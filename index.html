<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Kalepin — Calepinage Bardage Pro</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#c4324a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kalepin">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="description" content="Outil professionnel de calepinage bardage metallique avec vue 3D, export PDF et metres">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script>
    window.onerror=function(msg,url,line,col,err){
      document.body.innerHTML='<div style="color:#ff6b6b;padding:20px;font-family:monospace;white-space:pre-wrap;background:#1a1a2e"><h2 style=color:#ff4444>ERREUR JS</h2>'+msg+'\nLine: '+line+' Col: '+col+'\n'+(err&&err.stack||'')+'</div>';
    };
    window._jspdfReady=new Promise((resolve)=>{
      const urls=['https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js','https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js','https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js'];
      let i=0;function tryLoad(){if(i>=urls.length){resolve(false);return}const s=document.createElement('script');s.src=urls[i];s.onload=()=>resolve(true);s.onerror=()=>{i++;tryLoad()};document.head.appendChild(s)}tryLoad()});
  </script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0f;--pnl:#16161f;--crd:#1c1c28;--crd2:#22222e;--inp:#1a1a26;--bd:#2a2a3a;--bd2:#3a3a4e;--bdf:#c4324a;--t1:#f0ece6;--t2:#9a9aac;--t3:#5a5a6e;--bl:#c4324a;--blg:rgba(196,50,74,.15);--gn:#10b981;--gnd:rgba(16,185,129,.10);--am:#f59e0b;--amd:rgba(245,158,11,.10);--rs:#ef4444;--rsd:rgba(239,68,68,.10);--pp:#c4324a;--ppd:rgba(196,50,74,.08);--cy:#0ea5e9;--cyd:rgba(14,165,233,.10)}
    *{font-family:'DM Sans',system-ui,sans-serif;box-sizing:border-box;margin:0}
    html,body,#root{height:100%;overflow:hidden;background:var(--bg);color:var(--t1)}
    .mn{font-family:'JetBrains Mono',monospace}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:10px}
    input[type=number]{-moz-appearance:textfield}input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
    .idark{background:var(--inp);border:1.5px solid var(--bd);color:var(--t1);transition:.2s}.idark:focus{border-color:var(--bdf);box-shadow:0 0 0 3px rgba(196,50,74,.15);outline:none}
    .cd{background:var(--crd);border:1px solid var(--bd);transition:.2s;border-radius:12px}.cd:hover{border-color:var(--bd2)}
    .ba{transition:.15s;cursor:pointer;user-select:none}.ba:active{transform:scale(.97)}
    .rv{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.92rem;letter-spacing:-.02em}
    @keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pg{0%,100%{box-shadow:0 0 8px var(--blg)}50%{box-shadow:0 0 20px var(--blg)}}
    .afu{animation:fu .25s ease-out}.apg{animation:pg 2s ease-in-out infinite}
    .pb{background:var(--inp);border:1px solid var(--bd);color:var(--t2);cursor:pointer;transition:.15s;font-size:10px;padding:5px 7px;border-radius:7px;text-align:left}
    .pb:hover{border-color:var(--bl);color:var(--t1);background:rgba(196,50,74,.08)}.pb.on{border-color:var(--bl);color:var(--bl);background:rgba(196,50,74,.12)}
    .tb{padding:6px 8px;font-size:10px;font-weight:500;color:var(--t3);cursor:pointer;transition:.2s;border-bottom:2px solid transparent;white-space:nowrap}
    .tb:hover{color:var(--t2)}.tb.on{color:var(--bl);border-bottom-color:var(--bl)}
    .ov{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
    .mbx{background:var(--pnl);border:1px solid var(--bd);border-radius:16px;padding:24px;min-width:380px;max-width:520px;box-shadow:0 25px 60px rgba(0,0,0,.5);max-height:90vh;overflow-y:auto}
    .rng{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--bd);border-radius:4px;outline:none}
    .rng::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--bl);border-radius:50%;cursor:pointer;border:2px solid var(--pnl)}
    .cvbg{background-color:#0e0e18;background-image:radial-gradient(rgba(196,50,74,.08) 1px,transparent 1px);background-size:24px 24px}
    .drop{border:2px dashed var(--bd2);border-radius:16px;transition:.3s;cursor:pointer}.drop:hover{border-color:var(--bl);background:rgba(196,50,74,.06)}
    .ztab{display:flex;align-items:center;gap:5px;padding:5px 11px;font-size:10px;font-weight:600;border-radius:6px 6px 0 0;cursor:pointer;transition:.15s;border:1px solid transparent;border-bottom:none;position:relative;white-space:nowrap;max-width:160px}
    .ztab:hover{background:var(--crd)}.ztab.on{background:var(--pnl);border-color:var(--bd);margin-bottom:-1px;z-index:2;padding-bottom:6px}
    .ztab .ztab-close{opacity:0;width:14px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:.1s}
    .ztab:hover .ztab-close,.ztab.on .ztab-close{opacity:.5}.ztab .ztab-close:hover{opacity:1!important;background:var(--rsd);color:var(--rs)}
    .ztab-bar{display:flex;align-items:flex-end;gap:2px;overflow-x:auto;scrollbar-width:none;padding:0 4px;flex:1;min-width:0}
    .ztab-bar::-webkit-scrollbar{display:none}
    .ztab-add{display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;font-size:14px;cursor:pointer;flex-shrink:0;opacity:.6;transition:.15s}
    .ztab-add:hover{opacity:1;background:var(--blg);color:var(--bl)}
    .dtbl{width:100%;border-collapse:collapse;font-size:10px}.dtbl th{text-align:left;font-weight:600;padding:4px 6px;border-bottom:1px solid var(--bd);color:var(--t3);font-size:9px;text-transform:uppercase}.dtbl td{padding:4px 6px;border-bottom:1px solid rgba(255,255,255,.05)}
    .imp-tag{display:inline-flex;align-items:center;gap:3px;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:600}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes glow{0%,100%{opacity:.4}50%{opacity:1}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes orbit{from{transform:rotate(0deg) translateX(42px) rotate(0deg)}to{transform:rotate(360deg) translateX(42px) rotate(-360deg)}}
    @keyframes pulse-ring{0%{transform:scale(.8);opacity:1}100%{transform:scale(2.5);opacity:0}}
    .wc-logo{animation:float 3s ease-in-out infinite}
    .wc-d0{animation:slideUp .6s ease-out both}.wc-d1{animation:slideUp .6s ease-out both;animation-delay:.15s}
    .wc-d2{animation:slideUp .6s ease-out both;animation-delay:.3s}.wc-d3{animation:slideUp .6s ease-out both;animation-delay:.45s}
    .wc-d4{animation:slideUp .6s ease-out both;animation-delay:.6s}
    .wc-glow{animation:glow 2.5s ease-in-out infinite}
    .wc-shine{background:linear-gradient(90deg,transparent,rgba(196,50,74,.15),transparent);background-size:200% 100%;animation:shimmer 3s linear infinite}
    .opt-card{border:1px solid var(--bd);border-radius:10px;padding:10px;cursor:pointer;transition:.15s}
    .opt-card:hover{border-color:var(--bl)}.opt-card.best{border-color:var(--gn);background:var(--gnd)}
  </style>
</head>
<body>
<div id="root"></div>

<script id="app-source" type="text/plain">
const{useState,useMemo,useRef,useCallback,useEffect}=React;

/* ─── ICONS ─── */
const I={
  ruler:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0z"/><path d="m14.5 12.5 2-2m-5-1 2-2m-5-1 2-2m8 5 2-2"/></svg>,
  grid:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
  frame:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="6" x2="2" y2="6"/><line x1="22" y1="18" x2="2" y2="18"/><line x1="6" y1="2" x2="6" y2="22"/><line x1="18" y1="2" x2="18" y2="22"/></svg>,
  bolt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 3v4m0 10v4M3 12h4m10 0h4"/></svg>,
  win:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="4" x2="12" y2="20"/></svg>,
  dl:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  plus:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  trash:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  copy:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
  zi:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
  zo:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
  tgt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
  chv:s=><svg width={s||12} height={s||12} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round"><polyline points="6 9 12 15 18 9"/></svg>,
  cross:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>,
  up:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
  prn:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  x:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  move:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>,
  opt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 20V10m6 10V4M6 20v-4"/></svg>,
  pen:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
};

/* ─── PRESETS ─── */
const DP=[{n:'Alucobond 4mm',l:3200,w:1250},{n:'Trespa 8mm',l:3050,w:1530},{n:'Equitone 8mm',l:2530,w:1220},{n:'Rockpanel 8mm',l:2500,w:1200},{n:'Cedral 8mm',l:3600,w:190},{n:'Zinc VM 0.7',l:2000,w:500},{n:'Cassette alu 3mm',l:1500,w:600},{n:'Fibrociment 6mm',l:2500,w:1220}];
const DO=[{n:'Fen. 1V',t:'Fenetre',w:900,h:1150},{n:'Fen. 2V',t:'Fenetre',w:1200,h:1350},{n:'Porte std',t:'Porte',w:900,h:2150},{n:'Porte-fen.',t:'Porte-fenetre',w:1800,h:2150},{n:'Chassis fixe',t:'Chassis fixe',w:600,h:600},{n:'Grille vent.',t:'Grille',w:400,h:300}];

/* ── DXF PARSER (LINE, LWPOLYLINE, POLYLINE, CIRCLE, ARC) ── */
function parseDXF(text){
  const lines=[];const pairs=[];const raw=text.split(/\r?\n/);
  for(let i=0;i<raw.length-1;i+=2)pairs.push({code:parseInt(raw[i].trim()),val:raw[i+1].trim()});
  let inEntities=false,etype='',x1=0,y1=0,x2=0,y2=0;
  const pts=[];let collecting=false;
  for(let i=0;i<pairs.length;i++){
    const{code,val}=pairs[i];
    if(code===2&&val==='ENTITIES')inEntities=true;
    if(code===0&&val==='ENDSEC')inEntities=false;
    if(!inEntities)continue;
    if(code===0){
      // Flush previous entity
      if(etype==='LINE')lines.push({x1,y1,x2,y2});
      if((etype==='LWPOLYLINE'||etype==='POLYLINE')&&pts.length>1){
        for(let j=0;j<pts.length-1;j++)lines.push({x1:pts[j].x,y1:pts[j].y,x2:pts[j+1].x,y2:pts[j+1].y});
        if(collecting&&pts.length>2)lines.push({x1:pts[pts.length-1].x,y1:pts[pts.length-1].y,x2:pts[0].x,y2:pts[0].y});
      }
      etype=val;x1=y1=x2=y2=0;pts.length=0;collecting=false;
      if(val==='LWPOLYLINE'||val==='POLYLINE')collecting=true;
    }
    if(etype==='LINE'){if(code===10)x1=parseFloat(val);if(code===20)y1=parseFloat(val);if(code===11)x2=parseFloat(val);if(code===21)y2=parseFloat(val)}
    if(collecting){
      if(code===10)pts.push({x:parseFloat(val),y:0});
      if(code===20&&pts.length>0)pts[pts.length-1].y=parseFloat(val);
      if(code===70&&parseInt(val)&1)collecting=true;// closed flag
    }
    if(etype==='CIRCLE'){
      if(code===10)x1=parseFloat(val);if(code===20)y1=parseFloat(val);
      if(code===40){const r=parseFloat(val);for(let a=0;a<360;a+=15){
        const a1=a*Math.PI/180,a2=(a+15)*Math.PI/180;
        lines.push({x1:x1+r*Math.cos(a1),y1:y1+r*Math.sin(a1),x2:x1+r*Math.cos(a2),y2:y1+r*Math.sin(a2)});}}
    }
  }
  if(lines.length===0)throw new Error('Aucune entité trouvée');
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  lines.forEach(l=>{minX=Math.min(minX,l.x1,l.x2);minY=Math.min(minY,l.y1,l.y2);maxX=Math.max(maxX,l.x1,l.x2);maxY=Math.max(maxY,l.y1,l.y2)});
  return{lines,bounds:{minX,minY,maxX,maxY},units:'mm'};
}
const ZONE_COLORS=['#4f6ef7','#34d399','#fbbf24','#fb7185','#a78bfa','#22d3ee','#f97316','#ec4899'];

/* ─── POLYGON UTILITIES ─── */
function ptInPoly(px,py,poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i].x,yi=poly[i].y,xj=poly[j].x,yj=poly[j].y;
    if((yi>py)!==(yj>py)&&px<(xj-xi)*(py-yi)/(yj-yi)+xi)inside=!inside;
  }
  return inside;
}
function polyArea(poly){
  let a=0;for(let i=0,j=poly.length-1;i<poly.length;j=i++){a+=(poly[j].x+poly[i].x)*(poly[j].y-poly[i].y)}
  return Math.abs(a/2);
}
function polyBounds(poly){
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  poly.forEach(p=>{x1=Math.min(x1,p.x);y1=Math.min(y1,p.y);x2=Math.max(x2,p.x);y2=Math.max(y2,p.y)});
  return{x:x1,y:y1,w:x2-x1,h:y2-y1};
}
function rectPolyOverlap(rx,ry,rw,rh,poly){
  const corners=[{x:rx,y:ry},{x:rx+rw,y:ry},{x:rx+rw,y:ry+rh},{x:rx,y:ry+rh}];
  const ins=corners.map(c=>ptInPoly(c.x,c.y,poly));
  const cnt=ins.filter(Boolean).length;
  if(cnt===4)return'inside';
  if(cnt===0){
    // check if any poly edge crosses rect
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      if(segRectIntersect(poly[j],poly[i],rx,ry,rw,rh))return'partial';
    }
    // check if poly is inside rect
    if(poly.length>0&&rx<=poly[0].x&&poly[0].x<=rx+rw&&ry<=poly[0].y&&poly[0].y<=ry+rh)return'partial';
    return'outside';
  }
  return'partial';
}
function segRectIntersect(a,b,rx,ry,rw,rh){
  const edges=[[{x:rx,y:ry},{x:rx+rw,y:ry}],[{x:rx+rw,y:ry},{x:rx+rw,y:ry+rh}],[{x:rx+rw,y:ry+rh},{x:rx,y:ry+rh}],[{x:rx,y:ry+rh},{x:rx,y:ry}]];
  return edges.some(([c,d])=>segSeg(a,b,c,d));
}
function segSeg(a,b,c,d){
  const det=(b.x-a.x)*(d.y-c.y)-(b.y-a.y)*(d.x-c.x);if(Math.abs(det)<1e-10)return false;
  const t=((c.x-a.x)*(d.y-c.y)-(c.y-a.y)*(d.x-c.x))/det;
  const u=((c.x-a.x)*(b.y-a.y)-(c.y-a.y)*(b.x-a.x))/det;
  return t>=0&&t<=1&&u>=0&&u<=1;
}
function polyToPath(poly,sc,ox,oy){
  return poly.map((p,i)=>`${i===0?'M':'L'}${ox+p.x*sc} ${oy+p.y*sc}`).join(' ')+'Z';
}

/* ─── BASE COMPONENTS ─── */
function NI({value,onChange,unit,step=100,min=0,label,compact,ph=''}){
  const[v,sV]=useState(value),[f,sF]=useState(false);const r=useRef();
  useEffect(()=>{if(!f)sV(value)},[value,f]);
  const cm=()=>{sF(false);const n=Number(v);if(!isNaN(n)&&n>=min)onChange(n);else sV(value)};
  return(<div className={compact?'':'space-y-1'}>
    {label&&<label className="text-[11px] font-medium block" style={{color:'var(--t3)'}}>{label}</label>}
    <div className="relative"><input ref={r} type="number" value={v} onChange={e=>sV(e.target.value)}
      onKeyDown={e=>{if(e.key==='Enter')r.current?.blur();e.stopPropagation()}} onBlur={cm} onClick={e=>e.stopPropagation()}
      onFocus={()=>{sF(true);setTimeout(()=>r.current?.select(),0)}} step={step} min={min} placeholder={ph}
      className={`idark w-full rounded-lg text-sm font-medium ${compact?'pl-2 pr-8 py-1.5 text-xs':'pl-3 pr-10 py-2'}`}/>
      {unit&&<span className={`absolute right-2 top-1/2 -translate-y-1/2 font-medium mn ${compact?'text-[10px]':'text-xs'}`} style={{color:'var(--t3)'}}>{unit}</span>}
    </div></div>);
}
function TI({value,onChange,label,ph=''}){
  return(<div className="space-y-1">{label&&<label className="text-[11px] font-medium block" style={{color:'var(--t3)'}}>{label}</label>}
    <input type="text" value={value} onChange={e=>onChange(e.target.value)} placeholder={ph}
      onKeyDown={e=>e.stopPropagation()} onClick={e=>e.stopPropagation()} className="idark w-full rounded-lg text-sm font-medium pl-3 pr-3 py-2"/></div>);
}
function Sec({icon,title,badge,children,dO=true,color='var(--bl)',act}){
  const[o,sO]=useState(dO);
  return(<div className="cd overflow-hidden">
    <div className="flex items-center gap-2.5 px-3.5 py-2.5 cursor-pointer select-none" onClick={()=>sO(!o)}>
      <span className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:`color-mix(in srgb,${color} 15%,transparent)`,color}}>{icon}</span>
      <span className="text-[13px] font-semibold flex-1">{title}</span>
      {badge!=null&&<span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[11px] font-medium mn" style={{background:`color-mix(in srgb,${color} 12%,transparent)`,color}}>{badge}</span>}
      {act&&<span onClick={e=>{e.stopPropagation();act.fn()}} className="w-6 h-6 rounded-md flex items-center justify-center hover:bg-[var(--crd2)]" style={{color:'var(--t3)'}}>{act.ic}</span>}
      <span style={{color:'var(--t3)',transform:o?'rotate(0)':'rotate(-90deg)',transition:'.2s'}}>{I.chv()}</span>
    </div>{o&&<div className="px-3.5 pb-3.5 pt-0.5 afu">{children}</div>}</div>);
}
function RR({label,value,unit='',color,sub,bold}){
  return(<div className={`flex justify-between items-baseline ${sub?'pl-3 opacity-70':''} ${bold?'pt-1.5 mt-1.5 border-t border-[var(--bd)]':''}`}>
    <span className={`${sub?'text-[11px]':'text-xs'} ${bold?'font-semibold':''}`} style={{color:'var(--t2)'}}>{label}</span>
    <span className={`rv ${sub?'!text-xs':''}`} style={{color:color||'var(--t1)'}}>{value}<span className="text-[10px] ml-1 font-normal" style={{color:'var(--t3)'}}>{unit}</span></span>
  </div>);
}

/* ═══ CALCULATION ENGINE ═══ */
function calcZone(z){
  if(!z||!z.L||!z.H)return null;
  const L=z.L/1000,H=z.H/1000;
  const pL=Math.max(.1,z.pan_.l/1000),pW=Math.max(.1,z.pan_.w/1000);
  const eM=Math.max(.1,z.oss.eM/1000),eL=Math.max(.1,z.oss.eL/1000);
  const pw0=z.vert?pW:pL,ph0=z.vert?pL:pW;
  const defJH=(z.jointH||0)/1000,defJV=(z.jointV||0)/1000;
  const jointsH=z.jointsH||[];const jointsV=z.jointsV||[];
  const offX=(z.offX||0)/1000,offY=(z.offY||0)/1000;
  const colWidths=z.colWidths||[];const rowHeights=z.rowHeights||[];
  const poly=z.poly;const polyM=poly?poly.map(p=>({x:p.x/1000,y:p.y/1000})):null;
  const sBr=polyM?polyArea(polyM):L*H;
  const sOuv=z.ouvs.reduce((s,o)=>s+(o.w/1000)*(o.h/1000),0);
  const sNet=Math.max(0,sBr-sOuv);

  // ── STEP 1: Build base grid columns ──
  const baseXBounds=[0];let cx2=0;
  const offXm=offX>0?offX:0;
  if(offXm>0){baseXBounds.push(offXm);cx2=offXm+(jointsH[0]!=null?jointsH[0]/1000:defJH);}
  let ci2=baseXBounds.length>1?1:0;
  while(cx2<L-0.001&&ci2<300){
    const cw=(colWidths[ci2]&&colWidths[ci2]>0)?colWidths[ci2]/1000:pw0;
    const w2=Math.min(cw,L-cx2);if(w2<0.001)break;
    cx2+=w2;baseXBounds.push(Math.min(cx2,L));
    cx2+=(jointsH[ci2]!=null?jointsH[ci2]/1000:defJH);ci2++;
  }
  if(baseXBounds[baseXBounds.length-1]<L-0.001)baseXBounds.push(L);

  // ── STEP 1b: Build base grid rows ──
  const baseYBounds=[0];let ry2=0;
  const offYm=offY>0?offY:0;
  if(offYm>0){baseYBounds.push(offYm);ry2=offYm+(jointsV[0]!=null?jointsV[0]/1000:defJV);}
  let ri2=baseYBounds.length>1?1:0;
  while(ry2<H-0.001&&ri2<300){
    const rh=(rowHeights[ri2]&&rowHeights[ri2]>0)?rowHeights[ri2]/1000:ph0;
    const h2=Math.min(rh,H-ry2);if(h2<0.001)break;
    ry2+=h2;baseYBounds.push(Math.min(ry2,H));
    ry2+=(jointsV[ri2]!=null?jointsV[ri2]/1000:defJV);ri2++;
  }
  if(baseYBounds[baseYBounds.length-1]<H-0.001)baseYBounds.push(H);

  const baseNc=baseXBounds.length-1,baseNr=baseYBounds.length-1;
  const jGapsH=Array.from({length:Math.max(0,baseNc-1)},(_,i)=>(jointsH[i]!=null?jointsH[i]:z.jointH||0));
  const jGapsV=Array.from({length:Math.max(0,baseNr-1)},(_,i)=>(jointsV[i]!=null?jointsV[i]:z.jointV||0));

  // ── STEP 1c: Process merges — build merged cell map ──
  const merges=z.merges||[];
  const mergedAbsorbed=new Set();// "bc,br" keys of cells absorbed by a merge
  const mergedOrigins={};// "bc,br" → {c2, r2} for origin cells
  merges.forEach(mg=>{
    if(mg.c1>=baseNc||mg.r1>=baseNr||mg.c2>=baseNc||mg.r2>=baseNr)return;
    if(mg.c1>mg.c2||mg.r1>mg.r2)return;
    mergedOrigins[`${mg.c1},${mg.r1}`]={c2:mg.c2,r2:mg.r2};
    for(let c=mg.c1;c<=mg.c2;c++)for(let r=mg.r1;r<=mg.r2;r++){
      if(c===mg.c1&&r===mg.r1)continue;// origin not absorbed
      mergedAbsorbed.add(`${c},${r}`);
    }
  });

  // ── STEP 2: For each base cell, check if it intersects openings → subdivide LOCALLY ──
  const panelMap=[];let subIdx=0;
  const ouvRects=z.ouvs.map(o=>({l:o.x/1000,t:o.y/1000,r:(o.x+o.w)/1000,b:(o.y+o.h)/1000}));

  for(let bc=0;bc<baseNc;bc++){
    for(let br=0;br<baseNr;br++){
      const cellKey=`${bc},${br}`;
      // Skip cells absorbed by a merge
      if(mergedAbsorbed.has(cellKey))continue;
      // Compute effective bounds (expanded if this is a merge origin)
      let bx1=baseXBounds[bc],bx2=baseXBounds[bc+1];
      let by1=baseYBounds[br],by2=baseYBounds[br+1];
      const mg=mergedOrigins[cellKey];
      const isMerged=!!mg;
      if(mg){bx2=baseXBounds[mg.c2+1];by2=baseYBounds[mg.r2+1]}
      const bw=bx2-bx1,bh=by2-by1;
      if(bw<0.001||bh<0.001)continue;
      if(polyM&&rectPolyOverlap(bx1,by1,bw,bh,polyM)==='outside')continue;
      const polyEdge=polyM?rectPolyOverlap(bx1,by1,bw,bh,polyM)==='partial':false;

      // Collect opening edges that fall INSIDE this base cell
      const localXCuts=new Set(),localYCuts=new Set();
      let hasIntersection=false;
      ouvRects.forEach(or=>{
        if(or.l>=bx2-0.001||or.r<=bx1+0.001||or.t>=by2-0.001||or.b<=by1+0.001)return;
        hasIntersection=true;
        if(or.l>bx1+0.001&&or.l<bx2-0.001)localXCuts.add(or.l);
        if(or.r>bx1+0.001&&or.r<bx2-0.001)localXCuts.add(or.r);
        if(or.t>by1+0.001&&or.t<by2-0.001)localYCuts.add(or.t);
        if(or.b>by1+0.001&&or.b<by2-0.001)localYCuts.add(or.b);
      });

      if(!hasIntersection){
        // No opening touches this cell → single panel
        const excl=(z.exclusions||[]).find(e=>e.col===bc&&e.row===br);
        panelMap.push({col:subIdx,row:0,parentCol:bc,parentRow:br,pLeft:bx1,pTop:by1,pWa:bw,pHa:bh,
          isVoid:false,voidOuvIdx:-1,isImpacted:false,adjSides:[],polyEdge,
          ref:`${bc+1}.${br+1}`,subRef:`${bc+1}.${br+1}`,isBase:true,
          isMerged,mergeSpan:mg?{c1:bc,r1:br,c2:mg.c2,r2:mg.r2}:null,
          isExcluded:!!excl,exclusionDepth:excl?excl.depth:0});
        subIdx++;
      }else{
        // Subdivide this cell using local opening edges
        const xCuts=[bx1,...[...localXCuts].sort((a,b)=>a-b),bx2];
        const yCuts=[by1,...[...localYCuts].sort((a,b)=>a-b),by2];
        let subCount=0;
        for(let sx=0;sx<xCuts.length-1;sx++){
          for(let sy=0;sy<yCuts.length-1;sy++){
            const sx1=xCuts[sx],sx2=xCuts[sx+1],sy1=yCuts[sy],sy2=yCuts[sy+1];
            const sw=sx2-sx1,sh=sy2-sy1;
            if(sw<0.001||sh<0.001)continue;
            // Check if this sub-cell center is inside any opening
            const scx=sx1+sw/2,scy=sy1+sh/2;
            let isVoid=false,voidIdx=-1;
            ouvRects.forEach((or,oi)=>{
              if(scx>or.l+0.001&&scx<or.r-0.001&&scy>or.t+0.001&&scy<or.b-0.001){isVoid=true;voidIdx=oi}
            });
            subCount++;
            const excl=(z.exclusions||[]).find(e=>e.col===bc&&e.row===br);
            panelMap.push({col:subIdx,row:0,parentCol:bc,parentRow:br,pLeft:sx1,pTop:sy1,pWa:sw,pHa:sh,
              isVoid,voidOuvIdx:voidIdx,isImpacted:false,adjSides:[],polyEdge,
              ref:`${bc+1}.${br+1}`,subRef:`${bc+1}.${br+1}.${subCount}`,isBase:false,
              isMerged,mergeSpan:mg?{c1:bc,r1:br,c2:mg.c2,r2:mg.r2}:null,
              isExcluded:!!excl,exclusionDepth:excl?excl.depth:0});
            subIdx++;
          }
        }
      }
    }
  }

  // ── STEP 3: Mark impacted panels (neighbor voids) ──
  const exclusions=z.exclusions||[];
  const isExcluded=(col,row)=>exclusions.some(e=>e.col===col&&e.row===row);
  const activePanels=panelMap.filter(p=>!p.isVoid&&!isExcluded(p.parentCol,p.parentRow));
  const eps=0.003;
  activePanels.forEach(pm=>{
    const pr=pm.pLeft+pm.pWa,pb=pm.pTop+pm.pHa;
    const sides=[];
    panelMap.forEach(other=>{
      if(!other.isVoid||other.voidOuvIdx<0)return;
      const or2=other.pLeft+other.pWa,ob2=other.pTop+other.pHa;
      const o=z.ouvs[other.voidOuvIdx];if(!o)return;
      const r=o.retours||{tG:150,tD:150,lin:150,app:150};const fv=o.faceVis||50;
      // Check adjacency: shared edge
      const overlapY=Math.min(pb,ob2)-Math.max(pm.pTop,other.pTop);
      const overlapX=Math.min(pr,or2)-Math.max(pm.pLeft,other.pLeft);
      if(Math.abs(pr-other.pLeft)<eps&&overlapY>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'tG',retour:r.tG,faceVis:fv,foldL:Math.round(overlapY*1000),devRetour:r.tG+fv+10});
      if(Math.abs(pm.pLeft-or2)<eps&&overlapY>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'tD',retour:r.tD,faceVis:fv,foldL:Math.round(overlapY*1000),devRetour:r.tD+fv+10});
      if(Math.abs(pb-other.pTop)<eps&&overlapX>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'lin',retour:r.lin,faceVis:fv,foldL:Math.round(overlapX*1000),devRetour:r.lin+fv+10});
      if(Math.abs(pm.pTop-ob2)<eps&&overlapX>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'app',retour:r.app,faceVis:fv,foldL:Math.round(overlapX*1000),devRetour:r.app+fv+10});
    });
    // Deduplicate by side+ouvIdx
    const uniq=[];const seen=new Set();
    sides.forEach(s=>{const k=s.side+'-'+s.ouvIdx;if(!seen.has(k)){seen.add(k);uniq.push(s)}});
    if(uniq.length>0){
      const df=z._disabledFolds||{};
      uniq.forEach(s=>{const k=pm.subRef+'-'+s.side+'-'+s.ouvIdx;if(df[k])s.disabled=true;});
      const active=uniq.filter(s=>!s.disabled);
      pm.isImpacted=active.length>0;pm.adjSides=uniq}
  });

  // Mark ALL sub-panels with non-standard dimensions as impacted
  // Build set of expected base cell dimensions (from colWidths/rowHeights or default)
  const expectedW=new Set(),expectedH=new Set();
  expectedW.add(Math.round(pw0*10000));
  expectedH.add(Math.round(ph0*10000));
  // Also accept configured custom widths/heights
  (z.colWidths||[]).forEach(cw=>{if(cw>0)expectedW.add(Math.round(cw*10))});
  (z.rowHeights||[]).forEach(rh=>{if(rh>0)expectedH.add(Math.round(rh*10))});
  // Accept offset panels too
  if(offX>0)expectedW.add(Math.round(offX*10000));
  if(offY>0)expectedH.add(Math.round(offY*10000));
  activePanels.forEach(pm=>{
    if(pm.isImpacted)return;// Already marked from void adjacency
    const pw2=Math.round(pm.pWa*10000),ph2=Math.round(pm.pHa*10000);
    const wOk=expectedW.has(pw2);const hOk=expectedH.has(ph2);
    if(!wOk||!hOk){
      pm.isImpacted=true;// Non-standard dimension → cut panel
    }
  });
  const nP=activePanels.length;
  const pImp=activePanels.filter(p=>p.isImpacted).length;
  const totalPanArea=activePanels.reduce((a,pm)=>a+pm.pWa*pm.pHa,0);
  const chut=totalPanArea>0?Math.max(0,(totalPanArea-sNet)/totalPanArea*100):0;
  const impacts=[];
  const edgePanels=panelMap.filter(pm=>pm.polyEdge&&!pm.isVoid).map(pm=>({
    col:pm.col,row:0,ref:pm.subRef,panW:Math.round(pm.pWa*1000),panH:Math.round(pm.pHa*1000),edge:true}));

  // ── STEP 4: Cassettes (from adjSides) ──
  const menuDet=z.ouvs.map((o,i)=>{
    const lm=o.w/1000,hm=o.h/1000;
    const r=o.retours||{tG:150,tD:150,lin:150,app:150};
    const fv=o.faceVis||50;const pli=10;
    const cassettes=[];
    activePanels.forEach(pm=>{
      if(!pm.isImpacted)return;
      pm.adjSides.forEach(s=>{
        if(s.ouvIdx!==i||s.disabled)return;
        cassettes.push({nom:`${s.side==='tG'?'Tab.G':s.side==='tD'?'Tab.D':s.side==='lin'?'Linteau':'Appui'} P${pm.subRef}`,
          type:'pliee',L:s.foldL,dev:s.devRetour,side:s.side,panRef:pm.subRef});
      });
    });
    const surfCass=cassettes.reduce((a,cc)=>a+(cc.L*cc.dev)/1e6,0);
    const mlCass=cassettes.reduce((a,cc)=>a+cc.L/1000,0);
    return{...o,idx:i,lm,hm,retours:r,faceVis:fv,
      tableauG:hm,tableauD:hm,linteau:lm,appui:lm,encTotal:2*hm+2*lm,
      cassettes,surfCass,mlCass,impPanels:activePanels.filter(p=>p.isImpacted&&p.adjSides.some(s=>s.ouvIdx===i)).map(p=>p.subRef)};
  });
  const totEnc=menuDet.reduce((a,m)=>({tab:a.tab+m.tableauG+m.tableauD,lin:a.lin+m.linteau,app:a.app+m.appui,tot:a.tot+m.encTotal}),{tab:0,lin:0,app:0,tot:0});
  const totCassettes={pliees:menuDet.reduce((a,m)=>a+m.cassettes.length,0),surfTot:menuDet.reduce((a,m)=>a+m.surfCass,0),
    mlTot:menuDet.reduce((a,m)=>a+m.mlCass,0),detail:menuDet.flatMap(m=>m.cassettes.map(cc=>({...cc,ouvName:`${m.t} ${m.idx+1}`,ouvId:m.id})))};

  // ── STEP 5: Ossature ──
  const nM=Math.floor(L/eM)+1,nL2=Math.floor(H/eL)+1;
  const lMBr=nM*H,lLBr=nL2*L;let dM=0,dL=0;
  z.ouvs.forEach(o=>{const ox1=o.x/1000,ox2=(o.x+o.w)/1000;
    for(let i=0;i<=nM;i++){const mx=i*eM;if(mx>ox1&&mx<ox2)dM+=o.h/1000}
    for(let i=0;i<=nL2;i++){const ly=i*eL;if(ly>o.y/1000&&ly<(o.y+o.h)/1000)dL+=o.w/1000}});
  const lMN=lMBr-dM+totEnc.tab,lLN=lLBr-dL+totEnc.lin+totEnc.app,tOss=lMN+lLN;
  const jV=Math.max(0,baseNc-1)*H,jH=Math.max(0,baseNr-1)*L,tJ=jV+jH;
  const jGapH=defJH,jGapV=defJV;
  const jGapArea=jGapsH.reduce((a,g)=>a+g/1000*H,0)+jGapsV.reduce((a,g)=>a+g/1000*L,0);
  const tFix=nP*z.fix.pp,tEq=nM*z.fix.em;
  // Compat: cols/rows for rendering
  const cols=panelMap.map(pm=>({x:pm.pLeft,w:pm.pWa}));
  const rows=panelMap.map(pm=>({y:pm.pTop,h:pm.pHa}));

  return{sBr,sOuv,sNet,nC:baseNc,nR:baseNr,nP,pImp,chut,pw:pw0,ph:ph0,nM,nL:nL2,lMBr,lLBr,dM,dL,lMN,lLN,tOss,jV,jH,tJ,jGapH,jGapV,jGapArea,jGapsH,jGapsV,tFix,tEq,
    impacts,menuDet,totEnc,totCassettes,panelMap,activePanels,edgePanels,offX,offY,cols,rows,
    baseXBounds,baseYBounds,baseNc,baseNr};
}

/* ═══ OPTIMIZATION ENGINE ═══ */
function optimizeLayout(z){
  const results=[];
  const pL=z.pan_.l,pW=z.pan_.w;
  const stepOff=50;// mm
  [true,false].forEach(vert=>{
    const pw=vert?pW:pL,ph=vert?pL:pW;
    for(let ox=0;ox<pw;ox+=stepOff){
      for(let oy=0;oy<ph;oy+=stepOff){
        const test={...z,vert,offX:ox,offY:oy};
        const r=calcZone(test);
        if(!r)continue;
        results.push({vert,offX:ox,offY:oy,nP:r.nP,pImp:r.pImp,chut:r.chut,sNet:r.sNet,nCuts:r.impacts.length+r.edgePanels.length,label:`${vert?'V':'H'} dec.${ox}x${oy}`});
      }
    }
  });
  results.sort((a,b)=>a.chut-b.chut);
  // Keep unique top results
  const seen=new Set();const uniq=[];
  for(const r of results){
    const k=`${r.nP}-${r.chut.toFixed(1)}`;
    if(!seen.has(k)){seen.add(k);uniq.push(r);if(uniq.length>=6)break}
  }
  return uniq;
}

/* ═══ 3D FACADE VIEWER ═══ */
function Facade3D({zone,calc,ralColor,ralFinish,showWall,onToggle,onClose,hideBack=false}){
  const mountRef=useRef();const sceneRef=useRef();const frameRef=useRef();
  const rotRef=useRef({x:-.3,y:.4});const dragRef=useRef(null);const zoomRef=useRef(3);
  const panRef=useRef({x:0,y:0});const pinchRef=useRef(null);
  const[showOss3D,setShowOss3D]=useState(true);
  const[showInsul,setShowInsul]=useState(true);
  const[insulThick,setInsulThick]=useState(100);// mm
  const[showScaff,setShowScaff]=useState(false);
  const[scaff,setScaff]=useState({x:0,y:0,nBays:3,nLevels:3,bayW:2.57,levelH:2.0,dist:0.8,scaffW:0.73});// standard EU dimensions
  const[isMobile,setIsMobile]=useState(()=>window.innerWidth<640);
  useEffect(()=>{const h=()=>setIsMobile(window.innerWidth<640);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);

  useEffect(()=>{
    if(!zone||!calc||!mountRef.current)return;
    const W=mountRef.current.clientWidth,H=mountRef.current.clientHeight;
    const scene=new THREE.Scene();
    scene.background=new THREE.Color(0x1a1e2e);

    const camera=new THREE.PerspectiveCamera(42,W/H,0.01,300);
    const renderer=new THREE.WebGLRenderer({antialias:true,alpha:false,powerPreference:'high-performance'});
    renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    renderer.shadowMap.enabled=true;
    renderer.shadowMap.type=THREE.PCFShadowMap;
    renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.1;
    mountRef.current.innerHTML='';mountRef.current.appendChild(renderer.domElement);
    renderer.domElement.style.pointerEvents='auto';
    renderer.domElement.style.cursor='grab';

    // ── Lumières ──
    // Lumière ambiante douce (ciel couvert)
    const amb=new THREE.AmbientLight(0xe8e8f0,0.6);scene.add(amb);
    // Soleil (angle ~45° depuis la droite-haut)
    const sun=new THREE.DirectionalLight(0xfff5e0,1.1);
    sun.position.set(8,12,8);sun.castShadow=true;
    sun.shadow.camera.near=0.1;sun.shadow.camera.far=80;
    sun.shadow.camera.left=-15;sun.shadow.camera.right=15;
    sun.shadow.camera.top=15;sun.shadow.camera.bottom=-15;
    sun.shadow.mapSize.width=1024;sun.shadow.mapSize.height=1024;
    sun.shadow.bias=-0.0005;
    scene.add(sun);
    // Contre-jour bleuté depuis le bas-gauche
    const fill=new THREE.DirectionalLight(0x8ab0ff,0.35);fill.position.set(-4,-2,3);scene.add(fill);
    // Lumière de rebond du sol
    const bounce=new THREE.PointLight(0xffeedd,0.2,30);bounce.position.set(0,-5,4);scene.add(bounce);

    const Lm=zone.L/1000,Hm=zone.H/1000,depth=0.008;
    const zoneOuvs=zone.ouvs||[];
    const facadeGroup=new THREE.Group();
    facadeGroup.position.set(-Lm/2,-Hm/2,0);

    // ── Matériaux ──
    const baseColor=new THREE.Color(ralColor||'#383E42');
    const fin=ralFinish||'mat';
    const isBrillant=fin==='brillant',isSatine=fin==='satiné',isMiroir=fin==='miroir',isBrosse=fin==='brossé';
    const panMetal=isBrillant?0.75:isSatine?0.55:isMiroir?0.9:isBrosse?0.5:0.38;
    const panRough=isBrillant?0.06:isSatine?0.2:isMiroir?0.02:isBrosse?0.38:0.52;
    // Env map pour les reflets — scène riche pour beaux reflets vitrage
    const cubeRT=new THREE.WebGLCubeRenderTarget(256);
    const cubeCamera=new THREE.CubeCamera(0.1,50,cubeRT);
    const envScene=new THREE.Scene();
    // Ciel dégradé
    const envSky=new THREE.Mesh(new THREE.SphereGeometry(20,32,16),new THREE.MeshBasicMaterial({color:0x87CEEB,side:THREE.BackSide}));
    envScene.add(envSky);
    // Nuages blancs (sphères aplaties)
    for(let ci=0;ci<8;ci++){
      const cloud=new THREE.Mesh(new THREE.SphereGeometry(2+Math.random()*3,8,6),
        new THREE.MeshBasicMaterial({color:0xffffff}));
      cloud.position.set(-10+Math.random()*20,6+Math.random()*6,-8+Math.random()*16);
      cloud.scale.set(1,.3,.6);envScene.add(cloud);
    }
    // Sol vert
    const envFloor2=new THREE.Mesh(new THREE.PlaneGeometry(40,40),new THREE.MeshBasicMaterial({color:0x4a6a3a}));
    envFloor2.rotation.x=-Math.PI/2;envFloor2.position.y=-5;envScene.add(envFloor2);
    // Bâtiments en arrière-plan (reflets urbains)
    for(let bi=0;bi<6;bi++){
      const bh=3+Math.random()*8,bw=1.5+Math.random()*2;
      const bldg=new THREE.Mesh(new THREE.BoxGeometry(bw,bh,bw),
        new THREE.MeshBasicMaterial({color:new THREE.Color().setHSL(0,0,0.35+Math.random()*0.25)}));
      bldg.position.set(-12+bi*5,bh/2-5,-15+Math.random()*4);envScene.add(bldg);
    }
    cubeCamera.update(renderer,envScene);

    const panMat=new THREE.MeshStandardMaterial({color:baseColor.clone(),metalness:panMetal,roughness:panRough,
      envMap:cubeRT.texture,envMapIntensity:isBrillant?1.4:isSatine?0.7:isMiroir?2.0:0.25});
    panMat.needsUpdate=true;
    const ossMat=new THREE.MeshStandardMaterial({color:0x909090,metalness:0.65,roughness:0.25});
    const concreteMat=new THREE.MeshStandardMaterial({color:0xb0b0a8,metalness:0.04,roughness:0.92});

    // ── Panels — positions corrigées avec joints réels ──
    // Dans baseXBounds : pLeft du col bc>0 commence AU DÉBUT du joint précédent,
    // donc pWa inclut ce joint. Il faut soustraire jGapsH[bc-1] pour le vrai panneau.
    const jGapsH3=calc.jGapsH||[];// joint widths per gap (mm)
    const jGapsV3=calc.jGapsV||[];
    const minJointVis=0.002;// 2mm min visual joint in 3D

    const getPanelRect=(pm)=>{
      const bx1=calc.baseXBounds[pm.parentCol];
      const by1=calc.baseYBounds[pm.parentRow];
      const jPH=pm.parentCol>0?(jGapsH3[pm.parentCol-1]||0)/1000:0;
      const jPV=pm.parentRow>0?(jGapsV3[pm.parentRow-1]||0)/1000:0;
      const atLeft=Math.abs(pm.pLeft-bx1)<0.0005;
      const atTop=Math.abs(pm.pTop-by1)<0.0005;
      const l=pm.pLeft+(atLeft?jPH:0);
      const t=pm.pTop+(atTop?jPV:0);
      const w=pm.pWa-(atLeft?jPH:0);
      const h=pm.pHa-(atTop?jPV:0);
      return{l,t,w,h};
    };

    // Panneau normaux
    const activePanels=calc.panelMap.filter(p=>!p.isVoid&&!p.isExcluded);
    activePanels.forEach(pm=>{
      const{l,t,w,h}=getPanelRect(pm);
      if(w<0.001||h<0.001)return;
      const geo=new THREE.BoxGeometry(w,h,depth);
      const mesh=new THREE.Mesh(geo,panMat);
      mesh.position.set(l+w/2,Hm-(t+h/2),depth/2);
      facadeGroup.add(mesh);
    });

    // Panneaux exclus (balcons) — béton extrudé
    const excludedPanels=calc.panelMap.filter(p=>p.isExcluded);
    excludedPanels.forEach(pm=>{
      const{l,t,w,h}=getPanelRect(pm);
      if(w<0.001||h<0.001)return;
      const extDepth=(pm.exclusionDepth||1500)/1000;
      const geo=new THREE.BoxGeometry(w,h,extDepth);
      const mesh=new THREE.Mesh(geo,concreteMat);
      mesh.position.set(l+w/2,Hm-(t+h/2),depth+extDepth/2);
      facadeGroup.add(mesh);
    });

    // ── Joints 3D : rainures visibles entre panneaux ──
    // Matériau joint : aluminium sombre, légèrement métallique (EPDM / silicone noir)
    const jointMat=new THREE.MeshStandardMaterial({color:0x111418,metalness:0.15,roughness:0.9});
    const jointDepth=depth*1.5;// joints légèrement plus profonds que les panneaux
    const merges=zone.merges||[];
    // Ouvertures en mètres pour découper les joints
    const ouvsMm=zoneOuvs.map(o=>({l:o.x/1000,r:(o.x+o.w)/1000,t:o.y/1000,b:(o.y+o.h)/1000}));

    // ── Joints verticaux (entre colonnes) — découpés autour des ouvertures ──
    calc.baseXBounds.slice(1,-1).forEach((xb,i)=>{
      const isInsideMerge=merges.some(m=>i>=m.c1&&i<m.c2);
      if(isInsideMerge)return;
      const jw=Math.max(minJointVis,(jGapsH3[i]||0)/1000);
      const jCx=xb+jw/2;
      // Découper ce joint vertical en segments qui évitent les ouvertures
      let segs=[{y1:0,y2:Hm}];
      ouvsMm.forEach(o=>{
        // Le joint passe dans l'ouverture si son x est entre oL et oR
        if(jCx<o.l-jw/2||jCx>o.r+jw/2)return;
        const ns=[];segs.forEach(s=>{
          const oT=o.t,oB=o.b;
          if(oT>=s.y2||oB<=s.y1){ns.push(s);return;}
          if(s.y1<oT)ns.push({y1:s.y1,y2:oT});
          if(oB<s.y2)ns.push({y1:oB,y2:s.y2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sh=s.y2-s.y1;if(sh<0.005)return;
        const geo=new THREE.BoxGeometry(jw,sh,jointDepth);
        const m=new THREE.Mesh(geo,jointMat);
        m.position.set(jCx,Hm-s.y1-sh/2,jointDepth/2);
        facadeGroup.add(m);
      });
    });

    // ── Joints horizontaux (entre rangées) — découpés autour des ouvertures ──
    calc.baseYBounds.slice(1,-1).forEach((yb,i)=>{
      const isInsideMerge=merges.some(m=>i>=m.r1&&i<m.r2);
      if(isInsideMerge)return;
      const jv=Math.max(minJointVis,(jGapsV3[i]||0)/1000);
      const jCy=Hm-yb-jv/2;
      const jYworld=yb+jv/2;// position Y en coords façade
      let segs=[{x1:0,x2:Lm}];
      ouvsMm.forEach(o=>{
        if(jYworld<o.t-jv/2||jYworld>o.b+jv/2)return;
        const ns=[];segs.forEach(s=>{
          const oL=o.l,oR=o.r;
          if(oL>=s.x2||oR<=s.x1){ns.push(s);return;}
          if(s.x1<oL)ns.push({x1:s.x1,x2:oL});
          if(oR<s.x2)ns.push({x1:oR,x2:s.x2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sw=s.x2-s.x1;if(sw<0.005)return;
        const geo=new THREE.BoxGeometry(sw,jv,jointDepth);
        const m=new THREE.Mesh(geo,jointMat);
        m.position.set(s.x1+sw/2,jCy,jointDepth/2);
        facadeGroup.add(m);
      });
    });

    // ── Matériaux retours : même finition RAL que les cassettes ──
    const retMat=new THREE.MeshStandardMaterial({color:baseColor.clone(),metalness:panMetal,roughness:panRough+0.05,
      envMap:cubeRT.texture,envMapIntensity:isBrillant?0.9:0.2,
      polygonOffset:true,polygonOffsetFactor:-1,polygonOffsetUnits:-1});
    // ── Vitrage double couche (fond sombre + reflet) ──
    const glassBackMat=new THREE.MeshStandardMaterial({
      color:0x1a2a3a,metalness:0.0,roughness:0.95,transparent:true,opacity:0.6,side:THREE.DoubleSide});
    const glassMat=new THREE.MeshStandardMaterial({
      color:0x9cc8e8,metalness:0.4,roughness:0.02,transparent:true,opacity:0.35,
      envMap:cubeRT.texture,envMapIntensity:1.8,side:THREE.DoubleSide});
    // Cadre menuiserie alu
    const frameMat=new THREE.MeshStandardMaterial({color:0x3a3a42,metalness:0.8,roughness:0.15,
      envMap:cubeRT.texture,envMapIntensity:0.6});

    // ── Retours + Vitrages pour chaque ouverture ──
    const sheetT=0.003;// épaisseur tôle 3mm
    zoneOuvs.forEach(o=>{
      const ox=o.x/1000,oy=o.y/1000,ow=o.w/1000,oh=o.h/1000;
      const r=o.retours||{tG:150,tD:150,lin:150,app:150};
      const fv=(o.faceVis||50)/1000;
      const panZ=depth+0.001;// juste devant les panneaux

      // ── RETOURS en profondeur (perpendiculaires à la facade, dans l'épaisseur du mur) ──
      const rTG=r.tG/1000,rTD=r.tD/1000,rLin=r.lin/1000,rApp=r.app/1000;
      // Tableau Gauche — retour en profondeur
      if(rTG>0){
        const rg=new THREE.Mesh(new THREE.BoxGeometry(sheetT,oh,rTG),retMat);
        rg.position.set(ox-sheetT/2,Hm-(oy+oh/2),-rTG/2);facadeGroup.add(rg);
      }
      // Tableau Droit — retour en profondeur
      if(rTD>0){
        const rd2=new THREE.Mesh(new THREE.BoxGeometry(sheetT,oh,rTD),retMat);
        rd2.position.set(ox+ow+sheetT/2,Hm-(oy+oh/2),-rTD/2);facadeGroup.add(rd2);
      }
      // Linteau — retour en profondeur
      if(rLin>0){
        const rl=new THREE.Mesh(new THREE.BoxGeometry(ow,sheetT,rLin),retMat);
        rl.position.set(ox+ow/2,Hm-oy+sheetT/2,-rLin/2);facadeGroup.add(rl);
      }
      // Appui — retour en profondeur
      if(rApp>0){
        const ra=new THREE.Mesh(new THREE.BoxGeometry(ow,sheetT,rApp),retMat);
        ra.position.set(ox+ow/2,Hm-(oy+oh)-sheetT/2,-rApp/2);facadeGroup.add(ra);
      }

      // ── FACES VISIBLES sur facade (recouvrement de la découpe) ──
      if(fv>0.001){
        // Tab G face visible
        if(rTG>0){const fg=new THREE.Mesh(new THREE.BoxGeometry(fv,oh+fv*2,sheetT),retMat);
          fg.position.set(ox-fv/2,Hm-(oy+oh/2),panZ);facadeGroup.add(fg);}
        // Tab D face visible
        if(rTD>0){const fd=new THREE.Mesh(new THREE.BoxGeometry(fv,oh+fv*2,sheetT),retMat);
          fd.position.set(ox+ow+fv/2,Hm-(oy+oh/2),panZ);facadeGroup.add(fd);}
        // Linteau face visible
        if(rLin>0){const fl=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,sheetT),retMat);
          fl.position.set(ox+ow/2,Hm-(oy-fv/2),panZ);facadeGroup.add(fl);}
        // Appui face visible
        if(rApp>0){const fa=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,sheetT),retMat);
          fa.position.set(ox+ow/2,Hm-(oy+oh+fv/2),panZ);facadeGroup.add(fa);}
      }

      // ── VITRAGE double couche ──
      const maxRet=Math.max(rTG,rTD,rLin,rApp);
      const glassZ=-maxRet*0.65;
      // Couche arrière sombre (simule intérieur)
      const gb=new THREE.Mesh(new THREE.PlaneGeometry(ow-0.008,oh-0.008),glassBackMat);
      gb.position.set(ox+ow/2,Hm-(oy+oh/2),glassZ-0.003);facadeGroup.add(gb);
      // Couche avant réfléchissante
      const gm=new THREE.Mesh(new THREE.PlaneGeometry(ow-0.006,oh-0.006),glassMat);
      gm.position.set(ox+ow/2,Hm-(oy+oh/2),glassZ);facadeGroup.add(gm);

      // ── CADRE MENUISERIE ALU ──
      const ft=0.032,fd2=0.045;
      const fTop=new THREE.Mesh(new THREE.BoxGeometry(ow+ft,ft,fd2),frameMat);
      fTop.position.set(ox+ow/2,Hm-(oy-ft/2),glassZ);facadeGroup.add(fTop);
      const fBot=new THREE.Mesh(new THREE.BoxGeometry(ow+ft,ft,fd2),frameMat);
      fBot.position.set(ox+ow/2,Hm-(oy+oh+ft/2),glassZ);facadeGroup.add(fBot);
      const fL=new THREE.Mesh(new THREE.BoxGeometry(ft,oh+ft*2,fd2),frameMat);
      fL.position.set(ox-ft/2,Hm-(oy+oh/2),glassZ);facadeGroup.add(fL);
      const fR=new THREE.Mesh(new THREE.BoxGeometry(ft,oh+ft*2,fd2),frameMat);
      fR.position.set(ox+ow+ft/2,Hm-(oy+oh/2),glassZ);facadeGroup.add(fR);
    });

    // ── Ossature ──
    const ossGroup=new THREE.Group();
    const zOss=zone.oss||{eM:600,eL:1350};const eM=zOss.eM/1000,eLi=zOss.eL/1000;
    const mW=0.06,mD=0.04;// montant section (60x40mm omega)
    const lW=0.04,lD=0.04;// lisse section (40x40mm)
    const ossZ=-mD/2-0.002;// z de l'ossature (derrière les panneaux)

    // Exclusion ossature = rectangle de l'ouverture élargi de la demi-largeur des montants
    // pour que rien de visible ne dépasse dans le cadre
    const halfM=mW/2+0.005;// demi-largeur montant + 5mm
    const halfL=lW/2+0.005;// demi-largeur lisse + 5mm
    const ossExclusions=zoneOuvs.map(o=>({
      l:o.x/1000-halfM, r:(o.x+o.w)/1000+halfM,
      t:o.y/1000-halfL, b:(o.y+o.h)/1000+halfL
    }));

    // Montants verticaux — profil oméga (3 faces)
    const montantsX=[];
    for(let i=0;i<=Math.floor(Lm/eM);i++){
      const mx=i*eM;if(mx>Lm+0.001)break;
      montantsX.push(mx);
      let segs=[{y1:0,y2:Hm}];
      ossExclusions.forEach(ex=>{
        if(mx<ex.l||mx>ex.r)return;
        const ns=[];segs.forEach(s=>{
          if(ex.t>=s.y2||ex.b<=s.y1){ns.push(s);return}
          if(s.y1<ex.t)ns.push({y1:s.y1,y2:ex.t});
          if(ex.b<s.y2)ns.push({y1:ex.b,y2:s.y2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sh=s.y2-s.y1;if(sh<0.02)return;
        // Corps montant
        const g=new THREE.BoxGeometry(mW,sh,mD);const m=new THREE.Mesh(g,ossMat);
        m.position.set(mx,Hm-s.y1-sh/2,ossZ);ossGroup.add(m);
        // Ailette gauche et droite (profil U)
        const aw=0.01,ah=sh;
        const al=new THREE.Mesh(new THREE.BoxGeometry(aw,ah,0.012),ossMat);
        al.position.set(mx-mW/2-aw/2,Hm-s.y1-sh/2,ossZ+mD/2-0.005);ossGroup.add(al);
        const ar=new THREE.Mesh(new THREE.BoxGeometry(aw,ah,0.012),ossMat);
        ar.position.set(mx+mW/2+aw/2,Hm-s.y1-sh/2,ossZ+mD/2-0.005);ossGroup.add(ar);
      });
    }
    // Lisses horizontales
    const lissesY=[];
    for(let i=0;i<=Math.floor(Hm/eLi);i++){
      const ly=i*eLi;if(ly>Hm+0.001)break;
      lissesY.push(ly);
      let segs=[{x1:0,x2:Lm}];
      ossExclusions.forEach(ex=>{
        if(ly<ex.t||ly>ex.b)return;
        const ns=[];segs.forEach(s=>{
          if(ex.l>=s.x2||ex.r<=s.x1){ns.push(s);return}
          if(s.x1<ex.l)ns.push({x1:s.x1,x2:ex.l});
          if(ex.r<s.x2)ns.push({x1:ex.r,x2:s.x2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sw=s.x2-s.x1;if(sw<0.02)return;
        const g=new THREE.BoxGeometry(sw,lW,lD);const m=new THREE.Mesh(g,ossMat);
        m.position.set(s.x1+sw/2,Hm-ly,ossZ-mD/2-lD/2+0.002);ossGroup.add(m);
      });
    }
    facadeGroup.add(ossGroup);

    // ── Isolant (entre ossature et mur béton) ──
    const insulGroup=new THREE.Group();
    const insulD=insulThick/1000;// épaisseur en mètres
    const insulZ=-mD-0.005;// juste derrière l'ossature
    const insulMat=new THREE.MeshStandardMaterial({
      color:0xe8c840,metalness:0.0,roughness:0.95,
      transparent:true,opacity:0.85
    });
    // Découper l'isolant autour des ouvertures
    // Stratégie: créer des rectangles d'isolant qui évitent les ouvertures
    // Simple: découpe en bandes horizontales
    const ouvRects=zoneOuvs.map(o=>({l:o.x/1000,r:(o.x+o.w)/1000,t:o.y/1000,b:(o.y+o.h)/1000}));
    // Créer une grille de rectangles couvrant la facade, découpés autour des ouvertures
    let insulRects=[{l:0,r:Lm,t:0,b:Hm}];
    ouvRects.forEach(ouv=>{
      const next=[];
      insulRects.forEach(ir=>{
        // Pas de chevauchement → garder tel quel
        if(ouv.l>=ir.r||ouv.r<=ir.l||ouv.t>=ir.b||ouv.b<=ir.t){next.push(ir);return}
        // Découpe: on crée les 4 rectangles autour de l'ouverture
        if(ir.t<ouv.t)next.push({l:ir.l,r:ir.r,t:ir.t,b:ouv.t});// haut
        if(ouv.b<ir.b)next.push({l:ir.l,r:ir.r,t:ouv.b,b:ir.b});// bas
        if(ir.l<ouv.l)next.push({l:ir.l,r:ouv.l,t:Math.max(ir.t,ouv.t),b:Math.min(ir.b,ouv.b)});// gauche
        if(ouv.r<ir.r)next.push({l:ouv.r,r:ir.r,t:Math.max(ir.t,ouv.t),b:Math.min(ir.b,ouv.b)});// droite
      });
      insulRects=next;
    });
    insulRects.forEach(ir=>{
      const w=ir.r-ir.l,h=ir.b-ir.t;
      if(w<0.01||h<0.01)return;
      const geo=new THREE.BoxGeometry(w,h,insulD);
      const m=new THREE.Mesh(geo,insulMat);
      m.position.set(ir.l+w/2,Hm-(ir.t+h/2),insulZ-insulD/2);
      insulGroup.add(m);
    });
    insulGroup.visible=showInsul;
    facadeGroup.add(insulGroup);

    // ── Échafaudage ──
    const scaffGroup=new THREE.Group();
    if(showScaff){
      const tubR=0.024;// rayon tube 48mm
      const tubSegs=8;
      const scaffMat=new THREE.MeshStandardMaterial({color:0xb8b8c0,metalness:0.75,roughness:0.25});
      const planckMat=new THREE.MeshStandardMaterial({color:0x9B7424,metalness:0.05,roughness:0.9});
      const guardMat=new THREE.MeshStandardMaterial({color:0xe8d020,metalness:0.45,roughness:0.25});
      const couplerMat=new THREE.MeshStandardMaterial({color:0x888890,metalness:0.8,roughness:0.2});
      const {nBays,nLevels,bayW,levelH,dist,x:scaffX,y:scaffY,scaffW}=scaff;
      const totalW=nBays*bayW;
      const totalH=nLevels*levelH;
      const zBack=depth+dist;// face arrière (côté facade)
      const zFront=zBack+scaffW;// face avant
      const zMid=(zFront+zBack)/2;
      const oX=scaffX-totalW/2+Lm/2;// centrage X sur facade + offset
      const baseY=scaffY;// Y de base (sol par défaut = 0, mais peut être décalé)

      // Helper: tube entre 2 points
      const makeTube=(p1,p2,r,mat)=>{
        const dx=p2[0]-p1[0],dy=p2[1]-p1[1],dz=p2[2]-p1[2];
        const len=Math.sqrt(dx*dx+dy*dy+dz*dz);if(len<0.001)return;
        const geo=new THREE.CylinderGeometry(r,r,len,tubSegs);
        const m=new THREE.Mesh(geo,mat);
        m.position.set((p1[0]+p2[0])/2,(p1[1]+p2[1])/2,(p1[2]+p2[2])/2);
        // Orient cylinder along direction
        const up=new THREE.Vector3(0,1,0);
        const dir=new THREE.Vector3(dx,dy,dz).normalize();
        const q=new THREE.Quaternion().setFromUnitVectors(up,dir);
        m.setRotationFromQuaternion(q);
        scaffGroup.add(m);
      };
      // Helper: coupler (raccord) at a joint
      const makeCoupler=(x,y,z)=>{
        const geo=new THREE.SphereGeometry(tubR*1.6,6,6);
        const m=new THREE.Mesh(geo,couplerMat);
        m.position.set(x,y,z);scaffGroup.add(m);
      };

      // ── Pieds réglables (vérins + platines) ──
      for(let bi=0;bi<=nBays;bi++){
        const mx=oX+bi*bayW;
        [zFront,zBack].forEach(zz=>{
          // Platine au sol
          const plate=new THREE.Mesh(new THREE.BoxGeometry(0.18,0.008,0.18),scaffMat);
          plate.position.set(mx,baseY+0.004,zz);scaffGroup.add(plate);
          // Tige filetée vérin
          const spinH=0.25;
          makeTube([mx,baseY+0.008,zz],[mx,baseY+spinH,zz],0.016,scaffMat);
          // Écrou de réglage
          const nut=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.04,6),couplerMat);
          nut.position.set(mx,baseY+spinH*0.6,zz);scaffGroup.add(nut);
        });
      }

      // ── Montants verticaux — du pied jusqu'au sommet ──
      const postBase=baseY+0.25;// au-dessus du vérin
      const postTop=baseY+totalH+0.5;// dépasse un peu au-dessus
      for(let bi=0;bi<=nBays;bi++){
        const mx=oX+bi*bayW;
        [zFront,zBack].forEach(zz=>{
          makeTube([mx,postBase,zz],[mx,postTop,zz],tubR,scaffMat);
          // Bouchon haut
          const cap=new THREE.Mesh(new THREE.CylinderGeometry(tubR*1.3,tubR*1.3,0.01,tubSegs),couplerMat);
          cap.position.set(mx,postTop,zz);scaffGroup.add(cap);
        });
      }

      // ── Niveaux: longerons, traverses, planchers, garde-corps, diagonales ──
      for(let li=0;li<=nLevels;li++){
        const ly=baseY+li*levelH;
        // Longerons avant et arrière (tubes horizontaux)
        [zFront,zBack].forEach(zz=>{
          makeTube([oX,ly,zz],[oX+totalW,ly,zz],tubR,scaffMat);
        });
        // Traverses perpendiculaires (relient avant-arrière)
        for(let bi=0;bi<=nBays;bi++){
          const mx=oX+bi*bayW;
          makeTube([mx,ly,zBack],[mx,ly,zFront],tubR,scaffMat);
          // Raccords aux intersections
          [zFront,zBack].forEach(zz=>makeCoupler(mx,ly,zz));
        }

        // Plancher bois (pas au sol, pas au-dessus du dernier niveau)
        if(li>0){
          for(let bi=0;bi<nBays;bi++){
            const px=oX+bi*bayW+bayW/2;
            // Planches individuelles (3 par travée pour le réalisme)
            const nPlanks=3;const plankW=(scaffW-0.08)/nPlanks;
            for(let pi=0;pi<nPlanks;pi++){
              const pz=zBack+0.04+pi*plankW+plankW/2;
              const plank=new THREE.Mesh(new THREE.BoxGeometry(bayW-0.06,0.035,plankW-0.005),planckMat);
              plank.position.set(px,ly+0.017,pz);scaffGroup.add(plank);
            }
          }
        }

        // Diagonales de contreventement (face avant, alternées)
        if(li<nLevels){
          for(let bi=0;bi<nBays;bi++){
            const x1=oX+bi*bayW,x2=oX+(bi+1)*bayW;
            const y1=ly,y2=ly+levelH;
            if((bi+li)%2===0){
              makeTube([x1,y1,zFront],[x2,y2,zFront],tubR*0.55,scaffMat);
            }else{
              makeTube([x2,y1,zFront],[x1,y2,zFront],tubR*0.55,scaffMat);
            }
          }
        }

        // Garde-corps jaune (seulement au-dessus des planchers, face avant + retours latéraux)
        if(li>0){
          // Lisse intermédiaire (0.5m) + lisse haute (1.0m)
          [0.5,1.0].forEach(gh=>{
            // Avant
            makeTube([oX,ly+gh,zFront],[oX+totalW,ly+gh,zFront],tubR*0.65,guardMat);
            // Retours latéraux (gauche et droite)
            makeTube([oX,ly+gh,zBack],[oX,ly+gh,zFront],tubR*0.65,guardMat);
            makeTube([oX+totalW,ly+gh,zBack],[oX+totalW,ly+gh,zFront],tubR*0.65,guardMat);
          });
          // Plinthe bois (protection pied) — face avant
          const plin=new THREE.Mesh(new THREE.BoxGeometry(totalW,0.15,0.025),guardMat);
          plin.position.set(oX+totalW/2,ly+0.075,zFront+tubR);scaffGroup.add(plin);
          // Plinthes latérales
          const plinL=new THREE.Mesh(new THREE.BoxGeometry(0.025,0.15,scaffW),guardMat);
          plinL.position.set(oX-tubR,ly+0.075,zMid);scaffGroup.add(plinL);
          const plinR=new THREE.Mesh(new THREE.BoxGeometry(0.025,0.15,scaffW),guardMat);
          plinR.position.set(oX+totalW+tubR,ly+0.075,zMid);scaffGroup.add(plinR);
        }
      }

      // ── Amarrages facade (ancres au mur, 1 par bay tous les 2 niveaux) ──
      for(let li=1;li<=nLevels;li+=2){
        const ly=baseY+li*levelH;
        for(let bi=0;bi<=nBays;bi++){
          const mx=oX+bi*bayW;
          // Tube d'ancrage vers la facade
          makeTube([mx,ly,zBack],[mx,ly,depth+0.02],tubR*0.5,scaffMat);
          // Platine d'ancrage sur facade
          const anchor=new THREE.Mesh(new THREE.BoxGeometry(0.08,0.08,0.01),couplerMat);
          anchor.position.set(mx,ly,depth+0.015);scaffGroup.add(anchor);
        }
      }
    }
    facadeGroup.add(scaffGroup);

    scene.add(facadeGroup);

    // ── Concrete wall (toggleable) ──
    if(showWall){
      const wallThick=0.18;
      const wallZ=insulZ-insulD-wallThick/2+0.005;// juste derrière l'isolant
      const wallGeo=new THREE.BoxGeometry(Lm+0.1,Hm+0.1,wallThick);
      const wallMat=new THREE.MeshStandardMaterial({color:0x787878,roughness:0.95,metalness:0.02});
      const wall=new THREE.Mesh(wallGeo,wallMat);
      wall.position.set(0,0,wallZ);scene.add(wall);
    }



    // Refs pour toggle visibilité sans recréer la scène
    sceneRef.current={scene,camera,renderer,ossGroup,insulGroup,scaffGroup};

    // Render loop
    const animate=()=>{
      frameRef.current=requestAnimationFrame(animate);
      const d=zoomRef.current;
      ossGroup.visible=showOss3D;
      const px=panRef.current.x,py=panRef.current.y;
      camera.position.set(px+d*Math.sin(rotRef.current.y)*Math.cos(rotRef.current.x),
        py+d*Math.sin(rotRef.current.x),d*Math.cos(rotRef.current.y)*Math.cos(rotRef.current.x));
      camera.lookAt(px,py,0);renderer.render(scene,camera);
    };animate();

    const handleResize=()=>{if(!mountRef.current)return;const w=mountRef.current.clientWidth,h=mountRef.current.clientHeight;
      camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h)};
    window.addEventListener('resize',handleResize);

    // ── Events souris + touch directement sur le canvas WebGL ──
    // (nécessaire sur iOS Safari : le canvas natif intercepte tout avant React)
    const canvas=renderer.domElement;

    const onMD=e=>{
      if(e.button===2||e.shiftKey||e.button===1){
        dragRef.current={x:e.clientX,y:e.clientY,px:panRef.current.x,py:panRef.current.y,mode:'pan'};
      }else{dragRef.current={x:e.clientX,y:e.clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};}
    };
    const onMM=e=>{if(!dragRef.current)return;
      if(dragRef.current.mode==='pan'){
        panRef.current.x=dragRef.current.px-(e.clientX-dragRef.current.x)*0.006;
        panRef.current.y=dragRef.current.py+(e.clientY-dragRef.current.y)*0.006;
      }else{
        rotRef.current.y=dragRef.current.ry+(e.clientX-dragRef.current.x)*0.005;
        rotRef.current.x=Math.max(-1.2,Math.min(1.2,dragRef.current.rx+(e.clientY-dragRef.current.y)*0.005));
      }};
    const onMU=()=>{dragRef.current=null;};
    const onWH=e=>{e.preventDefault();zoomRef.current=Math.max(0.15,Math.min(60,zoomRef.current*(1+e.deltaY*0.0012)));};

    // Touch : 1 doigt = rotation, 2 doigts = pan horizontal/vertical + pinch zoom
    const onTS=e=>{
      // Pas de preventDefault ici — bloquerait les taps sur les boutons iOS
      const t=e.touches;
      if(t.length===1){
        dragRef.current={x:t[0].clientX,y:t[0].clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};
        pinchRef.current=null;
      }else if(t.length===2){
        const dx=t[1].clientX-t[0].clientX,dy=t[1].clientY-t[0].clientY;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const mx=(t[0].clientX+t[1].clientX)/2,my=(t[0].clientY+t[1].clientY)/2;
        pinchRef.current={dist,zoom:zoomRef.current};
        // Stocker position initiale du centre pour le pan
        dragRef.current={x:mx,y:my,px:panRef.current.x,py:panRef.current.y,mode:'pan'};
      }
    };
    const onTM=e=>{
      e.preventDefault();
      const t=e.touches;
      if(t.length===1&&dragRef.current?.mode==='rot'){
        rotRef.current.y=dragRef.current.ry+(t[0].clientX-dragRef.current.x)*0.005;
        rotRef.current.x=Math.max(-1.2,Math.min(1.2,dragRef.current.rx+(t[0].clientY-dragRef.current.y)*0.005));
      }else if(t.length===2){
        const dx=t[1].clientX-t[0].clientX,dy=t[1].clientY-t[0].clientY;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const mx=(t[0].clientX+t[1].clientX)/2,my=(t[0].clientY+t[1].clientY)/2;
        // Pinch → zoom
        if(pinchRef.current){
          zoomRef.current=Math.max(0.15,Math.min(60,pinchRef.current.zoom*(pinchRef.current.dist/dist)));
        }
        // Translation 2 doigts → pan (horizontal prioritaire, sensibilité augmentée)
        if(dragRef.current?.mode==='pan'){
          panRef.current.x=dragRef.current.px-(mx-dragRef.current.x)*0.008;
          panRef.current.y=dragRef.current.py+(my-dragRef.current.y)*0.008;
        }
      }
    };
    const onTE=e=>{
      if(e.touches.length===0){dragRef.current=null;pinchRef.current=null;}
      else if(e.touches.length===1){
        // Retour à 1 doigt après 2 → reprendre rotation depuis position actuelle
        dragRef.current={x:e.touches[0].clientX,y:e.touches[0].clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};
        pinchRef.current=null;
      }
    };

    canvas.addEventListener('mousedown',onMD);
    canvas.addEventListener('mousemove',onMM,{passive:true});
    canvas.addEventListener('mouseup',onMU);
    canvas.addEventListener('mouseleave',onMU);
    canvas.addEventListener('wheel',onWH,{passive:false});
    canvas.addEventListener('touchstart',onTS,{passive:true});
    canvas.addEventListener('touchmove',onTM,{passive:false});
    canvas.addEventListener('touchend',onTE);
    canvas.addEventListener('touchcancel',onTE);
    canvas.addEventListener('contextmenu',e=>e.preventDefault());

    return()=>{
      cancelAnimationFrame(frameRef.current);
      window.removeEventListener('resize',handleResize);
      canvas.removeEventListener('mousedown',onMD);canvas.removeEventListener('mousemove',onMM);
      canvas.removeEventListener('mouseup',onMU);canvas.removeEventListener('mouseleave',onMU);
      canvas.removeEventListener('wheel',onWH);canvas.removeEventListener('touchstart',onTS);
      canvas.removeEventListener('touchmove',onTM);canvas.removeEventListener('touchend',onTE);
      canvas.removeEventListener('touchcancel',onTE);
      renderer.dispose();if(mountRef.current)mountRef.current.innerHTML='';
    };
  },[zone,calc,ralColor,ralFinish,showOss3D,showWall,showInsul,insulThick,showScaff,scaff]);


  return<div style={{position:'absolute',inset:0,zIndex:10,background:'#13151f'}}>
    <div ref={mountRef} style={{position:'absolute',inset:0,touchAction:'none',pointerEvents:'none'}}/>
    <div style={{position:'absolute',top:10,left:10,right:10,zIndex:50,display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}
      onMouseDown={e=>e.stopPropagation()} onTouchStart={e=>e.stopPropagation()}>
      <div style={{display:'flex',gap:5,padding:5,background:'rgba(12,14,28,.88)',borderRadius:10,backdropFilter:'blur(10px)',WebkitBackdropFilter:'blur(10px)'}}>
        {[{l:isMobile?'\u2190 2D':'\u2190 Vue 2D',fn:onClose,col:'red',hide:hideBack},{l:'Reset',fn:()=>{rotRef.current={x:-.3,y:.4};zoomRef.current=3;panRef.current={x:0,y:0}}},{l:'Face',fn:()=>{rotRef.current={x:0,y:0};zoomRef.current=3}}
        ].filter(b=>!b.hide).map(b=><button key={b.l} onClick={b.fn} style={{border:'none',cursor:'pointer',padding:isMobile?'8px 10px':'7px 14px',borderRadius:7,fontSize:10,fontWeight:600,fontFamily:'DM Sans',background:b.col==='red'?'rgba(139,26,43,.45)':'rgba(40,44,65,.9)',color:b.col==='red'?'#fca5a5':'rgba(255,255,255,.65)',boxShadow:'0 0 0 1px rgba(255,255,255,.08)'}}>{b.l}</button>)}
      </div>
      <div style={{display:'flex',gap:5,padding:5,background:'rgba(12,14,28,.88)',borderRadius:10,backdropFilter:'blur(10px)',WebkitBackdropFilter:'blur(10px)'}}>
        {[{l:'Ossature',fn:()=>setShowOss3D(v=>!v),a:showOss3D,col:'amber'},{l:'Isolant',fn:()=>setShowInsul(v=>!v),a:showInsul,col:'yellow'},{l:isMobile?'B\u00e9ton':'Mur b\u00e9ton',fn:()=>onToggle('wall'),a:showWall,col:'blue'}
        ].map(b=><button key={b.l} onClick={b.fn} style={{border:'none',cursor:'pointer',padding:isMobile?'8px 10px':'7px 14px',borderRadius:7,fontSize:10,fontWeight:600,fontFamily:'DM Sans',background:b.a?(b.col==='amber'?'rgba(245,158,11,.3)':b.col==='yellow'?'rgba(232,200,64,.25)':'rgba(79,110,247,.3)'):'rgba(40,44,65,.9)',color:b.a?(b.col==='amber'?'#fbbf24':b.col==='yellow'?'#e8c840':'#93c5fd'):'rgba(255,255,255,.55)',boxShadow:b.a?'0 0 0 1.5px '+(b.col==='amber'?'rgba(245,158,11,.5)':b.col==='yellow'?'rgba(232,200,64,.4)':'rgba(79,110,247,.5)'):'0 0 0 1px rgba(255,255,255,.08)'}}>{b.l}</button>)}
        {showInsul&&<select value={insulThick} onChange={e=>setInsulThick(Number(e.target.value))}
          onMouseDown={e=>e.stopPropagation()} onTouchStart={e=>e.stopPropagation()}
          style={{background:'rgba(232,200,64,.15)',border:'1px solid rgba(232,200,64,.3)',color:'#e8c840',borderRadius:6,padding:'5px 6px',fontSize:9,fontWeight:600,fontFamily:'DM Sans',cursor:'pointer',outline:'none'}}>
          {[60,80,100,120,140,160,180,200,240].map(v=><option key={v} value={v} style={{background:'#1a1a26',color:'#e8c840'}}>{v}mm</option>)}
        </select>}
        <div style={{width:1,height:18,background:'rgba(255,255,255,.1)',margin:'0 2px'}}/>
        <button onClick={()=>setShowScaff(v=>!v)} style={{border:'none',cursor:'pointer',padding:isMobile?'8px 10px':'7px 14px',borderRadius:7,fontSize:10,fontWeight:600,fontFamily:'DM Sans',
          background:showScaff?'rgba(16,185,129,.25)':'rgba(40,44,65,.9)',color:showScaff?'#34d399':'rgba(255,255,255,.55)',
          boxShadow:showScaff?'0 0 0 1.5px rgba(16,185,129,.4)':'0 0 0 1px rgba(255,255,255,.08)'}}>🏗 {isMobile?'':'Échafaudage'}</button>
      </div>
    </div>
    {/* ── Panneau config échafaudage ── */}
    {showScaff&&<div style={{position:'absolute',top:60,right:10,zIndex:50,background:'rgba(12,14,28,.92)',backdropFilter:'blur(12px)',WebkitBackdropFilter:'blur(12px)',borderRadius:12,padding:14,width:isMobile?200:220,border:'1px solid rgba(16,185,129,.2)',boxShadow:'0 10px 40px rgba(0,0,0,.5)'}}
      onMouseDown={e=>e.stopPropagation()} onTouchStart={e=>e.stopPropagation()}>
      <div style={{fontSize:11,fontWeight:700,color:'#34d399',marginBottom:10,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <span>🏗 Échafaudage</span>
        <button onClick={()=>setShowScaff(false)} style={{background:'none',border:'none',color:'rgba(255,255,255,.3)',cursor:'pointer',fontSize:14}}>×</button>
      </div>
      {[
        {label:'Travées',key:'nBays',min:1,max:15,step:1,unit:''},
        {label:'Niveaux',key:'nLevels',min:1,max:12,step:1,unit:''},
        {label:'Larg. travée',key:'bayW',min:0.73,max:4,step:0.01,unit:'m'},
        {label:'Haut. niveau',key:'levelH',min:1.0,max:3,step:0.05,unit:'m'},
        {label:'Profondeur',key:'scaffW',min:0.6,max:1.5,step:0.01,unit:'m'},
        {label:'Dist. facade',key:'dist',min:0.15,max:3,step:0.05,unit:'m'},
        {label:'Décalage X',key:'x',min:-15,max:15,step:0.1,unit:'m'},
        {label:'Décalage Y',key:'y',min:-2,max:5,step:0.1,unit:'m'},
      ].map(s=><div key={s.key} style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
        <span style={{fontSize:9,color:'rgba(255,255,255,.5)',width:75,flexShrink:0}}>{s.label}</span>
        <input type="range" min={s.min} max={s.max} step={s.step} value={scaff[s.key]}
          onChange={e=>setScaff(prev=>({...prev,[s.key]:parseFloat(e.target.value)}))}
          style={{flex:1,accentColor:'#34d399',height:4}}/>
        <span style={{fontSize:9,color:'#34d399',width:40,textAlign:'right',fontFamily:'monospace',flexShrink:0}}>{typeof scaff[s.key]==='number'&&scaff[s.key]%1!==0?scaff[s.key].toFixed(2):scaff[s.key]}{s.unit}</span>
      </div>)}
      <div style={{borderTop:'1px solid rgba(255,255,255,.06)',marginTop:6,paddingTop:8,fontSize:9,color:'rgba(255,255,255,.35)'}}>
        {(scaff.nBays*scaff.bayW).toFixed(1)}m × {(scaff.nLevels*scaff.levelH).toFixed(1)}m — prof. {scaff.scaffW}m — {scaff.nBays*(scaff.nLevels+1)} cadres
      </div>
    </div>}
    <div style={{position:'absolute',bottom:isMobile?'calc(10px + env(safe-area-inset-bottom, 0px))':10,left:'50%',transform:'translateX(-50%)',zIndex:40,pointerEvents:'none',background:'rgba(10,12,20,.7)',backdropFilter:'blur(8px)',WebkitBackdropFilter:'blur(8px)',borderRadius:8,padding:'5px 14px',whiteSpace:'nowrap'}}>
      <span style={{fontSize:10,color:'rgba(255,255,255,.3)',fontFamily:'monospace'}}>{isMobile?'1 doigt: rotation \u00b7 2 doigts: zoom/pan':'Drag: rotation \u00b7 Shift+drag: pan \u00b7 Molette: zoom'}</span>
      <span style={{fontSize:10,fontFamily:'monospace',padding:'2px 8px',marginLeft:8,borderRadius:5,background:'rgba(79,110,247,.2)',color:'#93c5fd'}}>{(zone.L/1000).toFixed(2)}\u00d7{(zone.H/1000).toFixed(2)} m \u00b7 {calc.nP} pan.</span>
    </div>
  </div>;
}

/* ═══ MAIN APP ═══ */
// ═══════════════════════════════════════════════════════════
// SUPABASE + QR CODE HELPERS
// ═══════════════════════════════════════════════════════════
const SUPA_STORAGE_KEY='kalepin_supabase';
const SUPA_DEFAULTS={url:'https://kaawdguztacoagfhhcgz.supabase.co',key:'sb_publishable_5AGy4vctveV8pk8Fzb5fsw_xqCoSsMU',viewerUrl:''};
function getSupaConfig(){try{const stored=JSON.parse(localStorage.getItem(SUPA_STORAGE_KEY)||'{}');return{url:stored.url||SUPA_DEFAULTS.url,key:stored.key||SUPA_DEFAULTS.key,viewerUrl:stored.viewerUrl||SUPA_DEFAULTS.viewerUrl}}catch(e){return SUPA_DEFAULTS}}
function setSupaConfig(cfg){localStorage.setItem(SUPA_STORAGE_KEY,JSON.stringify(cfg))}

// ═══════════════════════════════════════════════════════════
// SUPABASE AUTH
// ═══════════════════════════════════════════════════════════
const AUTH_STORAGE_KEY='kalepin_auth_session';
const SUPA=SUPA_DEFAULTS;

function getAuthSession(){try{return JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY)||'null')}catch(e){return null}}
function setAuthSession(session){if(session)localStorage.setItem(AUTH_STORAGE_KEY,JSON.stringify(session));else localStorage.removeItem(AUTH_STORAGE_KEY)}

async function authSignUp(email,password,fullName){
  const res=await fetch(SUPA.url+'/auth/v1/signup',{
    method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key},
    body:JSON.stringify({email,password,data:{full_name:fullName||''}})
  });
  const data=await res.json();if(!res.ok)throw new Error(data.error_description||data.msg||data.error||'Erreur inscription');
  // If email confirmation is disabled, we get a session back
  if(data.access_token){
    const session={access_token:data.access_token,refresh_token:data.refresh_token,user:data.user,expires_at:Date.now()+data.expires_in*1000};
    setAuthSession(session);return session;
  }
  return data; // email confirmation needed
}

async function authSignIn(email,password){
  const res=await fetch(SUPA.url+'/auth/v1/token?grant_type=password',{
    method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key},
    body:JSON.stringify({email,password})
  });
  const data=await res.json();if(!res.ok)throw new Error(data.error_description||data.msg||data.error||'Email ou mot de passe incorrect');
  const session={access_token:data.access_token,refresh_token:data.refresh_token,user:data.user,expires_at:Date.now()+data.expires_in*1000};
  setAuthSession(session);return session;
}

async function authRefresh(){
  const s=getAuthSession();if(!s?.refresh_token)return null;
  try{
    const res=await fetch(SUPA.url+'/auth/v1/token?grant_type=refresh_token',{
      method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key},
      body:JSON.stringify({refresh_token:s.refresh_token})
    });
    if(!res.ok){setAuthSession(null);return null}
    const data=await res.json();
    const session={access_token:data.access_token,refresh_token:data.refresh_token,user:data.user,expires_at:Date.now()+data.expires_in*1000};
    setAuthSession(session);return session;
  }catch(e){return null}
}

async function authSignOut(){
  const s=getAuthSession();
  if(s?.access_token){
    try{await fetch(SUPA.url+'/auth/v1/logout',{method:'POST',headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}})}catch(e){}
  }
  setAuthSession(null);
}

async function authGetUser(){
  let s=getAuthSession();if(!s)return null;
  // Refresh if expired or about to expire (5min buffer)
  if(s.expires_at && Date.now()>s.expires_at-300000){s=await authRefresh();if(!s)return null}
  try{
    const res=await fetch(SUPA.url+'/auth/v1/user',{headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}});
    if(!res.ok){if(res.status===401){const refreshed=await authRefresh();if(!refreshed)return null;
      const res2=await fetch(SUPA.url+'/auth/v1/user',{headers:{'apikey':SUPA.key,'Authorization':'Bearer '+refreshed.access_token}});
      if(!res2.ok){setAuthSession(null);return null}return await res2.json();}
      setAuthSession(null);return null}
    return await res.json();
  }catch(e){return null}
}

// ═══════════════════════════════════════════════════════════
// BETA APPROVAL + PROFILE
// ═══════════════════════════════════════════════════════════
// Retourne {data, error:'table_missing'|'rls'|'network'|null, details?}
async function fetchUserProfile(userId){
  const s=getAuthSession();if(!s)return{data:null,error:'no_session'};
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_profiles?id=eq.'+userId+'&select=*&limit=1',{
      headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token,'Accept':'application/json'}
    });
    if(!res.ok){
      const body=await res.json().catch(()=>({}));
      console.warn('[Kalepin] fetchProfile HTTP',res.status,body);
      if(body?.code==='42P01'||body?.message?.includes('does not exist'))return{data:null,error:'table_missing'};
      return{data:null,error:'rls',details:'HTTP '+res.status+': '+(body?.message||body?.hint||JSON.stringify(body))};
    }
    const d=await res.json();return{data:d[0]||null,error:null};
  }catch(e){console.warn('[Kalepin] fetchProfile network',e);return{data:null,error:'network',details:e.message}}
}

async function ensureProfile(user){
  const s=getAuthSession();if(!s)return{data:null,error:'no_session'};
  // Try fetching profile up to 2 times (handles transient RLS/timing issues)
  let fetchResult=null;
  for(let attempt=0;attempt<2;attempt++){
    fetchResult=await fetchUserProfile(user.id);
    if(fetchResult.error==='table_missing')return{data:null,error:'table_missing'};
    if(fetchResult.data)return{data:fetchResult.data,error:null};
    if(fetchResult.error==='rls'&&attempt===0){await new Promise(r=>setTimeout(r,1000));continue}
    break;
  }
  // SELECT itself returned an error → don't attempt INSERT
  if(fetchResult.error&&fetchResult.error!=='network'){return fetchResult}
  // Profil absent (SELECT 200 empty) → create it
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_profiles',{
      method:'POST',
      headers:{'Content-Type':'application/json','apikey':SUPA.key,
        'Authorization':'Bearer '+s.access_token,'Prefer':'return=representation'},
      body:JSON.stringify({id:user.id,email:user.email,
        full_name:user.user_metadata?.full_name||user.email.split('@')[0],
        status:'pending',role:'user'})
    });
    if(!res.ok){
      const body=await res.json().catch(()=>({}));
      console.warn('[Kalepin] insertProfile HTTP',res.status,body);
      if(body?.code==='42P01'||body?.message?.includes('does not exist'))return{data:null,error:'table_missing'};
      if(res.status===409||body?.code==='23505'){
        const retry=await fetchUserProfile(user.id);
        return retry;
      }
      return{data:null,error:'insert_failed',details:'HTTP '+res.status+': '+(body?.message||body?.hint||JSON.stringify(body))};
    }
    const d=await res.json();return{data:d[0]||null,error:null};
  }catch(e){return{data:null,error:'network',details:e.message}}
}

// Admin functions
async function adminListUsers(filterStatus){
  const s=getAuthSession();if(!s)return[];
  const q=filterStatus?'&status=eq.'+filterStatus:'';
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_profiles?select=*&order=created_at.desc'+q,{
      headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}
    });
    if(!res.ok)return[];return await res.json();
  }catch(e){return[]}
}

async function adminSetUserStatus(userId,status){
  const s=getAuthSession();if(!s)return false;
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_profiles?id=eq.'+userId,{
      method:'PATCH',
      headers:{'Content-Type':'application/json','apikey':SUPA.key,'Authorization':'Bearer '+s.access_token},
      body:JSON.stringify({status,updated_at:new Date().toISOString()})
    });
    return res.ok;
  }catch(e){return false}
}

async function adminSetUserRole(userId,role){
  const s=getAuthSession();if(!s)return false;
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_profiles?id=eq.'+userId,{
      method:'PATCH',
      headers:{'Content-Type':'application/json','apikey':SUPA.key,'Authorization':'Bearer '+s.access_token},
      body:JSON.stringify({role,updated_at:new Date().toISOString()})
    });
    return res.ok;
  }catch(e){return false}
}

// ═══════════════════════════════════════════════════════════
// SUBSCRIPTION & STRIPE
// ═══════════════════════════════════════════════════════════
const PLANS={
  solo:{id:'solo',name:'Solo',price:39,features:['1 utilisateur','Projets illimites','Export PDF & Excel','Vue 3D + QR chantier']},
  equipe:{id:'equipe',name:'Equipe',price:99,features:['5 utilisateurs','Partage de projets','Import DXF/DWG','Support prioritaire']},
  entreprise:{id:'entreprise',name:'Entreprise',price:249,features:['Utilisateurs illimites','API & integrations','Export DSTV/CNC','Account manager']}
};
const TRIAL_DAYS=14;
const STRIPE_CONFIG_KEY='kalepin_stripe';
// User sets these after creating Stripe products
function getStripeConfig(){try{return JSON.parse(localStorage.getItem(STRIPE_CONFIG_KEY)||'{}')}catch(e){return{}}}

async function fetchSubscription(userId){
  const s=getAuthSession();if(!s)return null;
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_subscriptions?user_id=eq.'+userId+'&select=*&order=created_at.desc&limit=1',{
      headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}
    });
    if(!res.ok)return null;const data=await res.json();return data[0]||null;
  }catch(e){return null}
}

async function createTrialSubscription(userId,email){
  const s=getAuthSession();if(!s)return null;
  const now=new Date();const trialEnd=new Date(now.getTime()+TRIAL_DAYS*86400000);
  const sub={user_id:userId,email:email,plan:'solo',status:'trialing',
    trial_start:now.toISOString(),trial_end:trialEnd.toISOString(),
    stripe_customer_id:null,stripe_subscription_id:null};
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_subscriptions',{
      method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key,
        'Authorization':'Bearer '+s.access_token,'Prefer':'return=representation'},
      body:JSON.stringify(sub)
    });
    if(!res.ok)return null;const data=await res.json();return data[0]||sub;
  }catch(e){return null}
}

function getSubscriptionStatus(sub){
  if(!sub)return{active:false,status:'none',daysLeft:0};
  if(sub.status==='active')return{active:true,status:'active',plan:sub.plan,daysLeft:null};
  if(sub.status==='trialing'){
    const now=new Date();const end=new Date(sub.trial_end);
    const diff=Math.ceil((end-now)/86400000);
    return{active:diff>0,status:'trialing',plan:sub.plan,daysLeft:Math.max(0,diff)};
  }
  if(sub.status==='past_due')return{active:true,status:'past_due',plan:sub.plan,daysLeft:null};
  return{active:false,status:sub.status||'expired',daysLeft:0};
}

// ── Paywall Component ──
function Paywall({user,onClose,currentPlan}){
  const[billing,setBilling]=useState('monthly');
  const[selected,setSelected]=useState('equipe');
  const[loading,setLoading]=useState(false);

  const discount=billing==='annual'?0.17:0;
  const plans=[
    {id:'solo',name:'Solo',monthly:39,color:'#5a5a7e',badge:null,
     features:['1 utilisateur','Projets illimités','Export PDF & Excel','Vue 3D + QR chantier','Support email']},
    {id:'equipe',name:'Équipe',monthly:99,color:'#c4324a',badge:'Populaire',
     features:['5 utilisateurs','Partage de projets','Import DXF/DWG','Catalogue fabricants','Support prioritaire']},
    {id:'entreprise',name:'Entreprise',monthly:249,color:'#0ea5e9',badge:'Best value',
     features:['Utilisateurs illimités','API & intégrations','Export DSTV/CNC','Marque blanche','Account manager']},
  ];

  const price=(p)=>billing==='annual'?Math.round(p*(1-discount)):p;

  const handleCheckout=async(planId)=>{
    setLoading(planId);
    const s=getAuthSession();
    try{
      const res=await fetch(SUPA.url+'/functions/v1/stripe-checkout',{
        method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key,'Authorization':'Bearer '+s.access_token},
        body:JSON.stringify({plan:planId,billing,email:user.email,userId:user.id,returnUrl:window.location.origin+window.location.pathname})
      });
      if(res.ok){const d=await res.json();if(d.url)window.location.href=d.url;else throw new Error()}
      else throw new Error();
    }catch(e){
      alert('Paiement non configuré.\nDéployez la Edge Function stripe-checkout sur Supabase.');
    }
    setLoading(false);
  };

  return<div className="ov" onClick={onClose}>
    <div onClick={e=>e.stopPropagation()} style={{background:'#0e0e18',border:'1px solid var(--bd)',borderRadius:24,width:'min(900px,96vw)',maxHeight:'92vh',overflowY:'auto',boxShadow:'0 40px 100px rgba(0,0,0,.7)',animation:'fu .25s ease-out'}}>

      {/* Header */}
      <div style={{padding:'28px 32px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
        <div>
          <div style={{fontSize:22,fontWeight:800,color:'var(--t1)',letterSpacing:'-.02em'}}>Choisissez votre plan</div>
          <div style={{fontSize:13,color:'var(--t3)',marginTop:4}}>Essai gratuit 14 jours — résiliez à tout moment</div>
        </div>
        <button onClick={onClose} style={{background:'var(--crd)',border:'1px solid var(--bd)',borderRadius:8,width:34,height:34,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',color:'var(--t3)',fontSize:18,flexShrink:0}}>×</button>
      </div>

      {/* Billing toggle */}
      <div style={{display:'flex',justifyContent:'center',margin:'20px 0 24px',gap:0}}>
        <div style={{display:'inline-flex',background:'var(--crd)',borderRadius:10,border:'1px solid var(--bd)',padding:3,gap:2}}>
          {['monthly','annual'].map(b=><button key={b} onClick={()=>setBilling(b)} style={{
            padding:'6px 20px',borderRadius:7,fontSize:12,fontWeight:600,border:'none',cursor:'pointer',fontFamily:'inherit',transition:'all .2s',
            background:billing===b?'var(--bl)':'transparent',color:billing===b?'#fff':'var(--t3)'
          }}>{b==='monthly'?'Mensuel':'Annuel'}{b==='annual'&&<span style={{marginLeft:6,padding:'1px 6px',background:'rgba(16,185,129,.25)',color:'#10b981',borderRadius:20,fontSize:9,fontWeight:700}}>-17%</span>}</button>)}
        </div>
      </div>

      {/* Plans */}
      <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12,padding:'0 24px 28px'}}>
        {plans.map(plan=>{
          const isSel=selected===plan.id;
          const isCur=currentPlan===plan.id;
          return<div key={plan.id} onClick={()=>setSelected(plan.id)} style={{
            background:isSel?'rgba(196,50,74,.06)':'var(--crd)',
            border:`2px solid ${isSel?plan.color:isCur?'var(--gn)':'var(--bd)'}`,
            borderRadius:16,padding:22,cursor:'pointer',transition:'all .2s',position:'relative',
            boxShadow:isSel?`0 0 0 3px ${plan.color}22`:'none'
          }}>
            {plan.badge&&<div style={{position:'absolute',top:-11,left:'50%',transform:'translateX(-50%)',
              background:plan.color,color:'#fff',padding:'3px 14px',borderRadius:20,fontSize:9,fontWeight:700,whiteSpace:'nowrap'}}>
              {plan.badge}</div>}
            {isCur&&<div style={{position:'absolute',top:-11,right:14,
              background:'var(--gn)',color:'#fff',padding:'2px 10px',borderRadius:20,fontSize:9,fontWeight:700}}>Plan actuel</div>}

            <div style={{fontSize:11,fontWeight:700,color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.1em',marginBottom:8}}>{plan.name}</div>
            <div style={{display:'flex',alignItems:'baseline',gap:4,marginBottom:4}}>
              <span style={{fontSize:38,fontWeight:900,color:'var(--t1)',letterSpacing:'-.03em'}}>{price(plan.monthly)}</span>
              <span style={{fontSize:13,color:'var(--t3)'}}>€/mois</span>
            </div>
            {billing==='annual'&&<div style={{fontSize:11,color:'#10b981',marginBottom:12}}>
              soit {price(plan.monthly)*12} €/an — {Math.round(plan.monthly*discount*12)} € économisés
            </div>}
            <div style={{height:1,background:'var(--bd)',margin:'12px 0'}}/>
            <div style={{display:'flex',flexDirection:'column',gap:7,marginBottom:20}}>
              {plan.features.map((f,i)=><div key={i} style={{fontSize:12,color:'var(--t2)',display:'flex',alignItems:'center',gap:8}}>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><circle cx="6" cy="6" r="6" fill={plan.color} opacity=".2"/><path d="M3.5 6l2 2 3-3" stroke={plan.color} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
                {f}
              </div>)}
            </div>
            <button onClick={e=>{e.stopPropagation();handleCheckout(plan.id)}}
              disabled={isCur||loading===plan.id}
              style={{width:'100%',padding:'11px',borderRadius:10,border:'none',fontSize:13,fontWeight:700,
                cursor:isCur?'default':'pointer',fontFamily:'inherit',transition:'all .2s',
                background:isCur?'var(--crd2)':isSel?plan.color:'var(--crd2)',
                color:isCur?'var(--t3)':isSel?'#fff':'var(--t1)',
                opacity:loading===plan.id?.6:1
              }}>
              {isCur?'Plan actuel':loading===plan.id?'…':'Commencer →'}
            </button>
          </div>
        })}
      </div>

      {/* Footer */}
      <div style={{borderTop:'1px solid var(--bd)',padding:'14px 28px',display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:8}}>
        <div style={{display:'flex',gap:20}}>
          {['🔒 Paiement sécurisé Stripe','📧 Support réactif','↩ Résiliation libre'].map(t=><span key={t} style={{fontSize:11,color:'var(--t3)'}}>{t}</span>)}
        </div>
        <span style={{fontSize:11,color:'var(--t3)',fontStyle:'italic'}}>Tous les prix HT</span>
      </div>
    </div>
  </div>;
}

// ── Trial Banner ──
function TrialBanner({subStatus,onUpgrade}){
  if(!subStatus||subStatus.status==='active')return null;
  if(subStatus.status==='trialing'&&subStatus.daysLeft>7)return null;
  const urgent=subStatus.daysLeft<=3;
  const expired=!subStatus.active;
  const col=expired?'#ef4444':urgent?'#f59e0b':'#0ea5e9';
  return<div style={{
    background:`${col}12`,border:`1px solid ${col}30`,
    borderRadius:8,padding:'7px 14px',display:'flex',alignItems:'center',gap:10,fontSize:11,animation:'fu .3s ease-out'
  }}>
    <span style={{fontSize:14}}>{expired?'⚠️':'⏱'}</span>
    <span style={{fontWeight:700,color:col}}>
      {expired?'Essai terminé':subStatus.daysLeft===0?'Expire aujourd\'hui':`${subStatus.daysLeft} jour${subStatus.daysLeft>1?'s':''} restant${subStatus.daysLeft>1?'s':''}`}
    </span>
    <span style={{color:'var(--t2)',flex:1}}>{expired?'Abonnez-vous pour continuer à utiliser Kalepin.':'sur votre essai gratuit.'}</span>
    <button onClick={onUpgrade} className="ba" style={{
      padding:'5px 16px',borderRadius:6,fontSize:11,fontWeight:700,border:'none',cursor:'pointer',fontFamily:'inherit',
      background:expired?'#c4324a':'var(--crd)',color:expired?'#fff':'var(--bl)',
      boxShadow:expired?'0 2px 12px rgba(196,50,74,.4)':'none',flexShrink:0
    }}>{expired?'S\'abonner maintenant':'Voir les plans'}</button>
  </div>;
}

// ── AccountSettings Modal ──
function AccountSettings({user,onClose}){
  const[tab,setTab]=useState('profil');
  const[name,setName]=useState(user?.user_metadata?.full_name||'');
  const[saving,setSaving]=useState(false);
  const[msg,setMsg]=useState(null);
  const[pwd,setPwd]=useState({cur:'',next:'',confirm:''});
  const[showPwd,setShowPwd]=useState({cur:false,next:false});

  const saveName=async()=>{
    setSaving(true);setMsg(null);
    try{
      const s=getAuthSession();
      const res=await fetch(SUPA.url+'/auth/v1/user',{method:'PUT',
        headers:{'Content-Type':'application/json','apikey':SUPA.key,'Authorization':'Bearer '+s.access_token},
        body:JSON.stringify({data:{full_name:name}})});
      if(res.ok)setMsg({type:'ok',text:'Nom mis à jour !'});
      else throw new Error('Erreur serveur');
    }catch(e){setMsg({type:'err',text:e.message})}finally{setSaving(false);}
  };

  const savePassword=async()=>{
    if(pwd.next!==pwd.confirm){setMsg({type:'err',text:'Les mots de passe ne correspondent pas'});return}
    if(pwd.next.length<6){setMsg({type:'err',text:'Minimum 6 caractères'});return}
    setSaving(true);setMsg(null);
    try{
      const s=getAuthSession();
      const res=await fetch(SUPA.url+'/auth/v1/user',{method:'PUT',
        headers:{'Content-Type':'application/json','apikey':SUPA.key,'Authorization':'Bearer '+s.access_token},
        body:JSON.stringify({password:pwd.next})});
      if(res.ok){setMsg({type:'ok',text:'Mot de passe modifié !'});setPwd({cur:'',next:'',confirm:''});}
      else throw new Error('Erreur — vérifiez le mot de passe actuel');
    }catch(e){setMsg({type:'err',text:e.message})}finally{setSaving(false);}
  };

  const initials=(user?.user_metadata?.full_name||user?.email||'U').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);

  const tabStyle=(t)=>({padding:'8px 16px',borderRadius:8,fontSize:12,fontWeight:600,border:'none',cursor:'pointer',
    fontFamily:'inherit',transition:'all .15s',
    background:tab===t?'var(--bl)':'transparent',color:tab===t?'#fff':'var(--t3)'});

  const inpStyle={width:'100%',padding:'11px 14px',background:'var(--inp)',border:'1.5px solid var(--bd)',borderRadius:10,
    color:'var(--t1)',fontSize:13,fontFamily:'inherit',outline:'none',boxSizing:'border-box',transition:'border .2s'};

  return<div className="ov" onClick={onClose}>
    <div onClick={e=>e.stopPropagation()} style={{background:'var(--pnl)',border:'1px solid var(--bd)',borderRadius:20,
      width:'min(480px,95vw)',maxHeight:'85vh',overflowY:'auto',boxShadow:'0 30px 80px rgba(0,0,0,.6)',animation:'fu .2s ease-out'}}>

      {/* Header */}
      <div style={{padding:'20px 24px 16px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:14}}>
        <div style={{width:46,height:46,borderRadius:13,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:17,fontWeight:800,color:'#fff',flexShrink:0,boxShadow:'0 4px 16px rgba(196,50,74,.3)'}}>
          {initials}
        </div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontSize:15,fontWeight:700,color:'var(--t1)'}}>{user?.user_metadata?.full_name||'Mon compte'}</div>
          <div style={{fontSize:11,color:'var(--t3)',marginTop:2}}>{user?.email}</div>
        </div>
        <button onClick={onClose} style={{background:'var(--crd)',border:'1px solid var(--bd)',borderRadius:8,width:32,height:32,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',color:'var(--t3)',fontSize:16,flexShrink:0}}>×</button>
      </div>

      {/* Tabs */}
      <div style={{display:'flex',gap:4,padding:'12px 16px 0',borderBottom:'1px solid var(--bd)'}}>
        {[['profil','👤 Profil'],['securite','🔒 Sécurité']].map(([t,l])=>(
          <button key={t} onClick={()=>{setTab(t);setMsg(null);}} style={tabStyle(t)}>{l}</button>
        ))}
      </div>

      <div style={{padding:'20px 24px'}}>
        {msg&&<div style={{padding:'10px 14px',borderRadius:10,marginBottom:16,fontSize:13,display:'flex',alignItems:'center',gap:8,
          background:msg.type==='ok'?'rgba(16,185,129,.1)':'rgba(239,68,68,.1)',
          border:`1px solid ${msg.type==='ok'?'rgba(16,185,129,.25)':'rgba(239,68,68,.25)'}`,
          color:msg.type==='ok'?'#10b981':'#ef4444'}}>
          {msg.type==='ok'?'✓':'⚠'} {msg.text}
        </div>}

        {tab==='profil'&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
          <div>
            <label style={{fontSize:11,fontWeight:600,color:'var(--t3)',marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:'.06em'}}>Nom complet</label>
            <input value={name} onChange={e=>setName(e.target.value)} style={inpStyle}
              onFocus={e=>e.target.style.borderColor='#c4324a'} onBlur={e=>e.target.style.borderColor='var(--bd)'}
              onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter')saveName()}} placeholder="Votre nom"/>
          </div>
          <div>
            <label style={{fontSize:11,fontWeight:600,color:'var(--t3)',marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:'.06em'}}>Email</label>
            <input value={user?.email||''} disabled style={{...inpStyle,opacity:.5,cursor:'not-allowed'}}/>
            <div style={{fontSize:10,color:'var(--t3)',marginTop:4}}>L'email ne peut pas être modifié</div>
          </div>
          <button onClick={saveName} disabled={saving} style={{padding:'11px',background:saving?'#5a1120':'#c4324a',color:'#fff',border:'none',borderRadius:10,fontSize:13,fontWeight:700,cursor:saving?'wait':'pointer',fontFamily:'inherit',transition:'all .2s'}}>
            {saving?'Sauvegarde…':'Enregistrer'}
          </button>
        </div>}

        {tab==='securite'&&<div style={{display:'flex',flexDirection:'column',gap:14}}>
          <div style={{padding:'12px 14px',background:'rgba(14,165,233,.06)',border:'1px solid rgba(14,165,233,.15)',borderRadius:10,fontSize:12,color:'var(--t3)'}}>
            ℹ Changez votre mot de passe Kalepin. Vous serez redirigé pour vous reconnecter.
          </div>
          {[
            {key:'next',label:'Nouveau mot de passe',ph:'6 caractères minimum'},
            {key:'confirm',label:'Confirmer',ph:'Répétez le mot de passe'},
          ].map(f=><div key={f.key}>
            <label style={{fontSize:11,fontWeight:600,color:'var(--t3)',marginBottom:6,display:'block',textTransform:'uppercase',letterSpacing:'.06em'}}>{f.label}</label>
            <div style={{position:'relative'}}>
              <input type={showPwd[f.key]?'text':'password'} value={pwd[f.key]} onChange={e=>setPwd(p=>({...p,[f.key]:e.target.value}))}
                placeholder={f.ph} style={{...inpStyle,paddingRight:42}}
                onFocus={e=>e.target.style.borderColor='#c4324a'} onBlur={e=>e.target.style.borderColor='var(--bd)'}
                onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter')savePassword()}}/>
              <button onClick={()=>setShowPwd(p=>({...p,[f.key]:!p[f.key]}))} style={{position:'absolute',right:12,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',cursor:'pointer',color:'var(--t3)',padding:2}}>
                {showPwd[f.key]
                  ?<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10 10 0 0 1 12 20c-7 0-11-8-11-8a18 18 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                  :<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>}
              </button>
            </div>
          </div>)}
          {pwd.next&&pwd.next===pwd.confirm&&<div style={{display:'flex',gap:4,marginTop:-6}}>
            {[...Array(Math.min(4,Math.floor(pwd.next.length/2)))].map((_,i)=><div key={i} style={{height:2,flex:1,borderRadius:2,background:pwd.next.length>=8?'#10b981':pwd.next.length>=6?'#f59e0b':'#ef4444'}}/>)}
            {[...Array(Math.max(0,4-Math.floor(pwd.next.length/2)))].map((_,i)=><div key={'e'+i} style={{height:2,flex:1,borderRadius:2,background:'var(--bd)'}}/>)}
          </div>}
          <button onClick={savePassword} disabled={saving} style={{padding:'11px',background:saving?'#5a1120':'#c4324a',color:'#fff',border:'none',borderRadius:10,fontSize:13,fontWeight:700,cursor:saving?'wait':'pointer',fontFamily:'inherit',transition:'all .2s'}}>
            {saving?'Modification…':'Modifier le mot de passe'}
          </button>
        </div>}
      </div>
    </div>
  </div>;
}


// ── UserMenuPanel ──
function UserMenuPanel({user,subStatus,onUpgrade,onSettings,onSignOut,onClose}){
  const name=user?.user_metadata?.full_name||user?.email?.split('@')[0]||'Utilisateur';
  const initials=name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const planLabel=subStatus?.status==='active'?'Actif':subStatus?.status==='trialing'?`Essai — ${subStatus.daysLeft}j`:subStatus?.status==='past_due'?'Paiement en attente':'Expiré';
  const planColor=subStatus?.status==='active'?'var(--gn)':subStatus?.status==='trialing'?'var(--am)':'var(--rs)';
  const planBg=subStatus?.status==='active'?'var(--gnd)':subStatus?.status==='trialing'?'var(--amd)':'var(--rsd)';
  const planName=(subStatus?.plan||'solo').charAt(0).toUpperCase()+(subStatus?.plan||'solo').slice(1);

  return<div style={{width:240,background:'var(--pnl)',border:'1px solid var(--bd)',borderRadius:14,overflow:'hidden',boxShadow:'0 20px 50px rgba(0,0,0,.5)',animation:'fu .2s ease-out'}}>
    {/* Profile header */}
    <div style={{padding:'16px 16px 12px',background:'linear-gradient(135deg,rgba(196,50,74,.08),transparent)'}}>
      <div style={{display:'flex',alignItems:'center',gap:10}}>
        <div style={{width:40,height:40,borderRadius:12,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:15,fontWeight:800,color:'#fff',flexShrink:0,boxShadow:'0 4px 12px rgba(196,50,74,.35)'}}>
          {initials}
        </div>
        <div style={{minWidth:0}}>
          <div style={{fontSize:13,fontWeight:700,color:'var(--t1)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{name}</div>
          <div style={{fontSize:10,color:'var(--t3)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{user?.email}</div>
        </div>
      </div>
      {/* Plan badge */}
      <div style={{marginTop:10,padding:'6px 10px',background:planBg,border:`1px solid ${planColor}30`,borderRadius:8,display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <span style={{fontSize:11,fontWeight:700,color:planColor}}>{planName}</span>
        <span style={{fontSize:10,color:planColor,opacity:.8}}>{planLabel}</span>
      </div>
    </div>

    <div style={{height:1,background:'var(--bd)'}}/>

    {/* Actions */}
    <div style={{padding:6}}>
      {[
        {icon:'💳',label:'Plans & abonnement',fn:()=>{onClose();onUpgrade()},color:'var(--bl)'},
        {icon:'⚙️',label:'Paramètres compte',fn:()=>{onClose();onSettings();},color:'var(--t2)'},
      ].map(a=><button key={a.label} onClick={a.fn} style={{
        width:'100%',display:'flex',alignItems:'center',gap:10,padding:'9px 12px',borderRadius:8,
        background:'transparent',border:'none',cursor:'pointer',fontFamily:'inherit',
        color:a.color,fontSize:12,fontWeight:500,transition:'background .15s',textAlign:'left'
      }}
      onMouseEnter={e=>e.currentTarget.style.background='var(--crd)'}
      onMouseLeave={e=>e.currentTarget.style.background='transparent'}
      ><span style={{fontSize:14}}>{a.icon}</span>{a.label}</button>)}
    </div>

    <div style={{height:1,background:'var(--bd)'}}/>

    <div style={{padding:6}}>
      <button onClick={()=>{onClose();onSignOut();}} style={{
        width:'100%',display:'flex',alignItems:'center',gap:10,padding:'9px 12px',borderRadius:8,
        background:'transparent',border:'none',cursor:'pointer',fontFamily:'inherit',
        color:'var(--rs)',fontSize:12,fontWeight:500,transition:'background .15s',textAlign:'left'
      }}
      onMouseEnter={e=>e.currentTarget.style.background='var(--rsd)'}
      onMouseLeave={e=>e.currentTarget.style.background='transparent'}
      ><span style={{fontSize:14}}>🚪</span>Se déconnecter</button>
    </div>
  </div>;
}

// ── Auth Gate Component ──
// ══════════════════════════════════════════════════════════
// ADMIN DASHBOARD — pleine page, stats riches, gestion users
// ══════════════════════════════════════════════════════════
function AdminApp({onBack,currentUser,isSuperAdmin}){
  const[tab,setTab]=useState('overview');
  const[users,setUsers]=useState([]);
  const[loadingUsers,setLoadingUsers]=useState(true);
  const[acting,setActing]=useState(null);
  const[search,setSearch]=useState('');
  const[filterStatus,setFilterStatus]=useState('all');

  const loadUsers=async()=>{
    setLoadingUsers(true);
    const all=await adminListUsers(null);
    setUsers(all||[]);setLoadingUsers(false);
  };
  useEffect(()=>{loadUsers();},[]);

  const act=async(userId,action)=>{
    setActing(userId);
    if(action==='approve')await adminSetUserStatus(userId,'approved');
    else if(action==='reject')await adminSetUserStatus(userId,'rejected');
    else if(action==='pending')await adminSetUserStatus(userId,'pending');
    else if(action==='admin')await adminSetUserRole(userId,'admin');
    else if(action==='user')await adminSetUserRole(userId,'user');
    await loadUsers();setActing(null);
  };

  // ── Computed stats ──
  const total=users.length;
  const approved=users.filter(u=>u.status==='approved').length;
  const pending=users.filter(u=>u.status==='pending').length;
  const rejected=users.filter(u=>u.status==='rejected').length;
  const admins=users.filter(u=>u.role==='admin'||u.role==='superadmin').length;
  const today=new Date().toDateString();
  const newToday=users.filter(u=>new Date(u.created_at).toDateString()===today).length;
  const thisWeek=users.filter(u=>{const d=new Date(u.created_at);return(Date.now()-d)<7*86400000;}).length;
  const thisMonth=users.filter(u=>{const d=new Date(u.created_at);return(Date.now()-d)<30*86400000;}).length;

  // ── By day last 14 days ──
  const signupsByDay=Array.from({length:14},(_,i)=>{
    const d=new Date();d.setDate(d.getDate()-13+i);const ds=d.toDateString();
    return{label:d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'}),count:users.filter(u=>new Date(u.created_at).toDateString()===ds).length};
  });
  const maxBar=Math.max(1,...signupsByDay.map(d=>d.count));

  // ── Filtered users ──
  const filteredUsers=users.filter(u=>{
    const matchStatus=filterStatus==='all'||u.status===filterStatus;
    const matchSearch=!search||(u.email||'').toLowerCase().includes(search.toLowerCase())||(u.full_name||'').toLowerCase().includes(search.toLowerCase());
    return matchStatus&&matchSearch;
  });

  const STATUS_COLOR={pending:'#f59e0b',approved:'#10b981',rejected:'#ef4444'};
  const STATUS_BG={pending:'rgba(245,158,11,.12)',approved:'rgba(16,185,129,.12)',rejected:'rgba(239,68,68,.12)'};
  const STATUS_LABEL={pending:'En attente',approved:'Approuvé',rejected:'Refusé'};

  const StatCard=({icon,label,value,sub,color='#c4324a',onClick})=>(
    <div onClick={onClick} style={{padding:'18px 20px',borderRadius:14,background:'rgba(255,255,255,.03)',border:`1px solid ${color}22`,cursor:onClick?'pointer':'default',transition:'all .2s'}}
      onMouseOver={e=>{if(onClick)e.currentTarget.style.borderColor=color+'55'}}
      onMouseOut={e=>{if(onClick)e.currentTarget.style.borderColor=color+'22'}}>
      <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
        <div style={{width:36,height:36,borderRadius:10,background:`${color}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:18}}>{icon}</div>
        <span style={{fontSize:11,color:'#5a5a7e',fontWeight:600}}>{label}</span>
      </div>
      <div style={{fontSize:28,fontWeight:800,color:'#f0ece6',letterSpacing:'-.02em',lineHeight:1}}>{value}</div>
      {sub&&<div style={{fontSize:11,color:'#4a4a6a',marginTop:5}}>{sub}</div>}
    </div>
  );

  return<div style={{height:'100vh',display:'flex',flexDirection:'column',background:'#080810',fontFamily:'DM Sans,sans-serif',overflow:'hidden'}}>
    {/* ── Header ── */}
    <div style={{padding:'14px 28px',borderBottom:'1px solid rgba(255,255,255,.07)',display:'flex',alignItems:'center',gap:14,flexShrink:0,background:'rgba(255,255,255,.02)'}}>
      <button onClick={onBack} style={{width:34,height:34,borderRadius:9,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'#6a6a8a',fontSize:18,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}}>←</button>
      <div style={{width:36,height:36,borderRadius:10,background:'linear-gradient(135deg,#c4324a,#8b1a2b)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18}}>⚡</div>
      <div>
        <div style={{fontSize:15,fontWeight:800,color:'#f0ece6',letterSpacing:'-.01em'}}>Dashboard Admin</div>
        <div style={{fontSize:11,color:'#4a4a6a'}}>Kalepin Bêta — {currentUser?.email}</div>
      </div>
      <div style={{flex:1}}/>
      <div style={{display:'flex',gap:2,background:'rgba(255,255,255,.05)',borderRadius:10,padding:3}}>
        {[{k:'overview',ic:'📊',l:'Vue d\'ensemble'},{k:'users',ic:'👥',l:'Utilisateurs'},{k:'pending',ic:'⏳',l:`Approbations${pending?' ('+pending+')':''}`},{k:'stats',ic:'📈',l:'Statistiques'}].map(t=>(
          <button key={t.k} onClick={()=>setTab(t.k)} style={{padding:'7px 14px',borderRadius:8,fontSize:11,fontWeight:600,border:'none',cursor:'pointer',fontFamily:'inherit',transition:'all .15s',
            background:tab===t.k?'rgba(196,50,74,.25)':'transparent',color:tab===t.k?'#f0ece6':'#5a5a7e'}}>
            {t.ic} {t.l}
          </button>
        ))}
      </div>
    </div>

    {/* ── Content ── */}
    <div style={{flex:1,overflowY:'auto',padding:'28px 32px'}}>

      {/* ══ OVERVIEW ══ */}
      {tab==='overview'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:24}}>
          <StatCard icon="👥" label="Total inscrits" value={total} sub={`+${newToday} aujourd'hui`} color="#0ea5e9" onClick={()=>setTab('users')}/>
          <StatCard icon="✅" label="Accès accordé" value={approved} sub={`${total?Math.round(approved/total*100):0}% du total`} color="#10b981" onClick={()=>{setTab('users');setFilterStatus('approved')}}/>
          <StatCard icon="⏳" label="En attente" value={pending} sub={pending>0?'Action requise':'Tout est traité'} color="#f59e0b" onClick={()=>setTab('pending')}/>
          <StatCard icon="📁" label="Refusés" value={rejected} sub="" color="#ef4444" onClick={()=>{setTab('users');setFilterStatus('rejected')}}/>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:14,marginBottom:24}}>
          <StatCard icon="📅" label="Inscrits aujourd'hui" value={newToday} color="#c4324a"/>
          <StatCard icon="📆" label="Inscrits cette semaine" value={thisWeek} color="#8b5cf6"/>
          <StatCard icon="🗓" label="Inscrits ce mois" value={thisMonth} color="#06b6d4"/>
        </div>

        {/* ── Graphique inscriptions 14j ── */}
        <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px',marginBottom:20}}>
          <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:16}}>📈 Inscriptions — 14 derniers jours</div>
          <div style={{display:'flex',alignItems:'flex-end',gap:6,height:80}}>
            {signupsByDay.map((d,i)=>(
              <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}>
                <div style={{fontSize:8,color:'#c4324a',fontWeight:700,opacity:d.count>0?1:0}}>{d.count}</div>
                <div style={{width:'100%',borderRadius:'3px 3px 0 0',background:d.count>0?'linear-gradient(to top,#c4324a,#e8607a)':'rgba(255,255,255,.06)',
                  height:Math.max(3,d.count/maxBar*60)+'px',transition:'height .3s',minHeight:3}}/>
                <div style={{fontSize:7,color:'#3a3a5a',whiteSpace:'nowrap',transform:'rotate(-35deg)',transformOrigin:'top center',marginTop:4}}>{d.label}</div>
              </div>
            ))}
          </div>
        </div>

        {/* ── Répartition statuts ── */}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:14}}>
          <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
            <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:14}}>🥧 Répartition statuts</div>
            {[{s:'approved',l:'Approuvés',v:approved},{s:'pending',l:'En attente',v:pending},{s:'rejected',l:'Refusés',v:rejected}].map(({s,l,v})=>(
              <div key={s} style={{marginBottom:10}}>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
                  <span style={{fontSize:11,color:'#6a6a8a'}}>{l}</span>
                  <span style={{fontSize:11,fontWeight:700,color:STATUS_COLOR[s]}}>{v}</span>
                </div>
                <div style={{height:6,borderRadius:3,background:'rgba(255,255,255,.06)',overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${total?v/total*100:0}%`,borderRadius:3,background:STATUS_COLOR[s],transition:'width .5s'}}/>
                </div>
              </div>
            ))}
          </div>
          <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
            <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:14}}>🔑 Rôles</div>
            {[{l:'Superadmin',v:users.filter(u=>u.role==='superadmin').length,c:'#c4324a'},{l:'Admin',v:users.filter(u=>u.role==='admin').length,c:'#f59e0b'},{l:'Utilisateurs',v:users.filter(u=>u.role==='user'||!u.role).length,c:'#0ea5e9'}].map(({l,v,c})=>(
              <div key={l} style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                <div style={{width:10,height:10,borderRadius:3,background:c,flexShrink:0}}/>
                <span style={{fontSize:11,color:'#6a6a8a',flex:1}}>{l}</span>
                <span style={{fontSize:13,fontWeight:700,color:'#f0ece6'}}>{v}</span>
              </div>
            ))}
            <div style={{marginTop:14,paddingTop:14,borderTop:'1px solid rgba(255,255,255,.06)'}}>
              <div style={{fontSize:11,color:'#4a4a6a'}}>Taux de conversion bêta</div>
              <div style={{fontSize:22,fontWeight:800,color:'#10b981',marginTop:4}}>{total?Math.round(approved/total*100):0}%</div>
            </div>
          </div>
        </div>

        {/* ── Derniers inscrits ── */}
        <div style={{marginTop:14,background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
          <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:14}}>🕐 Dernières inscriptions</div>
          {[...users].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).slice(0,5).map(u=>(
            <div key={u.id} style={{display:'flex',alignItems:'center',gap:12,padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.04)'}}>
              <div style={{width:32,height:32,borderRadius:9,background:'linear-gradient(135deg,rgba(196,50,74,.2),rgba(196,50,74,.05))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,fontWeight:800,color:'#c4324a',flexShrink:0}}>
                {(u.full_name||u.email||'?')[0].toUpperCase()}
              </div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:12,fontWeight:600,color:'#d0d0e0',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{u.full_name||'—'}</div>
                <div style={{fontSize:10,color:'#4a4a6a'}}>{u.email}</div>
              </div>
              <span style={{padding:'2px 8px',borderRadius:6,fontSize:9,fontWeight:700,background:STATUS_BG[u.status]||STATUS_BG.pending,color:STATUS_COLOR[u.status]||STATUS_COLOR.pending}}>{STATUS_LABEL[u.status]||'?'}</span>
              <span style={{fontSize:10,color:'#3a3a5a',whiteSpace:'nowrap'}}>{u.created_at?new Date(u.created_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}):'—'}</span>
            </div>
          ))}
        </div>
      </div>}

              {/* ══ USERS TABLE ══ */}
      {(tab==='users')&&<div>
        <div style={{display:'flex',gap:10,marginBottom:16,alignItems:'center'}}>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="🔍  Rechercher par nom ou email…"
            style={{flex:1,padding:'9px 14px',background:'rgba(255,255,255,.05)',border:'1px solid rgba(255,255,255,.1)',borderRadius:10,color:'#f0ece6',fontSize:12,fontFamily:'DM Sans,sans-serif',outline:'none'}}/>
          {['all','pending','approved','rejected'].map(s=>(
            <button key={s} onClick={()=>setFilterStatus(s)} style={{padding:'7px 14px',borderRadius:8,border:`1px solid ${filterStatus===s?STATUS_COLOR[s]||'rgba(196,50,74,.5)':'rgba(255,255,255,.08)'}`,
              background:filterStatus===s?STATUS_BG[s]||'rgba(196,50,74,.12)':'transparent',
              color:filterStatus===s?STATUS_COLOR[s]||'#c4324a':'#5a5a7e',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>
              {s==='all'?'Tous':STATUS_LABEL[s]} ({s==='all'?users.length:users.filter(u=>u.status===s).length})
            </button>
          ))}
          <button onClick={loadUsers} style={{padding:'7px 12px',borderRadius:8,border:'1px solid rgba(255,255,255,.08)',background:'transparent',color:'#5a5a7e',fontSize:12,cursor:'pointer'}}>↻</button>
        </div>
        {loadingUsers?<div style={{textAlign:'center',padding:60,color:'#3a3a5a'}}>Chargement…</div>
        :<div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,overflow:'hidden'}}>
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:12}}>
            <thead><tr style={{background:'rgba(0,0,0,.2)',borderBottom:'1px solid rgba(255,255,255,.07)'}}>
              {['','Utilisateur','Email','Statut','Rôle','Inscrit le','Accès','Rôle'].map((h,i)=><th key={i} style={{textAlign:'left',padding:'12px 14px',color:'#3a3a5a',fontWeight:700,fontSize:9,textTransform:'uppercase',letterSpacing:'.07em'}}>{h}</th>)}
            </tr></thead>
            <tbody>{filteredUsers.map((u,i)=>{
              const isActing=acting===u.id;
              const isSelf=u.id===currentUser?.id;
              const isSuperadminRow=u.role==='superadmin';
              return<tr key={u.id} style={{borderBottom:'1px solid rgba(255,255,255,.04)',background:i%2===0?'transparent':'rgba(255,255,255,.01)'}}>
                {/* Avatar */}
                <td style={{padding:'10px 14px',width:36}}>
                  <div style={{width:32,height:32,borderRadius:9,background:`linear-gradient(135deg,rgba(196,50,74,.2),rgba(196,50,74,.05))`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,fontWeight:800,color:'#c4324a'}}>
                    {(u.full_name||u.email||'?')[0].toUpperCase()}
                  </div>
                </td>
                {/* Nom */}
                <td style={{padding:'10px 6px'}}>
                  <div style={{fontWeight:600,color:'#d0d0e0'}}>{u.full_name||'—'}</div>
                  {isSelf&&<div style={{fontSize:8,color:'#c4324a',fontWeight:700,marginTop:2}}>C'est vous</div>}
                </td>
                {/* Email */}
                <td style={{padding:'10px 6px',color:'#5a5a7e',fontSize:11}}>{u.email}</td>
                {/* Badge statut */}
                <td style={{padding:'10px 6px'}}>
                  <span style={{padding:'3px 9px',borderRadius:6,fontSize:9,fontWeight:700,background:STATUS_BG[u.status]||STATUS_BG.pending,color:STATUS_COLOR[u.status]||STATUS_COLOR.pending}}>
                    {STATUS_LABEL[u.status]||'?'}
                  </span>
                </td>
                {/* Badge rôle */}
                <td style={{padding:'10px 6px'}}>
                  <span style={{padding:'3px 9px',borderRadius:6,fontSize:9,fontWeight:700,
                    background:isSuperadminRow?'rgba(196,50,74,.2)':u.role==='admin'?'rgba(245,158,11,.15)':'rgba(100,100,130,.12)',
                    color:isSuperadminRow?'#c4324a':u.role==='admin'?'#f59e0b':'#6a6a9a'}}>
                    {isSuperadminRow?'⭐ Superadmin':u.role==='admin'?'🔑 Admin':'👤 Utilisateur'}
                  </span>
                </td>
                {/* Date */}
                <td style={{padding:'10px 6px',color:'#3a3a5a',fontSize:10,whiteSpace:'nowrap'}}>
                  {u.created_at?new Date(u.created_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}):'—'}
                </td>
                {/* Actions ACCÈS (statut) */}
                <td style={{padding:'10px 6px'}}>
                  {isSuperadminRow||isSelf?<span style={{fontSize:9,color:'#3a3a5a'}}>—</span>
                  :<div style={{display:'flex',gap:3}}>
                    <button onClick={()=>act(u.id,'approve')} disabled={isActing||u.status==='approved'} title="Approuver l'accès"
                      style={{padding:'4px 10px',borderRadius:5,border:'1px solid rgba(16,185,129,.3)',fontSize:9,fontWeight:700,cursor:u.status==='approved'?'default':'pointer',fontFamily:'inherit',transition:'all .15s',
                        background:u.status==='approved'?'rgba(16,185,129,.25)':'rgba(16,185,129,.06)',
                        color:u.status==='approved'?'#10b981':'#5a9a7a',
                        opacity:isActing?.4:1}}>
                      ✓ Approuvé
                    </button>
                    <button onClick={()=>act(u.id,'pending')} disabled={isActing||u.status==='pending'} title="Remettre en attente"
                      style={{padding:'4px 10px',borderRadius:5,border:'1px solid rgba(245,158,11,.3)',fontSize:9,fontWeight:700,cursor:u.status==='pending'?'default':'pointer',fontFamily:'inherit',transition:'all .15s',
                        background:u.status==='pending'?'rgba(245,158,11,.2)':'rgba(245,158,11,.05)',
                        color:u.status==='pending'?'#f59e0b':'#6a6a4a',
                        opacity:isActing?.4:1}}>
                      ⏸ Attente
                    </button>
                    <button onClick={()=>act(u.id,'reject')} disabled={isActing||u.status==='rejected'} title="Refuser l'accès"
                      style={{padding:'4px 10px',borderRadius:5,border:'1px solid rgba(239,68,68,.3)',fontSize:9,fontWeight:700,cursor:u.status==='rejected'?'default':'pointer',fontFamily:'inherit',transition:'all .15s',
                        background:u.status==='rejected'?'rgba(239,68,68,.2)':'rgba(239,68,68,.05)',
                        color:u.status==='rejected'?'#ef4444':'#6a4a4a',
                        opacity:isActing?.4:1}}>
                      ✗ Refusé
                    </button>
                  </div>}
                </td>
                {/* Actions RÔLE */}
                <td style={{padding:'10px 6px'}}>
                  {isSuperadminRow||isSelf?<span style={{fontSize:9,color:'#3a3a5a'}}>—</span>
                  :<div style={{display:'flex',gap:3}}>
                    <button onClick={()=>act(u.id,'user')} disabled={isActing||u.role==='user'} title="Rétrograder en utilisateur"
                      style={{padding:'4px 10px',borderRadius:5,border:'1px solid rgba(100,100,180,.3)',fontSize:9,fontWeight:700,cursor:u.role==='user'?'default':'pointer',fontFamily:'inherit',transition:'all .15s',
                        background:u.role==='user'?'rgba(100,100,180,.2)':'rgba(100,100,180,.05)',
                        color:u.role==='user'?'#8888cc':'#4a4a6a',
                        opacity:isActing?.4:1}}>
                      👤 User
                    </button>
                    <button onClick={()=>act(u.id,'admin')} disabled={isActing||u.role==='admin'} title="Promouvoir en admin"
                      style={{padding:'4px 10px',borderRadius:5,border:'1px solid rgba(245,158,11,.3)',fontSize:9,fontWeight:700,cursor:u.role==='admin'?'default':'pointer',fontFamily:'inherit',transition:'all .15s',
                        background:u.role==='admin'?'rgba(245,158,11,.2)':'rgba(245,158,11,.05)',
                        color:u.role==='admin'?'#f59e0b':'#6a5a2a',
                        opacity:isActing?.4:1}}>
                      🔑 Admin
                    </button>
                  </div>}
                </td>
              </tr>;
            })}</tbody>
          </table>
          {!filteredUsers.length&&<div style={{textAlign:'center',padding:40,color:'#3a3a5a',fontSize:12}}>Aucun utilisateur trouvé</div>}
        </div>}
      </div>}

      {/* ══ PENDING APPROVALS ══ */}
      {tab==='pending'&&<div>
        {pending===0
          ?<div style={{textAlign:'center',padding:80}}>
            <div style={{fontSize:48,marginBottom:16}}>✅</div>
            <div style={{fontSize:16,fontWeight:700,color:'#f0ece6',marginBottom:8}}>Tout est traité !</div>
            <div style={{fontSize:13,color:'#4a4a6a'}}>Aucune demande d'accès en attente</div>
          </div>
          :<div>
            <div style={{marginBottom:16,padding:'12px 16px',background:'rgba(245,158,11,.08)',border:'1px solid rgba(245,158,11,.2)',borderRadius:12,fontSize:12,color:'#f59e0b',display:'flex',alignItems:'center',gap:10}}>
              <span style={{fontSize:18}}>⏳</span>
              <span><strong>{pending}</strong> demande{pending>1?'s':''} d'accès en attente de validation</span>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:10}}>
              {users.filter(u=>u.status==='pending').map(u=>(
                <div key={u.id} style={{display:'flex',alignItems:'center',gap:14,padding:'16px 20px',background:'rgba(255,255,255,.03)',border:'1px solid rgba(245,158,11,.15)',borderRadius:14}}>
                  <div style={{width:42,height:42,borderRadius:12,background:'linear-gradient(135deg,rgba(245,158,11,.2),rgba(245,158,11,.05))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,fontWeight:800,color:'#f59e0b',flexShrink:0}}>
                    {(u.full_name||u.email||'?')[0].toUpperCase()}
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontSize:13,fontWeight:700,color:'#f0ece6'}}>{u.full_name||'Sans nom'}</div>
                    <div style={{fontSize:11,color:'#5a5a7e',marginTop:2}}>{u.email}</div>
                    <div style={{fontSize:10,color:'#3a3a5a',marginTop:2}}>Inscrit le {u.created_at?new Date(u.created_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'}):'—'}</div>
                  </div>
                  <div style={{display:'flex',gap:8,flexShrink:0}}>
                    <button onClick={()=>act(u.id,'approve')} disabled={acting===u.id} style={{padding:'9px 22px',borderRadius:9,border:'none',background:'linear-gradient(135deg,#10b981,#059669)',color:'#fff',fontSize:12,fontWeight:700,cursor:'pointer',fontFamily:'inherit',opacity:acting===u.id?.5:1,boxShadow:'0 4px 12px rgba(16,185,129,.25)'}}>
                      ✓ Approuver
                    </button>
                    <button onClick={()=>act(u.id,'reject')} disabled={acting===u.id} style={{padding:'9px 22px',borderRadius:9,border:'1px solid rgba(239,68,68,.3)',background:'rgba(239,68,68,.08)',color:'#ef4444',fontSize:12,fontWeight:700,cursor:'pointer',fontFamily:'inherit',opacity:acting===u.id?.5:1}}>
                      ✗ Refuser
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>}
      </div>}

      {/* ══ STATS ══ */}
      {tab==='stats'&&<div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginBottom:16}}>
          <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
            <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:14}}>📊 Métriques clés</div>
            {[
              ['Inscrits total',total,'#0ea5e9'],
              ['Taux d\'approbation',`${total?Math.round(approved/total*100):0}%`,'#10b981'],
              ['Inscrits aujourd\'hui',newToday,'#c4324a'],
              ['Inscrits cette semaine',thisWeek,'#8b5cf6'],
              ['Inscrits ce mois',thisMonth,'#f59e0b'],
              ['Admins',admins,'#c4324a'],
            ].map(([l,v,c])=>(
              <div key={l} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:'1px solid rgba(255,255,255,.04)'}}>
                <span style={{fontSize:12,color:'#5a5a7e'}}>{l}</span>
                <span style={{fontSize:14,fontWeight:800,color:c}}>{v}</span>
              </div>
            ))}
          </div>
          <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
            <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:14}}>📅 Inscriptions par période</div>
            {[['Aujourd\'hui',newToday,'#c4324a'],['7 derniers jours',thisWeek,'#8b5cf6'],['30 derniers jours',thisMonth,'#0ea5e9']].map(([l,v,c])=>(
              <div key={l} style={{marginBottom:16}}>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
                  <span style={{fontSize:11,color:'#5a5a7e'}}>{l}</span>
                  <span style={{fontSize:13,fontWeight:800,color:c}}>{v}</span>
                </div>
                <div style={{height:8,borderRadius:4,background:'rgba(255,255,255,.06)',overflow:'hidden'}}>
                  <div style={{height:'100%',width:`${total?v/total*100:0}%`,borderRadius:4,background:c,transition:'width .5s'}}/>
                </div>
              </div>
            ))}
            <div style={{marginTop:20,padding:'14px 16px',background:'rgba(196,50,74,.06)',border:'1px solid rgba(196,50,74,.15)',borderRadius:10}}>
              <div style={{fontSize:10,color:'#6a6a8a',marginBottom:4}}>Vitesse de croissance (7j)</div>
              <div style={{fontSize:20,fontWeight:800,color:'#c4324a'}}>{thisWeek > 0 ? '+'+thisWeek : '0'} <span style={{fontSize:11,fontWeight:400,color:'#4a4a6a'}}>nouveaux / 7 jours</span></div>
            </div>
          </div>
        </div>
        {/* Graphique barres 14j */}
        <div style={{background:'rgba(255,255,255,.025)',border:'1px solid rgba(255,255,255,.07)',borderRadius:16,padding:'20px 24px'}}>
          <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:20}}>📈 Inscriptions jour par jour — 14 derniers jours</div>
          <div style={{display:'flex',alignItems:'flex-end',gap:8,height:100,paddingBottom:24,position:'relative'}}>
            {/* Gridlines */}
            {[0,25,50,75,100].map(p=>(
              <div key={p} style={{position:'absolute',left:0,right:0,bottom:24+p*.76,height:1,background:'rgba(255,255,255,.04)'}}/>
            ))}
            {signupsByDay.map((d,i)=>(
              <div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:0,position:'relative',zIndex:1}}>
                {d.count>0&&<div style={{fontSize:9,color:'#c4324a',fontWeight:800,marginBottom:3}}>{d.count}</div>}
                <div style={{width:'70%',borderRadius:'4px 4px 0 0',background:d.count>0?'linear-gradient(to top,#c4324a,#e8607a)':'rgba(255,255,255,.05)',
                  height:Math.max(4,d.count/maxBar*76)+'px',transition:'height .4s'}}/>
                <div style={{position:'absolute',bottom:-20,fontSize:8,color:'#3a3a5a',whiteSpace:'nowrap',left:'50%',transform:'translateX(-50%)'}}>{d.label}</div>
              </div>
            ))}
          </div>
        </div>
      </div>}

    </div>
  </div>;
}

function AuthGate({children}){
  const[user,setUser]=useState(null);
  const[profile,setProfile]=useState(null);
  const[profileError,setProfileError]=useState(null);
  const[loading,setLoading]=useState(true);
  const[subStatus,setSubStatus]=useState(null);
  const[mode,setMode]=useState('landing');
  const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[name,setName]=useState('');
  const[showPwd,setShowPwd]=useState(false);
  const[error,setError]=useState('');const[info,setInfo]=useState('');const[submitting,setSubmitting]=useState(false);

  const loadUserData=async(u)=>{
    if(!u)return;
    setUser(u);
    let prof=null,profErr=null,profDetails=null;
    try{
      const result=await ensureProfile(u);
      prof=result.data;
      profErr=result.error;
      profDetails=result.details||null;
    }catch(e){profErr='network';profDetails=e.message;}
    setProfile(prof);
    setProfileError(profErr?{code:profErr,details:profDetails}:null);
    const canAccess=prof?.status==='approved'||prof?.role==='admin'||prof?.role==='superadmin';
    if(canAccess){
      let sub=await fetchSubscription(u.id);
      if(!sub)sub=await createTrialSubscription(u.id,u.email);
      setSubStatus(getSubscriptionStatus(sub));
    }
  };

  useEffect(()=>{authGetUser().then(async u=>{
    await loadUserData(u);
    setLoading(false);
  });},[]);

  const switchMode=(m)=>{setMode(m);setError('');setInfo('');};

  const handleLogin=async()=>{
    setError('');setSubmitting(true);
    try{
      const data=await authSignIn(email,password);
      await loadUserData(data.user);
    }catch(e){setError(e.message||'Email ou mot de passe incorrect')}finally{setSubmitting(false)}
  };
  const handleSignup=async()=>{
    if(password.length<6){setError('Mot de passe : 6 caractères minimum');return;}
    setError('');setSubmitting(true);
    try{
      const data=await authSignUp(email,password,name);
      const u=data.user||data;
      if(u?.id){await loadUserData(u);}
    }catch(e){setError(e.message)}finally{setSubmitting(false)}
  };
  const handleForgot=async()=>{
    setError('');setInfo('');setSubmitting(true);
    try{
      const res=await fetch(SUPA.url+'/auth/v1/recover',{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key},body:JSON.stringify({email})});
      if(res.ok)setInfo('Lien de réinitialisation envoyé à '+email);
      else{const d=await res.json();setError(d.error_description||'Erreur')}
    }catch(e){setError(e.message)}finally{setSubmitting(false)}
  };

  if(loading)return<div style={{height:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)'}}>
    <div style={{textAlign:'center'}}>
      <div style={{width:52,height:52,borderRadius:15,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px',fontSize:24,color:'#fff',fontWeight:900,boxShadow:'0 8px 40px rgba(196,50,74,.3)',animation:'pg 2s infinite'}}>K</div>
      <div style={{fontSize:13,color:'var(--t3)'}}>Chargement…</div>
    </div>
  </div>;

  // ── Écran BETA EN ATTENTE ──
  if(user && profile?.status==='pending'){
    const doSignout=async()=>{await authSignOut();setUser(null);setProfile(null);setProfileError(null);setSubStatus(null);};
    return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#080810',fontFamily:'DM Sans,sans-serif',padding:24}}>
      <div style={{maxWidth:460,width:'100%',textAlign:'center'}}>
        <div style={{width:64,height:64,borderRadius:18,background:'linear-gradient(135deg,rgba(245,158,11,.2),rgba(245,158,11,.05))',border:'1px solid rgba(245,158,11,.3)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:30,margin:'0 auto 24px'}}>⏳</div>
        <div style={{fontSize:24,fontWeight:800,color:'#f0ece6',marginBottom:12,letterSpacing:'-.02em'}}>Demande d'accès envoyée</div>
        <div style={{fontSize:15,color:'#6a6a7e',lineHeight:1.7,marginBottom:32}}>
          Ton compte <strong style={{color:'#f0ece6'}}>{user.email}</strong> est en attente de validation.<br/>
          Tu recevras un accès dès qu'il sera approuvé par l'équipe Kalepin.
        </div>
        <div style={{background:'rgba(245,158,11,.06)',border:'1px solid rgba(245,158,11,.15)',borderRadius:16,padding:'20px 24px',marginBottom:28,textAlign:'left'}}>
          <div style={{fontSize:13,fontWeight:700,color:'#f59e0b',marginBottom:12}}>🚀 Bêta privée — ce qui t'attend</div>
          {[['⚡','Calepinage bardage façade en quelques minutes'],['🧱','Briques, carrelages, panneaux métalliques'],['📐','Export 3D, PDF, Excel et QR chantier'],['🎁','Accès complet gratuit pendant la bêta']].map(([ic,t])=><div key={t} style={{display:'flex',alignItems:'center',gap:10,marginBottom:8,fontSize:13,color:'#8a8a9e'}}>
            <span>{ic}</span><span>{t}</span>
          </div>)}
        </div>
        <button onClick={doSignout} style={{padding:'10px 24px',borderRadius:10,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'var(--t3)',fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>
          Se déconnecter
        </button>
      </div>
    </div>;
  }

  // ── Écran REFUSÉ ──
  if(user && profile?.status==='rejected'){
    const doSignout=async()=>{await authSignOut();setUser(null);setProfile(null);setProfileError(null);setSubStatus(null);};
    return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#080810',fontFamily:'DM Sans,sans-serif',padding:24}}>
      <div style={{maxWidth:420,width:'100%',textAlign:'center'}}>
        <div style={{width:64,height:64,borderRadius:18,background:'rgba(239,68,68,.1)',border:'1px solid rgba(239,68,68,.2)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:30,margin:'0 auto 24px'}}>🚫</div>
        <div style={{fontSize:22,fontWeight:800,color:'#f0ece6',marginBottom:12}}>Accès non accordé</div>
        <div style={{fontSize:14,color:'#6a6a7e',lineHeight:1.7,marginBottom:28}}>
          Ton compte <strong style={{color:'#f0ece6'}}>{user.email}</strong> n'a pas été approuvé pour cette bêta.<br/>
          Contacte-nous à <a href="mailto:contact@kalepin.fr" style={{color:'#c4324a'}}>contact@kalepin.fr</a> pour plus d'informations.
        </div>
        <button onClick={doSignout} style={{padding:'10px 24px',borderRadius:10,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'var(--t3)',fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>Se déconnecter</button>
      </div>
    </div>;
  }

  // ── Erreur réseau / RLS → écran retry ──
  if(user && profile===null && profileError && profileError.code!=='table_missing'){
    const doRetry=async()=>{setLoading(true);await loadUserData(user);setLoading(false);};
    const doSignout=async()=>{await authSignOut();setUser(null);setProfile(null);setProfileError(null);setSubStatus(null);};
    return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#080810',fontFamily:'DM Sans,sans-serif',padding:24}}>
      <div style={{maxWidth:420,width:'100%',textAlign:'center'}}>
        <div style={{width:60,height:60,borderRadius:16,background:'rgba(245,158,11,.1)',border:'1px solid rgba(245,158,11,.2)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,margin:'0 auto 20px'}}>⚠️</div>
        <div style={{fontSize:18,fontWeight:800,color:'#f0ece6',marginBottom:10}}>Problème de connexion</div>
        <div style={{fontSize:13,color:'#5a5a7e',lineHeight:1.7,marginBottom:16}}>
          Impossible de charger ton profil.<br/>Vérifie ta connexion et réessaie.
        </div>
        {profileError.details&&<div style={{fontSize:10,color:'#f59e0b',background:'rgba(245,158,11,.06)',border:'1px solid rgba(245,158,11,.15)',borderRadius:10,padding:'10px 14px',marginBottom:20,textAlign:'left',fontFamily:'JetBrains Mono,monospace',wordBreak:'break-all'}}>
          <div style={{fontWeight:700,marginBottom:4}}>Erreur : {profileError.code}</div>
          {profileError.details}
        </div>}
        {profileError.code==='rls'&&<div style={{fontSize:11,color:'#5a5a7e',lineHeight:1.6,marginBottom:16,textAlign:'left',background:'rgba(14,165,233,.04)',border:'1px solid rgba(14,165,233,.1)',borderRadius:10,padding:'10px 14px'}}>
          💡 <strong style={{color:'#0ea5e9'}}>Possible cause :</strong> les policies RLS sur <code style={{color:'#f0ece6'}}>kalepin_profiles</code> bloquent la lecture. Exécutez le script SQL corrigé dans Supabase → SQL Editor.
        </div>}
        <div style={{display:'flex',gap:10,justifyContent:'center'}}>
          <button onClick={doRetry} style={{padding:'10px 24px',borderRadius:10,border:'none',background:'#c4324a',color:'#fff',fontSize:13,fontWeight:700,cursor:'pointer',fontFamily:'inherit'}}>Réessayer</button>
          <button onClick={doSignout} style={{padding:'10px 24px',borderRadius:10,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'var(--t3)',fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>Se déconnecter</button>
        </div>
      </div>
    </div>;
  }

  // ── Table Supabase absente (erreur 42P01) ──
  if(user && profile===null && profileError?.code==='table_missing'){
    const doSignout=async()=>{await authSignOut();setUser(null);setProfile(null);setProfileError(null);setSubStatus(null);};
    return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#080810',fontFamily:'DM Sans,sans-serif',padding:24}}>
      <div style={{maxWidth:440,width:'100%',textAlign:'center'}}>
        <div style={{width:60,height:60,borderRadius:16,background:'rgba(14,165,233,.12)',border:'1px solid rgba(14,165,233,.25)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,margin:'0 auto 20px'}}>🔧</div>
        <div style={{fontSize:20,fontWeight:800,color:'#f0ece6',marginBottom:10}}>Configuration requise</div>
        <div style={{fontSize:13,color:'#5a5a7e',lineHeight:1.7,marginBottom:24}}>
          La table <code style={{background:'rgba(255,255,255,.08)',padding:'1px 6px',borderRadius:4,color:'#f0ece6'}}>kalepin_profiles</code> n'existe pas dans Supabase.<br/>
          Exécute le script SQL fourni pour finaliser la configuration.
        </div>
        <button onClick={doSignout} style={{padding:'10px 24px',borderRadius:10,border:'1px solid rgba(255,255,255,.1)',background:'transparent',color:'var(--t3)',fontSize:13,cursor:'pointer',fontFamily:'inherit'}}>Se déconnecter</button>
      </div>
    </div>;
  }

  // ── App ouverte (approved ou admin) ──
  const isApproved=profile?.status==='approved'||profile?.role==='admin'||profile?.role==='superadmin';
  if(user && isApproved)return typeof children==='function'?children({user,profile,signOut:async()=>{await authSignOut();setUser(null);setProfile(null);setProfileError(null);setSubStatus(null)},subStatus}):children;
  

  // ── Page de présentation (landing) ──
  const isLogin=mode==='login',isSignup=mode==='signup',isForgot=mode==='forgot',isLanding=mode==='landing';

  if(isLanding)return<div style={{minHeight:'100vh',background:'#060609',fontFamily:'DM Sans,sans-serif',overflow:'auto'}}>
    {/* Fond */}
    <div style={{position:'fixed',inset:0,pointerEvents:'none'}}>
      <div style={{position:'absolute',top:'-10%',left:'20%',width:600,height:600,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.08),transparent 60%)',filter:'blur(100px)'}}/>
      <div style={{position:'absolute',bottom:'-5%',right:'15%',width:400,height:400,borderRadius:'50%',background:'radial-gradient(circle,rgba(14,165,233,.05),transparent 60%)',filter:'blur(80px)'}}/>
    </div>
    {/* Nav */}
    <div style={{position:'sticky',top:0,zIndex:20,background:'rgba(6,6,9,.85)',backdropFilter:'blur(16px)',borderBottom:'1px solid rgba(255,255,255,.04)'}}>
      <div style={{maxWidth:1100,margin:'0 auto',padding:'12px 28px',display:'flex',alignItems:'center',gap:12}}>
        <div style={{width:34,height:34,borderRadius:10,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:17,fontWeight:900,color:'#fff',boxShadow:'0 4px 16px rgba(196,50,74,.3)'}}>K</div>
        <span style={{fontSize:16,fontWeight:800,color:'#f0ece6',letterSpacing:'-.02em'}}>Kale<span style={{color:'#c4324a'}}>pin</span></span>
        <div style={{flex:1}}/>
        <button onClick={()=>setMode('login')} style={{padding:'7px 18px',borderRadius:8,border:'1px solid rgba(255,255,255,.08)',background:'transparent',color:'#9a9aac',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>Se connecter</button>
        <button onClick={()=>setMode('signup')} style={{padding:'7px 18px',borderRadius:8,border:'none',background:'#c4324a',color:'#fff',fontSize:12,fontWeight:700,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 4px 16px rgba(196,50,74,.3)'}}>Créer un compte</button>
      </div>
    </div>
    {/* Hero */}
    <div style={{maxWidth:1100,margin:'0 auto',padding:'80px 28px 48px',textAlign:'center',position:'relative',zIndex:1}}>
      <div style={{display:'inline-flex',alignItems:'center',gap:8,padding:'5px 16px',borderRadius:20,background:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)',marginBottom:28}}>
        <span style={{width:6,height:6,borderRadius:3,background:'#34d399',animation:'pulse-ring 2s infinite'}}/><span style={{fontSize:11,fontWeight:600,color:'#34d399'}}>Bêta ouverte — Accès gratuit</span>
      </div>
      <h1 style={{fontSize:'clamp(30px,5vw,48px)',fontWeight:800,lineHeight:1.1,color:'#f0ece6',marginBottom:20,letterSpacing:'-.03em'}}>
        De l'import de vos plans au<br/><span style={{background:'linear-gradient(135deg,#c4324a,#e8697f)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>bon de commande en 5 minutes</span>
      </h1>
      <p style={{fontSize:16,color:'rgba(255,255,255,.4)',maxWidth:600,margin:'0 auto 36px',lineHeight:1.7}}>
        L'outil métier conçu pour les <b style={{color:'rgba(255,255,255,.6)'}}>bardeurs et façadiers</b> qui souhaitent automatiser le calepinage, générer des métrés précis et visualiser le rendu 3D.
      </p>
      <div style={{display:'flex',justifyContent:'center',gap:12,flexWrap:'wrap'}}>
        <button onClick={()=>setMode('signup')} style={{padding:'14px 32px',borderRadius:12,border:'none',background:'#c4324a',color:'#fff',fontSize:15,fontWeight:700,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 6px 24px rgba(196,50,74,.35)'}}>Commencer gratuitement →</button>
        <button onClick={()=>setMode('login')} style={{padding:'14px 28px',borderRadius:12,border:'1px solid rgba(255,255,255,.1)',background:'rgba(255,255,255,.03)',color:'#9a9aac',fontSize:15,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>J'ai déjà un compte</button>
      </div>
    </div>
    {/* Modules */}
    <div style={{maxWidth:1100,margin:'0 auto',padding:'32px 28px 48px'}}>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))',gap:20}}>
        {[{icon:'🏢',title:'Facade Cassettes',desc:'Bardage métallique, cassettes, panneaux composites (Alucobond, Trespa, Equitone).',tags:['Import PDF/DXF','Calcul auto','3D RAL','Ossature','QR Chantier'],color:'196,50,74'},
          {icon:'🧱',title:'Facade Brique',desc:'Briques de parement, plaquettes. Appareillages classiques, joints, ouvertures et retours.',tags:['6 appareillages','Coupes auto','Retours','Drag & drop','Métrés'],color:'217,119,6'},
          {icon:'🔲',title:'Calepinage Carrelage',desc:'Sol, mur, piscine. Motifs de pose, calepins, coupes périphériques automatiques.',tags:['6 motifs','Sol/Mur/Piscine','Coupes','3D','Export'],color:'14,165,233'}
        ].map(m=><div key={m.title} style={{padding:28,borderRadius:20,background:'linear-gradient(135deg,rgba('+m.color+',.04),rgba('+m.color+',.01))',border:'1.5px solid rgba('+m.color+',.1)',transition:'all .25s'}}
          onMouseOver={e=>{e.currentTarget.style.borderColor='rgba('+m.color+',.3)';e.currentTarget.style.transform='translateY(-4px)'}}
          onMouseOut={e=>{e.currentTarget.style.borderColor='rgba('+m.color+',.1)';e.currentTarget.style.transform='none'}}>
          <div style={{fontSize:32,marginBottom:12}}>{m.icon}</div>
          <div style={{fontSize:17,fontWeight:700,color:'#f0ece6',marginBottom:6}}>{m.title}</div>
          <div style={{fontSize:12,color:'#5a5a6e',lineHeight:1.7,marginBottom:14}}>{m.desc}</div>
          <div style={{display:'flex',gap:5,flexWrap:'wrap'}}>{m.tags.map(t=><span key={t} style={{padding:'3px 10px',borderRadius:6,fontSize:9,fontWeight:700,background:'rgba('+m.color+',.08)',color:'rgb('+m.color+')'}}>{t}</span>)}</div>
        </div>)}
      </div>
    </div>
    {/* Features */}
    <div style={{maxWidth:1100,margin:'0 auto',padding:'32px 28px 48px'}}>
      <div style={{textAlign:'center',marginBottom:32}}>
        <div style={{fontSize:26,fontWeight:800,color:'#f0ece6',letterSpacing:'-.02em'}}>Tout ce qu'il faut pour vos chantiers</div>
        <div style={{fontSize:13,color:'#5a5a6e',marginTop:8}}>Du métré au bon de commande, en quelques clics</div>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))',gap:14}}>
        {[['📐','Import PDF & DXF','Importez vos plans architecte, calibrez et tracez vos zones'],
          ['🎨','Couleurs RAL réelles','Bibliothèque RAL et Arcelor intégrée avec rendu fidèle'],
          ['🧊','Visualisation 3D','Vue 3D interactive avec ombres, matériaux et rotation'],
          ['📊','Export PDF & Excel','Rapports détaillés, métrés automatiques, bons de commande'],
          ['🔗','QR Code Chantier','Partagez une vue 3D consultable sur smartphone'],
          ['☁️','Sauvegarde cloud','Projets synchronisés dans le cloud, accessible partout']
        ].map(([ic,t,d])=><div key={t} style={{padding:'18px 20px',borderRadius:14,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.05)'}}>
          <div style={{fontSize:22,marginBottom:8}}>{ic}</div>
          <div style={{fontSize:13,fontWeight:700,color:'#e0dcd6',marginBottom:4}}>{t}</div>
          <div style={{fontSize:11,color:'#5a5a6e',lineHeight:1.6}}>{d}</div>
        </div>)}
      </div>
    </div>
    {/* CTA */}
    <div style={{maxWidth:600,margin:'0 auto',padding:'40px 28px 80px',textAlign:'center'}}>
      <div style={{padding:'36px 32px',borderRadius:24,background:'linear-gradient(135deg,rgba(196,50,74,.08),rgba(196,50,74,.02))',border:'1px solid rgba(196,50,74,.15)'}}>
        <div style={{fontSize:22,fontWeight:800,color:'#f0ece6',marginBottom:10}}>Prêt à gagner du temps ?</div>
        <div style={{fontSize:13,color:'#5a5a6e',marginBottom:24}}>Créez votre compte et commencez votre premier calepinage en quelques minutes.</div>
        <button onClick={()=>setMode('signup')} style={{padding:'14px 36px',borderRadius:12,border:'none',background:'#c4324a',color:'#fff',fontSize:15,fontWeight:700,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 6px 24px rgba(196,50,74,.35)'}}>Créer mon compte gratuitement</button>
      </div>
    </div>
    <div style={{borderTop:'1px solid rgba(255,255,255,.04)',padding:'20px 28px',textAlign:'center'}}>
      <span style={{fontSize:10,color:'#3a3a4e'}}>Kalepin © 2025 — Outil professionnel de calepinage</span>
    </div>
  </div>;

  // ── Écran de connexion / inscription (épuré) ──
  return<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'#060609',fontFamily:'DM Sans,sans-serif',position:'relative'}}>
    <div style={{position:'absolute',inset:0,pointerEvents:'none'}}>
      <div style={{position:'absolute',top:'20%',left:'40%',width:400,height:400,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.08),transparent 60%)',filter:'blur(80px)'}}/>
    </div>
    <div style={{width:'100%',maxWidth:380,padding:'0 24px',position:'relative',zIndex:1}}>
      <div style={{textAlign:'center',marginBottom:32}}>
        <div onClick={()=>setMode('landing')} style={{display:'inline-flex',alignItems:'center',gap:10,cursor:'pointer',marginBottom:16}}>
          <div style={{width:40,height:40,borderRadius:12,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,fontWeight:900,color:'#fff',boxShadow:'0 6px 24px rgba(196,50,74,.3)'}}>K</div>
          <span style={{fontSize:20,fontWeight:800,color:'#f0ece6',letterSpacing:'-.02em'}}>Kale<span style={{color:'#c4324a'}}>pin</span></span>
        </div>
        <div style={{fontSize:14,color:'#5a5a6e'}}>{isForgot?'Réinitialiser le mot de passe':isSignup?'Créer votre compte':'Bon retour'}</div>
      </div>
      <div style={{background:'rgba(22,22,31,.6)',border:'1px solid rgba(255,255,255,.06)',borderRadius:20,padding:'28px 24px',backdropFilter:'blur(12px)'}}>
        {!isForgot&&<div style={{display:'flex',background:'rgba(255,255,255,.03)',borderRadius:10,padding:3,marginBottom:24,gap:2}}>
          {[['login','Connexion'],['signup','Inscription']].map(([m,l])=><button key={m} onClick={()=>switchMode(m)} style={{
            flex:1,padding:'8px',borderRadius:8,fontSize:12,fontWeight:600,border:'none',cursor:'pointer',fontFamily:'inherit',transition:'all .2s',
            background:mode===m?'#c4324a':'transparent',color:mode===m?'#fff':'#5a5a6e'
          }}>{l}</button>)}
        </div>}
        {isForgot&&<div style={{marginBottom:20}}>
          <button onClick={()=>switchMode('login')} style={{display:'flex',alignItems:'center',gap:5,background:'none',border:'none',color:'#5a5a6e',cursor:'pointer',fontSize:11,fontFamily:'inherit',padding:0,marginBottom:12}}>← Retour</button>
          <div style={{fontSize:11,color:'#5a5a6e'}}>Saisissez votre email, on vous envoie un lien</div>
        </div>}
        {error&&<div style={{background:'rgba(239,68,68,.08)',border:'1px solid rgba(239,68,68,.2)',borderRadius:10,padding:'10px 12px',marginBottom:16,fontSize:12,color:'#ef4444',display:'flex',alignItems:'flex-start',gap:8}}>
          <span style={{flexShrink:0}}>⚠</span><span>{error}</span>
        </div>}
        {info&&<div style={{background:'rgba(16,185,129,.08)',border:'1px solid rgba(16,185,129,.2)',borderRadius:10,padding:'10px 12px',marginBottom:16,fontSize:12,color:'#10b981',display:'flex',alignItems:'center',gap:8}}>
          <span>✓</span>{info}
        </div>}
        <div style={{display:'flex',flexDirection:'column',gap:14}}>
          {isSignup&&<div>
            <label style={{fontSize:10,fontWeight:600,color:'#5a5a6e',marginBottom:5,display:'block',letterSpacing:'.05em'}}>NOM</label>
            <input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Jean Dupont" className="idark"
              style={{width:'100%',padding:'11px 12px',borderRadius:9,fontSize:13,boxSizing:'border-box'}}
              onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter')handleSignup()}}/>
          </div>}
          <div>
            <label style={{fontSize:10,fontWeight:600,color:'#5a5a6e',marginBottom:5,display:'block',letterSpacing:'.05em'}}>EMAIL</label>
            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="vous@entreprise.com" className="idark"
              style={{width:'100%',padding:'11px 12px',borderRadius:9,fontSize:13,boxSizing:'border-box'}}
              onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){isForgot?handleForgot():isLogin?handleLogin():handleSignup()}}}/>
          </div>
          {!isForgot&&<div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:5}}>
              <label style={{fontSize:10,fontWeight:600,color:'#5a5a6e',letterSpacing:'.05em'}}>MOT DE PASSE</label>
              {isLogin&&<button onClick={()=>switchMode('forgot')} style={{background:'none',border:'none',color:'#c4324a',fontSize:10,cursor:'pointer',fontFamily:'inherit',padding:0}}>Oublié ?</button>}
            </div>
            <div style={{position:'relative'}}>
              <input type={showPwd?'text':'password'} value={password} onChange={e=>setPassword(e.target.value)}
                placeholder={isSignup?'6 caractères minimum':''} className="idark"
                style={{width:'100%',padding:'11px 38px 11px 12px',borderRadius:9,fontSize:13,boxSizing:'border-box'}}
                onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){isLogin?handleLogin():handleSignup()}}}/>
              <button onClick={()=>setShowPwd(v=>!v)} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',cursor:'pointer',color:'#5a5a6e',padding:2,display:'flex',fontSize:14}}>
                {showPwd?'🙈':'👁'}</button>
            </div>
          </div>}
          <button onClick={isForgot?handleForgot:isLogin?handleLogin:handleSignup} disabled={submitting}
            style={{width:'100%',padding:'13px',background:submitting?'#5a1120':'#c4324a',color:'#fff',border:'none',borderRadius:10,
              fontSize:14,fontWeight:700,cursor:submitting?'wait':'pointer',fontFamily:'inherit',boxShadow:'0 4px 16px rgba(196,50,74,.3)',marginTop:4}}>
            {submitting?'…':isForgot?'Envoyer le lien':isLogin?'Se connecter':'Demander l\'accès bêta'}</button>
        </div>
        {isSignup&&<div style={{marginTop:14,padding:'10px 12px',background:'rgba(245,158,11,.05)',border:'1px solid rgba(245,158,11,.12)',borderRadius:9,display:'flex',alignItems:'center',gap:8}}>
          <span style={{fontSize:16}}>🔒</span><div style={{fontSize:11,color:'#5a5a6e'}}>Accès bêta — validation sous 24h</div>
        </div>}
      </div>
      <div style={{marginTop:20,fontSize:10,color:'#3a3a4e',textAlign:'center',lineHeight:1.7}}>
        En continuant, vous acceptez nos conditions d'utilisation et notre politique de confidentialité
      </div>
    </div>
  </div>;
}



async function supaUpload(zoneData){
  const cfg=getSupaConfig();if(!cfg.url||!cfg.key)return null;
  try{
    const res=await fetch(cfg.url+'/rest/v1/kalepin_views',{
      method:'POST',headers:{'Content-Type':'application/json','apikey':cfg.key,
        'Authorization':'Bearer '+cfg.key,'Prefer':'return=representation'},
      body:JSON.stringify({project_name:zoneData.project_name,zone_name:zoneData.zone_name,
        zone_json:zoneData.zone_json,calc_json:zoneData.calc_json,
        ral_color:zoneData.ral_color,ral_finish:zoneData.ral_finish})
    });
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();return data[0]?.id||null;
  }catch(e){console.error('Supabase upload:',e);return null}
}

async function supaFetch(viewId,cfgOverride){
  const cfg=cfgOverride||getSupaConfig();if(!cfg.url||!cfg.key)return null;
  try{
    const res=await fetch(cfg.url+'/rest/v1/kalepin_views?id=eq.'+viewId+'&select=*',{
      headers:{'apikey':cfg.key,'Authorization':'Bearer '+cfg.key}
    });
    if(!res.ok)return null;
    const data=await res.json();return data[0]||null;
  }catch(e){console.error('Supabase fetch:',e);return null}
}

// ═══════════════════════════════════════════════════════════
// CLOUD PROJECTS CRUD
// ═══════════════════════════════════════════════════════════
async function cloudProjectsList(){
  const s=getAuthSession();if(!s)return[];
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_projects?select=id,name,updated_at,zones_count,total_surface&order=updated_at.desc',{
      headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}
    });
    if(!res.ok)return[];return await res.json();
  }catch(e){return[]}
}

async function cloudProjectSave(projectData,existingId){
  const s=getAuthSession();if(!s)return null;
  const user=await authGetUser();if(!user)return null;
  const zonesCount=projectData.zones?.length||0;
  const totalSurf=projectData.zones?.reduce((a,z)=>(a+(z.L||0)*(z.H||0)/1e6),0)||0;
  const body={user_id:user.id,name:projectData.name||'Projet',data:projectData,
    zones_count:zonesCount,total_surface:Math.round(totalSurf*100)/100,updated_at:new Date().toISOString()};

  if(existingId){
    // Update
    try{
      const res=await fetch(SUPA.url+'/rest/v1/kalepin_projects?id=eq.'+existingId,{
        method:'PATCH',headers:{'Content-Type':'application/json','apikey':SUPA.key,
          'Authorization':'Bearer '+s.access_token,'Prefer':'return=representation'},
        body:JSON.stringify({name:body.name,data:body.data,zones_count:body.zones_count,total_surface:body.total_surface,updated_at:body.updated_at})
      });
      if(!res.ok){const e=await res.text();console.error('Cloud save update:',e);return null}
      const d=await res.json();return d[0]||{id:existingId};
    }catch(e){return null}
  }else{
    // Insert
    try{
      const res=await fetch(SUPA.url+'/rest/v1/kalepin_projects',{
        method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA.key,
          'Authorization':'Bearer '+s.access_token,'Prefer':'return=representation'},
        body:JSON.stringify(body)
      });
      if(!res.ok){const e=await res.text();console.error('Cloud save insert:',e);return null}
      const d=await res.json();return d[0]||null;
    }catch(e){return null}
  }
}

async function cloudProjectLoad(projectId){
  const s=getAuthSession();if(!s)return null;
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_projects?id=eq.'+projectId+'&select=*',{
      headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}
    });
    if(!res.ok)return null;const d=await res.json();return d[0]||null;
  }catch(e){return null}
}

async function cloudProjectDelete(projectId){
  const s=getAuthSession();if(!s)return false;
  try{
    const res=await fetch(SUPA.url+'/rest/v1/kalepin_projects?id=eq.'+projectId,{
      method:'DELETE',headers:{'apikey':SUPA.key,'Authorization':'Bearer '+s.access_token}
    });
    return res.ok;
  }catch(e){return false}
}

async function cloudProjectDuplicate(projectId){
  const orig=await cloudProjectLoad(projectId);if(!orig)return null;
  const newData={...orig.data,name:(orig.name||'Projet')+' (copie)'};
  return await cloudProjectSave(newData,null);
}

function makeQRDataURL(text,sizeMM){
  if(typeof qrcode==='undefined')return null;
  try{
    const qr=qrcode(0,'L');qr.addData(text);qr.make();
    const mod=qr.getModuleCount();
    const cell=Math.max(2,Math.floor(sizeMM*3.78/mod));
    const cv=document.createElement('canvas');cv.width=cv.height=mod*cell;
    const cx=cv.getContext('2d');cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height);
    cx.fillStyle='#000';
    for(let r=0;r<mod;r++)for(let c2=0;c2<mod;c2++)if(qr.isDark(r,c2))cx.fillRect(c2*cell,r*cell,cell,cell);
    return cv.toDataURL('image/png');
  }catch(e){console.error('QR:',e);return null}
}

// ── VIEWER MODE (standalone 3D from QR scan) ──
function ViewerApp({viewId}){
  const[data,setData]=useState(null);const[err,setErr]=useState(null);const[loading,setLoading]=useState(true);
  const[showWall,setShowWall]=useState(true);
  useEffect(()=>{
    // Read supabase config from URL params (embedded in QR link) or fallback to localStorage
    const params=new URLSearchParams(window.location.search);
    const cfgFromUrl={url:params.get('s_url')||'',key:params.get('s_key')||''};
    const cfg=(cfgFromUrl.url&&cfgFromUrl.key)?cfgFromUrl:getSupaConfig();
    supaFetch(viewId,cfg).then(d=>{
      if(d){setData(d)}else{setErr('Projet introuvable')}
      setLoading(false);
    });
  },[viewId]);
  if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'#1a1a2e',color:'#fff',fontFamily:'DM Sans'}}>
    <div style={{textAlign:'center'}}><div style={{fontSize:32,marginBottom:12}}>⏳</div><div>Chargement du projet 3D...</div></div></div>;
  if(err||!data)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'#1a1a2e',color:'#fff',fontFamily:'DM Sans'}}>
    <div style={{textAlign:'center'}}><div style={{fontSize:32,marginBottom:12}}>⚠️</div><div>{err||'Erreur'}</div>
      <a href={window.location.pathname} style={{color:'#8b5cf6',marginTop:16,display:'block'}}>← Retour au Kalepin</a></div></div>;
  const zone=JSON.parse(data.zone_json);const calc=JSON.parse(data.calc_json);
  return<div style={{width:'100vw',height:'100vh',position:'relative'}}>
    <Facade3D zone={zone} calc={calc} ralColor={data.ral_color||'#383E42'} ralFinish={data.ral_finish||'mat'}
      showWall={showWall} onToggle={k=>{if(k==='wall')setShowWall(v=>!v);}} onClose={()=>window.location.href=window.location.pathname} hideBack={true}/>
    <div style={{position:'absolute',top:16,left:16,zIndex:100,background:'rgba(0,0,0,.7)',padding:'10px 16px',borderRadius:12,color:'#fff',fontFamily:'DM Sans'}}>
      <div style={{fontSize:14,fontWeight:700}}>{data.project_name}</div>
      <div style={{fontSize:11,opacity:.7}}>{data.zone_name} — {zone.L/1000}×{zone.H/1000}m</div>
    </div>
  </div>;
}

function App({user,profile,signOut,subStatus}){
  const[step,setStep]=useState('dashboard');
  // Garde de sécurité : si un user non-superadmin se retrouve sur le step admin, on le renvoie
  useEffect(()=>{
    if(step==='admin'&&profile?.role!=='superadmin'){setStep('dashboard');}
  },[step,profile]);
  const[projectName,setProjectName]=useState('Projet facade');
  const[bgSrc,setBgSrc]=useState(null);const[bgW,setBgW]=useState(0);const[bgH,setBgH]=useState(0);
  const[bgOp,setBgOp]=useState(.35);const[bgVis,setBgVis]=useState(true);
  const[zoom,setZoom]=useState(1);const[pan,setPan]=useState({x:0,y:0});const[isPanning,setIsPanning]=useState(null);
  const viewStatesRef=useRef({});// {zoneId: {zoom, pan}} — per-tab view memory
  const saveView=useCallback((zoneId,z,p)=>{viewStatesRef.current[zoneId]={zoom:z,pan:p};},[]);
  const restoreView=useCallback((zoneId,fallbackFn)=>{
    const saved=viewStatesRef.current[zoneId];
    if(saved){setZoom(saved.zoom);setPan(saved.pan);}
    else if(fallbackFn){fallbackFn();}
  },[]);
  const[calPts,setCalPts]=useState([]);const[calMm,setCalMm]=useState(1000);const[calModal,setCalModal]=useState(false);const[mmPerPx,setMmPerPx]=useState(null);
  const[zoneStart,setZoneStart]=useState(null);const[zoneCur,setZoneCur]=useState(null);
  const[zones,setZones]=useState([]);const[activeZoneIdx,setActiveZoneIdx]=useState(0);
  const az=zones[activeZoneIdx]||null;
  const[fix,setFix]=useState({pp:6,em:3});
  const[selId,setSelId]=useState(null);const[selIds,setSelIds]=useState(new Set());const[showAlignPanel,setShowAlignPanel]=useState(false);const[modeDraw,setModeDraw]=useState(false);const[drawRect,setDrawRect]=useState(null);
  const[lasso,setLasso]=useState(null);
  const[editPanel,setEditPanel]=useState(null);// {col, row, screenX, screenY}
  const[mergeSrc,setMergeSrc]=useState(null);// {col, row, parentCol, parentRow} — first panel for merge
  const[excludeMode,setExcludeMode]=useState(false);const[coupeOuv,setCoupeOuv]=useState(null);// true = click on panel to toggle exclusion
  const[excludeDepth,setExcludeDepth]=useState(1500);// default extrusion depth mm
  const[rightTab,setRightTab]=useState('resultats');
  const[presPan,setPresPan]=useState(DP);const[presOuv,setPresOuv]=useState(DO);
  const[addMod,setAddMod]=useState(null);const[expMod,setExpMod]=useState(false);
  const[expSel,setExpSel]=useState({});const[pdfOss,setPdfOss]=useState(false);const[pdfPageNums,setPdfPageNums]=useState({});
  const[xlsxExpMod,setXlsxExpMod]=useState(false);const[xlsxExpSel,setXlsxExpSel]=useState({});
  const[jsonExpMod,setJsonExpMod]=useState(false);const[jsonExpSel,setJsonExpSel]=useState({});
  const[jsonImpFile,setJsonImpFile]=useState(null);const[jsonImpMod,setJsonImpMod]=useState(false);const[jsonImpZones,setJsonImpZones]=useState([]);const[jsonImpSel,setJsonImpSel]=useState({});
  const[supaModal,setSupaModal]=useState(false);const[pdfQR,setPdfQR]=useState(false);const[pdfCass,setPdfCass]=useState(true);
  const[supaConf,setSupaConf]=useState(()=>getSupaConfig());
  const[renamingTab,setRenamingTab]=useState(null);// zone index being renamed inline
  const[optMod,setOptMod]=useState(false);const[optResults,setOptResults]=useState([]);
  // Polygon drawing
  const[polyMode,setPolyMode]=useState(false);const[polyPts,setPolyPts]=useState([]);
  // Zone dragging
  const[dragZone,setDragZone]=useState(null);
  const[dragJoint,setDragJoint]=useState(null);// {type:'h'|'v', index, startPos, origSize}
  const[resizeZone,setResizeZone]=useState(null);
  const[rotateZone,setRotateZone]=useState(null);
  // DXF vector overlay
  const[dxfData,setDxfData]=useState(null);// {lines:[{x1,y1,x2,y2}], bounds:{minX,minY,maxX,maxY}}
  // Snap system
  const[snapMode,setSnapMode]=useState('grid');// 'free','grid','oss'
  const[gridSize,setGridSize]=useState(10);// mm
  // Measurement tool
  const[measureMode,setMeasureMode]=useState(false);
  const[measurePts,setMeasurePts]=useState([]);// [{x,y}] in mm
  const[measures,setMeasures]=useState([]);// stored measurements
  // Métré panel
  const[metreOpen,setMetreOpen]=useState(false);
  const[userMenu,setUserMenu]=useState(false);
  const[showPaywall,setShowPaywall]=useState(false);
  const[showAccount,setShowAccount]=useState(false);
  const[showProjects,setShowProjects]=useState(false);
  const[showMasse,setShowMasse]=useState(false);
  const[showAdmin,setShowAdmin]=useState(false);
  // Admin check: by role (si table créée) OU par email hardcodé (fallback)
  // Sécurité : seul le rôle 'superadmin' (défini dans Supabase) donne accès au panel admin
  // Un profil null, undefined, ou role='user'/'admin' n'y a JAMAIS accès
  const isAdmin=profile!==null && profile!==undefined && profile.role==='superadmin';
  const isSuperAdmin=isAdmin;
  const[projectType,setProjectType]=useState('facade');// 'facade' or 'carrelage'
  const[dashProjects,setDashProjects]=useState([]);const[dashLoading,setDashLoading]=useState(true);
  useEffect(()=>{if(step==='dashboard')cloudProjectsList().then(p=>{setDashProjects(p||[]);setDashLoading(false)})},[step]);
  const[cloudProjId,setCloudProjId]=useState(null);
  const[saving,setSaving]=useState(false);
  const[lastSaved,setLastSaved]=useState(null);
  const[metreSelZones,setMetreSelZones]=useState({});
  // RAL Colors
  const RAL_COLORS=[
    // ── RAL Standards ──
    {code:'RAL 9010',name:'Blanc pur',hex:'#f5f5f0',cat:'RAL'},
    {code:'RAL 9016',name:'Blanc signalisation',hex:'#f7fbf5',cat:'RAL'},
    {code:'RAL 9001',name:'Blanc crème',hex:'#efebdc',cat:'RAL'},
    {code:'RAL 9005',name:'Noir foncé',hex:'#0e0e10',cat:'RAL'},
    {code:'RAL 9011',name:'Noir graphite',hex:'#27292b',cat:'RAL'},
    {code:'RAL 7016',name:'Gris anthracite',hex:'#383E42',cat:'RAL'},
    {code:'RAL 7035',name:'Gris clair',hex:'#C4C8C8',cat:'RAL'},
    {code:'RAL 7022',name:'Gris ombre',hex:'#4B4D46',cat:'RAL'},
    {code:'RAL 7024',name:'Gris graphite',hex:'#4E5258',cat:'RAL'},
    {code:'RAL 7040',name:'Gris fenêtre',hex:'#989EA1',cat:'RAL'},
    {code:'RAL 7039',name:'Gris quartz',hex:'#6B6B60',cat:'RAL'},
    {code:'RAL 7021',name:'Gris noir',hex:'#2F3234',cat:'RAL'},
    {code:'RAL 7015',name:'Gris ardoise',hex:'#51565C',cat:'RAL'},
    {code:'RAL 7036',name:'Gris platine',hex:'#97969A',cat:'RAL'},
    {code:'RAL 7047',name:'Télégris 4',hex:'#CBCED0',cat:'RAL'},
    {code:'RAL 1015',name:'Ivoire clair',hex:'#E6D2B5',cat:'RAL'},
    {code:'RAL 1013',name:'Blanc perlé',hex:'#E3D9C6',cat:'RAL'},
    {code:'RAL 1023',name:'Jaune signal',hex:'#F0CA00',cat:'RAL'},
    {code:'RAL 1028',name:'Jaune melon',hex:'#F5A300',cat:'RAL'},
    {code:'RAL 2004',name:'Orange pur',hex:'#E25303',cat:'RAL'},
    {code:'RAL 3000',name:'Rouge feu',hex:'#A72920',cat:'RAL'},
    {code:'RAL 3003',name:'Rouge rubis',hex:'#8D1D2C',cat:'RAL'},
    {code:'RAL 3004',name:'Rouge pourpre',hex:'#6B1C23',cat:'RAL'},
    {code:'RAL 3005',name:'Rouge vin',hex:'#5E2028',cat:'RAL'},
    {code:'RAL 5002',name:'Bleu outremer',hex:'#00387B',cat:'RAL'},
    {code:'RAL 5003',name:'Bleu saphir',hex:'#1E3A5F',cat:'RAL'},
    {code:'RAL 5008',name:'Bleu gris',hex:'#2B3A44',cat:'RAL'},
    {code:'RAL 5015',name:'Bleu ciel',hex:'#2271B3',cat:'RAL'},
    {code:'RAL 5024',name:'Bleu pastel',hex:'#608DA1',cat:'RAL'},
    {code:'RAL 6005',name:'Vert mousse',hex:'#0F4336',cat:'RAL'},
    {code:'RAL 6009',name:'Vert sapin',hex:'#1F3A28',cat:'RAL'},
    {code:'RAL 6021',name:'Vert pâle',hex:'#89AC76',cat:'RAL'},
    {code:'RAL 6029',name:'Vert menthe',hex:'#006B3E',cat:'RAL'},
    {code:'RAL 8014',name:'Brun sépia',hex:'#4A3526',cat:'RAL'},
    {code:'RAL 8017',name:'Brun chocolat',hex:'#45322E',cat:'RAL'},
    {code:'RAL 8019',name:'Brun gris',hex:'#3E3332',cat:'RAL'},
    {code:'RAL 8022',name:'Brun noir',hex:'#1A1718',cat:'RAL'},
    {code:'RAL 9006',name:'Alu blanc',hex:'#A1A1A0',cat:'RAL'},
    {code:'RAL 9007',name:'Alu gris',hex:'#878581',cat:'RAL'},
    // ── Anodisé ──
    {code:'ANO C0',name:'Naturel',hex:'#B0B0A8',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C31',name:'Bronze clair',hex:'#9B8B6C',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C32',name:'Bronze moyen',hex:'#7A6B52',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C33',name:'Bronze foncé',hex:'#5A4B3A',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C34',name:'Noir',hex:'#2A2520',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C35',name:'Champagne',hex:'#C8B898',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C21',name:'Or clair',hex:'#D4B86A',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C22',name:'Or moyen',hex:'#B8963C',cat:'Anodisé',finish:'brossé'},
    // ── Arcelor / PVDF ──
    {code:'ARC 905',name:'Blanc 905',hex:'#F0F0EC',cat:'Arcelor'},
    {code:'ARC 100',name:'Noir 100',hex:'#1A1A1A',cat:'Arcelor'},
    {code:'ARC 7016M',name:'Anthracite mat',hex:'#3A3F44',cat:'Arcelor',finish:'mat'},
    {code:'ARC 7016B',name:'Anthracite brillant',hex:'#454B52',cat:'Arcelor',finish:'brillant'},
    {code:'ARC 7016S',name:'Anthracite sablé',hex:'#3D4248',cat:'Arcelor',finish:'sablé'},
    {code:'ARC 9006',name:'Alu blanc',hex:'#A8A8A6',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC 9007',name:'Alu gris',hex:'#8C8880',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC 1015',name:'Ivoire Sunclean',hex:'#E8D6B8',cat:'Arcelor'},
    {code:'ARC 7035',name:'Gris clair Sunclean',hex:'#C6CACC',cat:'Arcelor'},
    {code:'ARC Zinc',name:'Zinc naturel',hex:'#BCC4C8',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC Bronze',name:'Bronze Arcelor',hex:'#6D5C48',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC Cuivre',name:'Cuivre Arcelor',hex:'#B07040',cat:'Arcelor',finish:'métallisé'},
    // ── Brillant / Satiné ──
    {code:'RAL 9010B',name:'Blanc pur brillant',hex:'#f7f7f2',cat:'Brillant',finish:'brillant'},
    {code:'RAL 9005B',name:'Noir brillant',hex:'#101012',cat:'Brillant',finish:'brillant'},
    {code:'RAL 7016B',name:'Anthracite brillant',hex:'#3C4248',cat:'Brillant',finish:'brillant'},
    {code:'RAL 7035B',name:'Gris clair brillant',hex:'#C8CCCC',cat:'Brillant',finish:'brillant'},
    {code:'RAL 3000B',name:'Rouge feu brillant',hex:'#AB2D24',cat:'Brillant',finish:'brillant'},
    {code:'RAL 5015B',name:'Bleu ciel brillant',hex:'#2675B7',cat:'Brillant',finish:'brillant'},
    {code:'RAL 9010S',name:'Blanc pur satiné',hex:'#f3f3ee',cat:'Satiné',finish:'satiné'},
    {code:'RAL 9005S',name:'Noir satiné',hex:'#131315',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7016S',name:'Anthracite satiné',hex:'#3A3F44',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7035S',name:'Gris clair satiné',hex:'#C2C6C6',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7021S',name:'Gris noir satiné',hex:'#2D3032',cat:'Satiné',finish:'satiné'},
    {code:'RAL 8019S',name:'Brun gris satiné',hex:'#3C3130',cat:'Satiné',finish:'satiné'},
    // ── Inox / Spécial ──
    {code:'INOX 304',name:'Inox brossé',hex:'#C8CCD0',cat:'Spécial',finish:'brossé'},
    {code:'INOX 316',name:'Inox poli miroir',hex:'#D8DDE0',cat:'Spécial',finish:'miroir'},
    {code:'COR-TEN',name:'Acier Corten',hex:'#8B4513',cat:'Spécial',finish:'oxydé'},
    {code:'COR-TEN V',name:'Corten vieilli',hex:'#6B3410',cat:'Spécial',finish:'oxydé'},
    {code:'CUIVRE N',name:'Cuivre neuf',hex:'#B87333',cat:'Spécial',finish:'poli'},
    {code:'CUIVRE P',name:'Cuivre patiné',hex:'#68896B',cat:'Spécial',finish:'patiné'},
    {code:'ZINC N',name:'Zinc neuf',hex:'#CDD4D8',cat:'Spécial',finish:'naturel'},
    {code:'ZINC P',name:'Zinc prépatiné',hex:'#8A9298',cat:'Spécial',finish:'patiné'},
    {code:'TITANE',name:'Titane brossé',hex:'#8C8C88',cat:'Spécial',finish:'brossé'},
    {code:'LAITON',name:'Laiton brossé',hex:'#C5A55A',cat:'Spécial',finish:'brossé'},
  ];
  const RAL_CATS=[...new Set(RAL_COLORS.map(r=>r.cat))];
  const[ralIdx,setRalIdx]=useState(2);// default RAL 7016 — remembered for new zone creation only
  // Per-zone RAL: each zone has its own ralIdx stored in zone.ralIdx
  // zoneRalIdx = the active zone's RAL (falls back to global default)
  const zoneRalIdx=az?(az.ralIdx??ralIdx):ralIdx;
  const setZoneRal=(i)=>{setRalIdx(i);updateAZ(z=>({...z,ralIdx:i}))};
  // (no sync effect — each zone is fully independent)
  const[ralCat,setRalCat]=useState('RAL');
  const[show3D,setShow3D]=useState(false);
  const[show3DWall,setShow3DWall]=useState(true);

  const cvRef=useRef(),svgRef=useRef(),fileRef=useRef();
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const snap=(v,g)=>{
    if(snapMode==='free')return Math.round(v);
    const gs=g||(snapMode==='oss'&&az?0:gridSize);
    if(snapMode==='oss'&&az){
      // Snap to nearest ossature line
      const eM=az.oss.eM,eL=az.oss.eL;
      const nearM=Math.round(v/eM)*eM,nearL=Math.round(v/eL)*eL,nearG=Math.round(v/gridSize)*gridSize;
      const dM=Math.abs(v-nearM),dL=Math.abs(v-nearL),dG=Math.abs(v-nearG);
      const best=Math.min(dM,dL,dG);
      if(best===dM)return nearM;if(best===dL)return nearL;return nearG;
    }
    return gs>0?Math.round(v/gs)*gs:Math.round(v);
  };
  const updateZone=(idx,fn)=>setZones(zs=>zs.map((z,i)=>i===idx?fn(z):z));
  const updateAZ=fn=>updateZone(activeZoneIdx,fn);
  // Snap opening edge to nearest panel joint boundary
  const snapOuvToJoint=(o,side)=>{
    try{
      if(!C||!C.baseXBounds||C.baseXBounds.length<2)return o;
      const xB=C.baseXBounds.map(v=>Math.round(v*1000));
      const yB=C.baseYBounds.map(v=>Math.round(v*1000));
      let nx=o.x,ny=o.y,nw=o.w,nh=o.h;
      const near=(arr,val)=>{if(!arr.length)return val;return arr.reduce((b,v)=>Math.abs(v-val)<Math.abs(b-val)?v:b,arr[0])};
      if(side==='left'){const n=near(xB,nx);nw=nx+nw-n;nx=n}
      if(side==='right'){const n=near(xB,nx+nw);nw=n-nx}
      if(side==='top'){const n=near(yB,ny);nh=ny+nh-n;ny=n}
      if(side==='bottom'){const n=near(yB,ny+nh);nh=n-ny}
      if(side==='all'){const nl=near(xB,nx);const nr=near(xB,nx+nw);const nt=near(yB,ny);const nb=near(yB,ny+nh);
        nx=nl;nw=nr-nl;ny=nt;nh=nb-nt}
      if(nw<100)nw=100;if(nh<100)nh=100;
      return{...o,x:Math.max(0,nx),y:Math.max(0,ny),w:Math.max(100,nw),h:Math.max(100,nh)};
    }catch(e){console.warn('snapOuvToJoint error',e);return o}
  };
  const manualScale=0.06;const pxPerMm_eff=mmPerPx?(1/mmPerPx):manualScale;

  const s2svg=useCallback((cx,cy)=>{
    if(!svgRef.current)return{x:0,y:0};const r=svgRef.current.getBoundingClientRect();
    return{x:(cx-r.left-pan.x)/zoom,y:(cy-r.top-pan.y)/zoom};
  },[zoom,pan]);
  const s2mm=useCallback((cx,cy,zn)=>{
    if(!svgRef.current||!zn)return{x:0,y:0};const sv=s2svg(cx,cy);
    const sc=mmPerPx||(1/manualScale);return{x:(sv.x-zn.facOrigin.x)*sc,y:(sv.y-zn.facOrigin.y)*sc};
  },[s2svg,mmPerPx]);
  const toMm=(cx,cy)=>s2mm(cx,cy,az);

  useEffect(()=>{const el=cvRef.current;if(!el)return;
    const h=e=>{if(show3D)return;e.preventDefault();const rect=el.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;
      const factor=e.deltaY>0?0.87:1.15;const nz=clamp(zoom*factor,0.01,80);
      const dx=mx-pan.x,dy=my-pan.y;const np={x:mx-dx*(nz/zoom),y:my-dy*(nz/zoom)};setPan(np);setZoom(nz);if(az)saveView(az.id,nz,np);};
    el.addEventListener('wheel',h,{passive:false});
    // Native middle-click handler for panning
    const mh=e=>{if(e.button===1){e.preventDefault();e.stopPropagation();
      setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y,mid:true})}};
    const aux=e=>{if(e.button===1)e.preventDefault()};
    el.addEventListener('mousedown',mh);el.addEventListener('auxclick',aux);
    return()=>{el.removeEventListener('wheel',h);el.removeEventListener('mousedown',mh);el.removeEventListener('auxclick',aux)}
  },[zoom,pan,show3D]);

  useEffect(()=>{const h=e=>{
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
    if(step==='work'){
      if(e.key==='d'||e.key==='D'){setModeDraw(v=>!v);setMeasureMode(false)}
      if(e.key==='m'||e.key==='M'){setMeasureMode(v=>!v);setModeDraw(false);setMeasurePts([])}
      if(e.key==='Delete'&&az){if(selIds.size>0){updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>!selIds.has(o.id))}));setSelIds(new Set())}else if(selId){updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>o.id!==selId)}));setSelId(null)}}
      if(e.key==='Escape'){setModeDraw(false);setMeasureMode(false);setMeasurePts([]);setSelId(null);setSelIds(new Set());setShowAlignPanel(false);setPolyPts([]);setEditPanel(null);setMergeSrc(null);setExcludeMode(false);setUserMenu(false);setShow3D(false)}
      // Ctrl+A = ouvrir panneau d'alignement (si sélection) ou sélectionner toutes
      if((e.ctrlKey||e.metaKey)&&e.key==='a'&&az){e.preventDefault();
        if(selIds.size>=2){setShowAlignPanel(v=>!v);}
        else if(az.ouvs.length>0){setSelIds(new Set(az.ouvs.map(o=>o.id)));setSelId(null);setShowAlignPanel(true);}}
      // Ctrl+E = toggle merge panel mode
      if((e.ctrlKey||e.metaKey)&&e.key==='e'&&az){e.preventDefault();if(mergeSrc){setMergeSrc(null)}else{setMergeSrc({parentCol:-1,parentRow:-1});setEditPanel(null);setSelId(null);}}
      // Copy openings from active zone
      if((e.ctrlKey||e.metaKey)&&e.key==='c'&&az){e.preventDefault();window._copiedOuvs=JSON.parse(JSON.stringify(az.ouvs))}
      // Paste openings into active zone
      if((e.ctrlKey||e.metaKey)&&e.key==='v'&&window._copiedOuvs&&az){e.preventDefault();
        const newOuvs=window._copiedOuvs.map(o=>({...o,id:Date.now()+Math.random()}));
        updateAZ(z=>({...z,ouvs:[...z.ouvs,...newOuvs]}))}
    }
    if(step==='zone'&&e.key==='Escape'){setPolyPts([]);setPolyMode(false)}
    // Enter to validate calibration
    if(calModal&&e.key==='Enter'){e.preventDefault();confirmCal()}
  };window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h);},[step,selId,selIds,az,activeZoneIdx,calModal,zones,zoom,mergeSrc,show3D]);

  const autoFit=useCallback(()=>{if(!cvRef.current||!zones.length)return;
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    zones.forEach(z=>{const ox=z.facOrigin.x,oy=z.facOrigin.y;const w=z.L*pxPerMm_eff,h=z.H*pxPerMm_eff;
      minX=Math.min(minX,ox);minY=Math.min(minY,oy);maxX=Math.max(maxX,ox+w);maxY=Math.max(maxY,oy+h);});
    const rect=cvRef.current.getBoundingClientRect();const totalW=maxX-minX,totalH=maxY-minY;
    if(totalW<1||totalH<1)return;const nz=Math.min((rect.width-80)/totalW,(rect.height-80)/totalH,5);
    setZoom(nz);setPan({x:(rect.width-totalW*nz)/2-minX*nz,y:(rect.height-totalH*nz)/2-minY*nz});
  },[zones,pxPerMm_eff]);

  const C=useMemo(()=>az?calcZone({...az,fix}):null,[az,fix]);
  const allCalcs=useMemo(()=>zones.map(z=>calcZone({...z,fix})),[zones,fix]);

  // ── Auto-save cloud every 3 min ──
  useEffect(()=>{
    if(!cloudProjId||step!=='work'||zones.length===0)return;
    const timer=setInterval(()=>{
      const data={v:16,name:projectName,zones,activeZoneIdx,ralIdx,
        bgSrc:null,mmPerPx,manualScale:0.06,savedAt:new Date().toISOString()};
      cloudProjectSave(data,cloudProjId).then(r=>{if(r)setLastSaved(new Date())});
    },180000);// 3 min
    return()=>clearInterval(timer);
  },[cloudProjId,step,zones,projectName,activeZoneIdx,ralIdx,mmPerPx]);

  /* ── FILE ── */
  const loadFile=file=>{if(!file)return;const ext=file.name.split('.').pop().toLowerCase();
    if(ext==='dxf'){const reader=new FileReader();reader.onload=ev=>{try{
      const dxf=parseDXF(ev.target.result);setDxfData(dxf);
      // Create raster preview from DXF for background
      const W=1600,H=Math.round(1600*(dxf.bounds.maxY-dxf.bounds.minY)/(dxf.bounds.maxX-dxf.bounds.minX))||1200;
      const cv=document.createElement('canvas');cv.width=W;cv.height=H;const ctx=cv.getContext('2d');
      ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);ctx.strokeStyle='#333';ctx.lineWidth=1;
      const sx=W/(dxf.bounds.maxX-dxf.bounds.minX)*.95,sy=H/(dxf.bounds.maxY-dxf.bounds.minY)*.95;
      const sc=Math.min(sx,sy),ox=W*.025,oy=H*.025;
      dxf.lines.forEach(l=>{ctx.beginPath();
        ctx.moveTo(ox+(l.x1-dxf.bounds.minX)*sc,H-oy-(l.y1-dxf.bounds.minY)*sc);
        ctx.lineTo(ox+(l.x2-dxf.bounds.minX)*sc,H-oy-(l.y2-dxf.bounds.minY)*sc);ctx.stroke()});
      processImage(cv.toDataURL(),W,H);
    }catch(e){alert('Erreur DXF: '+e.message)}};reader.readAsText(file);return}
    if(ext==='pdf'){if(typeof pdfjsLib==='undefined'){alert('PDF.js non charge');return}
      const reader=new FileReader();reader.onload=async ev=>{try{
        const pdf=await pdfjsLib.getDocument(new Uint8Array(ev.target.result)).promise;
        const pg=await pdf.getPage(1);const vp=pg.getViewport({scale:2});
        const cv=document.createElement('canvas');cv.width=vp.width;cv.height=vp.height;
        await pg.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
        processImage(cv.toDataURL(),vp.width,vp.height);
      }catch(e){alert('Erreur PDF: '+e.message)}};
      reader.readAsArrayBuffer(file);
    }else{const reader=new FileReader();reader.onload=ev=>{const img=new Image();img.onload=()=>processImage(ev.target.result,img.width,img.height);img.src=ev.target.result};reader.readAsDataURL(file)}};
  const processImage=(src,natW,natH)=>{setBgSrc(src);setBgW(natW);setBgH(natH);setCalPts([]);setMmPerPx(null);setStep('calibrate');
    setTimeout(()=>{if(!cvRef.current)return;const rect=cvRef.current.getBoundingClientRect();const z=Math.min((rect.width-60)/natW,(rect.height-60)/natH,2);setZoom(z);setPan({x:30,y:30})},50)};

  /* ── FIX ── */
  /* ── MOUSE ── */
  const handleDown=e=>{
    // Middle click handled natively (see useEffect above)
    if(e.button===1){return}
    if(e.button===2){e.preventDefault();setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y,mid:true});return}
    if(e.button!==0)return;if(editPanel)setEditPanel(null);const sv=s2svg(e.clientX,e.clientY);
    if(step==='calibrate'){if(calPts.length<2){const np=[...calPts,{x:sv.x,y:sv.y}];setCalPts(np);if(np.length===2)setCalModal(true)}return}
    if(step==='zone'){
      if(polyMode){// Add polygon point
        const sc=mmPerPx||(1/manualScale);const mmX=sv.x*sc,mmY=sv.y*sc;
        if(polyPts.length>=3){const d=Math.sqrt((sv.x-polyPts[0].sx)**2+(sv.y-polyPts[0].sy)**2);
          if(d<15/zoom){// Close polygon
            const poly=polyPts.map(p=>({x:p.mx,y:p.my}));const b=polyBounds(poly);
            const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,L:Math.round(b.w/50)*50||2000,H:Math.round(b.h/50)*50||2000,
              facOrigin:{x:polyPts[0].sx-b.x/sc,y:polyPts[0].sy-b.y/sc},
              poly:poly.map(p=>({x:Math.round(p.x-b.x),y:Math.round(p.y-b.y)})),
              pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[],ralIdx:ralIdx};
            newZ.L=Math.round(b.w/50)*50||2000;newZ.H=Math.round(b.h/50)*50||2000;
            setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);setPolyPts([]);return;
          }
        }
        setPolyPts(p=>[...p,{sx:sv.x,sy:sv.y,mx:mmX,my:mmY}]);return;
      }
      setZoneStart({x:sv.x,y:sv.y});setZoneCur({x:sv.x,y:sv.y});return;
    }
    if(step==='work'&&az){
      const mm=toMm(e.clientX,e.clientY);
      // Measurement mode
      if(measureMode){
        const pt={x:snap(mm.x),y:snap(mm.y)};
        if(measurePts.length===0){setMeasurePts([pt])}
        else if(measurePts.length===1){
          const p0=measurePts[0];const dist=Math.sqrt((pt.x-p0.x)**2+(pt.y-p0.y)**2);
          setMeasures(m=>[...m,{p0,p1:pt,dist:Math.round(dist),id:Date.now()}]);setMeasurePts([]);
        }
        return;
      }
      if(modeDraw&&az.L){const x=clamp(snap(mm.x),0,az.L-100),y=clamp(snap(mm.y),0,az.H-100);setDrawRect({x,y,sx:x,sy:y,w:0,h:0});return}
      if(mergeSrc)return;
      if(excludeMode)return;// In exclude mode — panel onClick will handle
      const mm2=toMm(e.clientX,e.clientY);
      const inZone=az&&mm2.x>=0&&mm2.x<=az.L&&mm2.y>=0&&mm2.y<=az.H;
      if(inZone){if(!e.shiftKey&&!(e.ctrlKey||e.metaKey)){setSelIds(new Set());setSelId(null);}if(!(e.ctrlKey||e.metaKey)){setLasso({sx:mm2.x,sy:mm2.y,x:mm2.x,y:mm2.y,w:0,h:0});}}
      setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y});
    }
  };

  const handleZoneDragStart=(e,idx)=>{e.stopPropagation();
    const sv=s2svg(e.clientX,e.clientY);
    setDragZone({idx,startX:sv.x,startY:sv.y,origX:zones[idx].facOrigin.x,origY:zones[idx].facOrigin.y});
  };

  const handleOuvDown=(e,o,act='move')=>{e.stopPropagation();if(modeDraw||step!=='work'||!az)return;
    if((e.shiftKey||(e.ctrlKey||e.metaKey))&&act==='move'){setSelIds(prev=>{const n=new Set(prev);n.has(o.id)?n.delete(o.id):n.add(o.id);return n});setSelId(null);return;}
    const inGroup=selIds.has(o.id)&&selIds.size>0;
    if(!inGroup){setSelId(o.id);setSelIds(new Set());}
    const mm=toMm(e.clientX,e.clientY);
    if(inGroup&&act==='move'){
      const ids=new Set(selIds);ids.add(o.id);
      const origs={};az.ouvs.forEach(v=>{if(ids.has(v.id))origs[v.id]={...v}});
      setIsPanning({type:'move-group',ids,sx:mm.x,sy:mm.y,origs});
    }else{setIsPanning({type:act,id:o.id,sx:mm.x,sy:mm.y,orig:{...o}});}
  };

  const handleMove=e=>{
    if(dragZone){const sv=s2svg(e.clientX,e.clientY);const dx=sv.x-dragZone.startX,dy=sv.y-dragZone.startY;
      updateZone(dragZone.idx,z=>({...z,facOrigin:{x:dragZone.origX+dx,y:dragZone.origY+dy}}));return;}
    if(resizeZone){
      const sc=mmPerPx||(1/manualScale);const ppm=mmPerPx?(1/mmPerPx):manualScale;
      const dx=(e.clientX-resizeZone.startX)/zoom,dy=(e.clientY-resizeZone.startY)/zoom;
      const dmx=dx*sc,dmy=dy*sc;const h=resizeZone.handle;
      updateZone(resizeZone.idx,z=>{
        let L=resizeZone.origL,H=resizeZone.origH,ox=resizeZone.origOrigin.x,oy=resizeZone.origOrigin.y;
        if(h.includes('e'))L=Math.max(500,Math.round((resizeZone.origL+dmx)/50)*50);
        if(h.includes('w')){const dL=Math.round(dmx/50)*50;L=Math.max(500,resizeZone.origL-dL);ox=resizeZone.origOrigin.x+dL*ppm;}
        if(h.includes('s'))H=Math.max(500,Math.round((resizeZone.origH+dmy)/50)*50);
        if(h.includes('n')){const dH=Math.round(dmy/50)*50;H=Math.max(500,resizeZone.origH-dH);oy=resizeZone.origOrigin.y+dH*ppm;}
        return{...z,L,H,facOrigin:{x:ox,y:oy}};
      });return;}
    if(rotateZone){
      const rect=cvRef.current.getBoundingClientRect();
      const z=zones[rotateZone.idx];const ppm=mmPerPx?(1/mmPerPx):manualScale;
      const cx=z.facOrigin.x*zoom+pan.x+z.L*ppm*zoom/2;
      const cy=z.facOrigin.y*zoom+pan.y+z.H*ppm*zoom/2;
      const angle=Math.atan2(e.clientY-rect.top-cy,e.clientX-rect.left-cx)*180/Math.PI;
      const delta=angle-rotateZone.startAngle;
      const newRot=Math.round((rotateZone.origRot+delta)*2)/2;// snap 0.5°
      updateZone(rotateZone.idx,z=>({...z,rot:clamp(newRot,-90,90)}));return;}
    if(step==='zone'&&zoneStart){const sv=s2svg(e.clientX,e.clientY);setZoneCur({x:sv.x,y:sv.y});return}
    if(step!=='work'||!az)return;
    if(drawRect){const mm=toMm(e.clientX,e.clientY);const x=clamp(snap(mm.x),0,az.L),y=clamp(snap(mm.y),0,az.H);
      setDrawRect(d=>({...d,x:Math.min(d.sx,x),y:Math.min(d.sy,y),w:Math.abs(x-d.sx),h:Math.abs(y-d.sy)}));return}
    if(!isPanning)return;
    if(!isPanning.type){
      if(lasso&&az){const m2=toMm(e.clientX,e.clientY);setLasso(l=>({...l,x:Math.min(l.sx,m2.x),y:Math.min(l.sy,m2.y),w:Math.abs(m2.x-l.sx),h:Math.abs(m2.y-l.sy)}));}
      else{const np={x:isPanning.px+(e.clientX-isPanning.sx),y:isPanning.py+(e.clientY-isPanning.sy)};setPan(np);if(az)saveView(az.id,zoom,np);}
      return}
    const mm=toMm(e.clientX,e.clientY);
    if(isPanning.type==='move'){const dx=mm.x-isPanning.sx,dy=mm.y-isPanning.sy,o=isPanning.orig;
      let nx=clamp(snap(o.x+dx),0,az.L-o.w),ny=clamp(snap(o.y+dy),0,az.H-o.h);
      // Soft snap to grid lines (within 30mm threshold)
      if(C){const thr=30;
        C.baseXBounds.forEach(b=>{const bm=Math.round(b*1000);if(Math.abs(nx-bm)<thr)nx=bm;if(Math.abs(nx+o.w-bm)<thr)nx=bm-o.w});
        C.baseYBounds.forEach(b=>{const bm=Math.round(b*1000);if(Math.abs(ny-bm)<thr)ny=bm;if(Math.abs(ny+o.h-bm)<thr)ny=bm-o.h});}
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>v.id===isPanning.id?{...v,x:clamp(nx,0,z.L-o.w),y:clamp(ny,0,z.H-o.h)}:v)}));return}
    if(isPanning.type==='move-group'){const dx=snap(mm.x-isPanning.sx),dy=snap(mm.y-isPanning.sy);
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>isPanning.ids.has(v.id)?{...v,x:clamp((isPanning.origs[v.id]?.x||v.x)+dx,0,z.L-v.w),y:clamp((isPanning.origs[v.id]?.y||v.y)+dy,0,z.H-v.h)}:v)}));return}
    if(isPanning.type?.startsWith('r-')){const dir=isPanning.type.slice(2),dx=mm.x-isPanning.sx,dy=mm.y-isPanning.sy,o=isPanning.orig;
      let x=o.x,y=o.y,w=o.w,h=o.h;
      if(dir.includes('w')){x=o.x+dx;w=o.w-dx}if(dir.includes('e'))w=o.w+dx;
      if(dir.includes('n')){y=o.y+dy;h=o.h-dy}if(dir.includes('s'))h=o.h+dy;
      if(w<200){if(dir.includes('w'))x=o.x+o.w-200;w=200}if(h<200){if(dir.includes('n'))y=o.y+o.h-200;h=200}
      x=clamp(snap(x),0,az.L-200);y=clamp(snap(y),0,az.H-200);w=snap(clamp(w,200,az.L-x));h=snap(clamp(h,200,az.H-y));
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>v.id===isPanning.id?{...v,x,y,w,h}:v)}));}
  };

  const handleUp=()=>{
    if(dragZone){setDragZone(null);return}
    if(resizeZone){setResizeZone(null);return}
    if(rotateZone){setRotateZone(null);return}
    if(step==='zone'&&!polyMode&&zoneStart&&zoneCur){
      const sc=mmPerPx||(1/manualScale);const x1=Math.min(zoneStart.x,zoneCur.x),y1=Math.min(zoneStart.y,zoneCur.y);
      const x2=Math.max(zoneStart.x,zoneCur.x),y2=Math.max(zoneStart.y,zoneCur.y);const wPx=x2-x1,hPx=y2-y1;
      const wScreen=wPx*zoom,hScreen=hPx*zoom;
      if(wScreen>25&&hScreen>25){const wMm=Math.max(500,Math.round(wPx*sc/50)*50),hMm=Math.max(500,Math.round(hPx*sc/50)*50);
        const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,L:wMm,H:hMm,facOrigin:{x:x1,y:y1},poly:null,
          pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[],ralIdx:ralIdx};
        setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);}
      setZoneStart(null);setZoneCur(null);return;}
    if(drawRect&&drawRect.w>=200&&drawRect.h>=200&&az){const nO={id:Date.now(),t:'Menuiserie',x:drawRect.x,y:drawRect.y,w:drawRect.w,h:drawRect.h};
      updateAZ(z=>({...z,ouvs:[...z.ouvs,nO]}));setSelId(nO.id);setModeDraw(false);}
    if(lasso&&az&&lasso.w>20&&lasso.h>20){
      const hit=az.ouvs.filter(o=>o.x>=lasso.x&&o.y>=lasso.y&&o.x+o.w<=lasso.x+lasso.w&&o.y+o.h<=lasso.y+lasso.h);
      if(hit.length>0){setSelIds(new Set(hit.map(o=>o.id)));setSelId(null);}
    }
    setLasso(null);setDrawRect(null);setIsPanning(null);setZoneStart(null);setZoneCur(null);
  };

  const confirmCal=()=>{if(calPts.length<2)return;const dx=calPts[1].x-calPts[0].x,dy=calPts[1].y-calPts[0].y;const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>0&&calMm>0){setMmPerPx(calMm/dist);setStep('zone')}setCalModal(false)};
  const loadProjectFile=useRef();
  const startManual=()=>{setZones([{id:Date.now(),name:'Zone 1',L:12000,H:8000,facOrigin:{x:100,y:100},poly:null,
    pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]}]);setActiveZoneIdx(0);setStep('work');setTimeout(autoFit,150)};
  const goToWork=()=>{if(zones.length>0){setActiveZoneIdx(0);setStep('work');setTimeout(autoFit,150)}};
  const addPOuv=p=>{if(!az)return;const x=snap(Math.random()*Math.max(0,az.L-p.w)),y=snap(Math.random()*Math.max(0,az.H-p.h));
    updateAZ(z=>({...z,ouvs:[...z.ouvs,{id:Date.now(),t:p.t,x,y,w:p.w,h:p.h}]}))};

  const runOptimize=()=>{if(!az)return;const r=optimizeLayout({...az,fix});setOptResults(r);setOptMod(true)};
  const applyOpt=opt=>{updateAZ(z=>({...z,vert:opt.vert,offX:opt.offX,offY:opt.offY}));setOptMod(false)};

  /* ── EXPORT ALL ZONES PNG ── */
  // ── PROJECT SAVE / LOAD ──
  const saveProject=async(forceNew)=>{
    const data={v:16,name:projectName,zones,activeZoneIdx,ralIdx,
      bgSrc:null,mmPerPx,manualScale:0.06,savedAt:new Date().toISOString()};
    setSaving(true);
    try{
      const result=await cloudProjectSave(data,forceNew?null:cloudProjId);
      if(result){
        if(!cloudProjId||forceNew)setCloudProjId(result.id);
        setLastSaved(new Date());
      }else{
        // Fallback: local JSON
        const json=JSON.stringify(data,null,2);const blob=new Blob([json],{type:'application/json'});
        const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
        a.download=`Kalepin_${projectName.replace(/\W/g,'_')}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();URL.revokeObjectURL(url);
      }
    }catch(e){console.error('Save:',e)}
    setSaving(false);
  };
  const exportProjectJSON=(selIdxs)=>{
    const selZones=selIdxs&&selIdxs.length>0?selIdxs.map(i=>zones[i]).filter(Boolean):zones;
    const data={v:16,name:projectName,zones:selZones,activeZoneIdx:0,ralIdx,
      mmPerPx,manualScale:0.06,savedAt:new Date().toISOString()};
    const json=JSON.stringify(data,null,2);const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;
    const suffix=selZones.length===1?'_'+selZones[0].name.replace(/\W+/g,'_'):'';
    a.download=`Kalepin_${projectName.replace(/\W/g,'_')}${suffix}_${new Date().toISOString().slice(0,10)}.json`;
    a.click();URL.revokeObjectURL(url);
  };
  // Ouvrir le picker JSON et lire les zones disponibles dans le fichier
  const jsonImpRef=useRef();
  const openJsonImport=()=>{jsonImpRef.current&&jsonImpRef.current.click();};
  const onJsonImpFile=(file)=>{
    if(!file)return;
    const reader=new FileReader();reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.zones||!Array.isArray(data.zones)){alert('Fichier projet invalide');return}
        setJsonImpFile(data);
        const sel={};data.zones.forEach((_,i)=>sel[i]=true);
        setJsonImpZones(data.zones);setJsonImpSel(sel);setJsonImpMod(true);
      }catch(e){alert('Erreur lecture fichier: '+e.message)}
    };reader.readAsText(file);
  };
  const confirmJsonImport=(mode)=>{// mode: 'replace' | 'append'
    const selIdxs=Object.entries(jsonImpSel).filter(([,v])=>v).map(([k])=>parseInt(k));
    if(!selIdxs.length){alert('Sélectionne au moins une zone');return}
    const importedZones=selIdxs.map(i=>({...jsonImpZones[i],id:Date.now()+Math.random()*1000}));
    if(mode==='replace'){
      setProjectName(jsonImpFile.name||'Projet');setZones(importedZones);setActiveZoneIdx(0);
      if(jsonImpFile.ralIdx!=null)setRalIdx(jsonImpFile.ralIdx);
      if(jsonImpFile.mmPerPx)setMmPerPx(jsonImpFile.mmPerPx);
      setCloudProjId(null);
    }else{
      const renamed=importedZones.map(z=>({...z,name:zones.some(ez=>ez.name===z.name)?z.name+' (imp.)':z.name}));
      setZones(prev=>[...prev,...renamed]);setActiveZoneIdx(zones.length);
    }
    setJsonImpMod(false);setJsonImpFile(null);setStep('work');setTimeout(autoFit,200);
  };
  const exportExcel=(selIdxs)=>{
    if(typeof XLSX==='undefined'){alert('SheetJS non chargé, réessayez dans quelques secondes.');return;}
    const selZones=selIdxs&&selIdxs.length>0
      ? selIdxs.map(i=>({z:zones[i],calc:allCalcs[i],i})).filter(r=>r.z&&r.calc)
      : zones.map((z,i)=>({z,calc:allCalcs[i],i})).filter(r=>r.calc);
    const wb=XLSX.utils.book_new();
    const date=new Date().toLocaleDateString('fr-FR');

    const HDR={fill:{fgColor:{rgb:'5A1020'}},font:{bold:true,color:{rgb:'FFFFFF'},sz:10,name:'Arial'},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'medium',color:{rgb:'8B1A2B'}}}};
    const TITLE={fill:{fgColor:{rgb:'3D0A13'}},font:{bold:true,color:{rgb:'FFFFFF'},sz:13,name:'Arial'},alignment:{horizontal:'center',vertical:'center'}};
    const TOT={fill:{fgColor:{rgb:'F0E4D0'}},font:{bold:true,sz:10,name:'Consolas',color:{rgb:'5A1020'}},alignment:{horizontal:'center',vertical:'center'},border:{top:{style:'medium',color:{rgb:'C4A882'}},bottom:{style:'medium',color:{rgb:'C4A882'}}}};
    const SUB={fill:{fgColor:{rgb:'F5EDE0'}},font:{bold:true,sz:9,name:'Arial'},alignment:{horizontal:'center',vertical:'center'},border:{bottom:{style:'thin',color:{rgb:'C4A882'}}}};
    const merge=(ws,rs)=>{ws['!merges']=(ws['!merges']||[]).concat(rs.map(r=>XLSX.utils.decode_range(r)))};
    const rh=(h)=>({hpt:h});

    // ONGLET 1 — BON DE COMMANDE CONSOLIDÉ
    {
      const globalDims={};
      selZones.forEach(({z,calc})=>{
        (calc.activePanels||calc.panelMap||[]).filter(p=>!p.isVoid&&!p.isExcluded).forEach(p=>{
          const pw=Math.round(p.pWa*1000),ph=Math.round(p.pHa*1000);
          const k=pw+'x'+ph;
          if(!globalDims[k])globalDims[k]={l:pw,h:ph,qty:0,surf:0};
          globalDims[k].qty++;globalDims[k].surf+=pw*ph/1e6;
        });
      });
      const rows=Object.entries(globalDims).sort((a,b)=>b[1].qty-a[1].qty);
      const totQty=rows.reduce((a,[,d])=>a+d.qty,0);
      const totSurf=rows.reduce((a,[,d])=>a+d.surf,0);
      const data=[];
      data.push([{v:'MÉTRÉS — PANNEAUX DE BARDAGE',t:'s',s:TITLE},...Array(5).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:'Projet : '+projectName+'   |   Édition : '+date+'   |   '+rows.length+' dimensions   |   '+totQty+' panneaux',t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(5).fill({v:'',t:'s'})]);
      data.push([{v:'',t:'s'},...Array(5).fill({v:'',t:'s'})]);
      data.push([
        {v:'Réf. Panneau',t:'s',s:HDR},{v:'Longueur\n(mm)',t:'s',s:HDR},{v:'Largeur\n(mm)',t:'s',s:HDR},
        {v:'Surface\nunit. (m²)',t:'s',s:HDR},{v:'Quantité',t:'s',s:HDR},{v:'Surface\ntotale (m²)',t:'s',s:HDR}
      ]);
      rows.forEach(([k,d],i)=>{
        const alt=i%2===0;const bg=alt?{rgb:'FFF8F0'}:{rgb:'FFFFFF'};
        const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
        data.push([
          {v:'P '+d.l+'x'+d.h,t:'s',s:{...s,font:{...s.font,bold:true}}},
          {v:d.l,t:'n',s},{v:d.h,t:'n',s},
          {v:Math.round(d.l*d.h/1e6*10000)/10000,t:'n',s:{...s,numFmt:'0.0000'}},
          {v:d.qty,t:'n',s:{...s,font:{...s.font,bold:true,color:{rgb:'8B1A2B'}}}},
          {v:Math.round(d.surf*100)/100,t:'n',s:{...s,numFmt:'0.00',font:{...s.font,bold:true}}}
        ]);
      });
      data.push([
        {v:'TOTAL',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},
        {v:totQty,t:'n',s:{...TOT,numFmt:'0'}},
        {v:Math.round(totSurf*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
      ]);
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:F1','A2:F2','A3:F3']);
      ws['!cols']=[{wch:18},{wch:12},{wch:12},{wch:16},{wch:12},{wch:16}];
      ws['!rows']=[rh(28),rh(16),rh(6),rh(28),...rows.map(()=>rh(20)),rh(22)];
      XLSX.utils.book_append_sheet(wb,ws,'Metres');
    }

    // ONGLET 2 — DÉTAIL PAR ZONE
    {
      const data=[];
      data.push([{v:'DETAIL PAR ZONE — DIMENSIONS ET QUANTITES',t:'s',s:TITLE},...Array(4).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(4).fill({v:'',t:'s'})]);
      const rowHeights=[rh(28),rh(14)];
      selZones.forEach(({z,calc})=>{
        const pans=(calc.activePanels||calc.panelMap||[]).filter(p=>!p.isVoid&&!p.isExcluded);
        const dm={};pans.forEach(p=>{
          const k=Math.round(p.pWa*1000)+'x'+Math.round(p.pHa*1000);dm[k]=(dm[k]||0)+1;
        });
        const dimRows=Object.entries(dm).sort((a,b)=>b[1]-a[1]);
        data.push([{v:'',t:'s'},...Array(4).fill({v:'',t:'s'})]);rowHeights.push(rh(6));
        data.push([
          {v:'▶  '+z.name+'   ('+( z.L/1000).toFixed(2)+' x '+(z.H/1000).toFixed(2)+' m)   —   Panneau type : '+(z.pan_.nom||z.pan_.l+'x'+z.pan_.w)+' mm',
           t:'s',s:{fill:{fgColor:{rgb:'F2E8DE'}},font:{bold:true,sz:10,color:{rgb:'5A1020'},name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
          ...Array(4).fill({v:'',t:'s',s:{fill:{fgColor:{rgb:'F2E8DE'}}}})
        ]);rowHeights.push(rh(22));
        data.push([
          {v:'Dimensions (mm)',t:'s',s:SUB},{v:'Longueur (mm)',t:'s',s:SUB},{v:'Largeur (mm)',t:'s',s:SUB},
          {v:'Quantite',t:'s',s:SUB},{v:'Surface totale (m2)',t:'s',s:SUB}
        ]);rowHeights.push(rh(18));
        dimRows.forEach(([d,q],i)=>{
          const parts=d.split('x');const dw=Number(parts[0]),dh=Number(parts[1]);
          const alt=i%2===0;const bg={rgb:alt?'FFF5EE':'FFFFFF'};
          const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
          data.push([
            {v:d,t:'s',s:{...s,font:{...s.font,bold:true}}},
            {v:dw,t:'n',s},{v:dh,t:'n',s},
            {v:q,t:'n',s:{...s,font:{...s.font,bold:true,color:{rgb:'8B1A2B'}}}},
            {v:Math.round(dw*dh/1e6*q*100)/100,t:'n',s:{...s,numFmt:'0.00'}}
          ]);rowHeights.push(rh(18));
        });
        const totZ=pans.length;const surfZ=pans.reduce((a,p)=>a+Math.round(p.pWa*1000)*Math.round(p.pHa*1000)/1e6,0);
        data.push([
          {v:'Total zone',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},
          {v:totZ,t:'n',s:{...TOT,numFmt:'0'}},
          {v:Math.round(surfZ*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
        ]);rowHeights.push(rh(20));
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:E1','A2:E2']);
      ws['!cols']=[{wch:18},{wch:14},{wch:14},{wch:12},{wch:18}];
      ws['!rows']=rowHeights;
      XLSX.utils.book_append_sheet(wb,ws,'Detail par zone');
    }

    // ONGLET 3 — METRÉS
    {
      const data=[];
      data.push([{v:'RECAPITULATIF METRES',t:'s',s:TITLE},...Array(7).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(7).fill({v:'',t:'s'})]);
      data.push([{v:'',t:'s'},...Array(7).fill({v:'',t:'s'})]);
      data.push([
        {v:'Zone',t:'s',s:HDR},{v:'L x H (m)',t:'s',s:HDR},{v:'S. brute (m2)',t:'s',s:HDR},
        {v:'S. ouvert. (m2)',t:'s',s:HDR},{v:'S. nette (m2)',t:'s',s:HDR},
        {v:'Panneaux',t:'s',s:HDR},{v:'Chutes (%)',t:'s',s:HDR},{v:'Ossature (ml)',t:'s',s:HDR}
      ]);
      let tBr=0,tOuv=0,tNet=0,tP=0,tOss=0;
      selZones.forEach(({z,calc},i)=>{
        tBr+=calc.sBr||0;tOuv+=calc.sOuv||0;tNet+=calc.sNet||0;tP+=calc.nP||0;tOss+=calc.tOss||0;
        const alt=i%2===0;const bg={rgb:alt?'FFF8F0':'FFFFFF'};
        const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
        data.push([
          {v:z.name,t:'s',s:{...s,font:{...s.font,bold:true,name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
          {v:(z.L/1000).toFixed(2)+' x '+(z.H/1000).toFixed(2),t:'s',s},
          {v:Math.round((calc.sBr||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}},
          {v:Math.round((calc.sOuv||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}},
          {v:Math.round((calc.sNet||0)*100)/100,t:'n',s:{...s,numFmt:'0.00',font:{...s.font,bold:true}}},
          {v:calc.nP||0,t:'n',s},
          {v:Math.round((calc.chut||0)*10)/10,t:'n',s:{...s,numFmt:'0.0',fill:{fgColor:{rgb:(calc.chut||0)>15?'FEF0F0':alt?'FFF8F0':'FFFFFF'}}}},
          {v:Math.round((calc.tOss||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}}
        ]);
      });
      data.push([
        {v:'TOTAL',t:'s',s:TOT},{v:'',t:'s',s:TOT},
        {v:Math.round(tBr*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}},
        {v:Math.round(tOuv*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}},
        {v:Math.round(tNet*100)/100,t:'n',s:{...TOT,numFmt:'0.00',font:{...TOT.font,color:{rgb:'8B1A2B'},sz:11}}},
        {v:tP,t:'n',s:{...TOT,numFmt:'0'}},{v:'',t:'s',s:TOT},
        {v:Math.round(tOss*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
      ]);
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:H1','A2:H2','A3:H3']);
      ws['!cols']=[{wch:16},{wch:14},{wch:13},{wch:14},{wch:13},{wch:10},{wch:11},{wch:13}];
      ws['!rows']=[rh(28),rh(14),rh(6),rh(26),...selZones.map(()=>rh(20)),rh(22)];
      XLSX.utils.book_append_sheet(wb,ws,'Recap surfaces');
    }

    // ONGLET 4 — OUVERTURES
    if(selZones.some(({z})=>z.ouvs?.length>0)){
      const data=[];
      data.push([{v:'OUVERTURES ET ENCADREMENTS',t:'s',s:TITLE},...Array(8).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(8).fill({v:'',t:'s'})]);
      const rhs=[rh(28),rh(14)];
      selZones.forEach(({z,calc})=>{
        if(!z.ouvs?.length)return;
        data.push([{v:'',t:'s'},...Array(8).fill({v:'',t:'s'})]);rhs.push(rh(6));
        data.push([{v:'▶  '+z.name,t:'s',s:{fill:{fgColor:{rgb:'FFF0F2'}},font:{bold:true,sz:10,color:{rgb:'BE123C'},name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},...Array(8).fill({v:'',t:'s',s:{fill:{fgColor:{rgb:'FFF0F2'}}}})]);rhs.push(rh(20));
        data.push([
          {v:'N°',t:'s',s:HDR},{v:'Type',t:'s',s:HDR},{v:'Largeur (mm)',t:'s',s:HDR},{v:'Hauteur (mm)',t:'s',s:HDR},
          {v:'Surface (m2)',t:'s',s:HDR},{v:'Tableau G (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'6B2030'}}}},
          {v:'Tableau D (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'6B2030'}}}},
          {v:'Linteau (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'4A1A25'}}}},{v:'Appui (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'4A1A25'}}}}
        ]);rhs.push(rh(26));
        z.ouvs.forEach((o,i)=>{
          const m=calc?.menuDet?.find(md=>md.id===o.id);
          const alt=i%2===0;const bg={rgb:alt?'FFF8FA':'FFFFFF'};
          const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
          data.push([
            {v:'O'+(i+1),t:'s',s:{...s,font:{...s.font,bold:true,color:{rgb:'BE123C'}}}},
            {v:o.t||'Menuiserie',t:'s',s:{...s,font:{...s.font,name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
            {v:o.w,t:'n',s},{v:o.h,t:'n',s},
            {v:Math.round(o.w*o.h/1e6*10000)/10000,t:'n',s:{...s,numFmt:'0.0000'}},
            m?{v:Math.round(m.tableauG*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.tableauD*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.linteau*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.appui*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s}
          ]);rhs.push(rh(18));
        });
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:I1','A2:I2']);
      ws['!cols']=[{wch:6},{wch:16},{wch:12},{wch:12},{wch:12},{wch:13},{wch:13},{wch:12},{wch:11}];
      ws['!rows']=rhs;
      XLSX.utils.book_append_sheet(wb,ws,'Ouvertures');
    }

    XLSX.writeFile(wb,'Kalepin_'+projectName.replace(/\W+/g,'_')+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
  };
  const exportCSV=exportExcel;
  const loadProject=(file,appendMode=false)=>{
    const reader=new FileReader();reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.zones||!Array.isArray(data.zones)){alert('Fichier projet invalide');return}
        if(appendMode){
          const newZones=data.zones.map(z=>({...z,id:Date.now()+Math.random(),
            name:zones.some(ez=>ez.name===z.name)?z.name+' (imp.)':z.name}));
          if(zones.length>0){
            setZones(prev=>[...prev,...newZones]);
            setActiveZoneIdx(zones.length);
          }else{
            setProjectName(data.name||'Projet');
            setZones(newZones);
            setActiveZoneIdx(0);
            if(data.ralIdx!=null)setRalIdx(data.ralIdx);
            if(data.mmPerPx)setMmPerPx(data.mmPerPx);
          }
          setStep('work');
          setTimeout(autoFit,200);
        }else{
          setProjectName(data.name||'Projet');
          setZones(data.zones);
          setActiveZoneIdx(data.activeZoneIdx||0);
          if(data.ralIdx!=null)setRalIdx(data.ralIdx);
          if(data.mmPerPx)setMmPerPx(data.mmPerPx);
          setCloudProjId(null);
          setStep('work');
          setTimeout(autoFit,200);
        }
      }catch(e){alert('Erreur lecture fichier: '+e.message)}
    };reader.readAsText(file);
  };
  const openCloudProject=async(projId)=>{
    const proj=await cloudProjectLoad(projId);
    if(!proj||!proj.data){alert('Projet introuvable');return}
    const data=proj.data;
    setProjectName(data.name||proj.name||'Projet');
    setZones(data.zones||[]);
    setActiveZoneIdx(data.activeZoneIdx||0);
    if(data.ralIdx!=null)setRalIdx(data.ralIdx);
    if(data.mmPerPx)setMmPerPx(data.mmPerPx);
    setCloudProjId(projId);
    setLastSaved(new Date(proj.updated_at));
    setShowProjects(false);
    setStep('work');
    setTimeout(autoFit,200);
  };

  const exportAllZones=async()=>{
    const now=new Date();const dateStr=now.toLocaleDateString('fr-FR');
    const W=2800,mg=50;

    for(let zi=0;zi<zones.length;zi++){
      const z=zones[zi];const zC=allCalcs[zi];if(!zC)continue;
      const zColor=ZONE_COLORS[zi%ZONE_COLORS.length];
      const panLabel=z.pan_.nom||`${z.pan_.l}x${z.pan_.w}`;
      const planAreaW=W-mg*2-380;const planH=520;
      const fAsp=z.L/z.H;let fW,fH;
      if(fAsp>(planAreaW-40)/(planH-30)){fW=planAreaW-40;fH=fW/fAsp}else{fH=planH-30;fW=fH*fAsp}
      const sc=fW/z.L;
      const encRows=zC.menuDet.length;const impRows=zC.impacts.length;
      const tableStartY=mg+planH+80;
      const totalH=tableStartY+Math.max(encRows,1)*26+80+Math.max(impRows,1)*26+80+120;

      const c=document.createElement('canvas');c.width=W;c.height=totalH;const ctx=c.getContext('2d');
      ctx.fillStyle='#fff';ctx.fillRect(0,0,W,totalH);

      // Header
      ctx.fillStyle='#1e293b';ctx.fillRect(0,0,W,46);
      ctx.fillStyle='#fff';ctx.font='bold 17px "DM Sans",sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';
      ctx.fillText(`${projectName.toUpperCase()}`,mg,23);
      ctx.font='12px "DM Sans",sans-serif';ctx.fillStyle='#94a3b8';ctx.textAlign='right';
      ctx.fillText(`${dateStr} | ${z.name} | ${panLabel} | ${z.vert?'V':'H'}${z.offX||z.offY?` dec.${z.offX}x${z.offY}`:''}`,W-mg,23);

      // ── OVERVIEW THUMBNAIL (top right) ──
      const ovW=180,ovH=120,ovX=W-mg-ovW,ovY=mg+56;
      ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.strokeRect(ovX-1,ovY-1,ovW+2,ovH+2);
      ctx.fillStyle='#f8fafc';ctx.fillRect(ovX,ovY,ovW,ovH);
      // Draw bg thumbnail
      if(bgSrc){try{const img=new Image();img.src=bgSrc;
        const ovSc=Math.min(ovW/bgW,ovH/bgH);
        ctx.drawImage(img,ovX+(ovW-bgW*ovSc)/2,ovY+(ovH-bgH*ovSc)/2,bgW*ovSc,bgH*ovSc);}catch(e){}}
      // Draw all zones on overview — relative to background image
      const bgRef_W=bgW||1,bgRef_H=bgH||1;
      const ovSc2=Math.min(ovW/bgRef_W,ovH/bgRef_H);
      const mapOX=ovX+(ovW-bgRef_W*ovSc2)/2,mapOY=ovY+(ovH-bgRef_H*ovSc2)/2;
      zones.forEach((zz,zzi)=>{
        const ppm=pxPerMm_eff||0.06;
        const rx=mapOX+zz.facOrigin.x*ovSc2,ry=mapOY+zz.facOrigin.y*ovSc2;
        const rw=zz.L*ppm*ovSc2,rh=zz.H*ppm*ovSc2;
        const isCur=zzi===zi;
        // Draw zone outline with high precision
        ctx.save();
        if(zz.rot){ctx.translate(rx+rw/2,ry+rh/2);ctx.rotate(zz.rot*Math.PI/180);ctx.translate(-(rx+rw/2),-(ry+rh/2))}
        ctx.fillStyle=isCur?`${ZONE_COLORS[zzi%8]}33`:'rgba(100,100,100,.08)';ctx.fillRect(rx,ry,rw,rh);
        ctx.strokeStyle=isCur?ZONE_COLORS[zzi%8]:'#999';ctx.lineWidth=isCur?2.5:.8;ctx.strokeRect(rx,ry,rw,rh);
        // Show ouvertures on minimap
        if(isCur&&zz.ouvs){
          ctx.fillStyle='rgba(251,113,133,.3)';
          zz.ouvs.forEach(o=>{ctx.fillRect(rx+o.x*ppm*ovSc2,ry+o.y*ppm*ovSc2,o.w*ppm*ovSc2,o.h*ppm*ovSc2)})
        }
        if(rw>12){ctx.fillStyle=isCur?ZONE_COLORS[zzi%8]:'#999';ctx.font=`bold ${Math.min(10,rw/4)}px sans-serif`;ctx.textAlign='left';ctx.textBaseline='top';ctx.fillText(zz.name,rx+2,ry+2)}
        // Dimension labels on minimap
        if(isCur&&rw>30){
          ctx.fillStyle=ZONE_COLORS[zzi%8];ctx.font='bold 7px monospace';ctx.textAlign='center';
          ctx.fillText(`${(zz.L/1000).toFixed(1)}m`,rx+rw/2,ry-3);
          ctx.save();ctx.translate(rx-3,ry+rh/2);ctx.rotate(-Math.PI/2);ctx.fillText(`${(zz.H/1000).toFixed(1)}m`,0,0);ctx.restore();
        }
        ctx.restore();
      });
      ctx.fillStyle='#64748b';ctx.font='9px sans-serif';ctx.textAlign='right';ctx.textBaseline='top';ctx.fillText('REPERAGE',ovX+ovW,ovY-12);

      // ── CALEPINAGE PLAN ──
      const fX=mg+20,fY=mg+56+20;
      // Polygon path or rectangle
      const drawFacadeOutline=(fx,fy,fw,fh,zn,ssc)=>{
        if(zn.poly){
          ctx.beginPath();zn.poly.forEach((p,i)=>{const px=fx+p.x/1000*ssc*1000,py=fy+p.y/1000*ssc*1000;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py)});ctx.closePath();
        }else{ctx.beginPath();ctx.rect(fx,fy,fw,fh)}
      };

      // BG clipped to facade
      if(bgSrc&&mmPerPx){try{const img=new Image();img.src=bgSrc;ctx.save();
        drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.clip();
        ctx.globalAlpha=0.25;ctx.drawImage(img,z.facOrigin.x,z.facOrigin.y,z.L/mmPerPx,z.H/mmPerPx,fX,fY,fW,fH);ctx.globalAlpha=1;ctx.restore();}catch(e){}}

      ctx.strokeStyle='#334155';ctx.lineWidth=2;drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.stroke();

      // Panels (with RAL color + void handling)
      ctx.save();drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.clip();
      const ralHex=RAL_COLORS[z.ralIdx??ralIdx]?.hex||'#383E42';
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*1000*sc,py=fY+pm.pTop*1000*sc,pw2=pm.pWa*1000*sc,ph2=pm.pHa*1000*sc;
        if(pm.isVoid){ctx.fillStyle='rgba(255,255,255,.06)';ctx.fillRect(px,py,pw2,ph2);return}
        ctx.fillStyle=ralHex;ctx.globalAlpha=0.88;ctx.fillRect(px+.5,py+.5,pw2-1,ph2-1);ctx.globalAlpha=1;
        ctx.strokeStyle=pm.isImpacted?'rgba(251,191,36,.7)':'rgba(255,255,255,.15)';ctx.lineWidth=pm.isImpacted?1.2:.4;ctx.strokeRect(px+.5,py+.5,pw2-1,ph2-1);
        if(pw2>16&&ph2>10){ctx.fillStyle='rgba(255,255,255,.6)';ctx.font=`bold ${Math.min(8,pw2/5)}px monospace`;ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText(pm.subRef,px+pw2/2,py+ph2/2)}
      });
      // Joint gaps (using base grid bounds)
      const merges=z.merges||[];
      if(zC.jGapsH&&zC.baseXBounds){ctx.fillStyle='rgba(251,191,36,.12)';
        zC.baseXBounds.slice(1,-1).forEach((bx,i)=>{
          // Check if this joint is inside a merged panel
          const isInsideMerge=merges.some(m=>i>=m.c1 && i<m.c2);
          if(isInsideMerge)return;  // Skip this joint
          const gw=(zC.jGapsH[i]||0)/1000*1000*sc;const gx=fX+bx*1000*sc;
          if(gw>0.3)ctx.fillRect(gx,fY,Math.max(gw,0.5),fH)});
      }
      if(zC.jGapsV&&zC.baseYBounds){ctx.fillStyle='rgba(251,191,36,.12)';
        zC.baseYBounds.slice(1,-1).forEach((by,i)=>{
          // Check if this joint is inside a merged panel
          const isInsideMerge=merges.some(m=>i>=m.r1 && i<m.r2);
          if(isInsideMerge)return;  // Skip this joint
          const gh=(zC.jGapsV[i]||0)/1000*1000*sc;const gy=fY+by*1000*sc;
          if(gh>0.3)ctx.fillRect(fX,gy,fW,Math.max(gh,0.5))});
      }
      // Montants/lisses
      ctx.lineWidth=.8;ctx.setLineDash([4,3]);
      // Montants interrupted around openings
      ctx.strokeStyle='rgba(200,110,0,.3)';
      for(let i=0;i<=zC.nM&&i<400;i++){const mx=fX+i*z.oss.eM*sc;if(mx>fX+fW)break;
        let segs=[{y1:fY,y2:fY+fH}];const mxMm=i*z.oss.eM;
        z.ouvs.forEach(o=>{if(mxMm<o.x+1||mxMm>o.x+o.w-1)return;
          const ns=[];segs.forEach(s=>{const oT=fY+o.y*sc,oB=fY+(o.y+o.h)*sc;
            if(oT>=s.y2||oB<=s.y1){ns.push(s);return}
            if(s.y1<oT)ns.push({y1:s.y1,y2:oT});if(oB<s.y2)ns.push({y1:oB,y2:s.y2});});segs=ns;});
        segs.forEach(s=>{ctx.beginPath();ctx.moveTo(mx,s.y1);ctx.lineTo(mx,s.y2);ctx.stroke()});}
      // Lisses interrupted
      ctx.strokeStyle='rgba(16,175,120,.3)';
      for(let i=0;i<=zC.nL&&i<200;i++){const ly=fY+i*z.oss.eL*sc;if(ly>fY+fH)break;
        let segs=[{x1:fX,x2:fX+fW}];const lyMm=i*z.oss.eL;
        z.ouvs.forEach(o=>{if(lyMm<o.y+1||lyMm>o.y+o.h-1)return;
          const ns=[];segs.forEach(s=>{const oL=fX+o.x*sc,oR=fX+(o.x+o.w)*sc;
            if(oL>=s.x2||oR<=s.x1){ns.push(s);return}
            if(s.x1<oL)ns.push({x1:s.x1,x2:oL});if(oR<s.x2)ns.push({x1:oR,x2:s.x2});});segs=ns;});
        segs.forEach(s=>{ctx.beginPath();ctx.moveTo(s.x1,ly);ctx.lineTo(s.x2,ly);ctx.stroke()});}
      ctx.setLineDash([]);
      // Ouvertures with cut dimensions
      z.ouvs.forEach((o,oi)=>{
        const ox=fX+o.x*sc,oy=fY+o.y*sc,ow=o.w*sc,oh=o.h*sc;
        ctx.fillStyle='rgba(255,200,210,.3)';ctx.fillRect(ox,oy,ow,oh);ctx.strokeStyle='#d21e40';ctx.lineWidth=1.5;ctx.strokeRect(ox,oy,ow,oh);
        ctx.strokeStyle='rgba(210,30,60,.1)';ctx.lineWidth=.4;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+ow,oy+oh);ctx.stroke();
        ctx.beginPath();ctx.moveTo(ox+ow,oy);ctx.lineTo(ox,oy+oh);ctx.stroke();
        if(ow>30){ctx.fillStyle='#be123c';ctx.font=`bold ${Math.min(10,ow/6)}px monospace`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(`O${oi+1}`,ox+ow/2,oy+oh/2-6);
          ctx.font=`${Math.min(8,ow/8)}px monospace`;ctx.fillText(`${o.w}x${o.h}`,ox+ow/2,oy+oh/2+6)}
      });
      ctx.restore();

      // Dimensions
      ctx.fillStyle='#1e293b';ctx.font='bold 12px monospace';ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText(`${(z.L/1000).toFixed(2)} m`,fX+fW/2,fY-6);
      ctx.save();ctx.translate(fX-14,fY+fH/2);ctx.rotate(-Math.PI/2);ctx.textBaseline='middle';ctx.fillText(`${(z.H/1000).toFixed(2)} m`,0,0);ctx.restore();

      // ── QUANTITATIF SIDEBAR ──
      const rX=ovX-200,rW=190;let ry=mg+56;
      const sRow=(lb,val,bold,color)=>{ctx.font=bold?'bold 11px sans-serif':'10px sans-serif';ctx.fillStyle=bold?(color||'#1e293b'):'#64748b';ctx.textAlign='left';ctx.fillText(lb,rX,ry);
        ctx.font=bold?'bold 12px monospace':'11px monospace';ctx.fillStyle=bold?(color||'#1e293b'):'#334155';ctx.textAlign='right';ctx.fillText(val,rX+rW,ry);ry+=bold?19:15};
      const sHead=(lb,color)=>{ctx.fillStyle=color;ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText(lb.toUpperCase(),rX,ry);ry+=14};
      sHead('Surfaces','#3b82f6');sRow('Brute',zC.sBr.toFixed(2)+' m2');sRow('Ouvertures','-'+zC.sOuv.toFixed(2)+' m2');sRow('Nette',zC.sNet.toFixed(2)+' m2',true,'#3b82f6');ry+=6;
      sHead('Panneaux','#8b5cf6');sRow('Total',zC.nP+' u',true);sRow('Impactes',zC.pImp+' u');sRow('Chutes',zC.chut.toFixed(1)+' %');ry+=6;
      sHead('Ossature','#d97706');sRow('Montants',zC.lMN.toFixed(1)+' ml');sRow('Lisses',zC.lLN.toFixed(1)+' ml');sRow('Total',zC.tOss.toFixed(1)+' ml',true);ry+=6;
      sHead('Encadrements','#0891b2');sRow('Tableaux',zC.totEnc.tab.toFixed(2)+' ml');sRow('Linteaux',zC.totEnc.lin.toFixed(2)+' ml');
      sRow('Appuis',zC.totEnc.app.toFixed(2)+' ml');sRow('Total encadr.',zC.totEnc.tot.toFixed(2)+' ml',true);ry+=6;
      if(zC.totCassettes&&zC.totCassettes.pliees>0){
        sHead('Cassettes pliées','#7c3aed');sRow('Nombre',zC.totCassettes.pliees+' pcs');
        sRow('Surface',zC.totCassettes.surfTot.toFixed(2)+' m²');sRow('ML total',zC.totCassettes.mlTot.toFixed(2)+' ml',true);ry+=6;
      }
      sHead('Fixations','#6b7280');sRow('Fixations',zC.tFix+' u');sRow('Equerres',zC.tEq+' u');

      // ── TABLE: ENCADREMENTS ──
      let ty=tableStartY;const tW=W-mg*2;
      ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';ctx.textBaseline='top';
      ctx.fillText('ENCADREMENTS MENUISERIES',mg,ty);ty+=22;
      const eH=['N','Type','L(mm)','H(mm)','Tab.G','Tab.D','Lint.','Appui','Total','Pan.imp.'];
      ctx.fillStyle='#f1f5f9';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#334155';ctx.font='bold 9px sans-serif';
      eH.forEach((h,i)=>{ctx.textAlign=i===0?'center':i>=9?'left':'right';ctx.fillText(h,mg+i*tW/10+tW/20,ty+8)});ty+=22;
      zC.menuDet.forEach((m,ri)=>{if(ri%2===0){ctx.fillStyle='#f8fafc';ctx.fillRect(mg,ty,tW,22)}
        const vals=[`O${ri+1}`,m.t,String(m.w),String(m.h),m.tableauG.toFixed(3),m.tableauD.toFixed(3),m.linteau.toFixed(3),m.appui.toFixed(3),m.encTotal.toFixed(3),m.impPanels.join(',')];
        ctx.font='10px monospace';vals.forEach((v,i)=>{ctx.fillStyle=i===8?'#059669':'#334155';ctx.textAlign=i===0?'center':i>=9?'left':'right';ctx.fillText(v,mg+i*tW/10+tW/20,ty+8)});
        ctx.strokeStyle='#e2e8f0';ctx.lineWidth=.3;ctx.beginPath();ctx.moveTo(mg,ty+22);ctx.lineTo(mg+tW,ty+22);ctx.stroke();ty+=22});
      // Total row
      ctx.fillStyle='#ecfdf5';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#059669';ctx.font='bold 10px sans-serif';ctx.textAlign='left';ctx.fillText('TOTAL',mg+10,ty+8);
      ctx.font='bold 11px monospace';ctx.textAlign='right';ctx.fillText(zC.totEnc.tot.toFixed(2)+' ml',mg+tW-10,ty+8);ty+=34;

      // ── TABLE: DECOUPE ──
      ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';ctx.fillText('PANNEAUX IMPACTES — DECOUPE',mg,ty);ty+=22;
      const dH=['Ref','Ouv.','Pan.L','Pan.H','Dec.X','Dec.Y','Dec.L','Dec.H','Pieces restantes'];
      ctx.fillStyle='#fffbeb';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#92400e';ctx.font='bold 9px sans-serif';
      dH.forEach((h,i)=>{ctx.textAlign=i>=8?'left':'center';ctx.fillText(h,i>=8?mg+8*tW/9+6:mg+i*tW/9+tW/18,ty+8)});ty+=22;
      zC.impacts.forEach((ip,ri)=>{if(ri%2===0){ctx.fillStyle='#fffef5';ctx.fillRect(mg,ty,tW,22)}
        const vals=[ip.ref,`O${ip.ouvIdx+1}`,String(ip.panW),String(ip.panH),String(ip.cutX),String(ip.cutY),String(ip.cutW),String(ip.cutH),
          ip.fullRemoval?'SUPPRIME':ip.pieces.map(p=>`${p.desc}:${p.w}x${p.h}`).join(' | ')];
        ctx.font='10px monospace';vals.forEach((v,i)=>{ctx.fillStyle=ip.fullRemoval&&i>=8?'#dc2626':i===0?'#d97706':'#334155';ctx.textAlign=i>=8?'left':'center';
          ctx.fillText(v,i>=8?mg+8*tW/9+6:mg+i*tW/9+tW/18,ty+8)});
        ctx.strokeStyle='#e2e8f0';ctx.lineWidth=.3;ctx.beginPath();ctx.moveTo(mg,ty+22);ctx.lineTo(mg+tW,ty+22);ctx.stroke();ty+=22});
      // Footer
      ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';ctx.textBaseline='bottom';
      ctx.fillText(`${projectName} — ${z.name} — ${dateStr}`,W-mg,totalH-15);
      ctx.fillStyle=zColor;ctx.fillRect(mg,totalH-20,60,4);

      c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);
        a.download=`Calepinage_${projectName.replace(/\W/g,'_')}_${z.name.replace(/\W/g,'_')}.png`;a.click()},'image/png');
      if(zi<zones.length-1)await new Promise(r=>setTimeout(r,300));
    }
  };

  /* ── SVG RENDERING ── */

  /* ── EXPORT PDF A4 PAYSAGE ── */

  // QR code and AR functions removed in v17

  const exportPDF=async(selZones,opts={})=>{
    const ok=await window._jspdfReady;if(!ok){alert('jsPDF non chargé');return}
    const{jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    const PW=297,PH=210,mg=7;const dateStr=new Date().toLocaleDateString('fr-FR');const showOss=opts.showOss||false;
    const showQR=opts.showQR||false;const showCass=opts.showCass!==false;const viewerBase=(getSupaConfig().viewerUrl||window.location.origin+window.location.pathname);
    let first=true;

    // Regrouper les zones par numéro de page
    const pageGroups=opts.pageGroups||{};// {zoneIdx: pageNum}
    const pages={};// {pageNum: [zoneIdx,...]}
    selZones.forEach(zi=>{const pg=pageGroups[zi]??zi;if(!pages[pg])pages[pg]=[];pages[pg].push(zi);});
    const pageList=Object.values(pages);

    for(const pageZones of pageList){
      if(!first)doc.addPage('a4','landscape');first=false;
      const nCols=pageZones.length;// zones côte-à-côte

      for(let col=0;col<nCols;col++){
        const zi=pageZones[col];
        const z=zones[zi];const zC=allCalcs[zi];if(!zC)continue;
        const zCol=ZONE_COLORS[zi%8];
        const rc=s=>[parseInt(s.slice(1,3),16)||100,parseInt(s.slice(3,5),16)||100,parseInt(s.slice(5,7),16)||200];
        const zRGB=rc(zCol);

        // Zone names in header
        if(col===0){
          doc.setDrawColor(180,30,50);doc.setLineWidth(0.3);doc.line(mg,11,PW-mg,11);
          doc.setTextColor(50,50,55);doc.setFont('helvetica','bold');doc.setFontSize(9);
          doc.text('CALEPINAGE',mg,7.5);
          doc.setFontSize(5.5);doc.setTextColor(120);doc.setFont('helvetica','normal');
          const names=pageZones.map(i=>zones[i].name).join(' + ');
          doc.text(names+' | '+dateStr,PW-mg,7.5,{align:'right'});
        }

        // Diviser la largeur plan entre les zones de la page
        const totalPlanW=PW*0.575;
        const colPlanW=nCols===1?totalPlanW:(totalPlanW-4*(nCols-1))/nCols;
        const colOffX=col*(colPlanW+(nCols>1?4:0));

        /* ═══ PLAN FACADE ═══ */
        const planH=PH-13-mg-6;
        const plX=mg+colOffX,plY=16;
        doc.setFillColor(252,252,254);doc.rect(plX,plY,colPlanW,planH,'F');
        doc.setDrawColor(220,220,225);doc.setLineWidth(.1);doc.rect(plX,plY,colPlanW,planH);

        // Zone label top-left of this column
        if(nCols>1){
          doc.setFillColor(...zRGB);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.15}));
          doc.rect(plX,plY,colPlanW,3,'F');doc.restoreGraphicsState();
          doc.setFontSize(4.5);doc.setFont('helvetica','bold');doc.setTextColor(...zRGB);
          doc.text(z.name,plX+2,plY+2.2);
        }

        const fMg=10;const avW=colPlanW-fMg*2-14,avH=planH-fMg*2-8;
        const fAsp=z.L/z.H;let fW,fH;
        if(fAsp>avW/avH){fW=avW;fH=fW/fAsp}else{fH=avH;fW=fH*fAsp}
        const fX=plX+fMg+7+(avW-fW)/2,fY=plY+fMg+4+(avH-fH)/2;
        const sc=fW/(z.L/1000);

      // ─ BACKGROUND PLAN behind panels ─
      if(bgSrc&&pxPerMm_eff){try{
        const facPxW=z.L*pxPerMm_eff,facPxH=z.H*pxPerMm_eff;
        const tmpC=document.createElement('canvas');
        tmpC.width=Math.min(Math.round(facPxW),2000);tmpC.height=Math.min(Math.round(facPxH),2000);
        const tmpCtx=tmpC.getContext('2d');const bgImg=new Image();bgImg.src=bgSrc;
        tmpCtx.drawImage(bgImg,z.facOrigin.x,z.facOrigin.y,facPxW,facPxH,0,0,tmpC.width,tmpC.height);
        const cropData=tmpC.toDataURL('image/jpeg',0.6);
        doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.3}));
        doc.addImage(cropData,'JPEG',fX,fY,fW,fH);
        doc.restoreGraphicsState();
      }catch(e){}}

      // ─ OSSATURE (optional) ─
      if(showOss){
        doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.12}));
        const eMm=z.oss.eM/1000;
        doc.setDrawColor(200,180,140);doc.setLineWidth(.03);
        for(let i=0;i*eMm*sc<=fW+.1&&i<300;i++){doc.setLineDashPattern([.6,.5],0);doc.line(fX+i*eMm*sc,fY,fX+i*eMm*sc,fY+fH)}
        const eLm=z.oss.eL/1000;doc.setDrawColor(160,185,160);
        for(let i=0;i*eLm*sc<=fH+.1&&i<300;i++){doc.setLineDashPattern([.6,.5],0);doc.line(fX,fY+i*eLm*sc,fX+fW,fY+i*eLm*sc)}
        doc.setLineDashPattern([],0);doc.restoreGraphicsState();
      }

      // ─ PANELS with color-coded repérage ─
      // Build color map by unique dimension
      const repColors=[[79,130,230],[52,180,140],[180,90,40],[139,92,246],[13,148,136],[180,30,50],[100,140,80],[200,130,50]];
      const dimColorMap={};let dci=0;
      zC.activePanels.forEach(pm=>{const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        if(!(k in dimColorMap)){dimColorMap[k]=repColors[dci%repColors.length];dci++}});
      doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.2}));
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc;
        const pw=pm.pWa*sc,ph=pm.pHa*sc;
        if(pw<.1||ph<.1)return;
        if(pm.isVoid){doc.setFillColor(30,30,30);doc.rect(px,py,pw,ph,'F');return}
        const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        const rgb=dimColorMap[k]||[200,200,210];
        doc.setFillColor(...rgb);doc.rect(px,py,pw,ph,'F');
      });
      doc.restoreGraphicsState();
      // Panel borders + refs
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc;
        const pw=pm.pWa*sc,ph=pm.pHa*sc;
        if(pw<.1||ph<.1||pm.isVoid)return;
        const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        const rgb=dimColorMap[k]||[160,165,180];
        doc.setDrawColor(...rgb);doc.setLineWidth(.06);doc.rect(px,py,pw,ph);
        if(pw>2&&ph>1.5){
          doc.setFontSize(Math.min(4,pw/2.5,ph/1.5));doc.setFont('courier','bold');doc.setTextColor(...rgb);
          doc.text(pm.subRef||((pm.col+1)+'.'+(pm.row+1)),px+pw/2,py+ph/2+.4,{align:'center'});
        }
      });
      // panDims for right column
      const panDims={};zC.activePanels.forEach(pm=>{const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);if(!panDims[k])panDims[k]=0;panDims[k]++});

      // ─ OPENINGS — group identical dims ─
      const ouvDimGroups={};z.ouvs.forEach((o,oi)=>{const k=o.w+'x'+o.h;if(!ouvDimGroups[k])ouvDimGroups[k]=[];ouvDimGroups[k].push(oi)});
      const shownDims=new Set();
      z.ouvs.forEach((o,oi)=>{
        const ox=fX+o.x/1000*sc,oy=fY+o.y/1000*sc;
        const ow=o.w/1000*sc,oh=o.h/1000*sc;
        doc.setFillColor(255,245,245);doc.setDrawColor(180,50,60);doc.setLineWidth(.1);
        doc.rect(ox,oy,ow,oh,'FD');
        doc.setLineWidth(.04);doc.setDrawColor(200,120,130);
        doc.line(ox,oy,ox+ow,oy+oh);doc.line(ox+ow,oy,ox,oy+oh);
        doc.setFont('helvetica','bold');doc.setFontSize(Math.min(5.5,ow/2.2));doc.setTextColor(160,30,40);
        if(ow>2)doc.text('O'+(oi+1),ox+ow/2,oy+oh/2,{align:'center'});
        // Show dims only once per unique size
        const dk=o.w+'x'+o.h;
        if(!shownDims.has(dk)&&ow>3){
          shownDims.add(dk);doc.setFont('courier','normal');doc.setFontSize(Math.min(3.5,ow/3));doc.setTextColor(140,60,70);
          const qty=ouvDimGroups[dk].length;
          doc.text(o.w+'x'+o.h+(qty>1?' (x'+qty+')':''),ox+ow/2,oy+oh/2+2.5,{align:'center'});
        }
      });

      // ─ FACADE BORDER ─
      doc.setDrawColor(80,85,95);doc.setLineWidth(.25);doc.rect(fX,fY,fW,fH);

      // ─ DIMENSION LINES ─
      doc.setDrawColor(130,135,145);doc.setLineWidth(.03);
      // Width top
      const dY=fY-4.5;
      doc.line(fX,dY,fX+fW,dY);doc.line(fX,dY-2,fX,dY+2);doc.line(fX+fW,dY-2,fX+fW,dY+2);
      // small arrow heads
      doc.setFillColor(100,105,120);
      doc.triangle(fX,dY,fX+1,dY-.4,fX+1,dY+.4,'F');
      doc.triangle(fX+fW,dY,fX+fW-1,dY-.4,fX+fW-1,dY+.4,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(50,55,65);
      doc.text((z.L/1000).toFixed(2)+' m',fX+fW/2,dY-1.5,{align:'center'});
      // Height left
      const dX=fX-6;
      doc.line(dX,fY,dX,fY+fH);doc.line(dX-2,fY,dX+2,fY);doc.line(dX-2,fY+fH,dX+2,fY+fH);
      doc.triangle(dX,fY,dX-.4,fY+1,dX+.4,fY+1,'F');
      doc.triangle(dX,fY+fH,dX-.4,fY+fH-1,dX+.4,fY+fH-1,'F');
      doc.text((z.H/1000).toFixed(2)+' m',dX-1.5,fY+fH/2,{align:'center',angle:90});

      // ─ UNIFIED LEGEND (below facade, wrapping to multiple rows) ─
      {const lY0=fY+fH+2.5,lX0=fX;let lx=lX0;let ly=lY0;const lh=2.4;const lineGap=3.2;const maxW=fX+fW;
       doc.setFontSize(2.8);doc.setFont('helvetica','normal');
       // Panel dim colors — always wrap
       const entries=Object.entries(dimColorMap);
       entries.forEach(([dim,rgb])=>{
         const qty=panDims[dim]||0;const txt=`${dim} (×${qty})`;
         const tw=doc.getTextWidth(txt)+5.5;
         if(lx+tw>maxW-1){lx=lX0;ly+=lineGap;}// wrap to next row
         doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.25}));
         doc.rect(lx,ly,2.5,lh,'F');doc.restoreGraphicsState();
         doc.setDrawColor(...rgb);doc.setLineWidth(.02);doc.rect(lx,ly,2.5,lh);
         doc.setTextColor(...rgb);doc.text(txt,lx+3,ly+1.65);
         lx+=tw;
       });
       // Ouverture legend
       const ouvTw=doc.getTextWidth('Ouverture')+6;
       if(lx+ouvTw>maxW-1){lx=lX0;ly+=lineGap;}
       doc.setFillColor(255,235,235);doc.setDrawColor(180,50,60);doc.setLineWidth(.04);
       doc.rect(lx,ly,2.5,lh,'FD');
       doc.setTextColor(180,50,60);doc.text('Ouverture',lx+3.5,ly+1.65);
      }

      // ─ REPERAGE (only if plan loaded) ─
      if(bgSrc&&pxPerMm_eff){
        const thW=30,thH=22,thX=plX+planW-thW-2,thY=plY+1.5;
        doc.setFillColor(250,250,252);doc.rect(thX,thY,thW,thH,'F');
        doc.setDrawColor(200,200,210);doc.setLineWidth(.08);doc.rect(thX,thY,thW,thH);
        // Background plan in reperage
        if(bgSrc){try{
          doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.2}));
          const bgAsp=bgW/bgH;let ibW,ibH;
          if(bgAsp>(thW-1)/(thH-1)){ibW=thW-1;ibH=ibW/bgAsp}else{ibH=thH-1;ibW=ibH*bgAsp}
          doc.addImage(bgSrc,'JPEG',thX+.5+(thW-1-ibW)/2,thY+.5+(thH-1-ibH)/2,ibW,ibH);
          doc.restoreGraphicsState();
        }catch(e){}}
        doc.setFontSize(3.5);doc.setFont('helvetica','bold');doc.setTextColor(150,150,160);
        doc.text('REPERAGE',thX+thW/2,thY+2.5,{align:'center'});
        // Map zones relative to background image (bgW x bgH in SVG pixels)
        const refW=bgW||1,refH=bgH||1;
        const bgAsp2=refW/refH;const thMg=2;
        let mapW,mapH;
        if(bgAsp2>(thW-thMg*2)/(thH-thMg*2-3)){mapW=thW-thMg*2;mapH=mapW/bgAsp2}
        else{mapH=thH-thMg*2-3;mapW=mapH*bgAsp2}
        const mapX=thX+thMg+(thW-thMg*2-mapW)/2,mapY=thY+3+thMg+(thH-thMg*2-3-mapH)/2;
        const ppm=pxPerMm_eff||1;
        zones.forEach((zz,zzi)=>{
          const rx=mapX+(zz.facOrigin.x/refW)*mapW;
          const ry=mapY+(zz.facOrigin.y/refH)*mapH;
          const rw=Math.max((zz.L*ppm/refW)*mapW,1.2);
          const rh=Math.max((zz.H*ppm/refH)*mapH,.8);
          const cur=zzi===zi;const zRGB2=rc(ZONE_COLORS[zzi%8]);
          doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:cur?0.7:0.4}));
          doc.setFillColor(...zRGB2);doc.rect(rx,ry,rw,rh,'F');
          doc.restoreGraphicsState();
          doc.setDrawColor(...zRGB2);doc.setLineWidth(cur?.35:.1);doc.rect(rx,ry,rw,rh);
          if(rw>3.5){doc.setFontSize(2.5);doc.setTextColor(...zRGB2);
            doc.setFont('helvetica','bold');doc.text(zz.name,rx+.5,ry+rh/2+.7)}
        });
      }

      /* ═══ RIGHT COLUMN: QUANTITATIF + TABLES ═══ */
      // Only shown for last zone in the page group (no room if multiple)
      if(col!==nCols-1)continue;// next col
      const totalPlanWR=PW*0.575;
      const rX=mg+totalPlanWR+3.5,rW=PW-rX-mg;let rY=plY;
      const rYstart=rY;
      // Right column background
      // Light right column

      doc.setDrawColor(220,220,225);doc.setLineWidth(.04);doc.line(rX-.5,plY,rX-.5,PH-8);

      const sTitle=(t,rgb)=>{
        doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.08}));doc.rect(rX,rY+.3,rW-1,4,'F');doc.restoreGraphicsState();
        doc.setFillColor(...rgb);doc.rect(rX+1,rY+.5,rW-2.5,.35,'F');
        doc.setFontSize(5);doc.setFont('helvetica','bold');doc.setTextColor(...rgb);
        doc.text(t,rX+2.5,rY+3.2);rY+=4.5;
      };
      const sRow=(lb,val,bold,rgb)=>{
        doc.setFontSize(bold?6:5.2);doc.setFont('helvetica',bold?'bold':'normal');
        doc.setTextColor(...(rgb||[70,75,90]));doc.text(lb,rX+3,rY+1.8);
        doc.setFont('courier','bold');doc.setFontSize(bold?6:5.2);
        doc.text(val,rX+rW-3,rY+1.8,{align:'right'});rY+=bold?3.8:3;
      };

      sTitle('SURFACES',[59,130,246]);
      sRow('Surface brute',zC.sBr.toFixed(2)+' m\u00B2');
      sRow('Ouvertures','-'+zC.sOuv.toFixed(2)+' m\u00B2');
      sRow('Surface nette',zC.sNet.toFixed(2)+' m\u00B2',true,[59,130,246]);rY+=1;

      sTitle('PANNEAUX',[139,92,246]);
      sRow('Total',zC.nP+' u ('+zC.nC+'c × '+zC.nR+'r)',true);
      rY+=1;

      // ── TABLEAU PANNEAUX COLORÉ ──
      // Header row
      const colW=[5,24,10,10,12];// swatch | dim | W | H | qty
      const tX=rX+1;
      doc.setFillColor(245,240,255);doc.rect(tX,rY,rW-2,3.5,'F');
      doc.setDrawColor(200,190,230);doc.setLineWidth(.02);doc.line(tX,rY+3.5,tX+rW-2,rY+3.5);
      doc.setFontSize(3.2);doc.setFont('helvetica','bold');doc.setTextColor(100,60,160);
      let tx2=tX+.5;
      ['','DIMENSIONS','Larg.','Haut.','QTE'].forEach((h,i)=>{doc.text(h,tx2+(i>0?.5:0),rY+2.5);tx2+=colW[i]});
      rY+=3.8;

      // Data rows
      const dimEntries=Object.entries(panDims).sort((a,b)=>b[1]-a[1]);
      dimEntries.forEach(([d,q],ri)=>{
        const [dw,dh]=d.split('x').map(Number);
        const rgb=dimColorMap[d]||[180,180,190];
        if(ri%2===0){doc.setFillColor(252,250,255);doc.rect(tX,rY-.3,rW-2,3.4,'F');}
        // Color swatch
        doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:.55}));
        doc.roundedRect(tX+.3,rY+.2,3.5,2.5,.4,.4,'F');doc.restoreGraphicsState();
        doc.setDrawColor(...rgb);doc.setLineWidth(.06);doc.roundedRect(tX+.3,rY+.2,3.5,2.5,.4,.4);
        // Values
        tx2=tX+.5+colW[0];
        doc.setFont('courier','bold');doc.setFontSize(3.5);doc.setTextColor(...rgb);
        doc.text(dw+'x'+dh,tx2,rY+2);tx2+=colW[1];
        doc.setFont('courier','normal');doc.setTextColor(80,80,95);
        doc.text(String(dw),tx2,rY+2);tx2+=colW[2];
        doc.text(String(dh),tx2,rY+2);tx2+=colW[3];
        doc.setFont('courier','bold');doc.setTextColor(100,60,160);
        doc.text(String(q)+' u',tx2,rY+2);
        rY+=3.2;
      });
      // Separator + total
      doc.setDrawColor(200,190,230);doc.setLineWidth(.04);doc.line(tX,rY,tX+rW-2,rY);rY+=1.5;
      doc.setFont('courier','bold');doc.setFontSize(4);doc.setTextColor(100,60,160);
      doc.text('Total : '+zC.nP+' panneaux',tX+rW-3,rY+2,{align:'right'});
      rY+=4.5;

      // Separator
      doc.setDrawColor(220,220,225);doc.setLineWidth(.04);doc.line(rX+2,rY,rX+rW-2,rY);rY+=2;

      // ─── TABLE ENCADREMENTS (grouped by identical type+dims) ───
      doc.setFont('helvetica','bold');doc.setFontSize(5.5);doc.setTextColor(50,55,65);
      doc.text('ENCADREMENTS',rX,rY+2);rY+=4;
      const eCols2=['Qté','Type','L','H','Tab.G','Tab.D','Lint.','Appui','Total'];
      const eW2=[7,11,9,9,11.5,11.5,11.5,11.5,15];
      doc.setDrawColor(200,200,210);doc.setLineWidth(.03);doc.line(rX,rY+3,rX+rW,rY+3);
      doc.setFontSize(3.5);doc.setFont('helvetica','bold');doc.setTextColor(110,115,130);
      let tx=rX+.5;eCols2.forEach((h,i)=>{doc.text(h,tx,rY+2);tx+=eW2[i]});rY+=3.8;
      // Group identical openings by type + dimensions + retours
      const encGroups={};zC.menuDet.forEach(m=>{
        const k=m.w+'|'+m.h+'|'+Math.round(m.tableauG*100)+'|'+Math.round(m.tableauD*100)+'|'+Math.round(m.linteau*100)+'|'+Math.round(m.appui*100);
        if(!encGroups[k])encGroups[k]={...m,qty:0,encTotalSum:0};
        encGroups[k].qty++;encGroups[k].encTotalSum+=m.encTotal;
      });
      const encRows=Object.values(encGroups);
      doc.setFont('courier','normal');doc.setFontSize(4);
      encRows.forEach((m,ri)=>{
        if(rY>PH-18)return;
        if(ri%2===0){doc.setFillColor(250,250,253);doc.rect(rX,rY-.5,rW,3.2,'F')}
        tx=rX+.5;doc.setTextColor(60,65,80);
        const vals=[m.qty>1?'x'+m.qty:'1',m.t,String(m.w),String(m.h),m.tableauG.toFixed(3),m.tableauD.toFixed(3),m.linteau.toFixed(3),m.appui.toFixed(3),m.encTotal.toFixed(3)];
        vals.forEach((v,i)=>{
          if(i===0&&m.qty>1){doc.setTextColor(180,30,50);doc.setFont('courier','bold')}
          else if(i===8){doc.setTextColor(180,30,50);doc.setFont('courier','bold')}
          else{doc.setTextColor(60,65,80);doc.setFont('courier','normal')}
          doc.text(v,tx,rY+2);tx+=eW2[i];
        });rY+=3.2;
      });
      if(zC.menuDet.length>0){
        doc.setDrawColor(200,200,210);doc.setLineWidth(.03);doc.line(rX,rY,rX+rW,rY);rY+=1;
        doc.setFont('courier','bold');doc.setFontSize(4.5);doc.setTextColor(180,30,50);
        doc.text('Total: '+zC.totEnc.tot.toFixed(2)+' ml  ('+zC.menuDet.length+' menuiseries)',rX+rW-3,rY+2,{align:'right'});
        rY+=4.5;
      }else{rY+=2}

      /* ═══ FOOTER ═══ */
      if(col===nCols-1){// Once per page
        doc.setDrawColor(180,30,50);doc.setLineWidth(.15);doc.line(mg,PH-5,PW-mg,PH-5);
        doc.setFontSize(4);doc.setTextColor(150,150,160);doc.setFont('helvetica','normal');
        const names=pageZones.map(i=>zones[i].name).join(' + ');
        doc.text(projectName+' | '+names+' | '+dateStr,PW-mg,PH-2,{align:'right'});
        // QR codes for each zone on this page
        if(showQR){
          let qxOff=mg;
          for(const zqi of pageZones){
            const zq=zones[zqi],zqC=allCalcs[zqi];if(!zqC)continue;
            try{
              const viewData={project_name:projectName,zone_name:zq.name,
                zone_json:JSON.stringify(zq),calc_json:JSON.stringify(zqC),
                ral_color:RAL_COLORS[zq.ralIdx??ralIdx]?.hex||'#383E42',ral_finish:RAL_COLORS[zq.ralIdx??ralIdx]?.finish||'mat'};
              const uid=await supaUpload(viewData);
              if(uid){
                const sConf=getSupaConfig();
                const viewUrl=viewerBase+'?view='+uid+'&s_url='+encodeURIComponent(sConf.url)+'&s_key='+encodeURIComponent(sConf.key);
                const qrImg=makeQRDataURL(viewUrl,18);
                if(qrImg){
                  doc.addImage(qrImg,'PNG',qxOff,PH-23,18,18);
                  doc.setFontSize(3);doc.setTextColor(120);
                  doc.text(zq.name,qxOff+9,PH-4,{align:'center'});
                  doc.text('Scan -> 3D',qxOff+9,PH-1.5,{align:'center'});
                  qxOff+=22;
                }
              }
            }catch(e){console.error('QR gen:',e)}
          }
        }
      }
      }// end col loop
    }// end page loop

    // ═══ PAGE CASSETTES PLIÉES — RAPPORT ═══
    if(showCass){
      const allCass=[];
      selZones.forEach(zi=>{
        const z=zones[zi],zC=allCalcs[zi];if(!zC||!zC.totCassettes)return;
        (zC.totCassettes.detail||[]).forEach(d=>allCass.push({...d,zone:z.name,zoneIdx:zi}));
      });
      if(allCass.length>0){
        doc.addPage('a4','landscape');
        const rc=s=>[parseInt(s.slice(1,3),16)||100,parseInt(s.slice(3,5),16)||100,parseInt(s.slice(5,7),16)||200];
        // Header
        doc.setFillColor(90,16,32);doc.rect(0,0,PW,13,'F');
        doc.setFont('helvetica','bold');doc.setFontSize(11);doc.setTextColor(255,255,255);
        doc.text('CASSETTES PLIEES  -  RAPPORT DETAILLE',PW/2,8,{align:'center'});
        doc.setFontSize(5);doc.setFont('helvetica','normal');doc.setTextColor(220,200,200);
        doc.text(projectName+' | '+dateStr,PW/2,11.5,{align:'center'});

        // Group by side
        const bySide={tG:[],tD:[],lin:[],app:[]};
        allCass.forEach(d=>{const sk=d.side||'app';if(bySide[sk])bySide[sk].push(d)});
        const sideInfo=[
          {key:'tG',label:'TABLEAU GAUCHE',color:[245,158,11],icon:'<'},
          {key:'tD',label:'TABLEAU DROIT',color:[59,130,246],icon:'>'},
          {key:'lin',label:'LINTEAU',color:[139,92,246],icon:'^'},
          {key:'app',label:'APPUI',color:[16,185,129],icon:'v'}
        ];

        // Summary boxes
        let bx=mg;const bw=(PW-mg*2-12)/4;
        sideInfo.forEach(si=>{
          const cnt=bySide[si.key].length;
          doc.setFillColor(...si.color);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.1}));
          doc.rect(bx,17,bw,14,'F');doc.restoreGraphicsState();
          doc.setDrawColor(...si.color);doc.setLineWidth(.3);doc.rect(bx,17,bw,14);
          doc.setFont('helvetica','bold');doc.setFontSize(12);doc.setTextColor(...si.color);
          doc.text(String(cnt),bx+bw/2,25,{align:'center'});
          doc.setFontSize(4.5);doc.text(si.label,bx+bw/2,29.5,{align:'center'});
          bx+=bw+4;
        });

        // Totals bar
        doc.setFillColor(245,240,235);doc.rect(mg,34,PW-mg*2,7,'F');
        doc.setFont('helvetica','bold');doc.setFontSize(5.5);doc.setTextColor(90,16,32);
        doc.text('Total: '+allCass.length+' plis  |  '+new Set(allCass.map(d=>d.panRef)).size+' panneaux  |  Surface: '+allCass.reduce((a,d)=>a+d.L*d.dev/1e6,0).toFixed(2)+' m m2  |  ML: '+allCass.reduce((a,d)=>a+d.L/1000,0).toFixed(2)+' ml',PW/2,38.5,{align:'center'});

        // Tables per side
        let ty=45;
        sideInfo.filter(si=>bySide[si.key].length>0).forEach(si=>{
          const items=bySide[si.key];
          // Side header
          if(ty>PH-25){doc.addPage('a4','landscape');ty=15;}
          doc.setFillColor(...si.color);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.12}));
          doc.rect(mg,ty,PW-mg*2,5,'F');doc.restoreGraphicsState();
          doc.setFont('helvetica','bold');doc.setFontSize(5.5);doc.setTextColor(...si.color);
          doc.text(si.icon+' '+si.label+' ('+items.length+')',mg+3,ty+3.5);
          ty+=7;

          // Column headers
          const cols=[{l:'Panneau',w:22},{l:'Ouverture',w:35},{l:'Zone',w:30},{l:'Cote',w:22},{l:'Long. (mm)',w:22},{l:'Retour',w:20},{l:'Face vis.',w:18},{l:'Dev. (mm)',w:22},{l:'Surface (m2)',w:25}];
          let cx=mg+2;
          doc.setFillColor(60,60,70);doc.rect(mg,ty,PW-mg*2,4.5,'F');
          doc.setFont('helvetica','bold');doc.setFontSize(4);doc.setTextColor(255,255,255);
          cols.forEach(c=>{doc.text(c.l,cx+c.w/2,ty+3,{align:'center'});cx+=c.w});
          ty+=5.5;

          // Rows
          items.forEach((d,ri)=>{
            if(ty>PH-12){doc.addPage('a4','landscape');ty=15;}
            const alt=ri%2===0;
            doc.setFillColor(alt?252:245,alt?250:242,alt?248:235);doc.rect(mg,ty,PW-mg*2,4,'F');
            doc.setFont('courier','normal');doc.setFontSize(4);doc.setTextColor(40,40,50);
            cx=mg+2;
            const sideLabel=d.side==='tG'?'Tab. G':d.side==='tD'?'Tab. D':d.side==='lin'?'Linteau':'Appui';
            const retour=d.dev-50-10;// dev = panDim + retour + fv + 10
            const vals=[d.panRef,d.ouvName||'-',d.zone||'-',sideLabel,String(d.L),String(retour>0?retour:'-'),'50',String(d.dev),(d.L*d.dev/1e6).toFixed(3)];
            vals.forEach((v,vi)=>{
              doc.setFont('courier',vi===0?'bold':'normal');
              if(vi===0)doc.setTextColor(...si.color);else doc.setTextColor(40,40,50);
              doc.text(v,cx+cols[vi].w/2,ty+2.8,{align:'center'});cx+=cols[vi].w;
            });
            ty+=4.5;
          });
          // Subtotal
          doc.setFillColor(240,235,225);doc.rect(mg,ty,PW-mg*2,4.5,'F');
          doc.setFont('helvetica','bold');doc.setFontSize(4.5);doc.setTextColor(...si.color);
          doc.text('Sous-total: '+items.length+' plis',mg+5,ty+3);
          doc.text(items.reduce((a,d)=>a+d.L/1000,0).toFixed(2)+' ml',mg+80,ty+3);
          doc.text(items.reduce((a,d)=>a+d.L*d.dev/1e6,0).toFixed(3)+' m m2',mg+130,ty+3);
          ty+=8;
        });
      }
    }

    // ═══ PAGE REPÉRAGE CASSETTES PLIÉES ═══
    if(showCass){
      selZones.forEach(zi=>{
        const z=zones[zi],zC=allCalcs[zi];if(!zC)return;
        const impPans=(zC.activePanels||[]).filter(p=>p.isImpacted&&p.adjSides&&p.adjSides.length>0);
        if(impPans.length===0)return;
        doc.addPage('a4','landscape');
        const rc=s=>[parseInt(s.slice(1,3),16)||100,parseInt(s.slice(3,5),16)||100,parseInt(s.slice(5,7),16)||200];
        // Header
        doc.setFillColor(60,20,80);doc.rect(0,0,PW,11,'F');
        doc.setFont('helvetica','bold');doc.setFontSize(9);doc.setTextColor(255,255,255);
        doc.text('REPERAGE CASSETTES PLIEES  -  '+z.name.toUpperCase(),PW/2,7,{align:'center'});
        doc.setFontSize(4.5);doc.setFont('helvetica','normal');doc.setTextColor(200,190,210);
        doc.text(projectName+' | '+dateStr+' | '+(z.L/1000).toFixed(2)+'x'+(z.H/1000).toFixed(2)+' m',PW/2,10,{align:'center'});

        // Draw facade
        const fMg=12;const avW=PW*0.65-fMg*2,avH=PH-20-fMg*2;
        const fAsp=z.L/z.H;let fW,fH;
        if(fAsp>avW/avH){fW=avW;fH=fW/fAsp}else{fH=avH;fW=fH*fAsp}
        const fX=fMg+(avW-fW)/2,fY=16+(avH-fH)/2;
        const sc=fW/(z.L/1000);

        // Background
        doc.setFillColor(248,248,252);doc.rect(fX-1,fY-1,fW+2,fH+2,'F');
        doc.setDrawColor(200,200,210);doc.setLineWidth(.15);doc.rect(fX,fY,fW,fH);

        // Side colors
        const sideColors={tG:[245,158,11],tD:[59,130,246],lin:[139,92,246],app:[16,185,129]};
        const sideLabels={tG:'Tab.G',tD:'Tab.D',lin:'Lint.',app:'Appui'};

        // Draw all panels (light gray)
        doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.08}));
        zC.panelMap.forEach(pm=>{
          if(pm.isVoid)return;
          const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc,pw=pm.pWa*sc,ph=pm.pHa*sc;
          if(pw<.1||ph<.1)return;
          doc.setFillColor(180,180,190);doc.rect(px,py,pw,ph,'F');
        });
        doc.restoreGraphicsState();

        // Openings
        zC.panelMap.forEach(pm=>{
          if(!pm.isVoid)return;
          const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc,pw=pm.pWa*sc,ph=pm.pHa*sc;
          doc.setFillColor(30,30,40);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.15}));
          doc.rect(px,py,pw,ph,'F');doc.restoreGraphicsState();
        });

        // Highlight impacted panels with side colors
        impPans.forEach(pm=>{
          const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc,pw=pm.pWa*sc,ph=pm.pHa*sc;
          // Get dominant side color
          const mainSide=pm.adjSides[0]?.side||'tG';
          const col=sideColors[mainSide]||[200,200,200];

          // Fill panel with side color
          doc.setFillColor(...col);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.25}));
          doc.rect(px,py,pw,ph,'F');doc.restoreGraphicsState();
          doc.setDrawColor(...col);doc.setLineWidth(.4);doc.rect(px,py,pw,ph);

          // Draw fold direction arrows on sides
          pm.adjSides.forEach(s=>{
            const sc2=sideColors[s.side]||col;
            doc.setDrawColor(...sc2);doc.setLineWidth(.6);
            if(s.side==='tG'){doc.line(px,py,px,py+ph)}
            else if(s.side==='tD'){doc.line(px+pw,py,px+pw,py+ph)}
            else if(s.side==='lin'){doc.line(px,py,px+pw,py)}
            else if(s.side==='app'){doc.line(px,py+ph,px+pw,py+ph)}
          });

          // Panel ref label
          doc.setFont('courier','bold');doc.setFontSize(pw>5&&ph>4?3.5:2.5);doc.setTextColor(...col);
          doc.text(pm.subRef,px+pw/2,py+ph/2-0.5,{align:'center'});
          // Side labels
          doc.setFont('helvetica','normal');doc.setFontSize(2);doc.setTextColor(80,80,90);
          const sides=pm.adjSides.map(s=>sideLabels[s.side]).join('+');
          doc.text(sides,px+pw/2,py+ph/2+1.8,{align:'center'});
        });

        // Panel grid lines
        doc.setDrawColor(200,200,210);doc.setLineWidth(.08);
        zC.panelMap.forEach(pm=>{
          if(pm.isVoid)return;
          const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc,pw=pm.pWa*sc,ph=pm.pHa*sc;
          doc.rect(px,py,pw,ph);
        });

        // Dimensions
        doc.setFont('helvetica','normal');doc.setFontSize(3.5);doc.setTextColor(100,100,110);
        doc.text((z.L/1000).toFixed(2)+' m',fX+fW/2,fY+fH+5,{align:'center'});
        doc.text((z.H/1000).toFixed(2)+' m',fX-5,fY+fH/2,{angle:90,align:'center'});

        // Legend panel (right side)
        const lgX=PW*0.68,lgY=16,lgW=PW-lgX-mg;
        doc.setFillColor(250,248,252);doc.rect(lgX,lgY,lgW,PH-lgY-mg,'F');
        doc.setDrawColor(200,195,210);doc.setLineWidth(.15);doc.rect(lgX,lgY,lgW,PH-lgY-mg);

        doc.setFont('helvetica','bold');doc.setFontSize(5.5);doc.setTextColor(60,20,80);
        doc.text('LEGENDE',lgX+lgW/2,lgY+5,{align:'center'});

        // Side legend items
        let ly=lgY+10;
        [{key:'tG',label:'Tableau Gauche',icon:'<'},{key:'tD',label:'Tableau Droit',icon:'>'},{key:'lin',label:'Linteau',icon:'^'},{key:'app',label:'Appui',icon:'v'}].forEach(si=>{
          const col=sideColors[si.key];const cnt=impPans.filter(p=>p.adjSides.some(s=>s.side===si.key)).length;
          doc.setFillColor(...col);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.2}));
          doc.rect(lgX+3,ly,lgW-6,5,'F');doc.restoreGraphicsState();
          doc.setDrawColor(...col);doc.setLineWidth(.25);doc.rect(lgX+3,ly,lgW-6,5);
          doc.setFont('helvetica','bold');doc.setFontSize(4);doc.setTextColor(...col);
          doc.text(si.icon+' '+si.label,lgX+6,ly+3.3);
          doc.text(cnt+' pan.',lgX+lgW-5,ly+3.3,{align:'right'});
          ly+=7;
        });

        // Stats
        ly+=3;
        doc.setDrawColor(180,170,190);doc.setLineWidth(.1);doc.line(lgX+5,ly,lgX+lgW-5,ly);ly+=4;
        doc.setFont('helvetica','bold');doc.setFontSize(4.5);doc.setTextColor(60,20,80);
        doc.text('RESUME',lgX+lgW/2,ly,{align:'center'});ly+=5;
        const stats=[
          ['Panneaux plies',impPans.length+' u'],
          ['Total plis',impPans.reduce((a,p)=>a+p.adjSides.length,0)+' pcs'],
          ['Surface cass.',zC.totCassettes?zC.totCassettes.surfTot.toFixed(2)+' m2':'-'],
          ['ML total',zC.totCassettes?zC.totCassettes.mlTot.toFixed(2)+' ml':'-']
        ];
        stats.forEach(([label,val])=>{
          doc.setFont('helvetica','normal');doc.setFontSize(3.8);doc.setTextColor(80,70,90);
          doc.text(label,lgX+5,ly);
          doc.setFont('courier','bold');doc.setTextColor(60,20,80);
          doc.text(val,lgX+lgW-5,ly,{align:'right'});
          ly+=4.5;
        });

        // Detail table
        ly+=3;
        doc.setFont('helvetica','bold');doc.setFontSize(4);doc.setTextColor(60,20,80);
        doc.text('DETAIL PAR PANNEAU',lgX+lgW/2,ly,{align:'center'});ly+=4;

        impPans.forEach(pm=>{
          if(ly>PH-mg-8)return;// skip if no space
          const mainCol=sideColors[pm.adjSides[0]?.side||'tG']||[100,100,100];
          doc.setFillColor(...mainCol);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.08}));
          doc.rect(lgX+3,ly-1,lgW-6,pm.adjSides.length*3.5+3.5,'F');doc.restoreGraphicsState();
          doc.setFont('courier','bold');doc.setFontSize(3.5);doc.setTextColor(...mainCol);
          doc.text(pm.subRef,lgX+5,ly+1.5);
          doc.setFont('helvetica','normal');doc.setFontSize(3);doc.setTextColor(100,90,110);
          doc.text(Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000)+' mm',lgX+lgW-5,ly+1.5,{align:'right'});
          ly+=3.5;
          pm.adjSides.forEach(s=>{
            const sc2=sideColors[s.side]||[150,150,150];
            doc.setFillColor(...sc2);doc.rect(lgX+6,ly-0.5,1.5,1.5,'F');
            doc.setFont('helvetica','normal');doc.setFontSize(2.8);doc.setTextColor(70,70,80);
            doc.text(sideLabels[s.side]+': ret '+s.retour+'mm, dev '+s.devRetour+'mm',lgX+9,ly+0.8);
            ly+=3.5;
          });
          ly+=1;
        });
      });
    }

    // (single page per zone — no extra pages)
        doc.save('Calepinage_'+projectName.replace(/\W/g,'_')+'.pdf');
  };


  const ppMmZ=pxPerMm_eff*zoom;
  const ZoneView=({z,zCalc,isActive,idx})=>{
    if(!z||!zCalc)return null;
    const ox=z.facOrigin.x*zoom+pan.x,oy=z.facOrigin.y*zoom+pan.y;
    const fWpx=z.L*pxPerMm_eff*zoom,fHpx=z.H*pxPerMm_eff*zoom;
    const ppZ=pxPerMm_eff*zoom;const montSp=z.oss.eM*ppZ,lissSp=z.oss.eL*ppZ;
    const zColor=ZONE_COLORS[idx%8];
    const clipId=`fc-${z.id}`;

    // Polygon or rect clip
    const ClipShape=()=>z.poly?
      <clipPath id={clipId}><path d={polyToPath(z.poly,ppZ,0,0)}/></clipPath>:
      <clipPath id={clipId}><rect width={fWpx} height={fHpx} rx="2"/></clipPath>;

    const rotDeg=z.rot||0;
    const cx=fWpx/2,cy=fHpx/2;
    return(
      <g transform={`translate(${ox},${oy})${rotDeg?` rotate(${rotDeg},${cx},${cy})`:''}`} opacity={isActive?1:.35}>
        <defs><ClipShape/></defs>
        {/* Shadow + fill */}
        {z.poly?<path d={polyToPath(z.poly,ppZ,4,4)} fill="#000" opacity=".08"/>:
          <rect x={4} y={4} width={fWpx} height={fHpx} fill="#000" rx="3" opacity=".08"/>}
        {z.poly?<path d={polyToPath(z.poly,ppZ,0,0)} fill="rgba(255,252,248,.6)" stroke={isActive?zColor:'#444'} strokeWidth={isActive?2:1}/>:
          <rect width={fWpx} height={fHpx} fill="rgba(255,252,248,.6)" stroke={isActive?zColor:'#444'} strokeWidth={isActive?2:1} rx="2"/>}
        {/* BG image */}
        {bgSrc&&bgVis&&<image href={bgSrc} x={-z.facOrigin.x*zoom} y={-z.facOrigin.y*zoom} width={bgW*zoom} height={bgH*zoom} opacity={bgOp} clipPath={`url(#${clipId})`}/>}
        {/* Panels — sub-panels with RAL colors */}
        {isActive&&<g clipPath={`url(#${clipId})`}>{zCalc.panelMap.map((pm,pi)=>{
          const px=pm.pLeft*1000*ppZ,py=pm.pTop*1000*ppZ,pw=pm.pWa*1000*ppZ,ph=pm.pHa*1000*ppZ;
          if(pw<1||ph<1)return null;
          const ralColor=RAL_COLORS[az.ralIdx??ralIdx]?.hex||'#383E42';
          if(pm.isVoid){
            // Void cell (inside opening) - show as empty/hatched
            return<g key={`p${pm.col}-${pm.row}`}>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="rgba(0,0,0,.3)" stroke="rgba(251,113,133,.15)" strokeWidth=".3" rx="1"/>
            </g>
          }
          const isImp=pm.isImpacted;
          const isEditing=editPanel&&editPanel.col===pm.col&&editPanel.row===pm.row;
          const panW=Math.round(pm.pWa*1000),panH=Math.round(pm.pHa*1000);
          return<g key={`p${pm.col}-${pm.row}`} style={{cursor:'pointer'}}
            onMouseDown={e=>{
              if(e.button===0&&!modeDraw&&!measureMode)e.stopPropagation();// Let draw/measure pass through
              if(mergeSrc&&e.button===0){e.stopPropagation();
                e.preventDefault();
                if(mergeSrc.parentCol===-1){setMergeSrc({parentCol:pm.parentCol,parentRow:pm.parentRow});return}
                const s=mergeSrc,t={parentCol:pm.parentCol,parentRow:pm.parentRow};
                if(s.parentCol===t.parentCol&&s.parentRow===t.parentRow){setMergeSrc(null);return}
                const c1=Math.min(s.parentCol,t.parentCol),r1=Math.min(s.parentRow,t.parentRow);
                const c2=Math.max(s.parentCol,t.parentCol),r2=Math.max(s.parentRow,t.parentRow);
                updateAZ(z=>{
                  let ms=(z.merges||[]).filter(m=>!(m.c1>=c1&&m.r1>=r1&&m.c2<=c2&&m.r2<=r2));
                  ms=ms.filter(m=>{for(let cc=c1;cc<=c2;cc++)for(let rr=r1;rr<=r2;rr++){if(cc>=m.c1&&cc<=m.c2&&rr>=m.r1&&rr<=m.r2)return false}return true});
                  ms.push({c1,r1,c2,r2});return{...z,merges:ms}});
                setMergeSrc(null);setEditPanel(null);return;
              }
            }}
            onClick={e=>{e.stopPropagation();
              if(mergeSrc)return;
              // Exclude mode: toggle exclusion on panel click
              if(excludeMode){
                const already=(az.exclusions||[]).some(ex=>ex.col===pm.parentCol&&ex.row===pm.parentRow);
                if(already){
                  updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter(ex=>!(ex.col===pm.parentCol&&ex.row===pm.parentRow))}));
                }else{
                  updateAZ(z=>({...z,exclusions:[...(z.exclusions||[]),{col:pm.parentCol,row:pm.parentRow,depth:excludeDepth}]}));
                }
                return;
              }
              const rect=cvRef.current.getBoundingClientRect();
              setEditPanel({col:pm.col,row:pm.row,parentCol:pm.parentCol,parentRow:pm.parentRow,screenX:e.clientX-rect.left,screenY:e.clientY-rect.top,panW,panH,pLeft:pm.pLeft,pTop:pm.pTop})}}>
            <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1}
              fill={mergeSrc&&mergeSrc.parentCol===pm.parentCol&&mergeSrc.parentRow===pm.parentRow?'rgba(139,92,246,.5)':isEditing?'rgba(79,110,247,.3)':ralColor} fillOpacity={mergeSrc?0.95:isEditing?1:.88}
              stroke={isEditing?'var(--bl)':isImp?'rgba(251,191,36,.8)':pm.polyEdge?'rgba(34,211,238,.6)':'rgba(255,255,255,.2)'}
              strokeWidth={isEditing?2.5:isImp?1.2:.5} rx="1"
              opacity={isEditing?1:.85}/>
            {/* Panel ref label */}
            {pw>14&&ph>10&&<text x={px+3} y={py+9} fontSize={Math.min(7,pw/6,ph/3)} fontWeight="700" fontFamily="JetBrains Mono"
              fill="rgba(255,255,255,.85)" style={{pointerEvents:'none'}}>{pm.subRef}</text>}
            {/* Dimensions */}
            {pw>45&&ph>22&&<text x={px+pw/2} y={py+ph/2+2} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(7,pw/8,ph/3.5)} fontWeight="500" fontFamily="JetBrains Mono"
              fill="rgba(255,255,255,.6)" style={{pointerEvents:'none'}}>{panW}×{panH}</text>}
            {/* Impacted marker */}
            {isImp&&pw>20&&ph>14&&<text x={px+pw-3} y={py+9} textAnchor="end" fontSize={Math.min(7,pw/7)}
              fill="rgba(251,191,36,.9)" fontWeight="700" style={{pointerEvents:'none'}}>✂</text>}
            {/* Merged indicator */}
            {pm.isMerged&&<><rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="none"
              stroke="rgba(139,92,246,.6)" strokeWidth="2" strokeDasharray="4,2" rx="1" style={{pointerEvents:'none'}}/>
              {pw>25&&ph>20&&<text x={px+pw-3} y={py+ph-4} textAnchor="end" fontSize="7"
                fill="rgba(139,92,246,.8)" fontWeight="700" style={{pointerEvents:'none'}}>⊞</text>}</>}
            {/* Excluded panel - red hatching */}
            {pm.isExcluded&&<>
              <defs><pattern id={`hatch-${pm.col}-${pm.row}`} width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                <line x1="0" y1="0" x2="0" y2="8" stroke="rgba(190,18,60,.5)" strokeWidth="2"/></pattern></defs>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill={`url(#hatch-${pm.col}-${pm.row})`} rx="1" style={{pointerEvents:'none'}}/>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="none"
                stroke="rgba(190,18,60,.8)" strokeWidth="2.5" strokeDasharray="6,3" rx="1" style={{pointerEvents:'none'}}/>
              {pw>25&&ph>20&&<text x={px+pw/2} y={py+ph/2} textAnchor="middle" dominantBaseline="middle" fontSize="11"
                fill="rgba(190,18,60,.9)" fontWeight="700" style={{pointerEvents:'none'}}>🚫</text>}
              {pw>35&&ph>30&&pm.exclusionDepth&&<text x={px+pw/2} y={py+ph/2+12} textAnchor="middle" dominantBaseline="middle" fontSize="7"
                fill="rgba(190,18,60,.7)" fontWeight="600" style={{pointerEvents:'none'}}>Balcon {pm.exclusionDepth}mm</text>}
            </>}
          </g>})}</g>}
        {/* Ossature: montants + lisses interrupted around openings */}
        {isActive&&<g clipPath={`url(#${clipId})`} style={{pointerEvents:'none'}}>
          {Array.from({length:Math.floor(z.L/z.oss.eM)+1}).map((_,i)=>{
            const mxMm=i*z.oss.eM;if(mxMm>z.L)return null;const mxPx=mxMm*ppZ;
            let segs=[{y1:0,y2:z.H}];
            z.ouvs.forEach(o=>{const oL=o.x,oR=o.x+o.w,oT=o.y,oB=o.y+o.h;
              if(mxMm<oL+1||mxMm>oR-1)return;
              const ns=[];segs.forEach(s=>{if(oT>=s.y2||oB<=s.y1){ns.push(s);return}
                if(s.y1<oT)ns.push({y1:s.y1,y2:oT});if(oB<s.y2)ns.push({y1:oB,y2:s.y2})});segs=ns;});
            return<g key={`m${i}`}>{segs.map((s,si)=>
              <line key={si} x1={mxPx} y1={s.y1*ppZ} x2={mxPx} y2={s.y2*ppZ}
                stroke="rgba(245,158,11,.55)" strokeWidth="1.5" strokeDasharray="5,3"/>)}
              {mxPx>10&&mxPx<fWpx-10&&<text x={mxPx+2} y={10} fontSize="6" fill="rgba(245,158,11,.35)" fontFamily="JetBrains Mono" fontWeight="700">M</text>}
            </g>})}
          {Array.from({length:Math.floor(z.H/z.oss.eL)+1}).map((_,i)=>{
            const lyMm=i*z.oss.eL;if(lyMm>z.H)return null;const lyPx=lyMm*ppZ;
            let segs=[{x1:0,x2:z.L}];
            z.ouvs.forEach(o=>{const oL=o.x,oR=o.x+o.w,oT=o.y,oB=o.y+o.h;
              if(lyMm<oT+1||lyMm>oB-1)return;
              const ns=[];segs.forEach(s=>{if(oL>=s.x2||oR<=s.x1){ns.push(s);return}
                if(s.x1<oL)ns.push({x1:s.x1,x2:oL});if(oR<s.x2)ns.push({x1:oR,x2:s.x2})});segs=ns;});
            return<g key={`l${i}`}>{segs.map((s,si)=>
              <line key={si} x1={s.x1*ppZ} y1={lyPx} x2={s.x2*ppZ} y2={lyPx}
                stroke="rgba(52,211,153,.45)" strokeWidth="1.5" strokeDasharray="5,3"/>)}
              {lyPx>10&&lyPx<fHpx-10&&<text x={2} y={lyPx+10} fontSize="6" fill="rgba(52,211,153,.3)" fontFamily="JetBrains Mono" fontWeight="700">L</text>}
            </g>})}
          {/* Chassis frames around openings */}
          {z.ouvs.map((o,oi)=><rect key={`ch${oi}`} x={o.x*ppZ} y={o.y*ppZ} width={o.w*ppZ} height={o.h*ppZ}
            fill="none" stroke="rgba(180,180,180,.4)" strokeWidth="2.5" rx="1"/>)}
        </g>}
        {/* Retours d'encadrements — cadre autour ouvertures (face visible sur facade) */}
        {isActive&&z.ouvs.map((o,oi)=>{
          const r=o.retours||{tG:150,tD:150,lin:150,app:150};
          const fv=o.faceVis||50;
          const ox=o.x*ppZ,oy=o.y*ppZ,ow=o.w*ppZ,oh=o.h*ppZ;
          const rScale=ppZ;
          const fvPx=fv*rScale;
          const tGpx=r.tG*rScale,tDpx=r.tD*rScale,linPx=r.lin*rScale,appPx=r.app*rScale;
          if(fvPx<0.3)return null;
          return<g key={`ret${oi}`} style={{pointerEvents:'none'}}>
            {/* Tableau Gauche — bande violette à GAUCHE de l'ouverture */}
            {r.tG>0&&<><rect x={ox-fvPx} y={oy} width={fvPx} height={oh}
              fill="rgba(139,92,246,.3)" stroke="rgba(139,92,246,.8)" strokeWidth="1.2"/>
              {fvPx>3&&oh>20&&<text x={ox-fvPx/2} y={oy+oh/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(139,92,246,.9)" fontFamily="JetBrains Mono" fontWeight="700"
                transform={`rotate(-90,${ox-fvPx/2},${oy+oh/2})`}>TG {r.tG}</text>}</>}
            {/* Tableau Droit — bande violette à DROITE de l'ouverture */}
            {r.tD>0&&<><rect x={ox+ow} y={oy} width={fvPx} height={oh}
              fill="rgba(139,92,246,.3)" stroke="rgba(139,92,246,.8)" strokeWidth="1.2"/>
              {fvPx>3&&oh>20&&<text x={ox+ow+fvPx/2} y={oy+oh/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(139,92,246,.9)" fontFamily="JetBrains Mono" fontWeight="700"
                transform={`rotate(90,${ox+ow+fvPx/2},${oy+oh/2})`}>TD {r.tD}</text>}</>}
            {/* Linteau — bande cyan AU-DESSUS de l'ouverture */}
            {r.lin>0&&<><rect x={ox-fvPx} y={oy-fvPx} width={ow+fvPx*2} height={fvPx}
              fill="rgba(34,211,238,.25)" stroke="rgba(34,211,238,.8)" strokeWidth="1.2"/>
              {fvPx>3&&ow>30&&<text x={ox+ow/2} y={oy-fvPx/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(34,211,238,.9)" fontFamily="JetBrains Mono" fontWeight="700">LIN {r.lin}</text>}</>}
            {/* Appui — bande verte EN-DESSOUS de l'ouverture */}
            {r.app>0&&<><rect x={ox-fvPx} y={oy+oh} width={ow+fvPx*2} height={fvPx}
              fill="rgba(52,211,153,.25)" stroke="rgba(52,211,153,.8)" strokeWidth="1.2"/>
              {fvPx>3&&ow>30&&<text x={ox+ow/2} y={oy+oh+fvPx/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(52,211,153,.9)" fontFamily="JetBrains Mono" fontWeight="700">APP {r.app}</text>}</>}
            {/* Corner markers */}
            {fvPx>2&&<>
              <rect x={ox-fvPx} y={oy-fvPx} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox+ow} y={oy-fvPx} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox-fvPx} y={oy+oh} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox+ow} y={oy+oh} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
            </>}
          </g>})}

        {/* Ouvertures */}
        {z.ouvs.map((o,oi)=>{const oox=o.x*ppZ,ooy=o.y*ppZ,oow=o.w*ppZ,ooh=o.h*ppZ;const sel=selId===o.id&&isActive;const multiSel=selIds.has(o.id)&&isActive;
          return<g key={o.id}>
            {/* Opening background — darker to stand out */}
            <rect x={oox} y={ooy} width={oow} height={ooh} fill={multiSel?'rgba(79,110,247,.25)':sel?'rgba(251,113,133,.3)':'rgba(251,113,133,.18)'}
              stroke={multiSel?'var(--bl)':sel?'var(--rs)':'rgba(251,113,133,.8)'} strokeWidth={multiSel||sel?3:2} rx="2" style={{cursor:isActive?'move':'pointer'}}
              onMouseDown={isActive?e=>handleOuvDown(e,o,'move'):undefined}/>
            {/* Cross hatch for opening */}
            {oow>20&&ooh>20&&<g opacity=".15" style={{pointerEvents:'none'}}><line x1={oox} y1={ooy} x2={oox+oow} y2={ooy+ooh} stroke="var(--rs)" strokeWidth="1"/>
              <line x1={oox+oow} y1={ooy} x2={oox} y2={ooy+ooh} stroke="var(--rs)" strokeWidth="1"/></g>}
            {/* Label */}
            {oow>40&&ooh>20&&<text x={oox+oow/2} y={ooy+ooh/2} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(12,oow/5)} fontWeight="700" fill="var(--rs)" fontFamily="JetBrains Mono" style={{pointerEvents:'none'}}>{o.t||'O'}{oi+1}</text>}
            {oow>60&&ooh>35&&<text x={oox+oow/2} y={ooy+ooh/2+Math.min(12,oow/5)*0.8} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(9,oow/8)} fontWeight="500" fill="rgba(251,113,133,.6)" fontFamily="JetBrains Mono" style={{pointerEvents:'none'}}>{o.w}×{o.h}</text>}
            {sel&&['nw','ne','se','sw','n','s','e','w'].map(d=>{
              const cx=d.includes('w')?oox:d.includes('e')?oox+oow:oox+oow/2;
              const cy=d.includes('n')?ooy:d.includes('s')?ooy+ooh:ooy+ooh/2;
              return<circle key={d} cx={cx} cy={cy} r="5" fill="var(--rs)" stroke="var(--pnl)" strokeWidth="2"
                style={{cursor:d.length===2?d+'-resize':d==='n'||d==='s'?'ns-resize':'ew-resize'}}
                onMouseDown={e=>handleOuvDown(e,o,`r-${d}`)}/>;
            })}</g>})}
        {/* Clickable individual joints — between BASE grid panels */}
        {isActive&&zCalc.baseXBounds&&zCalc.baseXBounds.length>2&&<g clipPath={`url(#${clipId})`}>
          {zCalc.baseXBounds.slice(1,-1).map((bx,i)=>{
            const gw=(zCalc.jGapsH[i]||0)/1000*1000*ppZ;
            const gx=bx*1000*ppZ;
            const isCustom=(az.jointsH||[])[i]!=null;
            const vis=Math.max(gw,8);
            // Check if this joint is inside a merged panel (should be hidden)
            const isInsideMerge=(az.merges||[]).some(m=>{
              // Joint i is between col i and i+1
              // Hidden if BOTH cols are in same merge
              return i>=m.c1 && i<m.c2;  // col i and i+1 are both in [c1, c2]
            });
            if(isInsideMerge)return null;  // Hide joint between merged cells
            return<g key={`jh${i}`}>
              <rect x={gx-vis/2+gw/2} y={0} width={vis} height={fHpx}
                fill={isCustom?'rgba(251,191,36,.45)':gw>0.3?'rgba(251,191,36,.25)':'rgba(251,191,36,.08)'}
                stroke={isCustom?'rgba(251,191,36,.95)':gw>0.3?'rgba(251,191,36,.6)':'rgba(251,191,36,.2)'} strokeWidth={isCustom?2:.8}
                style={{cursor:'col-resize'}} rx="2"
                onMouseDown={e=>e.stopPropagation()}
                onClick={e=>{e.stopPropagation();
                  const cur=(az.jointsH||[])[i]!=null?(az.jointsH)[i]:(az.jointH||0);
                  const v=prompt(`Joint vertical #${i+1}\n(entre col ${i+1} et ${i+2})\n\nÉpaisseur en mm :`,cur);
                  if(v===null)return;const n=parseFloat(v);if(isNaN(n))return;
                  updateAZ(z=>{const jh=[...(z.jointsH||[])];while(jh.length<=i)jh.push(null);jh[i]=n;return{...z,jointsH:jh}})}}/>
              {vis>12&&<text x={gx} y={fHpx/2} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="600" fill="rgba(251,191,36,.9)" style={{pointerEvents:'none'}}>↔</text>}
            </g>})}
          {zCalc.baseYBounds&&zCalc.baseYBounds.slice(1,-1).map((by,i)=>{
            const gh=(zCalc.jGapsV[i]||0)/1000*1000*ppZ;
            const gy=by*1000*ppZ;
            const isCustom=(az.jointsV||[])[i]!=null;
            const vis=Math.max(gh,8);
            // Check if this joint is inside a merged panel (should be hidden)
            const isInsideMerge=(az.merges||[]).some(m=>{
              // Joint i is between row i and i+1
              // Hidden if BOTH rows are in same merge
              return i>=m.r1 && i<m.r2;  // row i and i+1 are both in [r1, r2]
            });
            if(isInsideMerge)return null;  // Hide joint between merged cells
            return<g key={`jv${i}`}>
              <rect x={0} y={gy-vis/2+gh/2} width={fWpx} height={vis}
                fill={isCustom?'rgba(251,191,36,.45)':gh>0.3?'rgba(251,191,36,.25)':'rgba(251,191,36,.08)'}
                stroke={isCustom?'rgba(251,191,36,.95)':gh>0.3?'rgba(251,191,36,.6)':'rgba(251,191,36,.2)'} strokeWidth={isCustom?2:.8}
                style={{cursor:'row-resize'}} rx="2"
                onMouseDown={e=>e.stopPropagation()}
                onClick={e=>{e.stopPropagation();
                  const cur=(az.jointsV||[])[i]!=null?(az.jointsV)[i]:(az.jointV||0);
                  const v=prompt(`Joint horizontal #${i+1}\n(entre ligne ${i+1} et ${i+2})\n\nÉpaisseur en mm :`,cur);
                  if(v===null)return;const n=parseFloat(v);if(isNaN(n))return;
                  updateAZ(z=>{const jv=[...(z.jointsV||[])];while(jv.length<=i)jv.push(null);jv[i]=n;return{...z,jointsV:jv}})}}/>
              {vis>12&&<text x={fWpx/2} y={gy} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="600" fill="rgba(251,191,36,.9)" style={{pointerEvents:'none'}}>↕</text>}
            </g>})}
        </g>}

        {/* Dims */}
        <text x={fWpx/2} y={-8} textAnchor="middle" fontSize="11" fontWeight="600" fill="var(--t2)" fontFamily="JetBrains Mono">{(z.L/1000).toFixed(2)} m</text>
        <text x={-8} y={fHpx/2} textAnchor="middle" fontSize="11" fontWeight="600" fill="var(--t2)" fontFamily="JetBrains Mono"
          transform={`rotate(-90,-8,${fHpx/2})`}>{(z.H/1000).toFixed(2)} m</text>
        {/* Zone label (drag handle) */}
        <g style={{cursor:'grab'}} onMouseDown={e=>handleZoneDragStart(e,idx)} onClick={!isActive?e=>{e.stopPropagation();setActiveZoneIdx(idx)}:undefined}>
          <rect x={0} y={fHpx+4} width={Math.max(80,Math.min(fWpx,140))} height={20} rx="4" fill={zColor} opacity={isActive?1:.6}/>
          <text x={8} y={fHpx+17} fontSize="10" fontWeight="700" fill="#fff" fontFamily="DM Sans">{I.move(8)} {z.name}</text>
          {!isActive&&<text x={Math.max(80,Math.min(fWpx,140))-6} y={fHpx+16} textAnchor="end" fontSize="9" fill="rgba(255,255,255,.7)">cliquer</text>}
        </g>
        {/* Resize handles on zone */}
        {isActive&&!z.poly&&['nw','n','ne','e','se','s','sw','w'].map(h=>{
          const cx=h.includes('w')?0:h.includes('e')?fWpx:fWpx/2;
          const cy=h.includes('n')?0:h.includes('s')?fHpx:fHpx/2;
          return<rect key={h} x={cx-5} y={cy-5} width={10} height={10} rx="2.5"
            fill={zColor} stroke="#fff" strokeWidth="1.5" opacity=".85"
            style={{cursor:h.length===2?h+'-resize':h==='n'||h==='s'?'ns-resize':'ew-resize'}}
            onMouseDown={e=>{e.stopPropagation();setResizeZone({idx,handle:h,startX:e.clientX,startY:e.clientY,origOrigin:{...z.facOrigin},origL:z.L,origH:z.H})}}/>})}
        {/* Rotation handle */}
        {isActive&&!z.poly&&<g>
          <line x1={fWpx/2} y1={-8} x2={fWpx/2} y2={-22} stroke={zColor} strokeWidth="1.5" opacity=".6"/>
          <circle cx={fWpx/2} cy={-26} r={7} fill={zColor} stroke="#fff" strokeWidth="1.5" opacity=".9"
            style={{cursor:'grab'}}
            onMouseDown={e=>{e.stopPropagation();
              const rect=cvRef.current.getBoundingClientRect();
              const ccx=ox+fWpx/2,ccy=oy+fHpx/2;
              const startAngle=Math.atan2(e.clientY-rect.top-ccy,e.clientX-rect.left-ccx)*180/Math.PI;
              setRotateZone({idx,startAngle,origRot:z.rot||0})}}/>
          <text x={fWpx/2} y={-22.5} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#fff" fontWeight="700" style={{pointerEvents:'none'}}>↻</text>
          {(z.rot||0)!==0&&<text x={fWpx/2+14} y={-26} fontSize="9" fill={zColor} fontWeight="600">{(z.rot||0).toFixed(1)}°</text>}
        </g>}
      </g>);
  };

  const cursor=isPanning?.mid?'grabbing':step==='calibrate'||step==='zone'?'crosshair':step==='work'&&(modeDraw||measureMode)?'crosshair':dragZone||resizeZone||rotateZone?'grabbing':'default';
  const Instructions=()=>{
    const msgs={calibrate:'Cliquez 2 points pour calibrer la distance.',
      zone:polyMode?`Mode polygone: cliquez les sommets (${polyPts.length} pts). ${polyPts.length>=3?'Cliquez pres du 1er point pour fermer.':''}`:
        'Dessinez les zones sur le plan.',
      work:measureMode?'Mode mesure: cliquez 2 points. M: quitter | Esc: annuler'
        :modeDraw?'Dessinez l\'ouverture (min 200x200mm)'
        :'Ctrl+C/V: copier/coller ouvertures | D: dessiner | M: mesurer | Del: supprimer'};
    const msg=msgs[step];if(!msg)return null;
    return<div className="px-4 py-2 text-xs font-medium flex items-center gap-2" style={{background:polyMode?'var(--gnd)':'var(--blg)',color:polyMode?'var(--gn)':'var(--bl)',borderBottom:'1px solid var(--bd)'}}>
      <span className="w-4 h-4 rounded-full flex items-center justify-center text-[10px] font-bold" style={{background:polyMode?'var(--gn)':'var(--bl)',color:'#fff'}}>i</span>{msg}
      {step==='zone'&&<div className="ml-auto flex gap-2">

        <button onClick={()=>{setPolyMode(!polyMode);setPolyPts([])}} className={`ba px-3 py-1 rounded-lg text-[11px] font-bold ${polyMode?'text-white':'text-[var(--gn)]'}`}
          style={{background:polyMode?'var(--gn)':'transparent',border:`1px solid ${polyMode?'var(--gn)':'var(--bd)'}` }}>
          {I.pen(12)} {polyMode?'Mode polygone':'Polygone'}</button>
        {zones.length>0&&<button onClick={goToWork} className="ba px-4 py-1 rounded-lg text-[11px] font-bold text-white" style={{background:'var(--bl)'}}>
          Continuer ({zones.length})</button>}
      </div>}
    </div>;
  };

  /* ── WELCOME ── */
  const Welcome=()=>(
    <div className="h-full w-full flex items-center justify-center relative overflow-hidden" style={{background:'linear-gradient(160deg,#0a0a0f,#0e0e1a 40%,#110e18 70%,#0a0a0f)'}}>
      {/* Animated bg */}
      <div style={{position:'absolute',inset:0,overflow:'hidden',pointerEvents:'none'}}>
        <svg width="100%" height="100%" style={{opacity:.03}}>
          {Array.from({length:20}).map((_,i)=><line key={`v${i}`} x1={`${i*5.2}%`} y1="0" x2={`${i*5.2}%`} y2="100%" stroke="#c4324a" strokeWidth=".5"/>)}
          {Array.from({length:14}).map((_,i)=><line key={`h${i}`} x1="0" y1={`${i*7.5}%`} x2="100%" y2={`${i*7.5}%`} stroke="#c4324a" strokeWidth=".5"/>)}
        </svg>
        <div style={{position:'absolute',top:'15%',left:'20%',width:220,height:220,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.08),transparent 70%)',animation:'float 7s ease-in-out infinite'}}/>
        <div style={{position:'absolute',bottom:'20%',right:'15%',width:160,height:160,borderRadius:'50%',background:'radial-gradient(circle,rgba(8,145,178,.04),transparent 70%)',animation:'float 5s ease-in-out infinite 2s'}}/>
        <div style={{position:'absolute',top:'50%',left:'50%',width:400,height:400,marginTop:-200,marginLeft:-200,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.06),transparent 60%)',animation:'float 9s ease-in-out infinite 1s'}}/>
      </div>
      <div className="flex flex-col items-center" style={{maxWidth:480,width:'100%',padding:'0 32px',textAlign:'center',position:'relative',zIndex:2}}>
        {/* Logo with orbiting dots + pulse rings */}
        <div className="wc-d0 mb-8 relative" style={{width:88,height:88}}>
          <div style={{position:'absolute',inset:-8,borderRadius:'50%',border:'1.5px solid rgba(196,50,74,.15)',animation:'pulse-ring 3s cubic-bezier(.215,.61,.355,1) infinite'}}/>
          <div style={{position:'absolute',inset:-8,borderRadius:'50%',border:'1.5px solid rgba(8,145,178,.08)',animation:'pulse-ring 3s cubic-bezier(.215,.61,.355,1) infinite',animationDelay:'1s'}}/>
          <div className="wc-logo flex items-center justify-center" style={{width:88,height:88,borderRadius:22,background:'linear-gradient(135deg,#c4324a,#a0243a,#c0392b)',boxShadow:'0 8px 40px rgba(196,50,74,.3),0 0 80px rgba(196,50,74,.12)',position:'relative',zIndex:1}}>
            <svg width="42" height="42" viewBox="0 0 40 40" fill="none"><rect x="3" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".95"/><rect x="23" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="3" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="23" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".55"/></svg>
          </div>
          <div style={{position:'absolute',top:'50%',left:'50%',width:7,height:7,marginTop:-3.5,marginLeft:-3.5,borderRadius:'50%',background:'#0891b2',boxShadow:'0 0 10px #0891b2',animation:'orbit 8s linear infinite'}}/>
          <div style={{position:'absolute',top:'50%',left:'50%',width:5,height:5,marginTop:-2.5,marginLeft:-2.5,borderRadius:'50%',background:'#c4324a',boxShadow:'0 0 8px #c4324a',animation:'orbit 6s linear infinite reverse',animationDelay:'-2s'}}/>
        </div>
        <h1 className="wc-d1 text-3xl font-bold mb-2" style={{background:'linear-gradient(135deg,#f0ece6,#c4324a)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',letterSpacing:'-0.02em'}}>Kalepin</h1>
        <p className="wc-d1 text-sm mb-1.5" style={{color:'var(--t2)'}}>Calepinage, découpe & visualisation 3D</p>
        <p className="wc-d1 text-[10px] mn mb-10" style={{color:'var(--t3)'}}>v16 — PDF fournisseur • Zones ajustables • Plan transparent</p>
        <button onClick={()=>setStep('dashboard')} className="wc-d1 mb-6" style={{background:'none',border:'none',color:'var(--t3)',fontSize:11,cursor:'pointer',fontFamily:'inherit',display:'flex',alignItems:'center',gap:4}}>← Retour au dashboard</button>
        <div className="wc-d2 w-full" style={{marginBottom:24}}>
          <input ref={fileRef} type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.dxf" className="hidden" onChange={e=>{if(e.target.files[0])loadFile(e.target.files[0])}}/>
          <div className="drop p-6 flex items-center justify-center gap-5 rounded-2xl" onClick={()=>fileRef.current?.click()}
            onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])}}
            style={{background:'rgba(139,26,43,.03)',border:'2px dashed rgba(79,110,247,.2)',cursor:'pointer'}}>
            <div style={{width:48,height:48,borderRadius:14,background:'linear-gradient(135deg,rgba(139,26,43,.1),rgba(8,145,178,.06))',display:'flex',alignItems:'center',justifyContent:'center'}}>
              {I.up(28)}
            </div>
            <div className="text-left"><div className="text-sm font-semibold mb-1.5">Déposer un plan</div>
            <div className="flex gap-1.5">{['PDF','PNG','JPG','DXF'].map(t=><span key={t} className="px-2.5 py-0.5 rounded-md text-[10px] font-bold mn" style={{background:t==='DXF'?'rgba(8,145,178,.1)':'rgba(196,50,74,.12)',color:t==='DXF'?'#0891b2':'#c4324a'}}>{t}</span>)}</div></div>
          </div></div>
        <div className="wc-d3 flex items-center gap-3 mb-6 w-full"><div className="flex-1 h-px" style={{background:'var(--bd)'}}/><span className="text-[11px]" style={{color:'var(--t3)'}}>ou</span><div className="flex-1 h-px" style={{background:'var(--bd)'}}/></div>
        <button onClick={()=>setStep('dashboard')} className="wc-d3 ba w-full py-3.5 rounded-xl text-sm font-semibold mb-3"
          style={{background:'linear-gradient(135deg,rgba(79,110,247,.1),rgba(79,110,247,.05))',border:'1px solid rgba(79,110,247,.25)',color:'var(--bl)',transition:'all .3s'}}>
          ☁ Mes projets</button>
        <button onClick={startManual} className="wc-d3 ba w-full py-3.5 rounded-xl text-sm font-semibold" 
          style={{background:'linear-gradient(135deg,var(--crd),var(--crd2))',border:'1px solid var(--bd2)',color:'var(--t1)',
            backgroundSize:'200% auto',transition:'all .3s'}}>
          Saisie manuelle des dimensions</button>
        <div className="wc-d4 flex flex-wrap justify-center gap-2.5 mt-10">
          {[{c:'#0891b2',t:'DXF/PDF',i:'📐'},{c:'#c4324a',t:'Découpe',i:'✂'},{c:'#a0243a',t:'3D & RAL',i:'🧊'},{c:'#0d9488',t:'Métré',i:'📊'}].map(f=>
            <div key={f.t} className="px-3.5 py-2 rounded-xl text-center" style={{background:`color-mix(in srgb,${f.c} 8%,transparent)`,border:`1px solid color-mix(in srgb,${f.c} 15%,transparent)`}}>
              <div className="text-[10px] font-bold" style={{color:f.c}}>{f.i} {f.t}</div></div>)}
        </div>
      </div></div>);

  /* ── COUPE CASSETTE POPUP ── */
  const CoupePopup=({ouvIdx,onClose})=>{
    if(ouvIdx===null||!az)return null;
    const o=az.ouvs[ouvIdx];if(!o)return null;
    const r=o.retours||{tG:150,tD:150,lin:150,app:150};
    const fv=o.faceVis||50;
    const sides=[{key:'tG',label:'Tableau G',ret:r.tG,color:'#8b5cf6',L:o.h},
      {key:'tD',label:'Tableau D',ret:r.tD,color:'#8b5cf6',L:o.h},
      {key:'lin',label:'Linteau',ret:r.lin,color:'#0891b2',L:o.w},
      {key:'app',label:'Appui',ret:r.app,color:'#0d9488',L:o.w}];
    const upR=(key,val)=>updateAZ(z=>({...z,ouvs:z.ouvs.map((oo,i)=>i===ouvIdx?{...oo,retours:{...(oo.retours||{tG:150,tD:150,lin:150,app:150}),[key]:val}}:oo)}));
    const upFV=(val)=>updateAZ(z=>({...z,ouvs:z.ouvs.map((oo,i)=>i===ouvIdx?{...oo,faceVis:val}:oo)}));
    const drawSec=(ret,fvv,color)=>{
      const sc2=0.3,mg2=25;const retS=ret*sc2,fvS=fvv*sc2;
      const sx=mg2+15,sy=mg2+10;
      return<svg viewBox="0 0 200 110" style={{width:'100%',height:90}}>
        <rect x={sx-8} y={sy} width={10} height={retS+8} fill="#ccc" opacity="0.25" rx="1"/>
        <rect x={sx+2} y={sy} width={8} height={retS+8} fill="#f0c020" opacity="0.12"/>
        <polyline points={`${sx+fvS},${sy-3} ${sx},${sy-3} ${sx},${sy+retS} ${sx+3},${sy+retS} ${sx+3},${sy} ${sx+fvS},${sy}`}
          fill="none" stroke={color} strokeWidth="2.5" strokeLinejoin="round"/>
        <line x1={sx} y1={sy-12} x2={sx+fvS} y2={sy-12} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx} y1={sy-15} x2={sx} y2={sy-9} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx+fvS} y1={sy-15} x2={sx+fvS} y2={sy-9} stroke="#888" strokeWidth="0.4"/>
        <text x={(sx+sx+fvS)/2} y={sy-14} fontSize="7" fill="#555" textAnchor="middle" fontFamily="monospace">{fvv}</text>
        <line x1={sx-16} y1={sy} x2={sx-16} y2={sy+retS} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx-19} y1={sy} x2={sx-13} y2={sy} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx-19} y1={sy+retS} x2={sx-13} y2={sy+retS} stroke="#888" strokeWidth="0.4"/>
        <text x={sx-17} y={sy+retS/2+3} fontSize="7" fill="#555" textAnchor="middle" fontFamily="monospace" transform={`rotate(-90,${sx-17},${sy+retS/2+3})`}>{ret}</text>
        <text x={140} y={sy+retS/2} fontSize="10" fill={color} fontWeight="bold" fontFamily="monospace">Dev: {ret+fvv+10}</text>
        <text x={140} y={sy+retS/2+12} fontSize="7" fill="#999">({ret}+{fvv}+10mm pli)</text>
      </svg>
    };
    return<div className="ov" onClick={onClose}><div className="mbx" style={{maxWidth:580,minWidth:460}} onClick={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3">
        <div><div className="text-base font-bold" style={{color:'var(--t1)'}}>Coupe cassette pliée</div>
          <div className="text-xs" style={{color:'var(--t3)'}}>O{ouvIdx+1} — {o.w}x{o.h}mm</div></div>
        <button onClick={onClose} className="ba w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>x</button>
      </div>
      <div className="flex items-center gap-3 mb-3 p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
        <span className="text-[10px] font-bold" style={{color:'var(--t2)'}}>Face visible</span>
        <input type="range" className="rng flex-1" min={10} max={200} step={5} value={fv} onChange={e=>upFV(parseInt(e.target.value))}/>
        <input type="number" value={fv} onChange={e=>upFV(parseInt(e.target.value)||50)}
          className="w-14 px-2 py-1 rounded text-center text-xs mn font-bold idark" onKeyDown={e=>e.stopPropagation()}/>
        <span className="text-[9px]" style={{color:'var(--t3)'}}>mm</span>
      </div>
      <div className="grid grid-cols-2 gap-2">
        {sides.map(s=><div key={s.key} className="p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div className="flex items-center gap-2 mb-1">
            <span className="text-[10px] font-bold" style={{color:s.color}}>{s.label}</span>
            <input type="number" value={s.ret} onChange={e=>upR(s.key,parseInt(e.target.value)||0)}
              className="w-14 px-2 py-1 rounded text-center text-xs mn font-bold idark ml-auto" onKeyDown={e=>e.stopPropagation()}/>
            <span className="text-[9px]" style={{color:'var(--t3)'}}>mm</span>
          </div>
          {drawSec(s.ret,fv,s.color)}
          <div className="flex justify-between mt-1 text-[9px]">
            <span style={{color:s.color}}>L={s.L}mm</span>
            <span className="mn font-bold" style={{color:s.color}}>S={(s.L*(s.ret+fv+10)/1e6).toFixed(3)} m²</span>
          </div>
        </div>)}
      </div>
      <div className="mt-3 p-2 rounded-lg text-center" style={{background:'rgba(196,50,74,.08)',border:'1px solid rgba(196,50,74,.15)'}}>
        <span className="text-sm font-bold" style={{color:'var(--bl)'}}>Total: </span>
        <span className="mn text-sm font-bold" style={{color:'var(--bl)'}}>
          {((r.tG+fv+10)*o.h/1e6+(r.tD+fv+10)*o.h/1e6+(r.lin+fv+10)*o.w/1e6+(r.app+fv+10)*o.w/1e6).toFixed(3)} m²
        </span>
        <span className="text-xs ml-2" style={{color:'var(--t3)'}}>
          ({((r.tG+fv+10)*o.h/1e3+(r.tD+fv+10)*o.h/1e3+(r.lin+fv+10)*o.w/1e3+(r.app+fv+10)*o.w/1e3).toFixed(2)} ml dev.)
        </span>
      </div>
    </div></div>
  };

  /* ── MAIN RENDER ── */
  return(
    <div className="h-full flex flex-col">
      {/* ── LIGNE 1 : Logo + projet + outils ── */}
      <div className="flex items-center px-3 flex-shrink-0" style={{height:step==='dashboard'||step==='carrelage'||step==='brique'?0:44,borderBottom:step==='work'?'none':'1px solid var(--bd)',background:'var(--pnl)',overflow:'hidden'}}>
        <div className="flex items-center gap-2 flex-shrink-0" style={{cursor:'pointer'}} onClick={()=>{if(step!=='dashboard')setStep('dashboard')}} title="Retour au dashboard">
          <div className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'linear-gradient(135deg,#c4324a,#a0243a)'}}>
            <svg width="14" height="14" viewBox="0 0 40 40" fill="none"><rect x="3" y="3" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="23" y="3" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="3" y="23" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="23" y="23" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/></svg>
          </div><span className="font-bold text-sm">Kalepin</span></div>
        {step==='work'&&<>
          <div className="mx-2 h-5 w-px flex-shrink-0" style={{background:'var(--bd)'}}/>
          <input type="text" value={projectName} onChange={e=>setProjectName(e.target.value)} className="bg-transparent border-none outline-none text-sm font-medium flex-shrink-0" style={{color:'var(--t2)',width:130}} onKeyDown={e=>e.stopPropagation()}/>
          <div className="flex gap-1 ml-1 flex-shrink-0">
            <button onClick={()=>saveProject(false)} className="ba px-2 py-1 rounded text-[9px] font-bold"
              style={{background:saving?'rgba(52,211,153,.2)':'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)',opacity:saving?.6:1}}
              title={cloudProjId?'Sauvegarder dans le cloud':'Nouveau projet cloud'}>{saving?'⏳':'☁'} {saving?'...':'Sauver'}</button>
            <button onClick={()=>setShowProjects(true)} className="ba px-2 py-1 rounded text-[9px] font-bold"
              style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}
              title="Mes projets cloud">📂 Projets</button>
            <div style={{position:'relative'}} className="flex-shrink-0">
              <button onClick={e=>{e.currentTarget.nextSibling.style.display=e.currentTarget.nextSibling.style.display==='block'?'none':'block'}}
                className="ba px-1.5 py-1 rounded text-[9px]" style={{border:'1px solid var(--bd)',color:'var(--t3)',background:'var(--crd)'}}>⋯</button>
              <div style={{display:'none',position:'absolute',top:'100%',left:0,marginTop:4,background:'var(--pnl)',border:'1px solid var(--bd)',borderRadius:8,padding:4,minWidth:160,boxShadow:'0 10px 30px rgba(0,0,0,.4)',zIndex:200}}>
                <button onClick={e=>{e.currentTarget.parentNode.style.display='none';saveProject(true)}} className="ba w-full text-left px-3 py-1.5 rounded text-[10px]" style={{border:'none',background:'transparent',color:'var(--t2)',cursor:'pointer',fontFamily:'inherit'}}>☁ Sauver comme nouveau</button>
                <button onClick={e=>{e.currentTarget.parentNode.style.display='none';const s={};zones.forEach((_,i)=>s[i]=true);setJsonExpSel(s);setJsonExpMod(true)}} className="ba w-full text-left px-3 py-1.5 rounded text-[10px]" style={{border:'none',background:'transparent',color:'var(--t2)',cursor:'pointer',fontFamily:'inherit'}}>💾 Exporter JSON…</button>
                <button onClick={e=>{e.currentTarget.parentNode.style.display='none';openJsonImport()}} className="ba w-full text-left px-3 py-1.5 rounded text-[10px]" style={{border:'none',background:'transparent',color:'#0ea5e9',cursor:'pointer',fontFamily:'inherit'}}>📥 Importer JSON…</button>
                <input ref={jsonImpRef} type="file" accept=".json" style={{display:'none'}} onChange={e=>{if(e.target.files[0])onJsonImpFile(e.target.files[0]);e.target.value=''}}/>
              </div>
            </div>
            {lastSaved&&<span className="text-[8px] self-center ml-1" style={{color:'var(--t3)'}}>☁ {lastSaved.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</span>}
          </div>
          {/* ── ONGLETS ── */}
          <div className="flex-1 min-w-0 mx-2 self-stretch flex items-end">
            <div className="ztab-bar border-b w-full" style={{borderColor:'var(--bd)'}}>
              {zones.map((z,i)=>(
                <div key={z.id} className={`ztab ${i===activeZoneIdx?'on':''}`}
                  style={i===activeZoneIdx?{borderColor:'var(--bd)',color:ZONE_COLORS[i%8],background:'var(--pnl)'}:{color:'var(--t2)'}}
                  onClick={()=>{if(renamingTab===i)return;
                    // Sauvegarder la vue de la zone courante
                    if(az)saveView(az.id,zoom,pan);
                    setActiveZoneIdx(i);setSelId(null);setSelIds(new Set());setShowAlignPanel(false);
                    // Restaurer la vue de la zone cible (après le setState)
                    const targetZone=zones[i];
                    setTimeout(()=>{
                      const saved=viewStatesRef.current[targetZone.id];
                      if(saved){setZoom(saved.zoom);setPan(saved.pan);}
                      else{// Première visite de cet onglet — autofit sur cette zone seule
                        if(cvRef.current){const rect=cvRef.current.getBoundingClientRect();
                          const w=targetZone.L*pxPerMm_eff,h=targetZone.H*pxPerMm_eff;
                          const nz=Math.min((rect.width-80)/w,(rect.height-80)/h,5);
                          const np={x:(rect.width-w*nz)/2-targetZone.facOrigin.x*nz+targetZone.facOrigin.x*nz,
                            y:(rect.height-h*nz)/2-targetZone.facOrigin.y*nz+targetZone.facOrigin.y*nz};
                          // Simple centering on this zone
                          const cx=targetZone.facOrigin.x*nz+np.x,cy=targetZone.facOrigin.y*nz+np.y;
                          setZoom(nz);setPan({x:rect.width/2-targetZone.facOrigin.x*nz-w*nz/2,y:rect.height/2-targetZone.facOrigin.y*nz-h*nz/2});
                        }
                      }
                    },0);
                  }}
                  onDoubleClick={()=>setRenamingTab(i)}>
                  <span className="inline-block w-2 h-2 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8],opacity:i===activeZoneIdx?1:.6}}/>
                  {renamingTab===i
                    ? <input autoFocus className="bg-transparent border-none outline-none font-semibold text-[10px]"
                        style={{color:ZONE_COLORS[i%8],width:Math.max(40,z.name.length*7)+'px'}}
                        defaultValue={z.name}
                        onBlur={e=>{updateZone(i,z=>({...z,name:e.target.value||z.name}));setRenamingTab(null)}}
                        onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'||e.key==='Escape'){e.target.blur()}}}
                        onClick={e=>e.stopPropagation()}/>
                    : <span className="truncate" style={{maxWidth:110}}>{z.name}</span>
                  }
                  {zones.length>1&&<span className="ztab-close" onClick={e=>{e.stopPropagation();
                    if(!confirm(`Supprimer la zone "${z.name}" ?`))return;
                    setZones(zs=>zs.filter((_,j)=>j!==i));
                    setActiveZoneIdx(i===0?0:Math.min(i-1,zones.length-2));
                  }}>✕</span>}
                </div>
              ))}
              <div className="ztab-add" title="Ajouter une zone (sans plan)" style={{marginBottom:1}}
                onClick={()=>{
                  const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,
                    L:3000,H:2800,facOrigin:{x:(zones.length%4)*120+40,y:(Math.floor(zones.length/4))*100+30},
                    pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},
                    ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]};
                  setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);setStep('work');setTimeout(autoFit,150);
                }}>＋</div>
            </div>
          </div>
          {/* ── OUTILS DROITE ── */}
          <div className="flex items-center gap-1.5 flex-shrink-0">
            {bgSrc&&<div className="flex items-center gap-1.5 flex-shrink-0"><label className="text-[10px] flex-shrink-0" style={{color:'var(--t3)'}}>Plan</label>
              <input type="checkbox" checked={bgVis} onChange={e=>setBgVis(e.target.checked)}/><input type="range" min="5" max="90" value={bgOp*100} onChange={e=>setBgOp(e.target.value/100)} className="rng w-12"/></div>}
            <button onClick={runOptimize} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'var(--ppd)',border:'1px solid rgba(167,139,250,.3)',color:'var(--pp)'}}>{I.opt(12)} Optimiser</button>
            <select value={snapMode} onChange={e=>setSnapMode(e.target.value)} className="idark text-[10px] px-1.5 py-1 rounded-lg flex-shrink-0" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)',width:62}}>
              <option value="free">Libre</option><option value="grid">Grille</option><option value="oss">Ossature</option>
            </select>
            {snapMode==='grid'&&<select value={gridSize} onChange={e=>setGridSize(Number(e.target.value))} className="idark text-[10px] px-1 py-1 rounded-lg flex-shrink-0" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)',width:48}}>
              {[1,5,10,25,50,100].map(v=><option key={v} value={v}>{v}mm</option>)}
            </select>}
            <button onClick={()=>{setMeasureMode(v=>!v);if(!measureMode)setModeDraw(false);setMeasurePts([])}}
              className={`ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0 ${measureMode?'apg':''}`}
              style={{background:measureMode?'rgba(245,158,11,.15)':'var(--inp)',border:`1px solid ${measureMode?'#f59e0b':'var(--bd)'}`,color:measureMode?'#f59e0b':'var(--t2)'}}>📏</button>
            {measures.length>0&&<button onClick={()=>setMeasures([])} className="text-[9px] px-1.5 py-1 rounded flex-shrink-0" style={{color:'var(--rs)'}}>✕ {measures.length}</button>}
            <button onClick={()=>setShowMasse(true)} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0"
              style={{background:'rgba(14,165,233,.1)',border:'1px solid rgba(14,165,233,.3)',color:'#0ea5e9'}}>🗺 Masse</button>
            <button onClick={()=>setMetreOpen(true)} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Métré</button>
            <button onClick={()=>setRightTab('ral')} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0"
              style={{background:rightTab==='ral'?'rgba(167,139,250,.2)':'transparent',border:`1px solid ${rightTab==='ral'?'var(--pp)':'rgba(167,139,250,.2)'}`,color:'var(--pp)'}}>
              <div style={{width:12,height:12,borderRadius:3,background:RAL_COLORS[zoneRalIdx]?.hex,border:'1px solid rgba(255,255,255,.2)'}}/>{RAL_COLORS[zoneRalIdx]?.code}</button>
            <button onClick={()=>setShow3D(v=>!v)} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0"
              style={{background:show3D?'rgba(167,139,250,.2)':'rgba(167,139,250,.08)',border:`1px solid ${show3D?'var(--pp)':'rgba(167,139,250,.25)'}`,color:'var(--pp)'}}>
              🧊 {show3D?'2D':'3D'}</button>
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setExpSel(s);setExpMod(true)}} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>{I.prn(12)} PDF</button>
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s);setXlsxExpMod(true)}} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Excel</button>
            <div className="mx-1 h-5 w-px flex-shrink-0" style={{background:'var(--bd)'}}/>
            {isAdmin&&<button onClick={()=>setStep('admin')} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(196,50,74,.12)',border:'1px solid rgba(196,50,74,.3)',color:'#c4324a'}}>⚡ Admin</button>}
            <div style={{position:'relative'}} className="flex-shrink-0">
              <button onClick={()=>setUserMenu(v=>!v)} className="ba flex items-center gap-1.5 px-2 py-1 rounded-lg" style={{background:userMenu?'var(--crd2)':'var(--crd)',border:'1px solid var(--bd)'}}>
                <div style={{width:26,height:26,borderRadius:8,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:800,color:'#fff',flexShrink:0}}>
                  {(user?.user_metadata?.full_name||user?.email||'U')[0].toUpperCase()}
                </div>
                <span style={{fontSize:11,color:'var(--t2)',maxWidth:80,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                  {user?.user_metadata?.full_name||user?.email?.split('@')[0]||'User'}
                </span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{color:'var(--t3)',transform:userMenu?'rotate(180deg)':'rotate(0)',transition:'transform .2s',flexShrink:0}}><path d="M6 9l6 6 6-6"/></svg>
              </button>
              {userMenu&&<div style={{position:'absolute',top:'calc(100% + 6px)',right:0,zIndex:200}}>
                <UserMenuPanel user={user} subStatus={subStatus} onUpgrade={()=>setShowPaywall(true)} onSettings={()=>setShowAccount(true)} onSignOut={signOut} onClose={()=>setUserMenu(false)}/>
              </div>}
            </div>
          </div>
        </>}
        {step!=='work'&&<div style={{marginLeft:'auto',position:'relative'}} className="flex-shrink-0">
          {isAdmin&&<button onClick={()=>setStep('admin')} style={{marginRight:8,padding:'5px 12px',borderRadius:8,border:'1px solid rgba(196,50,74,.3)',background:'rgba(196,50,74,.08)',color:'#c4324a',fontSize:11,fontWeight:700,cursor:'pointer',fontFamily:'inherit'}}>⚡ Admin</button>}
          <button onClick={()=>setUserMenu(v=>!v)} className="ba flex items-center gap-1.5 px-2 py-1 rounded-lg" style={{background:userMenu?'var(--crd2)':'var(--crd)',border:'1px solid var(--bd)'}}>
            <div style={{width:26,height:26,borderRadius:8,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:11,fontWeight:800,color:'#fff'}}>
              {(user?.user_metadata?.full_name||user?.email||'U')[0].toUpperCase()}
            </div>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{color:'var(--t3)',transform:userMenu?'rotate(180deg)':'rotate(0)',transition:'transform .2s'}}><path d="M6 9l6 6 6-6"/></svg>
          </button>
          {userMenu&&<div style={{position:'absolute',top:'calc(100% + 6px)',right:0,zIndex:200}}>
            <UserMenuPanel user={user} subStatus={subStatus} onUpgrade={()=>setShowPaywall(true)} onSettings={()=>setShowAccount(true)} onSignOut={signOut} onClose={()=>setUserMenu(false)}/>
          </div>}
        </div>}
      </div>
      {/* ── TRIAL BANNER ── */}
      {step==='work'&&<div style={{padding:'0 8px'}}><TrialBanner subStatus={subStatus} onUpgrade={()=>setShowPaywall(true)}/></div>}
      {/* ══ BARRE MULTI-SÉLECTION OUVERTURES ══ */}
      {step==='work'&&selIds.size>0&&az&&(()=>{
        const selOuvs=az.ouvs.filter(o=>selIds.has(o.id));
        const doAlign=(axis)=>{
          // Always work with fresh data inside updateAZ
          updateAZ(zone=>{
            const sel=zone.ouvs.filter(o=>selIds.has(o.id));
            if(sel.length<2)return zone;
            const xs=sel.map(o=>o.x),ys=sel.map(o=>o.y);
            const x2s=sel.map(o=>o.x+o.w),y2s=sel.map(o=>o.y+o.h);
            const minX=Math.min(...xs),maxX2=Math.max(...x2s);
            const minY=Math.min(...ys),maxY2=Math.max(...y2s);
            const map={};
            if(axis==='left')    sel.forEach(o=>{map[o.id]={x:minX};});
            else if(axis==='right')  sel.forEach(o=>{map[o.id]={x:maxX2-o.w};});
            else if(axis==='centerH')sel.forEach(o=>{map[o.id]={x:(minX+maxX2)/2-o.w/2};});
            else if(axis==='top')    sel.forEach(o=>{map[o.id]={y:minY};});
            else if(axis==='bottom') sel.forEach(o=>{map[o.id]={y:maxY2-o.h};});
            else if(axis==='centerV')sel.forEach(o=>{map[o.id]={y:(minY+maxY2)/2-o.h/2};});
            else if(axis==='distH'){
              const sorted=[...sel].sort((a,b)=>a.x-b.x);
              if(sorted.length<3)return zone;// need 3+ for distribution
              const totalW=sorted.reduce((a,o)=>a+o.w,0);
              const totalGap=maxX2-minX-totalW;
              const gap=totalGap/(sorted.length-1);
              let cx=sorted[0].x;
              sorted.forEach(o=>{map[o.id]={x:Math.round(cx)};cx+=o.w+gap;});
            }
            else if(axis==='distV'){
              const sorted=[...sel].sort((a,b)=>a.y-b.y);
              if(sorted.length<3)return zone;
              const totalH=sorted.reduce((a,o)=>a+o.h,0);
              const totalGap=maxY2-minY-totalH;
              const gap=totalGap/(sorted.length-1);
              let cy=sorted[0].y;
              sorted.forEach(o=>{map[o.id]={y:Math.round(cy)};cy+=o.h+gap;});
            }
            const newOuvs=zone.ouvs.map(o=>{
              if(!map[o.id])return o;
              const nx='x' in map[o.id]?Math.max(0,Math.min(map[o.id].x,zone.L-o.w)):o.x;
              const ny='y' in map[o.id]?Math.max(0,Math.min(map[o.id].y,zone.H-o.h)):o.y;
              return{...o,x:nx,y:ny};
            });
            return{...zone,ouvs:newOuvs};
          });
        };
        // SVG alignment icons
        const AlignIcon=({type})=>{
          const sq=(x,y,w=18,h=18,fill='#c4324a')=><rect x={x} y={y} width={w} height={h} rx="2" fill={fill}/>;
          const line=(x1,y1,x2,y2)=><line x1={x1} y1={y1} x2={x2} y2={y2} stroke="#c4324a" strokeWidth="2" strokeDasharray="3,2"/>;
          const s=28;
          if(type==='left')   return<svg width={s} height={s} viewBox="0 0 28 28">{line(6,2,6,26)}{sq(7,4,8,8,'#c4324a')}{sq(7,11,14,6,'rgba(139,26,43,.4)')}{sq(7,18,10,7,'rgba(139,26,43,.6)')}</svg>;
          if(type==='right')  return<svg width={s} height={s} viewBox="0 0 28 28">{line(22,2,22,26)}{sq(6,4,14,8,'rgba(139,26,43,.4)')}{sq(12,13,8,6,'#c4324a')}{sq(9,20,11,6,'rgba(139,26,43,.6)')}</svg>;
          if(type==='cH')     return<svg width={s} height={s} viewBox="0 0 28 28">{line(14,2,14,26)}{sq(6,4,16,7,'rgba(139,26,43,.4)')}{sq(9,12,10,7,'#c4324a')}{sq(7,20,14,6,'rgba(139,26,43,.6)')}</svg>;
          if(type==='top')    return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,6,26,6)}{sq(4,7,8,10,'#c4324a')}{sq(15,7,9,16,'rgba(139,26,43,.4)')}</svg>;
          if(type==='bottom') return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,22,26,22)}{sq(4,6,8,16,'rgba(139,26,43,.4)')}{sq(15,12,9,10,'#c4324a')}</svg>;
          if(type==='cV')     return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,14,26,14)}{sq(4,5,8,18,'rgba(139,26,43,.4)')}{sq(15,8,9,12,'#c4324a')}</svg>;
          if(type==='dH')     return<svg width={s} height={s} viewBox="0 0 28 28"><text x="14" y="18" textAnchor="middle" fontSize="14" fill="#c4324a" fontWeight="bold">⇿</text></svg>;
          if(type==='dV')     return<svg width={s} height={s} viewBox="0 0 28 28"><text x="14" y="18" textAnchor="middle" fontSize="14" fill="#c4324a" fontWeight="bold">⇳</text></svg>;
          return null;
        };
        const AB2=(type,label,fn,disabled=false)=>(
          <button key={type} title={label} onClick={disabled?undefined:fn} disabled={disabled}
            className="ba flex flex-col items-center gap-0.5 px-1.5 py-1 rounded"
            style={{background:'rgba(139,26,43,.07)',border:'1px solid rgba(196,50,74,.25)',color:'var(--bl)',opacity:disabled?.35:1,cursor:disabled?'not-allowed':'pointer',minWidth:34}}>
            <AlignIcon type={type}/>
            <span style={{fontSize:7,color:'var(--t3)',lineHeight:1}}>{label}</span>
          </button>
        );
        return(
          <div className="flex-shrink-0" style={{borderBottom:'1px solid rgba(196,50,74,.25)'}}>
            {/* Ligne 1 : info + actions basiques */}
            <div className="flex items-center gap-2 px-3 py-1" style={{background:'rgba(196,50,74,.08)'}}>
              <span className="text-[11px] font-bold" style={{color:'var(--bl)'}}>{selIds.size} ouverture{selIds.size>1?'s':''} sélectionnée{selIds.size>1?'s':''}</span>
              <span className="text-[9px] opacity-50" style={{color:'var(--t2)'}}>Ctrl+clic · Maj+clic · Lasso · Glisser=déplacer</span>
              <div className="flex-1"/>
              <button onClick={()=>setShowAlignPanel(v=>!v)}
                className="ba flex items-center gap-1 px-2 py-1 rounded text-[9px] font-bold"
                style={{background:showAlignPanel?'rgba(196,50,74,.25)':'rgba(196,50,74,.12)',border:'1px solid rgba(196,50,74,.35)',color:'var(--bl)'}}>
                ⊹ Aligner <span className="opacity-50 ml-0.5">Ctrl+A</span>
              </button>
              <button onClick={()=>{const dx=parseInt(prompt('Décalage X (mm):','0')||'0'),dy=parseInt(prompt('Décalage Y (mm):','0')||'0');updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>selIds.has(o.id)?{...o,x:Math.max(0,Math.min(o.x+(dx||0),z.L-o.w)),y:Math.max(0,Math.min(o.y+(dy||0),z.H-o.h))}:o)}));}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>↔ Décaler</button>
              <button onClick={()=>{const dw=parseInt(prompt('Largeur mm (0=inchangé):','0')||'0'),dh=parseInt(prompt('Hauteur mm (0=inchangé):','0')||'0');updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>selIds.has(o.id)?{...o,...(dw>0?{w:dw}:{}),...(dh>0?{h:dh}:{})}:o)}));}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⤡ Resize</button>
              <button onClick={()=>{updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>!selIds.has(o.id))}));setSelIds(new Set());setShowAlignPanel(false);}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>🗑</button>
              <button onClick={()=>{setSelIds(new Set());setShowAlignPanel(false);}} className="ba px-2 py-1 rounded text-[9px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t3)'}}>✕</button>
            </div>
            {/* Ligne 2 : alignement */}
            {showAlignPanel&&selIds.size>=2&&(
              <div className="flex items-center gap-1 px-3 py-1.5" style={{background:'rgba(196,50,74,.08)',borderTop:'1px solid rgba(196,50,74,.15)'}}>
                <span className="text-[8px] font-bold mr-0.5" style={{color:'var(--t3)'}}>ALIGNER</span>
                {AB2('left','Gauche',()=>doAlign('left'))}
                {AB2('cH','Centrer H',()=>doAlign('centerH'))}
                {AB2('right','Droite',()=>doAlign('right'))}
                <div className="w-px h-6 mx-0.5" style={{background:'rgba(196,50,74,.25)'}}/>
                {AB2('top','Haut',()=>doAlign('top'))}
                {AB2('cV','Centrer V',()=>doAlign('centerV'))}
                {AB2('bottom','Bas',()=>doAlign('bottom'))}
                <div className="w-px h-6 mx-0.5" style={{background:'rgba(196,50,74,.25)'}}/>
                <span className="text-[8px] font-bold mr-0.5" style={{color:'var(--t3)'}}>DISTRIBUER</span>
                {AB2('dH','Horiz.',()=>doAlign('distH'),selIds.size<3)}
                {AB2('dV','Vert.',()=>doAlign('distV'),selIds.size<3)}
                {selIds.size<3&&<span className="text-[8px] opacity-40 ml-1" style={{color:'var(--t3)'}}>3 min. pour distribuer</span>}
              </div>
            )}
          </div>
        );
      })()}
      {/* ══ BARRE FUSION PANNEAUX ══ */}
      {step==='work'&&mergeSrc&&az&&(
        <div className="flex items-center gap-2 px-3 py-1.5 flex-shrink-0" style={{background:'rgba(139,92,246,.12)',borderBottom:'1px solid rgba(139,92,246,.3)'}}>
          <span className="text-[11px] font-bold" style={{color:'var(--pp)'}}>⊞ Mode fusion panneaux actif</span>
          <span className="text-[9px] opacity-70" style={{color:'var(--pp)'}}>Cliquez deux panneaux adjacents à fusionner · Ctrl+E ou Échap pour annuler</span>
          <div className="flex-1"/>
          <button onClick={()=>setMergeSrc(null)} className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.2)',border:'1px solid rgba(139,92,246,.4)',color:'var(--pp)'}}>✕ Annuler</button>
        </div>
      )}
      <div className="flex-1 flex min-h-0">
        {/* ── DASHBOARD ── */}
        {/* ══════════ DASHBOARD ══════════ */}
        {step==='dashboard'&&<div className="h-full w-full overflow-y-auto" style={{background:'linear-gradient(160deg,#0a0a0f,#0e0e1a 40%,#110e18 70%,#0a0a0f)'}}>

          {/* ─── STICKY NAV ─── */}
          <div style={{position:'sticky',top:0,zIndex:20,background:'rgba(10,10,15,.88)',backdropFilter:'blur(14px)',borderBottom:'1px solid rgba(255,255,255,.05)'}}>
            <div style={{maxWidth:1120,margin:'0 auto',padding:'10px 24px',display:'flex',alignItems:'center',gap:12}}>
              <div style={{width:34,height:34,borderRadius:10,background:'linear-gradient(135deg,#c4324a,#a0243a)',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 4px 16px rgba(196,50,74,.3)'}}>
                <svg width="16" height="16" viewBox="0 0 40 40" fill="none"><rect x="3" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".95"/><rect x="23" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="3" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="23" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".55"/></svg>
              </div>
              <span style={{fontSize:15,fontWeight:800,color:'#f0ece6',letterSpacing:'-.02em'}}>Kalepin</span>
              <div style={{flex:1}}/>
              <span style={{fontSize:11,color:'var(--t3)',marginRight:4}}>{user?.email||''}</span>
              <button onClick={()=>setShowAccount(true)} style={{padding:'5px 12px',borderRadius:7,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>⚙ Compte</button>
              <button onClick={signOut} style={{padding:'5px 12px',borderRadius:7,border:'1px solid rgba(239,68,68,.12)',background:'rgba(239,68,68,.04)',color:'#f87171',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>Déconnexion</button>
            </div>
          </div>

          {/* ─── HERO PITCH ─── */}
          <div style={{position:'relative',overflow:'hidden'}}>
            <div style={{position:'absolute',top:'8%',left:'12%',width:300,height:300,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.06),transparent 70%)',pointerEvents:'none'}}/>
            <div style={{position:'absolute',bottom:'5%',right:'8%',width:200,height:200,borderRadius:'50%',background:'radial-gradient(circle,rgba(8,145,178,.04),transparent 70%)',pointerEvents:'none'}}/>
            <div style={{position:'absolute',top:'40%',left:'55%',width:350,height:350,borderRadius:'50%',background:'radial-gradient(circle,rgba(196,50,74,.035),transparent 60%)',pointerEvents:'none'}}/>
            <div style={{maxWidth:1120,margin:'0 auto',padding:'60px 24px 40px',textAlign:'center',position:'relative',zIndex:1}}>
              <div style={{display:'inline-flex',alignItems:'center',gap:8,padding:'5px 16px',borderRadius:20,background:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)',marginBottom:24}}>
                <span style={{width:6,height:6,borderRadius:3,background:'#34d399',animation:'pulse-ring 2s infinite'}}/>
                <span style={{fontSize:11,fontWeight:600,color:'#34d399'}}>Bienvenue {user?.email?.split('@')[0]||''}!</span>
              </div>
              <h1 style={{fontSize:38,fontWeight:800,lineHeight:1.15,color:'#f0ece6',marginBottom:16,letterSpacing:'-.03em'}}>
                De l'import de vos plans au<br/>
                <span style={{background:'linear-gradient(135deg,#c4324a,#e8697f)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>bon de commande en 5 minutes</span>
              </h1>
              <p style={{fontSize:15,color:'rgba(255,255,255,.45)',maxWidth:620,margin:'0 auto 32px',lineHeight:1.7}}>
                L'outil métier conçu pour les <b style={{color:'rgba(255,255,255,.6)'}}>bardeurs et façadiers</b> qui souhaitent automatiser le calepinage (Alucobond, Trespa, Equitone…), générer des métrés précis d'ossature et visualiser le rendu 3D avec les codes RAL réels.
              </p>
              <div style={{display:'flex',justifyContent:'center',gap:10,flexWrap:'wrap'}}>
                {['Import PDF / DXF','Calcul auto cassettes','Vue 3D RAL','Métrés Excel','QR Code Chantier','Plan de masse'].map(t=>
                  <span key={t} style={{padding:'5px 14px',borderRadius:20,fontSize:10,fontWeight:600,background:'rgba(255,255,255,.04)',border:'1px solid rgba(255,255,255,.06)',color:'rgba(255,255,255,.5)'}}>{t}</span>
                )}
              </div>
            </div>
          </div>

          <div style={{maxWidth:1120,margin:'0 auto',padding:'10px 24px 44px'}}>
            <div style={{fontSize:13,fontWeight:700,color:'var(--t1)',marginBottom:14,display:'flex',alignItems:'center',gap:8}}>
              <div style={{width:3,height:18,borderRadius:2,background:'#c4324a'}}/>Créer un nouveau projet
            </div>
            <div style={{display:'grid',gridTemplateColumns:`repeat(${isAdmin?4:3},1fr)`,gap:16}}>
              {/* Facade cassettes */}
              <div onClick={()=>{setProjectType('facade');setStep('welcome')}} style={{padding:24,borderRadius:20,background:'linear-gradient(135deg,rgba(196,50,74,.05),rgba(196,50,74,.01))',border:'1.5px solid rgba(196,50,74,.1)',cursor:'pointer',transition:'all .25s',position:'relative',overflow:'hidden'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='rgba(196,50,74,.35)';e.currentTarget.style.transform='translateY(-3px)';e.currentTarget.style.boxShadow='0 16px 48px rgba(196,50,74,.12)'}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='rgba(196,50,74,.1)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none'}}>
                <div style={{fontSize:30,marginBottom:10}}>🏢</div>
                <div style={{fontSize:15,fontWeight:700,color:'var(--t1)',marginBottom:4}}>Facade Cassettes</div>
                <div style={{fontSize:11,color:'var(--t3)',lineHeight:1.6,marginBottom:12}}>Bardage métallique, cassettes, panneaux composites (Alucobond, Trespa, Equitone).</div>
                <div style={{display:'flex',gap:5,flexWrap:'wrap'}}>
                  {['PDF','DXF','3D','RAL','Ossature'].map(t=><span key={t} style={{padding:'2px 8px',borderRadius:5,fontSize:8,fontWeight:700,background:'rgba(196,50,74,.08)',color:'#c4324a'}}>{t}</span>)}
                </div>
              </div>
              {/* Facade brique */}
              <div onClick={()=>{setProjectType('brique');setStep('brique')}} style={{padding:24,borderRadius:20,background:'linear-gradient(135deg,rgba(217,119,6,.05),rgba(217,119,6,.01))',border:'1.5px solid rgba(217,119,6,.1)',cursor:'pointer',transition:'all .25s',position:'relative',overflow:'hidden'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='rgba(217,119,6,.35)';e.currentTarget.style.transform='translateY(-3px)';e.currentTarget.style.boxShadow='0 16px 48px rgba(217,119,6,.12)'}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='rgba(217,119,6,.1)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none'}}>
                <div style={{fontSize:30,marginBottom:10}}>🧱</div>
                <div style={{fontSize:15,fontWeight:700,color:'var(--t1)',marginBottom:4}}>Facade Brique</div>
                <div style={{fontSize:11,color:'var(--t3)',lineHeight:1.6,marginBottom:12}}>Briques de parement, plaquettes. Appareillages classiques, joints et ouvertures.</div>
                <div style={{display:'flex',gap:5,flexWrap:'wrap'}}>
                  {['Panneresse','Flamande','Anglaise','Coupes','Métrés'].map(t=><span key={t} style={{padding:'2px 8px',borderRadius:5,fontSize:8,fontWeight:700,background:'rgba(217,119,6,.08)',color:'#d97706'}}>{t}</span>)}
                </div>
              </div>
              {/* Carrelage */}
              <div onClick={()=>{setProjectType('carrelage');setStep('carrelage')}} style={{padding:24,borderRadius:20,background:'linear-gradient(135deg,rgba(14,165,233,.05),rgba(14,165,233,.015))',border:'1.5px solid rgba(14,165,233,.1)',cursor:'pointer',transition:'all .25s',position:'relative',overflow:'hidden'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='rgba(14,165,233,.35)';e.currentTarget.style.transform='translateY(-3px)';e.currentTarget.style.boxShadow='0 16px 48px rgba(14,165,233,.12)'}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='rgba(14,165,233,.1)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none'}}>
                <div style={{fontSize:30,marginBottom:10}}>🔲</div>
                <div style={{fontSize:15,fontWeight:700,color:'var(--t1)',marginBottom:4}}>Calepinage Carrelage</div>
                <div style={{fontSize:11,color:'var(--t3)',lineHeight:1.6,marginBottom:12}}>Sol, mur, piscine. Motifs de pose, calepins, coupes périphériques.</div>
                <div style={{display:'flex',gap:6,flexWrap:'wrap'}}>
                  {['Sol','Mur','Piscine','Coupes','Métrés','Motifs'].map(t=><span key={t} style={{padding:'3px 10px',borderRadius:6,fontSize:9,fontWeight:700,background:'rgba(14,165,233,.08)',color:'#0ea5e9'}}>{t}</span>)}
                </div>
              </div>
              {/* Admin card — visible uniquement pour les admins */}
              {isAdmin&&<div onClick={()=>setStep('admin')} style={{padding:24,borderRadius:20,background:'linear-gradient(135deg,rgba(196,50,74,.09),rgba(139,26,43,.04))',border:'1.5px solid rgba(196,50,74,.22)',cursor:'pointer',transition:'all .25s',position:'relative',overflow:'hidden'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='rgba(196,50,74,.55)';e.currentTarget.style.transform='translateY(-3px)';e.currentTarget.style.boxShadow='0 16px 48px rgba(196,50,74,.18)'}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='rgba(196,50,74,.22)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none'}}>
                <div style={{position:'absolute',top:12,right:14,padding:'2px 8px',borderRadius:20,background:'rgba(196,50,74,.15)',border:'1px solid rgba(196,50,74,.3)',fontSize:8,fontWeight:800,color:'#c4324a',letterSpacing:'.08em'}}>ADMIN</div>
                <div style={{fontSize:30,marginBottom:10}}>⚡</div>
                <div style={{fontSize:15,fontWeight:700,color:'var(--t1)',marginBottom:4}}>Dashboard Admin</div>
                <div style={{fontSize:11,color:'var(--t3)',lineHeight:1.6,marginBottom:12}}>Gestion des utilisateurs bêta, statistiques d'usage, bibliothèques.</div>
                <div style={{display:'flex',gap:5,flexWrap:'wrap'}}>
                  {['Utilisateurs','Stats','Approbations','Bibliothèques'].map(t=><span key={t} style={{padding:'2px 8px',borderRadius:5,fontSize:8,fontWeight:700,background:'rgba(196,50,74,.1)',color:'#c4324a'}}>{t}</span>)}
                </div>
              </div>}
            </div>
          </div>

          {/* ─── MES PROJETS ─── */}
          <div style={{maxWidth:1120,margin:'0 auto',padding:'0 24px 56px'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
              <div style={{fontSize:13,fontWeight:700,color:'var(--t1)',display:'flex',alignItems:'center',gap:8}}>
                <div style={{width:3,height:18,borderRadius:2,background:'#0ea5e9'}}/>Mes projets récents ({dashProjects.length})
              </div>
              <button onClick={()=>{setDashLoading(true);cloudProjectsList().then(p=>{setDashProjects(p||[]);setDashLoading(false)})}} style={{padding:'5px 14px',borderRadius:7,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',fontSize:10,cursor:'pointer',fontFamily:'inherit'}}>↻ Actualiser</button>
            </div>
            {dashLoading?<div style={{textAlign:'center',padding:40,color:'var(--t3)',fontSize:13}}>Chargement...</div>
            :dashProjects.length===0?<div style={{textAlign:'center',padding:50,borderRadius:20,border:'1.5px dashed rgba(255,255,255,.06)',background:'rgba(255,255,255,.012)'}}>
              <div style={{fontSize:42,marginBottom:14}}>📁</div>
              <div style={{fontSize:14,fontWeight:600,color:'var(--t2)',marginBottom:6}}>Aucun projet sauvegardé</div>
              <div style={{fontSize:11,color:'var(--t3)'}}>Créez votre premier calepinage ci-dessus</div>
            </div>
            :<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250,1fr))',gap:12}}>
              {dashProjects.map(p=><div key={p.id} onClick={()=>openCloudProject(p.id)} style={{
                padding:16,borderRadius:14,background:'rgba(255,255,255,.02)',border:'1px solid rgba(255,255,255,.05)',cursor:'pointer',transition:'all .2s',position:'relative',overflow:'hidden'}}
                onMouseOver={e=>{e.currentTarget.style.borderColor='rgba(196,50,74,.22)';e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow='0 10px 30px rgba(0,0,0,.25)'}}
                onMouseOut={e=>{e.currentTarget.style.borderColor='rgba(255,255,255,.05)';e.currentTarget.style.transform='none';e.currentTarget.style.boxShadow='none'}}>
                <div style={{position:'absolute',top:0,left:0,right:0,height:3,background:'linear-gradient(90deg,#c4324a,#a0243a)',opacity:.45}}/>
                <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:10}}>
                  <div style={{width:34,height:34,borderRadius:9,background:'linear-gradient(135deg,rgba(196,50,74,.08),rgba(196,50,74,.03))',border:'1px solid rgba(196,50,74,.1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,flexShrink:0}}>🏗</div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:12,fontWeight:700,color:'var(--t1)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{p.name}</div>
                    <div style={{fontSize:9,color:'var(--t3)',marginTop:2}}>{(()=>{try{return new Date(p.updated_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'})}catch(e){return'-'}})()}</div>
                  </div>
                </div>
                <div style={{display:'flex',gap:8,fontSize:10,color:'var(--t3)'}}><span>{p.zones_count||0} zone{(p.zones_count||0)>1?'s':''}</span><span>·</span><span>{(p.total_surface||0).toFixed(1)} m²</span></div>
              </div>)}
            </div>}
          </div>

          {/* ─── FONCTIONNALITÉS ─── */}
          <div style={{background:'rgba(255,255,255,.012)',borderTop:'1px solid rgba(255,255,255,.04)',borderBottom:'1px solid rgba(255,255,255,.04)'}}>
            <div style={{maxWidth:1120,margin:'0 auto',padding:'56px 24px'}}>
              <div style={{textAlign:'center',marginBottom:40}}>
                <h2 style={{fontSize:26,fontWeight:800,color:'#f0ece6',marginBottom:10}}>Pourquoi choisir Kalepin ?</h2>
                <p style={{fontSize:13,color:'rgba(255,255,255,.4)',maxWidth:520,margin:'0 auto'}}>4 problèmes métier résolus par un seul outil</p>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:16}}>
                {[
                  {icon:'🎯',title:'Zéro erreur de commande',desc:'Calcul auto des surfaces nettes, chutes et nombre exact de panneaux incluant les cassettes pliées avec le détail des plis.',color:'#c4324a'},
                  {icon:'🧊',title:'Vente simplifiée en 3D',desc:'Montrez à vos clients le rendu final avec les finitions RAL (mat, brillant, métallisé) dans le navigateur ou sur mobile.',color:'#0ea5e9'},
                  {icon:'📊',title:'Métrés instantanés',desc:'Excel récapitulant les métrés par zone, les ouvertures (fenêtres, portes) et les linéaires d\'ossature en 1 clic.',color:'#34d399'},
                  {icon:'📐',title:'Import DXF / PDF',desc:'Importez vos plans d\'architecte et travaillez directement dessus par transparence. Calibration automatique.',color:'#f59e0b'},
                ].map((f,i)=><div key={i} style={{padding:24,borderRadius:18,background:'rgba(0,0,0,.2)',border:'1px solid rgba(255,255,255,.04)',position:'relative',overflow:'hidden',transition:'all .2s'}}
                  onMouseOver={e=>e.currentTarget.style.borderColor=`${f.color}30`}
                  onMouseOut={e=>e.currentTarget.style.borderColor='rgba(255,255,255,.04)'}>
                  <div style={{position:'absolute',top:-20,right:-20,width:70,height:70,borderRadius:'50%',background:`radial-gradient(circle,${f.color}0d,transparent)`,pointerEvents:'none'}}/>
                  <div style={{fontSize:30,marginBottom:14}}>{f.icon}</div>
                  <div style={{fontSize:13,fontWeight:700,color:'#f0ece6',marginBottom:8}}>{f.title}</div>
                  <div style={{fontSize:11,color:'rgba(255,255,255,.4)',lineHeight:1.65}}>{f.desc}</div>
                </div>)}
              </div>
            </div>
          </div>

          {/* ─── QR CODE CHANTIER SPOTLIGHT ─── */}
          <div style={{background:'rgba(196,50,74,.035)',borderTop:'1px solid rgba(196,50,74,.08)',borderBottom:'1px solid rgba(196,50,74,.08)'}}>
            <div style={{maxWidth:1120,margin:'0 auto',padding:'44px 24px',display:'flex',alignItems:'center',gap:32}}>
              <div style={{width:88,height:88,borderRadius:20,background:'linear-gradient(135deg,rgba(196,50,74,.1),rgba(196,50,74,.04))',border:'1px solid rgba(196,50,74,.12)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:40,flexShrink:0}}>📱</div>
              <div style={{flex:1}}>
                <div style={{fontSize:18,fontWeight:700,color:'#f0ece6',marginBottom:8}}>Le QR Code Chantier</div>
                <div style={{fontSize:12,color:'rgba(255,255,255,.4)',lineHeight:1.7}}>
                  Posez vos panneaux avec le plan 3D accessible sur votre téléphone via un simple QR code collé sur votre plan papier.
                  Partagez la vue AR avec vos clients directement sur site — un argument commercial unique qui fait la différence.
                </div>
              </div>
              <div style={{flexShrink:0}}>
                <button onClick={()=>{setProjectType('facade');setStep('welcome')}} style={{padding:'12px 28px',borderRadius:12,border:'none',background:'linear-gradient(135deg,#c4324a,#a0243a)',color:'#fff',fontSize:13,fontWeight:700,cursor:'pointer',fontFamily:'inherit',boxShadow:'0 6px 20px rgba(196,50,74,.25)',transition:'all .2s'}}>Essayer maintenant</button>
              </div>
            </div>
          </div>

          {/* ─── FOOTER ─── */}
          <div style={{borderTop:'1px solid rgba(255,255,255,.04)',padding:'24px 0',textAlign:'center'}}>
            <div style={{fontSize:10,color:'rgba(255,255,255,.2)'}}>Kalepin v16 — © 2025 · Conçu pour les bardeurs et façadiers</div>
          </div>

        </div>}


        {step==='welcome'&&<Welcome/>}
        {step==='carrelage'&&<CarrelageApp onBack={()=>setStep('dashboard')} user={user}/>}
        {step==='brique'&&<BriqueApp onBack={()=>setStep('dashboard')} user={user}/>}
        {step==='admin'&&profile?.role==='superadmin'&&<AdminApp onBack={()=>setStep('dashboard')} currentUser={user} isSuperAdmin={true}/>}
        {/* LEFT */}
        {step==='work'&&az&&(
          <div className="w-[250px] flex-shrink-0 border-r flex flex-col" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex-1 overflow-y-auto p-2.5 space-y-2">
              <div className="cd p-2.5"><TI label="Zone" value={az.name} onChange={v=>updateAZ(z=>({...z,name:v}))}/>
                <div className="grid grid-cols-2 gap-1.5 mt-2">
                  <NI compact label="L mm" value={az.L} onChange={v=>updateAZ(z=>({...z,L:v}))} unit="mm"/>
                  <NI compact label="H mm" value={az.H} onChange={v=>updateAZ(z=>({...z,H:v}))} unit="mm"/>
                </div>
                {az.poly&&<div className="text-[9px] mt-1 px-1 py-0.5 rounded" style={{background:'var(--ppd)',color:'var(--pp)'}}>Polygone {az.poly.length} pts</div>}
                <div className="flex gap-1.5 mt-2">
                  <button onClick={()=>{const cz=JSON.parse(JSON.stringify(az));cz.id=Date.now();cz.name=az.name+' (copie)';
                    cz.facOrigin={x:az.facOrigin.x+30/zoom,y:az.facOrigin.y+30/zoom};
                    setZones(zs=>[...zs,cz]);setActiveZoneIdx(zones.length)}}
                    className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg flex items-center justify-center gap-1" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⧉ Dupliquer</button>
                  {zones.length>1&&<button onClick={()=>{setZones(zs=>zs.filter((_,i)=>i!==activeZoneIdx));setActiveZoneIdx(Math.max(0,activeZoneIdx-1))}}
                    className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>Supprimer</button>}
                </div>
              </div>
              <Sec icon={I.grid()} title="Panneau" color="var(--bl)">
                <div className="space-y-2">
                  <div className="grid grid-cols-2 gap-1 max-h-24 overflow-y-auto">{presPan.map((p,i)=>(
                    <div key={p.n+i} className="relative group">
                      <button onClick={()=>updateAZ(z=>({...z,pan_:{l:p.l,w:p.w,nom:p.n}}))} className={`pb truncate w-full ${az.pan_.nom===p.n?'on':''}`}>{p.n}<span className="block text-[8px] opacity-60">{p.l}x{p.w}</span></button>
                      {i>=DP.length&&<button onClick={()=>setPresPan(ps=>ps.filter((_,j)=>j!==i))} className="absolute -top-1 -right-1 w-3.5 h-3.5 rounded-full flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100 transition-opacity" style={{background:'var(--rs)',color:'#fff',lineHeight:1}}>×</button>}
                    </div>))}</div>
                  <button onClick={()=>{
                    const nom=prompt('Nom du panneau :');if(!nom)return;
                    const l=parseInt(prompt('Longueur (mm) :','2000'));if(!l||isNaN(l))return;
                    const w=parseInt(prompt('Largeur (mm) :','600'));if(!w||isNaN(w))return;
                    const np={n:nom,l,w};setPresPan(ps=>[...ps,np]);updateAZ(z=>({...z,pan_:{l,w,nom}}))
                  }} className="ba w-full py-1.5 rounded-lg text-[10px] font-medium flex items-center justify-center gap-1" style={{background:'var(--blg)',border:'1px dashed var(--bl)',color:'var(--bl)'}}>+ Créer un panneau</button>
                  <NI label="Longueur" value={az.pan_.l} onChange={v=>updateAZ(z=>({...z,pan_:{...z.pan_,l:v,nom:''}}))} unit="mm"/>
                  <NI label="Largeur" value={az.pan_.w} onChange={v=>updateAZ(z=>({...z,pan_:{...z.pan_,w:v,nom:''}}))} unit="mm"/>
                  <div className="flex gap-1.5">{[true,false].map(v=><button key={String(v)} onClick={()=>updateAZ(z=>({...z,vert:v}))} className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg"
                    style={{background:az.vert===v?'var(--blg)':'var(--inp)',border:`1px solid ${az.vert===v?'var(--bl)':'var(--bd)'}`,color:az.vert===v?'var(--bl)':'var(--t3)'}}>{v?'Vertical':'Horizontal'}</button>)}</div>
                  <div className="grid grid-cols-2 gap-1.5">
                    <NI compact label="Decal. X" value={az.offX||0} onChange={v=>updateAZ(z=>({...z,offX:v}))} unit="mm" step={50} min={0}/>
                    <NI compact label="Decal. Y" value={az.offY||0} onChange={v=>updateAZ(z=>({...z,offY:v}))} unit="mm" step={50} min={0}/>
                  </div>
                  {/* Joint gaps — default + individual */}
                  <div className="grid grid-cols-2 gap-1.5">
                    <NI compact label="Joint H défaut" value={az.jointH||0} onChange={v=>updateAZ(z=>({...z,jointH:v}))} unit="mm" step={1} min={0}/>
                    <NI compact label="Joint V défaut" value={az.jointV||0} onChange={v=>updateAZ(z=>({...z,jointV:v}))} unit="mm" step={1} min={0}/>
                  </div>
                  {(az.jointsH?.some(v=>v!=null)||az.jointsV?.some(v=>v!=null))&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-[9px] font-bold" style={{color:'var(--am)'}}>Joints individuels</span>
                      <button onClick={()=>updateAZ(z=>({...z,jointsH:[],jointsV:[]}))} className="text-[8px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>Reset tout</button>
                    </div>
                    {az.jointsH?.some(v=>v!=null)&&<div className="text-[9px] mb-1" style={{color:'var(--t3)'}}>
                      V: {az.jointsH.map((v,i)=>v!=null?`#${i+1}:${v}mm`:null).filter(Boolean).join(', ')}</div>}
                    {az.jointsV?.some(v=>v!=null)&&<div className="text-[9px]" style={{color:'var(--t3)'}}>
                      H: {az.jointsV.map((v,i)=>v!=null?`#${i+1}:${v}mm`:null).filter(Boolean).join(', ')}</div>}
                    <div className="text-[8px] mt-1" style={{color:'var(--am)',fontStyle:'italic'}}>💡 Cliquez sur un joint (ligne orange) dans le plan pour ajuster son épaisseur</div>
                  </div>}
                  {/* Per-column / Per-row sizes */}
                  {C&&C.nC>0&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-[9px] font-bold" style={{color:'var(--cy)'}}>Largeurs colonnes (mm)</span>
                      <button onClick={()=>updateAZ(z=>({...z,colWidths:[]}))} className="text-[8px]" style={{color:'var(--t3)'}}>Reset</button>
                    </div>
                    <div className="flex flex-wrap gap-1 max-h-[200px] overflow-y-auto">{Array.from({length:C.nC}).map((_,ci)=>{
                      const defW=Math.round((az.vert?az.pan_.w:az.pan_.l));
                      const curW=(az.colWidths||[])[ci]||defW;
                      return<input key={ci} type="number" value={curW}
                        onChange={e=>{const v=parseInt(e.target.value)||defW;
                          updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=ci)cw.push(0);cw[ci]=v;return{...z,colWidths:cw}})}}
                        className="idark text-center mn w-12 py-0.5 rounded text-[9px]"
                        style={{borderColor:((az.colWidths||[])[ci]&&(az.colWidths||[])[ci]!==defW)?'var(--cy)':'var(--bd)'}}
                        title={`Col ${ci+1}`}/>})}</div>
                  </div>}
                  {C&&C.nR>0&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-[9px] font-bold" style={{color:'var(--pp)'}}>Hauteurs lignes (mm)</span>
                      <button onClick={()=>updateAZ(z=>({...z,rowHeights:[]}))} className="text-[8px]" style={{color:'var(--t3)'}}>Reset</button>
                    </div>
                    <div className="flex flex-wrap gap-1 max-h-[200px] overflow-y-auto">{Array.from({length:C.nR}).map((_,ri)=>{
                      const defH=Math.round((az.vert?az.pan_.l:az.pan_.w));
                      const curH=(az.rowHeights||[])[ri]||defH;
                      return<input key={ri} type="number" value={curH}
                        onChange={e=>{const v=parseInt(e.target.value)||defH;
                          updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=ri)rh.push(0);rh[ri]=v;return{...z,rowHeights:rh}})}}
                        className="idark text-center mn w-12 py-0.5 rounded text-[9px]"
                        style={{borderColor:((az.rowHeights||[])[ri]&&(az.rowHeights||[])[ri]!==defH)?'var(--pp)':'var(--bd)'}}
                        title={`Ligne ${ri+1}`}/>})}</div>
                  </div>}
                  <div className="flex items-center gap-2">
                    <NI compact label="Rotation" value={az.rot||0} onChange={v=>updateAZ(z=>({...z,rot:v}))} unit="°" step={0.5} min={-45} max={45}/>
                    <input type="range" min="-45" max="45" step="0.5" value={az.rot||0} onChange={e=>updateAZ(z=>({...z,rot:parseFloat(e.target.value)}))} className="rng flex-1"/>
                    {(az.rot||0)!==0&&<button onClick={()=>updateAZ(z=>({...z,rot:0}))} className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>0°</button>}
                  </div>
                </div></Sec>
              <Sec icon={I.frame()} title="Ossature" color="var(--am)" dO={false}><div className="space-y-2">
                <NI label="Entraxe montants" value={az.oss.eM} onChange={v=>updateAZ(z=>({...z,oss:{...z.oss,eM:v}}))} unit="mm"/>
                <NI label="Entraxe lisses" value={az.oss.eL} onChange={v=>updateAZ(z=>({...z,oss:{...z.oss,eL:v}}))} unit="mm"/>
              </div></Sec>
              <Sec icon={I.bolt()} title="Fixations" color="var(--t2)" dO={false}><div className="space-y-2">
                <NI label="Par panneau" value={fix.pp} onChange={v=>setFix(f=>({...f,pp:v}))} unit="u" step={1}/>
                <NI label="Equerres/montant" value={fix.em} onChange={v=>setFix(f=>({...f,em:v}))} unit="u" step={1}/>
              </div></Sec>
              <Sec icon="⊞" title="Fusion" badge={(az.merges||[]).length||null} color="var(--pp)">
                <div className="space-y-2">
                  <button onClick={()=>{if(mergeSrc){setMergeSrc(null)}else{setMergeSrc({parentCol:-1,parentRow:-1});setEditPanel(null)}}}
                    className={`ba w-full py-2 rounded-lg text-[10px] font-bold ${mergeSrc?'apg':''}`}
                    style={{background:mergeSrc?'rgba(139,92,246,.25)':'rgba(139,92,246,.1)',border:'1px solid rgba(139,92,246,.3)',color:'var(--pp)'}}>
                    {mergeSrc?'Annuler':'Fusionner des panneaux'}<span className="ml-1 text-[8px] opacity-50">Ctrl+E</span></button>
                  {(az.merges||[]).length>0&&<div className="space-y-1">
                    <div className="text-[9px] font-bold" style={{color:'var(--t3)'}}>{(az.merges||[]).length} fusion(s)</div>
                    {(az.merges||[]).map((m,i)=><div key={i} className="flex items-center justify-between px-2 py-1 rounded" style={{background:'rgba(139,92,246,.06)',border:'1px solid rgba(139,92,246,.1)'}}>
                      <span className="text-[9px] mn font-bold" style={{color:'var(--pp)'}}>C{m.c1+1}-C{m.c2+1} L{m.r1+1}-L{m.r2+1}</span>
                      <button onClick={()=>updateAZ(z=>({...z,merges:(z.merges||[]).filter((_,j)=>j!==i)}))} className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>x</button>
                    </div>)}
                    <button onClick={()=>updateAZ(z=>({...z,merges:[]}))} className="w-full py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',color:'var(--rs)'}}>Tout supprimer</button>
                  </div>}
                </div>
              </Sec>
              {/* ── EXCLUSIONS / BALCONS ── */}
              <Sec icon="🚫" title="Exclusions / Balcons" badge={(az.exclusions||[]).length||null} color="var(--rs)">
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <label className="text-[9px] font-bold" style={{color:'var(--t3)'}}>Profondeur (mm)</label>
                    <input type="number" value={excludeDepth} onChange={e=>setExcludeDepth(Math.max(100,parseInt(e.target.value)||1500))}
                      className="idark flex-1 px-2 py-1 rounded text-[11px] mn font-bold text-center"
                      style={{borderColor:'var(--rs)'}} min={100} step={100}/>
                  </div>
                  <button onClick={()=>{if(excludeMode){setExcludeMode(false)}else{setExcludeMode(true);setMergeSrc(null);setEditPanel(null)}}}
                    className={`ba w-full py-2 rounded-lg text-[10px] font-bold ${excludeMode?'apg':''}`}
                    style={{background:excludeMode?'rgba(190,18,60,.25)':'rgba(190,18,60,.08)',border:'1px solid rgba(190,18,60,.3)',color:'var(--rs)'}}>
                    {excludeMode?'✓ Cliquer panneau pour exclure/restaurer':'🚫 Mode exclusion (balcon/auvent)'}
                  </button>
                  {(az.exclusions||[]).length>0&&<div className="space-y-1">
                    <div className="text-[9px] font-bold" style={{color:'var(--t3)'}}>{(az.exclusions||[]).length} exclusion(s)</div>
                    {(az.exclusions||[]).map((ex,i)=><div key={i} className="flex items-center justify-between px-2 py-1 rounded" style={{background:'rgba(190,18,60,.06)',border:'1px solid rgba(190,18,60,.15)'}}>
                      <span className="text-[9px] mn font-bold" style={{color:'var(--rs)'}}>C{ex.col+1} L{ex.row+1} — {ex.depth}mm</span>
                      <div className="flex gap-1">
                        <input type="number" defaultValue={ex.depth} className="w-14 text-center text-[9px] px-1 py-0.5 rounded mn"
                          style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}}
                          onChange={e=>{const v=parseInt(e.target.value)||1500;
                            updateAZ(z=>({...z,exclusions:(z.exclusions||[]).map((x,j)=>j===i?{...x,depth:v}:x)}))}}/>
                        <button onClick={()=>updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter((_,j)=>j!==i)}))}
                          className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>x</button>
                      </div>
                    </div>)}
                    <button onClick={()=>updateAZ(z=>({...z,exclusions:[]}))} className="w-full py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',color:'var(--rs)'}}>Tout supprimer</button>
                  </div>}
                </div>
              </Sec>
              <Sec icon={I.win()} title="Ouvertures" badge={az.ouvs.length||null} color="var(--rs)" act={{ic:I.plus(14),fn:()=>setAddMod('ouv')}}>
                <div className="space-y-2">
                  <button onClick={()=>setModeDraw(!modeDraw)} className={`ba w-full py-1.5 text-xs font-medium rounded-lg flex items-center justify-center gap-1 ${modeDraw?'apg':''}`}
                    style={{background:modeDraw?'var(--rsd)':'var(--blg)',border:`1px solid ${modeDraw?'var(--rs)':'var(--bl)'}`,color:modeDraw?'var(--rs)':'var(--bl)'}}>
                    {modeDraw?'Annuler':<>{I.cross(12)} Dessiner</>}</button>
                  <div className="grid grid-cols-2 gap-1">{presOuv.map((p,i)=><button key={p.n+i} onClick={()=>addPOuv(p)} className="pb truncate">{p.n}</button>)}</div>
                  <div className="space-y-1 max-h-40 overflow-y-auto">
                    {az.ouvs.map((o,i)=>{const sel=selId===o.id;return(
                      <div key={o.id} className={`rounded-lg p-2 cursor-pointer ${sel?'ring-1':''}`}
                        style={{background:sel?'var(--blg)':'var(--inp)',border:`1px solid ${sel?'var(--bl)':'var(--bd)'}`,ringColor:'var(--bl)'}}
                        onClick={()=>setSelId(sel?null:o.id)}>
                        <div className="flex items-center justify-between">
                          <span className="text-[11px] font-medium">{o.t} {i+1} <span className="mn text-[10px]" style={{color:'var(--t3)'}}>{o.w}x{o.h}</span></span>
                          <div className="flex gap-1">
                            <button onClick={e=>{e.stopPropagation();updateAZ(z=>({...z,ouvs:[...z.ouvs,{...o,id:Date.now(),x:clamp(o.x+200,0,az.L-o.w)}]}))}} className="w-5 h-5 rounded flex items-center justify-center" style={{color:'var(--t3)'}}>{I.copy(10)}</button>
                            <button onClick={e=>{e.stopPropagation();updateAZ(z=>({...z,ouvs:z.ouvs.filter(x=>x.id!==o.id)}));if(selId===o.id)setSelId(null)}} className="w-5 h-5 rounded flex items-center justify-center" style={{color:'var(--t3)'}}>{I.trash(10)}</button>
                          </div></div>
                        {sel&&<div className="mt-2 afu"><div className="grid grid-cols-2 gap-1">
                          <NI compact value={o.x} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,x:v}:x)}))} unit="X" step={50}/>
                          <NI compact value={o.y} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,y:v}:x)}))} unit="Y" step={50}/>
                          <NI compact value={o.w} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,w:v}:x)}))} unit="L" step={50} min={200}/>
                          <NI compact value={o.h} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,h:v}:x)}))} unit="H" step={50} min={200}/>
                        </div>
                        <div className="mt-1.5 flex flex-wrap gap-1">
                          <button onClick={()=>{const s=snapOuvToJoint(o,'all');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-2 py-1 rounded text-[8px] font-bold" style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⊞ Aligner tout</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'left');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>← G</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'right');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>D →</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'top');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>↑ H</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'bottom');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>B ↓</button>
                        </div></div>}
                      </div>);})}
                    {!az.ouvs.length&&<p className="text-center text-[11px] py-2" style={{color:'var(--t3)'}}>Aucune</p>}
                  </div></div></Sec>
            </div></div>)}
        {/* CENTER */}
        <div className="flex-1 flex flex-col min-w-0 relative">
          {step==='work'&&(<div className="flex items-center gap-2 px-3 h-9 border-b flex-shrink-0" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex items-center gap-1 p-0.5 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
              <button onClick={()=>setZoom(z=>Math.min(z*1.2,20))} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.zi(12)}</button>
              <span className="w-10 text-center text-[10px] mn" style={{color:'var(--t3)'}}>{(zoom*100).toFixed(0)}%</span>
              <button onClick={()=>setZoom(z=>Math.max(z/1.2,.05))} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.zo(12)}</button>
              <div className="w-px h-4" style={{background:'var(--bd)'}}/><button onClick={autoFit} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.tgt(12)}</button></div>
            <div className="flex gap-2.5 text-[9px] ml-2">
              {[{f:'rgba(79,110,247,.1)',s:'rgba(79,110,247,.4)',t:'Standard'},{f:'rgba(251,191,36,.12)',s:'rgba(251,191,36,.5)',t:'Impactes'},{f:'rgba(34,211,238,.08)',s:'rgba(34,211,238,.4)',t:'Bord poly.'}].map(l=>
                <span key={l.t} className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded-sm" style={{background:l.f,border:`1px solid ${l.s}`}}/><span style={{color:'var(--t3)'}}>{l.t}</span></span>)}
            </div></div>)}
          <Instructions/>
          <div ref={cvRef} className="flex-1 overflow-hidden cvbg" style={{cursor,position:'relative'}} onMouseDown={handleDown} onMouseMove={handleMove} onMouseUp={handleUp} onMouseLeave={()=>{handleUp();setDragZone(null);setResizeZone(null)}} onContextMenu={e=>e.preventDefault()}>

            {show3D&&az&&C&&<Facade3D zone={az} calc={C} ralColor={RAL_COLORS[az.ralIdx??ralIdx]?.hex} ralFinish={RAL_COLORS[az.ralIdx??ralIdx]?.finish||'mat'}
              showWall={show3DWall}
              onToggle={k=>{if(k==='wall')setShow3DWall(v=>!v)}}
              onClose={()=>setShow3D(false)}/>}
            {/* Floating canvas toolbar — only 3D + color swatch */}
            {step==='work'&&!show3D&&az&&<div style={{position:'absolute',top:12,right:12,zIndex:20,display:'flex',gap:8,alignItems:'center'}}>
              <div onClick={()=>setRightTab('ral')} style={{width:28,height:28,borderRadius:8,background:RAL_COLORS[zoneRalIdx]?.hex,
                border:'2px solid rgba(255,255,255,.2)',cursor:'pointer',boxShadow:'0 2px 10px rgba(0,0,0,.3)'}} title={`${RAL_COLORS[zoneRalIdx]?.code} — Cliquer pour changer`}/>
              <button onClick={()=>setShow3D(true)} className="ba"
                style={{background:'linear-gradient(135deg,rgba(139,92,246,.9),rgba(79,110,247,.9))',border:'none',borderRadius:10,padding:'8px 12px',
                  color:'#fff',fontSize:12,fontWeight:700,cursor:'pointer',boxShadow:'0 4px 20px rgba(79,110,247,.4)',
                  display:'flex',alignItems:'center',gap:5,backdropFilter:'blur(8px)'}}>
                🧊 3D</button>
            </div>}
            {/* Merge mode banner */}
            {mergeSrc&&<div style={{position:'absolute',top:50,left:'50%',transform:'translateX(-50%)',zIndex:25,
              background:'rgba(139,92,246,.9)',borderRadius:12,padding:'10px 20px',backdropFilter:'blur(8px)',
              display:'flex',alignItems:'center',gap:10,boxShadow:'0 4px 20px rgba(0,0,0,.4)'}}>
              <span className="text-sm font-bold text-white">{mergeSrc.parentCol===-1?'Cliquer le 1er panneau':'Cliquer le 2ème panneau'}</span>
              <button onClick={()=>setMergeSrc(null)} className="ba px-3 py-1 rounded-lg text-xs font-bold"
                style={{background:'rgba(255,255,255,.2)',color:'#fff'}}>Annuler</button>
            </div>}
            {/* Exclude mode banner */}
            {excludeMode&&<div style={{position:'absolute',top:50,left:'50%',transform:'translateX(-50%)',zIndex:25,
              background:'rgba(190,18,60,.88)',borderRadius:12,padding:'10px 20px',backdropFilter:'blur(8px)',
              display:'flex',alignItems:'center',gap:10,boxShadow:'0 4px 20px rgba(0,0,0,.4)'}}>
              <span style={{fontSize:18}}>🚫</span>
              <span className="text-sm font-bold text-white">Cliquer un panneau pour l'exclure / restaurer — {excludeDepth}mm</span>
              <button onClick={()=>setExcludeMode(false)} className="ba px-3 py-1 rounded-lg text-xs font-bold"
                style={{background:'rgba(255,255,255,.2)',color:'#fff'}}>Terminer</button>
            </div>}
            {/* Legend overlay */}
            {step==='work'&&!show3D&&az&&<div style={{position:'absolute',bottom:12,left:12,zIndex:20,
              background:'rgba(15,17,24,.85)',borderRadius:10,padding:'8px 12px',backdropFilter:'blur(12px)',
              border:'1px solid rgba(255,255,255,.06)',display:'flex',gap:12,alignItems:'center'}}>
              {[{c:RAL_COLORS[zoneRalIdx]?.hex||'#383E42',t:'Panneau',b:'none'},
                {c:'rgba(251,113,133,.3)',t:'Ouverture',b:'2px solid rgba(251,113,133,.8)'},
                {c:'rgba(139,92,246,.3)',t:'Tableau',b:'1px solid rgba(139,92,246,.8)'},
                {c:'rgba(34,211,238,.25)',t:'Linteau',b:'1px solid rgba(34,211,238,.8)'},
                {c:'rgba(52,211,153,.25)',t:'Appui',b:'1px solid rgba(52,211,153,.8)'},
                {c:'rgba(245,158,11,.3)',t:'Joint',b:'1px solid rgba(245,158,11,.7)'},
                {c:'transparent',t:'Ossature',b:'2px dashed rgba(245,158,11,.6)'},
              ].map(l=><div key={l.t} className="flex items-center gap-1.5">
                <div style={{width:12,height:12,borderRadius:3,background:l.c,border:l.b,flexShrink:0}}/>
                <span className="text-[9px] font-medium" style={{color:'var(--t3)'}}>{l.t}</span>
              </div>)}
            </div>}
            <svg ref={svgRef} width="100%" height="100%" style={{display:'block',userSelect:'none'}}>
              {bgSrc&&bgVis&&(step==='calibrate'||step==='zone')&&<image href={bgSrc} x={pan.x} y={pan.y} width={bgW*zoom} height={bgH*zoom} style={{opacity:bgOp}}/>}
              {/* Background plan in work mode - behind zones */}
              {bgSrc&&bgVis&&step==='work'&&<image href={bgSrc} x={pan.x} y={pan.y} width={bgW*zoom} height={bgH*zoom} style={{opacity:Math.min(bgOp,0.25)}}/>}
              {step==='calibrate'&&calPts.map((p,i)=><g key={i}><circle cx={p.x*zoom+pan.x} cy={p.y*zoom+pan.y} r="8" fill="none" stroke="var(--cy)" strokeWidth="2" opacity=".5"/>
                <circle cx={p.x*zoom+pan.x} cy={p.y*zoom+pan.y} r="4" fill="var(--cy)"/></g>)}
              {step==='calibrate'&&calPts.length===2&&<line x1={calPts[0].x*zoom+pan.x} y1={calPts[0].y*zoom+pan.y} x2={calPts[1].x*zoom+pan.x} y2={calPts[1].y*zoom+pan.y} stroke="var(--cy)" strokeWidth="2.5" strokeDasharray="8,4"/>}
              {/* Zone step: drawn zones */}
              {step==='zone'&&zones.map((z,i)=>{const ox=z.facOrigin.x*zoom+pan.x,oy=z.facOrigin.y*zoom+pan.y;
                const ppm=mmPerPx?(1/mmPerPx):manualScale;const fW2=z.L*ppm*zoom,fH2=z.H*ppm*zoom;
                const zCol=ZONE_COLORS[i%8];const rDeg=z.rot||0;const rcx=ox+fW2/2,rcy=oy+fH2/2;
                return<g key={z.id} transform={rDeg?`rotate(${rDeg},${rcx},${rcy})`:undefined}>{z.poly?<path d={z.poly.map((p,j)=>`${j===0?'M':'L'}${ox+p.x*ppm*zoom} ${oy+p.y*ppm*zoom}`).join(' ')+'Z'}
                  fill="rgba(79,110,247,.08)" stroke={zCol} strokeWidth="1.5"/>:
                  <rect x={ox} y={oy} width={fW2} height={fH2} fill="rgba(79,110,247,.08)" stroke={zCol} strokeWidth="1.5" rx="3"/>}
                  <text x={ox+6} y={oy+14} fontSize="11" fontWeight="600" fill={zCol}>{z.name}</text>
                  <text x={ox+6} y={oy+28} fontSize="9" fontWeight="500" fill="var(--t3)" fontFamily="JetBrains Mono">{(z.L/1000).toFixed(2)} x {(z.H/1000).toFixed(2)} m</text>
                  {/* Resize handles */}
                  {!z.poly&&['nw','n','ne','e','se','s','sw','w'].map(h=>{
                    const cx=h.includes('w')?ox:h.includes('e')?ox+fW2:ox+fW2/2;
                    const cy=h.includes('n')?oy:h.includes('s')?oy+fH2:oy+fH2/2;
                    return<rect key={h} x={cx-5} y={cy-5} width={10} height={10} rx="2.5"
                      fill={zCol} stroke="#fff" strokeWidth="1.5" opacity=".85"
                      style={{cursor:h.length===2?h+'-resize':h==='n'||h==='s'?'ns-resize':'ew-resize'}}
                      onMouseDown={e=>{e.stopPropagation();setResizeZone({idx:i,handle:h,startX:e.clientX,startY:e.clientY,origOrigin:{...z.facOrigin},origL:z.L,origH:z.H})}}/>})}
                  {/* Rotation handle */}
                  {!z.poly&&<g>
                    <line x1={ox+fW2/2} y1={oy-6} x2={ox+fW2/2} y2={oy-18} stroke={zCol} strokeWidth="1.5" opacity=".5"/>
                    <circle cx={ox+fW2/2} cy={oy-22} r={6} fill={zCol} stroke="#fff" strokeWidth="1.5" opacity=".85"
                      style={{cursor:'grab'}}
                      onMouseDown={e=>{e.stopPropagation();
                        const rect=cvRef.current.getBoundingClientRect();
                        const ccx=ox+fW2/2,ccy=oy+fH2/2;
                        const startAngle=Math.atan2(e.clientY-rect.top-ccy,e.clientX-rect.left-ccx)*180/Math.PI;
                        setRotateZone({idx:i,startAngle,origRot:z.rot||0})}}/>
                    <text x={ox+fW2/2} y={oy-19} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#fff" fontWeight="700" style={{pointerEvents:'none'}}>↻</text>
                  </g>}
                  {/* Drag handle + delete */}
                  <g style={{cursor:'grab'}} onMouseDown={e=>handleZoneDragStart(e,i)}>
                    <rect x={ox} y={oy+fH2+5} width={Math.min(fW2,120)} height={18} rx="5" fill={zCol} opacity=".85"/>
                    <text x={ox+8} y={oy+fH2+17} fontSize="9" fontWeight="700" fill="#fff" fontFamily="DM Sans">☰ déplacer</text>
                  </g>
                  {zones.length>1&&<g style={{cursor:'pointer'}} onClick={e=>{e.stopPropagation();if(confirm('Supprimer '+z.name+' ?')){setZones(zs=>zs.filter((_,j)=>j!==i))}}}>
                    <rect x={ox+Math.min(fW2,120)+4} y={oy+fH2+5} width={18} height={18} rx="5" fill="#ef4444" opacity=".85"/>
                    <text x={ox+Math.min(fW2,120)+13} y={oy+fH2+17} textAnchor="middle" fontSize="11" fontWeight="700" fill="#fff">×</text>
                  </g>}
                </g>})}
              {/* Polygon drawing preview */}
              {step==='zone'&&polyMode&&polyPts.length>0&&<g>
                <polyline points={polyPts.map(p=>`${p.sx*zoom+pan.x},${p.sy*zoom+pan.y}`).join(' ')} fill="none" stroke="var(--gn)" strokeWidth="2" strokeDasharray="6,4"/>
                {polyPts.map((p,i)=><circle key={i} cx={p.sx*zoom+pan.x} cy={p.sy*zoom+pan.y} r={i===0?6:4} fill={i===0?'var(--gn)':'var(--cy)'} stroke="#fff" strokeWidth="1.5"/>)}
                {polyPts.length>=3&&<circle cx={polyPts[0].sx*zoom+pan.x} cy={polyPts[0].sy*zoom+pan.y} r="12" fill="none" stroke="var(--gn)" strokeWidth="1" strokeDasharray="3,3" opacity=".5"/>}
              </g>}
              {/* Rectangle zone drawing */}
              {step==='zone'&&!polyMode&&zoneStart&&zoneCur&&(()=>{const sc=mmPerPx||(1/manualScale);
                const x1=Math.min(zoneStart.x,zoneCur.x)*zoom+pan.x,y1=Math.min(zoneStart.y,zoneCur.y)*zoom+pan.y;
                const w=Math.abs(zoneCur.x-zoneStart.x)*zoom,h=Math.abs(zoneCur.y-zoneStart.y)*zoom;
                return<g><rect x={x1} y={y1} width={w} height={h} fill="rgba(52,211,153,.1)" stroke="var(--gn)" strokeWidth="2" strokeDasharray="8,4" rx="3"/>
                  {w>60&&<text x={x1+w/2} y={y1-8} textAnchor="middle" fontSize="12" fontWeight="700" fill="var(--gn)" fontFamily="JetBrains Mono">
                    {(Math.abs(zoneCur.x-zoneStart.x)*sc/1000).toFixed(2)} x {(Math.abs(zoneCur.y-zoneStart.y)*sc/1000).toFixed(2)} m</text>}</g>})()}
              {/* WORK: all zones */}
              {step==='work'&&zones.map((z,i)=><ZoneView key={z.id} z={z} zCalc={allCalcs[i]} isActive={i===activeZoneIdx} idx={i}/>)}
              {step==='work'&&drawRect&&drawRect.w>0&&drawRect.h>0&&az&&(()=>{const ppZ=pxPerMm_eff*zoom;const ox=az.facOrigin.x*zoom+pan.x,oy=az.facOrigin.y*zoom+pan.y;
                return<rect x={ox+drawRect.x*ppZ} y={oy+drawRect.y*ppZ} width={drawRect.w*ppZ} height={drawRect.h*ppZ} fill="rgba(79,110,247,.15)" stroke="var(--bl)" strokeWidth="2" strokeDasharray="6,4" rx="2"/>})()}
              {/* DXF vector overlay */}
              {step==='work'&&dxfData&&bgSrc&&(()=>{
                const ppm=pxPerMm_eff;const b=dxfData.bounds;
                const dxfW=b.maxX-b.minX,dxfH=b.maxY-b.minY;
                const scX=bgW/dxfW,scY=bgH/dxfH,sc=Math.min(scX,scY);
                const ox2=0,oy2=0;
                return<g opacity=".4">{dxfData.lines.slice(0,5000).map((l,i)=>{
                  const x1=(ox2+(l.x1-b.minX)*sc)*zoom+pan.x;
                  const y1=(oy2+(dxfH-(l.y1-b.minY))*sc)*zoom+pan.y;
                  const x2=(ox2+(l.x2-b.minX)*sc)*zoom+pan.x;
                  const y2=(oy2+(dxfH-(l.y2-b.minY))*sc)*zoom+pan.y;
                  return<line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke="var(--cy)" strokeWidth=".5"/>})}</g>})()}
              {/* Measurement lines */}
              {step==='work'&&measures.map(m=>{const ppZ=pxPerMm_eff*zoom;
                const zOx=az?az.facOrigin.x*zoom+pan.x:pan.x,zOy=az?az.facOrigin.y*zoom+pan.y:pan.y;
                const x1=zOx+m.p0.x*ppZ,y1=zOy+m.p0.y*ppZ,x2=zOx+m.p1.x*ppZ,y2=zOy+m.p1.y*ppZ;
                const mx=(x1+x2)/2,my=(y1+y2)/2;
                return<g key={m.id}>
                  <line x1={x1} y1={y1} x2={x2} y2={y2} stroke="#f59e0b" strokeWidth="2" strokeDasharray="4,3"/>
                  <circle cx={x1} cy={y1} r="3" fill="#f59e0b" stroke="#fff" strokeWidth="1"/>
                  <circle cx={x2} cy={y2} r="3" fill="#f59e0b" stroke="#fff" strokeWidth="1"/>
                  <rect x={mx-22} y={my-9} width="44" height="16" rx="4" fill="rgba(0,0,0,.8)"/>
                  <text x={mx} y={my+3} textAnchor="middle" fontSize="10" fontWeight="700" fill="#fbbf24" fontFamily="JetBrains Mono">{m.dist>=1000?(m.dist/1000).toFixed(2)+'m':m.dist+'mm'}</text>
                  <text x={x2+6} y={y2-4} fontSize="8" fill="#f59e0b" style={{cursor:'pointer'}} onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))}>✕</text>
                </g>})}
              {/* Measurement in progress */}
              {step==='work'&&measureMode&&measurePts.length===1&&az&&(()=>{
                const ppZ=pxPerMm_eff*zoom;
                const zOx=az.facOrigin.x*zoom+pan.x,zOy=az.facOrigin.y*zoom+pan.y;
                const x1=zOx+measurePts[0].x*ppZ,y1=zOy+measurePts[0].y*ppZ;
                return<g><circle cx={x1} cy={y1} r="5" fill="none" stroke="#f59e0b" strokeWidth="2"><animate attributeName="r" values="4;8;4" dur="1.5s" repeatCount="indefinite"/></circle></g>})()}
            {lasso&&lasso.w>5&&lasso.h>5&&az&&(()=>{const ppZ2=zoom*(pxPerMm_eff||manualScale||0.15);const ox=(az.facOrigin?.x||0)*zoom+pan.x,oy=(az.facOrigin?.y||0)*zoom+pan.y;
              return<rect x={lasso.x*ppZ2+ox} y={lasso.y*ppZ2+oy} width={lasso.w*ppZ2} height={lasso.h*ppZ2} fill="rgba(79,110,247,.08)" stroke="rgba(79,110,247,.7)" strokeWidth="1.5" strokeDasharray="5,3"/>})()}
            </svg></div></div>

        {/* RIGHT */}
        {step==='work'&&C&&az&&(
          <div className="w-[270px] flex-shrink-0 border-l flex flex-col" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex border-b flex-shrink-0 overflow-x-auto" style={{borderColor:'var(--bd)'}}>
              {[{id:'resultats',l:'Résultats'},{id:'ral',l:'🎨 RAL'},{id:'menuiseries',l:'Cassettes'},{id:'decoupe',l:'Découpe'},{id:'metre',l:'Métré'}].map(t=>(
                <button key={t.id} onClick={()=>setRightTab(t.id)} className={`tb flex-1 ${rightTab===t.id?'on':''}`}>{t.l}</button>))}</div>
            <div className="flex-1 overflow-y-auto p-2.5 space-y-2.5">
              {rightTab==='ral'&&<>
                <div className="cd p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-6 h-6 rounded-lg" style={{background:RAL_COLORS[zoneRalIdx]?.hex,border:'2px solid rgba(255,255,255,.15)'}}/>
                    <div><div className="text-xs font-bold">{RAL_COLORS[zoneRalIdx]?.code}</div>
                    <div className="text-[9px]" style={{color:'var(--t3)'}}>{RAL_COLORS[zoneRalIdx]?.name}{RAL_COLORS[zoneRalIdx]?.finish?' • '+RAL_COLORS[zoneRalIdx].finish:''}</div></div>
                  </div>
                  {/* Category tabs */}
                  <div className="flex flex-wrap gap-1 mb-2.5">
                    {RAL_CATS.map(cat=><button key={cat} onClick={()=>setRalCat(cat)}
                      className="ba px-2 py-1 rounded-md text-[9px] font-bold"
                      style={{background:ralCat===cat?'var(--blg)':'var(--inp)',border:`1px solid ${ralCat===cat?'var(--bl)':'var(--bd)'}`,
                        color:ralCat===cat?'var(--bl)':'var(--t3)'}}>{cat}</button>)}
                  </div>
                  {/* Color grid filtered by category */}
                  <div className="grid grid-cols-6 gap-1.5">
                    {RAL_COLORS.map((r,i)=>r.cat===ralCat?<button key={r.code} onClick={()=>setZoneRal(i)}
                      className="ba relative" title={`${r.code} — ${r.name}${r.finish?' ('+r.finish+')':''}`}
                      style={{width:34,height:34,borderRadius:8,background:r.hex,border:i===zoneRalIdx?'3px solid var(--bl)':'2px solid rgba(255,255,255,.08)',
                        boxShadow:i===zoneRalIdx?'0 0 12px rgba(79,110,247,.4)':'none',transform:i===zoneRalIdx?'scale(1.12)':'scale(1)',transition:'.15s'}}>
                      {i===zoneRalIdx&&<div style={{position:'absolute',inset:-1,borderRadius:8,border:'2px solid #fff',opacity:.4}}/>}
                      {r.finish&&<div style={{position:'absolute',bottom:1,right:1,width:6,height:6,borderRadius:3,
                        background:r.finish==='brillant'?'#fff':r.finish==='mat'?'#555':r.finish==='brossé'?'#999':r.finish==='métallisé'?'#ccc':'#a85',opacity:.8}}/>}
                    </button>:null)}
                  </div>
                </div>
                <button onClick={()=>setShow3D(true)} className="ba w-full py-2.5 rounded-xl text-sm font-bold text-white flex items-center justify-center gap-2"
                  style={{background:'linear-gradient(135deg,var(--pp),var(--bl))',boxShadow:'0 4px 15px rgba(79,110,247,.25)'}}>
                  🧊 Vue 3D</button>
              </>}
              {rightTab==='resultats'&&<>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--bl)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--bl)'}}>Surfaces</span></div>
                  <RR label="Brute" value={C.sBr.toFixed(2)} unit="m2"/><RR label="Ouvertures" value={`-${C.sOuv.toFixed(2)}`} unit="m2" color="var(--rs)" sub/>
                  <RR label="Nette" value={C.sNet.toFixed(2)} unit="m2" color="var(--bl)" bold/></div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--pp)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--pp)'}}>Panneaux</span></div>
                  <RR label="Calepinage" value={`${C.nC}x${C.nR}`}/><RR label="Total" value={C.nP} unit="u" color="var(--pp)"/>
                  {(az.exclusions||[]).length>0&&<RR label="Exclus (balcons)" value={`-${(az.exclusions||[]).length}`} unit="u" color="var(--rs)" sub/>}
                  <RR label="Impactes" value={C.pImp} unit="u" color="var(--am)" sub/>
                  <RR label="Bord poly." value={C.edgePanels.length} unit="u" color="var(--cy)" sub/><RR label="Chutes" value={C.chut.toFixed(1)} unit="%" color={C.chut>15?'var(--rs)':'var(--gn)'}/>
                  {(C.jGapH>0||C.jGapV>0||C.jGapsH?.some(v=>v>0)||C.jGapsV?.some(v=>v>0))&&<RR label="Joints" value={`Déf: ${(C.jGapH*1000).toFixed(0)}/${(C.jGapV*1000).toFixed(0)}${C.jGapsH?.filter(v=>v!==null&&v!==(az.jointH||0)).length?` + ${C.jGapsH.filter(v=>v!==null&&v!==(az.jointH||0)).length} ind.`:''}`} unit="mm" color="var(--am)"/>}</div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--am)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--am)'}}>Ossature</span></div>
                  <RR label="Montants" value={C.lMN.toFixed(1)} unit="ml"/><RR label="Lisses" value={C.lLN.toFixed(1)} unit="ml"/><RR label="Total" value={C.tOss.toFixed(1)} unit="ml" color="var(--am)" bold/></div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--cy)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--cy)'}}>Encadrements</span></div>
                  <RR label="Tableaux" value={C.totEnc.tab.toFixed(2)} unit="ml"/><RR label="Linteaux" value={C.totEnc.lin.toFixed(2)} unit="ml"/><RR label="Appuis" value={C.totEnc.app.toFixed(2)} unit="ml"/>
                  <RR label="Total" value={C.totEnc.tot.toFixed(2)} unit="ml" color="var(--cy)" bold/></div>
                {C.totCassettes&&C.totCassettes.pliees>0&&<div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--pp)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--pp)'}}>Cassettes pliées</span></div>
                  <RR label="Plis" value={C.totCassettes.pliees} unit="pièces"/>
                  <RR label="Panneaux pliés" value={new Set(C.totCassettes.detail.map(d=>d.panRef)).size} unit="pan." color="var(--am)" sub/>
                  <RR label="Surface" value={C.totCassettes.surfTot.toFixed(2)} unit="m²" bold color="var(--pp)"/>
                  <RR label="ML total" value={C.totCassettes.mlTot.toFixed(2)} unit="ml"/></div>}
                <div className="cd p-2.5"><div className="grid grid-cols-2 gap-2">
                  <div className="text-center p-1.5 rounded-lg" style={{background:'var(--inp)'}}><div className="rv text-base">{C.tFix}</div><div className="text-[9px]" style={{color:'var(--t3)'}}>Fixations</div></div>
                  <div className="text-center p-1.5 rounded-lg" style={{background:'var(--inp)'}}><div className="rv text-base">{C.tEq}</div><div className="text-[9px]" style={{color:'var(--t3)'}}>Equerres</div></div></div></div>
                {/* Global summary */}
                {zones.length>1&&<div className="cd p-2.5"><div className="text-[9px] font-bold uppercase tracking-widest mb-1.5" style={{color:'var(--t2)'}}>Total {zones.length} zones</div>
                  {(()=>{const totals=allCalcs.reduce((a,c)=>c?{sNet:a.sNet+c.sNet,nP:a.nP+c.nP,tOss:a.tOss+c.tOss,tFix:a.tFix+c.tFix}:a,{sNet:0,nP:0,tOss:0,tFix:0});
                    return<><RR label="Surface nette" value={totals.sNet.toFixed(2)} unit="m2" color="var(--bl)" bold/><RR label="Panneaux" value={totals.nP} unit="u"/><RR label="Ossature" value={totals.tOss.toFixed(1)} unit="ml"/></>})()}
                </div>}
              </>}
              {rightTab==='menuiseries'&&<>
                <div className="text-[9px] font-bold uppercase tracking-widest mb-1" style={{color:'var(--cy)'}}>Encadrements & Cassettes</div>
                {C.menuDet.length===0&&<p className="text-[11px] py-3 text-center" style={{color:'var(--t3)'}}>Aucune ouverture</p>}
                {C.menuDet.map((m,i)=><div key={m.id} className="cd p-2.5 space-y-2 afu">
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-bold" style={{color:'var(--rs)'}}>O{i+1} — {m.t}</span>
                    <div className="flex items-center gap-1.5"><button onClick={()=>setCoupeOuv(i)} className="ba px-2 py-0.5 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.08)',border:'1px solid rgba(139,92,246,.2)',color:'var(--pp)'}}>Coupe</button><span className="mn text-[10px]" style={{color:'var(--t3)'}}>{m.w}×{m.h}</span></div>
                  </div>
                  {/* Retour depths */}
                  <div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="text-[9px] font-bold mb-1.5" style={{color:'var(--pp)'}}>Profondeur retours (mm)</div>
                    <div className="grid grid-cols-2 gap-1">
                      <NI compact label="Tab. G" value={m.retours?.tG||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tG:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Tab. D" value={m.retours?.tD||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tD:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Linteau" value={m.retours?.lin||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),lin:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Appui" value={m.retours?.app||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),app:v}}:o)}))} unit="mm" step={10} min={0}/>
                    </div>
                    <div className="mt-1"><NI compact label="Face visible" value={m.faceVis||50} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,faceVis:v}:o)}))} unit="mm" step={5} min={0}/></div>
                  </div>
                  {/* Cassettes table — per impacted panel with toggle */}
                  {(()=>{
                    const allImp=(C.activePanels||[]).filter(p=>p.adjSides&&p.adjSides.some(s=>s.ouvIdx===m.idx));
                    const allFolds=allImp.flatMap(p=>p.adjSides.filter(s=>s.ouvIdx===m.idx).map(s=>({...s,panRef:p.subRef})));
                    const activeFolds=allFolds.filter(f=>!f.disabled);
                    if(allFolds.length===0)return<div className="text-[9px]" style={{color:'var(--t3)',fontStyle:'italic'}}>Ouverture non intersectée par des panneaux</div>;
                    const sN={tG:'Tab.G',tD:'Tab.D',lin:'Lint.',app:'Appui'};
                    return<>
                      <div className="text-[9px] font-bold" style={{color:'var(--pp)'}}>Plis ({activeFolds.length}/{allFolds.length} actifs sur {new Set(allFolds.map(f=>f.panRef)).size} pan.)</div>
                      <table className="dtbl"><thead><tr><th></th><th>Pan.</th><th>Pli</th><th style={{textAlign:'right'}}>L</th><th style={{textAlign:'right'}}>Ret.</th><th style={{textAlign:'right'}}>Dév.</th><th style={{textAlign:'right'}}>m²</th></tr></thead><tbody>
                        {allFolds.map((f,j)=><tr key={j} style={{opacity:f.disabled?.45:1}}>
                          <td><input type="checkbox" checked={!f.disabled} onChange={()=>{
                            updateAZ(zz=>{const df={...(zz._disabledFolds||{})};const k=f.panRef+'-'+f.side+'-'+f.ouvIdx;
                            df[k]=!df[k];return{...zz,_disabledFolds:df};});
                          }} style={{accentColor:'var(--pp)',width:11,height:11,cursor:'pointer'}}/></td>
                          <td className="mn" style={{color:'var(--am)'}}>{f.panRef}</td>
                          <td style={{color:f.disabled?'var(--t3)':'var(--pp)'}}>{sN[f.side]||f.side}</td>
                          <td className="mn" style={{textAlign:'right'}}>{f.foldL}</td>
                          <td className="mn" style={{textAlign:'right'}}>{f.retour}</td>
                          <td className="mn" style={{textAlign:'right'}}>{f.devRetour}</td>
                          <td className="mn" style={{textAlign:'right'}}>{(f.foldL*f.devRetour/1e6).toFixed(3)}</td>
                        </tr>)}
                        {activeFolds.length>0&&<tr style={{background:'var(--gnd)'}}><td/><td colSpan="2" className="font-bold" style={{color:'var(--gn)'}}>Total actifs</td>
                          <td className="mn font-bold" style={{textAlign:'right',color:'var(--gn)'}}>{activeFolds.reduce((a,f)=>a+f.foldL/1000,0).toFixed(1)} ml</td>
                          <td/><td/>
                          <td className="mn font-bold" style={{textAlign:'right',color:'var(--gn)'}}>{activeFolds.reduce((a,f)=>a+f.foldL*f.devRetour/1e6,0).toFixed(3)}</td>
                        </tr>}
                      </tbody></table>
                    </>;
                  })()}
                  {/* ML encadrements (ossature) */}
                  <div className="flex justify-between text-[10px] px-1"><span style={{color:'var(--t3)'}}>Encadr. ossature</span>
                    <span className="mn font-bold" style={{color:'var(--cy)'}}>{m.encTotal.toFixed(3)} ml</span></div>
                  {m.impPanels.length>0&&<div className="flex flex-wrap gap-1"><span className="text-[9px]" style={{color:'var(--t3)'}}>Pan.:</span>
                    {m.impPanels.map(r=><span key={r} className="imp-tag" style={{background:'var(--amd)',color:'var(--am)'}}>{r}</span>)}</div>}
                </div>)}
                {/* Totaux cassettes */}
                {C.menuDet.length>0&&<div className="cd p-2.5 space-y-1.5">
                  <div className="text-[9px] font-bold uppercase" style={{color:'var(--pp)'}}>Récap cassettes pliées</div>
                  {(()=>{
                    const det=C.totCassettes.detail||[];
                    const bySide={tG:[],tD:[],lin:[],app:[]};
                    det.forEach(d=>{const sk=d.side||'app';if(bySide[sk])bySide[sk].push(d)});
                    const sideInfo=[
                      {key:'tG',label:'Tableau Gauche',icon:'◀',color:'#f59e0b'},
                      {key:'tD',label:'Tableau Droit',icon:'▶',color:'#3b82f6'},
                      {key:'lin',label:'Linteau',icon:'▲',color:'#8b5cf6'},
                      {key:'app',label:'Appui',icon:'▼',color:'#10b981'}
                    ];
                    const uniquePans=new Set(det.map(d=>d.panRef));
                    return<>
                      {/* Compteurs par côté */}
                      <div className="grid grid-cols-2 gap-1.5 mb-2">
                        {sideInfo.map(si=><div key={si.key} className="rounded-lg p-2 text-center" style={{background:bySide[si.key].length?si.color+'18':'var(--inp)',border:'1px solid '+(bySide[si.key].length?si.color+'40':'var(--bd)')}}>
                          <div style={{fontSize:16,lineHeight:1}}>{si.icon}</div>
                          <div className="mn font-bold" style={{fontSize:14,color:bySide[si.key].length?si.color:'var(--t3)'}}>{bySide[si.key].length}</div>
                          <div style={{fontSize:8,color:bySide[si.key].length?si.color:'var(--t3)',fontWeight:600}}>{si.label}</div>
                        </div>)}
                      </div>
                      {/* Totaux */}
                      <div className="rounded-lg p-2 mb-2" style={{background:'var(--ppd)',border:'1px solid rgba(196,50,74,.25)'}}>
                        <div className="flex justify-between text-[10px] mb-1"><span style={{color:'var(--pp)',fontWeight:700}}>Total plis</span><span className="mn font-bold" style={{color:'var(--pp)'}}>{C.totCassettes.pliees} pcs</span></div>
                        <div className="flex justify-between text-[10px] mb-1"><span style={{color:'var(--t3)'}}>Panneaux concernés</span><span className="mn font-bold" style={{color:'var(--am)'}}>{uniquePans.size} pan.</span></div>
                        <div className="flex justify-between text-[10px] mb-1"><span style={{color:'var(--t3)'}}>Surface cassettes</span><span className="mn font-bold" style={{color:'var(--pp)'}}>{C.totCassettes.surfTot.toFixed(2)} m²</span></div>
                        <div className="flex justify-between text-[10px]"><span style={{color:'var(--t3)'}}>ML total</span><span className="mn font-bold">{C.totCassettes.mlTot.toFixed(2)} ml</span></div>
                      </div>
                      {/* Liste détaillée par côté */}
                      {sideInfo.filter(si=>bySide[si.key].length>0).map(si=><div key={si.key} className="space-y-1 mb-2">
                        <div className="flex items-center gap-1.5 px-1"><span style={{fontSize:11}}>{si.icon}</span><span className="text-[9px] font-bold uppercase" style={{color:si.color}}>{si.label} ({bySide[si.key].length})</span></div>
                        <table className="dtbl"><thead><tr><th>Panneau</th><th>Ouverture</th><th style={{textAlign:'right'}}>L (mm)</th><th style={{textAlign:'right'}}>Dév.</th><th style={{textAlign:'right'}}>m²</th></tr></thead><tbody>
                          {bySide[si.key].map((d,j)=><tr key={j}>
                            <td className="mn font-bold" style={{color:'var(--am)'}}>{d.panRef}</td>
                            <td style={{color:'var(--t3)',fontSize:9}}>{d.ouvName}</td>
                            <td className="mn" style={{textAlign:'right'}}>{d.L}</td>
                            <td className="mn" style={{textAlign:'right'}}>{d.dev}</td>
                            <td className="mn" style={{textAlign:'right'}}>{(d.L*d.dev/1e6).toFixed(3)}</td>
                          </tr>)}
                          <tr style={{background:'var(--gnd)'}}><td colSpan="2" className="font-bold" style={{color:si.color,fontSize:9}}>Sous-total</td>
                            <td className="mn font-bold" style={{textAlign:'right',color:si.color}}>{bySide[si.key].reduce((a,d)=>a+d.L,0)} mm</td>
                            <td/>
                            <td className="mn font-bold" style={{textAlign:'right',color:si.color}}>{bySide[si.key].reduce((a,d)=>a+d.L*d.dev/1e6,0).toFixed(3)}</td>
                          </tr>
                        </tbody></table>
                      </div>)}
                    </>;
                  })()}
                </div>}
                {C.menuDet.length>0&&<div className="cd p-2.5"><RR label="Total encadr. ossature" value={C.totEnc.tot.toFixed(2)} unit="ml" color="var(--gn)" bold/></div>}
              </>}
              {rightTab==='decoupe'&&<>
                <div className="text-[9px] font-bold uppercase tracking-widest mb-1" style={{color:'var(--am)'}}>Panneaux impactés — {C.pImp}u / {C.nP} total</div>
                {C.pImp===0&&<p className="text-[11px] py-3 text-center" style={{color:'var(--t3)'}}>Aucun panneau impacté. Ajoutez une ouverture pour voir les découpes.</p>}
                {(()=>{
                  const impPans=C.activePanels?C.activePanels.filter(p=>p.isImpacted||(p.adjSides&&p.adjSides.length>0)):[];
                  const basePw=Math.round(C.pw*1000),basePh=Math.round(C.ph*1000);
                  return impPans.map((pm,i)=>{
                    const pw3=Math.round(pm.pWa*1000),ph3=Math.round(pm.pHa*1000);
                    const hasFolds=pm.adjSides&&pm.adjSides.length>0;
                    const sideNames={tG:'Tableau G',tD:'Tableau D',lin:'Linteau',app:'Appui'};
                    return<div key={i} className="cd p-2.5 space-y-1.5 afu">
                      <div className="flex items-center justify-between">
                        <span className="mn text-xs font-bold" style={{color:'var(--am)'}}>Pan. {pm.subRef}</span>
                        <span className="text-[9px] px-2 py-0.5 rounded-full font-bold" style={{background:hasFolds?'rgba(167,139,250,.15)':'var(--amd)',
                          color:hasFolds?'var(--pp)':'var(--am)'}}>{hasFolds?'Plié':'Découpé'}</span>
                      </div>
                      <div className="grid grid-cols-2 gap-1 text-[9px]" style={{color:'var(--t3)'}}>
                        <div>Dim: <b className="mn" style={{color:'var(--t1)'}}>{pw3}×{ph3}</b></div>
                        <div>Base: <b className="mn" style={{color:'var(--bl)'}}>{basePw}×{basePh}</b></div>
                        <div>Surf: <b className="mn" style={{color:'var(--gn)'}}>{(pw3*ph3/1e6).toFixed(3)} m²</b></div>
                        <div>Parent: <b className="mn">{pm.ref}</b></div>
                      </div>
                      {hasFolds&&<div className="rounded-lg overflow-hidden" style={{border:'1px solid rgba(167,139,250,.2)'}}>
                        {pm.adjSides.map((s,si)=>{
                          const o=az.ouvs[s.ouvIdx];const oName=o?`${o.t||'Ouv.'} ${s.ouvIdx+1}`:'?';
                          const panDim=s.side==='tG'||s.side==='tD'?ph3:pw3;
                          const devTotal=panDim+s.retour+s.faceVis+10;
                          return<div key={si} className="px-2.5 py-1.5 text-[9px]" style={{background:si%2===0?'rgba(167,139,250,.06)':'var(--inp)',opacity:s.disabled?.7:1}}>
                            <div className="flex justify-between items-center mb-0.5">
                              <div className="flex items-center gap-1.5">
                                <input type="checkbox" checked={!s.disabled} onChange={()=>{
                                  updateAZ(zz=>{const pm2=zz._disabledFolds||{};const k2=pm.subRef+'-'+s.side+'-'+s.ouvIdx;
                                  pm2[k2]=!pm2[k2];return{...zz,_disabledFolds:{...pm2}};});
                                }} style={{accentColor:'var(--pp)',width:12,height:12}}/>
                                <b style={{color:s.disabled?'var(--t3)':'var(--pp)'}}>{sideNames[s.side]||s.side}</b>
                              </div>
                              <span style={{color:'var(--t3)'}}>{oName}</span>
                            </div>
                            <div className="grid grid-cols-3 gap-1 mn" style={{color:'var(--t2)'}}>
                              <span>Ret: <b>{s.retour}</b></span>
                              <span>FV: <b>{s.faceVis}</b></span>
                              <span>Pli: <b>10</b></span>
                            </div>
                            <div className="mt-0.5 font-bold" style={{color:'var(--bl)',fontSize:10}}>
                              Dév: {devTotal} mm <span style={{color:'var(--t3)',fontWeight:400,fontSize:8}}>= {panDim}+{s.retour}+{s.faceVis}+10</span>
                            </div>
                          </div>})}
                      </div>}
                      {!hasFolds&&<div className="text-[9px] px-2 py-1.5 rounded-lg" style={{background:'var(--amd)',color:'var(--am)'}}>
                        Panneau découpé (dim ≠ base {basePw}×{basePh})</div>}
                    </div>})})()}
              </>}
              {rightTab==='metre'&&<>
                <div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'var(--gn)'}}>COMPARATIF ZONES</div>
                  <div className="space-y-1.5">{zones.map((z,i)=>{const c2=allCalcs[i];if(!c2)return null;
                    return<div key={z.id} className="rounded-lg p-2" style={{background:i===activeZoneIdx?'var(--blg)':'var(--inp)',border:`1px solid ${i===activeZoneIdx?ZONE_COLORS[i%8]:'var(--bd)'}`,cursor:'pointer'}} onClick={()=>setActiveZoneIdx(i)}>
                      <div className="flex items-center gap-1.5 mb-1"><div className="w-2.5 h-2.5 rounded-sm" style={{background:ZONE_COLORS[i%8]}}/><span className="text-[10px] font-bold" style={{color:ZONE_COLORS[i%8]}}>{z.name}</span></div>
                      <div className="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[9px]">
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>S.nette</span><span className="mn font-bold" style={{color:'var(--bl)'}}>{c2.sNet.toFixed(2)} m²</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Panneaux</span><span className="mn font-bold" style={{color:'var(--t1)'}}>{c2.nP}u</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Ossature</span><span className="mn" style={{color:'var(--t2)'}}>{c2.tOss.toFixed(1)} ml</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Chutes</span><span className="mn" style={{color:c2.chut<10?'var(--gn)':c2.chut<20?'var(--am)':'var(--rs)'}}>{c2.chut.toFixed(1)}%</span></div>
                      </div>
                    </div>})}</div>
                </div>
                {zones.length>1&&<div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'var(--am)'}}>Σ TOTAUX ({zones.length} zones)</div>
                  {(()=>{const totS=allCalcs.reduce((a,c)=>a+(c?.sNet||0),0);const totP=allCalcs.reduce((a,c)=>a+(c?.nP||0),0);
                    const totOss=allCalcs.reduce((a,c)=>a+(c?.tOss||0),0);const totFix=allCalcs.reduce((a,c)=>a+(c?.tFix||0),0);
                    const totEq=allCalcs.reduce((a,c)=>a+(c?.tEq||0),0);const totJ=allCalcs.reduce((a,c)=>a+(c?.tJ||0),0);
                    const totEnc=allCalcs.reduce((a,c)=>a+(c?.totEnc?.tot||0),0);const totBr=allCalcs.reduce((a,c)=>a+(c?.sBr||0),0);
                    return<div className="space-y-1 text-[10px]">
                      <RR label="Surface brute" value={totBr.toFixed(2)} unit="m²"/>
                      <RR label="Surface nette" value={totS.toFixed(2)} unit="m²" bold color="var(--bl)"/>
                      <RR label="Panneaux" value={totP} unit="u" bold/><RR label="Ossature" value={totOss.toFixed(1)} unit="ml"/>
                      <RR label="Fixations" value={totFix} unit="u"/><RR label="Équerres" value={totEq} unit="u"/>
                      <RR label="Joints" value={totJ.toFixed(1)} unit="ml"/>
                      <RR label="Encadrements" value={totEnc.toFixed(1)} unit="ml" color="var(--gn)"/>
                    </div>})()}
                </div>}
                {measures.length>0&&<div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'#f59e0b'}}>📏 MESURES ({measures.length})</div>
                  <div className="space-y-1">{measures.map((m,i)=><div key={m.id} className="flex items-center justify-between">
                    <span className="text-[10px]" style={{color:'var(--t3)'}}>M{i+1}</span>
                    <span className="mn text-[10px] font-bold" style={{color:'#fbbf24'}}>{m.dist>=1000?(m.dist/1000).toFixed(3)+' m':m.dist+' mm'}</span>
                    <button onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))} className="text-[9px]" style={{color:'var(--rs)'}}>✕</button>
                  </div>)}</div>
                  {measures.length>1&&<div className="flex justify-between mt-1.5 pt-1.5" style={{borderTop:'1px solid var(--bd)'}}>
                    <span className="text-[10px] font-bold" style={{color:'#f59e0b'}}>Σ Total</span>
                    <span className="mn text-[10px] font-bold" style={{color:'#fbbf24'}}>{(measures.reduce((a,m)=>a+m.dist,0)/1000).toFixed(3)} m</span>
                  </div>}
                </div>}
                <button onClick={()=>setMetreOpen(true)} className="ba w-full py-2 rounded-lg text-[10px] font-medium flex items-center justify-center gap-1"
                  style={{background:'var(--gnd)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Tableau complet multi-zones</button>
              </>}
            </div></div>)}
      </div>

      {/* PANEL EDITOR POPUP — compact, follows plan */}
      {editPanel&&az&&C&&(()=>{
        const pm=C.panelMap.find(p=>p.col===editPanel.col&&p.row===editPanel.row);
        if(!pm||pm.isVoid){setEditPanel(null);return null}
        const panW=Math.round(pm.pWa*1000),panH=Math.round(pm.pHa*1000);
        const pCol=pm.parentCol,pRow=pm.parentRow;
        const ralHex=RAL_COLORS[az?.ralIdx??ralIdx]?.hex||'#383E42';
        // Compute screen position from panel coords + zoom/pan
        const ppZ=zoom*(pxPerMm_eff||manualScale||0.15);
        const scrX=(pm.pLeft*ppZ+pan.x+(az.facOrigin?.x||0)*zoom)*1+30;
        const scrY=(pm.pTop*ppZ+pan.y+(az.facOrigin?.y||0)*zoom)*1;
        const rect=cvRef.current?.getBoundingClientRect()||{left:0,top:0,width:800,height:600};
        const popW=235,popMaxH=420;
        let lf=rect.left+scrX+pm.pWa*ppZ+8;
        let tp=rect.top+scrY;
        if(lf+popW>window.innerWidth-10)lf=rect.left+scrX-popW-8;
        if(tp+popMaxH>window.innerHeight-10)tp=window.innerHeight-popMaxH-10;
        if(tp<10)tp=10;if(lf<10)lf=10;
        return<div style={{position:'fixed',left:lf,top:tp,zIndex:200,width:popW,maxHeight:popMaxH,
          background:'var(--pnl)',border:'1.5px solid var(--bl)',borderRadius:10,
          boxShadow:'0 8px 30px rgba(0,0,0,.12)',overflowY:'auto',overflowX:'hidden',maxHeight:Math.min(popMaxH,window.innerHeight-tp-10)}}>
          {/* Header compact */}
          <div style={{padding:'6px 10px',borderBottom:'1px solid var(--bd)',background:'var(--crd)'}}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-1.5">
                <div style={{width:20,height:20,borderRadius:4,background:ralHex,display:'flex',alignItems:'center',justifyContent:'center'}}>
                  <span style={{fontSize:7,fontWeight:700,color:'#fff',fontFamily:'monospace'}}>{pm.subRef}</span></div>
                <div><span className="text-[11px] font-bold" style={{color:'var(--t1)'}}>Panneau {pm.subRef}</span>
                  <span className="text-[8px] ml-1" style={{color:'var(--t3)'}}>C{pm.col+1} L{pm.row+1}</span></div>
              </div>
              <button onClick={()=>setEditPanel(null)} className="w-5 h-5 rounded flex items-center justify-center text-[10px]"
                style={{color:'var(--t3)',border:'1px solid var(--bd)'}}>✕</button>
            </div>
          </div>
          {/* Dims row */}
          <div className="flex gap-1 px-2 py-1.5" style={{borderBottom:'1px solid var(--bd)'}}>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(196,50,74,.08)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>L</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--bl)'}}>{panW}</div></div>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(13,148,136,.06)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>H</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--gn)'}}>{panH}</div></div>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(139,92,246,.06)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>m²</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--pp)'}}>{(panW*panH/1e6).toFixed(2)}</div></div>
          </div>
          {/* Tags */}
          {(pm.isImpacted||pm.polyEdge)&&<div className="flex gap-1 px-2 py-1" style={{borderBottom:'1px solid var(--bd)'}}>
            {pm.isImpacted&&<span className="text-[8px] font-bold px-1.5 py-0.5 rounded" style={{background:'var(--amd)',color:'var(--am)'}}>✂ Impacté</span>}
            {pm.polyEdge&&<span className="text-[8px] font-bold px-1.5 py-0.5 rounded" style={{background:'rgba(34,211,238,.08)',color:'var(--cy)'}}>◇ Bord</span>}
          </div>}
          {/* Edit dims */}
          <div className="px-2 py-1.5 space-y-1.5" style={{borderBottom:'1px solid var(--bd)'}}>
            <div className="flex items-center gap-1.5">
              <span className="text-[8px] font-bold" style={{color:'var(--am)',minWidth:28}}>↔ Col</span>
              <input type="number" defaultValue={(az.colWidths||[])[pCol]||az.pan_.l||600}
                className="flex-1 px-2 py-1 rounded text-[11px] mn font-bold idark" id="ep-colw" onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){const v=parseFloat(e.target.value);if(!v||v<50)return;
                  updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=pCol)cw.push(null);cw[pCol]=v;return{...z,colWidths:cw}});setEditPanel(null)}}}/>
              <button onClick={()=>{const el=document.getElementById('ep-colw');const v=parseFloat(el?.value);if(!v||v<50)return;
                updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=pCol)cw.push(null);cw[pCol]=v;return{...z,colWidths:cw}});setEditPanel(null)}}
                className="px-3 py-1 rounded text-[9px] font-bold text-white flex-shrink-0" style={{background:'var(--bl)',minWidth:32}}>OK</button>
            </div>
            <div className="flex items-center gap-1.5">
              <span className="text-[8px] font-bold" style={{color:'var(--gn)',minWidth:28}}>↕ Lig</span>
              <input type="number" defaultValue={(az.rowHeights||[])[pRow]||az.pan_.w||400}
                className="flex-1 px-2 py-1 rounded text-[11px] mn font-bold idark" id="ep-rowh" onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){const v=parseFloat(e.target.value);if(!v||v<50)return;
                  updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=pRow)rh.push(null);rh[pRow]=v;return{...z,rowHeights:rh}});setEditPanel(null)}}}/>
              <button onClick={()=>{const el=document.getElementById('ep-rowh');const v=parseFloat(el?.value);if(!v||v<50)return;
                updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=pRow)rh.push(null);rh[pRow]=v;return{...z,rowHeights:rh}});setEditPanel(null)}}
                className="px-3 py-1 rounded text-[9px] font-bold text-white flex-shrink-0" style={{background:'var(--gn)',minWidth:32}}>OK</button>
            </div>
          </div>
          {/* Actions */}
          <div className="px-2 py-1.5 space-y-1" style={{borderBottom:'1px solid var(--bd)'}}>
            {(()=>{
              const excl=(az.exclusions||[]).find(e=>e.col===pCol&&e.row===pRow);
              if(excl)return<div className="space-y-1">
                <div className="flex items-center gap-1.5">
                  <span className="text-[8px]" style={{color:'var(--rs)'}}>Exclu ({excl.depth}mm)</span>
                  <input type="number" defaultValue={excl.depth} className="w-14 px-1.5 py-0.5 rounded text-[10px] mn idark" id="ep-excl-depth" onKeyDown={e=>e.stopPropagation()}/>
                  <button onClick={()=>{const el=document.getElementById('ep-excl-depth');const v=parseFloat(el?.value);if(!v||v<100)return;
                    updateAZ(z=>{const ex=[...(z.exclusions||[])].map(e=>e.col===pCol&&e.row===pRow?{...e,depth:v}:e);return{...z,exclusions:ex}});setEditPanel(null)}}
                    className="px-1.5 py-0.5 rounded text-[8px] font-bold text-white" style={{background:'var(--bl)'}}>✓</button>
                  <button onClick={()=>{updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter(e=>!(e.col===pCol&&e.row===pRow))}));setEditPanel(null)}}
                    className="px-1.5 py-0.5 rounded text-[8px] font-bold" style={{color:'var(--rs)',border:'1px solid rgba(251,113,133,.3)'}}>✕</button>
                </div>
              </div>;
              return<button onClick={()=>{const depth=prompt('Profondeur extrusion (mm):','1500');if(!depth)return;const d=parseFloat(depth);if(isNaN(d)||d<100)return;
                updateAZ(z=>{const ex=[...(z.exclusions||[])];ex.push({col:pCol,row:pRow,depth:d});return{...z,exclusions:ex}});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(251,113,133,.06)',border:'1px solid rgba(251,113,133,.15)',color:'var(--rs)'}}>
                🚫 Exclure (balcon)</button>;
            })()}
          </div>
          {/* Transform to opening */}
          <div className="px-2 py-1.5" style={{borderBottom:'1px solid var(--bd)'}}>
            <button onClick={()=>{
              const ox=Math.round(pm.pLeft*1000),oy=Math.round(pm.pTop*1000);
              const ow=Math.round(pm.pWa*1000),oh=Math.round(pm.pHa*1000);
              const nO={id:Date.now(),t:oh>1800?'Porte':'Fenetre',x:ox,y:oy,w:ow,h:oh};
              updateAZ(z=>({...z,ouvs:[...z.ouvs,nO]}));setSelId(nO.id);setEditPanel(null)}}
              className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(14,165,233,.06)',border:'1px solid rgba(14,165,233,.15)',color:'#0ea5e9'}}>
              🔲 Transformer en ouverture</button>
          </div>
          {/* Merge */}
          <div className="px-2 py-1.5">
            {pm.isMerged?
              <button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])].filter(m=>!(m.c1===pm.mergeSpan.c1&&m.r1===pm.mergeSpan.r1));return{...z,merges:ms}});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(251,113,133,.06)',border:'1px solid rgba(251,113,133,.15)',color:'var(--rs)'}}>
                ✂ Défusionner</button>
            :<div className="space-y-1">
              <button onClick={()=>{setMergeSrc({parentCol:pCol,parentRow:pRow});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.08)',border:'1px solid rgba(139,92,246,.15)',color:'var(--pp)'}}>
                ⊞ Fusionner avec...</button>
              <div className="flex gap-1">
                {pCol<C.baseNc-1&&<button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])];ms.push({c1:pCol,r1:pRow,c2:pCol+1,r2:pRow});return{...z,merges:ms}});setEditPanel(null)}}
                  className="flex-1 py-0.5 rounded text-[8px] font-bold" style={{background:'rgba(79,110,247,.06)',border:'1px solid rgba(79,110,247,.12)',color:'var(--bl)'}}>→</button>}
                {pRow<C.baseNr-1&&<button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])];ms.push({c1:pCol,r1:pRow,c2:pCol,r2:pRow+1});return{...z,merges:ms}});setEditPanel(null)}}
                  className="flex-1 py-0.5 rounded text-[8px] font-bold" style={{background:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)',color:'var(--gn)'}}>↓</button>}
              </div>
            </div>}
          </div>
          {/* Bottom bar */}
          <div className="flex gap-1 px-2 pb-1.5">
            <button onClick={()=>{updateAZ(z=>{
              const cw=[...(z.colWidths||[])];if(cw[pCol]!=null)cw[pCol]=null;
              const rh=[...(z.rowHeights||[])];if(rh[pRow]!=null)rh[pRow]=null;
              return{...z,colWidths:cw,rowHeights:rh}});setEditPanel(null)}}
              className="flex-1 py-1 rounded text-[8px] font-bold" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t3)'}}>↺ Reset</button>
            <button onClick={()=>setEditPanel(null)}
              className="px-3 py-1 rounded text-[8px] font-bold" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
          </div>
        </div>})()}

      {/* ══ MODAL EXPORT JSON ══ */}
      {jsonExpMod&&<div className="ov"><div className="mbx" style={{maxWidth:480}}>
        <div className="flex items-center justify-between mb-4">
          <div className="text-sm font-bold" style={{color:'var(--t1)'}}>💾 Exporter JSON — choisir les zones</div>
          <button onClick={()=>setJsonExpMod(false)} className="ba px-2 py-1 rounded text-xs" style={{color:'var(--t3)'}}>✕</button>
        </div>
        <div className="space-y-2 mb-4">
          {zones.map((z,i)=>(
            <label key={z.id} className="flex items-center gap-3 p-2.5 rounded-lg cursor-pointer" style={{background:jsonExpSel[i]?'rgba(79,110,247,.08)':'var(--inp)',border:`1px solid ${jsonExpSel[i]?'var(--bl)':'var(--bd)'}`,transition:'.15s'}}>
              <input type="checkbox" checked={!!jsonExpSel[i]} onChange={e=>setJsonExpSel(s=>({...s,[i]:e.target.checked}))}/>
              <span className="text-xs font-semibold" style={{color:'var(--t1)'}}>{z.name}</span>
              <span className="text-[10px] ml-auto" style={{color:'var(--t3)'}}>{z.L/1000}×{z.H/1000}m</span>
            </label>
          ))}
        </div>
        <div className="flex gap-2 justify-between items-center">
          <div className="flex gap-2">
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setJsonExpSel(s)}} className="text-[10px] px-2 py-1 rounded ba" style={{color:'var(--bl)',background:'var(--blg)'}}>Tout</button>
            <button onClick={()=>setJsonExpSel({})} className="text-[10px] px-2 py-1 rounded ba" style={{color:'var(--t3)',background:'var(--inp)'}}>Aucun</button>
          </div>
          <div className="flex gap-2">
            <button onClick={()=>setJsonExpMod(false)} className="ba px-3 py-2 rounded-lg text-xs" style={{background:'var(--inp)',color:'var(--t2)'}}>Annuler</button>
            <button onClick={()=>{const sel=Object.entries(jsonExpSel).filter(([,v])=>v).map(([k])=>parseInt(k));if(!sel.length){alert('Sélectionne au moins une zone');return}exportProjectJSON(sel);setJsonExpMod(false)}}
              className="ba px-4 py-2 rounded-lg text-xs font-bold" style={{background:'var(--bl)',color:'#fff',border:'none'}}>
              💾 Exporter {Object.values(jsonExpSel).filter(Boolean).length} zone{Object.values(jsonExpSel).filter(Boolean).length>1?'s':''}
            </button>
          </div>
        </div>
      </div></div>}

      {/* ══ MODAL IMPORT JSON ══ */}
      {jsonImpMod&&<div className="ov"><div className="mbx" style={{maxWidth:520}}>
        <div className="flex items-center justify-between mb-1">
          <div className="text-sm font-bold" style={{color:'var(--t1)'}}>📥 Importer JSON — {jsonImpFile?.name||'Fichier'}</div>
          <button onClick={()=>{setJsonImpMod(false);setJsonImpFile(null)}} className="ba px-2 py-1 rounded text-xs" style={{color:'var(--t3)'}}>✕</button>
        </div>
        <div className="text-[10px] mb-4" style={{color:'var(--t3)'}}>
          {jsonImpZones.length} zone{jsonImpZones.length>1?'s':''} trouvée{jsonImpZones.length>1?'s':''} — sélectionne celles à importer
        </div>
        <div className="space-y-2 mb-5">
          {jsonImpZones.map((z,i)=>(
            <label key={i} className="flex items-center gap-3 p-2.5 rounded-lg cursor-pointer" style={{background:jsonImpSel[i]?'rgba(14,165,233,.08)':'var(--inp)',border:`1px solid ${jsonImpSel[i]?'rgba(14,165,233,.5)':'var(--bd)'}`,transition:'.15s'}}>
              <input type="checkbox" checked={!!jsonImpSel[i]} onChange={e=>setJsonImpSel(s=>({...s,[i]:e.target.checked}))}/>
              <div style={{flex:1}}>
                <div className="text-xs font-semibold" style={{color:'var(--t1)'}}>{z.name}</div>
                <div className="text-[9px]" style={{color:'var(--t3)'}}>{z.L/1000}×{z.H/1000}m · {z.ouvs?.length||0} ouverture{(z.ouvs?.length||0)>1?'s':''}</div>
              </div>
            </label>
          ))}
        </div>
        <div className="text-[10px] font-semibold mb-2" style={{color:'var(--t2)'}}>Mode d'import :</div>
        <div className="flex gap-2">
          <button onClick={()=>confirmJsonImport('replace')}
            className="ba flex-1 py-2.5 rounded-lg text-xs font-bold" style={{background:'rgba(239,68,68,.12)',border:'1px solid rgba(239,68,68,.3)',color:'#ef4444'}}>
            🔄 Remplacer le projet
          </button>
          <button onClick={()=>confirmJsonImport('append')}
            className="ba flex-1 py-2.5 rounded-lg text-xs font-bold" style={{background:'rgba(14,165,233,.1)',border:'1px solid rgba(14,165,233,.35)',color:'#0ea5e9'}}>
            ➕ Ajouter comme onglet{Object.values(jsonImpSel).filter(Boolean).length>1?'s':''}
          </button>
        </div>
      </div></div>}

      {xlsxExpMod&&<div className="ov"><div className="mbx">
        <h3 className="font-bold text-base mb-1">Export Excel</h3>
        <p className="text-xs mb-4" style={{color:'var(--t2)'}}>Sélectionnez les zones à inclure dans l'export</p>
        <div className="space-y-2 mb-4">
          {zones.map((z,i)=>{const zC2=allCalcs[i];return(
            <label key={z.id} className="flex items-center gap-3 p-2.5 rounded-lg cursor-pointer" style={{background:xlsxExpSel[i]?'rgba(52,211,153,.08)':'var(--inp)',border:`1px solid ${xlsxExpSel[i]?'rgba(52,211,153,.4)':'var(--bd)'}`,transition:'.15s'}}>
              <input type="checkbox" checked={!!xlsxExpSel[i]} onChange={e=>setXlsxExpSel(s=>({...s,[i]:e.target.checked}))}/>
              <div className="w-3 h-3 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8]}}/>
              <div className="flex-1"><div className="text-sm font-medium">{z.name}</div>
                <div className="text-[10px]" style={{color:'var(--t3)'}}>{(z.L/1000).toFixed(1)} × {(z.H/1000).toFixed(1)} m — {zC2?.nP||0} panneaux{z.ouvs?.length?' — '+z.ouvs.length+' ouverture'+(z.ouvs.length>1?'s':''):''}</div></div>
            </label>)})}
          <div className="flex gap-2 mt-1">
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s)}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--gn)',background:'rgba(52,211,153,.1)'}}>Tout sélectionner</button>
            <button onClick={()=>setXlsxExpSel({})} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t3)',background:'var(--inp)'}}>Tout désélectionner</button>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={()=>setXlsxExpMod(false)} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
          <button onClick={()=>{
            const sel=Object.entries(xlsxExpSel).filter(([,v])=>v).map(([k])=>parseInt(k));
            if(!sel.length){alert('Sélectionnez au moins une zone');return;}
            setXlsxExpMod(false);exportCSV(sel);}}
            className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--gn)'}}>
            📊 Exporter {Object.values(xlsxExpSel).filter(Boolean).length} zone{Object.values(xlsxExpSel).filter(Boolean).length>1?'s':''}
          </button>
        </div>
      </div></div>}

      {/* MODALS */}
      {calModal&&<div className="ov" onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();confirmCal()}}}><div className="mbx"><h3 className="font-bold text-base mb-4">Calibration</h3>
        <p className="text-xs mb-3" style={{color:'var(--t2)'}}>Distance reelle entre les 2 points :</p>
        <NI value={calMm} onChange={setCalMm} unit="mm" step={100} min={1}/>
        <div className="flex gap-2 mt-5"><button onClick={()=>{setCalModal(false);setCalPts([])}} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
          <button onClick={confirmCal} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)'}}>Valider</button></div></div></div>}

      {addMod&&<div className="ov"><div className="mbx"><AddPC type={addMod} onClose={()=>setAddMod(null)} onAdd={p=>{if(addMod==='pan')setPresPan(a=>[...a,p]);else setPresOuv(a=>[...a,p])}}/></div></div>}

      {coupeOuv!==null&&<CoupePopup ouvIdx={coupeOuv} onClose={()=>setCoupeOuv(null)}/>}
      {expMod&&(()=>{
        // Compter les pages uniques
        const getPageNum=(i)=>pdfPageNums[i]??i+1;
        const selList=Object.entries(expSel).filter(([,v])=>v).map(([k])=>parseInt(k));
        const pageNums=[...new Set(selList.map(i=>getPageNum(i)))].sort((a,b)=>a-b);
        return(
        <div className="ov"><div className="mbx" style={{maxWidth:580}}>
          <h3 className="font-bold text-base mb-1">Export PDF</h3>
          <p className="text-xs mb-3" style={{color:'var(--t2)'}}>Sélectionnez les zones et assignez-les à des pages (plusieurs zones = même page côte-à-côte)</p>

          {/* Zone list with page selectors */}
          <div className="space-y-1.5 mb-3">
            <div className="grid text-[9px] font-bold mb-1" style={{gridTemplateColumns:'1fr 90px',color:'var(--t3)'}}>
              <span>Zone</span><span className="text-center">Page PDF</span>
            </div>
            {zones.map((z,i)=>{const zC2=allCalcs[i];const pg=getPageNum(i);return(
              <div key={z.id} className="grid items-center gap-2" style={{gridTemplateColumns:'auto 1fr 90px'}}>
                <input type="checkbox" checked={!!expSel[i]} onChange={e=>setExpSel(s=>({...s,[i]:e.target.checked}))}/>
                <label className="flex items-center gap-2 p-2 rounded-lg cursor-pointer" style={{background:expSel[i]?'var(--blg)':'var(--inp)',border:`1px solid ${expSel[i]?'var(--bl)':'var(--bd)'}`,transition:'.15s'}}
                  onClick={()=>setExpSel(s=>({...s,[i]:!s[i]}))}>
                  <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8]}}/>
                  <div><div className="text-xs font-medium">{z.name}</div>
                    <div className="text-[9px]" style={{color:'var(--t3)'}}>{(z.L/1000).toFixed(1)}×{(z.H/1000).toFixed(1)} m — {zC2?.nP||0} pan.</div></div>
                </label>
                <div className="flex items-center gap-1">
                  <span className="text-[9px]" style={{color:'var(--t3)'}}>Pg.</span>
                  <input type="number" min={1} max={99} value={pg}
                    onChange={e=>setPdfPageNums(p=>({...p,[i]:parseInt(e.target.value)||i+1}))}
                    onKeyDown={e=>e.stopPropagation()}
                    className="idark w-12 text-center text-xs mn font-bold px-1 py-1 rounded"
                    style={{opacity:expSel[i]?1:.35}}/>
                </div>
              </div>
            )})}
          </div>

          {/* Page preview */}
          {selList.length>0&&(()=>{
            const pages={};selList.forEach(i=>{const pg=getPageNum(i);if(!pages[pg])pages[pg]=[];pages[pg].push(i);});
            return(
              <div className="mb-3 p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
                <div className="text-[9px] font-bold mb-1.5" style={{color:'var(--t3)'}}>APERÇU PAGES ({Object.keys(pages).length} page{Object.keys(pages).length>1?'s':''})</div>
                <div className="flex flex-wrap gap-2">
                  {Object.entries(pages).sort((a,b)=>a[0]-b[0]).map(([pg,zis])=>(
                    <div key={pg} className="flex items-center gap-1.5 px-2 py-1 rounded" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                      <span className="text-[9px] font-bold" style={{color:'var(--bl)'}}>P{pg}</span>
                      <span className="text-[9px]">→</span>
                      {zis.map(zi=>(
                        <span key={zi} className="flex items-center gap-1">
                          <span className="inline-block w-2 h-2 rounded-sm" style={{background:ZONE_COLORS[zi%8]}}/>
                          <span className="text-[9px]">{zones[zi].name}</span>
                        </span>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            );
          })()}

          <div className="flex gap-2 mb-3">
            <button onClick={()=>{const s={};const pn={};zones.forEach((_,i)=>{s[i]=true;pn[i]=i+1;});setExpSel(s);setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--bl)',background:'var(--blg)'}}>Tout sélect.</button>
            <button onClick={()=>setExpSel({})} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t3)',background:'var(--inp)'}}>Aucun</button>
            <button onClick={()=>{const sel=selList;const pn={};sel.forEach((i,idx)=>{pn[i]=idx+1;});setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t2)',background:'var(--inp)'}}>1 zone/page</button>
            <button onClick={()=>{const sel=selList;const pn={};sel.forEach(i=>{pn[i]=1;});setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t2)',background:'var(--inp)'}}>Tout sur 1 page</button>
          </div>

          <label className="flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer mb-2" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
            <input type="checkbox" checked={pdfOss} onChange={e=>setPdfOss(e.target.checked)}/>
            <span className="text-xs" style={{color:'var(--t2)'}}>Afficher ossature (montants / lisses)</span>
          </label>
          <div className="flex items-center gap-2 mb-3">
            <label className="flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer flex-1" style={{background:pdfQR?'rgba(139,92,246,.08)':'var(--crd)',border:`1px solid ${pdfQR?'rgba(139,92,246,.3)':'var(--bd)'}`}}>
              <input type="checkbox" checked={pdfQR} onChange={e=>setPdfQR(e.target.checked)} disabled={!supaConf.url||!supaConf.key}/>
              <span className="text-xs" style={{color:pdfQR?'var(--pp)':'var(--t2)'}}>QR code → vue 3D</span>
            </label>
            <button onClick={()=>{setExpMod(false);setSupaModal(true)}} className="ba px-3 py-2 rounded-lg text-[10px] font-bold"
              style={{background:supaConf.url?'rgba(13,148,136,.08)':'rgba(180,30,50,.06)',
                border:`1px solid ${supaConf.url?'rgba(13,148,136,.3)':'rgba(180,30,50,.15)'}`,
                color:supaConf.url?'var(--gn)':'var(--rs)'}}>
              {supaConf.url?'✓ Supabase':'⚙ Supabase'}</button>
          </div>
          <label className="flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer mb-3" style={{background:pdfCass?'rgba(139,92,246,.08)':'var(--crd)',border:`1px solid ${pdfCass?'rgba(139,92,246,.3)':'var(--bd)'}`}}>
            <input type="checkbox" checked={pdfCass} onChange={e=>setPdfCass(e.target.checked)}/>
            <span className="text-xs" style={{color:pdfCass?'var(--pp)':'var(--t2)'}}>Pages cassettes pliees (rapport + reperage)</span>
          </label>

          <div className="flex gap-2">
            <button onClick={()=>setExpMod(false)} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
            <button onClick={()=>{
              if(!selList.length)return;
              const pageGroups={};selList.forEach(i=>pageGroups[i]=getPageNum(i));
              setExpMod(false);exportPDF(selList,{showOss:pdfOss,pageGroups,showQR:pdfQR,showCass:pdfCass});}}
              className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)',opacity:selList.length?1:.5}}>
              Exporter {selList.length} zone{selList.length>1?'s':''} — {[...new Set(selList.map(i=>getPageNum(i)))].length} page{[...new Set(selList.map(i=>getPageNum(i)))].length>1?'s':''}
            </button>
          </div>
        </div></div>
        );
      })()}

      {/* SUPABASE CONFIG MODAL */}
      {supaModal&&<div className="ov" onClick={()=>setSupaModal(false)}><div className="mbx" style={{maxWidth:480}} onClick={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-bold text-base">Configuration Supabase</h3>
          <button onClick={()=>setSupaModal(false)} className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>✕</button>
        </div>
        <p className="text-xs mb-3" style={{color:'var(--t3)'}}>
          Connectez votre base Supabase pour stocker les vues 3D et générer des QR codes sur les PDF.
          Créez une table <code className="mn" style={{background:'var(--crd)',padding:'1px 4px',borderRadius:4}}>kalepin_views</code> avec les colonnes :
          <code className="mn block mt-1 p-2 rounded-lg text-[10px]" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
            id (uuid, PK, default gen_random_uuid()), created_at (timestamptz), project_name (text), zone_name (text), zone_json (jsonb), calc_json (jsonb), ral_color (text), ral_finish (text)
          </code>
        </p>
        <div className="space-y-2 mb-3">
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>URL Supabase</label>
            <input type="text" defaultValue={supaConf.url||''} id="supa-url" placeholder="https://xxxxx.supabase.co"
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>Anon Key (public)</label>
            <input type="password" defaultValue={supaConf.key||''} id="supa-key" placeholder="eyJhbGciOiJIUzI1NiIs..."
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>URL viewer (optionnel, défaut = URL actuelle)</label>
            <input type="text" defaultValue={supaConf.viewerUrl||''} id="supa-viewer" placeholder={window.location.origin+window.location.pathname}
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={()=>{
            const cfg={url:(document.getElementById('supa-url')?.value||'').replace(/\/$/,''),
              key:document.getElementById('supa-key')?.value||'',
              viewerUrl:document.getElementById('supa-viewer')?.value||''};
            setSupaConfig(cfg);setSupaConf(cfg);setSupaModal(false);
          }} className="ba flex-1 py-2 rounded-lg text-sm font-medium text-white" style={{background:'var(--gn)'}}>Enregistrer</button>
          {supaConf.url&&<button onClick={async()=>{
            try{const r=await fetch(supaConf.url+'/rest/v1/kalepin_views?select=id&limit=1',{headers:{'apikey':supaConf.key}});
              alert(r.ok?'✓ Connexion OK !':'✗ Erreur '+r.status)}catch(e){alert('✗ '+e.message)}
          }} className="ba px-4 py-2 rounded-lg text-sm font-medium" style={{background:'var(--cyd)',border:'1px solid rgba(8,145,178,.3)',color:'var(--cy)'}}>Tester</button>}
        </div>
      </div></div>}

      {optMod&&<div className="ov"><div className="mbx"><h3 className="font-bold text-base mb-3">Optimisation calepinage</h3>
        <p className="text-xs mb-4" style={{color:'var(--t2)'}}>Solutions testees: orientations V/H x decalages. Classement par taux de chute minimal.</p>
        <div className="space-y-2 max-h-[400px] overflow-y-auto">
          {optResults.map((r,i)=><div key={i} className={`opt-card ${i===0?'best':''}`} onClick={()=>applyOpt(r)}>
            <div className="flex items-center justify-between mb-1">
              <span className="text-xs font-bold" style={{color:i===0?'var(--gn)':'var(--t1)'}}>{i===0?'★ Optimal':``} {r.vert?'Vertical':'Horizontal'}</span>
              <span className="mn text-xs font-bold" style={{color:r.chut<10?'var(--gn)':r.chut<20?'var(--am)':'var(--rs)'}}>{r.chut.toFixed(1)}% chutes</span></div>
            <div className="flex gap-3 text-[10px]" style={{color:'var(--t3)'}}>
              <span>Decal: {r.offX}x{r.offY}mm</span><span>{r.nP} pan.</span><span>{r.pImp} imp.</span><span>{r.nCuts} coupes</span></div>
          </div>)}
          {optResults.length===0&&<p className="text-center py-4 text-xs" style={{color:'var(--t3)'}}>Aucun resultat</p>}
        </div>
        <button onClick={()=>setOptMod(false)} className="ba w-full mt-4 py-2 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
      </div></div>}

      {/* AI DETECTION MODAL */}
      {/* METRE MODAL */}
      {metreOpen&&<div className="ov"><div className="mbx" style={{maxWidth:700,width:'90vw'}}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-bold text-base">📊 Métré — Récapitulatif multi-zones</h3>
          <button onClick={()=>setMetreOpen(false)} className="text-lg" style={{color:'var(--t3)'}}>✕</button>
        </div>
        {/* Zone selection */}
        <div className="flex flex-wrap gap-1.5 mb-4">{zones.map((z,i)=>{
          const isOn=!!metreSelZones[i];
          return<button key={z.id} onClick={()=>setMetreSelZones(s=>({...s,[i]:!s[i]}))}
            className="ba px-3 py-1.5 rounded-lg text-[11px] font-medium"
            style={{background:isOn?'var(--blg)':'var(--inp)',border:`1px solid ${isOn?ZONE_COLORS[i%8]:'var(--bd)'}`,color:isOn?ZONE_COLORS[i%8]:'var(--t3)'}}>
            <span className="inline-block w-2.5 h-2.5 rounded-sm mr-1.5" style={{background:ZONE_COLORS[i%8],opacity:isOn?1:.4}}/>{z.name}</button>})}
          <button onClick={()=>{const a={};zones.forEach((_,i)=>a[i]=true);setMetreSelZones(a)}}
            className="ba px-2.5 py-1.5 rounded-lg text-[10px] font-medium" style={{background:'var(--gnd)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>Tout</button>
          <button onClick={()=>setMetreSelZones({})}
            className="ba px-2.5 py-1.5 rounded-lg text-[10px] font-medium" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>Aucun</button>
        </div>
        {/* Summary table */}
        {(()=>{
          const selIdx=Object.entries(metreSelZones).filter(([_,v])=>v).map(([k])=>parseInt(k));
          const rows=selIdx.map(i=>{const z=zones[i],c=allCalcs[i];if(!c)return null;
            return{name:z.name,col:ZONE_COLORS[i%8],sBr:c.sBr,sOuv:c.sOuv,sNet:c.sNet,nP:c.nP,pImp:c.pImp,
              tOss:c.tOss,tFix:c.tFix,tEq:c.tEq,tJ:c.tJ,totEnc:c.totEnc.tot,panL:z.pan_.l,panW:z.pan_.w,panNom:z.pan_.nom||`${z.pan_.l}x${z.pan_.w}`,
              chut:c.chut,nCuts:c.nCuts,L:z.L,H:z.H}}).filter(Boolean);
          if(rows.length===0)return<p className="text-center py-8 text-xs" style={{color:'var(--t3)'}}>Sélectionnez des zones ci-dessus</p>;
          const sum=(k)=>rows.reduce((a,r)=>a+r[k],0);
          const fmt=(v,d=2)=>v.toFixed(d);
          return<div className="space-y-3">
            {/* Detail table */}
            <div className="overflow-x-auto"><table className="w-full text-[10px]" style={{borderCollapse:'collapse'}}>
              <thead><tr style={{background:'var(--crd2)'}}>
                {['Zone','Dimensions','Panneau','S.Brute','Ouvertures','S.Nette','Panneaux','Impactés','Chutes','Ossature','Fixations','Équerres','Joints','Encadr.'].map(h=>
                  <th key={h} className="px-2 py-2 text-left font-bold" style={{color:'var(--t2)',borderBottom:'1px solid var(--bd)'}}>{h}</th>)}
              </tr></thead>
              <tbody>{rows.map((r,i)=><tr key={i} style={{borderBottom:'1px solid var(--bd)'}}>
                <td className="px-2 py-1.5 font-bold" style={{color:r.col}}>{r.name}</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{(r.L/1000).toFixed(1)}×{(r.H/1000).toFixed(1)}m</td>
                <td className="px-2 py-1.5" style={{color:'var(--t2)'}}>{r.panNom}</td>
                <td className="px-2 py-1.5 mn font-bold" style={{color:'var(--t1)'}}>{fmt(r.sBr)} m²</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--rs)'}}>-{fmt(r.sOuv)} m²</td>
                <td className="px-2 py-1.5 mn font-bold" style={{color:'var(--bl)'}}>{fmt(r.sNet)} m²</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t1)'}}>{r.nP}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--am)'}}>{r.pImp}u</td>
                <td className="px-2 py-1.5 mn" style={{color:r.chut<10?'var(--gn)':r.chut<20?'var(--am)':'var(--rs)'}}>{fmt(r.chut,1)}%</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{fmt(r.tOss,1)} ml</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{r.tFix}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{r.tEq}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{fmt(r.tJ,1)} ml</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--gn)'}}>{fmt(r.totEnc,1)} ml</td>
              </tr>)}</tbody>
              {rows.length>1&&<tfoot><tr style={{background:'var(--crd)'}}>
                <td className="px-2 py-2 font-bold" style={{color:'var(--gn)'}}>ΣTOTAL</td>
                <td className="px-2 py-2 mn" style={{color:'var(--t3)'}}>{rows.length} zones</td>
                <td className="px-2 py-2"/>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t1)'}}>{fmt(sum('sBr'))} m²</td>
                <td className="px-2 py-2 mn" style={{color:'var(--rs)'}}>-{fmt(sum('sOuv'))} m²</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--bl)'}}>{fmt(sum('sNet'))} m²</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t1)'}}>{sum('nP')}u</td>
                <td className="px-2 py-2 mn" style={{color:'var(--am)'}}>{sum('pImp')}u</td>
                <td className="px-2 py-2"/>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{fmt(sum('tOss'),1)} ml</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{sum('tFix')}u</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{sum('tEq')}u</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{fmt(sum('tJ'),1)} ml</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--gn)'}}>{fmt(sum('totEnc'),1)} ml</td>
              </tr></tfoot>}
            </table></div>
            {/* Summary cards */}
            <div className="grid grid-cols-4 gap-2">
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--bl)'}}>SURFACE NETTE TOTALE</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('sNet'))} m²</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--pp)'}}>PANNEAUX TOTAL</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{sum('nP')} u</div>
                <div className="text-[9px]" style={{color:'var(--am)'}}>{sum('pImp')} impactés</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--am)'}}>OSSATURE TOTALE</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('tOss'),1)} ml</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--gn)'}}>ENCADREMENTS TOTAL</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('totEnc'),1)} ml</div></div>
            </div>
            {/* Measurements */}
            {measures.length>0&&<div className="cd p-3">
              <div className="text-[10px] font-bold mb-2" style={{color:'#f59e0b'}}>MESURES ({measures.length})</div>
              <div className="space-y-1">{measures.map((m,i)=><div key={m.id} className="flex items-center justify-between text-[10px]">
                <span style={{color:'var(--t2)'}}>Mesure {i+1}</span>
                <span className="mn font-bold" style={{color:'#fbbf24'}}>{m.dist>=1000?(m.dist/1000).toFixed(3)+' m':m.dist+' mm'}</span>
                <button onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))} className="text-[9px]" style={{color:'var(--rs)'}}>✕</button>
              </div>)}</div>
              {measures.length>1&&<div className="flex justify-between mt-2 pt-2" style={{borderTop:'1px solid var(--bd)'}}>
                <span className="text-[10px] font-bold" style={{color:'#f59e0b'}}>Σ Total</span>
                <span className="mn font-bold" style={{color:'#fbbf24'}}>{(measures.reduce((a,m)=>a+m.dist,0)/1000).toFixed(3)} m</span>
              </div>}
            </div>}
          </div>})()}
        <button onClick={()=>setMetreOpen(false)} className="ba w-full mt-4 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
        <button onClick={()=>{setMetreOpen(false);const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s);setXlsxExpMod(true)}} className="ba w-full mt-2 py-2.5 rounded-lg text-sm font-medium" style={{background:'rgba(52,211,153,.12)',border:'1px solid rgba(52,211,153,.35)',color:'var(--gn)'}}>📊 Exporter Excel (métrés + détails)</button>
      </div></div>}
      {/* ── PAYWALL MODAL ── */}
      {showPaywall&&<Paywall user={user} currentPlan={subStatus?.plan} onClose={()=>setShowPaywall(false)}/>}
      {/* ── ACCOUNT SETTINGS ── */}
      {showAccount&&<AccountSettings user={user} onClose={()=>setShowAccount(false)}/>}
      {/* ── PLAN DE MASSE ── */}
      {showMasse&&<PlanMasse zones={zones} setZones={setZones} activeZoneIdx={activeZoneIdx} setActiveZoneIdx={setActiveZoneIdx}
        pxPerMm={pxPerMm_eff} onClose={()=>setShowMasse(false)} ZONE_COLORS={ZONE_COLORS} RAL_COLORS={RAL_COLORS} ralIdx={ralIdx}/>}
      {/* ── PROJECTS MODAL ── */}
      {showProjects&&<ProjectsModal onClose={()=>setShowProjects(false)} onOpen={openCloudProject} currentProjectId={cloudProjId}/>}
    </div>);
}

// ══════════════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════════════

// BRIQUE — Module calepinage brique de parement
// ══════════════════════════════════════════════════════════════
function BriqueApp({onBack,user}){
  // ── Multi-facade tabs ──
  const mkFacade=(name='Facade 1')=>({id:Date.now()+Math.random(),name,facW:6000,facH:3000,bkW:210,bkH:50,jointH:10,jointV:10,bond:'panneresse',bkColor:'#b5654a',bkColor2:'#8b4513',jointColor:'#c8bfb0',openings:[],angle:0});
  const[facades,setFacades]=useState([mkFacade()]);
  const[activeFacIdx,setActiveFacIdx]=useState(0);
  const fac=facades[activeFacIdx]||facades[0];
  const setFac=(fn)=>setFacades(fs=>fs.map((f,i)=>i===activeFacIdx?(typeof fn==='function'?fn(f):{...f,...fn}):f));

  // Shorthand getters
  const facW=fac.facW,facH=fac.facH,bkW=fac.bkW,bkH=fac.bkH,jointH=fac.jointH,jointV=fac.jointV;
  const bond=fac.bond,bkColor=fac.bkColor,bkColor2=fac.bkColor2,jointColor=fac.jointColor;
  const openings=fac.openings||[];

  // ── View state ──
  const[zoom,setZoom]=useState(1);const[showDims,setShowDims]=useState(true);const[showCuts,setShowCuts]=useState(true);
  const[hoverBk,setHoverBk]=useState(null);
  const[view3D,setView3D]=useState(false);
  const[showPlanMasse,setShowPlanMasse]=useState(false);
  const[selOuv,setSelOuv]=useState(null);// selected opening id
  const[dragState,setDragState]=useState(null);// {type:'move'|'r-*', id, sx, sy, orig}
  const svgRef=useRef(null);
  const svgContainerRef=useRef(null);
  const[cSize,setCSize]=useState({w:700,h:500});
  const mountRef=useRef(null);
  const sceneRef=useRef({});
  const rotRef=useRef({x:-.25,y:.35});
  const dragRef=useRef(null);
  const zoomRef=useRef(3.5);
  const panRef=useRef({x:0,y:0});

  const BRICK_PRESETS=[
    {name:'NF 210×50',w:210,h:50},{name:'NF 210×65',w:210,h:65},{name:'DF 240×52',w:240,h:52},
    {name:'WF 210×40',w:210,h:40},{name:'Mince 220×50',w:220,h:50},{name:'Module 290×90',w:290,h:90},
    {name:'Plaquette 240×71',w:240,h:71},{name:'Long 490×52',w:490,h:52},{name:'Format 240×115',w:240,h:115},
  ];
  const BK_COLORS=['#b5654a','#c47a5a','#d4956a','#9c4a2e','#8b4513','#7a3b1e','#6b3020',
    '#e8c9a0','#d4b896','#c2a882','#f0e0c8','#a08060','#705040','#503828',
    '#b88a6e','#c49474','#90786a','#786058','#605050','#484040'];
  const BONDS=[
    {id:'panneresse',name:'Panneresse',desc:'½ décalage (le plus courant)'},
    {id:'flamande',name:'Flamande',desc:'Alternance boutisse/panneresse'},
    {id:'anglaise',name:'Anglaise',desc:'Rangs alternés panneresse/boutisse'},
    {id:'boutisse',name:'Boutisse',desc:'Toutes boutisses (½ décalage)'},
    {id:'empile',name:'Empilé',desc:'Joints alignés verticalement'},
    {id:'americain',name:'Américain',desc:'⅓ décalage'},
  ];
  const OUV_TYPES=['Fenêtre','Porte','Porte-fenêtre','Vide'];

  // ── Compute bricks ──
  const computeBricks=useMemo(()=>{
    const W=facW,H=facH,bw=bkW,bh=bkH,jh=jointH,jv=jointV;
    const boutW=bw/2-jv/2;
    const rowH=bh+jh;
    const nRows=Math.ceil(H/rowH);
    const bricks=[];
    let fullCount=0,cutCount=0,boutCount=0;
    const oRects=openings.map(o=>({l:o.x,r:o.x+o.w,t:o.y,b:o.y+o.h}));
    const isInOpening=(x,y,w,h)=>{const cx=x+w/2,cy=y+h/2;return oRects.some(o=>cx>o.l&&cx<o.r&&cy>o.t&&cy<o.b)};
    const overlapsOpening=(x,y,w,h)=>oRects.some(o=>x<o.r&&x+w>o.l&&y<o.b&&y+h>o.t);
    for(let r=0;r<nRows;r++){
      const by=r*rowH;if(by>=H)break;
      const brickH=Math.min(bh,H-by);
      const isBoutisseRow=(bond==='anglaise'&&r%2===1)||(bond==='boutisse');
      const curBW=isBoutisseRow?boutW:bw;
      const colW=curBW+jv;
      let offset=0;
      if(bond==='panneresse')offset=r%2===0?0:colW/2;
      else if(bond==='flamande')offset=r%2===0?0:colW*0.75;
      else if(bond==='anglaise')offset=isBoutisseRow?(r%4===1?colW/2:0):(r%4===0?0:colW/2);
      else if(bond==='empile')offset=0;
      else if(bond==='americain')offset=(r%3)*colW/3;
      else if(bond==='boutisse')offset=r%2===0?0:colW/2;
      const nCols=Math.ceil((W+offset)/colW)+1;
      for(let c=-1;c<nCols;c++){
        let bx=c*colW-offset;
        let brickW=curBW;
        if(bond==='flamande'&&!isBoutisseRow){if(c%2===1)brickW=boutW;}
        const cx1=Math.max(0,bx),cy1=by;
        const cx2=Math.min(W,bx+brickW),cy2=Math.min(H,by+brickH);
        if(cx2<=cx1||cy2<=cy1)continue;
        const cw=cx2-cx1,ch=cy2-cy1;
        if(overlapsOpening(cx1,cy1,cw,ch))continue;
        const isCut=(Math.abs(cw-brickW)>1)||(Math.abs(ch-brickH)>1);
        const isBout=brickW<bw*0.7;
        if(!isCut)fullCount++;else cutCount++;
        if(isBout)boutCount++;
        const useBkColor2=isBout||(bond==='flamande'&&!isBoutisseRow&&(c%2===1));
        bricks.push({x:cx1,y:cy1,w:cw,h:ch,full:!isCut,isBout:useBkColor2,origW:brickW,origH:bh,col:c,row:r});
      }
    }
    const totalArea=W*H/1e6,ouvArea=openings.reduce((s,o)=>s+o.w*o.h/1e6,0),netArea=totalArea-ouvArea;
    const bricksPerM2=1e6/((bkW+jv)*(bkH+jh));
    return{bricks,fullCount,cutCount,boutCount,totalArea,ouvArea,netArea,bricksPerM2:Math.round(bricksPerM2),toOrder:Math.ceil((fullCount+cutCount)*1.05),mortarKg:netArea*(jh>=10?30:20)};
  },[facW,facH,bkW,bkH,jointH,jointV,bond,openings]);

  const svgW=cSize.w,svgH=cSize.h,mg=50;
  const sc=Math.min((svgW-mg*2)/facW,(svgH-mg*2)/facH)*zoom;
  const ox=(svgW-facW*sc)/2,oy=(svgH-facH*sc)/2;

  // ── Opening helpers ──
  const addOpening=(t)=>{
    const w=t==='Porte'?900:t==='Porte-fenêtre'?1800:t==='Vide'?800:1200;
    const h=t==='Porte'?2100:t==='Porte-fenêtre'?2150:t==='Vide'?800:1200;
    const x=Math.round((facW-w)/2),y=t==='Porte'||t==='Porte-fenêtre'?facH-h:Math.round((facH-h)/2);
    const nO={id:Date.now(),t,x,y,w,h,retours:{tG:150,tD:150,lin:150,app:150},faceVis:50,retourType:t==='Vide'?'brique':'metal'};
    setFac(f=>({...f,openings:[...f.openings,nO]}));setSelOuv(nO.id);
  };
  const updateOuv=(id,fn)=>setFac(f=>({...f,openings:f.openings.map(o=>o.id===id?fn(o):o)}));
  const delOuv=(id)=>{setFac(f=>({...f,openings:f.openings.filter(o=>o.id!==id)}));if(selOuv===id)setSelOuv(null)};
  const clamp=(v,mn,mx)=>Math.max(mn,Math.min(mx,v));
  const snap=(v,s=10)=>Math.round(v/s)*s;

  // ── SVG mouse handlers for drag/resize openings ──
  const svgPt=(cx,cy)=>{
    const r=svgContainerRef.current?.getBoundingClientRect();if(!r)return{x:0,y:0};
    return{x:(cx-r.left-ox)/sc,y:(cy-r.top-oy)/sc};
  };
  const handleSvgDown=(e,ouvId,type)=>{
    e.stopPropagation();e.preventDefault();
    const o=openings.find(v=>v.id===ouvId);if(!o)return;
    setSelOuv(ouvId);
    const pt=svgPt(e.clientX,e.clientY);
    setDragState({type,id:ouvId,sx:pt.x,sy:pt.y,orig:{x:o.x,y:o.y,w:o.w,h:o.h}});
  };
  const handleSvgMove=(e)=>{
    if(!dragState)return;
    const pt=svgPt(e.clientX,e.clientY);
    const dx=snap(pt.x-dragState.sx),dy=snap(pt.y-dragState.sy);
    const o=dragState.orig;
    if(dragState.type==='move'){
      const nx=clamp(o.x+dx,0,facW-o.w),ny=clamp(o.y+dy,0,facH-o.h);
      updateOuv(dragState.id,v=>({...v,x:nx,y:ny}));
    }else{
      const dir=dragState.type;
      let x=o.x,y=o.y,w=o.w,h=o.h;
      if(dir.includes('e')){w=Math.max(100,o.w+dx)}
      if(dir.includes('w')){const nw=Math.max(100,o.w-dx);x=o.x+(o.w-nw);w=nw}
      if(dir.includes('s')){h=Math.max(100,o.h+dy)}
      if(dir.includes('n')){const nh=Math.max(100,o.h-dy);y=o.y+(o.h-nh);h=nh}
      x=clamp(x,0,facW-w);y=clamp(y,0,facH-h);
      updateOuv(dragState.id,v=>({...v,x:snap(x),y:snap(y),w:snap(w),h:snap(h)}));
    }
  };
  const handleSvgUp=()=>setDragState(null);

  // ── Tab management ──
  const addFacade=()=>{const nf=mkFacade('Facade '+(facades.length+1));setFacades(fs=>[...fs,nf]);setActiveFacIdx(facades.length)};
  const delFacade=(idx)=>{if(facades.length<=1)return;setFacades(fs=>fs.filter((_,i)=>i!==idx));setActiveFacIdx(Math.max(0,Math.min(activeFacIdx,facades.length-2)))};
  const dupFacade=(idx)=>{const c=JSON.parse(JSON.stringify(facades[idx]));c.id=Date.now()+Math.random();c.name=c.name+' (copie)';setFacades(fs=>[...fs.slice(0,idx+1),c,...fs.slice(idx+1)]);setActiveFacIdx(idx+1)};

  // ── JSON export/import ──
  const exportBriqueJSON=()=>{
    const data={type:'kalepin-brique',version:1,facades};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='kalepin-brique-'+fac.name.replace(/\W+/g,'_')+'.json';a.click();
  };
  const importBriqueJSON=(file,append=false)=>{
    const reader=new FileReader();reader.onload=ev=>{try{
      const data=JSON.parse(ev.target.result);
      if(data.type!=='kalepin-brique'||!data.facades){alert('Fichier brique invalide');return}
      if(append){
        const newF=data.facades.map(f=>({...f,id:Date.now()+Math.random()}));
        setFacades(fs=>[...fs,...newF]);setActiveFacIdx(facades.length);
      }else{
        setFacades(data.facades.map(f=>({...f,id:f.id||Date.now()+Math.random()})));setActiveFacIdx(0);
      }
    }catch(e){alert('Erreur: '+e.message)}};reader.readAsText(file);
  };

  // ── Responsive SVG container ──
  useEffect(()=>{
    const el=svgContainerRef.current;if(!el)return;
    const ro=new ResizeObserver(entries=>{for(const e of entries){const{width,height}=e.contentRect;if(width>50&&height>50)setCSize({w:width,h:height})}});
    ro.observe(el);setCSize({w:el.clientWidth||700,h:el.clientHeight||500});
    return()=>ro.disconnect();
  },[view3D]);

  // ── Selected opening ──
  const selO=openings.find(o=>o.id===selOuv);

  // ── 3D VIEW ──
  useEffect(()=>{
    if(!view3D||!mountRef.current)return;
    const el=mountRef.current;
    const W=el.clientWidth,H=el.clientHeight;
    if(W<10||H<10)return;
    if(sceneRef.current.renderer){sceneRef.current.renderer.dispose()}
    el.innerHTML='';

    const scene=new THREE.Scene();
    scene.background=new THREE.Color(0x1a1e2e);
    const camera=new THREE.PerspectiveCamera(42,W/H,0.01,200);
    const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
    renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFShadowMap;
    renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.1;
    el.appendChild(renderer.domElement);
    renderer.domElement.style.cursor='grab';

    const amb=new THREE.AmbientLight(0xe8e8f0,0.6);scene.add(amb);
    const sun=new THREE.DirectionalLight(0xfff5e0,1.1);
    sun.position.set(8,12,8);sun.castShadow=true;
    sun.shadow.camera.near=0.1;sun.shadow.camera.far=80;
    sun.shadow.camera.left=-15;sun.shadow.camera.right=15;
    sun.shadow.camera.top=15;sun.shadow.camera.bottom=-15;
    sun.shadow.mapSize.width=1024;sun.shadow.mapSize.height=1024;
    sun.shadow.bias=-0.0005;scene.add(sun);
    const fill=new THREE.DirectionalLight(0x8ab0ff,0.3);fill.position.set(-4,-2,3);scene.add(fill);
    const bounce=new THREE.PointLight(0xffeedd,0.2,30);bounce.position.set(0,-5,4);scene.add(bounce);

    const Wm=facW/1000,Hm=facH/1000;
    const brickDepth=0.065;
    const facadeGroup=new THREE.Group();

    const groundMat=new THREE.MeshStandardMaterial({color:0x2a2a35,roughness:0.95});
    const ground=new THREE.Mesh(new THREE.PlaneGeometry(30,30),groundMat);
    ground.rotation.x=-Math.PI/2;ground.position.y=0;ground.receiveShadow=true;scene.add(ground);

    const jcCol=new THREE.Color(jointColor);
    const wallMat=new THREE.MeshStandardMaterial({color:jcCol,roughness:0.92,metalness:0.02});

    // Build back wall as segments avoiding openings (so openings are truly hollow)
    // oRects uses screen coords (y=0=top), convert to 3D coords for wall cutting
    const wallSegs=[];
    // Full wall rect in 3D space: x in [-Wm/2, Wm/2], y in [0, Hm]
    // Opening rects in 3D: ox3d = o.x/1000 - Wm/2, oy3d = Hm - o.y/1000 - o.h/1000
    let wallRects=[{x1:-Wm/2-0.01,x2:Wm/2+0.01,y1:-0.01,y2:Hm+0.01}];
    openings.forEach(o=>{
      const ol=o.x/1000-Wm/2, or2=(o.x+o.w)/1000-Wm/2;
      const ob=Hm-o.y/1000-o.h/1000, ot=Hm-o.y/1000;
      const next=[];
      wallRects.forEach(wr=>{
        if(ol>=wr.x2||or2<=wr.x1||ob>=wr.y2||ot<=wr.y1){next.push(wr);return}
        if(wr.y1<ob)next.push({x1:wr.x1,x2:wr.x2,y1:wr.y1,y2:ob});// bottom strip
        if(ot<wr.y2)next.push({x1:wr.x1,x2:wr.x2,y1:ot,y2:wr.y2});// top strip
        if(wr.x1<ol)next.push({x1:wr.x1,x2:ol,y1:Math.max(wr.y1,ob),y2:Math.min(wr.y2,ot)});// left strip
        if(or2<wr.x2)next.push({x1:or2,x2:wr.x2,y1:Math.max(wr.y1,ob),y2:Math.min(wr.y2,ot)});// right strip
      });
      wallRects=next;
    });
    wallRects.forEach(wr=>{
      const w=wr.x2-wr.x1,h=wr.y2-wr.y1;if(w<0.001||h<0.001)return;
      const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,0.012),wallMat);
      m.position.set(wr.x1+w/2,wr.y1+h/2,-0.006);m.receiveShadow=true;facadeGroup.add(m);
    });
    // Pas de cavity noire — on ajoute un plan intérieur clair derrière chaque ouverture
    openings.forEach(o=>{
      const ox=o.x/1000-Wm/2,oy=Hm-o.y/1000-o.h/1000;
      const ow2=o.w/1000,oh2=o.h/1000;
      const intMat=new THREE.MeshStandardMaterial({color:0x2a2830,roughness:0.95,metalness:0.0});
      const intPlane=new THREE.Mesh(new THREE.PlaneGeometry(ow2-0.01,oh2-0.01),intMat);
      intPlane.position.set(ox+ow2/2,oy+oh2/2,-0.15);facadeGroup.add(intPlane);
    });

    // oy3d = Y position flipped for 3D (0=bottom in 3D, 0=top in 2D screen coords)
    const oRects=openings.map(o=>({l:o.x/1000,r:(o.x+o.w)/1000,b:o.y/1000,t:(o.y+o.h)/1000,w:o.w/1000,h:o.h/1000,ox:o.x/1000,oy:Hm-o.y/1000-o.h/1000,type:o.t}));

    const bricks=computeBricks.bricks;
    const grp1=[],grp2=[];
    bricks.forEach(b=>{if(b.isBout)grp2.push(b);else grp1.push(b)});

    // Simple hash for deterministic but random-looking variation per brick
    const brickHash=(i)=>{let h=i*2654435761;h=((h>>>16)^h)*0x45d9f3b;h=((h>>>16)^h)*0x45d9f3b;h=(h>>>16)^h;return(h&0xffff)/65535};

    const addBrickGroup=(arr,baseCol)=>{
      if(!arr.length)return;
      const geo=new THREE.BoxGeometry(1,1,brickDepth);
      const mat=new THREE.MeshStandardMaterial({roughness:0.82,metalness:0.02});
      const mesh=new THREE.InstancedMesh(geo,mat,arr.length);
      mesh.castShadow=true;mesh.receiveShadow=true;
      const dummy=new THREE.Object3D();
      const colorAttr=new Float32Array(arr.length*3);
      const br=parseInt(baseCol.slice(1,3),16)/255;
      const bg=parseInt(baseCol.slice(3,5),16)/255;
      const bb=parseInt(baseCol.slice(5,7),16)/255;
      arr.forEach((b,i)=>{
        const sx=b.w/1000,sy=b.h/1000;
        // Flip Y: 2D origin is top-left (y=0=top), 3D origin is bottom (y=0=bottom)
        dummy.position.set(b.x/1000+sx/2-Wm/2, Hm-(b.y/1000+sy/2), brickDepth/2);
        dummy.scale.set(sx,sy,1);
        dummy.updateMatrix();
        mesh.setMatrixAt(i,dummy.matrix);
        // Random-looking brick variation using hash (unique seed per brick)
        const h1=brickHash(i*3+7);const h2=brickHash(i*5+13);const h3=brickHash(i*7+29);
        const shade=(h1-0.5)*0.022;// ±1.1% variation globale
        const rVar=(h2-0.5)*0.012;// variation rouge extra
        const bVar=(h3-0.5)*0.008;// variation bleue extra
        colorAttr[i*3]=Math.max(0,Math.min(1,br+shade+rVar));
        colorAttr[i*3+1]=Math.max(0,Math.min(1,bg+shade*0.8));
        colorAttr[i*3+2]=Math.max(0,Math.min(1,bb+shade*0.5+bVar));
      });
      mesh.instanceColor=new THREE.InstancedBufferAttribute(colorAttr,3);
      mesh.instanceMatrix.needsUpdate=true;
      facadeGroup.add(mesh);
    };
    addBrickGroup(grp1,bkColor);
    addBrickGroup(grp2,bkColor2);

    // Openings with retours in 3D
    oRects.forEach((o,oi)=>{
      const cx=o.ox+o.w/2-Wm/2, cy=o.oy+o.h/2;// oy already flipped in oRects
      const op=openings[oi];
      const ret=op?.retours||{tG:150,tD:150,lin:150,app:150};
      const fv=(op?.faceVis||50)/1000;
      const rType=op?.retourType||'metal';
      const retMat=rType==='brique'
        ?new THREE.MeshStandardMaterial({color:new THREE.Color(bkColor).multiplyScalar(0.92),roughness:0.85,metalness:0.02})
        :rType==='enduit'
        ?new THREE.MeshStandardMaterial({color:0xd8d0c4,roughness:0.95,metalness:0.0})
        :new THREE.MeshStandardMaterial({color:jcCol.clone().multiplyScalar(0.8),roughness:0.85,metalness:0.05});
      const frameMat=new THREE.MeshStandardMaterial({color:0x444455,roughness:0.25,metalness:0.7});
      // Retour gauche
      if(ret.tG>0){const d=ret.tG/1000;const m=new THREE.Mesh(new THREE.BoxGeometry(d,o.h,fv),retMat);
        m.position.set(cx-o.w/2-d/2,cy,brickDepth/2);m.castShadow=true;facadeGroup.add(m)}
      // Retour droit
      if(ret.tD>0){const d=ret.tD/1000;const m=new THREE.Mesh(new THREE.BoxGeometry(d,o.h,fv),retMat);
        m.position.set(cx+o.w/2+d/2,cy,brickDepth/2);m.castShadow=true;facadeGroup.add(m)}
      // Linteau
      if(ret.lin>0){const d=ret.lin/1000;const m=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.02,d,fv),retMat);
        m.position.set(cx,cy+o.h/2+d/2,brickDepth/2);m.castShadow=true;facadeGroup.add(m)}
      // Appui
      if(ret.app>0){const d=ret.app/1000;const m=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.08,d,fv+0.02),retMat);
        m.position.set(cx,cy-o.h/2-d/2,brickDepth/2+0.01);m.castShadow=true;facadeGroup.add(m)}
      // Cadre alu + vitrage (sauf Vide)
      if(o.type!=='Vide'){
        const ft=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.06,0.04,0.05),frameMat);ft.position.set(cx,cy+o.h/2+0.02,brickDepth/2);facadeGroup.add(ft);
        const fb=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.06,0.04,0.05),frameMat);fb.position.set(cx,cy-o.h/2-0.02,brickDepth/2);facadeGroup.add(fb);
        const fl=new THREE.Mesh(new THREE.BoxGeometry(0.04,o.h+0.06,0.05),frameMat);fl.position.set(cx-o.w/2-0.02,cy,brickDepth/2);facadeGroup.add(fl);
        const fr=new THREE.Mesh(new THREE.BoxGeometry(0.04,o.h+0.06,0.05),frameMat);fr.position.set(cx+o.w/2+0.02,cy,brickDepth/2);facadeGroup.add(fr);
        if(o.type==='Fenêtre'){
          const linMat=new THREE.MeshStandardMaterial({color:0x999990,roughness:0.85,metalness:0.05});
          const linteau=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.12,0.06,brickDepth+0.02),linMat);linteau.position.set(cx,cy+o.h/2+0.05,brickDepth/2);facadeGroup.add(linteau);
          const appui=new THREE.Mesh(new THREE.BoxGeometry(o.w+0.08,0.04,brickDepth+0.04),linMat);appui.position.set(cx,cy-o.h/2-0.04,brickDepth/2+0.01);facadeGroup.add(appui);
        }
        const glassMat=new THREE.MeshStandardMaterial({color:0x88ccee,transparent:true,opacity:0.32,roughness:0.03,metalness:0.15,side:THREE.DoubleSide,envMapIntensity:0.8});
        const glass=new THREE.Mesh(new THREE.PlaneGeometry(o.w-0.02,o.h-0.02),glassMat);glass.position.set(cx,cy,brickDepth*0.4);facadeGroup.add(glass);
        if(o.w>0.8){const mull=new THREE.Mesh(new THREE.BoxGeometry(0.02,o.h,0.025),frameMat);mull.position.set(cx,cy,brickDepth/2);facadeGroup.add(mull)}
      }
    });

    scene.add(facadeGroup);

    const dist0=Math.max(Wm,Hm)*1.6;
    zoomRef.current=dist0;
    const tgt=new THREE.Vector3(0,Hm/2,0);

    const onDown=e=>{dragRef.current={x:e.clientX,y:e.clientY,rx:rotRef.current.x,ry:rotRef.current.y,btn:e.button};renderer.domElement.style.cursor='grabbing'};
    const onUp=()=>{dragRef.current=null;renderer.domElement.style.cursor='grab'};
    const onMove=e=>{
      if(!dragRef.current)return;
      const dx=e.clientX-dragRef.current.x,dy=e.clientY-dragRef.current.y;
      if(dragRef.current.btn===2||dragRef.current.btn===1){
        panRef.current.x+=dx*0.003;panRef.current.y-=dy*0.003;dragRef.current.x=e.clientX;dragRef.current.y=e.clientY;
      }else{
        rotRef.current.y=dragRef.current.ry+dx*0.005;
        rotRef.current.x=Math.max(-1.2,Math.min(0.6,dragRef.current.rx+dy*0.005));
      }
    };
    const onWheel=e=>{e.preventDefault();zoomRef.current=Math.max(1,Math.min(30,zoomRef.current*(1+e.deltaY*0.001)))};
    renderer.domElement.addEventListener('mousedown',onDown);
    renderer.domElement.addEventListener('mouseup',onUp);
    renderer.domElement.addEventListener('mouseleave',onUp);
    renderer.domElement.addEventListener('mousemove',onMove);
    renderer.domElement.addEventListener('wheel',onWheel,{passive:false});
    renderer.domElement.addEventListener('contextmenu',e=>e.preventDefault());

    let raf;
    const animate=()=>{
      raf=requestAnimationFrame(animate);
      const d=zoomRef.current,rx=rotRef.current.x,ry=rotRef.current.y;
      camera.position.set(tgt.x+d*Math.sin(ry)*Math.cos(rx)+panRef.current.x,tgt.y+d*Math.sin(-rx)+panRef.current.y,tgt.z+d*Math.cos(ry)*Math.cos(rx));
      camera.lookAt(tgt.x+panRef.current.x,tgt.y+panRef.current.y,tgt.z);
      renderer.render(scene,camera);
    };
    animate();
    sceneRef.current={renderer,raf};
    const onResize=()=>{const w2=el.clientWidth,h2=el.clientHeight;if(w2>0&&h2>0){camera.aspect=w2/h2;camera.updateProjectionMatrix();renderer.setSize(w2,h2)}};
    window.addEventListener('resize',onResize);
    return()=>{cancelAnimationFrame(raf);window.removeEventListener('resize',onResize);renderer.dispose();el.innerHTML='';sceneRef.current={}};
  },[view3D,facW,facH,bkW,bkH,jointH,jointV,bond,bkColor,bkColor2,jointColor,openings,computeBricks.bricks]);

  // ── EXPORT PDF ──
  const exportPDF=async()=>{
    await window._jspdfReady;const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    const pw=297,ph=210;
    doc.setFillColor(26,30,46);doc.rect(0,0,pw,28,'F');
    doc.setFontSize(16);doc.setTextColor(255);doc.text('KALEPIN — Calepinage Brique',14,14);
    doc.setFontSize(10);doc.setTextColor(150);doc.text(fac.name+' — '+new Date().toLocaleDateString('fr-FR'),14,22);
    doc.text(BONDS.find(b=>b.id===bond)?.name+' — '+bkW+'×'+bkH+'mm — Joint '+jointH+'×'+jointV,pw-14,22,{align:'right'});
    const mL=20,mT=36,maxW=pw-mL*2,maxH=ph-mT-46;
    const scale=Math.min(maxW/facW,maxH/facH);
    const fW=facW*scale,fH=facH*scale;
    const fX=mL+(maxW-fW)/2,fY=mT;
    const hr=parseInt(jointColor.slice(1,3),16),hg=parseInt(jointColor.slice(3,5),16),hb=parseInt(jointColor.slice(5,7),16);
    doc.setFillColor(hr,hg,hb);doc.rect(fX,fY,fW,fH,'F');
    computeBricks.bricks.forEach(b=>{
      const baseCol=b.isBout?bkColor2:bkColor;
      const shade=((b.col*17+b.row*31)%20-10)*0.008;
      const r=Math.max(0,Math.min(255,parseInt(baseCol.slice(1,3),16)+shade*255));
      const g=Math.max(0,Math.min(255,parseInt(baseCol.slice(3,5),16)+shade*180));
      const bl=Math.max(0,Math.min(255,parseInt(baseCol.slice(5,7),16)+shade*128));
      doc.setFillColor(r,g,bl);
      doc.rect(fX+b.x*scale,fY+b.y*scale,b.w*scale,b.h*scale,'F');
      if(!b.full){doc.setDrawColor(239,68,68);doc.setLineWidth(0.2);doc.rect(fX+b.x*scale,fY+b.y*scale,b.w*scale,b.h*scale,'S')}
    });
    openings.forEach((o,i)=>{
      doc.setFillColor(135,206,235);doc.setGlobalAlpha?.(0.2);
      doc.rect(fX+o.x*scale,fY+o.y*scale,o.w*scale,o.h*scale,'F');
      doc.setDrawColor(91,184,217);doc.setLineWidth(0.5);
      doc.rect(fX+o.x*scale,fY+o.y*scale,o.w*scale,o.h*scale,'S');
      doc.setFontSize(7);doc.setTextColor(91,184,217);
      doc.text(o.t+' '+(i+1),fX+(o.x+o.w/2)*scale,fY+(o.y+o.h/2)*scale,{align:'center'});
    });
    doc.setDrawColor(80);doc.setLineWidth(0.5);doc.rect(fX,fY,fW,fH,'S');
    doc.setFontSize(8);doc.setTextColor(100);
    doc.text(facW+' mm',fX+fW/2,fY+fH+8,{align:'center'});
    const tY=fY+fH+16;
    doc.setFontSize(8);doc.setTextColor(60);
    const left=[['Surface brute',computeBricks.totalArea.toFixed(2)+' m²'],['Ouvertures',computeBricks.ouvArea.toFixed(2)+' m²'],['Surface nette',computeBricks.netArea.toFixed(2)+' m²'],
      ['Entières',''+computeBricks.fullCount],['Coupées',''+computeBricks.cutCount],['Total',''+(computeBricks.fullCount+computeBricks.cutCount)],['À commander (+5%)',''+computeBricks.toOrder],
      ['Mortier','~'+Math.round(computeBricks.mortarKg)+' kg ('+Math.ceil(computeBricks.mortarKg/25)+' sacs)']];
    left.forEach(([k,v],i)=>{doc.text(k,mL,tY+i*4);doc.text(v,mL+50,tY+i*4)});
    const right=[['Appareillage',BONDS.find(b=>b.id===bond)?.name],['Brique',bkW+'×'+bkH+' mm'],
      ['Joint',jointH+'×'+jointV+' mm'],['Briques/m²',''+computeBricks.bricksPerM2],['Ouvertures',''+openings.length]];
    right.forEach(([k,v],i)=>{doc.text(k,pw-80,tY+i*4);doc.text(v,pw-30,tY+i*4)});
    doc.save('kalepin-brique-'+fac.name.replace(/\W+/g,'_')+'.pdf');
  };

  // ── EXPORT CSV ──
  const exportCSV=()=>{
    const sep=';';let csv='\uFEFF';
    csv+='KALEPIN - Calepinage Brique\n'+fac.name+sep+facW+'x'+facH+'mm\n';
    csv+='Brique'+sep+bkW+'x'+bkH+'mm'+sep+'Joint'+sep+jointH+'x'+jointV+'mm'+sep+'Appareillage'+sep+(BONDS.find(b=>b.id===bond)?.name)+'\n\n';
    csv+='SURFACES\n';csv+='Brute'+sep+computeBricks.totalArea.toFixed(2)+' m²\n';
    csv+='Ouvertures'+sep+computeBricks.ouvArea.toFixed(2)+' m²\n';csv+='Nette'+sep+computeBricks.netArea.toFixed(2)+' m²\n\n';
    csv+='QUANTITES\n';csv+='Entières'+sep+computeBricks.fullCount+'\n';csv+='Coupées'+sep+computeBricks.cutCount+'\n';
    csv+='Total'+sep+(computeBricks.fullCount+computeBricks.cutCount)+'\n';csv+='À commander (+5%)'+sep+computeBricks.toOrder+'\n';
    csv+='Briques/m²'+sep+computeBricks.bricksPerM2+'\n\n';
    csv+='MORTIER\n';csv+='Estimé'+sep+'~'+Math.round(computeBricks.mortarKg)+' kg\n';
    csv+='Sacs 25kg'+sep+Math.ceil(computeBricks.mortarKg/25)+'\n\n';
    if(openings.length>0){csv+='OUVERTURES\nType'+sep+'X'+sep+'Y'+sep+'Largeur'+sep+'Hauteur'+sep+'Surface m²\n';
      openings.forEach(o=>{csv+=o.t+sep+o.x+sep+o.y+sep+o.w+sep+o.h+sep+(o.w*o.h/1e6).toFixed(3)+'\n'});csv+='\n'}
    csv+='DETAIL BRIQUES\n';csv+='N°'+sep+'X'+sep+'Y'+sep+'Largeur'+sep+'Hauteur'+sep+'Type'+sep+'Coupe\n';
    computeBricks.bricks.forEach((b,i)=>{csv+=(i+1)+sep+Math.round(b.x)+sep+Math.round(b.y)+sep+Math.round(b.w)+sep+Math.round(b.h)+sep+(b.isBout?'Boutisse':'Panneresse')+sep+(b.full?'Non':'Oui')+'\n'});
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='kalepin-brique-'+fac.name.replace(/\W+/g,'_')+'.csv';a.click();
  };

  const handleRH=8;// resize handle size in SVG px

  return<div style={{display:'flex',width:'100%',height:'100%',minHeight:0,background:'var(--bg)'}}>
    {/* LEFT */}
    <div style={{width:260,flexShrink:0,borderRight:'1px solid var(--bd)',background:'var(--pnl)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{padding:'12px 14px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:10}}>
        <button onClick={onBack} style={{width:28,height:28,borderRadius:8,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontFamily:'inherit'}}>←</button>
        <div><div style={{fontSize:13,fontWeight:700,color:'var(--t1)'}}>🧱 Brique</div>
          <div style={{fontSize:9,color:'var(--t3)'}}>Calepinage facade</div></div>
        <div style={{flex:1}}/>
        <div style={{display:'flex',gap:3}}>
          <button onClick={exportBriqueJSON} title="Exporter JSON" style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:11,display:'flex',alignItems:'center',justifyContent:'center'}}>💾</button>
          <label title="Importer JSON" style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:11,display:'flex',alignItems:'center',justifyContent:'center'}}>📥<input type="file" accept=".json" style={{display:'none'}} onChange={e=>{if(e.target.files[0])importBriqueJSON(e.target.files[0],false);e.target.value=''}}/></label>
          <label title="Ajouter façades JSON" style={{width:26,height:26,borderRadius:6,border:'1px solid #0ea5e9',background:'rgba(14,165,233,.08)',color:'#0ea5e9',cursor:'pointer',fontSize:11,display:'flex',alignItems:'center',justifyContent:'center'}}>📑<input type="file" accept=".json" style={{display:'none'}} onChange={e=>{if(e.target.files[0])importBriqueJSON(e.target.files[0],true);e.target.value=''}}/></label>
        </div>
      </div>
      <div style={{flex:1,overflowY:'auto',padding:10,display:'flex',flexDirection:'column',gap:8}}>
        {/* Facade */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#d97706'}}/><span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Facade</span></div>
          <TI label="Nom" value={fac.name} onChange={v=>setFac(f=>({...f,name:v}))}/>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,marginTop:6}}>
            <NI label="Largeur" value={facW} onChange={v=>setFac(f=>({...f,facW:v}))} unit="mm"/>
            <NI label="Hauteur" value={facH} onChange={v=>setFac(f=>({...f,facH:v}))} unit="mm"/>
          </div>
          <div style={{fontSize:9,color:'var(--t3)',marginTop:4,textAlign:'right'}}>{(facW*facH/1e6).toFixed(2)} m² brut</div>
        </div>
        {/* Brique */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#d97706'}}/><span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Brique</span></div>
          <div style={{display:'flex',flexWrap:'wrap',gap:3,marginBottom:6}}>
            {BRICK_PRESETS.map(p=><button key={p.name} onClick={()=>setFac(f=>({...f,bkW:p.w,bkH:p.h}))}
              style={{padding:'2px 6px',borderRadius:5,fontSize:8,fontWeight:600,cursor:'pointer',fontFamily:'inherit',
                border:bkW===p.w&&bkH===p.h?'1.5px solid #d97706':'1px solid var(--bd)',
                background:bkW===p.w&&bkH===p.h?'rgba(217,119,6,.12)':'var(--inp)',
                color:bkW===p.w&&bkH===p.h?'#d97706':'var(--t3)'}}>{p.name}</button>)}
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            <NI label="Largeur" value={bkW} onChange={v=>setFac(f=>({...f,bkW:v}))} unit="mm"/>
            <NI label="Hauteur" value={bkH} onChange={v=>setFac(f=>({...f,bkH:v}))} unit="mm"/>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,marginTop:6}}>
            <NI label="Joint H" value={jointH} onChange={v=>setFac(f=>({...f,jointH:v}))} unit="mm" step={1} min={0}/>
            <NI label="Joint V" value={jointV} onChange={v=>setFac(f=>({...f,jointV:v}))} unit="mm" step={1} min={0}/>
          </div>
        </div>
        {/* Appareillage */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#d97706'}}/><span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Appareillage</span></div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4}}>
            {BONDS.map(b=><button key={b.id} onClick={()=>setFac(f=>({...f,bond:b.id}))}
              style={{padding:'6px 4px',borderRadius:6,fontSize:9,fontWeight:600,textAlign:'left',cursor:'pointer',fontFamily:'inherit',
                border:bond===b.id?'1.5px solid #d97706':'1px solid var(--bd)',
                background:bond===b.id?'rgba(217,119,6,.1)':'var(--inp)',
                color:bond===b.id?'#d97706':'var(--t2)'}}><div style={{fontWeight:700}}>{b.name}</div>
              <div style={{fontSize:7,color:'var(--t3)',marginTop:1}}>{b.desc}</div></button>)}
          </div>
        </div>
        {/* Couleurs */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#d97706'}}/><span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Couleurs</span></div>
          <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Panneresse</div>
          <div style={{display:'flex',flexWrap:'wrap',gap:3,marginBottom:6}}>
            {BK_COLORS.map(c=><div key={c} onClick={()=>setFac(f=>({...f,bkColor:c}))}
              style={{width:18,height:18,borderRadius:4,background:c,cursor:'pointer',border:bkColor===c?'2px solid #fff':'2px solid transparent'}}/>)}
            <input type="color" value={bkColor} onChange={e=>setFac(f=>({...f,bkColor:e.target.value}))} style={{width:18,height:18,padding:0,border:'none',borderRadius:4,cursor:'pointer'}}/>
          </div>
          {(bond==='flamande'||bond==='anglaise')&&<>
            <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Boutisse</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:3,marginBottom:6}}>
              {BK_COLORS.map(c=><div key={c} onClick={()=>setFac(f=>({...f,bkColor2:c}))}
                style={{width:18,height:18,borderRadius:4,background:c,cursor:'pointer',border:bkColor2===c?'2px solid #fff':'2px solid transparent'}}/>)}
            </div>
          </>}
          <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Joint</div>
          <div style={{display:'flex',gap:3}}>
            {['#c8bfb0','#f0ece6','#999','#666','#444','#222'].map(c=><div key={c} onClick={()=>setFac(f=>({...f,jointColor:c}))}
              style={{width:18,height:18,borderRadius:4,background:c,cursor:'pointer',border:jointColor===c?'2px solid #fff':'2px solid transparent'}}/>)}
          </div>
        </div>
        {/* Ouvertures */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
            <div style={{display:'flex',alignItems:'center',gap:6}}>
              <div style={{width:3,height:12,borderRadius:2,background:'#f87171'}}/>
              <span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Ouvertures ({openings.length})</span>
            </div>
          </div>
          <div style={{display:'flex',flexWrap:'wrap',gap:3,marginBottom:6}}>
            {OUV_TYPES.map(t=><button key={t} onClick={()=>addOpening(t)}
              style={{padding:'3px 8px',borderRadius:5,fontSize:9,fontWeight:600,border:'1px solid var(--bd)',background:'var(--inp)',color:t==='Vide'?'#f59e0b':'var(--t3)',cursor:'pointer',fontFamily:'inherit'}}>+ {t}</button>)}
          </div>
          {openings.map((o)=><div key={o.id} onClick={()=>setSelOuv(o.id)} style={{padding:6,borderRadius:6,background:selOuv===o.id?'rgba(14,165,233,.08)':'var(--inp)',border:selOuv===o.id?'1.5px solid #0ea5e9':'1px solid var(--bd)',marginBottom:4,cursor:'pointer'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
              <span style={{fontSize:10,fontWeight:600,color:selOuv===o.id?'#0ea5e9':'var(--t2)'}}>{o.t} — {o.w}×{o.h}</span>
              <button onClick={e=>{e.stopPropagation();delOuv(o.id)}} style={{width:18,height:18,borderRadius:4,border:'1px solid rgba(239,68,68,.2)',background:'rgba(239,68,68,.05)',color:'#f87171',cursor:'pointer',fontSize:10,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'inherit'}}>×</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4,fontSize:10}}>
              <NI label="X" value={o.x} onChange={v=>updateOuv(o.id,o=>({...o,x:v}))} unit="mm"/>
              <NI label="Y" value={o.y} onChange={v=>updateOuv(o.id,o=>({...o,y:v}))} unit="mm"/>
              <NI label="L" value={o.w} onChange={v=>updateOuv(o.id,o=>({...o,w:v}))} unit="mm"/>
              <NI label="H" value={o.h} onChange={v=>updateOuv(o.id,o=>({...o,h:v}))} unit="mm"/>
            </div>
          </div>)}
        </div>
      </div>
    </div>

    {/* CENTER SVG */}
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}}>
      {/* Tabs bar */}
      <div style={{display:'flex',alignItems:'center',borderBottom:'1px solid var(--bd)',background:'var(--pnl)',flexShrink:0,padding:'0 8px',gap:2,height:32,overflowX:'auto'}}>
        {facades.map((f,i)=><div key={f.id} onClick={()=>setActiveFacIdx(i)} onDoubleClick={()=>{const n=prompt('Nom:',f.name);if(n)setFacades(fs=>fs.map((ff,j)=>j===i?{...ff,name:n}:ff))}}
          style={{padding:'4px 10px',fontSize:10,fontWeight:activeFacIdx===i?700:500,borderRadius:'6px 6px 0 0',cursor:'pointer',fontFamily:'inherit',whiteSpace:'nowrap',display:'flex',alignItems:'center',gap:4,
            background:activeFacIdx===i?'var(--bg)':'transparent',color:activeFacIdx===i?'#d97706':'var(--t3)',
            border:activeFacIdx===i?'1px solid var(--bd)':'1px solid transparent',borderBottom:activeFacIdx===i?'1px solid var(--bg)':'none'}}>
          {f.name}
          {facades.length>1&&<span onClick={e=>{e.stopPropagation();delFacade(i)}} style={{fontSize:8,color:'var(--t3)',cursor:'pointer',marginLeft:2}}>✕</span>}
        </div>)}
        <button onClick={addFacade} style={{width:22,height:22,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:12,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'inherit',flexShrink:0}} title="Nouvelle facade">+</button>
        <button onClick={()=>dupFacade(activeFacIdx)} style={{width:22,height:22,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:10,display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'inherit',flexShrink:0}} title="Dupliquer">⧉</button>
      </div>
      {/* Toolbar */}
      <div style={{padding:'6px 14px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:8,background:'var(--pnl)',flexShrink:0}}>
        <span style={{fontSize:12,fontWeight:700,color:'var(--t1)'}}>{fac.name}</span>
        <span style={{fontSize:10,color:'var(--t3)'}}>— {facW}×{facH}mm — {BONDS.find(b=>b.id===bond)?.name}</span>
        <div style={{flex:1}}/>
        <div style={{display:'flex',borderRadius:7,border:'1px solid var(--bd)',overflow:'hidden'}}>
          <button onClick={()=>setView3D(false)} style={{padding:'4px 12px',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'none',
            background:!view3D?'rgba(217,119,6,.15)':'var(--crd)',color:!view3D?'#d97706':'var(--t3)'}}>2D</button>
          <button onClick={()=>setView3D(true)} style={{padding:'4px 12px',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'none',borderLeft:'1px solid var(--bd)',
            background:view3D?'rgba(217,119,6,.15)':'var(--crd)',color:view3D?'#d97706':'var(--t3)'}}>3D</button>
          <button onClick={()=>setShowPlanMasse(true)} style={{padding:'4px 12px',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'none',borderLeft:'1px solid var(--bd)',
            background:'var(--crd)',color:'var(--t3)'}}>Plan</button>
        </div>
        {!view3D&&<>
          <label style={{fontSize:9,color:'var(--t3)',display:'flex',alignItems:'center',gap:3,cursor:'pointer'}}>
            <input type="checkbox" checked={showDims} onChange={e=>setShowDims(e.target.checked)} style={{accentColor:'#d97706'}}/> Cotes</label>
          <label style={{fontSize:9,color:'var(--t3)',display:'flex',alignItems:'center',gap:3,cursor:'pointer'}}>
            <input type="checkbox" checked={showCuts} onChange={e=>setShowCuts(e.target.checked)} style={{accentColor:'#d97706'}}/> Coupes</label>
          <div style={{display:'flex',gap:2}}>
            <button onClick={()=>setZoom(z=>Math.max(.3,z-.2))} style={{width:22,height:22,borderRadius:5,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:12,fontFamily:'inherit'}}>−</button>
            <button onClick={()=>setZoom(1)} style={{padding:'2px 6px',borderRadius:5,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:9,fontFamily:'inherit'}}>{Math.round(zoom*100)}%</button>
            <button onClick={()=>setZoom(z=>Math.min(4,z+.2))} style={{width:22,height:22,borderRadius:5,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:12,fontFamily:'inherit'}}>+</button>
          </div>
        </>}
        <button onClick={exportPDF} style={{padding:'4px 10px',borderRadius:6,fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'1px solid rgba(239,68,68,.3)',background:'rgba(239,68,68,.08)',color:'#ef4444'}}>📄 PDF</button>
        <button onClick={exportCSV} style={{padding:'4px 10px',borderRadius:6,fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'1px solid rgba(52,211,153,.3)',background:'rgba(52,211,153,.08)',color:'#34d399'}}>📊 CSV</button>
      </div>
      {/* 2D SVG view */}
      {!view3D&&<div ref={svgContainerRef} style={{flex:1,position:'relative',overflow:'hidden',background:'var(--bg)'}}
        onMouseMove={handleSvgMove} onMouseUp={handleSvgUp} onMouseLeave={handleSvgUp}>
        <svg ref={svgRef} style={{position:'absolute',inset:0,width:'100%',height:'100%',display:'block'}} viewBox={`0 0 ${svgW} ${svgH}`}>
          {/* Background */}
          <rect x={ox} y={oy} width={facW*sc} height={facH*sc} fill={jointColor} rx={1}/>
          {/* Bricks */}
          {computeBricks.bricks.map((b,i)=>{
            const baseCol=b.isBout?bkColor2:bkColor;
            const shade=((b.col*17+b.row*31)%20-10)/100;
            const r=parseInt(baseCol.slice(1,3),16),g=parseInt(baseCol.slice(3,5),16),bl=parseInt(baseCol.slice(5,7),16);
            const nr=Math.max(0,Math.min(255,r+Math.round(r*shade)));
            const ng=Math.max(0,Math.min(255,g+Math.round(g*shade)));
            const nb=Math.max(0,Math.min(255,bl+Math.round(bl*shade)));
            const isCut=!b.full;
            return<rect key={i} x={ox+b.x*sc} y={oy+b.y*sc} width={b.w*sc} height={b.h*sc}
              fill={isCut&&showCuts?'rgba(239,68,68,.25)':`rgb(${nr},${ng},${nb})`}
              stroke={isCut&&showCuts?'rgba(239,68,68,.5)':'rgba(0,0,0,.08)'} strokeWidth={isCut?.6:.2}
              rx={.3} style={{cursor:'pointer'}} onMouseEnter={()=>setHoverBk(i)} onMouseLeave={()=>setHoverBk(null)}/>;
          })}
          {/* Openings — draggable + resizable */}
          {openings.map((o,i)=>{
            const isSel=selOuv===o.id;
            const sx=ox+o.x*sc,sy=oy+o.y*sc,sw=o.w*sc,sh=o.h*sc;
            const col=o.t==='Vide'?'#f59e0b':'#5bb8d9';
            return<g key={o.id}>
              <rect x={sx} y={sy} width={sw} height={sh} fill={o.t==='Vide'?'rgba(245,158,11,.1)':'rgba(135,206,235,.15)'} stroke={col} strokeWidth={isSel?2.5:1.5} rx={1}
                style={{cursor:dragState?'grabbing':'grab'}} onMouseDown={e=>handleSvgDown(e,o.id,'move')}/>
              {o.t!=='Vide'&&<>
                <line x1={sx} y1={sy} x2={sx+sw} y2={sy+sh} stroke={col} strokeWidth={.5} opacity={.3}/>
                <line x1={sx+sw} y1={sy} x2={sx} y2={sy+sh} stroke={col} strokeWidth={.5} opacity={.3}/>
              </>}
              <text x={sx+sw/2} y={sy+sh/2} textAnchor="middle" dominantBaseline="middle"
                fill={col} fontSize={10} fontWeight="700" fontFamily="JetBrains Mono,monospace">{o.t} {i+1}</text>
              <text x={sx+sw/2} y={sy+sh/2+13} textAnchor="middle" fill={col} fontSize={8} fontFamily="JetBrains Mono,monospace">{o.w}×{o.h}</text>
              {o.retourType&&o.retourType!=='metal'&&<text x={sx+sw/2} y={sy+sh/2+24} textAnchor="middle" fill={col} fontSize={7} opacity={0.6} fontFamily="JetBrains Mono,monospace">ret. {o.retourType}</text>}
              {/* Resize handles when selected */}
              {isSel&&<>{/* corners */}
                {[['nw',sx,sy],['ne',sx+sw-handleRH,sy],['sw',sx,sy+sh-handleRH],['se',sx+sw-handleRH,sy+sh-handleRH]].map(([d,hx,hy])=>
                  <rect key={d} x={hx} y={hy} width={handleRH} height={handleRH} fill={col} rx={2} style={{cursor:d+'-resize'}} onMouseDown={e=>handleSvgDown(e,o.id,d)}/>)}
                {/* edge midpoints */}
                {[['n',sx+sw/2-handleRH/2,sy],['s',sx+sw/2-handleRH/2,sy+sh-handleRH],['w',sx,sy+sh/2-handleRH/2],['e',sx+sw-handleRH,sy+sh/2-handleRH/2]].map(([d,hx,hy])=>
                  <rect key={d} x={hx} y={hy} width={handleRH} height={handleRH} fill="rgba(255,255,255,.7)" stroke={col} strokeWidth={1} rx={2} style={{cursor:d==='n'||d==='s'?'ns-resize':'ew-resize'}} onMouseDown={e=>handleSvgDown(e,o.id,d)}/>)}
              </>}
            </g>})}
          {/* Border */}
          <rect x={ox} y={oy} width={facW*sc} height={facH*sc} fill="none" stroke="var(--t1)" strokeWidth={2} rx={1}/>
          {/* Dims */}
          {showDims&&<>
            <line x1={ox} y1={oy+facH*sc+20} x2={ox+facW*sc} y2={oy+facH*sc+20} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={ox} y1={oy+facH*sc+14} x2={ox} y2={oy+facH*sc+26} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={ox+facW*sc} y1={oy+facH*sc+14} x2={ox+facW*sc} y2={oy+facH*sc+26} stroke="var(--t3)" strokeWidth={.8}/>
            <text x={ox+facW*sc/2} y={oy+facH*sc+34} textAnchor="middle" fill="var(--t3)" fontSize={10} fontFamily="JetBrains Mono,monospace">{facW} mm</text>
            <line x1={ox-20} y1={oy} x2={ox-20} y2={oy+facH*sc} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={ox-26} y1={oy} x2={ox-14} y2={oy} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={ox-26} y1={oy+facH*sc} x2={ox-14} y2={oy+facH*sc} stroke="var(--t3)" strokeWidth={.8}/>
            <text x={ox-24} y={oy+facH*sc/2} textAnchor="middle" fill="var(--t3)" fontSize={10}
              fontFamily="JetBrains Mono,monospace" transform={`rotate(-90,${ox-24},${oy+facH*sc/2})`}>{facH} mm</text>
          </>}
          {hoverBk!==null&&computeBricks.bricks[hoverBk]&&(()=>{
            const b=computeBricks.bricks[hoverBk];
            return<g><rect x={ox+b.x*sc+2} y={oy+b.y*sc-16} width={100} height={16} rx={3} fill="rgba(0,0,0,.85)"/>
              <text x={ox+b.x*sc+6} y={oy+b.y*sc-4} fill="#fff" fontSize={9} fontFamily="JetBrains Mono,monospace">
                {b.full?`${b.origW}×${b.origH}`:`${Math.round(b.w)}×${Math.round(b.h)} (coupe)`}</text></g>
          })()}
        </svg>
      </div>}
      {/* 3D view */}
      {view3D&&<div ref={mountRef} style={{flex:1,background:'#1a1e2e',cursor:'grab'}}/>}
    </div>

    {/* RIGHT RESULTS */}
    <div style={{width:260,flexShrink:0,borderLeft:'1px solid var(--bd)',background:'var(--pnl)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{padding:'12px 14px',borderBottom:'1px solid var(--bd)'}}><div style={{fontSize:12,fontWeight:700,color:'var(--t1)'}}>📊 Résultats</div></div>
      <div style={{flex:1,overflowY:'auto',padding:10,display:'flex',flexDirection:'column',gap:8}}>
        {/* Surfaces */}
        <div style={{padding:8,borderRadius:8,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>SURFACES</div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}><span style={{fontSize:11,color:'var(--t2)'}}>Brute</span><span style={{fontSize:12,fontWeight:600,color:'var(--t1)',fontFamily:'monospace'}}>{computeBricks.totalArea.toFixed(2)} m²</span></div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}><span style={{fontSize:11,color:'var(--t2)'}}>Ouvertures</span><span style={{fontSize:12,fontWeight:600,color:'#f87171',fontFamily:'monospace'}}>-{computeBricks.ouvArea.toFixed(2)} m²</span></div>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{fontSize:11,fontWeight:700,color:'#d97706'}}>Nette</span><span style={{fontSize:13,fontWeight:700,color:'#d97706',fontFamily:'monospace'}}>{computeBricks.netArea.toFixed(2)} m²</span></div>
        </div>
        {/* Briques */}
        <div style={{padding:8,borderRadius:8,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>BRIQUES</div>
          <RR label="Entières" value={computeBricks.fullCount} color="#34d399"/>
          <RR label="Coupées" value={computeBricks.cutCount} color="#f87171"/>
          {computeBricks.boutCount>0&&<RR label="Boutisses" value={computeBricks.boutCount} color="#d97706"/>}
          <RR label="Total" value={computeBricks.fullCount+computeBricks.cutCount} bold/>
          <div style={{fontSize:9,color:'var(--t3)',marginTop:4}}>≈ {computeBricks.bricksPerM2} briques/m²</div>
        </div>
        {/* Commander */}
        <div style={{padding:8,borderRadius:8,background:'rgba(217,119,6,.06)',border:'1px solid rgba(217,119,6,.15)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'#d97706',marginBottom:4}}>À COMMANDER (+5%)</div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <span style={{fontSize:12,fontWeight:600,color:'var(--t2)'}}>Briques</span>
            <span style={{fontSize:18,fontWeight:800,color:'#d97706',fontFamily:'monospace'}}>{computeBricks.toOrder}</span>
          </div>
        </div>
        {/* Mortier */}
        <div style={{padding:8,borderRadius:8,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:4}}>MORTIER</div>
          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{fontSize:11,color:'var(--t2)'}}>Mortier estimé</span><span style={{fontSize:12,fontWeight:600,fontFamily:'monospace'}}>~{Math.round(computeBricks.mortarKg)} kg</span></div>
          <div style={{fontSize:9,color:'var(--t3)',marginTop:2}}>Joint {jointH}×{jointV}mm — {Math.ceil(computeBricks.mortarKg/25)} sacs de 25kg</div>
        </div>
        {/* Selected opening retours */}
        {selO&&<div style={{padding:8,borderRadius:8,background:'rgba(14,165,233,.04)',border:'1px solid rgba(14,165,233,.2)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'#0ea5e9',marginBottom:6}}>RETOURS — {selO.t} ({selO.w}×{selO.h})</div>
          <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Type</div>
          <div style={{display:'flex',gap:3,marginBottom:6}}>
            {OUV_TYPES.map(t=><button key={t} onClick={()=>updateOuv(selO.id,o=>({...o,t}))}
              style={{padding:'2px 6px',borderRadius:4,fontSize:8,fontWeight:600,cursor:'pointer',fontFamily:'inherit',
                border:selO.t===t?'1.5px solid #0ea5e9':'1px solid var(--bd)',
                background:selO.t===t?'rgba(14,165,233,.12)':'var(--inp)',
                color:selO.t===t?'#0ea5e9':'var(--t3)'}}>{t}</button>)}
          </div>
          <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Finition retours</div>
          <div style={{display:'flex',gap:3,marginBottom:6}}>
            {['metal','brique','enduit'].map(rt=><button key={rt} onClick={()=>updateOuv(selO.id,o=>({...o,retourType:rt}))}
              style={{padding:'2px 6px',borderRadius:4,fontSize:8,fontWeight:600,cursor:'pointer',fontFamily:'inherit',
                border:(selO.retourType||'metal')===rt?'1.5px solid #d97706':'1px solid var(--bd)',
                background:(selO.retourType||'metal')===rt?'rgba(217,119,6,.12)':'var(--inp)',
                color:(selO.retourType||'metal')===rt?'#d97706':'var(--t3)'}}>{rt==='metal'?'Métal':rt==='brique'?'Brique':'Enduit'}</button>)}
          </div>
          <div style={{fontSize:9,color:'var(--t3)',marginBottom:3}}>Profondeur retours (mm)</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4}}>
            <NI compact label="Tab. G" value={selO.retours?.tG||150} onChange={v=>updateOuv(selO.id,o=>({...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tG:v}}))} unit="mm" step={10} min={0}/>
            <NI compact label="Tab. D" value={selO.retours?.tD||150} onChange={v=>updateOuv(selO.id,o=>({...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tD:v}}))} unit="mm" step={10} min={0}/>
            <NI compact label="Linteau" value={selO.retours?.lin||150} onChange={v=>updateOuv(selO.id,o=>({...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),lin:v}}))} unit="mm" step={10} min={0}/>
            <NI compact label="Appui" value={selO.retours?.app||150} onChange={v=>updateOuv(selO.id,o=>({...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),app:v}}))} unit="mm" step={10} min={0}/>
          </div>
          <div style={{marginTop:4}}><NI compact label="Face visible" value={selO.faceVis||50} onChange={v=>updateOuv(selO.id,o=>({...o,faceVis:v}))} unit="mm" step={5} min={0}/></div>
        </div>}
        {/* Récap */}
        <div style={{padding:8,borderRadius:8,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:4}}>RÉCAPITULATIF</div>
          <div style={{fontSize:10,color:'var(--t2)',lineHeight:1.6}}>
            <div>Facade: <b>{fac.name}</b></div>
            <div>Brique: <b>{bkW}×{bkH} mm</b></div>
            <div>Joint: <b>{jointH}×{jointV} mm</b></div>
            <div>Appareil: <b>{BONDS.find(b=>b.id===bond)?.name}</b></div>
            <div>Ouvertures: <b>{openings.length}</b></div>
            <div>Facades: <b>{facades.length}</b></div>
            <div>Angle: <b>{fac.angle||0}°</b></div>
          </div>
        </div>
      </div>
    </div>

    {/* ═══ PLAN DE MASSE BRIQUE ═══ */}
    {showPlanMasse&&<div style={{position:'fixed',inset:0,zIndex:200,background:'var(--bg)',display:'flex',flexDirection:'column',fontFamily:'inherit'}}>
      {/* Header */}
      <div style={{padding:'10px 20px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:12,background:'var(--pnl)'}}>
        <button onClick={()=>setShowPlanMasse(false)} style={{padding:'5px 14px',borderRadius:7,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>← Retour</button>
        <span style={{fontSize:14,fontWeight:700,color:'var(--t1)'}}>Plan de masse — Brique</span>
        <span style={{fontSize:10,color:'var(--t3)'}}>{facades.length} facade{facades.length>1?'s':''}</span>
        <div style={{flex:1}}/>
        <button onClick={()=>{const nf=mkFacade('Facade '+(facades.length+1));setFacades(fs=>[...fs,nf])}} style={{padding:'5px 14px',borderRadius:7,border:'1px solid rgba(217,119,6,.2)',background:'rgba(217,119,6,.06)',color:'#d97706',fontSize:11,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>+ Facade</button>
      </div>
      {/* Content */}
      <div style={{flex:1,display:'flex',overflow:'hidden'}}>
        {/* SVG Plan */}
        <div style={{flex:1,position:'relative'}}>
          {(()=>{
            // Compute chain of facades
            const chain=[];let cx=0,cy=0;
            facades.forEach((f,i)=>{
              const a=(f.angle||0)*Math.PI/180;
              const nx=Math.sin(a),ny=-Math.cos(a);
              const dx=-ny,dy=nx;// direction along facade
              const Lm=f.facW/1000,Hm=f.facH/1000;
              const x1=cx,y1=cy;
              const x2=cx+dx*Lm,y2=cy+dy*Lm;
              chain.push({x1,y1,x2,y2,nx,ny,dx,dy,Lm,Hm,f,i});
              cx=x2;cy=y2;
            });
            // Bounding box
            let mnx=Infinity,mny=Infinity,mxx=-Infinity,mxy=-Infinity;
            chain.forEach(c=>{
              [c.x1,c.x2].forEach(x=>{mnx=Math.min(mnx,x-1);mxx=Math.max(mxx,x+1)});
              [c.y1,c.y2].forEach(y=>{mny=Math.min(mny,y-1);mxy=Math.max(mxy,y+1)});
              // Include wall thickness
              const t=c.Hm*0.12+0.3;
              mnx=Math.min(mnx,c.x1+c.nx*t,c.x2+c.nx*t);mxx=Math.max(mxx,c.x1+c.nx*t,c.x2+c.nx*t);
              mny=Math.min(mny,c.y1+c.ny*t,c.y2+c.ny*t);mxy=Math.max(mxy,c.y1+c.ny*t,c.y2+c.ny*t);
            });
            const pad=2;mnx-=pad;mny-=pad;mxx+=pad;mxy+=pad;
            const vbW=mxx-mnx,vbH=mxy-mny;
            const BK_PLAN_COLORS=['#d97706','#c4324a','#0ea5e9','#10b981','#8b5cf6','#ec4899'];
            return<svg viewBox={`${mnx} ${mny} ${vbW} ${vbH}`} style={{width:'100%',height:'100%'}} xmlns="http://www.w3.org/2000/svg">
              <defs><marker id="bk-arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#d97706" opacity="0.5"/></marker></defs>
              {/* Grid */}
              <pattern id="bk-grid" width="1" height="1" patternUnits="userSpaceOnUse"><rect width="1" height="1" fill="none" stroke="rgba(255,255,255,0.03)" strokeWidth="0.02"/></pattern>
              <rect x={mnx} y={mny} width={vbW} height={vbH} fill="url(#bk-grid)"/>
              {/* Facades */}
              {chain.map((c,i)=>{
                const col=BK_PLAN_COLORS[i%BK_PLAN_COLORS.length];
                const thick=0.25;// wall thickness in meters for display
                // 4 corners of the wall rectangle
                const pts=[
                  [c.x1,c.y1],[c.x2,c.y2],
                  [c.x2+c.nx*thick,c.y2+c.ny*thick],
                  [c.x1+c.nx*thick,c.y1+c.ny*thick]
                ].map(p=>p.join(',')).join(' ');
                const mx=(c.x1+c.x2)/2+c.nx*thick/2,my=(c.y1+c.y2)/2+c.ny*thick/2;
                // Normal arrow (shows exterior direction)
                const ax1=(c.x1+c.x2)/2, ay1=(c.y1+c.y2)/2;
                const ax2=ax1+c.nx*0.8, ay2=ay1+c.ny*0.8;
                return<g key={i}>
                  <polygon points={pts} fill={col} fillOpacity={activeFacIdx===i?0.35:0.15} stroke={col} strokeWidth={activeFacIdx===i?0.06:0.03} style={{cursor:'pointer'}}
                    onClick={()=>{setActiveFacIdx(i);setShowPlanMasse(false)}}/>
                  <line x1={ax1} y1={ay1} x2={ax2} y2={ay2} stroke={col} strokeWidth="0.03" markerEnd="url(#bk-arrow)" opacity="0.5"/>
                  <text x={mx} y={my} textAnchor="middle" dominantBaseline="middle" fill={col} fontSize="0.28" fontWeight="700" style={{pointerEvents:'none'}}>{c.f.name}</text>
                  <text x={mx} y={my+0.35} textAnchor="middle" fill={col} fontSize="0.18" opacity="0.7" style={{pointerEvents:'none'}}>{c.f.facW}×{c.f.facH}mm</text>
                  {/* Length dimension */}
                  <text x={(c.x1+c.x2)/2} y={(c.y1+c.y2)/2-0.25} textAnchor="middle" fill="rgba(255,255,255,0.3)" fontSize="0.16" style={{pointerEvents:'none'}}>{(c.Lm).toFixed(2)}m</text>
                </g>
              })}
              {/* Junction dots */}
              {chain.map((c,i)=><circle key={'j'+i} cx={c.x1} cy={c.y1} r="0.08" fill="#fff" fillOpacity="0.3"/>)}
              {chain.length>0&&<circle cx={chain[chain.length-1].x2} cy={chain[chain.length-1].y2} r="0.08" fill="#fff" fillOpacity="0.3"/>}
            </svg>
          })()}
        </div>
        {/* Side panel */}
        <div style={{width:260,borderLeft:'1px solid var(--bd)',background:'var(--pnl)',padding:12,overflowY:'auto',display:'flex',flexDirection:'column',gap:8}}>
          <div style={{fontSize:10,fontWeight:700,color:'var(--t1)',marginBottom:4}}>Facades</div>
          {facades.map((f,i)=>{
            const col=(['#d97706','#c4324a','#0ea5e9','#10b981','#8b5cf6','#ec4899'])[i%6];
            return<div key={f.id} style={{padding:10,borderRadius:10,border:activeFacIdx===i?'1.5px solid '+col:'1px solid var(--bd)',background:activeFacIdx===i?'rgba(255,255,255,.03)':'var(--crd)',cursor:'pointer'}}
              onClick={()=>setActiveFacIdx(i)}>
              <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:6}}>
                <div style={{width:10,height:10,borderRadius:3,background:col}}/>
                <span style={{fontSize:11,fontWeight:700,color:'var(--t1)',flex:1}}>{f.name}</span>
                <span style={{fontSize:9,color:'var(--t3)'}}>{f.facW}×{f.facH}</span>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <span style={{fontSize:9,color:'var(--t3)'}}>Angle:</span>
                <input type="range" min={0} max={360} step={5} value={f.angle||0}
                  onClick={e=>e.stopPropagation()}
                  onChange={e=>{const v=Number(e.target.value);setFacades(fs=>fs.map((ff,j)=>j===i?{...ff,angle:v}:ff))}}
                  style={{flex:1,accentColor:col,height:3}}/>
                <span style={{fontSize:9,fontWeight:600,color:col,width:28,textAlign:'right'}}>{f.angle||0}°</span>
              </div>
              <div style={{display:'flex',gap:4,marginTop:6}}>
                <div style={{width:12,height:12,borderRadius:3,background:f.bkColor}}/>
                <span style={{fontSize:9,color:'var(--t3)'}}>{f.bond} — {f.openings?.length||0} ouv.</span>
              </div>
            </div>
          })}
          <button onClick={()=>{const nf=mkFacade('Facade '+(facades.length+1));setFacades(fs=>[...fs,nf])}}
            style={{padding:'8px',borderRadius:8,border:'1.5px dashed var(--bd)',background:'transparent',color:'var(--t3)',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>+ Ajouter une facade</button>
          <div style={{marginTop:'auto',paddingTop:12,borderTop:'1px solid var(--bd)'}}>
            <div style={{fontSize:9,color:'var(--t3)',lineHeight:1.6}}>
              Cliquer sur une facade pour l'éditer.<br/>
              L'angle oriente la normale extérieure.
            </div>
          </div>
        </div>
      </div>
    </div>}
  </div>;
}
// ══════════════════════════════════════════════════════════════
function CarrelageApp({onBack,user}){
  // ── Room ──
  const[roomW,setRoomW]=useState(3500);// mm
  const[roomH,setRoomH]=useState(2800);
  const[roomName,setRoomName]=useState('Pièce 1');
  const[roomType,setRoomType]=useState('sol');// sol, mur, piscine
  // ── Tile ──
  const[tileW,setTileW]=useState(600);
  const[tileH,setTileH]=useState(600);
  const[jointW,setJointW]=useState(3);
  const[tileColor1,setTileColor1]=useState('#d4c5a9');
  const[tileColor2,setTileColor2]=useState('#8b7355');
  const[jointColor,setJointColor]=useState('#c8c0b0');
  // ── Layout ──
  const[pattern,setPattern]=useState('droit');// droit, decale12, decale13, diagonal, chevron, damier
  const[startCorner,setStartCorner]=useState('bl');// bl, br, tl, tr, center
  const[orientation,setOrientation]=useState('h');// h=horizontal, v=vertical
  // ── View ──
  const[zoom,setZoom]=useState(1);
  const[showDims,setShowDims]=useState(true);
  const[showCuts,setShowCuts]=useState(true);
  const[hoverTile,setHoverTile]=useState(null);
  const[view3D,setView3D]=useState(false);
  const svgRef=useRef(null);
  const mountRef=useRef(null);
  const sceneRef3D=useRef({});
  const rotRef3D=useRef({x:-.5,y:.4});const dragRef3D=useRef(null);
  const zoomRef3D=useRef(4);const panRef3D=useRef({x:0,y:0});
  const svgContainerRef=useRef(null);
  const[cSize,setCSize]=useState({w:800,h:600});
  const{useLayoutEffect}=React;
  useLayoutEffect(()=>{
    const el=svgContainerRef.current;if(!el)return;
    const upd=()=>{const r=el.getBoundingClientRect();if(r.width>80&&r.height>80)setCSize({w:r.width,h:r.height})};
    upd();const ro=new ResizeObserver(upd);ro.observe(el);return()=>ro.disconnect();
  },[view3D]);

  const TILE_PRESETS=[
    {name:'20×20',w:200,h:200},{name:'30×30',w:300,h:300},{name:'33×33',w:330,h:330},
    {name:'40×40',w:400,h:400},{name:'45×45',w:450,h:450},{name:'60×60',w:600,h:600},
    {name:'60×120',w:600,h:1200},{name:'80×80',w:800,h:800},{name:'30×60',w:300,h:600},
    {name:'75×150',w:750,h:1500},{name:'100×100',w:1000,h:1000},{name:'120×120',w:1200,h:1200},
    {name:'20×40',w:200,h:400},{name:'10×30 (métro)',w:100,h:300},{name:'7.5×15 (métro)',w:75,h:150},
    {name:'5×5 (mosaïque)',w:50,h:50},{name:'10×10 (zellige)',w:100,h:100},
  ];
  const COLORS=['#d4c5a9','#f5f0e6','#e8e0d0','#c2b8a3','#8b7355','#b8a88a','#6b5b4b',
    '#f0f0f0','#d0d0d0','#a0a0a0','#505050','#2a2a2a','#d4a574','#c48c5c',
    '#8b4513','#e6ccb3','#f5deb3','#daa520','#1a3a4a','#2c5f7c','#4a8c6f',
    '#2d5a27','#8b0000','#cc3333','#f4a460','#ffe4c4'];
  const JOINT_COLORS=['#c8c0b0','#ffffff','#e0dcd4','#999999','#666666','#333333','#2a2a2a'];

  // ── Compute tiles ──
  const computeTiles=useMemo(()=>{
    const tw=orientation==='v'?tileH:tileW;
    const th=orientation==='v'?tileW:tileH;
    const j=jointW;
    const RW=roomW,RH=roomH;
    const tiles=[];
    let fullCount=0,cutCount=0,cutArea=0;

    if(pattern==='droit'||pattern==='decale12'||pattern==='decale13'||pattern==='damier'){
      const stepX=tw+j,stepY=th+j;
      const offset=pattern==='decale12'?0.5:pattern==='decale13'?1/3:0;
      const nCols=Math.ceil(RW/stepX)+1,nRows=Math.ceil(RH/stepY)+1;
      // Start offsets based on corner
      let ox=0,oy=0;
      if(startCorner==='center'){ox=(RW%stepX)/2;oy=(RH%stepY)/2}
      else if(startCorner==='br'||startCorner==='tr'){ox=RW%stepX||0}
      if(startCorner==='tl'||startCorner==='tr'){oy=RH%stepY||0}

      for(let r=0;r<nRows;r++){
        const rowOff=(r%2===1&&offset>0)?stepX*offset:(pattern==='decale13'&&r%3===1)?stepX/3:(pattern==='decale13'&&r%3===2)?stepX*2/3:0;
        for(let c=-1;c<nCols;c++){
          let x=c*stepX-ox+rowOff;
          let y=r*stepY-oy;
          // Clip to room
          let cx1=Math.max(0,x),cy1=Math.max(0,y);
          let cx2=Math.min(RW,x+tw),cy2=Math.min(RH,y+th);
          if(cx2<=cx1||cy2<=cy1)continue;
          const clipW=cx2-cx1,clipH=cy2-cy1;
          const isFull=Math.abs(clipW-tw)<1&&Math.abs(clipH-th)<1;
          const isDamier2=pattern==='damier'&&(r+c)%2===1;
          if(isFull)fullCount++;else{cutCount++;cutArea+=clipW*clipH}
          tiles.push({x:cx1,y:cy1,w:clipW,h:clipH,full:isFull,origW:tw,origH:th,col:c,row:r,isDamier2});
        }
      }
    }else if(pattern==='diagonal'){
      // 45° diagonal — rotated tiles
      const diag=Math.sqrt(tw*tw+th*th);
      const stepD=diag/Math.sqrt(2)+j;
      const nD=Math.ceil((RW+RH)/stepD)+2;
      for(let r=-nD;r<nD;r++)for(let c=-nD;c<nD;c++){
        const cx=(c+r)*stepD/2,cy=(r-c)*stepD/2+RH/2;
        // Rotated rectangle corners
        const hw=tw/2,hh=th/2;
        const cos45=Math.cos(Math.PI/4),sin45=Math.sin(Math.PI/4);
        const corners=[[-hw,-hh],[hw,-hh],[hw,hh],[-hw,hh]].map(([px,py])=>({
          x:cx+px*cos45-py*sin45,y:cy+px*sin45+py*cos45
        }));
        // Check if any corner is in room
        const allOut=corners.every(p=>p.x<-tw||p.x>RW+tw||p.y<-th||p.y>RH+th);
        if(allOut)continue;
        // Simple AABB for clipping check
        const minX=Math.min(...corners.map(p=>p.x)),maxX=Math.max(...corners.map(p=>p.x));
        const minY=Math.min(...corners.map(p=>p.y)),maxY=Math.max(...corners.map(p=>p.y));
        if(maxX<0||minX>RW||maxY<0||minY>RH)continue;
        const isFull=minX>=0&&maxX<=RW&&minY>=0&&maxY<=RH;
        if(isFull)fullCount++;else cutCount++;
        tiles.push({x:cx,y:cy,w:tw,h:th,full:isFull,diagonal:true,corners,origW:tw,origH:th,col:c,row:r});
      }
    }else if(pattern==='chevron'){
      const angle=Math.PI/4;
      const segW=tw,segH=th;
      const stepX=segW*Math.cos(angle)*2+j;
      const stepY=segH+j;
      const nC=Math.ceil(RW/stepX)+2,nR=Math.ceil(RH/stepY)+2;
      for(let r=-1;r<nR;r++)for(let c=-1;c<nC;c++){
        const bx=c*stepX,by=r*stepY;
        // Left leg
        const x1=bx,y1=by;
        const cx1=Math.max(0,x1),cy1=Math.max(0,y1);
        const cx2=Math.min(RW,x1+segW*Math.cos(angle)),cy2=Math.min(RH,y1+segH);
        if(cx2>cx1&&cy2>cy1){
          const isFull=cx1===x1&&cy1===y1&&Math.abs(cx2-(x1+segW*Math.cos(angle)))<1&&Math.abs(cy2-(y1+segH))<1;
          if(isFull)fullCount++;else cutCount++;
          tiles.push({x:cx1,y:cy1,w:cx2-cx1,h:cy2-cy1,full:isFull,origW:tw,origH:th,col:c*2,row:r,chevronLeft:true});
        }
        // Right leg (mirror)
        const x2=bx+segW*Math.cos(angle)+j/2,y2=by;
        const dx1=Math.max(0,x2),dy1=Math.max(0,y2);
        const dx2=Math.min(RW,x2+segW*Math.cos(angle)),dy2=Math.min(RH,y2+segH);
        if(dx2>dx1&&dy2>dy1){
          const isFull2=dx1===x2&&dy1===y2&&Math.abs(dx2-(x2+segW*Math.cos(angle)))<1&&Math.abs(dy2-(y2+segH))<1;
          if(isFull2)fullCount++;else cutCount++;
          tiles.push({x:dx1,y:dy1,w:dx2-dx1,h:dy2-dy1,full:isFull2,origW:tw,origH:th,col:c*2+1,row:r,chevronRight:true});
        }
      }
    }

    const totalRoomArea=RW*RH/1e6;// m²
    const fullTileArea=tw*th/1e6;
    const totalTilesNeeded=fullCount+cutCount;
    const wastePercent=cutCount>0?((cutCount*fullTileArea*1e6-cutArea)/(totalRoomArea*1e6)*100):0;
    const tilesToOrder=fullCount+Math.ceil(cutCount*1.1);// 10% extra for cuts
    const boxesOf=Math.ceil(tilesToOrder/(pattern==='diagonal'||pattern==='chevron'?8:Math.max(1,Math.floor(1/fullTileArea))));

    return{tiles,fullCount,cutCount,totalTilesNeeded,totalRoomArea,fullTileArea,wastePercent:Math.min(wastePercent,50),tilesToOrder,boxesOf,
      linearCutH:cutCount>0?roomW*2:0,linearCutV:cutCount>0?roomH*2:0};
  },[roomW,roomH,tileW,tileH,jointW,pattern,startCorner,orientation]);

  // ── 3D Carrelage ──
  useEffect(()=>{
    if(!view3D||!mountRef.current)return;
    const el=mountRef.current;
    el.innerHTML='';
    const W=el.clientWidth,H=el.clientHeight;
    if(W<10||H<10)return;
    const tw=orientation==='v'?tileH:tileW,th=orientation==='v'?tileW:tileH;
    const RWm=roomW/1000,RHm=roomH/1000;
    const scene=new THREE.Scene();scene.background=new THREE.Color(0x1a1e2e);
    const camera=new THREE.PerspectiveCamera(42,W/H,0.01,200);
    const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
    renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFShadowMap;
    renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.15;
    el.appendChild(renderer.domElement);renderer.domElement.style.cursor='grab';renderer.domElement.addEventListener('contextmenu',e=>e.preventDefault());

    // Lighting
    scene.add(new THREE.AmbientLight(0xe8e8f0,0.5));
    const sun=new THREE.DirectionalLight(0xfff5e0,1.2);sun.position.set(6,12,8);sun.castShadow=true;
    sun.shadow.camera.near=0.1;sun.shadow.camera.far=40;sun.shadow.camera.left=-10;sun.shadow.camera.right=10;
    sun.shadow.camera.top=10;sun.shadow.camera.bottom=-10;sun.shadow.mapSize.width=1024;sun.shadow.mapSize.height=1024;sun.shadow.bias=-0.0005;
    scene.add(sun);
    const fill=new THREE.DirectionalLight(0x8ab0ff,0.35);fill.position.set(-4,-2,3);scene.add(fill);
    const bounce=new THREE.PointLight(0xffeedd,0.15,20);bounce.position.set(0,-3,2);scene.add(bounce);

    // Ground plane
    const groundMat=new THREE.MeshStandardMaterial({color:0x2a2a35,roughness:0.95});
    const ground=new THREE.Mesh(new THREE.PlaneGeometry(30,30),groundMat);
    ground.rotation.x=-Math.PI/2;ground.position.y=0;ground.receiveShadow=true;scene.add(ground);

    // Grout slab — FLOOR: XZ plane (y=height, very thin)
    const jcC=new THREE.Color(jointColor);
    const floorMat=new THREE.MeshStandardMaterial({color:jcC,roughness:0.92,metalness:0.02});
    const floor=new THREE.Mesh(new THREE.BoxGeometry(RWm+.02,.006,RHm+.02),floorMat);
    floor.position.set(0,.003,0);floor.receiveShadow=true;scene.add(floor);

    // Tiles instanced — laid FLAT on the floor (XZ plane)
    const tileDepth=0.012;// tile thickness in Y
    const grp1=[],grp2=[];
    computeTiles.tiles.forEach(t=>{if(!t.diagonal){if(t.isDamier2)grp2.push(t);else grp1.push(t)}});
    const addGroup=(arr,hex)=>{if(!arr.length)return;
      const c=new THREE.Color(hex);const mat=new THREE.MeshStandardMaterial({roughness:0.25,metalness:0.08});
      // BoxGeometry(X-width, Y-thickness, Z-depth) for floor tiles
      const mesh=new THREE.InstancedMesh(new THREE.BoxGeometry(1,tileDepth,1),mat,arr.length);
      mesh.castShadow=true;mesh.receiveShadow=true;const dummy=new THREE.Object3D();
      const ic=new Float32Array(arr.length*3);
      arr.forEach((t,i)=>{
        const sx=t.w/1000,sz=t.h/1000;
        // x: left→right, y: tile sits on top of grout slab, z: top→bottom of room
        dummy.position.set(t.x/1000+sx/2-RWm/2, tileDepth/2+.006, t.y/1000+sz/2-RHm/2);
        dummy.scale.set(sx*.985,1,sz*.985);dummy.updateMatrix();mesh.setMatrixAt(i,dummy.matrix);
        const sh=((t.col*13+t.row*17)%12-6)*0.015;
        ic[i*3]=Math.max(0,Math.min(1,c.r+sh));ic[i*3+1]=Math.max(0,Math.min(1,c.g+sh));ic[i*3+2]=Math.max(0,Math.min(1,c.b+sh*.5));
      });
      mesh.instanceColor=new THREE.InstancedBufferAttribute(ic,3);mesh.instanceMatrix.needsUpdate=true;scene.add(mesh);
    };
    addGroup(grp1,tileColor1);addGroup(grp2,tileColor2);

    // Room walls — vertical on the 4 sides of the floor area
    const wm=new THREE.MeshStandardMaterial({color:0x8a8a9a,roughness:.65,metalness:.05});
    const wH=0.5;const wT=0.04;
    // Back wall (z = -RHm/2)
    const bw=new THREE.Mesh(new THREE.BoxGeometry(RWm+wT*2,wH,wT),wm);
    bw.position.set(0,wH/2,-RHm/2-wT/2);bw.castShadow=true;bw.receiveShadow=true;scene.add(bw);
    // Left wall (x = -RWm/2)
    const lw=new THREE.Mesh(new THREE.BoxGeometry(wT,wH,RHm+wT),wm);
    lw.position.set(-RWm/2-wT/2,wH/2,0);lw.castShadow=true;lw.receiveShadow=true;scene.add(lw);
    // Right wall (x = RWm/2)
    const rw=new THREE.Mesh(new THREE.BoxGeometry(wT,wH,RHm+wT),wm);
    rw.position.set(RWm/2+wT/2,wH/2,0);rw.castShadow=true;rw.receiveShadow=true;scene.add(rw);
    // Front wall semi-transparent (z = +RHm/2)
    const fwMat=new THREE.MeshStandardMaterial({color:0x8a8a9a,roughness:.65,transparent:true,opacity:.18});
    const fw=new THREE.Mesh(new THREE.BoxGeometry(RWm+wT*2,wH,wT),fwMat);
    fw.position.set(0,wH/2,RHm/2+wT/2);scene.add(fw);

    // Baseboards on floor edges
    const bbMat=new THREE.MeshStandardMaterial({color:0xd0d0d8,roughness:.5});
    const bbH=0.055,bbT=0.009;
    const bb1=new THREE.Mesh(new THREE.BoxGeometry(RWm,bbH,bbT),bbMat);bb1.position.set(0,bbH/2,-RHm/2);scene.add(bb1);
    const bb2=new THREE.Mesh(new THREE.BoxGeometry(bbT,bbH,RHm),bbMat);bb2.position.set(-RWm/2,bbH/2,0);scene.add(bb2);
    const bb3=new THREE.Mesh(new THREE.BoxGeometry(bbT,bbH,RHm),bbMat);bb3.position.set(RWm/2,bbH/2,0);scene.add(bb3);

    // Camera — top-down angle looking at the floor
    const tgt=new THREE.Vector3(0,0,0);
    rotRef3D.current={x:-0.85,y:0.5};// look down from front-right
    zoomRef3D.current=Math.max(RWm,RHm)*1.8;
    const onD=e=>{dragRef3D.current={x:e.clientX,y:e.clientY,rx:rotRef3D.current.x,ry:rotRef3D.current.y,btn:e.button};renderer.domElement.style.cursor='grabbing'};
    const onU=()=>{dragRef3D.current=null;renderer.domElement.style.cursor='grab'};
    const onM=e=>{if(!dragRef3D.current)return;const dx=e.clientX-dragRef3D.current.x,dy=e.clientY-dragRef3D.current.y;
      if(dragRef3D.current.btn===2){panRef3D.current.x+=dx*.003;panRef3D.current.y-=dy*.003;dragRef3D.current.x=e.clientX;dragRef3D.current.y=e.clientY;}
      else{rotRef3D.current.y=dragRef3D.current.ry+dx*.005;rotRef3D.current.x=Math.max(-1.55,Math.min(-.1,dragRef3D.current.rx+dy*.005));}};
    const onW=e=>{e.preventDefault();zoomRef3D.current=Math.max(.5,Math.min(30,zoomRef3D.current*(1+e.deltaY*.001)))};
    renderer.domElement.addEventListener('mousedown',onD);renderer.domElement.addEventListener('mouseup',onU);
    renderer.domElement.addEventListener('mouseleave',onU);renderer.domElement.addEventListener('mousemove',onM);
    renderer.domElement.addEventListener('wheel',onW,{passive:false});
    let raf;const animate=()=>{raf=requestAnimationFrame(animate);
      const d=zoomRef3D.current,rx=rotRef3D.current.x,ry=rotRef3D.current.y;
      camera.position.set(tgt.x+d*Math.sin(ry)*Math.cos(rx)+panRef3D.current.x,tgt.y+d*Math.sin(-rx)+panRef3D.current.y,tgt.z+d*Math.cos(ry)*Math.cos(rx));
      camera.lookAt(tgt.x+panRef3D.current.x,tgt.y+panRef3D.current.y,tgt.z);renderer.render(scene,camera);};
    animate();sceneRef3D.current={renderer,raf};
    const onR=()=>{const w2=el.clientWidth,h2=el.clientHeight;if(w2>0&&h2>0){camera.aspect=w2/h2;camera.updateProjectionMatrix();renderer.setSize(w2,h2)}};
    window.addEventListener('resize',onR);
    return()=>{cancelAnimationFrame(raf);window.removeEventListener('resize',onR);renderer.dispose();if(el)el.innerHTML='';sceneRef3D.current={}};
  },[view3D,roomW,roomH,tileW,tileH,jointW,pattern,startCorner,orientation,tileColor1,tileColor2,jointColor,computeTiles.tiles]);

  // ── EXPORT PDF (Carrelage) ──
  const exportPDF=async()=>{
    await window._jspdfReady;const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    const pw=297,ph=210;
    doc.setFillColor(26,30,46);doc.rect(0,0,pw,28,'F');
    doc.setFontSize(16);doc.setTextColor(255);doc.text('KALEPIN — Calepinage Carrelage',14,14);
    doc.setFontSize(10);doc.setTextColor(150);doc.text(roomName+' — '+new Date().toLocaleDateString('fr-FR'),14,22);
    doc.text(PATTERNS.find(p=>p.id===pattern)?.name+' — '+tileW+'×'+tileH+'mm — Joint '+jointW+'mm',pw-14,22,{align:'right'});
    const mL=20,mT=36,maxW=pw-mL*2,maxH=ph-mT-46;
    const scale=Math.min(maxW/roomW,maxH/roomH);
    const fW=roomW*scale,fH=roomH*scale,fX=mL+(maxW-fW)/2,fY=mT;
    const jR=parseInt(jointColor.slice(1,3),16),jG=parseInt(jointColor.slice(3,5),16),jB=parseInt(jointColor.slice(5,7),16);
    doc.setFillColor(jR,jG,jB);doc.rect(fX,fY,fW,fH,'F');
    computeTiles.tiles.forEach(t=>{
      const col=t.isDamier2?tileColor2:tileColor1;
      const sh=((t.col*13+t.row*17)%12-6)*0.013;
      const r=Math.max(0,Math.min(255,parseInt(col.slice(1,3),16)+sh*255));
      const g=Math.max(0,Math.min(255,parseInt(col.slice(3,5),16)+sh*255));
      const b=Math.max(0,Math.min(255,parseInt(col.slice(5,7),16)+sh*128));
      doc.setFillColor(r,g,b);doc.rect(fX+t.x*scale,fY+t.y*scale,t.w*scale,t.h*scale,'F');
      if(!t.full){doc.setDrawColor(239,68,68);doc.setLineWidth(0.15);doc.rect(fX+t.x*scale,fY+t.y*scale,t.w*scale,t.h*scale,'S')}
    });
    doc.setDrawColor(80);doc.setLineWidth(0.5);doc.rect(fX,fY,fW,fH,'S');
    doc.setFontSize(8);doc.setTextColor(100);doc.text(roomW+' mm',fX+fW/2,fY+fH+8,{align:'center'});
    const tY=fY+fH+16;doc.setFontSize(8);doc.setTextColor(60);
    const left=[['Surface',computeTiles.totalRoomArea.toFixed(2)+' m²'],['Carreau',tileW+'×'+tileH+' mm ('+computeTiles.fullTileArea.toFixed(4)+' m²)'],
      ['Entiers',''+computeTiles.fullCount],['Coupés',''+computeTiles.cutCount],['Total',''+(computeTiles.fullCount+computeTiles.cutCount)],
      ['À commander (+10%)',''+computeTiles.tilesToOrder],['Boîtes ('+computeTiles.boxesOf.n+'/boîte)',''+computeTiles.boxesOf.boxes]];
    left.forEach(([k,v],i)=>{doc.text(k,mL,tY+i*4);doc.text(v,mL+60,tY+i*4)});
    const right=[['Pose',PATTERNS.find(p=>p.id===pattern)?.name],['Joint',jointW+' mm'],['Chute','~'+computeTiles.wastePercent.toFixed(1)+' %']];
    right.forEach(([k,v],i)=>{doc.text(k,pw-80,tY+i*4);doc.text(v,pw-30,tY+i*4)});
    doc.save('kalepin-carrelage-'+roomName.replace(/\W+/g,'_')+'.pdf');
  };

  // ── EXPORT CSV (Carrelage) ──
  const exportCSV=()=>{
    const sep=';';let csv='\uFEFF';
    csv+='KALEPIN - Calepinage Carrelage\n'+roomName+sep+roomW+'x'+roomH+'mm\n';
    csv+='Carreau'+sep+tileW+'x'+tileH+'mm'+sep+'Joint'+sep+jointW+'mm'+sep+'Pose'+sep+(PATTERNS.find(p=>p.id===pattern)?.name)+'\n\n';
    csv+='SURFACES\n';csv+='Surface'+sep+computeTiles.totalRoomArea.toFixed(2)+' m²\n';
    csv+='Carreau unitaire'+sep+computeTiles.fullTileArea.toFixed(4)+' m²\n\n';
    csv+='QUANTITES\n';csv+='Entiers'+sep+computeTiles.fullCount+'\n';csv+='Coupés'+sep+computeTiles.cutCount+'\n';
    csv+='Total'+sep+(computeTiles.fullCount+computeTiles.cutCount)+'\n';csv+='À commander (+10%)'+sep+computeTiles.tilesToOrder+'\n';
    csv+='Boîtes ('+computeTiles.boxesOf.n+'/boîte)'+sep+computeTiles.boxesOf.boxes+'\n';
    csv+='Chute estimée'+sep+'~'+computeTiles.wastePercent.toFixed(1)+' %\n\n';
    csv+='DETAIL CARREAUX\nN°'+sep+'X'+sep+'Y'+sep+'L'+sep+'H'+sep+'Type'+sep+'Coupe\n';
    computeTiles.tiles.forEach((t,i)=>{csv+=(i+1)+sep+Math.round(t.x)+sep+Math.round(t.y)+sep+Math.round(t.w)+sep+Math.round(t.h)+sep+(t.isDamier2?'Couleur2':'Couleur1')+sep+(t.full?'Non':'Oui')+'\n'});
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='kalepin-carrelage-'+roomName.replace(/\W+/g,'_')+'.csv';a.click();
  };

  // ── SVG scale ──
  const svgW=cSize.w,svgH=cSize.h;
  const mg=40;
  const sc=Math.min((svgW-mg*2)/roomW,(svgH-mg*2)/roomH)*zoom;
  const oxSvg=(svgW-roomW*sc)/2,oySvg=(svgH-roomH*sc)/2;

  // ── NI helper ──
  const NI=({label,value,onChange,unit,min=0,max=99999})=>
    <div><label style={{fontSize:9,fontWeight:600,color:'var(--t3)',display:'block',marginBottom:2}}>{label}</label>
      <div style={{display:'flex',alignItems:'center',gap:4}}>
        <input type="number" value={value} min={min} max={max} onChange={e=>onChange(Math.max(min,parseInt(e.target.value)||0))}
          style={{flex:1,padding:'5px 8px',borderRadius:6,border:'1px solid var(--bd)',background:'var(--inp)',color:'var(--t1)',fontSize:12,fontFamily:'JetBrains Mono,monospace',textAlign:'center'}}
          onKeyDown={e=>e.stopPropagation()}/>
        {unit&&<span style={{fontSize:9,color:'var(--t3)',flexShrink:0}}>{unit}</span>}
      </div></div>;

  const PATTERNS=[
    {id:'droit',name:'Droit',icon:'▦'},
    {id:'decale12',name:'Décalé ½',icon:'▤'},
    {id:'decale13',name:'Décalé ⅓',icon:'▥'},
    {id:'diagonal',name:'Diagonal 45°',icon:'◇'},
    {id:'chevron',name:'Chevron',icon:'⟨⟩'},
    {id:'damier',name:'Damier',icon:'▩'},
  ];

  const CORNERS=[
    {id:'bl',name:'Bas-Gauche',icon:'◣'},{id:'br',name:'Bas-Droite',icon:'◢'},
    {id:'tl',name:'Haut-Gauche',icon:'◤'},{id:'tr',name:'Haut-Droite',icon:'◥'},
    {id:'center',name:'Centre',icon:'◉'},
  ];

  return<div style={{display:'flex',width:'100%',height:'100%',minHeight:0,background:'var(--bg)'}}>
    {/* ─── LEFT PANEL ─── */}
    <div style={{width:260,flexShrink:0,borderRight:'1px solid var(--bd)',background:'var(--pnl)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      {/* Header */}
      <div style={{padding:'12px 14px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:10}}>
        <button onClick={onBack} style={{width:28,height:28,borderRadius:8,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontFamily:'inherit'}}>←</button>
        <div>
          <div style={{fontSize:13,fontWeight:700,color:'var(--t1)'}}>🔲 Carrelage</div>
          <div style={{fontSize:9,color:'var(--t3)'}}>Calepinage & coupes</div>
        </div>
        <div style={{flex:1}}/>
        <div style={{display:'flex',gap:3}}>
          <button onClick={()=>{const data={type:'kalepin-carrelage',version:1,roomName,roomW,roomH,roomType,tileW,tileH,jointW,tileColor1,tileColor2,jointColor,pattern,startCorner,orientation};
            const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='kalepin-carrelage-'+roomName.replace(/\W+/g,'_')+'.json';a.click()}}
            title="Exporter JSON" style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:11,display:'flex',alignItems:'center',justifyContent:'center'}}>💾</button>
          <label title="Importer JSON" style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:11,display:'flex',alignItems:'center',justifyContent:'center'}}>📥<input type="file" accept=".json" style={{display:'none'}} onChange={e=>{if(!e.target.files[0])return;const r=new FileReader();r.onload=ev=>{try{
            const d=JSON.parse(ev.target.result);if(d.type!=='kalepin-carrelage'){alert('Fichier carrelage invalide');return}
            if(d.roomName)setRoomName(d.roomName);if(d.roomW)setRoomW(d.roomW);if(d.roomH)setRoomH(d.roomH);if(d.roomType)setRoomType(d.roomType);
            if(d.tileW)setTileW(d.tileW);if(d.tileH)setTileH(d.tileH);if(d.jointW)setJointW(d.jointW);
            if(d.tileColor1)setTileColor1(d.tileColor1);if(d.tileColor2)setTileColor2(d.tileColor2);if(d.jointColor)setJointColor(d.jointColor);
            if(d.pattern)setPattern(d.pattern);if(d.startCorner)setStartCorner(d.startCorner);if(d.orientation)setOrientation(d.orientation);
            }catch(err){alert('Erreur: '+err.message)}};r.readAsText(e.target.files[0]);e.target.value=''}}/></label>
        </div>
      </div>

      <div style={{flex:1,overflowY:'auto',padding:10,display:'flex',flexDirection:'column',gap:8}}>
        {/* Room */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#0ea5e9'}}/>
            <span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Pièce</span>
          </div>
          <input type="text" value={roomName} onChange={e=>setRoomName(e.target.value)}
            style={{width:'100%',padding:'5px 8px',borderRadius:6,border:'1px solid var(--bd)',background:'var(--inp)',color:'var(--t1)',fontSize:12,marginBottom:8,boxSizing:'border-box'}}
            onKeyDown={e=>e.stopPropagation()}/>
          <div style={{display:'flex',gap:4,marginBottom:8}}>
            {['sol','mur','piscine'].map(t=><button key={t} onClick={()=>setRoomType(t)}
              style={{flex:1,padding:'4px',borderRadius:6,border:`1px solid ${roomType===t?'#0ea5e9':'var(--bd)'}`,
                background:roomType===t?'rgba(14,165,233,.1)':'var(--inp)',color:roomType===t?'#0ea5e9':'var(--t3)',
                fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',textTransform:'capitalize'}}>{t}</button>)}
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            <NI label="Largeur" value={roomW} onChange={setRoomW} unit="mm"/>
            <NI label="Hauteur" value={roomH} onChange={setRoomH} unit="mm"/>
          </div>
          <div style={{marginTop:6,fontSize:10,color:'var(--t3)',textAlign:'right'}}>
            {(roomW*roomH/1e6).toFixed(2)} m²
          </div>
        </div>

        {/* Tile */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#f59e0b'}}/>
            <span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Carreau</span>
          </div>
          <div style={{display:'flex',flexWrap:'wrap',gap:3,marginBottom:8}}>
            {TILE_PRESETS.map(p=><button key={p.name} onClick={()=>{setTileW(p.w);setTileH(p.h)}}
              style={{padding:'3px 7px',borderRadius:5,fontSize:8,fontWeight:600,cursor:'pointer',fontFamily:'inherit',
                border:`1px solid ${tileW===p.w&&tileH===p.h?'#f59e0b':'var(--bd)'}`,
                background:tileW===p.w&&tileH===p.h?'rgba(245,158,11,.1)':'var(--inp)',
                color:tileW===p.w&&tileH===p.h?'#f59e0b':'var(--t3)'}}>{p.name}</button>)}
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            <NI label="Largeur" value={tileW} onChange={setTileW} unit="mm"/>
            <NI label="Hauteur" value={tileH} onChange={setTileH} unit="mm"/>
          </div>
          <div style={{marginTop:6}}>
            <NI label="Joint" value={jointW} onChange={setJointW} unit="mm" max={20}/>
          </div>
          <div style={{display:'flex',gap:4,marginTop:8}}>
            <button onClick={()=>setOrientation('h')} style={{flex:1,padding:'4px',borderRadius:6,
              border:`1px solid ${orientation==='h'?'#f59e0b':'var(--bd)'}`,
              background:orientation==='h'?'rgba(245,158,11,.1)':'var(--inp)',
              color:orientation==='h'?'#f59e0b':'var(--t3)',fontSize:9,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>
              ▬ Horizontal</button>
            <button onClick={()=>setOrientation('v')} style={{flex:1,padding:'4px',borderRadius:6,
              border:`1px solid ${orientation==='v'?'#f59e0b':'var(--bd)'}`,
              background:orientation==='v'?'rgba(245,158,11,.1)':'var(--inp)',
              color:orientation==='v'?'#f59e0b':'var(--t3)',fontSize:9,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>
              ▮ Vertical</button>
          </div>
        </div>

        {/* Pattern */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#8b5cf6'}}/>
            <span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Motif de pose</span>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:4}}>
            {PATTERNS.map(p=><button key={p.id} onClick={()=>setPattern(p.id)}
              style={{padding:'6px 4px',borderRadius:8,border:`1px solid ${pattern===p.id?'#8b5cf6':'var(--bd)'}`,
                background:pattern===p.id?'rgba(139,92,246,.1)':'var(--inp)',cursor:'pointer',fontFamily:'inherit',textAlign:'center'}}>
              <div style={{fontSize:16}}>{p.icon}</div>
              <div style={{fontSize:8,fontWeight:600,color:pattern===p.id?'#8b5cf6':'var(--t3)',marginTop:2}}>{p.name}</div>
            </button>)}
          </div>
          <div style={{marginTop:8}}>
            <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:4}}>Départ</div>
            <div style={{display:'flex',gap:3}}>
              {CORNERS.map(c=><button key={c.id} onClick={()=>setStartCorner(c.id)} title={c.name}
                style={{flex:1,padding:'4px',borderRadius:5,fontSize:12,cursor:'pointer',fontFamily:'inherit',
                  border:`1px solid ${startCorner===c.id?'#8b5cf6':'var(--bd)'}`,
                  background:startCorner===c.id?'rgba(139,92,246,.1)':'var(--inp)',
                  color:startCorner===c.id?'#8b5cf6':'var(--t3)'}}>{c.icon}</button>)}
            </div>
          </div>
        </div>

        {/* Colors */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
            <div style={{width:3,height:12,borderRadius:2,background:'#34d399'}}/>
            <span style={{fontSize:10,fontWeight:700,color:'var(--t1)'}}>Couleurs</span>
          </div>
          <div style={{marginBottom:6}}>
            <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:3}}>Carreau {pattern==='damier'?'1':''}</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:3}}>
              {COLORS.map((c,i)=><button key={i} onClick={()=>setTileColor1(c)}
                style={{width:18,height:18,borderRadius:4,background:c,border:tileColor1===c?'2px solid #fff':'1px solid rgba(255,255,255,.1)',cursor:'pointer'}}/>)}
              <input type="color" value={tileColor1} onChange={e=>setTileColor1(e.target.value)}
                style={{width:18,height:18,borderRadius:4,border:'1px solid var(--bd)',cursor:'pointer',padding:0}}/>
            </div>
          </div>
          {pattern==='damier'&&<div style={{marginBottom:6}}>
            <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:3}}>Carreau 2</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:3}}>
              {COLORS.map((c,i)=><button key={i} onClick={()=>setTileColor2(c)}
                style={{width:18,height:18,borderRadius:4,background:c,border:tileColor2===c?'2px solid #fff':'1px solid rgba(255,255,255,.1)',cursor:'pointer'}}/>)}
              <input type="color" value={tileColor2} onChange={e=>setTileColor2(e.target.value)}
                style={{width:18,height:18,borderRadius:4,border:'1px solid var(--bd)',cursor:'pointer',padding:0}}/>
            </div>
          </div>}
          <div>
            <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:3}}>Joint</div>
            <div style={{display:'flex',gap:3}}>
              {JOINT_COLORS.map((c,i)=><button key={i} onClick={()=>setJointColor(c)}
                style={{width:18,height:18,borderRadius:4,background:c,border:jointColor===c?'2px solid #0ea5e9':'1px solid rgba(255,255,255,.1)',cursor:'pointer'}}/>)}
            </div>
          </div>
        </div>
      </div>
    </div>

    {/* ─── CENTER: SVG VISUALIZATION ─── */}
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}}>
      {/* Toolbar */}
      <div style={{padding:'8px 14px',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:8,background:'var(--pnl)',flexShrink:0}}>
        <span style={{fontSize:12,fontWeight:700,color:'var(--t1)'}}>{roomName}</span>
        <span style={{fontSize:10,color:'var(--t3)'}}>— {roomW}×{roomH}mm — {PATTERNS.find(p=>p.id===pattern)?.name}</span>
        <div style={{flex:1}}/>
        {!view3D&&<>
        <label style={{display:'flex',alignItems:'center',gap:4,fontSize:10,color:'var(--t3)',cursor:'pointer'}}>
          <input type="checkbox" checked={showDims} onChange={e=>setShowDims(e.target.checked)}/> Cotes</label>
        <label style={{display:'flex',alignItems:'center',gap:4,fontSize:10,color:'var(--t3)',cursor:'pointer'}}>
          <input type="checkbox" checked={showCuts} onChange={e=>setShowCuts(e.target.checked)}/> Coupes</label>
        <div style={{display:'flex',gap:2}}>
          <button onClick={()=>setZoom(z=>Math.max(.3,z-.15))} style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',cursor:'pointer',fontSize:14,fontFamily:'inherit'}}>−</button>
          <button onClick={()=>setZoom(1)} style={{padding:'0 8px',height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:10,fontFamily:'inherit'}}>{Math.round(zoom*100)}%</button>
          <button onClick={()=>setZoom(z=>Math.min(4,z+.15))} style={{width:26,height:26,borderRadius:6,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',cursor:'pointer',fontSize:14,fontFamily:'inherit'}}>+</button>
        </div></>}
        {/* Toggle 2D/3D */}
        <div style={{display:'flex',borderRadius:7,border:'1px solid var(--bd)',overflow:'hidden',flexShrink:0}}>
          <button onClick={()=>setView3D(false)} style={{padding:'4px 12px',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'none',
            background:!view3D?'rgba(14,165,233,.15)':'var(--crd)',color:!view3D?'#0ea5e9':'var(--t3)'}}>2D</button>
          <button onClick={()=>setView3D(true)} style={{padding:'4px 12px',fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'none',borderLeft:'1px solid var(--bd)',
            background:view3D?'rgba(14,165,233,.15)':'var(--crd)',color:view3D?'#0ea5e9':'var(--t3)'}}>🧊 3D</button>
        </div>
        <button onClick={exportPDF} style={{padding:'4px 10px',borderRadius:6,fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'1px solid rgba(239,68,68,.3)',background:'rgba(239,68,68,.08)',color:'#ef4444'}}>📄 PDF</button>
        <button onClick={exportCSV} style={{padding:'4px 10px',borderRadius:6,fontSize:10,fontWeight:600,cursor:'pointer',fontFamily:'inherit',border:'1px solid rgba(52,211,153,.3)',background:'rgba(52,211,153,.08)',color:'#34d399'}}>📊 CSV</button>
      </div>

      {/* SVG 2D */}
      {!view3D&&<div ref={svgContainerRef} style={{flex:1,position:'relative',overflow:'hidden',background:'var(--bg)'}}>
        <svg ref={svgRef} style={{position:'absolute',inset:0,width:'100%',height:'100%',display:'block'}} viewBox={`0 0 ${svgW} ${svgH}`}>
          {/* Background */}
          <rect width="100%" height="100%" fill="var(--bg)"/>

          {/* Room background with joint color */}
          <rect x={oxSvg} y={oySvg} width={roomW*sc} height={roomH*sc} fill={jointColor} rx={2}/>

          {/* Tiles */}
          {computeTiles.tiles.map((t,i)=>{
            if(t.diagonal){
              // Rotated tile — draw as polygon
              const pts=t.corners.map(p=>`${oxSvg+p.x*sc},${oySvg+p.y*sc}`).join(' ');
              return<polygon key={i} points={pts}
                fill={t.full?tileColor1:(showCuts?'rgba(239,68,68,.25)':tileColor1)}
                stroke={t.full?'rgba(0,0,0,.08)':'rgba(239,68,68,.4)'} strokeWidth={t.full?.3:.8}
                style={{cursor:'pointer'}} onMouseEnter={()=>setHoverTile(i)} onMouseLeave={()=>setHoverTile(null)}/>;
            }
            const col=t.isDamier2?tileColor2:tileColor1;
            const cutCol=showCuts&&!t.full;
            return<rect key={i} x={oxSvg+t.x*sc} y={oySvg+t.y*sc} width={t.w*sc} height={t.h*sc}
              fill={cutCol?`rgba(239,68,68,.2)`:col}
              stroke={cutCol?'rgba(239,68,68,.5)':'rgba(0,0,0,.06)'} strokeWidth={cutCol?.8:.3}
              rx={.5} style={{cursor:'pointer',transition:'fill .1s'}}
              onMouseEnter={()=>setHoverTile(i)} onMouseLeave={()=>setHoverTile(null)}/>;
          })}

          {/* Room border */}
          <rect x={oxSvg} y={oySvg} width={roomW*sc} height={roomH*sc}
            fill="none" stroke="var(--t1)" strokeWidth={2} rx={1}/>

          {/* Dimensions */}
          {showDims&&<>
            {/* Width */}
            <line x1={oxSvg} y1={oySvg+roomH*sc+20} x2={oxSvg+roomW*sc} y2={oySvg+roomH*sc+20} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={oxSvg} y1={oySvg+roomH*sc+14} x2={oxSvg} y2={oySvg+roomH*sc+26} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={oxSvg+roomW*sc} y1={oySvg+roomH*sc+14} x2={oxSvg+roomW*sc} y2={oySvg+roomH*sc+26} stroke="var(--t3)" strokeWidth={.8}/>
            <text x={oxSvg+roomW*sc/2} y={oySvg+roomH*sc+32} textAnchor="middle" fill="var(--t3)" fontSize={10} fontFamily="JetBrains Mono,monospace">{roomW} mm</text>
            {/* Height */}
            <line x1={oxSvg-20} y1={oySvg} x2={oxSvg-20} y2={oySvg+roomH*sc} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={oxSvg-26} y1={oySvg} x2={oxSvg-14} y2={oySvg} stroke="var(--t3)" strokeWidth={.8}/>
            <line x1={oxSvg-26} y1={oySvg+roomH*sc} x2={oxSvg-14} y2={oySvg+roomH*sc} stroke="var(--t3)" strokeWidth={.8}/>
            <text x={oxSvg-24} y={oySvg+roomH*sc/2} textAnchor="middle" fill="var(--t3)" fontSize={10}
              fontFamily="JetBrains Mono,monospace" transform={`rotate(-90,${oxSvg-24},${oySvg+roomH*sc/2})`}>{roomH} mm</text>
          </>}

          {/* Hover tooltip */}
          {hoverTile!==null&&computeTiles.tiles[hoverTile]&&(()=>{
            const t=computeTiles.tiles[hoverTile];
            const tx=oxSvg+(t.x||0)*sc+20,ty=oySvg+(t.y||0)*sc-10;
            return<g>
              <rect x={tx-4} y={ty-14} width={110} height={18} rx={4} fill="rgba(0,0,0,.85)"/>
              <text x={tx} y={ty} fill="#fff" fontSize={10} fontFamily="JetBrains Mono,monospace">
                {t.full?`${Math.round(t.origW)}×${Math.round(t.origH)}`:`Coupe: ${Math.round(t.w)}×${Math.round(t.h)}`}
              </text>
            </g>;
          })()}
        </svg>
      </div>}
      {/* 3D Three.js */}
      {view3D&&<div ref={mountRef} style={{flex:1,background:'#1a1e2e',cursor:'grab'}}/>}
    </div>

    {/* ─── RIGHT PANEL: RESULTS ─── */}
    <div style={{width:240,flexShrink:0,borderLeft:'1px solid var(--bd)',background:'var(--pnl)',display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div style={{padding:'12px 14px',borderBottom:'1px solid var(--bd)'}}>
        <div style={{fontSize:12,fontWeight:700,color:'var(--t1)'}}>📊 Résultats</div>
      </div>
      <div style={{flex:1,overflowY:'auto',padding:10,display:'flex',flexDirection:'column',gap:8}}>

        {/* Surface */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>SURFACE</div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Surface pièce</span>
            <span style={{fontSize:12,fontWeight:700,color:'#0ea5e9',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.totalRoomArea.toFixed(2)} m²</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Surface carreau</span>
            <span style={{fontSize:11,color:'var(--t3)',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.fullTileArea.toFixed(4)} m²</span>
          </div>
        </div>

        {/* Tiles count */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>CARREAUX</div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Carreaux entiers</span>
            <span style={{fontSize:12,fontWeight:700,color:'#34d399',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.fullCount}</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Carreaux coupés</span>
            <span style={{fontSize:12,fontWeight:700,color:'#f87171',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.cutCount}</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Total posé</span>
            <span style={{fontSize:12,fontWeight:700,color:'var(--t1)',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.totalTilesNeeded}</span>
          </div>
          <div style={{height:1,background:'var(--bd)',margin:'6px 0'}}/>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Chutes estimées</span>
            <span style={{fontSize:12,fontWeight:600,color:'#f59e0b',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.wastePercent.toFixed(1)}%</span>
          </div>
        </div>

        {/* Order */}
        <div style={{padding:12,borderRadius:10,background:'linear-gradient(135deg,rgba(14,165,233,.06),rgba(14,165,233,.02))',border:'1px solid rgba(14,165,233,.15)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'#0ea5e9',marginBottom:6}}>À COMMANDER (+10% marge)</div>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline'}}>
            <span style={{fontSize:13,fontWeight:700,color:'var(--t1)'}}>Carreaux</span>
            <span style={{fontSize:20,fontWeight:800,color:'#0ea5e9',fontFamily:'JetBrains Mono,monospace'}}>{computeTiles.tilesToOrder}</span>
          </div>
          <div style={{display:'flex',justifyContent:'space-between',marginTop:4}}>
            <span style={{fontSize:11,color:'var(--t2)'}}>Surface à acheter</span>
            <span style={{fontSize:12,fontWeight:700,color:'var(--t1)',fontFamily:'JetBrains Mono,monospace'}}>{(computeTiles.tilesToOrder*computeTiles.fullTileArea).toFixed(2)} m²</span>
          </div>
        </div>

        {/* Tile format recap */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>RÉCAPITULATIF</div>
          <div style={{fontSize:10,color:'var(--t2)',lineHeight:1.7}}>
            <div>Pièce: <b>{roomName}</b> ({roomType})</div>
            <div>Carreau: <b>{orientation==='v'?tileH:tileW}×{orientation==='v'?tileW:tileH} mm</b></div>
            <div>Joint: <b>{jointW} mm</b></div>
            <div>Motif: <b>{PATTERNS.find(p=>p.id===pattern)?.name}</b></div>
            <div>Départ: <b>{CORNERS.find(c=>c.id===startCorner)?.name}</b></div>
          </div>
        </div>

        {/* Cut details */}
        {showCuts&&computeTiles.cutCount>0&&<div style={{padding:10,borderRadius:10,background:'rgba(239,68,68,.04)',border:'1px solid rgba(239,68,68,.1)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'#f87171',marginBottom:6}}>COUPES PÉRIPHÉRIQUES</div>
          <div style={{fontSize:10,color:'var(--t2)',lineHeight:1.7}}>
            {(()=>{
              const tw=orientation==='v'?tileH:tileW;
              const th=orientation==='v'?tileW:tileH;
              const j=jointW;
              const cutRight=roomW%((tw+j))||tw;
              const cutBottom=roomH%((th+j))||th;
              return<>
                <div>Coupe droite: <b style={{color:'#f87171'}}>{Math.round(cutRight)} mm</b></div>
                <div>Coupe basse: <b style={{color:'#f87171'}}>{Math.round(cutBottom)} mm</b></div>
                <div>Nb coupes: <b>{computeTiles.cutCount}</b></div>
              </>;
            })()}
          </div>
        </div>}

        {/* Joint quantity */}
        <div style={{padding:10,borderRadius:10,background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,fontWeight:600,color:'var(--t3)',marginBottom:6}}>JOINTEMENT</div>
          <div style={{fontSize:10,color:'var(--t2)',lineHeight:1.7}}>
            {(()=>{
              const tw=orientation==='v'?tileH:tileW;
              const th=orientation==='v'?tileW:tileH;
              const perimeter=(tw+th)*2;
              const totalJointLength=computeTiles.totalTilesNeeded*perimeter/2/1000;// ml approx
              const kgPerM2=jointW<=3?0.5:jointW<=5?0.8:1.2;
              const jointKg=computeTiles.totalRoomArea*kgPerM2;
              return<>
                <div>Linéaire joints: <b>~{totalJointLength.toFixed(0)} ml</b></div>
                <div>Mortier joint: <b>~{jointKg.toFixed(1)} kg</b></div>
                <div style={{fontSize:9,color:'var(--t3)',marginTop:2}}>(base {kgPerM2} kg/m² pour joint {jointW}mm)</div>
              </>;
            })()}
          </div>
        </div>

      </div>
    </div>
  </div>;
}

// PLAN DE MASSE — Vue de dessus avec angles indépendants
// ══════════════════════════════════════════════════════════════
function PlanMasse({zones,setZones,activeZoneIdx,setActiveZoneIdx,pxPerMm,onClose,ZONE_COLORS,RAL_COLORS,ralIdx}){
  const svgRef=useRef();
  const[vb,setVb]=useState({x:-8,y:-8,w:30,h:22});
  const[panSt,setPanSt]=useState(null);
  const[selIdx,setSelIdx]=useState(activeZoneIdx);
  const[show3D,setShow3D]=useState(false);
  // Angles INDÉPENDANTS pour le plan de masse
  const[angles,setAngles]=useState(()=>zones.map(()=>0));
  // Breaks: indices de jonction dissociés
  const[breaks,setBreaks]=useState(new Set());
  const toggleBreak=(i)=>setBreaks(b=>{const n=new Set(b);n.has(i)?n.delete(i):n.add(i);return n});
  // Échafaudages multiples, positionnés librement
  const[scaffs,setScaffs]=useState([]);
  const[selSc,setSelSc]=useState(-1);
  const[dragSc,setDragSc]=useState(null);// {idx,start,orig}
  // Pièces d'angle ON/OFF
  const[showCorners,setShowCorners]=useState(true);

  // Sync angles array length with zones
  useEffect(()=>{
    setAngles(prev=>{
      if(prev.length===zones.length)return prev;
      const n=[...prev];while(n.length<zones.length)n.push(n.length*90);
      return n.slice(0,zones.length);
    });
  },[zones.length]);

  const setAngle=(i,v)=>setAngles(a=>a.map((x,j)=>j===i?v:x));

  // Compute chain: facades are segments chained end-to-end
  // angle = direction of the outward normal (0 = up in SVG = towards -Y)
  const computeChain=()=>{
    const ch=[];let cx=0,cy=0;
    zones.forEach((z,i)=>{
      if(i>0&&breaks.has(i)){// dissocié: décalage depuis la fin du précédent
        const prev=ch[ch.length-1];
        cx=prev.x2+prev.nx*2+1.5;cy=prev.y2+prev.ny*2;
      }
      const a=(angles[i]||0)*Math.PI/180;
      const dir=a+Math.PI/2;
      const L=z.L/1000,H=z.H/1000;
      const x2=cx+Math.cos(dir)*L,y2=cy+Math.sin(dir)*L;
      ch.push({i,x1:cx,y1:cy,x2,y2,nx:Math.cos(a),ny:Math.sin(a),L,H,dir,broken:i>0&&breaks.has(i)});
      cx=x2;cy=y2;
    });
    return ch;
  };
  const chain=computeChain();

  // Auto-fit viewbox on chain change
  useEffect(()=>{
    if(!chain.length)return;
    let x0=1e9,y0=1e9,x1=-1e9,y1=-1e9;
    chain.forEach(c=>{
      [c.x1,c.x2].forEach(x=>{x0=Math.min(x0,x-1.5);x1=Math.max(x1,x+1.5)});
      [c.y1,c.y2].forEach(y=>{y0=Math.min(y0,y-1.5);y1=Math.max(y1,y+1.5)});
    });
    scaffs.forEach(s=>{
      const ci=chain[s.facIdx||0];if(!ci)return;
      const cx=(ci.x1+ci.x2)/2+s.ox,cy=(ci.y1+ci.y2)/2+s.oy;
      x0=Math.min(x0,cx-3);x1=Math.max(x1,cx+3);y0=Math.min(y0,cy-3);y1=Math.max(y1,cy+3);
    });
    const w=Math.max(x1-x0,12),h=Math.max(w*0.65,y1-y0);
    setVb({x:x0-2,y:y0-2,w:w+4,h:h+4});
  },[angles.join(','),zones.map(z=>z.L).join(','),scaffs.length]);// eslint-disable-line

  // SVG coordinates helper
  const svgPt=(e)=>{
    const svg=svgRef.current;if(!svg)return{x:0,y:0};
    const r=svg.getBoundingClientRect();
    return{x:vb.x+(e.clientX-r.left)/r.width*vb.w,y:vb.y+(e.clientY-r.top)/r.height*vb.h};
  };
  const onDown=(e)=>{if(e.button!==0)return;setPanSt({s:svgPt(e),v:{...vb}})};
  const onMove=(e)=>{
    const p=svgPt(e);
    if(dragSc){
      const dx=p.x-dragSc.start.x,dy=p.y-dragSc.start.y;
      setScaffs(sc=>sc.map((s,i)=>i===dragSc.idx?{...s,ox:dragSc.orig.x+dx,oy:dragSc.orig.y+dy}:s));
      return;
    }
    if(panSt){setVb({...panSt.v,x:panSt.v.x+(panSt.s.x-p.x),y:panSt.v.y+(panSt.s.y-p.y)});}
  };
  const onUp=()=>{setPanSt(null);setDragSc(null)};
  const onWheel=(e)=>{e.preventDefault();const f=e.deltaY>0?1.12:0.9;const p=svgPt(e);
    setVb(v=>{const nw=Math.max(4,Math.min(200,v.w*f)),nh=nw*(v.h/v.w);
      return{x:p.x-(p.x-v.x)/v.w*nw,y:p.y-(p.y-v.y)/v.h*nh,w:nw,h:nh}})};

  const addScaff=()=>{
    setScaffs(s=>[...s,{facIdx:selIdx>=0?selIdx:0,ox:0,oy:0,nBays:3,nLvl:3,bayW:2.57,lvlH:2.0,dist:0.3,scaffW:0.73}]);
    setSelSc(scaffs.length);
  };

  return<div style={{position:'fixed',inset:0,zIndex:150,background:'rgba(0,0,0,.75)',backdropFilter:'blur(6px)',display:'flex',flexDirection:'column'}}>
    {/* Header */}
    <div style={{height:52,background:'var(--pnl)',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',padding:'0 16px',gap:8,flexShrink:0}}>
      <div style={{width:30,height:30,borderRadius:8,background:'rgba(14,165,233,.15)',border:'1px solid rgba(14,165,233,.25)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:15}}>🗺</div>
      <div style={{flex:1}}>
        <div style={{fontSize:13,fontWeight:700,color:'var(--t1)'}}>Plan de masse</div>
        <div style={{fontSize:10,color:'var(--t3)'}}>{zones.length} facade{zones.length>1?'s':''} · Drag = pan · Molette = zoom</div>
      </div>
      <button onClick={addScaff} style={{padding:'6px 12px',borderRadius:8,fontSize:11,fontWeight:600,border:'none',cursor:'pointer',fontFamily:'inherit',background:'rgba(16,185,129,.1)',color:'#34d399'}}>+ 🏗</button>
      <label style={{display:'flex',alignItems:'center',gap:4,fontSize:10,color:'var(--t3)',cursor:'pointer'}}>
        <input type="checkbox" checked={showCorners} onChange={e=>setShowCorners(e.target.checked)} style={{accentColor:'#a78bfa'}}/>Angles</label>
      {zones.length>=2&&<button onClick={()=>setShow3D(v=>!v)} style={{padding:'6px 14px',borderRadius:8,fontSize:11,fontWeight:600,border:'none',cursor:'pointer',fontFamily:'inherit',
        background:show3D?'rgba(167,139,250,.3)':'rgba(167,139,250,.1)',color:'var(--pp)'}}>{show3D?'↩ Plan':'🧊 3D'}</button>}
      <button onClick={onClose} style={{padding:'6px 14px',borderRadius:8,fontSize:11,fontWeight:700,border:'1px solid var(--bd)',cursor:'pointer',fontFamily:'inherit',background:'var(--crd)',color:'var(--t1)'}}>Fermer</button>
    </div>

    <div style={{flex:1,display:'flex',overflow:'hidden'}}>
      {/* ─── SVG plan ─── */}
      {!show3D&&<div style={{flex:1,position:'relative',overflow:'hidden',background:'#080810'}}>
        <svg ref={svgRef} width="100%" height="100%"
          viewBox={`${vb.x} ${vb.y} ${vb.w} ${vb.h}`}
          style={{cursor:dragSc?'grabbing':panSt?'grabbing':'grab',userSelect:'none'}}
          onMouseDown={onDown} onMouseMove={onMove} onMouseUp={onUp} onMouseLeave={onUp} onWheel={onWheel}>
          {/* Grille */}
          <defs>
            <pattern id="pm1" width="1" height="1" patternUnits="userSpaceOnUse">
              <path d="M1 0L0 0 0 1" fill="none" stroke="rgba(255,255,255,.035)" strokeWidth=".02"/></pattern>
            <pattern id="pm5" width="5" height="5" patternUnits="userSpaceOnUse">
              <rect width="5" height="5" fill="url(#pm1)"/>
              <path d="M5 0L0 0 0 5" fill="none" stroke="rgba(255,255,255,.07)" strokeWidth=".04"/></pattern>
          </defs>
          <rect x={vb.x-100} y={vb.y-100} width={vb.w+200} height={vb.h+200} fill="url(#pm5)"/>

          {/* ── Facades (segments) ── */}
          {chain.map(c=>{
            const col=ZONE_COLORS[c.i%ZONE_COLORS.length];
            const sel=c.i===selIdx;
            const wt=0.22,bt=0.07;// wall thickness, bardage thickness
            const dx=Math.cos(c.dir),dy=Math.sin(c.dir);
            // Wall rectangle (inside)
            const inx=-c.nx,iny=-c.ny;
            const wallP=[[c.x1,c.y1],[c.x2,c.y2],[c.x2+inx*wt,c.y2+iny*wt],[c.x1+inx*wt,c.y1+iny*wt]].map(p=>p.join(',')).join(' ');
            // Bardage rectangle (outside)
            const bardP=[[c.x1+c.nx*bt,c.y1+c.ny*bt],[c.x2+c.nx*bt,c.y2+c.ny*bt],[c.x2,c.y2],[c.x1,c.y1]].map(p=>p.join(',')).join(' ');
            const mx=(c.x1+c.x2)/2,my=(c.y1+c.y2)/2;
            // Joints on bardage
            const panW=(zones[c.i].pan_?.l||600)/1000;const nJ=Math.round(c.L/panW);
            return<g key={c.i} onClick={()=>{setSelIdx(c.i);setActiveZoneIdx(c.i);setSelSc(-1)}} style={{cursor:'pointer'}}>
              <polygon points={wallP} fill={sel?'rgba(130,130,140,.45)':'rgba(130,130,140,.25)'} stroke="rgba(255,255,255,.12)" strokeWidth=".02"/>
              <polygon points={bardP} fill={sel?`${col}60`:`${col}35`} stroke={col} strokeWidth={sel?.06:.03}/>
              {Array.from({length:nJ-1}).map((_,j)=>{const t=(j+1)/nJ;
                const px=c.x1+dx*c.L*t,py=c.y1+dy*c.L*t;
                return<line key={j} x1={px} y1={py} x2={px+c.nx*bt} y2={py+c.ny*bt} stroke={col} strokeWidth=".012" opacity=".35"/>})}
              {/* Normal arrow */}
              <line x1={mx} y1={my} x2={mx+c.nx*.8} y2={my+c.ny*.8} stroke={col} strokeWidth=".035" opacity=".5"/>
              <circle cx={mx+c.nx*.8} cy={my+c.ny*.8} r=".07" fill={col} opacity=".6"/>
              {/* Labels */}
              <text x={mx+c.nx*.45} y={my+c.ny*.45-.18} textAnchor="middle" dominantBaseline="middle"
                fontSize=".3" fill={col} fontWeight="700" fontFamily="DM Sans">{zones[c.i].name}</text>
              <text x={mx-c.nx*.2} y={my-c.ny*.2} textAnchor="middle" dominantBaseline="middle"
                fontSize=".2" fill="rgba(255,255,255,.3)" fontFamily="monospace">{c.L.toFixed(2)}m</text>
              {sel&&<><circle cx={c.x1} cy={c.y1} r=".1" fill={col}/><circle cx={c.x2} cy={c.y2} r=".08" fill={col} opacity=".5"/></>}
            </g>;
          })}

          {/* ── Junction angles + dissociation ── */}
          {chain.length>1&&chain.slice(1).map((c,k)=>{
            const prev=chain[k];
            const d=((angles[c.i]||0)-(angles[prev.i]||0)+360)%360;
            const disp=d>180?d-360:d;
            const isBroken=breaks.has(c.i);
            return<g key={`a${k}`}>
              <circle cx={c.x1} cy={c.y1} r=".15" fill={isBroken?"rgba(239,68,68,.3)":"rgba(14,165,233,.3)"} stroke={isBroken?"#ef4444":"#0ea5e9"} strokeWidth=".03"/>
              {showCorners&&!isBroken&&<rect x={c.x1-.07} y={c.y1-.07} width=".14" height=".14" fill="rgba(167,139,250,.5)" stroke="#a78bfa" strokeWidth=".02" rx=".02"/>}
              {/* Bouton dissocier/relier */}
              <g onClick={e=>{e.stopPropagation();toggleBreak(c.i)}} style={{cursor:'pointer'}}>
                <circle cx={c.x1} cy={c.y1-.38} r=".19" fill={isBroken?"rgba(239,68,68,.85)":"rgba(16,185,129,.7)"} stroke={isBroken?"#ef4444":"#10b981"} strokeWidth=".025"/>
                <text x={c.x1} y={c.y1-.38} textAnchor="middle" dominantBaseline="middle" fontSize=".16" fill="#fff" fontWeight="800">{isBroken?"⇔":"✂"}</text>
              </g>
              <text x={c.x1} y={c.y1-.65} textAnchor="middle" fontSize=".19" fill={isBroken?"#ef4444":"#0ea5e9"} fontWeight="700" fontFamily="monospace">{isBroken?"dissocié":(disp>0?'+':'')+disp.toFixed(0)+'°'}</text>
            </g>;
          })}

          {/* ── Scaffolds (draggable) ── */}
          {scaffs.map((s,si)=>{
            const ci=chain[s.facIdx]||chain[0];if(!ci)return null;
            const tw=s.nBays*s.bayW,td=s.scaffW;
            const dx=Math.cos(ci.dir),dy=Math.sin(ci.dir);
            const cx=(ci.x1+ci.x2)/2+s.ox,cy=(ci.y1+ci.y2)/2+s.oy;
            const d0=s.dist+0.01;
            const pts=[[cx-dx*tw/2+ci.nx*d0,cy-dy*tw/2+ci.ny*d0],
              [cx+dx*tw/2+ci.nx*d0,cy+dy*tw/2+ci.ny*d0],
              [cx+dx*tw/2+ci.nx*(d0+td),cy+dy*tw/2+ci.ny*(d0+td)],
              [cx-dx*tw/2+ci.nx*(d0+td),cy-dy*tw/2+ci.ny*(d0+td)]].map(p=>p.join(',')).join(' ');
            const isSel=si===selSc;
            return<g key={`sc${si}`} style={{cursor:'grab'}}
              onMouseDown={e=>{e.stopPropagation();e.preventDefault();setSelSc(si);setSelIdx(-1);
                setDragSc({idx:si,start:svgPt(e),orig:{x:s.ox,y:s.oy}})}}>
              <polygon points={pts} fill={isSel?'rgba(16,185,129,.18)':'rgba(16,185,129,.08)'}
                stroke="#34d399" strokeWidth={isSel?.06:.03} strokeDasharray={isSel?'none':'.12,.08'}/>
              <text x={cx+ci.nx*(d0+td/2)} y={cy+ci.ny*(d0+td/2)} textAnchor="middle" dominantBaseline="middle"
                fontSize=".25" fill="#34d399" fontWeight="700">🏗{si+1}</text>
              {/* Resize handles */}
              {isSel&&<>
                <circle cx={cx-dx*tw/2+ci.nx*(d0+td/2)} cy={cy-dy*tw/2+ci.ny*(d0+td/2)} r=".12" fill="#34d399" opacity=".6"/>
                <circle cx={cx+dx*tw/2+ci.nx*(d0+td/2)} cy={cy+dy*tw/2+ci.ny*(d0+td/2)} r=".12" fill="#34d399" opacity=".6"/>
              </>}
            </g>;
          })}

          {/* Nord */}
          <g transform={`translate(${vb.x+vb.w-1.5},${vb.y+1})`}>
            <circle r=".45" fill="rgba(0,0,0,.7)" stroke="rgba(255,255,255,.12)" strokeWidth=".025"/>
            <polygon points="0,-.3 -.07,.05 .07,.05" fill="white" opacity=".8"/>
            <text x="0" y="-.1" textAnchor="middle" fontSize=".17" fill="white" fontWeight="700">N</text>
          </g>
        </svg>
      </div>}

      {/* ─── 3D multi-zones ─── */}
      {show3D&&<div style={{flex:1,position:'relative',overflow:'hidden'}}>
        <Facade3DMulti zones={zones} chain={chain} ZONE_COLORS={ZONE_COLORS} scaffs={scaffs} showCorners={showCorners} RAL_COLORS={RAL_COLORS} ralIdx={ralIdx}/>
      </div>}

      {/* ─── Sidebar ─── */}
      <div style={{width:260,background:'var(--pnl)',borderLeft:'1px solid var(--bd)',overflowY:'auto',flexShrink:0,display:'flex',flexDirection:'column'}}>
        {/* Facades list */}
        <div style={{padding:'10px 14px 6px',borderBottom:'1px solid var(--bd)'}}>
          <div style={{fontSize:10,fontWeight:700,color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.08em'}}>Facades — {zones.length}</div>
        </div>
        {zones.map((z,i)=>{
          const col=ZONE_COLORS[i%ZONE_COLORS.length];
          const sel=i===selIdx;
          const c=chain[i];
          return<div key={z.id} onClick={()=>{setSelIdx(i);setActiveZoneIdx(i);setSelSc(-1)}} style={{
            padding:'8px 14px',borderBottom:'1px solid var(--bd)',cursor:'pointer',
            background:sel?`${col}10`:'transparent',borderLeft:`3px solid ${sel?col:'transparent'}`}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <span style={{fontSize:11,fontWeight:700,color:sel?col:'var(--t1)'}}>{z.name}</span>
              <span style={{fontSize:9,color:'var(--t3)',fontFamily:'monospace'}}>{(z.L/1000).toFixed(1)}×{(z.H/1000).toFixed(1)}m</span>
            </div>
            {sel&&<div style={{marginTop:6,display:'flex',flexDirection:'column',gap:6}}>
              <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:3}}>
                  <span style={{fontSize:9,fontWeight:600,color:'var(--t3)'}}>Orientation plan</span>
                  <div style={{display:'flex',alignItems:'center',gap:3}}>
                    <input type="number" value={angles[i]||0}
                      onChange={e=>setAngle(i,parseFloat(e.target.value)||0)}
                      onKeyDown={e=>e.stopPropagation()}
                      style={{width:48,padding:'2px 4px',background:'var(--inp)',border:'1px solid var(--bd)',borderRadius:4,color:'#f59e0b',fontSize:10,fontFamily:'monospace',textAlign:'center',outline:'none'}}/>
                    <span style={{fontSize:9,color:'var(--t3)'}}>°</span>
                  </div>
                </div>
                <input type="range" min="-180" max="180" step="1" value={angles[i]||0}
                  onChange={e=>setAngle(i,parseFloat(e.target.value))}
                  style={{width:'100%',accentColor:'#f59e0b',height:2}}/>
                <div style={{display:'flex',gap:3,marginTop:3}}>
                  {[0,90,180,270].map(v=><button key={v} onClick={e=>{e.stopPropagation();setAngle(i,v)}}
                    style={{flex:1,padding:'2px 0',fontSize:8,borderRadius:3,border:'1px solid var(--bd)',
                      background:Math.abs((angles[i]||0)-v)<1?'rgba(245,158,11,.2)':'var(--inp)',
                      color:'var(--t3)',cursor:'pointer',fontFamily:'monospace'}}>{v}°</button>)}
                </div>
              </div>
              {i>0&&(()=>{const d=((angles[i]||0)-(angles[i-1]||0)+360)%360;const disp=d>180?d-360:d;
                return<div style={{padding:'4px 8px',background:'rgba(14,165,233,.07)',borderRadius:6,border:'1px solid rgba(14,165,233,.1)',fontSize:9,color:'var(--t3)'}}>
                  ∠ {zones[i-1].name}: <span style={{color:'#0ea5e9',fontWeight:700,fontFamily:'monospace'}}>{disp>0?'+':''}{disp}°</span></div>})()}
              {/* RAL from 2D */}
              <div style={{display:'flex',alignItems:'center',gap:6,padding:'4px 0'}}>
                <div style={{width:14,height:14,borderRadius:3,background:RAL_COLORS[z.ralIdx??ralIdx]?.hex||'#383E42',border:'1px solid rgba(255,255,255,.2)',flexShrink:0}}/>
                <span style={{fontSize:9,color:'var(--t3)'}}>{RAL_COLORS[z.ralIdx??ralIdx]?.code||'RAL 7016'}</span>
                <span style={{fontSize:8,color:'var(--t3)',opacity:.5}}>(2D)</span>
              </div>
              <div style={{fontSize:9,color:'var(--t3)',opacity:.5}}>Ouvertures: {z.ouvs.length}</div>
            </div>}
          </div>;
        })}

        {/* Scaffolds config */}
        {scaffs.length>0&&<div style={{borderTop:'1px solid rgba(16,185,129,.2)'}}>
          <div style={{padding:'8px 14px 4px'}}>
            <span style={{fontSize:10,fontWeight:700,color:'#34d399'}}>🏗 Échafaudages ({scaffs.length})</span>
          </div>
          {scaffs.map((s,si)=>{
            const sel=si===selSc;
            return<div key={si} onClick={()=>{setSelSc(si);setSelIdx(-1)}} style={{
              padding:'8px 14px',borderBottom:'1px solid var(--bd)',cursor:'pointer',
              background:sel?'rgba(16,185,129,.05)':'transparent',borderLeft:`3px solid ${sel?'#34d399':'transparent'}`}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <span style={{fontSize:10,fontWeight:600,color:sel?'#34d399':'var(--t2)'}}>🏗 {si+1}</span>
                <div style={{display:'flex',gap:4,alignItems:'center'}}>
                  <span style={{fontSize:8,color:'var(--t3)',fontFamily:'monospace'}}>{(s.nBays*s.bayW).toFixed(1)}×{(s.nLvl*s.lvlH).toFixed(1)}m</span>
                  <button onClick={e=>{e.stopPropagation();setScaffs(sc=>sc.filter((_,j)=>j!==si));setSelSc(-1)}}
                    style={{background:'rgba(239,68,68,.15)',border:'none',color:'#f87171',borderRadius:3,padding:'1px 4px',fontSize:8,cursor:'pointer'}}>✕</button>
                </div>
              </div>
              {sel&&<div style={{marginTop:6,display:'flex',flexDirection:'column',gap:3}}>
                <div><label style={{fontSize:8,color:'var(--t3)'}}>Facade</label>
                  <select value={s.facIdx} onChange={e=>setScaffs(sc=>sc.map((x,j)=>j===si?{...x,facIdx:+e.target.value}:x))}
                    style={{width:'100%',padding:'2px 6px',background:'var(--inp)',border:'1px solid var(--bd)',borderRadius:4,color:'var(--t1)',fontSize:9}}>
                    {zones.map((z,k)=><option key={k} value={k}>{z.name}</option>)}</select></div>
                {[{l:'Travées',k:'nBays',min:1,max:15,step:1},
                  {l:'Niveaux',k:'nLvl',min:1,max:12,step:1},
                  {l:'L.travée',k:'bayW',min:.73,max:4,step:.05},
                  {l:'H.niveau',k:'lvlH',min:1,max:3,step:.1},
                  {l:'Prof.',k:'scaffW',min:.6,max:1.5,step:.05},
                  {l:'Dist.',k:'dist',min:.1,max:3,step:.05},
                ].map(p=><div key={p.k} style={{display:'flex',alignItems:'center',gap:3}}>
                  <span style={{fontSize:8,color:'var(--t3)',width:44,flexShrink:0}}>{p.l}</span>
                  <input type="range" min={p.min} max={p.max} step={p.step} value={s[p.k]||0}
                    onChange={e=>setScaffs(sc=>sc.map((x,j)=>j===si?{...x,[p.k]:+e.target.value}:x))}
                    style={{flex:1,accentColor:'#34d399',height:2}}/>
                  <span style={{fontSize:8,color:'#34d399',width:28,textAlign:'right',fontFamily:'monospace'}}>{s[p.k]%1?s[p.k].toFixed(1):s[p.k]}</span>
                </div>)}
                <div style={{fontSize:8,color:'var(--t3)',opacity:.5}}>Drag rectangle pour déplacer</div>
              </div>}
            </div>;
          })}
        </div>}

        {/* Legend */}
        <div style={{padding:'10px 14px',marginTop:'auto',borderTop:'1px solid var(--bd)'}}>
          <div style={{fontSize:9,color:'var(--t3)',lineHeight:1.8}}>
            ↑ = face bardage · Molette = zoom<br/>
            Drag fond = pan · Drag 🏗 = déplacer<br/>
            Les angles n'impactent pas la vue 2D
          </div>
        </div>
      </div>
    </div>
  </div>;
}

// ══════════════════════════════════════════════════════════════
// FACADE 3D MULTI-ZONES — Facades jointes avec ouvertures
// ══════════════════════════════════════════════════════════════
function Facade3DMulti({zones,chain,ZONE_COLORS,scaffs,showCorners,RAL_COLORS,ralIdx}){
  const mountRef=useRef();const frameRef=useRef();
  const rotRef=useRef({x:-.3,y:.5});const dragRef=useRef(null);
  const zoomRef=useRef(10);const panRef=useRef({x:0,y:2});

  useEffect(()=>{
    if(!zones.length||!chain||!chain.length||!mountRef.current)return;
    const W=mountRef.current.clientWidth,H=mountRef.current.clientHeight;
    const scene=new THREE.Scene();scene.background=new THREE.Color(0x1a1e2e);
    const camera=new THREE.PerspectiveCamera(42,W/H,0.01,500);
    const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
    renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
    renderer.shadowMap.enabled=true;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.1;
    mountRef.current.innerHTML='';mountRef.current.appendChild(renderer.domElement);
    renderer.domElement.style.pointerEvents='auto';renderer.domElement.style.cursor='grab';

    scene.add(new THREE.AmbientLight(0xe8e8f0,0.5));
    const sun=new THREE.DirectionalLight(0xfff5e0,1.0);sun.position.set(8,15,10);sun.castShadow=true;scene.add(sun);
    const fill=new THREE.DirectionalLight(0x8ab0ff,0.3);fill.position.set(-5,-2,4);scene.add(fill);

    const ground=new THREE.Mesh(new THREE.PlaneGeometry(100,100),new THREE.MeshStandardMaterial({color:0x1a1a2a,roughness:.9}));
    ground.rotation.x=-Math.PI/2;ground.position.y=-.01;ground.receiveShadow=true;scene.add(ground);

    // Centroid
    let sx=0,sz=0;chain.forEach(c=>{sx+=(c.x1+c.x2)/2;sz+=(c.y1+c.y2)/2});
    const cx0=sx/chain.length,cz0=sz/chain.length;

    // Shared materials
    const frameMat=new THREE.MeshStandardMaterial({color:0x3a3a42,metalness:.8,roughness:.15});
    const glassBackMat=new THREE.MeshStandardMaterial({color:0x1a2a3a,roughness:.95,transparent:true,opacity:.6,side:2});
    const glassMat=new THREE.MeshStandardMaterial({color:0x9cc8e8,metalness:.4,roughness:.02,transparent:true,opacity:.35,side:2});
    const ossMat=new THREE.MeshStandardMaterial({color:0x8a8a8a,metalness:.7,roughness:.3});

    // ── Build each facade ──
    chain.forEach(c=>{
      const zone=zones[c.i],Lm=c.L,Hm=c.H;
      const zRal=RAL_COLORS[zone.ralIdx??ralIdx]||{hex:'#383E42',finish:'mat'};
      const baseColor=new THREE.Color(zRal.hex);
      const fin=zRal.finish||'mat';
      const grp=new THREE.Group();
      grp.position.set((c.x1+c.x2)/2-cx0,0,(c.y1+c.y2)/2-cz0);
      grp.rotation.y=Math.PI-c.dir;// +Z local = vers l'extérieur (normale)

      const metalness=fin==='brillant'?.65:fin==='satine'?.5:.35;
      const roughness=fin==='brillant'?.15:fin==='satine'?.35:.55;
      const panMat=new THREE.MeshStandardMaterial({color:baseColor,metalness,roughness});
      const retMat=new THREE.MeshStandardMaterial({color:baseColor,metalness,roughness:roughness+.1,
        polygonOffset:true,polygonOffsetFactor:-1,polygonOffsetUnits:-1});
      const wallMat=new THREE.MeshStandardMaterial({color:0x787878,roughness:.95,transparent:true,opacity:.5});
      const ouvs=zone.ouvs||[];
      const depth=0.008;

      // Facade panel = flat shape with holes for openings (ShapeGeometry = reliable normals)
      const facShape=new THREE.Shape();
      facShape.moveTo(-Lm/2,0);facShape.lineTo(Lm/2,0);facShape.lineTo(Lm/2,Hm);facShape.lineTo(-Lm/2,Hm);facShape.lineTo(-Lm/2,0);
      ouvs.forEach(o=>{
        const ox=o.x/1000-Lm/2,oy=o.y/1000,ow=o.w/1000,oh=o.h/1000;
        const hole=new THREE.Path();
        hole.moveTo(ox,oy);hole.lineTo(ox+ow,oy);hole.lineTo(ox+ow,oy+oh);hole.lineTo(ox,oy+oh);hole.lineTo(ox,oy);
        facShape.holes.push(hole);
      });
      // Front face (exterior) - faces +Z = outward
      const panMat2=panMat.clone();panMat2.side=THREE.DoubleSide;
      const facMeshF=new THREE.Mesh(new THREE.ShapeGeometry(facShape),panMat2);
      facMeshF.position.z=.006;facMeshF.castShadow=true;grp.add(facMeshF);
      // Back face (interior side of panel, slightly behind)
      const facMeshB=new THREE.Mesh(new THREE.ShapeGeometry(facShape),panMat2);
      facMeshB.position.z=0;grp.add(facMeshB);

      // Joint lines (clipped around openings)
      const panW=(zone.pan_?.l||600)/1000,panH=(zone.pan_?.w||600)/1000;
      const jH=(zone.jointH||6)/1000||.006,jV=(zone.jointV||6)/1000||.006;
      const jointMat=new THREE.MeshStandardMaterial({color:0x111418,metalness:.15,roughness:.9});
      const nC=Math.max(1,Math.round(Lm/panW)),nR=Math.max(1,Math.round(Hm/panH));
      const oRects=ouvs.map(o=>({l:o.x/1000-Lm/2,r:(o.x+o.w)/1000-Lm/2,b:o.y/1000,t:(o.y+o.h)/1000}));
      // Vertical joints — split segments around openings
      for(let j=1;j<nC;j++){const jx=-Lm/2+j*(Lm/nC);
        let segs=[{a:0,b:Hm}];
        oRects.forEach(o=>{if(jx<o.l||jx>o.r)return;const ns=[];
          segs.forEach(s=>{if(o.b>=s.b||o.t<=s.a){ns.push(s);return}
            if(s.a<o.b)ns.push({a:s.a,b:o.b});if(o.t<s.b)ns.push({a:o.t,b:s.b});});segs=ns;});
        segs.forEach(s=>{const h=s.b-s.a;if(h<.02)return;
          const m=new THREE.Mesh(new THREE.BoxGeometry(jV,h,.008),jointMat);m.position.set(jx,s.a+h/2,.004);grp.add(m);});}
      // Horizontal joints — split segments around openings
      for(let j=1;j<nR;j++){const jy=j*(Hm/nR);
        let segs=[{a:-Lm/2,b:Lm/2}];
        oRects.forEach(o=>{if(jy<o.b||jy>o.t)return;const ns=[];
          segs.forEach(s=>{if(o.l>=s.b||o.r<=s.a){ns.push(s);return}
            if(s.a<o.l)ns.push({a:s.a,b:o.l});if(o.r<s.b)ns.push({a:o.r,b:s.b});});segs=ns;});
        segs.forEach(s=>{const w=s.b-s.a;if(w<.02)return;
          const m=new THREE.Mesh(new THREE.BoxGeometry(w,jH,.008),jointMat);m.position.set(s.a+w/2,jy,.004);grp.add(m);});}

      // Openings
      ouvs.forEach(o=>{
        const ox=o.x/1000-Lm/2,oy=o.y/1000,ow=o.w/1000,oh=o.h/1000;
        const rt=o.retours||{tG:150,tD:150,lin:150,app:150};
        const fv=(o.faceVis||50)/1000,st=.003;
        const rG=rt.tG/1000,rD=rt.tD/1000,rL=rt.lin/1000,rA=rt.app/1000;
        // Depth returns
        if(rG>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(st,oh,rG),retMat);m.position.set(ox-st/2,oy+oh/2,-rG/2);grp.add(m);}
        if(rD>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(st,oh,rD),retMat);m.position.set(ox+ow+st/2,oy+oh/2,-rD/2);grp.add(m);}
        if(rL>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(ow,st,rL),retMat);m.position.set(ox+ow/2,oy+oh+st/2,-rL/2);grp.add(m);}
        if(rA>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(ow,st,rA),retMat);m.position.set(ox+ow/2,oy-st/2,-rA/2);grp.add(m);}
        // Face visible
        if(fv>.001){
          if(rG>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(fv,oh+fv*2,st),retMat);m.position.set(ox-fv/2,oy+oh/2,depth+.001);grp.add(m);}
          if(rD>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(fv,oh+fv*2,st),retMat);m.position.set(ox+ow+fv/2,oy+oh/2,depth+.001);grp.add(m);}
          if(rL>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,st),retMat);m.position.set(ox+ow/2,oy+oh+fv/2,depth+.001);grp.add(m);}
          if(rA>.001){const m=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,st),retMat);m.position.set(ox+ow/2,oy-fv/2,depth+.001);grp.add(m);}
        }
        // Glass
        const maxR=Math.max(rG,rD,rL,rA,.05);const gz=-maxR*.65;
        const gb=new THREE.Mesh(new THREE.PlaneGeometry(ow-.008,oh-.008),glassBackMat);
        gb.position.set(ox+ow/2,oy+oh/2,gz-.003);grp.add(gb);
        const gm=new THREE.Mesh(new THREE.PlaneGeometry(ow-.006,oh-.006),glassMat);
        gm.position.set(ox+ow/2,oy+oh/2,gz);grp.add(gm);
        // Alu frame
        const ft=.032,fd=.045;
        const fT=new THREE.Mesh(new THREE.BoxGeometry(ow+ft,ft,fd),frameMat);fT.position.set(ox+ow/2,oy+oh+ft/2,gz);grp.add(fT);
        const fB=new THREE.Mesh(new THREE.BoxGeometry(ow+ft,ft,fd),frameMat);fB.position.set(ox+ow/2,oy-ft/2,gz);grp.add(fB);
        const fLf=new THREE.Mesh(new THREE.BoxGeometry(ft,oh+ft*2,fd),frameMat);fLf.position.set(ox-ft/2,oy+oh/2,gz);grp.add(fLf);
        const fRf=new THREE.Mesh(new THREE.BoxGeometry(ft,oh+ft*2,fd),frameMat);fRf.position.set(ox+ow+ft/2,oy+oh/2,gz);grp.add(fRf);
      });

      // Studs (with exclusion around openings)
      const eM=(zone.oss?.eM||600)/1000,hM=.035;
      const excl=ouvs.map(o=>({l:o.x/1000-Lm/2-hM,r:(o.x+o.w)/1000-Lm/2+hM,t:o.y/1000-hM,b:(o.y+o.h)/1000+hM}));
      for(let mx=0;mx<=Lm+.001;mx+=eM){
        const xp=-Lm/2+mx;let segs=[{a:0,b:Hm}];
        excl.forEach(ex=>{if(xp<ex.l||xp>ex.r)return;
          const ns=[];segs.forEach(s=>{if(ex.t>=s.b||ex.b<=s.a){ns.push(s);return}
            if(s.a<ex.t)ns.push({a:s.a,b:ex.t});if(ex.b<s.b)ns.push({a:ex.b,b:s.b});});segs=ns;});
        segs.forEach(s=>{const h=s.b-s.a;if(h<.02)return;
          const m=new THREE.Mesh(new THREE.BoxGeometry(.05,h,.04),ossMat);m.position.set(xp,s.a+h/2,-.025);grp.add(m);});
      }

      // Concrete wall
      const wall=new THREE.Mesh(new THREE.BoxGeometry(Lm+.02,Hm+.02,.18),wallMat);
      wall.position.set(0,Hm/2,-.12);wall.receiveShadow=true;grp.add(wall);
      scene.add(grp);
    });

    // ── Corner pieces ──
    if(showCorners&&chain.length>1){
      const cMat=new THREE.MeshStandardMaterial({color:0x505058,metalness:.7,roughness:.2});
      chain.slice(1).forEach((c,k)=>{
        const prev=chain[k];const jx=c.x1-cx0,jz=c.y1-cz0;
        const h=Math.min(prev.H,c.H);const cw=.06,aL=.15;
        // Vertical post
        const post=new THREE.Mesh(new THREE.BoxGeometry(cw,h,cw),cMat);
        post.position.set(jx,h/2,jz);scene.add(post);
        // Fins along each facade
        const a1=new THREE.Mesh(new THREE.BoxGeometry(aL,h,.003),cMat);
        a1.position.set(jx-Math.cos(prev.dir)*aL/2,h/2,jz-Math.sin(prev.dir)*aL/2);
        a1.rotation.y=Math.PI-prev.dir;scene.add(a1);
        const a2=new THREE.Mesh(new THREE.BoxGeometry(aL,h,.003),cMat);
        a2.position.set(jx+Math.cos(c.dir)*aL/2,h/2,jz+Math.sin(c.dir)*aL/2);
        a2.rotation.y=Math.PI-c.dir;scene.add(a2);
      });
    }

    // ── Scaffoldings ──
    const sMat=new THREE.MeshStandardMaterial({color:0xb8b8c0,metalness:.7,roughness:.25});
    const pMat=new THREE.MeshStandardMaterial({color:0x9B7424,roughness:.9});
    const gMat=new THREE.MeshStandardMaterial({color:0xe8d020,metalness:.45,roughness:.25});
    const tubR=.024,tubS=6;

    const makeTube=(grp,p1,p2,r,mat)=>{
      const dx=p2[0]-p1[0],dy=p2[1]-p1[1],dz=p2[2]-p1[2];
      const len=Math.sqrt(dx*dx+dy*dy+dz*dz);if(len<.001)return;
      const m=new THREE.Mesh(new THREE.CylinderGeometry(r,r,len,tubS),mat);
      m.position.set((p1[0]+p2[0])/2,(p1[1]+p2[1])/2,(p1[2]+p2[2])/2);
      const dir=new THREE.Vector3(dx,dy,dz).normalize();
      const up=new THREE.Vector3(0,1,0);
      if(Math.abs(dir.dot(up))<.9999)m.quaternion.setFromUnitVectors(up,dir);
      grp.add(m);
    };

    (scaffs||[]).forEach(s=>{
      const ci=chain[s.facIdx||0];if(!ci)return;
      const sg=new THREE.Group();
      sg.position.set((ci.x1+ci.x2)/2-cx0+s.ox,0,(ci.y1+ci.y2)/2-cz0+s.oy);
      sg.rotation.y=Math.PI-ci.dir;
      const {nBays,nLvl,bayW,lvlH,dist,scaffW}=s;
      const tw=nBays*bayW,th=nLvl*lvlH;
      const zB=.01+dist,zF=zB+scaffW;
      const oX=-tw/2;
      // Verticals
      for(let bi=0;bi<=nBays;bi++){const mx=oX+bi*bayW;
        [zF,zB].forEach(zz=>{
          makeTube(sg,[mx,0,zz],[mx,th+.3,zz],tubR,sMat);
          const plate=new THREE.Mesh(new THREE.BoxGeometry(.15,.008,.15),sMat);
          plate.position.set(mx,.004,zz);sg.add(plate);
        });}
      // Levels
      for(let li=0;li<=nLvl;li++){const ly=li*lvlH;
        [zF,zB].forEach(zz=>makeTube(sg,[oX,ly,zz],[oX+tw,ly,zz],tubR,sMat));
        for(let bi=0;bi<=nBays;bi++)makeTube(sg,[oX+bi*bayW,ly,zB],[oX+bi*bayW,ly,zF],tubR,sMat);
        if(li>0){
          const plank=new THREE.Mesh(new THREE.BoxGeometry(tw,.035,scaffW-.06),pMat);
          plank.position.set(oX+tw/2,ly+.017,(zF+zB)/2);sg.add(plank);
          [.5,1].forEach(gh=>makeTube(sg,[oX,ly+gh,zF],[oX+tw,ly+gh,zF],tubR*.65,gMat));
        }
        if(li<nLvl)for(let bi=0;bi<nBays;bi++){const x1=oX+bi*bayW,x2=oX+(bi+1)*bayW;
          if((bi+li)%2===0)makeTube(sg,[x1,ly,zF],[x2,ly+lvlH,zF],tubR*.5,sMat);
          else makeTube(sg,[x2,ly,zF],[x1,ly+lvlH,zF],tubR*.5,sMat);}
      }
      scene.add(sg);
    });

    // ── Animate ──
    const animate=()=>{
      frameRef.current=requestAnimationFrame(animate);
      const r=rotRef.current,z=zoomRef.current,p=panRef.current;
      camera.position.set(p.x+z*Math.sin(r.y)*Math.cos(r.x),p.y+z*Math.sin(r.x),z*Math.cos(r.y)*Math.cos(r.x));
      camera.lookAt(p.x,p.y,0);renderer.render(scene,camera);
    };animate();

    // ── Controls ──
    const canvas=renderer.domElement;
    const onMD=e=>{if(e.shiftKey||e.button===2)dragRef.current={t:'p',sx:e.clientX,sy:e.clientY,px:panRef.current.x,py:panRef.current.y};
      else dragRef.current={t:'r',sx:e.clientX,sy:e.clientY,rx:rotRef.current.x,ry:rotRef.current.y}};
    const onMM=e=>{const d=dragRef.current;if(!d)return;const dx=e.clientX-d.sx,dy=e.clientY-d.sy;
      if(d.t==='r')rotRef.current={x:Math.max(-1.4,Math.min(1.4,d.rx-dy*.006)),y:d.ry+dx*.006};
      if(d.t==='p')panRef.current={x:d.px-dx*.015*zoomRef.current/10,y:d.py+dy*.015*zoomRef.current/10}};
    const onMU=()=>dragRef.current=null;
    const onWH=e=>{e.preventDefault();zoomRef.current=Math.max(1,Math.min(80,zoomRef.current*(1+e.deltaY*.001)))};
    canvas.addEventListener('mousedown',onMD);canvas.addEventListener('mousemove',onMM);
    canvas.addEventListener('mouseup',onMU);canvas.addEventListener('mouseleave',onMU);
    canvas.addEventListener('wheel',onWH,{passive:false});canvas.addEventListener('contextmenu',e=>e.preventDefault());
    return()=>{cancelAnimationFrame(frameRef.current);renderer.dispose();if(mountRef.current)mountRef.current.innerHTML=''}
  },[zones,chain,scaffs,showCorners,ralIdx]);// eslint-disable-line

  return<div ref={mountRef} style={{width:'100%',height:'100%',touchAction:'none'}}/>;
}

function ProjectsModal({onClose,onOpen,currentProjectId}){
  const[projects,setProjects]=useState([]);const[loading,setLoading]=useState(true);
  const[deleting,setDeleting]=useState(null);const[search,setSearch]=useState('');

  const refresh=()=>{setLoading(true);cloudProjectsList().then(p=>{setProjects(p||[]);setLoading(false)})};
  useEffect(()=>{refresh()},[]);

  const filtered=projects.filter(p=>!search||p.name.toLowerCase().includes(search.toLowerCase()));

  const handleDelete=async(id)=>{
    if(!confirm('Supprimer ce projet definitivement ?'))return;
    setDeleting(id);const ok=await cloudProjectDelete(id);
    if(ok)setProjects(prev=>prev.filter(p=>p.id!==id));
    setDeleting(null);
  };
  const handleDuplicate=async(id)=>{
    const dup=await cloudProjectDuplicate(id);if(dup)refresh();
  };

  const fmtDate=(d)=>{try{const dt=new Date(d);return dt.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}catch(e){return'-'}};

  return<div className="ov" onClick={onClose}>
    <div onClick={e=>e.stopPropagation()} style={{background:'var(--pnl)',border:'1px solid var(--bd)',borderRadius:20,width:560,maxWidth:'95vw',maxHeight:'85vh',display:'flex',flexDirection:'column',boxShadow:'0 25px 60px rgba(0,0,0,.5)'}}>
      {/* Header */}
      <div style={{padding:'20px 24px 16px',borderBottom:'1px solid var(--bd)',flexShrink:0}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
          <div style={{fontSize:17,fontWeight:700,color:'var(--t1)'}}>☁ Mes projets</div>
          <button onClick={onClose} style={{background:'var(--crd)',border:'1px solid var(--bd)',borderRadius:8,width:28,height:28,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',color:'var(--t3)',fontSize:14}}>×</button>
        </div>
        <input type="text" value={search} onChange={e=>setSearch(e.target.value)} placeholder="Rechercher un projet..."
          style={{width:'100%',padding:'10px 14px',background:'var(--inp)',border:'1px solid var(--bd)',borderRadius:10,color:'var(--t1)',fontSize:13,fontFamily:'inherit',outline:'none',boxSizing:'border-box'}}
          onFocus={e=>e.target.style.borderColor='var(--bdf)'} onBlur={e=>e.target.style.borderColor='var(--bd)'} onKeyDown={e=>e.stopPropagation()}/>
      </div>

      {/* List */}
      <div style={{flex:1,overflowY:'auto',padding:'8px 12px'}}>
        {loading?<div style={{textAlign:'center',padding:40,color:'var(--t3)',fontSize:13}}>Chargement...</div>
        :filtered.length===0?<div style={{textAlign:'center',padding:40,color:'var(--t3)',fontSize:13}}>
          {projects.length===0?'Aucun projet sauvegarde. Creez votre premier projet !':'Aucun resultat pour "'+search+'"'}
        </div>
        :filtered.map(p=><div key={p.id} className="group" style={{
          display:'flex',alignItems:'center',gap:12,padding:'12px 14px',borderRadius:12,cursor:'pointer',
          transition:'all .15s',border:'1px solid transparent',marginBottom:4,
          background:p.id===currentProjectId?'rgba(196,50,74,.08)':'transparent',
          borderColor:p.id===currentProjectId?'rgba(196,50,74,.2)':'transparent'
        }}
          onMouseOver={e=>{if(p.id!==currentProjectId)e.currentTarget.style.background='var(--crd)'}}
          onMouseOut={e=>{if(p.id!==currentProjectId)e.currentTarget.style.background='transparent'}}
          onClick={()=>onOpen(p.id)}>
          {/* Icon */}
          <div style={{width:40,height:40,borderRadius:10,background:'linear-gradient(135deg,var(--crd),var(--crd2))',border:'1px solid var(--bd)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,flexShrink:0}}>🏗</div>
          {/* Info */}
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:13,fontWeight:600,color:'var(--t1)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
              {p.name}{p.id===currentProjectId&&<span style={{fontSize:9,color:'var(--gn)',marginLeft:8,fontWeight:700}}>● OUVERT</span>}
            </div>
            <div style={{fontSize:10,color:'var(--t3)',marginTop:2,display:'flex',gap:12}}>
              <span>{fmtDate(p.updated_at)}</span>
              <span>{p.zones_count||0} zone{(p.zones_count||0)>1?'s':''}</span>
              <span>{(p.total_surface||0).toFixed(1)} m²</span>
            </div>
          </div>
          {/* Actions */}
          <div style={{display:'flex',gap:4,flexShrink:0}} onClick={e=>e.stopPropagation()}>
            <button onClick={()=>handleDuplicate(p.id)} title="Dupliquer" className="ba" style={{width:28,height:28,borderRadius:7,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t3)',cursor:'pointer',fontSize:12,display:'flex',alignItems:'center',justifyContent:'center'}}>📋</button>
            <button onClick={()=>handleDelete(p.id)} title="Supprimer" className="ba" style={{width:28,height:28,borderRadius:7,border:'1px solid rgba(239,68,68,.2)',background:'rgba(239,68,68,.06)',color:'var(--rs)',cursor:'pointer',fontSize:12,display:'flex',alignItems:'center',justifyContent:'center',opacity:deleting===p.id?.5:1}}>🗑</button>
          </div>
        </div>)}
      </div>

      {/* Footer */}
      <div style={{padding:'12px 16px',borderTop:'1px solid var(--bd)',display:'flex',gap:8,flexShrink:0}}>
        <button onClick={onClose} className="ba" style={{flex:1,padding:'10px',borderRadius:10,border:'1px solid var(--bd)',background:'var(--crd)',color:'var(--t2)',fontSize:12,fontWeight:600,cursor:'pointer',fontFamily:'inherit'}}>Fermer</button>
      </div>
    </div>
  </div>;
}

function AddPC({type,onClose,onAdd}){
  const[n,sN]=useState('');const[l,sL]=useState(2000);const[w,sW]=useState(600);const[h,sH]=useState(1200);const[t,sT]=useState('Fenetre');
  const go=()=>{if(!n.trim())return;if(type==='pan')onAdd({n:n.trim(),l,w,c:1});else onAdd({n:n.trim(),t,w,h});onClose()};
  return<><h3 className="font-bold text-base mb-4">Nouveau {type==='pan'?'panneau':'ouverture'}</h3>
    <div className="space-y-3"><TI label="Nom" value={n} onChange={sN}/>
      {type==='ouv'&&<div className="space-y-1"><label className="text-[11px] font-medium" style={{color:'var(--t3)'}}>Type</label>
        <select value={t} onChange={e=>sT(e.target.value)} className="idark w-full rounded-lg text-sm py-2 px-3">
          {['Fenetre','Porte','Porte-fenetre','Chassis fixe','Grille'].map(x=><option key={x}>{x}</option>)}</select></div>}
      <div className="grid grid-cols-2 gap-3">{type==='pan'?<><NI label="Longueur" value={l} onChange={sL} unit="mm"/><NI label="Largeur" value={w} onChange={sW} unit="mm"/></>
        :<><NI label="Largeur" value={w} onChange={sW} unit="mm"/><NI label="Hauteur" value={h} onChange={sH} unit="mm"/></>}</div></div>
    <div className="flex gap-2 mt-5"><button onClick={onClose} className="ba flex-1 py-2 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
      <button onClick={go} className="ba flex-1 py-2 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)'}}>Ajouter</button></div></>;
}

if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
// Detect viewer mode from URL
const _viewParam=new URLSearchParams(window.location.search).get('view');
ReactDOM.createRoot(document.getElementById('root')).render(
  _viewParam?<ViewerApp viewId={_viewParam}/>:
  <AuthGate>{({user,profile,signOut,subStatus})=><App user={user} profile={profile} signOut={signOut} subStatus={subStatus}/>}</AuthGate>
);
</script>
<script>
try{
  var _src=document.getElementById('app-source').textContent;
  var _out=Babel.transform(_src,{presets:['react']}).code;
  var _s=document.createElement('script');
  _s.textContent=_out;
  document.body.appendChild(_s);
}catch(e){
  document.body.innerHTML='<div style="color:#ff6b6b;padding:20px;font-family:monospace;white-space:pre-wrap;background:#1a1a2e;min-height:100vh"><h2 style=color:#ff4444>ERREUR BABEL</h2><pre>'+e.message+'</pre></div>';
}
</script>
<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}
</script>
</body>
</html>
