<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalepin v17 — Bardage & Encadrements</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script>
    window.onerror=function(msg,url,line,col,err){
      document.body.innerHTML='<div style="color:red;padding:20px;font-family:monospace;white-space:pre-wrap"><h2>ERREUR JS</h2>'+msg+'\nLine: '+line+' Col: '+col+'\n'+(err&&err.stack||'')+'</div>';
    };
    window._jspdfReady=new Promise((resolve)=>{
      const urls=['https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js','https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js','https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js'];
      let i=0;function tryLoad(){if(i>=urls.length){resolve(false);return}const s=document.createElement('script');s.src=urls[i];s.onload=()=>resolve(true);s.onerror=()=>{i++;tryLoad()};document.head.appendChild(s)}tryLoad()});
  </script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f5f2ee;--pnl:#ffffff;--crd:#f9f6f3;--crd2:#f0ece6;--inp:#ffffff;--bd:#ddd5cc;--bd2:#c4b8ab;--bdf:#8b1a2b;--t1:#2a1a1e;--t2:#6b5860;--t3:#9a8890;--bl:#8b1a2b;--blg:rgba(139,26,43,.10);--gn:#0d9488;--gnd:rgba(13,148,136,.08);--am:#b45309;--amd:rgba(180,83,9,.08);--rs:#be123c;--rsd:rgba(190,18,60,.08);--pp:#8b1a2b;--ppd:rgba(139,26,43,.06);--cy:#0891b2;--cyd:rgba(8,145,178,.08)}
    *{font-family:'DM Sans',system-ui,sans-serif;box-sizing:border-box;margin:0}
    html,body,#root{height:100%;overflow:hidden;background:var(--bg);color:var(--t1)}
    .mn{font-family:'JetBrains Mono',monospace}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:10px}
    input[type=number]{-moz-appearance:textfield}input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
    .idark{background:var(--inp);border:1.5px solid var(--bd);color:var(--t1);transition:.2s}.idark:focus{border-color:var(--bdf);box-shadow:0 0 0 3px rgba(139,26,43,.1);outline:none}
    .cd{background:var(--crd);border:1px solid var(--bd);transition:.2s;border-radius:12px}.cd:hover{border-color:var(--bd2)}
    .ba{transition:.15s;cursor:pointer;user-select:none}.ba:active{transform:scale(.97)}
    .rv{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.92rem;letter-spacing:-.02em}
    @keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pg{0%,100%{box-shadow:0 0 8px var(--blg)}50%{box-shadow:0 0 20px var(--blg)}}
    .afu{animation:fu .25s ease-out}.apg{animation:pg 2s ease-in-out infinite}
    .pb{background:var(--inp);border:1px solid var(--bd);color:var(--t2);cursor:pointer;transition:.15s;font-size:10px;padding:5px 7px;border-radius:7px;text-align:left}
    .pb:hover{border-color:var(--bl);color:var(--t1);background:rgba(139,26,43,.05)}.pb.on{border-color:var(--bl);color:var(--bl);background:rgba(139,26,43,.08)}
    .tb{padding:6px 8px;font-size:10px;font-weight:500;color:var(--t3);cursor:pointer;transition:.2s;border-bottom:2px solid transparent;white-space:nowrap}
    .tb:hover{color:var(--t2)}.tb.on{color:var(--bl);border-bottom-color:var(--bl)}
    .ov{position:fixed;inset:0;background:rgba(42,26,30,.3);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
    .mbx{background:var(--pnl);border:1px solid var(--bd);border-radius:16px;padding:24px;min-width:380px;max-width:520px;box-shadow:0 25px 60px rgba(42,26,30,.12);max-height:90vh;overflow-y:auto}
    .rng{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--bd);border-radius:4px;outline:none}
    .rng::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--bl);border-radius:50%;cursor:pointer;border:2px solid var(--pnl)}
    .cvbg{background-color:#eee9e3;background-image:radial-gradient(#d8d0c6 1px,transparent 1px);background-size:24px 24px}
    .drop{border:2px dashed var(--bd);border-radius:16px;transition:.3s;cursor:pointer}.drop:hover{border-color:var(--bl);background:rgba(139,26,43,.04)}
    .ztab{display:flex;align-items:center;gap:5px;padding:5px 11px;font-size:10px;font-weight:600;border-radius:6px 6px 0 0;cursor:pointer;transition:.15s;border:1px solid transparent;border-bottom:none;position:relative;white-space:nowrap;max-width:160px}
    .ztab:hover{background:var(--crd2)}.ztab.on{background:var(--pnl);border-color:var(--bd);margin-bottom:-1px;z-index:2;padding-bottom:6px}
    .ztab .ztab-close{opacity:0;width:14px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;transition:.1s}
    .ztab:hover .ztab-close,.ztab.on .ztab-close{opacity:.5}.ztab .ztab-close:hover{opacity:1!important;background:var(--rsd);color:var(--rs)}
    .ztab-bar{display:flex;align-items:flex-end;gap:2px;overflow-x:auto;scrollbar-width:none;padding:0 4px;flex:1;min-width:0}
    .ztab-bar::-webkit-scrollbar{display:none}
    .ztab-add{display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;font-size:14px;cursor:pointer;flex-shrink:0;opacity:.6;transition:.15s}
    .ztab-add:hover{opacity:1;background:var(--blg);color:var(--bl)}
    .dtbl{width:100%;border-collapse:collapse;font-size:10px}.dtbl th{text-align:left;font-weight:600;padding:4px 6px;border-bottom:1px solid var(--bd);color:var(--t3);font-size:9px;text-transform:uppercase}.dtbl td{padding:4px 6px;border-bottom:1px solid rgba(39,45,66,.4)}
    .imp-tag{display:inline-flex;align-items:center;gap:3px;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:600}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes glow{0%,100%{opacity:.4}50%{opacity:1}}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @keyframes orbit{from{transform:rotate(0deg) translateX(42px) rotate(0deg)}to{transform:rotate(360deg) translateX(42px) rotate(-360deg)}}
    @keyframes pulse-ring{0%{transform:scale(.8);opacity:1}100%{transform:scale(2.5);opacity:0}}
    .wc-logo{animation:float 3s ease-in-out infinite}
    .wc-d0{animation:slideUp .6s ease-out both}.wc-d1{animation:slideUp .6s ease-out both;animation-delay:.15s}
    .wc-d2{animation:slideUp .6s ease-out both;animation-delay:.3s}.wc-d3{animation:slideUp .6s ease-out both;animation-delay:.45s}
    .wc-d4{animation:slideUp .6s ease-out both;animation-delay:.6s}
    .wc-glow{animation:glow 2.5s ease-in-out infinite}
    .wc-shine{background:linear-gradient(90deg,transparent,rgba(79,110,247,.15),transparent);background-size:200% 100%;animation:shimmer 3s linear infinite}
    .opt-card{border:1px solid var(--bd);border-radius:10px;padding:10px;cursor:pointer;transition:.15s}
    .opt-card:hover{border-color:var(--bl)}.opt-card.best{border-color:var(--gn);background:var(--gnd)}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const{useState,useMemo,useRef,useCallback,useEffect}=React;

/* ─── ICONS ─── */
const I={
  ruler:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0z"/><path d="m14.5 12.5 2-2m-5-1 2-2m-5-1 2-2m8 5 2-2"/></svg>,
  grid:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
  frame:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="6" x2="2" y2="6"/><line x1="22" y1="18" x2="2" y2="18"/><line x1="6" y1="2" x2="6" y2="22"/><line x1="18" y1="2" x2="18" y2="22"/></svg>,
  bolt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 3v4m0 10v4M3 12h4m10 0h4"/></svg>,
  win:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="4" x2="12" y2="20"/></svg>,
  dl:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  plus:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  trash:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  copy:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
  zi:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
  zo:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
  tgt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
  chv:s=><svg width={s||12} height={s||12} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round"><polyline points="6 9 12 15 18 9"/></svg>,
  cross:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>,
  up:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
  prn:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  x:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  move:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>,
  opt:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 20V10m6 10V4M6 20v-4"/></svg>,
  pen:s=><svg width={s||16} height={s||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
};

/* ─── PRESETS ─── */
const DP=[{n:'Alucobond 4mm',l:3200,w:1250},{n:'Trespa 8mm',l:3050,w:1530},{n:'Equitone 8mm',l:2530,w:1220},{n:'Rockpanel 8mm',l:2500,w:1200},{n:'Cedral 8mm',l:3600,w:190},{n:'Zinc VM 0.7',l:2000,w:500},{n:'Cassette alu 3mm',l:1500,w:600},{n:'Fibrociment 6mm',l:2500,w:1220}];
const DO=[{n:'Fen. 1V',t:'Fenetre',w:900,h:1150},{n:'Fen. 2V',t:'Fenetre',w:1200,h:1350},{n:'Porte std',t:'Porte',w:900,h:2150},{n:'Porte-fen.',t:'Porte-fenetre',w:1800,h:2150},{n:'Chassis fixe',t:'Chassis fixe',w:600,h:600},{n:'Grille vent.',t:'Grille',w:400,h:300}];

/* ── DXF PARSER (LINE, LWPOLYLINE, POLYLINE, CIRCLE, ARC) ── */
function parseDXF(text){
  const lines=[];const pairs=[];const raw=text.split(/\r?\n/);
  for(let i=0;i<raw.length-1;i+=2)pairs.push({code:parseInt(raw[i].trim()),val:raw[i+1].trim()});
  let inEntities=false,etype='',x1=0,y1=0,x2=0,y2=0;
  const pts=[];let collecting=false;
  for(let i=0;i<pairs.length;i++){
    const{code,val}=pairs[i];
    if(code===2&&val==='ENTITIES')inEntities=true;
    if(code===0&&val==='ENDSEC')inEntities=false;
    if(!inEntities)continue;
    if(code===0){
      // Flush previous entity
      if(etype==='LINE')lines.push({x1,y1,x2,y2});
      if((etype==='LWPOLYLINE'||etype==='POLYLINE')&&pts.length>1){
        for(let j=0;j<pts.length-1;j++)lines.push({x1:pts[j].x,y1:pts[j].y,x2:pts[j+1].x,y2:pts[j+1].y});
        if(collecting&&pts.length>2)lines.push({x1:pts[pts.length-1].x,y1:pts[pts.length-1].y,x2:pts[0].x,y2:pts[0].y});
      }
      etype=val;x1=y1=x2=y2=0;pts.length=0;collecting=false;
      if(val==='LWPOLYLINE'||val==='POLYLINE')collecting=true;
    }
    if(etype==='LINE'){if(code===10)x1=parseFloat(val);if(code===20)y1=parseFloat(val);if(code===11)x2=parseFloat(val);if(code===21)y2=parseFloat(val)}
    if(collecting){
      if(code===10)pts.push({x:parseFloat(val),y:0});
      if(code===20&&pts.length>0)pts[pts.length-1].y=parseFloat(val);
      if(code===70&&parseInt(val)&1)collecting=true;// closed flag
    }
    if(etype==='CIRCLE'){
      if(code===10)x1=parseFloat(val);if(code===20)y1=parseFloat(val);
      if(code===40){const r=parseFloat(val);for(let a=0;a<360;a+=15){
        const a1=a*Math.PI/180,a2=(a+15)*Math.PI/180;
        lines.push({x1:x1+r*Math.cos(a1),y1:y1+r*Math.sin(a1),x2:x1+r*Math.cos(a2),y2:y1+r*Math.sin(a2)});}}
    }
  }
  if(lines.length===0)throw new Error('Aucune entité trouvée');
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  lines.forEach(l=>{minX=Math.min(minX,l.x1,l.x2);minY=Math.min(minY,l.y1,l.y2);maxX=Math.max(maxX,l.x1,l.x2);maxY=Math.max(maxY,l.y1,l.y2)});
  return{lines,bounds:{minX,minY,maxX,maxY},units:'mm'};
}
const ZONE_COLORS=['#4f6ef7','#34d399','#fbbf24','#fb7185','#a78bfa','#22d3ee','#f97316','#ec4899'];

/* ─── POLYGON UTILITIES ─── */
function ptInPoly(px,py,poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i].x,yi=poly[i].y,xj=poly[j].x,yj=poly[j].y;
    if((yi>py)!==(yj>py)&&px<(xj-xi)*(py-yi)/(yj-yi)+xi)inside=!inside;
  }
  return inside;
}
function polyArea(poly){
  let a=0;for(let i=0,j=poly.length-1;i<poly.length;j=i++){a+=(poly[j].x+poly[i].x)*(poly[j].y-poly[i].y)}
  return Math.abs(a/2);
}
function polyBounds(poly){
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  poly.forEach(p=>{x1=Math.min(x1,p.x);y1=Math.min(y1,p.y);x2=Math.max(x2,p.x);y2=Math.max(y2,p.y)});
  return{x:x1,y:y1,w:x2-x1,h:y2-y1};
}
function rectPolyOverlap(rx,ry,rw,rh,poly){
  const corners=[{x:rx,y:ry},{x:rx+rw,y:ry},{x:rx+rw,y:ry+rh},{x:rx,y:ry+rh}];
  const ins=corners.map(c=>ptInPoly(c.x,c.y,poly));
  const cnt=ins.filter(Boolean).length;
  if(cnt===4)return'inside';
  if(cnt===0){
    // check if any poly edge crosses rect
    for(let i=0,j=poly.length-1;i<poly.length;j=i++){
      if(segRectIntersect(poly[j],poly[i],rx,ry,rw,rh))return'partial';
    }
    // check if poly is inside rect
    if(poly.length>0&&rx<=poly[0].x&&poly[0].x<=rx+rw&&ry<=poly[0].y&&poly[0].y<=ry+rh)return'partial';
    return'outside';
  }
  return'partial';
}
function segRectIntersect(a,b,rx,ry,rw,rh){
  const edges=[[{x:rx,y:ry},{x:rx+rw,y:ry}],[{x:rx+rw,y:ry},{x:rx+rw,y:ry+rh}],[{x:rx+rw,y:ry+rh},{x:rx,y:ry+rh}],[{x:rx,y:ry+rh},{x:rx,y:ry}]];
  return edges.some(([c,d])=>segSeg(a,b,c,d));
}
function segSeg(a,b,c,d){
  const det=(b.x-a.x)*(d.y-c.y)-(b.y-a.y)*(d.x-c.x);if(Math.abs(det)<1e-10)return false;
  const t=((c.x-a.x)*(d.y-c.y)-(c.y-a.y)*(d.x-c.x))/det;
  const u=((c.x-a.x)*(b.y-a.y)-(c.y-a.y)*(b.x-a.x))/det;
  return t>=0&&t<=1&&u>=0&&u<=1;
}
function polyToPath(poly,sc,ox,oy){
  return poly.map((p,i)=>`${i===0?'M':'L'}${ox+p.x*sc} ${oy+p.y*sc}`).join(' ')+'Z';
}

/* ─── BASE COMPONENTS ─── */
function NI({value,onChange,unit,step=100,min=0,label,compact,ph=''}){
  const[v,sV]=useState(value),[f,sF]=useState(false);const r=useRef();
  useEffect(()=>{if(!f)sV(value)},[value,f]);
  const cm=()=>{sF(false);const n=Number(v);if(!isNaN(n)&&n>=min)onChange(n);else sV(value)};
  return(<div className={compact?'':'space-y-1'}>
    {label&&<label className="text-[11px] font-medium block" style={{color:'var(--t3)'}}>{label}</label>}
    <div className="relative"><input ref={r} type="number" value={v} onChange={e=>sV(e.target.value)}
      onKeyDown={e=>{if(e.key==='Enter')r.current?.blur();e.stopPropagation()}} onBlur={cm} onClick={e=>e.stopPropagation()}
      onFocus={()=>{sF(true);setTimeout(()=>r.current?.select(),0)}} step={step} min={min} placeholder={ph}
      className={`idark w-full rounded-lg text-sm font-medium ${compact?'pl-2 pr-8 py-1.5 text-xs':'pl-3 pr-10 py-2'}`}/>
      {unit&&<span className={`absolute right-2 top-1/2 -translate-y-1/2 font-medium mn ${compact?'text-[10px]':'text-xs'}`} style={{color:'var(--t3)'}}>{unit}</span>}
    </div></div>);
}
function TI({value,onChange,label,ph=''}){
  return(<div className="space-y-1">{label&&<label className="text-[11px] font-medium block" style={{color:'var(--t3)'}}>{label}</label>}
    <input type="text" value={value} onChange={e=>onChange(e.target.value)} placeholder={ph}
      onKeyDown={e=>e.stopPropagation()} onClick={e=>e.stopPropagation()} className="idark w-full rounded-lg text-sm font-medium pl-3 pr-3 py-2"/></div>);
}
function Sec({icon,title,badge,children,dO=true,color='var(--bl)',act}){
  const[o,sO]=useState(dO);
  return(<div className="cd overflow-hidden">
    <div className="flex items-center gap-2.5 px-3.5 py-2.5 cursor-pointer select-none" onClick={()=>sO(!o)}>
      <span className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:`color-mix(in srgb,${color} 15%,transparent)`,color}}>{icon}</span>
      <span className="text-[13px] font-semibold flex-1">{title}</span>
      {badge!=null&&<span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[11px] font-medium mn" style={{background:`color-mix(in srgb,${color} 12%,transparent)`,color}}>{badge}</span>}
      {act&&<span onClick={e=>{e.stopPropagation();act.fn()}} className="w-6 h-6 rounded-md flex items-center justify-center hover:bg-[var(--crd2)]" style={{color:'var(--t3)'}}>{act.ic}</span>}
      <span style={{color:'var(--t3)',transform:o?'rotate(0)':'rotate(-90deg)',transition:'.2s'}}>{I.chv()}</span>
    </div>{o&&<div className="px-3.5 pb-3.5 pt-0.5 afu">{children}</div>}</div>);
}
function RR({label,value,unit='',color,sub,bold}){
  return(<div className={`flex justify-between items-baseline ${sub?'pl-3 opacity-70':''} ${bold?'pt-1.5 mt-1.5 border-t border-[var(--bd)]':''}`}>
    <span className={`${sub?'text-[11px]':'text-xs'} ${bold?'font-semibold':''}`} style={{color:'var(--t2)'}}>{label}</span>
    <span className={`rv ${sub?'!text-xs':''}`} style={{color:color||'var(--t1)'}}>{value}<span className="text-[10px] ml-1 font-normal" style={{color:'var(--t3)'}}>{unit}</span></span>
  </div>);
}

/* ═══ CALCULATION ENGINE ═══ */
function calcZone(z){
  if(!z||!z.L||!z.H)return null;
  const L=z.L/1000,H=z.H/1000;
  const pL=Math.max(.1,z.pan_.l/1000),pW=Math.max(.1,z.pan_.w/1000);
  const eM=Math.max(.1,z.oss.eM/1000),eL=Math.max(.1,z.oss.eL/1000);
  const pw0=z.vert?pW:pL,ph0=z.vert?pL:pW;
  const defJH=(z.jointH||0)/1000,defJV=(z.jointV||0)/1000;
  const jointsH=z.jointsH||[];const jointsV=z.jointsV||[];
  const offX=(z.offX||0)/1000,offY=(z.offY||0)/1000;
  const colWidths=z.colWidths||[];const rowHeights=z.rowHeights||[];
  const poly=z.poly;const polyM=poly?poly.map(p=>({x:p.x/1000,y:p.y/1000})):null;
  const sBr=polyM?polyArea(polyM):L*H;
  const sOuv=z.ouvs.reduce((s,o)=>s+(o.w/1000)*(o.h/1000),0);
  const sNet=Math.max(0,sBr-sOuv);

  // ── STEP 1: Build base grid columns ──
  const baseXBounds=[0];let cx2=0;
  const offXm=offX>0?offX:0;
  if(offXm>0){baseXBounds.push(offXm);cx2=offXm+(jointsH[0]!=null?jointsH[0]/1000:defJH);}
  let ci2=baseXBounds.length>1?1:0;
  while(cx2<L-0.001&&ci2<300){
    const cw=(colWidths[ci2]&&colWidths[ci2]>0)?colWidths[ci2]/1000:pw0;
    const w2=Math.min(cw,L-cx2);if(w2<0.001)break;
    cx2+=w2;baseXBounds.push(Math.min(cx2,L));
    cx2+=(jointsH[ci2]!=null?jointsH[ci2]/1000:defJH);ci2++;
  }
  if(baseXBounds[baseXBounds.length-1]<L-0.001)baseXBounds.push(L);

  // ── STEP 1b: Build base grid rows ──
  const baseYBounds=[0];let ry2=0;
  const offYm=offY>0?offY:0;
  if(offYm>0){baseYBounds.push(offYm);ry2=offYm+(jointsV[0]!=null?jointsV[0]/1000:defJV);}
  let ri2=baseYBounds.length>1?1:0;
  while(ry2<H-0.001&&ri2<300){
    const rh=(rowHeights[ri2]&&rowHeights[ri2]>0)?rowHeights[ri2]/1000:ph0;
    const h2=Math.min(rh,H-ry2);if(h2<0.001)break;
    ry2+=h2;baseYBounds.push(Math.min(ry2,H));
    ry2+=(jointsV[ri2]!=null?jointsV[ri2]/1000:defJV);ri2++;
  }
  if(baseYBounds[baseYBounds.length-1]<H-0.001)baseYBounds.push(H);

  const baseNc=baseXBounds.length-1,baseNr=baseYBounds.length-1;
  const jGapsH=Array.from({length:Math.max(0,baseNc-1)},(_,i)=>(jointsH[i]!=null?jointsH[i]:z.jointH||0));
  const jGapsV=Array.from({length:Math.max(0,baseNr-1)},(_,i)=>(jointsV[i]!=null?jointsV[i]:z.jointV||0));

  // ── STEP 1c: Process merges — build merged cell map ──
  const merges=z.merges||[];
  const mergedAbsorbed=new Set();// "bc,br" keys of cells absorbed by a merge
  const mergedOrigins={};// "bc,br" → {c2, r2} for origin cells
  merges.forEach(mg=>{
    if(mg.c1>=baseNc||mg.r1>=baseNr||mg.c2>=baseNc||mg.r2>=baseNr)return;
    if(mg.c1>mg.c2||mg.r1>mg.r2)return;
    mergedOrigins[`${mg.c1},${mg.r1}`]={c2:mg.c2,r2:mg.r2};
    for(let c=mg.c1;c<=mg.c2;c++)for(let r=mg.r1;r<=mg.r2;r++){
      if(c===mg.c1&&r===mg.r1)continue;// origin not absorbed
      mergedAbsorbed.add(`${c},${r}`);
    }
  });

  // ── STEP 2: For each base cell, check if it intersects openings → subdivide LOCALLY ──
  const panelMap=[];let subIdx=0;
  const ouvRects=z.ouvs.map(o=>({l:o.x/1000,t:o.y/1000,r:(o.x+o.w)/1000,b:(o.y+o.h)/1000}));

  for(let bc=0;bc<baseNc;bc++){
    for(let br=0;br<baseNr;br++){
      const cellKey=`${bc},${br}`;
      // Skip cells absorbed by a merge
      if(mergedAbsorbed.has(cellKey))continue;
      // Compute effective bounds (expanded if this is a merge origin)
      let bx1=baseXBounds[bc],bx2=baseXBounds[bc+1];
      let by1=baseYBounds[br],by2=baseYBounds[br+1];
      const mg=mergedOrigins[cellKey];
      const isMerged=!!mg;
      if(mg){bx2=baseXBounds[mg.c2+1];by2=baseYBounds[mg.r2+1]}
      const bw=bx2-bx1,bh=by2-by1;
      if(bw<0.001||bh<0.001)continue;
      if(polyM&&rectPolyOverlap(bx1,by1,bw,bh,polyM)==='outside')continue;
      const polyEdge=polyM?rectPolyOverlap(bx1,by1,bw,bh,polyM)==='partial':false;

      // Collect opening edges that fall INSIDE this base cell
      const localXCuts=new Set(),localYCuts=new Set();
      let hasIntersection=false;
      ouvRects.forEach(or=>{
        if(or.l>=bx2-0.001||or.r<=bx1+0.001||or.t>=by2-0.001||or.b<=by1+0.001)return;
        hasIntersection=true;
        if(or.l>bx1+0.001&&or.l<bx2-0.001)localXCuts.add(or.l);
        if(or.r>bx1+0.001&&or.r<bx2-0.001)localXCuts.add(or.r);
        if(or.t>by1+0.001&&or.t<by2-0.001)localYCuts.add(or.t);
        if(or.b>by1+0.001&&or.b<by2-0.001)localYCuts.add(or.b);
      });

      if(!hasIntersection){
        // No opening touches this cell → single panel
        const excl=(z.exclusions||[]).find(e=>e.col===bc&&e.row===br);
        panelMap.push({col:subIdx,row:0,parentCol:bc,parentRow:br,pLeft:bx1,pTop:by1,pWa:bw,pHa:bh,
          isVoid:false,voidOuvIdx:-1,isImpacted:false,adjSides:[],polyEdge,
          ref:`${bc+1}.${br+1}`,subRef:`${bc+1}.${br+1}`,isBase:true,
          isMerged,mergeSpan:mg?{c1:bc,r1:br,c2:mg.c2,r2:mg.r2}:null,
          isExcluded:!!excl,exclusionDepth:excl?excl.depth:0});
        subIdx++;
      }else{
        // Subdivide this cell using local opening edges
        const xCuts=[bx1,...[...localXCuts].sort((a,b)=>a-b),bx2];
        const yCuts=[by1,...[...localYCuts].sort((a,b)=>a-b),by2];
        let subCount=0;
        for(let sx=0;sx<xCuts.length-1;sx++){
          for(let sy=0;sy<yCuts.length-1;sy++){
            const sx1=xCuts[sx],sx2=xCuts[sx+1],sy1=yCuts[sy],sy2=yCuts[sy+1];
            const sw=sx2-sx1,sh=sy2-sy1;
            if(sw<0.001||sh<0.001)continue;
            // Check if this sub-cell center is inside any opening
            const scx=sx1+sw/2,scy=sy1+sh/2;
            let isVoid=false,voidIdx=-1;
            ouvRects.forEach((or,oi)=>{
              if(scx>or.l+0.001&&scx<or.r-0.001&&scy>or.t+0.001&&scy<or.b-0.001){isVoid=true;voidIdx=oi}
            });
            subCount++;
            const excl=(z.exclusions||[]).find(e=>e.col===bc&&e.row===br);
            panelMap.push({col:subIdx,row:0,parentCol:bc,parentRow:br,pLeft:sx1,pTop:sy1,pWa:sw,pHa:sh,
              isVoid,voidOuvIdx:voidIdx,isImpacted:false,adjSides:[],polyEdge,
              ref:`${bc+1}.${br+1}`,subRef:`${bc+1}.${br+1}.${subCount}`,isBase:false,
              isMerged,mergeSpan:mg?{c1:bc,r1:br,c2:mg.c2,r2:mg.r2}:null,
              isExcluded:!!excl,exclusionDepth:excl?excl.depth:0});
            subIdx++;
          }
        }
      }
    }
  }

  // ── STEP 3: Mark impacted panels (neighbor voids) ──
  const exclusions=z.exclusions||[];
  const isExcluded=(col,row)=>exclusions.some(e=>e.col===col&&e.row===row);
  const activePanels=panelMap.filter(p=>!p.isVoid&&!isExcluded(p.parentCol,p.parentRow));
  const eps=0.003;
  activePanels.forEach(pm=>{
    const pr=pm.pLeft+pm.pWa,pb=pm.pTop+pm.pHa;
    const sides=[];
    panelMap.forEach(other=>{
      if(!other.isVoid||other.voidOuvIdx<0)return;
      const or2=other.pLeft+other.pWa,ob2=other.pTop+other.pHa;
      const o=z.ouvs[other.voidOuvIdx];if(!o)return;
      const r=o.retours||{tG:150,tD:150,lin:150,app:150};const fv=o.faceVis||50;
      // Check adjacency: shared edge
      const overlapY=Math.min(pb,ob2)-Math.max(pm.pTop,other.pTop);
      const overlapX=Math.min(pr,or2)-Math.max(pm.pLeft,other.pLeft);
      if(Math.abs(pr-other.pLeft)<eps&&overlapY>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'tG',retour:r.tG,faceVis:fv,foldL:Math.round(overlapY*1000),devRetour:r.tG+fv+10});
      if(Math.abs(pm.pLeft-or2)<eps&&overlapY>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'tD',retour:r.tD,faceVis:fv,foldL:Math.round(overlapY*1000),devRetour:r.tD+fv+10});
      if(Math.abs(pb-other.pTop)<eps&&overlapX>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'lin',retour:r.lin,faceVis:fv,foldL:Math.round(overlapX*1000),devRetour:r.lin+fv+10});
      if(Math.abs(pm.pTop-ob2)<eps&&overlapX>eps)
        sides.push({ouvIdx:other.voidOuvIdx,side:'app',retour:r.app,faceVis:fv,foldL:Math.round(overlapX*1000),devRetour:r.app+fv+10});
    });
    // Deduplicate by side+ouvIdx
    const uniq=[];const seen=new Set();
    sides.forEach(s=>{const k=s.side+'-'+s.ouvIdx;if(!seen.has(k)){seen.add(k);uniq.push(s)}});
    if(uniq.length>0){pm.isImpacted=true;pm.adjSides=uniq}
  });

  // Mark ALL sub-panels with non-standard dimensions as impacted
  // Build set of expected base cell dimensions (from colWidths/rowHeights or default)
  const expectedW=new Set(),expectedH=new Set();
  expectedW.add(Math.round(pw0*10000));
  expectedH.add(Math.round(ph0*10000));
  // Also accept configured custom widths/heights
  (z.colWidths||[]).forEach(cw=>{if(cw>0)expectedW.add(Math.round(cw*10))});
  (z.rowHeights||[]).forEach(rh=>{if(rh>0)expectedH.add(Math.round(rh*10))});
  // Accept offset panels too
  if(offX>0)expectedW.add(Math.round(offX*10000));
  if(offY>0)expectedH.add(Math.round(offY*10000));
  activePanels.forEach(pm=>{
    if(pm.isImpacted)return;// Already marked from void adjacency
    const pw2=Math.round(pm.pWa*10000),ph2=Math.round(pm.pHa*10000);
    const wOk=expectedW.has(pw2);const hOk=expectedH.has(ph2);
    if(!wOk||!hOk){
      pm.isImpacted=true;// Non-standard dimension → cut panel
    }
  });
  const nP=activePanels.length;
  const pImp=activePanels.filter(p=>p.isImpacted).length;
  const totalPanArea=activePanels.reduce((a,pm)=>a+pm.pWa*pm.pHa,0);
  const chut=totalPanArea>0?Math.max(0,(totalPanArea-sNet)/totalPanArea*100):0;
  const impacts=[];
  const edgePanels=panelMap.filter(pm=>pm.polyEdge&&!pm.isVoid).map(pm=>({
    col:pm.col,row:0,ref:pm.subRef,panW:Math.round(pm.pWa*1000),panH:Math.round(pm.pHa*1000),edge:true}));

  // ── STEP 4: Cassettes (from adjSides) ──
  const menuDet=z.ouvs.map((o,i)=>{
    const lm=o.w/1000,hm=o.h/1000;
    const r=o.retours||{tG:150,tD:150,lin:150,app:150};
    const fv=o.faceVis||50;const pli=10;
    const cassettes=[];
    activePanels.forEach(pm=>{
      if(!pm.isImpacted)return;
      pm.adjSides.forEach(s=>{
        if(s.ouvIdx!==i)return;
        cassettes.push({nom:`${s.side==='tG'?'Tab.G':s.side==='tD'?'Tab.D':s.side==='lin'?'Linteau':'Appui'} P${pm.subRef}`,
          type:'pliee',L:s.foldL,dev:s.devRetour,side:s.side,panRef:pm.subRef});
      });
    });
    const surfCass=cassettes.reduce((a,cc)=>a+(cc.L*cc.dev)/1e6,0);
    const mlCass=cassettes.reduce((a,cc)=>a+cc.L/1000,0);
    return{...o,idx:i,lm,hm,retours:r,faceVis:fv,
      tableauG:hm,tableauD:hm,linteau:lm,appui:lm,encTotal:2*hm+2*lm,
      cassettes,surfCass,mlCass,impPanels:activePanels.filter(p=>p.isImpacted&&p.adjSides.some(s=>s.ouvIdx===i)).map(p=>p.subRef)};
  });
  const totEnc=menuDet.reduce((a,m)=>({tab:a.tab+m.tableauG+m.tableauD,lin:a.lin+m.linteau,app:a.app+m.appui,tot:a.tot+m.encTotal}),{tab:0,lin:0,app:0,tot:0});
  const totCassettes={pliees:menuDet.reduce((a,m)=>a+m.cassettes.length,0),surfTot:menuDet.reduce((a,m)=>a+m.surfCass,0),
    mlTot:menuDet.reduce((a,m)=>a+m.mlCass,0),detail:menuDet.flatMap(m=>m.cassettes.map(cc=>({...cc,ouvName:`${m.t} ${m.idx+1}`,ouvId:m.id})))};

  // ── STEP 5: Ossature ──
  const nM=Math.floor(L/eM)+1,nL2=Math.floor(H/eL)+1;
  const lMBr=nM*H,lLBr=nL2*L;let dM=0,dL=0;
  z.ouvs.forEach(o=>{const ox1=o.x/1000,ox2=(o.x+o.w)/1000;
    for(let i=0;i<=nM;i++){const mx=i*eM;if(mx>ox1&&mx<ox2)dM+=o.h/1000}
    for(let i=0;i<=nL2;i++){const ly=i*eL;if(ly>o.y/1000&&ly<(o.y+o.h)/1000)dL+=o.w/1000}});
  const lMN=lMBr-dM+totEnc.tab,lLN=lLBr-dL+totEnc.lin+totEnc.app,tOss=lMN+lLN;
  const jV=Math.max(0,baseNc-1)*H,jH=Math.max(0,baseNr-1)*L,tJ=jV+jH;
  const jGapH=defJH,jGapV=defJV;
  const jGapArea=jGapsH.reduce((a,g)=>a+g/1000*H,0)+jGapsV.reduce((a,g)=>a+g/1000*L,0);
  const tFix=nP*z.fix.pp,tEq=nM*z.fix.em;
  // Compat: cols/rows for rendering
  const cols=panelMap.map(pm=>({x:pm.pLeft,w:pm.pWa}));
  const rows=panelMap.map(pm=>({y:pm.pTop,h:pm.pHa}));

  return{sBr,sOuv,sNet,nC:baseNc,nR:baseNr,nP,pImp,chut,pw:pw0,ph:ph0,nM,nL:nL2,lMBr,lLBr,dM,dL,lMN,lLN,tOss,jV,jH,tJ,jGapH,jGapV,jGapArea,jGapsH,jGapsV,tFix,tEq,
    impacts,menuDet,totEnc,totCassettes,panelMap,activePanels,edgePanels,offX,offY,cols,rows,
    baseXBounds,baseYBounds,baseNc,baseNr};
}

/* ═══ OPTIMIZATION ENGINE ═══ */
function optimizeLayout(z){
  const results=[];
  const pL=z.pan_.l,pW=z.pan_.w;
  const stepOff=50;// mm
  [true,false].forEach(vert=>{
    const pw=vert?pW:pL,ph=vert?pL:pW;
    for(let ox=0;ox<pw;ox+=stepOff){
      for(let oy=0;oy<ph;oy+=stepOff){
        const test={...z,vert,offX:ox,offY:oy};
        const r=calcZone(test);
        if(!r)continue;
        results.push({vert,offX:ox,offY:oy,nP:r.nP,pImp:r.pImp,chut:r.chut,sNet:r.sNet,nCuts:r.impacts.length+r.edgePanels.length,label:`${vert?'V':'H'} dec.${ox}x${oy}`});
      }
    }
  });
  results.sort((a,b)=>a.chut-b.chut);
  // Keep unique top results
  const seen=new Set();const uniq=[];
  for(const r of results){
    const k=`${r.nP}-${r.chut.toFixed(1)}`;
    if(!seen.has(k)){seen.add(k);uniq.push(r);if(uniq.length>=6)break}
  }
  return uniq;
}

/* ═══ 3D FACADE VIEWER ═══ */
function Facade3D({zone,calc,ralColor,ralFinish,showWall,onToggle,onClose}){
  const mountRef=useRef();const sceneRef=useRef();const frameRef=useRef();
  const rotRef=useRef({x:-.3,y:.4});const dragRef=useRef(null);const zoomRef=useRef(3);
  const panRef=useRef({x:0,y:0});const pinchRef=useRef(null);
  const[showOss3D,setShowOss3D]=useState(true);
  const[showChassis,setShowChassis]=useState(true);
  const[isMobile,setIsMobile]=useState(()=>window.innerWidth<640);
  // Refs lus dans le render loop (évite les stale closures)
  const showOssRef=useRef(true);const showChassisRef=useRef(true);
  const chassisGroupRef=useRef(null);
  useEffect(()=>{showOssRef.current=showOss3D;},[showOss3D]);
  useEffect(()=>{showChassisRef.current=showChassis;},[showChassis]);
  useEffect(()=>{const h=()=>setIsMobile(window.innerWidth<640);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);

  useEffect(()=>{
    if(!zone||!calc||!mountRef.current)return;
    const W=mountRef.current.clientWidth,H=mountRef.current.clientHeight;
    const scene=new THREE.Scene();
    scene.background=new THREE.Color(0x1a1e2e);

    const camera=new THREE.PerspectiveCamera(42,W/H,0.01,300);
    const renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
    renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.shadowMap.enabled=true;
    renderer.shadowMap.type=THREE.PCFSoftShadowMap;
    mountRef.current.innerHTML='';mountRef.current.appendChild(renderer.domElement);

    // ── Lumières ──
    // Lumière ambiante douce (ciel couvert)
    const amb=new THREE.AmbientLight(0xd0dff0,0.55);scene.add(amb);
    // Soleil (angle ~45° depuis la droite-haut)
    const sun=new THREE.DirectionalLight(0xfff5e0,1.1);
    sun.position.set(8,12,8);sun.castShadow=true;
    sun.shadow.camera.near=0.1;sun.shadow.camera.far=80;
    sun.shadow.camera.left=-15;sun.shadow.camera.right=15;
    sun.shadow.camera.top=15;sun.shadow.camera.bottom=-15;
    sun.shadow.mapSize.width=2048;sun.shadow.mapSize.height=2048;
    sun.shadow.bias=-0.0005;
    scene.add(sun);
    // Contre-jour bleuté depuis le bas-gauche
    const fill=new THREE.DirectionalLight(0x8ab0ff,0.35);fill.position.set(-4,-2,3);scene.add(fill);
    // Lumière de rebond du sol
    const bounce=new THREE.PointLight(0xffeedd,0.2,30);bounce.position.set(0,-5,4);scene.add(bounce);

    const Lm=zone.L/1000,Hm=zone.H/1000,depth=0.008;
    const facadeGroup=new THREE.Group();
    facadeGroup.position.set(-Lm/2,-Hm/2,0);

    // ── Matériaux ──
    const baseColor=new THREE.Color(ralColor||'#383E42');
    const fin=ralFinish||'mat';
    const isBrillant=fin==='brillant',isSatine=fin==='satiné',isMiroir=fin==='miroir',isBrosse=fin==='brossé';
    const panMetal=isBrillant?0.75:isSatine?0.55:isMiroir?0.9:isBrosse?0.5:0.38;
    const panRough=isBrillant?0.06:isSatine?0.2:isMiroir?0.02:isBrosse?0.38:0.52;
    // Env map pour les reflets
    const cubeRT=new THREE.WebGLCubeRenderTarget(128);
    const cubeCamera=new THREE.CubeCamera(0.1,20,cubeRT);
    const envScene=new THREE.Scene();
    envScene.background=new THREE.Color(0x4a7ab5);
    const envSky=new THREE.Mesh(new THREE.SphereGeometry(10,16,8),new THREE.MeshBasicMaterial({color:0x6aa0d0,side:THREE.BackSide}));
    envScene.add(envSky);
    const envFloor2=new THREE.Mesh(new THREE.PlaneGeometry(20,20),new THREE.MeshBasicMaterial({color:0x3a4a3a}));
    envFloor2.rotation.x=-Math.PI/2;envFloor2.position.y=-3;envScene.add(envFloor2);
    cubeCamera.update(renderer,envScene);

    const panMat=new THREE.MeshStandardMaterial({color:baseColor.clone(),metalness:panMetal,roughness:panRough,
      envMap:cubeRT.texture,envMapIntensity:isBrillant?1.4:isSatine?0.7:isMiroir?2.0:0.25});
    panMat.needsUpdate=true;
    const ossMat=new THREE.MeshStandardMaterial({color:0x909090,metalness:0.65,roughness:0.25});
    const concreteMat=new THREE.MeshStandardMaterial({color:0xb0b0a8,metalness:0.04,roughness:0.92});

    // ── Panels — positions corrigées avec joints réels ──
    // Dans baseXBounds : pLeft du col bc>0 commence AU DÉBUT du joint précédent,
    // donc pWa inclut ce joint. Il faut soustraire jGapsH[bc-1] pour le vrai panneau.
    const jGapsH3=calc.jGapsH||[];// joint widths per gap (mm)
    const jGapsV3=calc.jGapsV||[];
    const minJointVis=0.002;// 2mm min visual joint in 3D

    const getPanelRect=(pm)=>{
      const bx1=calc.baseXBounds[pm.parentCol];
      const by1=calc.baseYBounds[pm.parentRow];
      const jPH=pm.parentCol>0?(jGapsH3[pm.parentCol-1]||0)/1000:0;
      const jPV=pm.parentRow>0?(jGapsV3[pm.parentRow-1]||0)/1000:0;
      const atLeft=Math.abs(pm.pLeft-bx1)<0.0005;
      const atTop=Math.abs(pm.pTop-by1)<0.0005;
      const l=pm.pLeft+(atLeft?jPH:0);
      const t=pm.pTop+(atTop?jPV:0);
      const w=pm.pWa-(atLeft?jPH:0);
      const h=pm.pHa-(atTop?jPV:0);
      return{l,t,w,h};
    };

    // Panneau normaux
    const activePanels=calc.panelMap.filter(p=>!p.isVoid&&!p.isExcluded);
    activePanels.forEach(pm=>{
      const{l,t,w,h}=getPanelRect(pm);
      if(w<0.001||h<0.001)return;
      const geo=new THREE.BoxGeometry(w,h,depth);
      const mesh=new THREE.Mesh(geo,panMat);
      mesh.position.set(l+w/2,Hm-(t+h/2),depth/2);
      facadeGroup.add(mesh);
    });

    // Panneaux exclus (balcons) — béton extrudé
    const excludedPanels=calc.panelMap.filter(p=>p.isExcluded);
    excludedPanels.forEach(pm=>{
      const{l,t,w,h}=getPanelRect(pm);
      if(w<0.001||h<0.001)return;
      const extDepth=(pm.exclusionDepth||1500)/1000;
      const geo=new THREE.BoxGeometry(w,h,extDepth);
      const mesh=new THREE.Mesh(geo,concreteMat);
      mesh.position.set(l+w/2,Hm-(t+h/2),depth+extDepth/2);
      facadeGroup.add(mesh);
    });

    // ── Joints 3D : rainures visibles entre panneaux ──
    // Matériau joint : aluminium sombre, légèrement métallique (EPDM / silicone noir)
    const jointMat=new THREE.MeshStandardMaterial({color:0x111418,metalness:0.15,roughness:0.9});
    const jointDepth=depth*1.5;// joints légèrement plus profonds que les panneaux
    const merges=zone.merges||[];
    // Ouvertures en mètres pour découper les joints
    const ouvsMm=zone.ouvs.map(o=>({l:o.x/1000,r:(o.x+o.w)/1000,t:o.y/1000,b:(o.y+o.h)/1000}));

    // ── Joints verticaux (entre colonnes) — découpés autour des ouvertures ──
    calc.baseXBounds.slice(1,-1).forEach((xb,i)=>{
      const isInsideMerge=merges.some(m=>i>=m.c1&&i<m.c2);
      if(isInsideMerge)return;
      const jw=Math.max(minJointVis,(jGapsH3[i]||0)/1000);
      const jCx=xb+jw/2;
      // Découper ce joint vertical en segments qui évitent les ouvertures
      let segs=[{y1:0,y2:Hm}];
      ouvsMm.forEach(o=>{
        // Le joint passe dans l'ouverture si son x est entre oL et oR
        if(jCx<o.l-jw/2||jCx>o.r+jw/2)return;
        const ns=[];segs.forEach(s=>{
          const oT=o.t,oB=o.b;
          if(oT>=s.y2||oB<=s.y1){ns.push(s);return;}
          if(s.y1<oT)ns.push({y1:s.y1,y2:oT});
          if(oB<s.y2)ns.push({y1:oB,y2:s.y2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sh=s.y2-s.y1;if(sh<0.005)return;
        const geo=new THREE.BoxGeometry(jw,sh,jointDepth);
        const m=new THREE.Mesh(geo,jointMat);
        m.position.set(jCx,Hm-s.y1-sh/2,jointDepth/2);
        facadeGroup.add(m);
      });
    });

    // ── Joints horizontaux (entre rangées) — découpés autour des ouvertures ──
    calc.baseYBounds.slice(1,-1).forEach((yb,i)=>{
      const isInsideMerge=merges.some(m=>i>=m.r1&&i<m.r2);
      if(isInsideMerge)return;
      const jv=Math.max(minJointVis,(jGapsV3[i]||0)/1000);
      const jCy=Hm-yb-jv/2;
      const jYworld=yb+jv/2;// position Y en coords façade
      let segs=[{x1:0,x2:Lm}];
      ouvsMm.forEach(o=>{
        if(jYworld<o.t-jv/2||jYworld>o.b+jv/2)return;
        const ns=[];segs.forEach(s=>{
          const oL=o.l,oR=o.r;
          if(oL>=s.x2||oR<=s.x1){ns.push(s);return;}
          if(s.x1<oL)ns.push({x1:s.x1,x2:oL});
          if(oR<s.x2)ns.push({x1:oR,x2:s.x2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sw=s.x2-s.x1;if(sw<0.005)return;
        const geo=new THREE.BoxGeometry(sw,jv,jointDepth);
        const m=new THREE.Mesh(geo,jointMat);
        m.position.set(s.x1+sw/2,jCy,jointDepth/2);
        facadeGroup.add(m);
      });
    });

    // ── Matériaux retours : même finition RAL que les cassettes ──
    const retMat=new THREE.MeshStandardMaterial({color:baseColor.clone(),metalness:panMetal,roughness:panRough+0.05,
      envMap:cubeRT.texture,envMapIntensity:isBrillant?0.9:0.2});
    // Matériau bord coupé (chant de tôle) : légèrement plus foncé, mat
    const edgeMat=new THREE.MeshStandardMaterial({color:baseColor.clone().multiplyScalar(0.7),metalness:0.3,roughness:0.65});
    // Vitrage
    const glassMat=new THREE.MeshStandardMaterial({color:0x3a6a9f,metalness:0.05,roughness:0.04,transparent:true,opacity:0.45,side:THREE.DoubleSide});
    // Chassis alu anodisé
    const chassisMat=new THREE.MeshStandardMaterial({color:0x8a8a8a,metalness:0.7,roughness:0.25});


    const chassisGroup=new THREE.Group();

    zone.ouvs.forEach(o=>{
      const ox=o.x/1000,oy=o.y/1000,ow=o.w/1000,oh=o.h/1000;
      const r=o.retours||{tG:150,tD:150,lin:150,app:150};
      const fv=(o.faceVis||50)/1000;// face visible (retour en saillie)
      const pt=depth;// épaisseur tôle = même que cassette

      // ── Tableau G (joue gauche) — profil L ──
      if(r.tG>0){
        const rd=r.tG/1000;
        // Face visible (dans le plan de façade)
        const fg=new THREE.Mesh(new THREE.BoxGeometry(fv,oh,pt),retMat);
        fg.position.set(ox-fv/2,Hm-(oy+oh/2),pt/2);facadeGroup.add(fg);
        // Chant visible
        const eg=new THREE.Mesh(new THREE.BoxGeometry(pt,oh,pt),edgeMat);
        eg.position.set(ox-fv,Hm-(oy+oh/2),pt/2);facadeGroup.add(eg);
        // Retour (perpendiculaire, s'enfonce dans le mur)
        const rg=new THREE.Mesh(new THREE.BoxGeometry(pt,oh,rd),retMat);
        rg.position.set(ox,Hm-(oy+oh/2),-rd/2);facadeGroup.add(rg);
      }
      // ── Tableau D (joue droite) ──
      if(r.tD>0){
        const rd=r.tD/1000;
        const fd=new THREE.Mesh(new THREE.BoxGeometry(fv,oh,pt),retMat);
        fd.position.set(ox+ow+fv/2,Hm-(oy+oh/2),pt/2);facadeGroup.add(fd);
        const ed=new THREE.Mesh(new THREE.BoxGeometry(pt,oh,pt),edgeMat);
        ed.position.set(ox+ow+fv,Hm-(oy+oh/2),pt/2);facadeGroup.add(ed);
        const rd2=new THREE.Mesh(new THREE.BoxGeometry(pt,oh,rd),retMat);
        rd2.position.set(ox+ow,Hm-(oy+oh/2),-rd/2);facadeGroup.add(rd2);
      }
      // ── Linteau (retour haut) ──
      if(r.lin>0){
        const rd=r.lin/1000;
        const fl=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,pt),retMat);
        fl.position.set(ox+ow/2,Hm-(oy-fv/2),pt/2);facadeGroup.add(fl);
        const el=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,pt,pt),edgeMat);
        el.position.set(ox+ow/2,Hm-(oy-fv),pt/2);facadeGroup.add(el);
        const rl=new THREE.Mesh(new THREE.BoxGeometry(ow,pt,rd),retMat);
        rl.position.set(ox+ow/2,Hm-oy,-rd/2);facadeGroup.add(rl);
      }
      // ── Appui (retour bas) ──
      if(r.app>0){
        const rd=r.app/1000;
        const fa=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,fv,pt),retMat);
        fa.position.set(ox+ow/2,Hm-(oy+oh+fv/2),pt/2);facadeGroup.add(fa);
        const ea=new THREE.Mesh(new THREE.BoxGeometry(ow+fv*2,pt,pt),edgeMat);
        ea.position.set(ox+ow/2,Hm-(oy+oh+fv),pt/2);facadeGroup.add(ea);
        const ra=new THREE.Mesh(new THREE.BoxGeometry(ow,pt,rd),retMat);
        ra.position.set(ox+ow/2,Hm-(oy+oh),-rd/2);facadeGroup.add(ra);
      }
      // Vitrage recalé au fond du tableau
      const glassZ=-(Math.max(r.tG||0,r.tD||0)/1000)*0.65;
      const gm=new THREE.Mesh(new THREE.PlaneGeometry(ow-0.01,oh-0.01),glassMat);
      gm.position.set(ox+ow/2,Hm-(oy+oh/2),glassZ);facadeGroup.add(gm);

      // ── Chassis aluminium autour de l'ouverture ──
      const ct=0.035,cd=0.055;// épaisseur et profondeur chassis
      const cz=glassZ+0.01;
      // Haut
      const cTop=new THREE.Mesh(new THREE.BoxGeometry(ow+ct*2,ct,cd),chassisMat);
      cTop.position.set(ox+ow/2,Hm-(oy-ct/2),cz-cd/2);chassisGroup.add(cTop);
      // Bas
      const cBot=new THREE.Mesh(new THREE.BoxGeometry(ow+ct*2,ct,cd),chassisMat);
      cBot.position.set(ox+ow/2,Hm-(oy+oh+ct/2),cz-cd/2);chassisGroup.add(cBot);
      // Gauche
      const cL=new THREE.Mesh(new THREE.BoxGeometry(ct,oh,cd),chassisMat);
      cL.position.set(ox-ct/2,Hm-(oy+oh/2),cz-cd/2);chassisGroup.add(cL);
      // Droite
      const cR=new THREE.Mesh(new THREE.BoxGeometry(ct,oh,cd),chassisMat);
      cR.position.set(ox+ow+ct/2,Hm-(oy+oh/2),cz-cd/2);chassisGroup.add(cR);
    });
    facadeGroup.add(chassisGroup);

    // ── Ossature ──
    const ossGroup=new THREE.Group();
    const eM=zone.oss.eM/1000,eLi=zone.oss.eL/1000;
    const mW=0.06,mD=0.04;// montant section (60x40mm omega)
    const lW=0.04,lD=0.04;// lisse section (40x40mm)
    const ossZ=-mD/2-0.002;// z de l'ossature (derrière les panneaux)

    // Montants verticaux
    for(let i=0;i<=Math.floor(Lm/eM);i++){
      const mx=i*eM;if(mx>Lm+0.001)break;
      let segs=[{y1:0,y2:Hm}];
      zone.ouvs.forEach(o=>{
        const oT=o.y/1000,oB=(o.y+o.h)/1000,oL=o.x/1000,oR=(o.x+o.w)/1000;
        if(mx<oL+0.01||mx>oR-0.01)return;
        const ns=[];segs.forEach(s=>{
          if(oT>=s.y2||oB<=s.y1){ns.push(s);return}
          if(s.y1<oT)ns.push({y1:s.y1,y2:oT});
          if(oB<s.y2)ns.push({y1:oB,y2:s.y2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sh=s.y2-s.y1;if(sh<0.02)return;
        const g=new THREE.BoxGeometry(mW,sh,mD);const m=new THREE.Mesh(g,ossMat);
        m.position.set(mx,Hm-s.y1-sh/2,ossZ);ossGroup.add(m);
      });
    }
    // Lisses horizontales
    for(let i=0;i<=Math.floor(Hm/eLi);i++){
      const ly=i*eLi;if(ly>Hm+0.001)break;
      let segs=[{x1:0,x2:Lm}];
      zone.ouvs.forEach(o=>{
        const oT=o.y/1000,oB=(o.y+o.h)/1000,oL=o.x/1000,oR=(o.x+o.w)/1000;
        if(ly<oT+0.01||ly>oB-0.01)return;
        const ns=[];segs.forEach(s=>{
          if(oL>=s.x2||oR<=s.x1){ns.push(s);return}
          if(s.x1<oL)ns.push({x1:s.x1,x2:oL});
          if(oR<s.x2)ns.push({x1:oR,x2:s.x2});
        });segs=ns;
      });
      segs.forEach(s=>{
        const sw=s.x2-s.x1;if(sw<0.02)return;
        const g=new THREE.BoxGeometry(sw,lW,lD);const m=new THREE.Mesh(g,ossMat);
        m.position.set(s.x1+sw/2,Hm-ly,ossZ-mD/2-lD/2+0.002);ossGroup.add(m);
      });
    }
    facadeGroup.add(ossGroup);
    scene.add(facadeGroup);
    chassisGroupRef.current=chassisGroup;

    // ── Concrete wall (toggleable) ──
    if(showWall){
      const wallGeo=new THREE.BoxGeometry(Lm+0.1,Hm+0.1,0.18);
      const wallMat=new THREE.MeshStandardMaterial({color:0x787878,roughness:0.95,metalness:0.02});
      const wall=new THREE.Mesh(wallGeo,wallMat);
      wall.position.set(0,0,-0.14);scene.add(wall);
    }

    // ── Bavette (drip edge at bottom) ──
    const bavH=0.04,bavD=0.06;
    const bavGeo=new THREE.BoxGeometry(Lm+0.02,bavH,bavD);
    const bavMat=new THREE.MeshStandardMaterial({color:baseColor.clone().multiplyScalar(0.85),metalness:0.5,roughness:0.4});
    const bav=new THREE.Mesh(bavGeo,bavMat);
    bav.position.set(0,-Hm/2-bavH/2,bavD/2-0.01);scene.add(bav);
    const lipGeo=new THREE.BoxGeometry(Lm+0.02,0.012,0.025);
    const lip=new THREE.Mesh(lipGeo,bavMat);
    lip.position.set(0,-Hm/2-bavH-0.005,bavD/2+0.005);lip.rotation.x=0.3;scene.add(lip);

    // ── Couvertine (coping at top) ──
    const covH=0.035,covD=0.08;
    const covGeo=new THREE.BoxGeometry(Lm+0.04,covH,covD);
    const covMat=new THREE.MeshStandardMaterial({color:baseColor.clone().multiplyScalar(0.9),metalness:0.5,roughness:0.35});
    const cov=new THREE.Mesh(covGeo,covMat);
    cov.position.set(0,Hm/2+covH/2,covD/2-0.02);scene.add(cov);
    const covLipGeo=new THREE.BoxGeometry(Lm+0.04,0.008,covD+0.02);
    const covLip=new THREE.Mesh(covLipGeo,covMat);
    covLip.position.set(0,Hm/2+covH+0.003,covD/2-0.02);scene.add(covLip);

    // ── Sol / trottoir ──
    const groundW=Lm+6,groundD=8;
    const groundMat=new THREE.MeshStandardMaterial({color:0x666670,roughness:0.92,metalness:0.05});
    const groundGeo=new THREE.BoxGeometry(groundW,0.08,groundD);
    const ground=new THREE.Mesh(groundGeo,groundMat);
    ground.position.set(0,-Hm/2-0.04-0.04,groundD/2-1);
    ground.receiveShadow=true;scene.add(ground);
    // Liseré de plinthe au pied du bâtiment
    const plinthMat=new THREE.MeshStandardMaterial({color:0x5a5a60,roughness:0.85,metalness:0.1});
    const plinthGeo=new THREE.BoxGeometry(Lm+0.06,0.12,0.15);
    const plinth=new THREE.Mesh(plinthGeo,plinthMat);
    plinth.position.set(0,-Hm/2-0.04,0.07);scene.add(plinth);

    // Render loop
    const animate=()=>{
      frameRef.current=requestAnimationFrame(animate);
      const d=zoomRef.current;
      ossGroup.visible=showOssRef.current;
      chassisGroup.visible=showChassisRef.current;
      const px=panRef.current.x,py=panRef.current.y;
      camera.position.set(px+d*Math.sin(rotRef.current.y)*Math.cos(rotRef.current.x),
        py+d*Math.sin(rotRef.current.x),d*Math.cos(rotRef.current.y)*Math.cos(rotRef.current.x));
      camera.lookAt(px,py,0);renderer.render(scene,camera);
    };animate();

    const handleResize=()=>{if(!mountRef.current)return;const w=mountRef.current.clientWidth,h=mountRef.current.clientHeight;
      camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h)};
    window.addEventListener('resize',handleResize);

    // ── Events souris + touch directement sur le canvas WebGL ──
    // (nécessaire sur iOS Safari : le canvas natif intercepte tout avant React)
    const canvas=renderer.domElement;

    const onMD=e=>{
      if(e.button===2||e.shiftKey||e.button===1){
        dragRef.current={x:e.clientX,y:e.clientY,px:panRef.current.x,py:panRef.current.y,mode:'pan'};
      }else{dragRef.current={x:e.clientX,y:e.clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};}
    };
    const onMM=e=>{if(!dragRef.current)return;
      if(dragRef.current.mode==='pan'){
        panRef.current.x=dragRef.current.px-(e.clientX-dragRef.current.x)*0.006;
        panRef.current.y=dragRef.current.py+(e.clientY-dragRef.current.y)*0.006;
      }else{
        rotRef.current.y=dragRef.current.ry+(e.clientX-dragRef.current.x)*0.005;
        rotRef.current.x=Math.max(-1.2,Math.min(1.2,dragRef.current.rx+(e.clientY-dragRef.current.y)*0.005));
      }};
    const onMU=()=>{dragRef.current=null;};
    const onWH=e=>{e.preventDefault();zoomRef.current=Math.max(0.15,Math.min(60,zoomRef.current*(1+e.deltaY*0.0012)));};

    // Touch : 1 doigt = rotation, 2 doigts = pan + pinch zoom
    // NE PAS appeler preventDefault() dans touchstart — cela bloque TOUS les taps sur iOS
    // y compris les boutons au-dessus du canvas. Seulement dans touchmove (pendant le drag).
    const onTS=e=>{
      const t=e.touches;
      if(t.length===1){
        dragRef.current={x:t[0].clientX,y:t[0].clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};
        pinchRef.current=null;
      }else if(t.length===2){
        const dx=t[1].clientX-t[0].clientX,dy=t[1].clientY-t[0].clientY;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const mx=(t[0].clientX+t[1].clientX)/2,my=(t[0].clientY+t[1].clientY)/2;
        pinchRef.current={dist,zoom:zoomRef.current};
        dragRef.current={x:mx,y:my,px:panRef.current.x,py:panRef.current.y,mode:'pan'};
      }
    };
    const onTM=e=>{
      if(dragRef.current)e.preventDefault();// bloque scroll SEULEMENT pendant un drag actif
      const t=e.touches;
      if(t.length===1&&dragRef.current?.mode==='rot'){
        rotRef.current.y=dragRef.current.ry+(t[0].clientX-dragRef.current.x)*0.005;
        rotRef.current.x=Math.max(-1.2,Math.min(1.2,dragRef.current.rx+(t[0].clientY-dragRef.current.y)*0.005));
      }else if(t.length===2){
        const dx=t[1].clientX-t[0].clientX,dy=t[1].clientY-t[0].clientY;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const mx=(t[0].clientX+t[1].clientX)/2,my=(t[0].clientY+t[1].clientY)/2;
        // Pinch → zoom
        if(pinchRef.current){
          zoomRef.current=Math.max(0.15,Math.min(60,pinchRef.current.zoom*(pinchRef.current.dist/dist)));
        }
        // Translation 2 doigts → pan (horizontal prioritaire, sensibilité augmentée)
        if(dragRef.current?.mode==='pan'){
          panRef.current.x=dragRef.current.px-(mx-dragRef.current.x)*0.008;
          panRef.current.y=dragRef.current.py+(my-dragRef.current.y)*0.008;
        }
      }
    };
    const onTE=e=>{
      if(e.touches.length===0){dragRef.current=null;pinchRef.current=null;}
      else if(e.touches.length===1){
        // Retour à 1 doigt après 2 → reprendre rotation depuis position actuelle
        dragRef.current={x:e.touches[0].clientX,y:e.touches[0].clientY,rx:rotRef.current.x,ry:rotRef.current.y,mode:'rot'};
        pinchRef.current=null;
      }
    };

    canvas.addEventListener('mousedown',onMD);
    canvas.addEventListener('mousemove',onMM,{passive:true});
    canvas.addEventListener('mouseup',onMU);
    canvas.addEventListener('mouseleave',onMU);
    canvas.addEventListener('wheel',onWH,{passive:false});
    canvas.addEventListener('touchstart',onTS,{passive:true});// passive=OK, pas de preventDefault dans touchstart
    canvas.addEventListener('touchmove',onTM,{passive:false});
    canvas.addEventListener('touchend',onTE);
    canvas.addEventListener('touchcancel',onTE);
    canvas.addEventListener('contextmenu',e=>e.preventDefault());

    return()=>{
      cancelAnimationFrame(frameRef.current);
      window.removeEventListener('resize',handleResize);
      canvas.removeEventListener('mousedown',onMD);canvas.removeEventListener('mousemove',onMM);
      canvas.removeEventListener('mouseup',onMU);canvas.removeEventListener('mouseleave',onMU);
      canvas.removeEventListener('wheel',onWH);canvas.removeEventListener('touchstart',onTS);
      canvas.removeEventListener('touchmove',onTM);canvas.removeEventListener('touchend',onTE);
      canvas.removeEventListener('touchcancel',onTE);
      renderer.dispose();if(mountRef.current)mountRef.current.innerHTML='';
    };
  },[zone,calc,ralColor,ralFinish,showOss3D,showWall]);

  // ── Styles communs boutons 3D ──
  const bBase={WebkitTapHighlightColor:'transparent',WebkitBackdropFilter:'blur(10px)',backdropFilter:'blur(10px)',
    border:'none',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',
    transition:'all .15s',fontFamily:'DM Sans,sans-serif'};
  const bOff={...bBase,background:'rgba(20,22,38,.82)',color:'rgba(255,255,255,.55)'};
  const bOn={...bBase,background:'rgba(79,110,247,.28)',color:'#93c5fd'};
  const bGreen={...bBase,background:'rgba(16,185,129,.25)',color:'#6ee7b7'};
  const bAmber={...bBase,background:'rgba(245,158,11,.22)',color:'#fbbf24'};
  const bRed={...bBase,background:'rgba(139,26,43,.35)',color:'#fca5a5'};

  // Icônes SVG inline légères
  const IC={
    back:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>,
    reset:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
    face:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18"/></svg>,
    oss:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/></svg>,
    chassis:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="4" width="16" height="16" rx="1"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>,
    bracket:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 19V5h7M5 12h7"/><circle cx="16" cy="8" r="2"/><circle cx="16" cy="16" r="2"/></svg>,
    wall:<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="3" width="20" height="18" rx="1"/><path d="M2 9h20M2 15h20M8 9v6M14 3v6M14 15v6"/></svg>,
  };

  const Btn=({icon,label,active,color,onClick,style={}})=>{
    const s=color==='green'?bGreen:color==='amber'?bAmber:color==='red'?bRed:active?bOn:bOff;
    return<button onClick={onClick} style={{...s,borderRadius:12,gap:4,
      boxShadow:active?'0 0 0 1px rgba(79,110,247,.4)':'0 0 0 1px rgba(255,255,255,.08)',...style}}>
      {icon}
      <span style={{fontSize:9,fontWeight:600,letterSpacing:.3,textTransform:'uppercase',lineHeight:1}}>{label}</span>
    </button>;
  };

  // Styles boutons — pas de pointerEvents override, les boutons fonctionnent normalement
  const BS={base:{border:'none',cursor:'pointer',borderRadius:10,fontFamily:'DM Sans,sans-serif',
    WebkitTapHighlightColor:'transparent',display:'flex',flexDirection:'column',
    alignItems:'center',justifyContent:'center',gap:3,transition:'background .15s,color .15s',
    boxShadow:'0 1px 8px rgba(0,0,0,.4)'},
    off:{background:'rgba(20,22,38,.9)',color:'rgba(255,255,255,.6)'},
    on:{background:'rgba(79,110,247,.35)',color:'#93c5fd'},
    amber:{background:'rgba(245,158,11,.28)',color:'#fbbf24'},
    green:{background:'rgba(16,185,129,.25)',color:'#6ee7b7'},
    red:{background:'rgba(139,26,43,.8)',color:'#fca5a5'},
  };
  const B=({ic,lb,on,col,fn,w=56,h=40})=>{
    const s=col==='red'?BS.red:col==='amber'?BS.amber:col==='green'?BS.green:on?BS.on:BS.off;
    return<button onClick={fn} style={{...BS.base,...s,minWidth:w,minHeight:h,padding:'4px 8px'}}>
      {ic}
      <span style={{fontSize:9,fontWeight:600,letterSpacing:.4,textTransform:'uppercase',lineHeight:1,whiteSpace:'nowrap'}}>{lb}</span>
    </button>;
  };
  const sv=(d)=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.2">{d}</svg>;
  const ICONS={
    back:sv(<path d="M19 12H5M12 5l-7 7 7 7"/>),
    reset:sv(<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>),
    face:sv(<><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></>),
    oss:sv(<><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><circle cx="12" cy="12" r="3"/></>),
    chassis:sv(<><rect x="4" y="4" width="16" height="16" rx="1"/><rect x="8" y="8" width="8" height="8" rx="1"/></>),
    wall:sv(<><rect x="2" y="3" width="20" height="18" rx="1"/><path d="M2 9h20M2 15h20M8 9v6M14 3v6M14 15v6"/></>),
  };

  const uiZ={position:'absolute',zIndex:30};
  return<div style={{position:'absolute',inset:0,zIndex:10,background:'#13151f'}}>
    {/* Canvas 3D — aucun pointer event sur ce div, seulement sur le canvas interne via addEventListener */}
    <div ref={mountRef} style={{position:'absolute',inset:0,touchAction:'none'}}/>

    {/* ── MOBILE : haut + bas ── */}
    {isMobile&&<>
      <div style={{...uiZ,top:0,left:0,right:0,display:'flex',alignItems:'center',gap:6,padding:'8px 10px',
        background:'linear-gradient(180deg,rgba(8,10,18,.97) 0%,rgba(8,10,18,0) 100%)'}}>
        <B ic={ICONS.back} lb="← 2D" col="red" fn={onClose} w={52} h={46}/>
        <div style={{flex:1,minWidth:0,padding:'0 4px'}}>
          <div style={{fontSize:11,fontWeight:700,color:'#fff',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{zone.name||'Façade'}</div>
          <div style={{fontSize:9,color:'rgba(255,255,255,.35)',fontFamily:'monospace'}}>{(zone.L/1000).toFixed(2)}×{(zone.H/1000).toFixed(2)} m · {calc.nP} pan.</div>
        </div>
        <B ic={ICONS.reset} lb="Reset" fn={()=>{rotRef.current={x:-.3,y:.4};zoomRef.current=3;panRef.current={x:0,y:0}}} w={48} h={46}/>
        <B ic={ICONS.face} lb="Face" fn={()=>{rotRef.current={x:0,y:0};zoomRef.current=3}} w={48} h={46}/>
      </div>
      <div style={{...uiZ,bottom:0,left:0,right:0,padding:'6px 10px 18px',
        background:'linear-gradient(0deg,rgba(8,10,18,.97) 0%,rgba(8,10,18,0) 100%)'}}>
        <div style={{display:'flex',gap:8,justifyContent:'center',marginBottom:6}}>
          <B ic={ICONS.oss} lb="Ossature" on={showOss3D} col={showOss3D?'amber':''} fn={()=>setShowOss3D(v=>!v)} w={90} h={52}/>
          <B ic={ICONS.chassis} lb="Chassis" on={showChassis} col={showChassis?'green':''} fn={()=>setShowChassis(v=>!v)} w={90} h={52}/>
          <B ic={ICONS.wall} lb="Béton" on={showWall} fn={()=>onToggle('wall')} w={90} h={52}/>
        </div>
        <div style={{textAlign:'center',fontSize:9,color:'rgba(255,255,255,.2)',fontFamily:'monospace'}}>
          1 doigt: rotation · 2 doigts: déplacer + zoom
        </div>
      </div>
    </>}

    {/* ── DESKTOP : haut gauche + haut droite ── */}
    {!isMobile&&<>
      <div style={{...uiZ,top:12,left:12,display:'flex',gap:6,alignItems:'center'}}>
        <B ic={ICONS.back} lb="← Vue 2D" col="red" fn={onClose} w={80} h={42}/>
        <B ic={ICONS.reset} lb="Reset" fn={()=>{rotRef.current={x:-.3,y:.4};zoomRef.current=3;panRef.current={x:0,y:0}}} w={60} h={42}/>
        <B ic={ICONS.face} lb="Face" fn={()=>{rotRef.current={x:0,y:0};zoomRef.current=3}} w={56} h={42}/>
        <div style={{width:1,height:28,background:'rgba(255,255,255,.12)',margin:'0 2px'}}/>
        <B ic={ICONS.oss} lb="Ossature" on={showOss3D} col={showOss3D?'amber':''} fn={()=>setShowOss3D(v=>!v)} w={76} h={42}/>
        <B ic={ICONS.chassis} lb="Chassis" on={showChassis} col={showChassis?'green':''} fn={()=>setShowChassis(v=>!v)} w={76} h={42}/>
        <B ic={ICONS.wall} lb="Mur béton" on={showWall} fn={()=>onToggle('wall')} w={84} h={42}/>
      </div>
      <div style={{...uiZ,bottom:12,left:'50%',transform:'translateX(-50%)',
        display:'flex',gap:10,alignItems:'center',
        background:'rgba(8,10,18,.8)',borderRadius:8,padding:'5px 14px',
        backdropFilter:'blur(8px)',WebkitBackdropFilter:'blur(8px)',whiteSpace:'nowrap'}}>
        <span style={{fontSize:10,color:'rgba(255,255,255,.3)',fontFamily:'monospace'}}>Drag: tourner · Shift+drag: déplacer · Molette: zoom</span>
        <span style={{fontSize:10,padding:'2px 8px',borderRadius:5,background:'rgba(79,110,247,.2)',color:'#93c5fd',fontFamily:'monospace'}}>
          {(zone.L/1000).toFixed(2)}×{(zone.H/1000).toFixed(2)} m · {calc.nP} pan.</span>
      </div>
    </>}
  </div>;
}

/* ═══ MAIN APP ═══ */
// ═══════════════════════════════════════════════════════════
// SUPABASE + QR CODE HELPERS
// ═══════════════════════════════════════════════════════════
const SUPA_STORAGE_KEY='kalepin_supabase';
function getSupaConfig(){try{return JSON.parse(localStorage.getItem(SUPA_STORAGE_KEY)||'{}')}catch(e){return{}}}
function setSupaConfig(cfg){localStorage.setItem(SUPA_STORAGE_KEY,JSON.stringify(cfg))}

async function supaUpload(zoneData){
  const cfg=getSupaConfig();if(!cfg.url||!cfg.key)return null;
  try{
    const res=await fetch(cfg.url+'/rest/v1/kalepin_views',{
      method:'POST',headers:{'Content-Type':'application/json','apikey':cfg.key,
        'Authorization':'Bearer '+cfg.key,'Prefer':'return=representation'},
      body:JSON.stringify({project_name:zoneData.project_name,zone_name:zoneData.zone_name,
        zone_json:zoneData.zone_json,calc_json:zoneData.calc_json,
        ral_color:zoneData.ral_color,ral_finish:zoneData.ral_finish})
    });
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();return data[0]?.id||null;
  }catch(e){console.error('Supabase upload:',e);return null}
}

async function supaFetch(viewId,cfgOverride){
  const cfg=cfgOverride||getSupaConfig();if(!cfg.url||!cfg.key)return null;
  try{
    const res=await fetch(cfg.url+'/rest/v1/kalepin_views?id=eq.'+viewId+'&select=*',{
      headers:{'apikey':cfg.key,'Authorization':'Bearer '+cfg.key}
    });
    if(!res.ok)return null;
    const data=await res.json();return data[0]||null;
  }catch(e){console.error('Supabase fetch:',e);return null}
}

function makeQRDataURL(text,sizeMM){
  if(typeof qrcode==='undefined')return null;
  try{
    const qr=qrcode(0,'L');qr.addData(text);qr.make();
    const mod=qr.getModuleCount();
    const cell=Math.max(2,Math.floor(sizeMM*3.78/mod));
    const cv=document.createElement('canvas');cv.width=cv.height=mod*cell;
    const cx=cv.getContext('2d');cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height);
    cx.fillStyle='#000';
    for(let r=0;r<mod;r++)for(let c2=0;c2<mod;c2++)if(qr.isDark(r,c2))cx.fillRect(c2*cell,r*cell,cell,cell);
    return cv.toDataURL('image/png');
  }catch(e){console.error('QR:',e);return null}
}

// ── VIEWER MODE (standalone 3D from QR scan) ──
function ViewerApp({viewId}){
  const[data,setData]=useState(null);const[err,setErr]=useState(null);const[loading,setLoading]=useState(true);
  const[showWall,setShowWall]=useState(true);
  useEffect(()=>{
    // Read supabase config from URL params (embedded in QR link) or fallback to localStorage
    const params=new URLSearchParams(window.location.search);
    const cfgFromUrl={url:params.get('s_url')||'',key:params.get('s_key')||''};
    const cfg=(cfgFromUrl.url&&cfgFromUrl.key)?cfgFromUrl:getSupaConfig();
    supaFetch(viewId,cfg).then(d=>{
      if(d){setData(d)}else{setErr('Projet introuvable')}
      setLoading(false);
    });
  },[viewId]);
  if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'#1a1a2e',color:'#fff',fontFamily:'DM Sans'}}>
    <div style={{textAlign:'center'}}><div style={{fontSize:32,marginBottom:12}}>⏳</div><div>Chargement du projet 3D...</div></div></div>;
  if(err||!data)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'#1a1a2e',color:'#fff',fontFamily:'DM Sans'}}>
    <div style={{textAlign:'center'}}><div style={{fontSize:32,marginBottom:12}}>⚠️</div><div>{err||'Erreur'}</div>
      <a href={window.location.pathname} style={{color:'#8b5cf6',marginTop:16,display:'block'}}>← Retour au Kalepin</a></div></div>;
  const zone=JSON.parse(data.zone_json);const calc=JSON.parse(data.calc_json);
  return<div style={{width:'100vw',height:'100vh',position:'relative'}}>
    <Facade3D zone={zone} calc={calc} ralColor={data.ral_color||'#383E42'} ralFinish={data.ral_finish||'mat'}
      showWall={showWall} onToggle={k=>{if(k==='wall')setShowWall(v=>!v);}} onClose={()=>window.location.href=window.location.pathname}/>
    <div style={{position:'absolute',top:16,left:16,zIndex:100,background:'rgba(0,0,0,.7)',padding:'10px 16px',borderRadius:12,color:'#fff',fontFamily:'DM Sans'}}>
      <div style={{fontSize:14,fontWeight:700}}>{data.project_name}</div>
      <div style={{fontSize:11,opacity:.7}}>{data.zone_name} — {zone.L/1000}×{zone.H/1000}m</div>
    </div>
  </div>;
}

function App(){
  const[step,setStep]=useState('welcome');
  const[projectName,setProjectName]=useState('Projet facade');
  const[bgSrc,setBgSrc]=useState(null);const[bgW,setBgW]=useState(0);const[bgH,setBgH]=useState(0);
  const[bgOp,setBgOp]=useState(.35);const[bgVis,setBgVis]=useState(true);
  const[zoom,setZoom]=useState(1);const[pan,setPan]=useState({x:0,y:0});const[isPanning,setIsPanning]=useState(null);
  const viewStatesRef=useRef({});// {zoneId: {zoom, pan}} — per-tab view memory
  const saveView=useCallback((zoneId,z,p)=>{viewStatesRef.current[zoneId]={zoom:z,pan:p};},[]);
  const restoreView=useCallback((zoneId,fallbackFn)=>{
    const saved=viewStatesRef.current[zoneId];
    if(saved){setZoom(saved.zoom);setPan(saved.pan);}
    else if(fallbackFn){fallbackFn();}
  },[]);
  const[calPts,setCalPts]=useState([]);const[calMm,setCalMm]=useState(1000);const[calModal,setCalModal]=useState(false);const[mmPerPx,setMmPerPx]=useState(null);
  const[zoneStart,setZoneStart]=useState(null);const[zoneCur,setZoneCur]=useState(null);
  const[zones,setZones]=useState([]);const[activeZoneIdx,setActiveZoneIdx]=useState(0);
  const az=zones[activeZoneIdx]||null;
  const[fix,setFix]=useState({pp:6,em:3});
  const[selId,setSelId]=useState(null);const[selIds,setSelIds]=useState(new Set());const[showAlignPanel,setShowAlignPanel]=useState(false);const[modeDraw,setModeDraw]=useState(false);const[drawRect,setDrawRect]=useState(null);
  const[lasso,setLasso]=useState(null);
  const[editPanel,setEditPanel]=useState(null);// {col, row, screenX, screenY}
  const[mergeSrc,setMergeSrc]=useState(null);// {col, row, parentCol, parentRow} — first panel for merge
  const[excludeMode,setExcludeMode]=useState(false);const[coupeOuv,setCoupeOuv]=useState(null);// true = click on panel to toggle exclusion
  const[excludeDepth,setExcludeDepth]=useState(1500);// default extrusion depth mm
  const[rightTab,setRightTab]=useState('resultats');
  const[presPan,setPresPan]=useState(DP);const[presOuv,setPresOuv]=useState(DO);
  const[addMod,setAddMod]=useState(null);const[expMod,setExpMod]=useState(false);
  const[expSel,setExpSel]=useState({});const[pdfOss,setPdfOss]=useState(false);const[pdfPageNums,setPdfPageNums]=useState({});// {zoneIdx: pageNum} — zones same pageNum = même page
  const[xlsxExpMod,setXlsxExpMod]=useState(false);const[xlsxExpSel,setXlsxExpSel]=useState({});
  const[supaModal,setSupaModal]=useState(false);const[pdfQR,setPdfQR]=useState(false);
  const[supaConf,setSupaConf]=useState(()=>getSupaConfig());
  const[renamingTab,setRenamingTab]=useState(null);// zone index being renamed inline
  const[optMod,setOptMod]=useState(false);const[optResults,setOptResults]=useState([]);
  // Polygon drawing
  const[polyMode,setPolyMode]=useState(false);const[polyPts,setPolyPts]=useState([]);
  // Zone dragging
  const[dragZone,setDragZone]=useState(null);
  const[dragJoint,setDragJoint]=useState(null);// {type:'h'|'v', index, startPos, origSize}
  const[resizeZone,setResizeZone]=useState(null);
  const[rotateZone,setRotateZone]=useState(null);
  // DXF vector overlay
  const[dxfData,setDxfData]=useState(null);// {lines:[{x1,y1,x2,y2}], bounds:{minX,minY,maxX,maxY}}
  // Snap system
  const[snapMode,setSnapMode]=useState('grid');// 'free','grid','oss'
  const[gridSize,setGridSize]=useState(10);// mm
  // Measurement tool
  const[measureMode,setMeasureMode]=useState(false);
  const[measurePts,setMeasurePts]=useState([]);// [{x,y}] in mm
  const[measures,setMeasures]=useState([]);// stored measurements
  // Métré panel
  const[metreOpen,setMetreOpen]=useState(false);
  const[metreSelZones,setMetreSelZones]=useState({});
  // RAL Colors
  const RAL_COLORS=[
    // ── RAL Standards ──
    {code:'RAL 9010',name:'Blanc pur',hex:'#f5f5f0',cat:'RAL'},
    {code:'RAL 9016',name:'Blanc signalisation',hex:'#f7fbf5',cat:'RAL'},
    {code:'RAL 9001',name:'Blanc crème',hex:'#efebdc',cat:'RAL'},
    {code:'RAL 9005',name:'Noir foncé',hex:'#0e0e10',cat:'RAL'},
    {code:'RAL 9011',name:'Noir graphite',hex:'#27292b',cat:'RAL'},
    {code:'RAL 7016',name:'Gris anthracite',hex:'#383E42',cat:'RAL'},
    {code:'RAL 7035',name:'Gris clair',hex:'#C4C8C8',cat:'RAL'},
    {code:'RAL 7022',name:'Gris ombre',hex:'#4B4D46',cat:'RAL'},
    {code:'RAL 7024',name:'Gris graphite',hex:'#4E5258',cat:'RAL'},
    {code:'RAL 7040',name:'Gris fenêtre',hex:'#989EA1',cat:'RAL'},
    {code:'RAL 7039',name:'Gris quartz',hex:'#6B6B60',cat:'RAL'},
    {code:'RAL 7021',name:'Gris noir',hex:'#2F3234',cat:'RAL'},
    {code:'RAL 7015',name:'Gris ardoise',hex:'#51565C',cat:'RAL'},
    {code:'RAL 7036',name:'Gris platine',hex:'#97969A',cat:'RAL'},
    {code:'RAL 7047',name:'Télégris 4',hex:'#CBCED0',cat:'RAL'},
    {code:'RAL 1015',name:'Ivoire clair',hex:'#E6D2B5',cat:'RAL'},
    {code:'RAL 1013',name:'Blanc perlé',hex:'#E3D9C6',cat:'RAL'},
    {code:'RAL 1023',name:'Jaune signal',hex:'#F0CA00',cat:'RAL'},
    {code:'RAL 1028',name:'Jaune melon',hex:'#F5A300',cat:'RAL'},
    {code:'RAL 2004',name:'Orange pur',hex:'#E25303',cat:'RAL'},
    {code:'RAL 3000',name:'Rouge feu',hex:'#A72920',cat:'RAL'},
    {code:'RAL 3003',name:'Rouge rubis',hex:'#8D1D2C',cat:'RAL'},
    {code:'RAL 3004',name:'Rouge pourpre',hex:'#6B1C23',cat:'RAL'},
    {code:'RAL 3005',name:'Rouge vin',hex:'#5E2028',cat:'RAL'},
    {code:'RAL 5002',name:'Bleu outremer',hex:'#00387B',cat:'RAL'},
    {code:'RAL 5003',name:'Bleu saphir',hex:'#1E3A5F',cat:'RAL'},
    {code:'RAL 5008',name:'Bleu gris',hex:'#2B3A44',cat:'RAL'},
    {code:'RAL 5015',name:'Bleu ciel',hex:'#2271B3',cat:'RAL'},
    {code:'RAL 5024',name:'Bleu pastel',hex:'#608DA1',cat:'RAL'},
    {code:'RAL 6005',name:'Vert mousse',hex:'#0F4336',cat:'RAL'},
    {code:'RAL 6009',name:'Vert sapin',hex:'#1F3A28',cat:'RAL'},
    {code:'RAL 6021',name:'Vert pâle',hex:'#89AC76',cat:'RAL'},
    {code:'RAL 6029',name:'Vert menthe',hex:'#006B3E',cat:'RAL'},
    {code:'RAL 8014',name:'Brun sépia',hex:'#4A3526',cat:'RAL'},
    {code:'RAL 8017',name:'Brun chocolat',hex:'#45322E',cat:'RAL'},
    {code:'RAL 8019',name:'Brun gris',hex:'#3E3332',cat:'RAL'},
    {code:'RAL 8022',name:'Brun noir',hex:'#1A1718',cat:'RAL'},
    {code:'RAL 9006',name:'Alu blanc',hex:'#A1A1A0',cat:'RAL'},
    {code:'RAL 9007',name:'Alu gris',hex:'#878581',cat:'RAL'},
    // ── Anodisé ──
    {code:'ANO C0',name:'Naturel',hex:'#B0B0A8',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C31',name:'Bronze clair',hex:'#9B8B6C',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C32',name:'Bronze moyen',hex:'#7A6B52',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C33',name:'Bronze foncé',hex:'#5A4B3A',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C34',name:'Noir',hex:'#2A2520',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C35',name:'Champagne',hex:'#C8B898',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C21',name:'Or clair',hex:'#D4B86A',cat:'Anodisé',finish:'brossé'},
    {code:'ANO C22',name:'Or moyen',hex:'#B8963C',cat:'Anodisé',finish:'brossé'},
    // ── Arcelor / PVDF ──
    {code:'ARC 905',name:'Blanc 905',hex:'#F0F0EC',cat:'Arcelor'},
    {code:'ARC 100',name:'Noir 100',hex:'#1A1A1A',cat:'Arcelor'},
    {code:'ARC 7016M',name:'Anthracite mat',hex:'#3A3F44',cat:'Arcelor',finish:'mat'},
    {code:'ARC 7016B',name:'Anthracite brillant',hex:'#454B52',cat:'Arcelor',finish:'brillant'},
    {code:'ARC 7016S',name:'Anthracite sablé',hex:'#3D4248',cat:'Arcelor',finish:'sablé'},
    {code:'ARC 9006',name:'Alu blanc',hex:'#A8A8A6',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC 9007',name:'Alu gris',hex:'#8C8880',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC 1015',name:'Ivoire Sunclean',hex:'#E8D6B8',cat:'Arcelor'},
    {code:'ARC 7035',name:'Gris clair Sunclean',hex:'#C6CACC',cat:'Arcelor'},
    {code:'ARC Zinc',name:'Zinc naturel',hex:'#BCC4C8',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC Bronze',name:'Bronze Arcelor',hex:'#6D5C48',cat:'Arcelor',finish:'métallisé'},
    {code:'ARC Cuivre',name:'Cuivre Arcelor',hex:'#B07040',cat:'Arcelor',finish:'métallisé'},
    // ── Brillant / Satiné ──
    {code:'RAL 9010B',name:'Blanc pur brillant',hex:'#f7f7f2',cat:'Brillant',finish:'brillant'},
    {code:'RAL 9005B',name:'Noir brillant',hex:'#101012',cat:'Brillant',finish:'brillant'},
    {code:'RAL 7016B',name:'Anthracite brillant',hex:'#3C4248',cat:'Brillant',finish:'brillant'},
    {code:'RAL 7035B',name:'Gris clair brillant',hex:'#C8CCCC',cat:'Brillant',finish:'brillant'},
    {code:'RAL 3000B',name:'Rouge feu brillant',hex:'#AB2D24',cat:'Brillant',finish:'brillant'},
    {code:'RAL 5015B',name:'Bleu ciel brillant',hex:'#2675B7',cat:'Brillant',finish:'brillant'},
    {code:'RAL 9010S',name:'Blanc pur satiné',hex:'#f3f3ee',cat:'Satiné',finish:'satiné'},
    {code:'RAL 9005S',name:'Noir satiné',hex:'#131315',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7016S',name:'Anthracite satiné',hex:'#3A3F44',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7035S',name:'Gris clair satiné',hex:'#C2C6C6',cat:'Satiné',finish:'satiné'},
    {code:'RAL 7021S',name:'Gris noir satiné',hex:'#2D3032',cat:'Satiné',finish:'satiné'},
    {code:'RAL 8019S',name:'Brun gris satiné',hex:'#3C3130',cat:'Satiné',finish:'satiné'},
    // ── Inox / Spécial ──
    {code:'INOX 304',name:'Inox brossé',hex:'#C8CCD0',cat:'Spécial',finish:'brossé'},
    {code:'INOX 316',name:'Inox poli miroir',hex:'#D8DDE0',cat:'Spécial',finish:'miroir'},
    {code:'COR-TEN',name:'Acier Corten',hex:'#8B4513',cat:'Spécial',finish:'oxydé'},
    {code:'COR-TEN V',name:'Corten vieilli',hex:'#6B3410',cat:'Spécial',finish:'oxydé'},
    {code:'CUIVRE N',name:'Cuivre neuf',hex:'#B87333',cat:'Spécial',finish:'poli'},
    {code:'CUIVRE P',name:'Cuivre patiné',hex:'#68896B',cat:'Spécial',finish:'patiné'},
    {code:'ZINC N',name:'Zinc neuf',hex:'#CDD4D8',cat:'Spécial',finish:'naturel'},
    {code:'ZINC P',name:'Zinc prépatiné',hex:'#8A9298',cat:'Spécial',finish:'patiné'},
    {code:'TITANE',name:'Titane brossé',hex:'#8C8C88',cat:'Spécial',finish:'brossé'},
    {code:'LAITON',name:'Laiton brossé',hex:'#C5A55A',cat:'Spécial',finish:'brossé'},
  ];
  const RAL_CATS=[...new Set(RAL_COLORS.map(r=>r.cat))];
  const[ralIdx,setRalIdx]=useState(2);// default RAL 7016
  const[ralCat,setRalCat]=useState('RAL');
  const[show3D,setShow3D]=useState(false);
  const[show3DWall,setShow3DWall]=useState(true);

  const cvRef=useRef(),svgRef=useRef(),fileRef=useRef();
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const snap=(v,g)=>{
    if(snapMode==='free')return Math.round(v);
    const gs=g||(snapMode==='oss'&&az?0:gridSize);
    if(snapMode==='oss'&&az){
      // Snap to nearest ossature line
      const eM=az.oss.eM,eL=az.oss.eL;
      const nearM=Math.round(v/eM)*eM,nearL=Math.round(v/eL)*eL,nearG=Math.round(v/gridSize)*gridSize;
      const dM=Math.abs(v-nearM),dL=Math.abs(v-nearL),dG=Math.abs(v-nearG);
      const best=Math.min(dM,dL,dG);
      if(best===dM)return nearM;if(best===dL)return nearL;return nearG;
    }
    return gs>0?Math.round(v/gs)*gs:Math.round(v);
  };
  const updateZone=(idx,fn)=>setZones(zs=>zs.map((z,i)=>i===idx?fn(z):z));
  const updateAZ=fn=>updateZone(activeZoneIdx,fn);
  // Snap opening edge to nearest panel joint boundary
  const snapOuvToJoint=(o,side)=>{
    try{
      if(!C||!C.baseXBounds||C.baseXBounds.length<2)return o;
      const xB=C.baseXBounds.map(v=>Math.round(v*1000));
      const yB=C.baseYBounds.map(v=>Math.round(v*1000));
      let nx=o.x,ny=o.y,nw=o.w,nh=o.h;
      const near=(arr,val)=>{if(!arr.length)return val;return arr.reduce((b,v)=>Math.abs(v-val)<Math.abs(b-val)?v:b,arr[0])};
      if(side==='left'){const n=near(xB,nx);nw=nx+nw-n;nx=n}
      if(side==='right'){const n=near(xB,nx+nw);nw=n-nx}
      if(side==='top'){const n=near(yB,ny);nh=ny+nh-n;ny=n}
      if(side==='bottom'){const n=near(yB,ny+nh);nh=n-ny}
      if(side==='all'){const nl=near(xB,nx);const nr=near(xB,nx+nw);const nt=near(yB,ny);const nb=near(yB,ny+nh);
        nx=nl;nw=nr-nl;ny=nt;nh=nb-nt}
      if(nw<100)nw=100;if(nh<100)nh=100;
      return{...o,x:Math.max(0,nx),y:Math.max(0,ny),w:Math.max(100,nw),h:Math.max(100,nh)};
    }catch(e){console.warn('snapOuvToJoint error',e);return o}
  };
  const manualScale=0.06;const pxPerMm_eff=mmPerPx?(1/mmPerPx):manualScale;

  const s2svg=useCallback((cx,cy)=>{
    if(!svgRef.current)return{x:0,y:0};const r=svgRef.current.getBoundingClientRect();
    return{x:(cx-r.left-pan.x)/zoom,y:(cy-r.top-pan.y)/zoom};
  },[zoom,pan]);
  const s2mm=useCallback((cx,cy,zn)=>{
    if(!svgRef.current||!zn)return{x:0,y:0};const sv=s2svg(cx,cy);
    const sc=mmPerPx||(1/manualScale);return{x:(sv.x-zn.facOrigin.x)*sc,y:(sv.y-zn.facOrigin.y)*sc};
  },[s2svg,mmPerPx]);
  const toMm=(cx,cy)=>s2mm(cx,cy,az);

  useEffect(()=>{const el=cvRef.current;if(!el)return;
    const h=e=>{if(show3D)return;e.preventDefault();const rect=el.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;
      const factor=e.deltaY>0?0.87:1.15;const nz=clamp(zoom*factor,0.01,80);
      const dx=mx-pan.x,dy=my-pan.y;const np={x:mx-dx*(nz/zoom),y:my-dy*(nz/zoom)};setPan(np);setZoom(nz);if(az)saveView(az.id,nz,np);};
    el.addEventListener('wheel',h,{passive:false});
    // Native middle-click handler for panning
    const mh=e=>{if(e.button===1){e.preventDefault();e.stopPropagation();
      setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y,mid:true})}};
    const aux=e=>{if(e.button===1)e.preventDefault()};
    el.addEventListener('mousedown',mh);el.addEventListener('auxclick',aux);
    return()=>{el.removeEventListener('wheel',h);el.removeEventListener('mousedown',mh);el.removeEventListener('auxclick',aux)}
  },[zoom,pan,show3D]);

  useEffect(()=>{const h=e=>{
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
    if(step==='work'){
      if(e.key==='d'||e.key==='D'){setModeDraw(v=>!v);setMeasureMode(false)}
      if(e.key==='m'||e.key==='M'){setMeasureMode(v=>!v);setModeDraw(false);setMeasurePts([])}
      if(e.key==='Delete'&&az){if(selIds.size>0){updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>!selIds.has(o.id))}));setSelIds(new Set())}else if(selId){updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>o.id!==selId)}));setSelId(null)}}
      if(e.key==='Escape'){setModeDraw(false);setMeasureMode(false);setMeasurePts([]);setSelId(null);setSelIds(new Set());setShowAlignPanel(false);setPolyPts([]);setEditPanel(null);setMergeSrc(null);setExcludeMode(false);if(show3D)setShow3D(false)}
      // Ctrl+A = ouvrir panneau d'alignement (si sélection) ou sélectionner toutes
      if((e.ctrlKey||e.metaKey)&&e.key==='a'&&az){e.preventDefault();
        if(selIds.size>=2){setShowAlignPanel(v=>!v);}
        else if(az.ouvs.length>0){setSelIds(new Set(az.ouvs.map(o=>o.id)));setSelId(null);setShowAlignPanel(true);}}
      // Ctrl+E = toggle merge panel mode
      if((e.ctrlKey||e.metaKey)&&e.key==='e'&&az){e.preventDefault();if(mergeSrc){setMergeSrc(null)}else{setMergeSrc({parentCol:-1,parentRow:-1});setEditPanel(null);setSelId(null);}}
      // Copy openings from active zone
      if((e.ctrlKey||e.metaKey)&&e.key==='c'&&az){e.preventDefault();window._copiedOuvs=JSON.parse(JSON.stringify(az.ouvs))}
      // Paste openings into active zone
      if((e.ctrlKey||e.metaKey)&&e.key==='v'&&window._copiedOuvs&&az){e.preventDefault();
        const newOuvs=window._copiedOuvs.map(o=>({...o,id:Date.now()+Math.random()}));
        updateAZ(z=>({...z,ouvs:[...z.ouvs,...newOuvs]}))}
    }
    if(step==='zone'&&e.key==='Escape'){setPolyPts([]);setPolyMode(false)}
    // Enter to validate calibration
    if(calModal&&e.key==='Enter'){e.preventDefault();confirmCal()}
  };window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h);},[step,selId,selIds,az,activeZoneIdx,calModal,zones,zoom,mergeSrc]);

  const autoFit=useCallback(()=>{if(!cvRef.current||!zones.length)return;
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    zones.forEach(z=>{const ox=z.facOrigin.x,oy=z.facOrigin.y;const w=z.L*pxPerMm_eff,h=z.H*pxPerMm_eff;
      minX=Math.min(minX,ox);minY=Math.min(minY,oy);maxX=Math.max(maxX,ox+w);maxY=Math.max(maxY,oy+h);});
    const rect=cvRef.current.getBoundingClientRect();const totalW=maxX-minX,totalH=maxY-minY;
    if(totalW<1||totalH<1)return;const nz=Math.min((rect.width-80)/totalW,(rect.height-80)/totalH,5);
    setZoom(nz);setPan({x:(rect.width-totalW*nz)/2-minX*nz,y:(rect.height-totalH*nz)/2-minY*nz});
  },[zones,pxPerMm_eff]);

  const C=useMemo(()=>az?calcZone({...az,fix}):null,[az,fix]);
  const allCalcs=useMemo(()=>zones.map(z=>calcZone({...z,fix})),[zones,fix]);

  /* ── FILE ── */
  const loadFile=file=>{if(!file)return;const ext=file.name.split('.').pop().toLowerCase();
    if(ext==='dxf'){const reader=new FileReader();reader.onload=ev=>{try{
      const dxf=parseDXF(ev.target.result);setDxfData(dxf);
      // Create raster preview from DXF for background
      const W=1600,H=Math.round(1600*(dxf.bounds.maxY-dxf.bounds.minY)/(dxf.bounds.maxX-dxf.bounds.minX))||1200;
      const cv=document.createElement('canvas');cv.width=W;cv.height=H;const ctx=cv.getContext('2d');
      ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);ctx.strokeStyle='#333';ctx.lineWidth=1;
      const sx=W/(dxf.bounds.maxX-dxf.bounds.minX)*.95,sy=H/(dxf.bounds.maxY-dxf.bounds.minY)*.95;
      const sc=Math.min(sx,sy),ox=W*.025,oy=H*.025;
      dxf.lines.forEach(l=>{ctx.beginPath();
        ctx.moveTo(ox+(l.x1-dxf.bounds.minX)*sc,H-oy-(l.y1-dxf.bounds.minY)*sc);
        ctx.lineTo(ox+(l.x2-dxf.bounds.minX)*sc,H-oy-(l.y2-dxf.bounds.minY)*sc);ctx.stroke()});
      processImage(cv.toDataURL(),W,H);
    }catch(e){alert('Erreur DXF: '+e.message)}};reader.readAsText(file);return}
    if(ext==='pdf'){if(typeof pdfjsLib==='undefined'){alert('PDF.js non charge');return}
      const reader=new FileReader();reader.onload=async ev=>{try{
        const pdf=await pdfjsLib.getDocument(new Uint8Array(ev.target.result)).promise;
        const pg=await pdf.getPage(1);const vp=pg.getViewport({scale:2});
        const cv=document.createElement('canvas');cv.width=vp.width;cv.height=vp.height;
        await pg.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
        processImage(cv.toDataURL(),vp.width,vp.height);
      }catch(e){alert('Erreur PDF: '+e.message)}};
      reader.readAsArrayBuffer(file);
    }else{const reader=new FileReader();reader.onload=ev=>{const img=new Image();img.onload=()=>processImage(ev.target.result,img.width,img.height);img.src=ev.target.result};reader.readAsDataURL(file)}};
  const processImage=(src,natW,natH)=>{setBgSrc(src);setBgW(natW);setBgH(natH);setCalPts([]);setMmPerPx(null);setStep('calibrate');
    setTimeout(()=>{if(!cvRef.current)return;const rect=cvRef.current.getBoundingClientRect();const z=Math.min((rect.width-60)/natW,(rect.height-60)/natH,2);setZoom(z);setPan({x:30,y:30})},50)};

  /* ── FIX ── */
  /* ── MOUSE ── */
  const handleDown=e=>{
    // Middle click handled natively (see useEffect above)
    if(e.button===1){return}
    if(e.button===2){e.preventDefault();setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y,mid:true});return}
    if(e.button!==0)return;if(editPanel)setEditPanel(null);const sv=s2svg(e.clientX,e.clientY);
    if(step==='calibrate'){if(calPts.length<2){const np=[...calPts,{x:sv.x,y:sv.y}];setCalPts(np);if(np.length===2)setCalModal(true)}return}
    if(step==='zone'){
      if(polyMode){// Add polygon point
        const sc=mmPerPx||(1/manualScale);const mmX=sv.x*sc,mmY=sv.y*sc;
        if(polyPts.length>=3){const d=Math.sqrt((sv.x-polyPts[0].sx)**2+(sv.y-polyPts[0].sy)**2);
          if(d<15/zoom){// Close polygon
            const poly=polyPts.map(p=>({x:p.mx,y:p.my}));const b=polyBounds(poly);
            const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,L:Math.round(b.w/50)*50||2000,H:Math.round(b.h/50)*50||2000,
              facOrigin:{x:polyPts[0].sx-b.x/sc,y:polyPts[0].sy-b.y/sc},
              poly:poly.map(p=>({x:Math.round(p.x-b.x),y:Math.round(p.y-b.y)})),
              pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]};
            newZ.L=Math.round(b.w/50)*50||2000;newZ.H=Math.round(b.h/50)*50||2000;
            setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);setPolyPts([]);return;
          }
        }
        setPolyPts(p=>[...p,{sx:sv.x,sy:sv.y,mx:mmX,my:mmY}]);return;
      }
      setZoneStart({x:sv.x,y:sv.y});setZoneCur({x:sv.x,y:sv.y});return;
    }
    if(step==='work'&&az){
      const mm=toMm(e.clientX,e.clientY);
      // Measurement mode
      if(measureMode){
        const pt={x:snap(mm.x),y:snap(mm.y)};
        if(measurePts.length===0){setMeasurePts([pt])}
        else if(measurePts.length===1){
          const p0=measurePts[0];const dist=Math.sqrt((pt.x-p0.x)**2+(pt.y-p0.y)**2);
          setMeasures(m=>[...m,{p0,p1:pt,dist:Math.round(dist),id:Date.now()}]);setMeasurePts([]);
        }
        return;
      }
      if(modeDraw&&az.L){const x=clamp(snap(mm.x),0,az.L-100),y=clamp(snap(mm.y),0,az.H-100);setDrawRect({x,y,sx:x,sy:y,w:0,h:0});return}
      if(mergeSrc)return;
      if(excludeMode)return;// In exclude mode — panel onClick will handle
      const mm2=toMm(e.clientX,e.clientY);
      const inZone=az&&mm2.x>=0&&mm2.x<=az.L&&mm2.y>=0&&mm2.y<=az.H;
      if(inZone){if(!e.shiftKey&&!(e.ctrlKey||e.metaKey)){setSelIds(new Set());setSelId(null);}if(!(e.ctrlKey||e.metaKey)){setLasso({sx:mm2.x,sy:mm2.y,x:mm2.x,y:mm2.y,w:0,h:0});}}
      setIsPanning({sx:e.clientX,sy:e.clientY,px:pan.x,py:pan.y});
    }
  };

  const handleZoneDragStart=(e,idx)=>{e.stopPropagation();
    const sv=s2svg(e.clientX,e.clientY);
    setDragZone({idx,startX:sv.x,startY:sv.y,origX:zones[idx].facOrigin.x,origY:zones[idx].facOrigin.y});
  };

  const handleOuvDown=(e,o,act='move')=>{e.stopPropagation();if(modeDraw||step!=='work'||!az)return;
    if((e.shiftKey||(e.ctrlKey||e.metaKey))&&act==='move'){setSelIds(prev=>{const n=new Set(prev);n.has(o.id)?n.delete(o.id):n.add(o.id);return n});setSelId(null);return;}
    const inGroup=selIds.has(o.id)&&selIds.size>0;
    if(!inGroup){setSelId(o.id);setSelIds(new Set());}
    const mm=toMm(e.clientX,e.clientY);
    if(inGroup&&act==='move'){
      const ids=new Set(selIds);ids.add(o.id);
      const origs={};az.ouvs.forEach(v=>{if(ids.has(v.id))origs[v.id]={...v}});
      setIsPanning({type:'move-group',ids,sx:mm.x,sy:mm.y,origs});
    }else{setIsPanning({type:act,id:o.id,sx:mm.x,sy:mm.y,orig:{...o}});}
  };

  const handleMove=e=>{
    if(dragZone){const sv=s2svg(e.clientX,e.clientY);const dx=sv.x-dragZone.startX,dy=sv.y-dragZone.startY;
      updateZone(dragZone.idx,z=>({...z,facOrigin:{x:dragZone.origX+dx,y:dragZone.origY+dy}}));return;}
    if(resizeZone){
      const sc=mmPerPx||(1/manualScale);const ppm=mmPerPx?(1/mmPerPx):manualScale;
      const dx=(e.clientX-resizeZone.startX)/zoom,dy=(e.clientY-resizeZone.startY)/zoom;
      const dmx=dx*sc,dmy=dy*sc;const h=resizeZone.handle;
      updateZone(resizeZone.idx,z=>{
        let L=resizeZone.origL,H=resizeZone.origH,ox=resizeZone.origOrigin.x,oy=resizeZone.origOrigin.y;
        if(h.includes('e'))L=Math.max(500,Math.round((resizeZone.origL+dmx)/50)*50);
        if(h.includes('w')){const dL=Math.round(dmx/50)*50;L=Math.max(500,resizeZone.origL-dL);ox=resizeZone.origOrigin.x+dL*ppm;}
        if(h.includes('s'))H=Math.max(500,Math.round((resizeZone.origH+dmy)/50)*50);
        if(h.includes('n')){const dH=Math.round(dmy/50)*50;H=Math.max(500,resizeZone.origH-dH);oy=resizeZone.origOrigin.y+dH*ppm;}
        return{...z,L,H,facOrigin:{x:ox,y:oy}};
      });return;}
    if(rotateZone){
      const rect=cvRef.current.getBoundingClientRect();
      const z=zones[rotateZone.idx];const ppm=mmPerPx?(1/mmPerPx):manualScale;
      const cx=z.facOrigin.x*zoom+pan.x+z.L*ppm*zoom/2;
      const cy=z.facOrigin.y*zoom+pan.y+z.H*ppm*zoom/2;
      const angle=Math.atan2(e.clientY-rect.top-cy,e.clientX-rect.left-cx)*180/Math.PI;
      const delta=angle-rotateZone.startAngle;
      const newRot=Math.round((rotateZone.origRot+delta)*2)/2;// snap 0.5°
      updateZone(rotateZone.idx,z=>({...z,rot:clamp(newRot,-90,90)}));return;}
    if(step==='zone'&&zoneStart){const sv=s2svg(e.clientX,e.clientY);setZoneCur({x:sv.x,y:sv.y});return}
    if(step!=='work'||!az)return;
    if(drawRect){const mm=toMm(e.clientX,e.clientY);const x=clamp(snap(mm.x),0,az.L),y=clamp(snap(mm.y),0,az.H);
      setDrawRect(d=>({...d,x:Math.min(d.sx,x),y:Math.min(d.sy,y),w:Math.abs(x-d.sx),h:Math.abs(y-d.sy)}));return}
    if(!isPanning)return;
    if(!isPanning.type){
      if(lasso&&az){const m2=toMm(e.clientX,e.clientY);setLasso(l=>({...l,x:Math.min(l.sx,m2.x),y:Math.min(l.sy,m2.y),w:Math.abs(m2.x-l.sx),h:Math.abs(m2.y-l.sy)}));}
      else{const np={x:isPanning.px+(e.clientX-isPanning.sx),y:isPanning.py+(e.clientY-isPanning.sy)};setPan(np);if(az)saveView(az.id,zoom,np);}
      return}
    const mm=toMm(e.clientX,e.clientY);
    if(isPanning.type==='move'){const dx=mm.x-isPanning.sx,dy=mm.y-isPanning.sy,o=isPanning.orig;
      let nx=clamp(snap(o.x+dx),0,az.L-o.w),ny=clamp(snap(o.y+dy),0,az.H-o.h);
      // Soft snap to grid lines (within 30mm threshold)
      if(C){const thr=30;
        C.baseXBounds.forEach(b=>{const bm=Math.round(b*1000);if(Math.abs(nx-bm)<thr)nx=bm;if(Math.abs(nx+o.w-bm)<thr)nx=bm-o.w});
        C.baseYBounds.forEach(b=>{const bm=Math.round(b*1000);if(Math.abs(ny-bm)<thr)ny=bm;if(Math.abs(ny+o.h-bm)<thr)ny=bm-o.h});}
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>v.id===isPanning.id?{...v,x:clamp(nx,0,z.L-o.w),y:clamp(ny,0,z.H-o.h)}:v)}));return}
    if(isPanning.type==='move-group'){const dx=snap(mm.x-isPanning.sx),dy=snap(mm.y-isPanning.sy);
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>isPanning.ids.has(v.id)?{...v,x:clamp((isPanning.origs[v.id]?.x||v.x)+dx,0,z.L-v.w),y:clamp((isPanning.origs[v.id]?.y||v.y)+dy,0,z.H-v.h)}:v)}));return}
    if(isPanning.type?.startsWith('r-')){const dir=isPanning.type.slice(2),dx=mm.x-isPanning.sx,dy=mm.y-isPanning.sy,o=isPanning.orig;
      let x=o.x,y=o.y,w=o.w,h=o.h;
      if(dir.includes('w')){x=o.x+dx;w=o.w-dx}if(dir.includes('e'))w=o.w+dx;
      if(dir.includes('n')){y=o.y+dy;h=o.h-dy}if(dir.includes('s'))h=o.h+dy;
      if(w<200){if(dir.includes('w'))x=o.x+o.w-200;w=200}if(h<200){if(dir.includes('n'))y=o.y+o.h-200;h=200}
      x=clamp(snap(x),0,az.L-200);y=clamp(snap(y),0,az.H-200);w=snap(clamp(w,200,az.L-x));h=snap(clamp(h,200,az.H-y));
      updateAZ(z=>({...z,ouvs:z.ouvs.map(v=>v.id===isPanning.id?{...v,x,y,w,h}:v)}));}
  };

  const handleUp=()=>{
    if(dragZone){setDragZone(null);return}
    if(resizeZone){setResizeZone(null);return}
    if(rotateZone){setRotateZone(null);return}
    if(step==='zone'&&!polyMode&&zoneStart&&zoneCur){
      const sc=mmPerPx||(1/manualScale);const x1=Math.min(zoneStart.x,zoneCur.x),y1=Math.min(zoneStart.y,zoneCur.y);
      const x2=Math.max(zoneStart.x,zoneCur.x),y2=Math.max(zoneStart.y,zoneCur.y);const wPx=x2-x1,hPx=y2-y1;
      const wScreen=wPx*zoom,hScreen=hPx*zoom;
      if(wScreen>25&&hScreen>25){const wMm=Math.max(500,Math.round(wPx*sc/50)*50),hMm=Math.max(500,Math.round(hPx*sc/50)*50);
        const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,L:wMm,H:hMm,facOrigin:{x:x1,y:y1},poly:null,
          pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]};
        setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);}
      setZoneStart(null);setZoneCur(null);return;}
    if(drawRect&&drawRect.w>=200&&drawRect.h>=200&&az){const nO={id:Date.now(),t:'Menuiserie',x:drawRect.x,y:drawRect.y,w:drawRect.w,h:drawRect.h};
      updateAZ(z=>({...z,ouvs:[...z.ouvs,nO]}));setSelId(nO.id);setModeDraw(false);}
    if(lasso&&az&&lasso.w>20&&lasso.h>20){
      const hit=az.ouvs.filter(o=>o.x>=lasso.x&&o.y>=lasso.y&&o.x+o.w<=lasso.x+lasso.w&&o.y+o.h<=lasso.y+lasso.h);
      if(hit.length>0){setSelIds(new Set(hit.map(o=>o.id)));setSelId(null);}
    }
    setLasso(null);setDrawRect(null);setIsPanning(null);setZoneStart(null);setZoneCur(null);
  };

  const confirmCal=()=>{if(calPts.length<2)return;const dx=calPts[1].x-calPts[0].x,dy=calPts[1].y-calPts[0].y;const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>0&&calMm>0){setMmPerPx(calMm/dist);setStep('zone')}setCalModal(false)};
  const loadProjectFile=useRef();
  const startManual=()=>{setZones([{id:Date.now(),name:'Zone 1',L:12000,H:8000,facOrigin:{x:100,y:100},poly:null,
    pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]}]);setActiveZoneIdx(0);setStep('work');setTimeout(autoFit,150)};
  const goToWork=()=>{if(zones.length>0){setActiveZoneIdx(0);setStep('work');setTimeout(autoFit,150)}};
  const addPOuv=p=>{if(!az)return;const x=snap(Math.random()*Math.max(0,az.L-p.w)),y=snap(Math.random()*Math.max(0,az.H-p.h));
    updateAZ(z=>({...z,ouvs:[...z.ouvs,{id:Date.now(),t:p.t,x,y,w:p.w,h:p.h}]}))};

  const runOptimize=()=>{if(!az)return;const r=optimizeLayout({...az,fix});setOptResults(r);setOptMod(true)};
  const applyOpt=opt=>{updateAZ(z=>({...z,vert:opt.vert,offX:opt.offX,offY:opt.offY}));setOptMod(false)};

  /* ── EXPORT ALL ZONES PNG ── */
  // ── PROJECT SAVE / LOAD ──
  const saveProject=()=>{
    const data={v:15,name:projectName,zones,activeZoneIdx,ralIdx,
      bgSrc:null,mmPerPx,manualScale:0.06,savedAt:new Date().toISOString()};
    // Don't save bgSrc if it's a large data URL — just save calibration
    const json=JSON.stringify(data,null,2);
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;
    a.download=`Kalepin_${projectName.replace(/\W/g,'_')}_${new Date().toISOString().slice(0,10)}.json`;
    a.click();URL.revokeObjectURL(url);
  };
  const exportExcel=(selIdxs)=>{
    if(typeof XLSX==='undefined'){alert('SheetJS non chargé, réessayez dans quelques secondes.');return;}
    const selZones=selIdxs&&selIdxs.length>0
      ? selIdxs.map(i=>({z:zones[i],calc:allCalcs[i],i})).filter(r=>r.z&&r.calc)
      : zones.map((z,i)=>({z,calc:allCalcs[i],i})).filter(r=>r.calc);
    const wb=XLSX.utils.book_new();
    const date=new Date().toLocaleDateString('fr-FR');

    const HDR={fill:{fgColor:{rgb:'5A1020'}},font:{bold:true,color:{rgb:'FFFFFF'},sz:10,name:'Arial'},alignment:{horizontal:'center',vertical:'center',wrapText:true},border:{bottom:{style:'medium',color:{rgb:'8B1A2B'}}}};
    const TITLE={fill:{fgColor:{rgb:'3D0A13'}},font:{bold:true,color:{rgb:'FFFFFF'},sz:13,name:'Arial'},alignment:{horizontal:'center',vertical:'center'}};
    const TOT={fill:{fgColor:{rgb:'F0E4D0'}},font:{bold:true,sz:10,name:'Consolas',color:{rgb:'5A1020'}},alignment:{horizontal:'center',vertical:'center'},border:{top:{style:'medium',color:{rgb:'C4A882'}},bottom:{style:'medium',color:{rgb:'C4A882'}}}};
    const SUB={fill:{fgColor:{rgb:'F5EDE0'}},font:{bold:true,sz:9,name:'Arial'},alignment:{horizontal:'center',vertical:'center'},border:{bottom:{style:'thin',color:{rgb:'C4A882'}}}};
    const merge=(ws,rs)=>{ws['!merges']=(ws['!merges']||[]).concat(rs.map(r=>XLSX.utils.decode_range(r)))};
    const rh=(h)=>({hpt:h});

    // ONGLET 1 — BON DE COMMANDE CONSOLIDÉ
    {
      const globalDims={};
      selZones.forEach(({z,calc})=>{
        (calc.activePanels||calc.panelMap||[]).filter(p=>!p.isVoid&&!p.isExcluded).forEach(p=>{
          const pw=Math.round(p.pWa*1000),ph=Math.round(p.pHa*1000);
          const k=pw+'x'+ph;
          if(!globalDims[k])globalDims[k]={l:pw,h:ph,qty:0,surf:0};
          globalDims[k].qty++;globalDims[k].surf+=pw*ph/1e6;
        });
      });
      const rows=Object.entries(globalDims).sort((a,b)=>b[1].qty-a[1].qty);
      const totQty=rows.reduce((a,[,d])=>a+d.qty,0);
      const totSurf=rows.reduce((a,[,d])=>a+d.surf,0);
      const data=[];
      data.push([{v:'MÉTRÉS — PANNEAUX DE BARDAGE',t:'s',s:TITLE},...Array(5).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:'Projet : '+projectName+'   |   Édition : '+date+'   |   '+rows.length+' dimensions   |   '+totQty+' panneaux',t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(5).fill({v:'',t:'s'})]);
      data.push([{v:'',t:'s'},...Array(5).fill({v:'',t:'s'})]);
      data.push([
        {v:'Réf. Panneau',t:'s',s:HDR},{v:'Longueur\n(mm)',t:'s',s:HDR},{v:'Largeur\n(mm)',t:'s',s:HDR},
        {v:'Surface\nunit. (m²)',t:'s',s:HDR},{v:'Quantité',t:'s',s:HDR},{v:'Surface\ntotale (m²)',t:'s',s:HDR}
      ]);
      rows.forEach(([k,d],i)=>{
        const alt=i%2===0;const bg=alt?{rgb:'FFF8F0'}:{rgb:'FFFFFF'};
        const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
        data.push([
          {v:'P '+d.l+'x'+d.h,t:'s',s:{...s,font:{...s.font,bold:true}}},
          {v:d.l,t:'n',s},{v:d.h,t:'n',s},
          {v:Math.round(d.l*d.h/1e6*10000)/10000,t:'n',s:{...s,numFmt:'0.0000'}},
          {v:d.qty,t:'n',s:{...s,font:{...s.font,bold:true,color:{rgb:'8B1A2B'}}}},
          {v:Math.round(d.surf*100)/100,t:'n',s:{...s,numFmt:'0.00',font:{...s.font,bold:true}}}
        ]);
      });
      data.push([
        {v:'TOTAL',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},
        {v:totQty,t:'n',s:{...TOT,numFmt:'0'}},
        {v:Math.round(totSurf*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
      ]);
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:F1','A2:F2','A3:F3']);
      ws['!cols']=[{wch:18},{wch:12},{wch:12},{wch:16},{wch:12},{wch:16}];
      ws['!rows']=[rh(28),rh(16),rh(6),rh(28),...rows.map(()=>rh(20)),rh(22)];
      XLSX.utils.book_append_sheet(wb,ws,'Metres');
    }

    // ONGLET 2 — DÉTAIL PAR ZONE
    {
      const data=[];
      data.push([{v:'DETAIL PAR ZONE — DIMENSIONS ET QUANTITES',t:'s',s:TITLE},...Array(4).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(4).fill({v:'',t:'s'})]);
      const rowHeights=[rh(28),rh(14)];
      selZones.forEach(({z,calc})=>{
        const pans=(calc.activePanels||calc.panelMap||[]).filter(p=>!p.isVoid&&!p.isExcluded);
        const dm={};pans.forEach(p=>{
          const k=Math.round(p.pWa*1000)+'x'+Math.round(p.pHa*1000);dm[k]=(dm[k]||0)+1;
        });
        const dimRows=Object.entries(dm).sort((a,b)=>b[1]-a[1]);
        data.push([{v:'',t:'s'},...Array(4).fill({v:'',t:'s'})]);rowHeights.push(rh(6));
        data.push([
          {v:'▶  '+z.name+'   ('+( z.L/1000).toFixed(2)+' x '+(z.H/1000).toFixed(2)+' m)   —   Panneau type : '+(z.pan_.nom||z.pan_.l+'x'+z.pan_.w)+' mm',
           t:'s',s:{fill:{fgColor:{rgb:'F2E8DE'}},font:{bold:true,sz:10,color:{rgb:'5A1020'},name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
          ...Array(4).fill({v:'',t:'s',s:{fill:{fgColor:{rgb:'F2E8DE'}}}})
        ]);rowHeights.push(rh(22));
        data.push([
          {v:'Dimensions (mm)',t:'s',s:SUB},{v:'Longueur (mm)',t:'s',s:SUB},{v:'Largeur (mm)',t:'s',s:SUB},
          {v:'Quantite',t:'s',s:SUB},{v:'Surface totale (m2)',t:'s',s:SUB}
        ]);rowHeights.push(rh(18));
        dimRows.forEach(([d,q],i)=>{
          const parts=d.split('x');const dw=Number(parts[0]),dh=Number(parts[1]);
          const alt=i%2===0;const bg={rgb:alt?'FFF5EE':'FFFFFF'};
          const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
          data.push([
            {v:d,t:'s',s:{...s,font:{...s.font,bold:true}}},
            {v:dw,t:'n',s},{v:dh,t:'n',s},
            {v:q,t:'n',s:{...s,font:{...s.font,bold:true,color:{rgb:'8B1A2B'}}}},
            {v:Math.round(dw*dh/1e6*q*100)/100,t:'n',s:{...s,numFmt:'0.00'}}
          ]);rowHeights.push(rh(18));
        });
        const totZ=pans.length;const surfZ=pans.reduce((a,p)=>a+Math.round(p.pWa*1000)*Math.round(p.pHa*1000)/1e6,0);
        data.push([
          {v:'Total zone',t:'s',s:TOT},{v:'',t:'s',s:TOT},{v:'',t:'s',s:TOT},
          {v:totZ,t:'n',s:{...TOT,numFmt:'0'}},
          {v:Math.round(surfZ*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
        ]);rowHeights.push(rh(20));
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:E1','A2:E2']);
      ws['!cols']=[{wch:18},{wch:14},{wch:14},{wch:12},{wch:18}];
      ws['!rows']=rowHeights;
      XLSX.utils.book_append_sheet(wb,ws,'Detail par zone');
    }

    // ONGLET 3 — METRÉS
    {
      const data=[];
      data.push([{v:'RECAPITULATIF METRES',t:'s',s:TITLE},...Array(7).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(7).fill({v:'',t:'s'})]);
      data.push([{v:'',t:'s'},...Array(7).fill({v:'',t:'s'})]);
      data.push([
        {v:'Zone',t:'s',s:HDR},{v:'L x H (m)',t:'s',s:HDR},{v:'S. brute (m2)',t:'s',s:HDR},
        {v:'S. ouvert. (m2)',t:'s',s:HDR},{v:'S. nette (m2)',t:'s',s:HDR},
        {v:'Panneaux',t:'s',s:HDR},{v:'Chutes (%)',t:'s',s:HDR},{v:'Ossature (ml)',t:'s',s:HDR}
      ]);
      let tBr=0,tOuv=0,tNet=0,tP=0,tOss=0;
      selZones.forEach(({z,calc})=>{
        tBr+=calc.sBr||0;tOuv+=calc.sOuv||0;tNet+=calc.sNet||0;tP+=calc.nP||0;tOss+=calc.tOss||0;
        const alt=i%2===0;const bg={rgb:alt?'FFF8F0':'FFFFFF'};
        const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
        data.push([
          {v:z.name,t:'s',s:{...s,font:{...s.font,bold:true,name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
          {v:(z.L/1000).toFixed(2)+' x '+(z.H/1000).toFixed(2),t:'s',s},
          {v:Math.round((calc.sBr||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}},
          {v:Math.round((calc.sOuv||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}},
          {v:Math.round((calc.sNet||0)*100)/100,t:'n',s:{...s,numFmt:'0.00',font:{...s.font,bold:true}}},
          {v:calc.nP||0,t:'n',s},
          {v:Math.round((calc.chut||0)*10)/10,t:'n',s:{...s,numFmt:'0.0',fill:{fgColor:{rgb:(calc.chut||0)>15?'FEF0F0':alt?'FFF8F0':'FFFFFF'}}}},
          {v:Math.round((calc.tOss||0)*100)/100,t:'n',s:{...s,numFmt:'0.00'}}
        ]);
      });
      data.push([
        {v:'TOTAL',t:'s',s:TOT},{v:'',t:'s',s:TOT},
        {v:Math.round(tBr*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}},
        {v:Math.round(tOuv*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}},
        {v:Math.round(tNet*100)/100,t:'n',s:{...TOT,numFmt:'0.00',font:{...TOT.font,color:{rgb:'8B1A2B'},sz:11}}},
        {v:tP,t:'n',s:{...TOT,numFmt:'0'}},{v:'',t:'s',s:TOT},
        {v:Math.round(tOss*100)/100,t:'n',s:{...TOT,numFmt:'0.00'}}
      ]);
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:H1','A2:H2','A3:H3']);
      ws['!cols']=[{wch:16},{wch:14},{wch:13},{wch:14},{wch:13},{wch:10},{wch:11},{wch:13}];
      ws['!rows']=[rh(28),rh(14),rh(6),rh(26),...selZones.map(()=>rh(20)),rh(22)];
      XLSX.utils.book_append_sheet(wb,ws,'Recap surfaces');
    }

    // ONGLET 4 — OUVERTURES
    if(selZones.some(({z})=>z.ouvs?.length>0)){
      const data=[];
      data.push([{v:'OUVERTURES ET ENCADREMENTS',t:'s',s:TITLE},...Array(8).fill({v:'',t:'s',s:TITLE})]);
      data.push([{v:projectName+'   |   '+date,t:'s',s:{font:{italic:true,sz:9,color:{rgb:'888888'},name:'Arial'},alignment:{horizontal:'center'}}},...Array(8).fill({v:'',t:'s'})]);
      const rhs=[rh(28),rh(14)];
      selZones.forEach(({z,calc})=>{
        if(!z.ouvs?.length)return;
        data.push([{v:'',t:'s'},...Array(8).fill({v:'',t:'s'})]);rhs.push(rh(6));
        data.push([{v:'▶  '+z.name,t:'s',s:{fill:{fgColor:{rgb:'FFF0F2'}},font:{bold:true,sz:10,color:{rgb:'BE123C'},name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},...Array(8).fill({v:'',t:'s',s:{fill:{fgColor:{rgb:'FFF0F2'}}}})]);rhs.push(rh(20));
        data.push([
          {v:'N°',t:'s',s:HDR},{v:'Type',t:'s',s:HDR},{v:'Largeur (mm)',t:'s',s:HDR},{v:'Hauteur (mm)',t:'s',s:HDR},
          {v:'Surface (m2)',t:'s',s:HDR},{v:'Tableau G (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'6B2030'}}}},
          {v:'Tableau D (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'6B2030'}}}},
          {v:'Linteau (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'4A1A25'}}}},{v:'Appui (ml)',t:'s',s:{...HDR,fill:{fgColor:{rgb:'4A1A25'}}}}
        ]);rhs.push(rh(26));
        z.ouvs.forEach((o,i)=>{
          const m=calc?.menuDet?.find(md=>md.id===o.id);
          const alt=i%2===0;const bg={rgb:alt?'FFF8FA':'FFFFFF'};
          const s={fill:{fgColor:bg},font:{name:'Consolas',sz:10},alignment:{horizontal:'center',vertical:'center'}};
          data.push([
            {v:'O'+(i+1),t:'s',s:{...s,font:{...s.font,bold:true,color:{rgb:'BE123C'}}}},
            {v:o.t||'Menuiserie',t:'s',s:{...s,font:{...s.font,name:'Arial'},alignment:{horizontal:'left',vertical:'center'}}},
            {v:o.w,t:'n',s},{v:o.h,t:'n',s},
            {v:Math.round(o.w*o.h/1e6*10000)/10000,t:'n',s:{...s,numFmt:'0.0000'}},
            m?{v:Math.round(m.tableauG*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.tableauD*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.linteau*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s},
            m?{v:Math.round(m.appui*1000)/1000,t:'n',s:{...s,numFmt:'0.000'}}:{v:'-',t:'s',s}
          ]);rhs.push(rh(18));
        });
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      merge(ws,['A1:I1','A2:I2']);
      ws['!cols']=[{wch:6},{wch:16},{wch:12},{wch:12},{wch:12},{wch:13},{wch:13},{wch:12},{wch:11}];
      ws['!rows']=rhs;
      XLSX.utils.book_append_sheet(wb,ws,'Ouvertures');
    }

    XLSX.writeFile(wb,'Kalepin_'+projectName.replace(/\W+/g,'_')+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
  };
  const exportCSV=exportExcel;
  const loadProject=(file)=>{
    const reader=new FileReader();reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.zones||!Array.isArray(data.zones)){alert('Fichier projet invalide');return}
        setProjectName(data.name||'Projet');
        setZones(data.zones);
        setActiveZoneIdx(data.activeZoneIdx||0);
        if(data.ralIdx!=null)setRalIdx(data.ralIdx);
        if(data.mmPerPx)setMmPerPx(data.mmPerPx);
        setStep('work');
        setTimeout(autoFit,200);
        alert('Projet chargé: '+data.zones.length+' zone(s)');
      }catch(e){alert('Erreur lecture fichier: '+e.message)}
    };reader.readAsText(file);
  };

  const exportAllZones=async()=>{
    const now=new Date();const dateStr=now.toLocaleDateString('fr-FR');
    const W=2800,mg=50;

    for(let zi=0;zi<zones.length;zi++){
      const z=zones[zi];const zC=allCalcs[zi];if(!zC)continue;
      const zColor=ZONE_COLORS[zi%ZONE_COLORS.length];
      const panLabel=z.pan_.nom||`${z.pan_.l}x${z.pan_.w}`;
      const planAreaW=W-mg*2-380;const planH=520;
      const fAsp=z.L/z.H;let fW,fH;
      if(fAsp>(planAreaW-40)/(planH-30)){fW=planAreaW-40;fH=fW/fAsp}else{fH=planH-30;fW=fH*fAsp}
      const sc=fW/z.L;
      const encRows=zC.menuDet.length;const impRows=zC.impacts.length;
      const tableStartY=mg+planH+80;
      const totalH=tableStartY+Math.max(encRows,1)*26+80+Math.max(impRows,1)*26+80+120;

      const c=document.createElement('canvas');c.width=W;c.height=totalH;const ctx=c.getContext('2d');
      ctx.fillStyle='#fff';ctx.fillRect(0,0,W,totalH);

      // Header
      ctx.fillStyle='#1e293b';ctx.fillRect(0,0,W,46);
      ctx.fillStyle='#fff';ctx.font='bold 17px "DM Sans",sans-serif';ctx.textAlign='left';ctx.textBaseline='middle';
      ctx.fillText(`${projectName.toUpperCase()}`,mg,23);
      ctx.font='12px "DM Sans",sans-serif';ctx.fillStyle='#94a3b8';ctx.textAlign='right';
      ctx.fillText(`${dateStr} | ${z.name} | ${panLabel} | ${z.vert?'V':'H'}${z.offX||z.offY?` dec.${z.offX}x${z.offY}`:''}`,W-mg,23);

      // ── OVERVIEW THUMBNAIL (top right) ──
      const ovW=180,ovH=120,ovX=W-mg-ovW,ovY=mg+56;
      ctx.strokeStyle='#e2e8f0';ctx.lineWidth=1;ctx.strokeRect(ovX-1,ovY-1,ovW+2,ovH+2);
      ctx.fillStyle='#f8fafc';ctx.fillRect(ovX,ovY,ovW,ovH);
      // Draw bg thumbnail
      if(bgSrc){try{const img=new Image();img.src=bgSrc;
        const ovSc=Math.min(ovW/bgW,ovH/bgH);
        ctx.drawImage(img,ovX+(ovW-bgW*ovSc)/2,ovY+(ovH-bgH*ovSc)/2,bgW*ovSc,bgH*ovSc);}catch(e){}}
      // Draw all zones on overview — relative to background image
      const bgRef_W=bgW||1,bgRef_H=bgH||1;
      const ovSc2=Math.min(ovW/bgRef_W,ovH/bgRef_H);
      const mapOX=ovX+(ovW-bgRef_W*ovSc2)/2,mapOY=ovY+(ovH-bgRef_H*ovSc2)/2;
      zones.forEach((zz,zzi)=>{
        const ppm=pxPerMm_eff||0.06;
        const rx=mapOX+zz.facOrigin.x*ovSc2,ry=mapOY+zz.facOrigin.y*ovSc2;
        const rw=zz.L*ppm*ovSc2,rh=zz.H*ppm*ovSc2;
        const isCur=zzi===zi;
        // Draw zone outline with high precision
        ctx.save();
        if(zz.rot){ctx.translate(rx+rw/2,ry+rh/2);ctx.rotate(zz.rot*Math.PI/180);ctx.translate(-(rx+rw/2),-(ry+rh/2))}
        ctx.fillStyle=isCur?`${ZONE_COLORS[zzi%8]}33`:'rgba(100,100,100,.08)';ctx.fillRect(rx,ry,rw,rh);
        ctx.strokeStyle=isCur?ZONE_COLORS[zzi%8]:'#999';ctx.lineWidth=isCur?2.5:.8;ctx.strokeRect(rx,ry,rw,rh);
        // Show ouvertures on minimap
        if(isCur&&zz.ouvs){
          ctx.fillStyle='rgba(251,113,133,.3)';
          zz.ouvs.forEach(o=>{ctx.fillRect(rx+o.x*ppm*ovSc2,ry+o.y*ppm*ovSc2,o.w*ppm*ovSc2,o.h*ppm*ovSc2)})
        }
        if(rw>12){ctx.fillStyle=isCur?ZONE_COLORS[zzi%8]:'#999';ctx.font=`bold ${Math.min(10,rw/4)}px sans-serif`;ctx.textAlign='left';ctx.textBaseline='top';ctx.fillText(zz.name,rx+2,ry+2)}
        // Dimension labels on minimap
        if(isCur&&rw>30){
          ctx.fillStyle=ZONE_COLORS[zzi%8];ctx.font='bold 7px monospace';ctx.textAlign='center';
          ctx.fillText(`${(zz.L/1000).toFixed(1)}m`,rx+rw/2,ry-3);
          ctx.save();ctx.translate(rx-3,ry+rh/2);ctx.rotate(-Math.PI/2);ctx.fillText(`${(zz.H/1000).toFixed(1)}m`,0,0);ctx.restore();
        }
        ctx.restore();
      });
      ctx.fillStyle='#64748b';ctx.font='9px sans-serif';ctx.textAlign='right';ctx.textBaseline='top';ctx.fillText('REPERAGE',ovX+ovW,ovY-12);

      // ── CALEPINAGE PLAN ──
      const fX=mg+20,fY=mg+56+20;
      // Polygon path or rectangle
      const drawFacadeOutline=(fx,fy,fw,fh,zn,ssc)=>{
        if(zn.poly){
          ctx.beginPath();zn.poly.forEach((p,i)=>{const px=fx+p.x/1000*ssc*1000,py=fy+p.y/1000*ssc*1000;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py)});ctx.closePath();
        }else{ctx.beginPath();ctx.rect(fx,fy,fw,fh)}
      };

      // BG clipped to facade
      if(bgSrc&&mmPerPx){try{const img=new Image();img.src=bgSrc;ctx.save();
        drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.clip();
        ctx.globalAlpha=0.25;ctx.drawImage(img,z.facOrigin.x,z.facOrigin.y,z.L/mmPerPx,z.H/mmPerPx,fX,fY,fW,fH);ctx.globalAlpha=1;ctx.restore();}catch(e){}}

      ctx.strokeStyle='#334155';ctx.lineWidth=2;drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.stroke();

      // Panels (with RAL color + void handling)
      ctx.save();drawFacadeOutline(fX,fY,fW,fH,z,sc);ctx.clip();
      const ralHex=RAL_COLORS[ralIdx]?.hex||'#383E42';
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*1000*sc,py=fY+pm.pTop*1000*sc,pw2=pm.pWa*1000*sc,ph2=pm.pHa*1000*sc;
        if(pm.isVoid){ctx.fillStyle='rgba(0,0,0,.2)';ctx.fillRect(px,py,pw2,ph2);return}
        ctx.fillStyle=ralHex;ctx.globalAlpha=0.88;ctx.fillRect(px+.5,py+.5,pw2-1,ph2-1);ctx.globalAlpha=1;
        ctx.strokeStyle=pm.isImpacted?'rgba(251,191,36,.7)':'rgba(255,255,255,.15)';ctx.lineWidth=pm.isImpacted?1.2:.4;ctx.strokeRect(px+.5,py+.5,pw2-1,ph2-1);
        if(pw2>16&&ph2>10){ctx.fillStyle='rgba(255,255,255,.6)';ctx.font=`bold ${Math.min(8,pw2/5)}px monospace`;ctx.textAlign='center';ctx.textBaseline='middle';
          ctx.fillText(pm.subRef,px+pw2/2,py+ph2/2)}
      });
      // Joint gaps (using base grid bounds)
      const merges=z.merges||[];
      if(zC.jGapsH&&zC.baseXBounds){ctx.fillStyle='rgba(251,191,36,.12)';
        zC.baseXBounds.slice(1,-1).forEach((bx,i)=>{
          // Check if this joint is inside a merged panel
          const isInsideMerge=merges.some(m=>i>=m.c1 && i<m.c2);
          if(isInsideMerge)return;  // Skip this joint
          const gw=(zC.jGapsH[i]||0)/1000*1000*sc;const gx=fX+bx*1000*sc;
          if(gw>0.3)ctx.fillRect(gx,fY,Math.max(gw,0.5),fH)});
      }
      if(zC.jGapsV&&zC.baseYBounds){ctx.fillStyle='rgba(251,191,36,.12)';
        zC.baseYBounds.slice(1,-1).forEach((by,i)=>{
          // Check if this joint is inside a merged panel
          const isInsideMerge=merges.some(m=>i>=m.r1 && i<m.r2);
          if(isInsideMerge)return;  // Skip this joint
          const gh=(zC.jGapsV[i]||0)/1000*1000*sc;const gy=fY+by*1000*sc;
          if(gh>0.3)ctx.fillRect(fX,gy,fW,Math.max(gh,0.5))});
      }
      // Montants/lisses
      ctx.lineWidth=.8;ctx.setLineDash([4,3]);
      // Montants interrupted around openings
      ctx.strokeStyle='rgba(200,110,0,.3)';
      for(let i=0;i<=zC.nM&&i<400;i++){const mx=fX+i*z.oss.eM*sc;if(mx>fX+fW)break;
        let segs=[{y1:fY,y2:fY+fH}];const mxMm=i*z.oss.eM;
        z.ouvs.forEach(o=>{if(mxMm<o.x+1||mxMm>o.x+o.w-1)return;
          const ns=[];segs.forEach(s=>{const oT=fY+o.y*sc,oB=fY+(o.y+o.h)*sc;
            if(oT>=s.y2||oB<=s.y1){ns.push(s);return}
            if(s.y1<oT)ns.push({y1:s.y1,y2:oT});if(oB<s.y2)ns.push({y1:oB,y2:s.y2});});segs=ns;});
        segs.forEach(s=>{ctx.beginPath();ctx.moveTo(mx,s.y1);ctx.lineTo(mx,s.y2);ctx.stroke()});}
      // Lisses interrupted
      ctx.strokeStyle='rgba(16,175,120,.3)';
      for(let i=0;i<=zC.nL&&i<200;i++){const ly=fY+i*z.oss.eL*sc;if(ly>fY+fH)break;
        let segs=[{x1:fX,x2:fX+fW}];const lyMm=i*z.oss.eL;
        z.ouvs.forEach(o=>{if(lyMm<o.y+1||lyMm>o.y+o.h-1)return;
          const ns=[];segs.forEach(s=>{const oL=fX+o.x*sc,oR=fX+(o.x+o.w)*sc;
            if(oL>=s.x2||oR<=s.x1){ns.push(s);return}
            if(s.x1<oL)ns.push({x1:s.x1,x2:oL});if(oR<s.x2)ns.push({x1:oR,x2:s.x2});});segs=ns;});
        segs.forEach(s=>{ctx.beginPath();ctx.moveTo(s.x1,ly);ctx.lineTo(s.x2,ly);ctx.stroke()});}
      ctx.setLineDash([]);
      // Ouvertures with cut dimensions
      z.ouvs.forEach((o,oi)=>{
        const ox=fX+o.x*sc,oy=fY+o.y*sc,ow=o.w*sc,oh=o.h*sc;
        ctx.fillStyle='rgba(255,200,210,.3)';ctx.fillRect(ox,oy,ow,oh);ctx.strokeStyle='#d21e40';ctx.lineWidth=1.5;ctx.strokeRect(ox,oy,ow,oh);
        ctx.strokeStyle='rgba(210,30,60,.1)';ctx.lineWidth=.4;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(ox+ow,oy+oh);ctx.stroke();
        ctx.beginPath();ctx.moveTo(ox+ow,oy);ctx.lineTo(ox,oy+oh);ctx.stroke();
        if(ow>30){ctx.fillStyle='#be123c';ctx.font=`bold ${Math.min(10,ow/6)}px monospace`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(`O${oi+1}`,ox+ow/2,oy+oh/2-6);
          ctx.font=`${Math.min(8,ow/8)}px monospace`;ctx.fillText(`${o.w}x${o.h}`,ox+ow/2,oy+oh/2+6)}
      });
      ctx.restore();

      // Dimensions
      ctx.fillStyle='#1e293b';ctx.font='bold 12px monospace';ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText(`${(z.L/1000).toFixed(2)} m`,fX+fW/2,fY-6);
      ctx.save();ctx.translate(fX-14,fY+fH/2);ctx.rotate(-Math.PI/2);ctx.textBaseline='middle';ctx.fillText(`${(z.H/1000).toFixed(2)} m`,0,0);ctx.restore();

      // ── QUANTITATIF SIDEBAR ──
      const rX=ovX-200,rW=190;let ry=mg+56;
      const sRow=(lb,val,bold,color)=>{ctx.font=bold?'bold 11px sans-serif':'10px sans-serif';ctx.fillStyle=bold?(color||'#1e293b'):'#64748b';ctx.textAlign='left';ctx.fillText(lb,rX,ry);
        ctx.font=bold?'bold 12px monospace':'11px monospace';ctx.fillStyle=bold?(color||'#1e293b'):'#334155';ctx.textAlign='right';ctx.fillText(val,rX+rW,ry);ry+=bold?19:15};
      const sHead=(lb,color)=>{ctx.fillStyle=color;ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText(lb.toUpperCase(),rX,ry);ry+=14};
      sHead('Surfaces','#3b82f6');sRow('Brute',zC.sBr.toFixed(2)+' m2');sRow('Ouvertures','-'+zC.sOuv.toFixed(2)+' m2');sRow('Nette',zC.sNet.toFixed(2)+' m2',true,'#3b82f6');ry+=6;
      sHead('Panneaux','#8b5cf6');sRow('Total',zC.nP+' u',true);sRow('Impactes',zC.pImp+' u');sRow('Chutes',zC.chut.toFixed(1)+' %');ry+=6;
      sHead('Ossature','#d97706');sRow('Montants',zC.lMN.toFixed(1)+' ml');sRow('Lisses',zC.lLN.toFixed(1)+' ml');sRow('Total',zC.tOss.toFixed(1)+' ml',true);ry+=6;
      sHead('Encadrements','#0891b2');sRow('Tableaux',zC.totEnc.tab.toFixed(2)+' ml');sRow('Linteaux',zC.totEnc.lin.toFixed(2)+' ml');
      sRow('Appuis',zC.totEnc.app.toFixed(2)+' ml');sRow('Total encadr.',zC.totEnc.tot.toFixed(2)+' ml',true);ry+=6;
      if(zC.totCassettes&&zC.totCassettes.pliees>0){
        sHead('Cassettes pliées','#7c3aed');sRow('Nombre',zC.totCassettes.pliees+' pcs');
        sRow('Surface',zC.totCassettes.surfTot.toFixed(2)+' m²');sRow('ML total',zC.totCassettes.mlTot.toFixed(2)+' ml',true);ry+=6;
      }
      sHead('Fixations','#6b7280');sRow('Fixations',zC.tFix+' u');sRow('Equerres',zC.tEq+' u');

      // ── TABLE: ENCADREMENTS ──
      let ty=tableStartY;const tW=W-mg*2;
      ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';ctx.textBaseline='top';
      ctx.fillText('ENCADREMENTS MENUISERIES',mg,ty);ty+=22;
      const eH=['N','Type','L(mm)','H(mm)','Tab.G','Tab.D','Lint.','Appui','Total','Pan.imp.'];
      ctx.fillStyle='#f1f5f9';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#334155';ctx.font='bold 9px sans-serif';
      eH.forEach((h,i)=>{ctx.textAlign=i===0?'center':i>=9?'left':'right';ctx.fillText(h,mg+i*tW/10+tW/20,ty+8)});ty+=22;
      zC.menuDet.forEach((m,ri)=>{if(ri%2===0){ctx.fillStyle='#f8fafc';ctx.fillRect(mg,ty,tW,22)}
        const vals=[`O${ri+1}`,m.t,String(m.w),String(m.h),m.tableauG.toFixed(3),m.tableauD.toFixed(3),m.linteau.toFixed(3),m.appui.toFixed(3),m.encTotal.toFixed(3),m.impPanels.join(',')];
        ctx.font='10px monospace';vals.forEach((v,i)=>{ctx.fillStyle=i===8?'#059669':'#334155';ctx.textAlign=i===0?'center':i>=9?'left':'right';ctx.fillText(v,mg+i*tW/10+tW/20,ty+8)});
        ctx.strokeStyle='#e2e8f0';ctx.lineWidth=.3;ctx.beginPath();ctx.moveTo(mg,ty+22);ctx.lineTo(mg+tW,ty+22);ctx.stroke();ty+=22});
      // Total row
      ctx.fillStyle='#ecfdf5';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#059669';ctx.font='bold 10px sans-serif';ctx.textAlign='left';ctx.fillText('TOTAL',mg+10,ty+8);
      ctx.font='bold 11px monospace';ctx.textAlign='right';ctx.fillText(zC.totEnc.tot.toFixed(2)+' ml',mg+tW-10,ty+8);ty+=34;

      // ── TABLE: DECOUPE ──
      ctx.fillStyle='#1e293b';ctx.font='bold 13px sans-serif';ctx.textAlign='left';ctx.fillText('PANNEAUX IMPACTES — DECOUPE',mg,ty);ty+=22;
      const dH=['Ref','Ouv.','Pan.L','Pan.H','Dec.X','Dec.Y','Dec.L','Dec.H','Pieces restantes'];
      ctx.fillStyle='#fffbeb';ctx.fillRect(mg,ty,tW,22);ctx.fillStyle='#92400e';ctx.font='bold 9px sans-serif';
      dH.forEach((h,i)=>{ctx.textAlign=i>=8?'left':'center';ctx.fillText(h,i>=8?mg+8*tW/9+6:mg+i*tW/9+tW/18,ty+8)});ty+=22;
      zC.impacts.forEach((ip,ri)=>{if(ri%2===0){ctx.fillStyle='#fffef5';ctx.fillRect(mg,ty,tW,22)}
        const vals=[ip.ref,`O${ip.ouvIdx+1}`,String(ip.panW),String(ip.panH),String(ip.cutX),String(ip.cutY),String(ip.cutW),String(ip.cutH),
          ip.fullRemoval?'SUPPRIME':ip.pieces.map(p=>`${p.desc}:${p.w}x${p.h}`).join(' | ')];
        ctx.font='10px monospace';vals.forEach((v,i)=>{ctx.fillStyle=ip.fullRemoval&&i>=8?'#dc2626':i===0?'#d97706':'#334155';ctx.textAlign=i>=8?'left':'center';
          ctx.fillText(v,i>=8?mg+8*tW/9+6:mg+i*tW/9+tW/18,ty+8)});
        ctx.strokeStyle='#e2e8f0';ctx.lineWidth=.3;ctx.beginPath();ctx.moveTo(mg,ty+22);ctx.lineTo(mg+tW,ty+22);ctx.stroke();ty+=22});
      // Footer
      ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';ctx.textBaseline='bottom';
      ctx.fillText(`${projectName} — ${z.name} — ${dateStr}`,W-mg,totalH-15);
      ctx.fillStyle=zColor;ctx.fillRect(mg,totalH-20,60,4);

      c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);
        a.download=`Calepinage_${projectName.replace(/\W/g,'_')}_${z.name.replace(/\W/g,'_')}.png`;a.click()},'image/png');
      if(zi<zones.length-1)await new Promise(r=>setTimeout(r,300));
    }
  };

  /* ── SVG RENDERING ── */

  /* ── EXPORT PDF A4 PAYSAGE ── */

  // QR code and AR functions removed in v17

  const exportPDF=async(selZones,opts={})=>{
    const ok=await window._jspdfReady;if(!ok){alert('jsPDF non chargé');return}
    const{jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    const PW=297,PH=210,mg=7;const dateStr=new Date().toLocaleDateString('fr-FR');const showOss=opts.showOss||false;
    const showQR=opts.showQR||false;const viewerBase=(getSupaConfig().viewerUrl||window.location.origin+window.location.pathname);
    let first=true;

    // Regrouper les zones par numéro de page
    const pageGroups=opts.pageGroups||{};// {zoneIdx: pageNum}
    const pages={};// {pageNum: [zoneIdx,...]}
    selZones.forEach(zi=>{const pg=pageGroups[zi]??zi;if(!pages[pg])pages[pg]=[];pages[pg].push(zi);});
    const pageList=Object.values(pages);

    for(const pageZones of pageList){
      if(!first)doc.addPage('a4','landscape');first=false;
      const nCols=pageZones.length;// zones côte-à-côte

      for(let col=0;col<nCols;col++){
        const zi=pageZones[col];
        const z=zones[zi];const zC=allCalcs[zi];if(!zC)continue;
        const zCol=ZONE_COLORS[zi%8];
        const rc=s=>[parseInt(s.slice(1,3),16)||100,parseInt(s.slice(3,5),16)||100,parseInt(s.slice(5,7),16)||200];
        const zRGB=rc(zCol);

        // Zone names in header
        if(col===0){
          doc.setDrawColor(180,30,50);doc.setLineWidth(0.3);doc.line(mg,11,PW-mg,11);
          doc.setTextColor(50,50,55);doc.setFont('helvetica','bold');doc.setFontSize(9);
          doc.text('CALEPINAGE',mg,7.5);
          doc.setFontSize(5.5);doc.setTextColor(120);doc.setFont('helvetica','normal');
          const names=pageZones.map(i=>zones[i].name).join(' + ');
          doc.text(names+' | '+dateStr,PW-mg,7.5,{align:'right'});
        }

        // Diviser la largeur plan entre les zones de la page
        const totalPlanW=PW*0.575;
        const colPlanW=nCols===1?totalPlanW:(totalPlanW-4*(nCols-1))/nCols;
        const colOffX=col*(colPlanW+(nCols>1?4:0));

        /* ═══ PLAN FACADE ═══ */
        const planH=PH-13-mg-6;
        const plX=mg+colOffX,plY=16;
        doc.setFillColor(252,252,254);doc.rect(plX,plY,colPlanW,planH,'F');
        doc.setDrawColor(220,220,225);doc.setLineWidth(.1);doc.rect(plX,plY,colPlanW,planH);

        // Zone label top-left of this column
        if(nCols>1){
          doc.setFillColor(...zRGB);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.15}));
          doc.rect(plX,plY,colPlanW,3,'F');doc.restoreGraphicsState();
          doc.setFontSize(4.5);doc.setFont('helvetica','bold');doc.setTextColor(...zRGB);
          doc.text(z.name,plX+2,plY+2.2);
        }

        const fMg=10;const avW=colPlanW-fMg*2-14,avH=planH-fMg*2-8;
        const fAsp=z.L/z.H;let fW,fH;
        if(fAsp>avW/avH){fW=avW;fH=fW/fAsp}else{fH=avH;fW=fH*fAsp}
        const fX=plX+fMg+7+(avW-fW)/2,fY=plY+fMg+4+(avH-fH)/2;
        const sc=fW/(z.L/1000);

      // ─ BACKGROUND PLAN behind panels ─
      if(bgSrc&&pxPerMm_eff){try{
        const facPxW=z.L*pxPerMm_eff,facPxH=z.H*pxPerMm_eff;
        const tmpC=document.createElement('canvas');
        tmpC.width=Math.min(Math.round(facPxW),2000);tmpC.height=Math.min(Math.round(facPxH),2000);
        const tmpCtx=tmpC.getContext('2d');const bgImg=new Image();bgImg.src=bgSrc;
        tmpCtx.drawImage(bgImg,z.facOrigin.x,z.facOrigin.y,facPxW,facPxH,0,0,tmpC.width,tmpC.height);
        const cropData=tmpC.toDataURL('image/jpeg',0.6);
        doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.3}));
        doc.addImage(cropData,'JPEG',fX,fY,fW,fH);
        doc.restoreGraphicsState();
      }catch(e){}}

      // ─ OSSATURE (optional) ─
      if(showOss){
        doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.12}));
        const eMm=z.oss.eM/1000;
        doc.setDrawColor(200,180,140);doc.setLineWidth(.03);
        for(let i=0;i*eMm*sc<=fW+.1&&i<300;i++){doc.setLineDashPattern([.6,.5],0);doc.line(fX+i*eMm*sc,fY,fX+i*eMm*sc,fY+fH)}
        const eLm=z.oss.eL/1000;doc.setDrawColor(160,185,160);
        for(let i=0;i*eLm*sc<=fH+.1&&i<300;i++){doc.setLineDashPattern([.6,.5],0);doc.line(fX,fY+i*eLm*sc,fX+fW,fY+i*eLm*sc)}
        doc.setLineDashPattern([],0);doc.restoreGraphicsState();
      }

      // ─ PANELS with color-coded repérage ─
      // Build color map by unique dimension
      const repColors=[[79,130,230],[52,180,140],[180,90,40],[139,92,246],[13,148,136],[180,30,50],[100,140,80],[200,130,50]];
      const dimColorMap={};let dci=0;
      zC.activePanels.forEach(pm=>{const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        if(!(k in dimColorMap)){dimColorMap[k]=repColors[dci%repColors.length];dci++}});
      doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.2}));
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc;
        const pw=pm.pWa*sc,ph=pm.pHa*sc;
        if(pw<.1||ph<.1)return;
        if(pm.isVoid){doc.setFillColor(30,30,30);doc.rect(px,py,pw,ph,'F');return}
        const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        const rgb=dimColorMap[k]||[200,200,210];
        doc.setFillColor(...rgb);doc.rect(px,py,pw,ph,'F');
      });
      doc.restoreGraphicsState();
      // Panel borders + refs
      zC.panelMap.forEach(pm=>{
        const px=fX+pm.pLeft*sc,py=fY+pm.pTop*sc;
        const pw=pm.pWa*sc,ph=pm.pHa*sc;
        if(pw<.1||ph<.1||pm.isVoid)return;
        const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);
        const rgb=dimColorMap[k]||[160,165,180];
        doc.setDrawColor(...rgb);doc.setLineWidth(.06);doc.rect(px,py,pw,ph);
        if(pw>2&&ph>1.5){
          doc.setFontSize(Math.min(4,pw/2.5,ph/1.5));doc.setFont('courier','bold');doc.setTextColor(...rgb);
          doc.text(pm.subRef||((pm.col+1)+'.'+(pm.row+1)),px+pw/2,py+ph/2+.4,{align:'center'});
        }
      });
      // panDims for right column
      const panDims={};zC.activePanels.forEach(pm=>{const k=Math.round(pm.pWa*1000)+'x'+Math.round(pm.pHa*1000);if(!panDims[k])panDims[k]=0;panDims[k]++});

      // ─ OPENINGS — group identical dims ─
      const ouvDimGroups={};z.ouvs.forEach((o,oi)=>{const k=o.w+'x'+o.h;if(!ouvDimGroups[k])ouvDimGroups[k]=[];ouvDimGroups[k].push(oi)});
      const shownDims=new Set();
      z.ouvs.forEach((o,oi)=>{
        const ox=fX+o.x/1000*sc,oy=fY+o.y/1000*sc;
        const ow=o.w/1000*sc,oh=o.h/1000*sc;
        doc.setFillColor(255,245,245);doc.setDrawColor(180,50,60);doc.setLineWidth(.1);
        doc.rect(ox,oy,ow,oh,'FD');
        doc.setLineWidth(.04);doc.setDrawColor(200,120,130);
        doc.line(ox,oy,ox+ow,oy+oh);doc.line(ox+ow,oy,ox,oy+oh);
        doc.setFont('helvetica','bold');doc.setFontSize(Math.min(5.5,ow/2.2));doc.setTextColor(160,30,40);
        if(ow>2)doc.text('O'+(oi+1),ox+ow/2,oy+oh/2,{align:'center'});
        // Show dims only once per unique size
        const dk=o.w+'x'+o.h;
        if(!shownDims.has(dk)&&ow>3){
          shownDims.add(dk);doc.setFont('courier','normal');doc.setFontSize(Math.min(3.5,ow/3));doc.setTextColor(140,60,70);
          const qty=ouvDimGroups[dk].length;
          doc.text(o.w+'x'+o.h+(qty>1?' (x'+qty+')':''),ox+ow/2,oy+oh/2+2.5,{align:'center'});
        }
      });

      // ─ FACADE BORDER ─
      doc.setDrawColor(80,85,95);doc.setLineWidth(.25);doc.rect(fX,fY,fW,fH);

      // ─ DIMENSION LINES ─
      doc.setDrawColor(130,135,145);doc.setLineWidth(.03);
      // Width top
      const dY=fY-4.5;
      doc.line(fX,dY,fX+fW,dY);doc.line(fX,dY-2,fX,dY+2);doc.line(fX+fW,dY-2,fX+fW,dY+2);
      // small arrow heads
      doc.setFillColor(100,105,120);
      doc.triangle(fX,dY,fX+1,dY-.4,fX+1,dY+.4,'F');
      doc.triangle(fX+fW,dY,fX+fW-1,dY-.4,fX+fW-1,dY+.4,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(50,55,65);
      doc.text((z.L/1000).toFixed(2)+' m',fX+fW/2,dY-1.5,{align:'center'});
      // Height left
      const dX=fX-6;
      doc.line(dX,fY,dX,fY+fH);doc.line(dX-2,fY,dX+2,fY);doc.line(dX-2,fY+fH,dX+2,fY+fH);
      doc.triangle(dX,fY,dX-.4,fY+1,dX+.4,fY+1,'F');
      doc.triangle(dX,fY+fH,dX-.4,fY+fH-1,dX+.4,fY+fH-1,'F');
      doc.text((z.H/1000).toFixed(2)+' m',dX-1.5,fY+fH/2,{align:'center',angle:90});

      // ─ UNIFIED LEGEND (below facade, wrapping to multiple rows) ─
      {const lY0=fY+fH+2.5,lX0=fX;let lx=lX0;let ly=lY0;const lh=2.4;const lineGap=3.2;const maxW=fX+fW;
       doc.setFontSize(2.8);doc.setFont('helvetica','normal');
       // Panel dim colors — always wrap
       const entries=Object.entries(dimColorMap);
       entries.forEach(([dim,rgb])=>{
         const qty=panDims[dim]||0;const txt=`${dim} (×${qty})`;
         const tw=doc.getTextWidth(txt)+5.5;
         if(lx+tw>maxW-1){lx=lX0;ly+=lineGap;}// wrap to next row
         doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.25}));
         doc.rect(lx,ly,2.5,lh,'F');doc.restoreGraphicsState();
         doc.setDrawColor(...rgb);doc.setLineWidth(.02);doc.rect(lx,ly,2.5,lh);
         doc.setTextColor(...rgb);doc.text(txt,lx+3,ly+1.65);
         lx+=tw;
       });
       // Ouverture legend
       const ouvTw=doc.getTextWidth('Ouverture')+6;
       if(lx+ouvTw>maxW-1){lx=lX0;ly+=lineGap;}
       doc.setFillColor(255,235,235);doc.setDrawColor(180,50,60);doc.setLineWidth(.04);
       doc.rect(lx,ly,2.5,lh,'FD');
       doc.setTextColor(180,50,60);doc.text('Ouverture',lx+3.5,ly+1.65);
      }

      // ─ REPERAGE (only if plan loaded) ─
      if(bgSrc&&pxPerMm_eff){
        const thW=30,thH=22,thX=plX+planW-thW-2,thY=plY+1.5;
        doc.setFillColor(250,250,252);doc.rect(thX,thY,thW,thH,'F');
        doc.setDrawColor(200,200,210);doc.setLineWidth(.08);doc.rect(thX,thY,thW,thH);
        // Background plan in reperage
        if(bgSrc){try{
          doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.2}));
          const bgAsp=bgW/bgH;let ibW,ibH;
          if(bgAsp>(thW-1)/(thH-1)){ibW=thW-1;ibH=ibW/bgAsp}else{ibH=thH-1;ibW=ibH*bgAsp}
          doc.addImage(bgSrc,'JPEG',thX+.5+(thW-1-ibW)/2,thY+.5+(thH-1-ibH)/2,ibW,ibH);
          doc.restoreGraphicsState();
        }catch(e){}}
        doc.setFontSize(3.5);doc.setFont('helvetica','bold');doc.setTextColor(150,150,160);
        doc.text('REPERAGE',thX+thW/2,thY+2.5,{align:'center'});
        // Map zones relative to background image (bgW x bgH in SVG pixels)
        const refW=bgW||1,refH=bgH||1;
        const bgAsp2=refW/refH;const thMg=2;
        let mapW,mapH;
        if(bgAsp2>(thW-thMg*2)/(thH-thMg*2-3)){mapW=thW-thMg*2;mapH=mapW/bgAsp2}
        else{mapH=thH-thMg*2-3;mapW=mapH*bgAsp2}
        const mapX=thX+thMg+(thW-thMg*2-mapW)/2,mapY=thY+3+thMg+(thH-thMg*2-3-mapH)/2;
        const ppm=pxPerMm_eff||1;
        zones.forEach((zz,zzi)=>{
          const rx=mapX+(zz.facOrigin.x/refW)*mapW;
          const ry=mapY+(zz.facOrigin.y/refH)*mapH;
          const rw=Math.max((zz.L*ppm/refW)*mapW,1.2);
          const rh=Math.max((zz.H*ppm/refH)*mapH,.8);
          const cur=zzi===zi;const zRGB2=rc(ZONE_COLORS[zzi%8]);
          doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:cur?0.7:0.4}));
          doc.setFillColor(...zRGB2);doc.rect(rx,ry,rw,rh,'F');
          doc.restoreGraphicsState();
          doc.setDrawColor(...zRGB2);doc.setLineWidth(cur?.35:.1);doc.rect(rx,ry,rw,rh);
          if(rw>3.5){doc.setFontSize(2.5);doc.setTextColor(...zRGB2);
            doc.setFont('helvetica','bold');doc.text(zz.name,rx+.5,ry+rh/2+.7)}
        });
      }

      /* ═══ RIGHT COLUMN: QUANTITATIF + TABLES ═══ */
      // Only shown for last zone in the page group (no room if multiple)
      if(col!==nCols-1)continue;// next col
      const totalPlanWR=PW*0.575;
      const rX=mg+totalPlanWR+3.5,rW=PW-rX-mg;let rY=plY;
      const rYstart=rY;
      // Right column background
      // Light right column

      doc.setDrawColor(220,220,225);doc.setLineWidth(.04);doc.line(rX-.5,plY,rX-.5,PH-8);

      const sTitle=(t,rgb)=>{
        doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:0.08}));doc.rect(rX,rY+.3,rW-1,4,'F');doc.restoreGraphicsState();
        doc.setFillColor(...rgb);doc.rect(rX+1,rY+.5,rW-2.5,.35,'F');
        doc.setFontSize(5);doc.setFont('helvetica','bold');doc.setTextColor(...rgb);
        doc.text(t,rX+2.5,rY+3.2);rY+=4.5;
      };
      const sRow=(lb,val,bold,rgb)=>{
        doc.setFontSize(bold?6:5.2);doc.setFont('helvetica',bold?'bold':'normal');
        doc.setTextColor(...(rgb||[70,75,90]));doc.text(lb,rX+3,rY+1.8);
        doc.setFont('courier','bold');doc.setFontSize(bold?6:5.2);
        doc.text(val,rX+rW-3,rY+1.8,{align:'right'});rY+=bold?3.8:3;
      };

      sTitle('SURFACES',[59,130,246]);
      sRow('Surface brute',zC.sBr.toFixed(2)+' m\u00B2');
      sRow('Ouvertures','-'+zC.sOuv.toFixed(2)+' m\u00B2');
      sRow('Surface nette',zC.sNet.toFixed(2)+' m\u00B2',true,[59,130,246]);rY+=1;

      sTitle('PANNEAUX',[139,92,246]);
      sRow('Total',zC.nP+' u ('+zC.nC+'c × '+zC.nR+'r)',true);
      rY+=1;

      // ── TABLEAU PANNEAUX COLORÉ ──
      // Header row
      const colW=[5,24,10,10,12];// swatch | dim | W | H | qty
      const tX=rX+1;
      doc.setFillColor(245,240,255);doc.rect(tX,rY,rW-2,3.5,'F');
      doc.setDrawColor(200,190,230);doc.setLineWidth(.02);doc.line(tX,rY+3.5,tX+rW-2,rY+3.5);
      doc.setFontSize(3.2);doc.setFont('helvetica','bold');doc.setTextColor(100,60,160);
      let tx2=tX+.5;
      ['','DIMENSIONS','Larg.','Haut.','QTÉ'].forEach((h,i)=>{doc.text(h,tx2+(i>0?.5:0),rY+2.5);tx2+=colW[i]});
      rY+=3.8;

      // Data rows
      const dimEntries=Object.entries(panDims).sort((a,b)=>b[1]-a[1]);
      dimEntries.forEach(([d,q],ri)=>{
        const [dw,dh]=d.split('x').map(Number);
        const rgb=dimColorMap[d]||[180,180,190];
        if(ri%2===0){doc.setFillColor(252,250,255);doc.rect(tX,rY-.3,rW-2,3.4,'F');}
        // Color swatch
        doc.setFillColor(...rgb);doc.saveGraphicsState();doc.setGState(new doc.GState({opacity:.55}));
        doc.roundedRect(tX+.3,rY+.2,3.5,2.5,.4,.4,'F');doc.restoreGraphicsState();
        doc.setDrawColor(...rgb);doc.setLineWidth(.06);doc.roundedRect(tX+.3,rY+.2,3.5,2.5,.4,.4);
        // Values
        tx2=tX+.5+colW[0];
        doc.setFont('courier','bold');doc.setFontSize(3.5);doc.setTextColor(...rgb);
        doc.text(dw+'×'+dh,tx2,rY+2);tx2+=colW[1];
        doc.setFont('courier','normal');doc.setTextColor(80,80,95);
        doc.text(String(dw),tx2,rY+2);tx2+=colW[2];
        doc.text(String(dh),tx2,rY+2);tx2+=colW[3];
        doc.setFont('courier','bold');doc.setTextColor(100,60,160);
        doc.text(String(q)+' u',tx2,rY+2);
        rY+=3.2;
      });
      // Separator + total
      doc.setDrawColor(200,190,230);doc.setLineWidth(.04);doc.line(tX,rY,tX+rW-2,rY);rY+=1.5;
      doc.setFont('courier','bold');doc.setFontSize(4);doc.setTextColor(100,60,160);
      doc.text('Total : '+zC.nP+' panneaux',tX+rW-3,rY+2,{align:'right'});
      rY+=4.5;

      // Separator
      doc.setDrawColor(220,220,225);doc.setLineWidth(.04);doc.line(rX+2,rY,rX+rW-2,rY);rY+=2;

      // ─── TABLE ENCADREMENTS (grouped by identical type+dims) ───
      doc.setFont('helvetica','bold');doc.setFontSize(5.5);doc.setTextColor(50,55,65);
      doc.text('ENCADREMENTS',rX,rY+2);rY+=4;
      const eCols2=['Qté','Type','L','H','Tab.G','Tab.D','Lint.','Appui','Total'];
      const eW2=[7,11,9,9,11.5,11.5,11.5,11.5,15];
      doc.setDrawColor(200,200,210);doc.setLineWidth(.03);doc.line(rX,rY+3,rX+rW,rY+3);
      doc.setFontSize(3.5);doc.setFont('helvetica','bold');doc.setTextColor(110,115,130);
      let tx=rX+.5;eCols2.forEach((h,i)=>{doc.text(h,tx,rY+2);tx+=eW2[i]});rY+=3.8;
      // Group identical openings by type + dimensions + retours
      const encGroups={};zC.menuDet.forEach(m=>{
        const k=m.w+'|'+m.h+'|'+Math.round(m.tableauG*100)+'|'+Math.round(m.tableauD*100)+'|'+Math.round(m.linteau*100)+'|'+Math.round(m.appui*100);
        if(!encGroups[k])encGroups[k]={...m,qty:0,encTotalSum:0};
        encGroups[k].qty++;encGroups[k].encTotalSum+=m.encTotal;
      });
      const encRows=Object.values(encGroups);
      doc.setFont('courier','normal');doc.setFontSize(4);
      encRows.forEach((m,ri)=>{
        if(rY>PH-18)return;
        if(ri%2===0){doc.setFillColor(250,250,253);doc.rect(rX,rY-.5,rW,3.2,'F')}
        tx=rX+.5;doc.setTextColor(60,65,80);
        const vals=[m.qty>1?'x'+m.qty:'1',m.t,String(m.w),String(m.h),m.tableauG.toFixed(3),m.tableauD.toFixed(3),m.linteau.toFixed(3),m.appui.toFixed(3),m.encTotal.toFixed(3)];
        vals.forEach((v,i)=>{
          if(i===0&&m.qty>1){doc.setTextColor(180,30,50);doc.setFont('courier','bold')}
          else if(i===8){doc.setTextColor(180,30,50);doc.setFont('courier','bold')}
          else{doc.setTextColor(60,65,80);doc.setFont('courier','normal')}
          doc.text(v,tx,rY+2);tx+=eW2[i];
        });rY+=3.2;
      });
      if(zC.menuDet.length>0){
        doc.setDrawColor(200,200,210);doc.setLineWidth(.03);doc.line(rX,rY,rX+rW,rY);rY+=1;
        doc.setFont('courier','bold');doc.setFontSize(4.5);doc.setTextColor(180,30,50);
        doc.text('Total: '+zC.totEnc.tot.toFixed(2)+' ml  ('+zC.menuDet.length+' menuiseries)',rX+rW-3,rY+2,{align:'right'});
        rY+=4.5;
      }else{rY+=2}

      /* ═══ FOOTER ═══ */
      if(col===nCols-1){// Once per page
        doc.setDrawColor(180,30,50);doc.setLineWidth(.15);doc.line(mg,PH-5,PW-mg,PH-5);
        doc.setFontSize(4);doc.setTextColor(150,150,160);doc.setFont('helvetica','normal');
        const names=pageZones.map(i=>zones[i].name).join(' + ');
        doc.text(projectName+' | '+names+' | '+dateStr,PW-mg,PH-2,{align:'right'});
        // QR codes for each zone on this page
        if(showQR){
          let qxOff=mg;
          for(const zqi of pageZones){
            const zq=zones[zqi],zqC=allCalcs[zqi];if(!zqC)continue;
            try{
              const viewData={project_name:projectName,zone_name:zq.name,
                zone_json:JSON.stringify(zq),calc_json:JSON.stringify(zqC),
                ral_color:RAL_COLORS[ralIdx]?.hex||'#383E42',ral_finish:RAL_COLORS[ralIdx]?.finish||'mat'};
              const uid=await supaUpload(viewData);
              if(uid){
                const sConf=getSupaConfig();
                const viewUrl=viewerBase+'?view='+uid+'&s_url='+encodeURIComponent(sConf.url)+'&s_key='+encodeURIComponent(sConf.key);
                const qrImg=makeQRDataURL(viewUrl,18);
                if(qrImg){
                  doc.addImage(qrImg,'PNG',qxOff,PH-23,18,18);
                  doc.setFontSize(3);doc.setTextColor(120);
                  doc.text(zq.name,qxOff+9,PH-4,{align:'center'});
                  doc.text('Scan → 3D',qxOff+9,PH-1.5,{align:'center'});
                  qxOff+=22;
                }
              }
            }catch(e){console.error('QR gen:',e)}
          }
        }
      }
      }// end col loop
    }// end page loop

    // (single page per zone — no extra pages)
        doc.save('Calepinage_'+projectName.replace(/\W/g,'_')+'.pdf');
  };


  const ppMmZ=pxPerMm_eff*zoom;
  const ZoneView=({z,zCalc,isActive,idx})=>{
    if(!z||!zCalc)return null;
    const ox=z.facOrigin.x*zoom+pan.x,oy=z.facOrigin.y*zoom+pan.y;
    const fWpx=z.L*pxPerMm_eff*zoom,fHpx=z.H*pxPerMm_eff*zoom;
    const ppZ=pxPerMm_eff*zoom;const montSp=z.oss.eM*ppZ,lissSp=z.oss.eL*ppZ;
    const zColor=ZONE_COLORS[idx%8];
    const clipId=`fc-${z.id}`;

    // Polygon or rect clip
    const ClipShape=()=>z.poly?
      <clipPath id={clipId}><path d={polyToPath(z.poly,ppZ,0,0)}/></clipPath>:
      <clipPath id={clipId}><rect width={fWpx} height={fHpx} rx="2"/></clipPath>;

    const rotDeg=z.rot||0;
    const cx=fWpx/2,cy=fHpx/2;
    return(
      <g transform={`translate(${ox},${oy})${rotDeg?` rotate(${rotDeg},${cx},${cy})`:''}`} opacity={isActive?1:.35}>
        <defs><ClipShape/></defs>
        {/* Shadow + fill */}
        {z.poly?<path d={polyToPath(z.poly,ppZ,4,4)} fill="#000" opacity=".08"/>:
          <rect x={4} y={4} width={fWpx} height={fHpx} fill="#000" rx="3" opacity=".08"/>}
        {z.poly?<path d={polyToPath(z.poly,ppZ,0,0)} fill="rgba(255,252,248,.6)" stroke={isActive?zColor:'#444'} strokeWidth={isActive?2:1}/>:
          <rect width={fWpx} height={fHpx} fill="rgba(255,252,248,.6)" stroke={isActive?zColor:'#444'} strokeWidth={isActive?2:1} rx="2"/>}
        {/* BG image */}
        {bgSrc&&bgVis&&<image href={bgSrc} x={-z.facOrigin.x*zoom} y={-z.facOrigin.y*zoom} width={bgW*zoom} height={bgH*zoom} opacity={bgOp} clipPath={`url(#${clipId})`}/>}
        {/* Panels — sub-panels with RAL colors */}
        {isActive&&<g clipPath={`url(#${clipId})`}>{zCalc.panelMap.map((pm,pi)=>{
          const px=pm.pLeft*1000*ppZ,py=pm.pTop*1000*ppZ,pw=pm.pWa*1000*ppZ,ph=pm.pHa*1000*ppZ;
          if(pw<1||ph<1)return null;
          const ralColor=RAL_COLORS[ralIdx]?.hex||'#383E42';
          if(pm.isVoid){
            // Void cell (inside opening) - show as empty/hatched
            return<g key={`p${pm.col}-${pm.row}`}>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="rgba(0,0,0,.3)" stroke="rgba(251,113,133,.15)" strokeWidth=".3" rx="1"/>
            </g>
          }
          const isImp=pm.isImpacted;
          const isEditing=editPanel&&editPanel.col===pm.col&&editPanel.row===pm.row;
          const panW=Math.round(pm.pWa*1000),panH=Math.round(pm.pHa*1000);
          return<g key={`p${pm.col}-${pm.row}`} style={{cursor:'pointer'}}
            onMouseDown={e=>{
              if(e.button===0&&!modeDraw&&!measureMode)e.stopPropagation();// Let draw/measure pass through
              if(mergeSrc&&e.button===0){e.stopPropagation();
                e.preventDefault();
                if(mergeSrc.parentCol===-1){setMergeSrc({parentCol:pm.parentCol,parentRow:pm.parentRow});return}
                const s=mergeSrc,t={parentCol:pm.parentCol,parentRow:pm.parentRow};
                if(s.parentCol===t.parentCol&&s.parentRow===t.parentRow){setMergeSrc(null);return}
                const c1=Math.min(s.parentCol,t.parentCol),r1=Math.min(s.parentRow,t.parentRow);
                const c2=Math.max(s.parentCol,t.parentCol),r2=Math.max(s.parentRow,t.parentRow);
                updateAZ(z=>{
                  let ms=(z.merges||[]).filter(m=>!(m.c1>=c1&&m.r1>=r1&&m.c2<=c2&&m.r2<=r2));
                  ms=ms.filter(m=>{for(let cc=c1;cc<=c2;cc++)for(let rr=r1;rr<=r2;rr++){if(cc>=m.c1&&cc<=m.c2&&rr>=m.r1&&rr<=m.r2)return false}return true});
                  ms.push({c1,r1,c2,r2});return{...z,merges:ms}});
                setMergeSrc(null);setEditPanel(null);return;
              }
            }}
            onClick={e=>{e.stopPropagation();
              if(mergeSrc)return;
              // Exclude mode: toggle exclusion on panel click
              if(excludeMode){
                const exKey={col:pCol,row:pRow};
                const already=(az.exclusions||[]).some(ex=>ex.col===pCol&&ex.row===pRow);
                if(already){
                  updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter(ex=>!(ex.col===pCol&&ex.row===pRow))}));
                }else{
                  updateAZ(z=>({...z,exclusions:[...(z.exclusions||[]),{col:pCol,row:pRow,depth:excludeDepth}]}));
                }
                return;
              }
              const rect=cvRef.current.getBoundingClientRect();
              setEditPanel({col:pm.col,row:pm.row,parentCol:pm.parentCol,parentRow:pm.parentRow,screenX:e.clientX-rect.left,screenY:e.clientY-rect.top,panW,panH,pLeft:pm.pLeft,pTop:pm.pTop})}}>
            <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1}
              fill={mergeSrc&&mergeSrc.parentCol===pm.parentCol&&mergeSrc.parentRow===pm.parentRow?'rgba(139,92,246,.5)':isEditing?'rgba(79,110,247,.3)':ralColor} fillOpacity={mergeSrc?0.95:isEditing?1:.88}
              stroke={isEditing?'var(--bl)':isImp?'rgba(251,191,36,.8)':pm.polyEdge?'rgba(34,211,238,.6)':'rgba(255,255,255,.2)'}
              strokeWidth={isEditing?2.5:isImp?1.2:.5} rx="1"
              opacity={isEditing?1:.85}/>
            {/* Panel ref label */}
            {pw>14&&ph>10&&<text x={px+3} y={py+9} fontSize={Math.min(7,pw/6,ph/3)} fontWeight="700" fontFamily="JetBrains Mono"
              fill="rgba(42,26,30,.8)" style={{pointerEvents:'none'}}>{pm.subRef}</text>}
            {/* Dimensions */}
            {pw>45&&ph>22&&<text x={px+pw/2} y={py+ph/2+2} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(7,pw/8,ph/3.5)} fontWeight="500" fontFamily="JetBrains Mono"
              fill="rgba(42,26,30,.55)" style={{pointerEvents:'none'}}>{panW}×{panH}</text>}
            {/* Impacted marker */}
            {isImp&&pw>20&&ph>14&&<text x={px+pw-3} y={py+9} textAnchor="end" fontSize={Math.min(7,pw/7)}
              fill="rgba(251,191,36,.9)" fontWeight="700" style={{pointerEvents:'none'}}>✂</text>}
            {/* Merged indicator */}
            {pm.isMerged&&<><rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="none"
              stroke="rgba(139,92,246,.6)" strokeWidth="2" strokeDasharray="4,2" rx="1" style={{pointerEvents:'none'}}/>
              {pw>25&&ph>20&&<text x={px+pw-3} y={py+ph-4} textAnchor="end" fontSize="7"
                fill="rgba(139,92,246,.8)" fontWeight="700" style={{pointerEvents:'none'}}>⊞</text>}</>}
            {/* Excluded panel - red hatching */}
            {pm.isExcluded&&<>
              <defs><pattern id={`hatch-${pm.col}-${pm.row}`} width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                <line x1="0" y1="0" x2="0" y2="8" stroke="rgba(190,18,60,.5)" strokeWidth="2"/></pattern></defs>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill={`url(#hatch-${pm.col}-${pm.row})`} rx="1" style={{pointerEvents:'none'}}/>
              <rect x={px+.5} y={py+.5} width={pw-1} height={ph-1} fill="none"
                stroke="rgba(190,18,60,.8)" strokeWidth="2.5" strokeDasharray="6,3" rx="1" style={{pointerEvents:'none'}}/>
              {pw>25&&ph>20&&<text x={px+pw/2} y={py+ph/2} textAnchor="middle" dominantBaseline="middle" fontSize="11"
                fill="rgba(190,18,60,.9)" fontWeight="700" style={{pointerEvents:'none'}}>🚫</text>}
              {pw>35&&ph>30&&pm.exclusionDepth&&<text x={px+pw/2} y={py+ph/2+12} textAnchor="middle" dominantBaseline="middle" fontSize="7"
                fill="rgba(190,18,60,.7)" fontWeight="600" style={{pointerEvents:'none'}}>Balcon {pm.exclusionDepth}mm</text>}
            </>}
          </g>})}</g>}
        {/* Ossature: montants + lisses interrupted around openings */}
        {isActive&&<g clipPath={`url(#${clipId})`} style={{pointerEvents:'none'}}>
          {Array.from({length:Math.floor(z.L/z.oss.eM)+1}).map((_,i)=>{
            const mxMm=i*z.oss.eM;if(mxMm>z.L)return null;const mxPx=mxMm*ppZ;
            let segs=[{y1:0,y2:z.H}];
            z.ouvs.forEach(o=>{const oL=o.x,oR=o.x+o.w,oT=o.y,oB=o.y+o.h;
              if(mxMm<oL+1||mxMm>oR-1)return;
              const ns=[];segs.forEach(s=>{if(oT>=s.y2||oB<=s.y1){ns.push(s);return}
                if(s.y1<oT)ns.push({y1:s.y1,y2:oT});if(oB<s.y2)ns.push({y1:oB,y2:s.y2})});segs=ns;});
            return<g key={`m${i}`}>{segs.map((s,si)=>
              <line key={si} x1={mxPx} y1={s.y1*ppZ} x2={mxPx} y2={s.y2*ppZ}
                stroke="rgba(245,158,11,.55)" strokeWidth="1.5" strokeDasharray="5,3"/>)}
              {mxPx>10&&mxPx<fWpx-10&&<text x={mxPx+2} y={10} fontSize="6" fill="rgba(245,158,11,.35)" fontFamily="JetBrains Mono" fontWeight="700">M</text>}
            </g>})}
          {Array.from({length:Math.floor(z.H/z.oss.eL)+1}).map((_,i)=>{
            const lyMm=i*z.oss.eL;if(lyMm>z.H)return null;const lyPx=lyMm*ppZ;
            let segs=[{x1:0,x2:z.L}];
            z.ouvs.forEach(o=>{const oL=o.x,oR=o.x+o.w,oT=o.y,oB=o.y+o.h;
              if(lyMm<oT+1||lyMm>oB-1)return;
              const ns=[];segs.forEach(s=>{if(oL>=s.x2||oR<=s.x1){ns.push(s);return}
                if(s.x1<oL)ns.push({x1:s.x1,x2:oL});if(oR<s.x2)ns.push({x1:oR,x2:s.x2})});segs=ns;});
            return<g key={`l${i}`}>{segs.map((s,si)=>
              <line key={si} x1={s.x1*ppZ} y1={lyPx} x2={s.x2*ppZ} y2={lyPx}
                stroke="rgba(52,211,153,.45)" strokeWidth="1.5" strokeDasharray="5,3"/>)}
              {lyPx>10&&lyPx<fHpx-10&&<text x={2} y={lyPx+10} fontSize="6" fill="rgba(52,211,153,.3)" fontFamily="JetBrains Mono" fontWeight="700">L</text>}
            </g>})}
          {/* Chassis frames around openings */}
          {z.ouvs.map((o,oi)=><rect key={`ch${oi}`} x={o.x*ppZ} y={o.y*ppZ} width={o.w*ppZ} height={o.h*ppZ}
            fill="none" stroke="rgba(180,180,180,.4)" strokeWidth="2.5" rx="1"/>)}
        </g>}
        {/* Retours d'encadrements — cadre autour ouvertures (face visible sur facade) */}
        {isActive&&z.ouvs.map((o,oi)=>{
          const r=o.retours||{tG:150,tD:150,lin:150,app:150};
          const fv=o.faceVis||50;
          const ox=o.x*ppZ,oy=o.y*ppZ,ow=o.w*ppZ,oh=o.h*ppZ;
          const rScale=ppZ;
          const fvPx=fv*rScale;
          const tGpx=r.tG*rScale,tDpx=r.tD*rScale,linPx=r.lin*rScale,appPx=r.app*rScale;
          if(fvPx<0.3)return null;
          return<g key={`ret${oi}`} style={{pointerEvents:'none'}}>
            {/* Tableau Gauche — bande violette à GAUCHE de l'ouverture */}
            {r.tG>0&&<><rect x={ox-fvPx} y={oy} width={fvPx} height={oh}
              fill="rgba(139,92,246,.3)" stroke="rgba(139,92,246,.8)" strokeWidth="1.2"/>
              {fvPx>3&&oh>20&&<text x={ox-fvPx/2} y={oy+oh/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(139,92,246,.9)" fontFamily="JetBrains Mono" fontWeight="700"
                transform={`rotate(-90,${ox-fvPx/2},${oy+oh/2})`}>TG {r.tG}</text>}</>}
            {/* Tableau Droit — bande violette à DROITE de l'ouverture */}
            {r.tD>0&&<><rect x={ox+ow} y={oy} width={fvPx} height={oh}
              fill="rgba(139,92,246,.3)" stroke="rgba(139,92,246,.8)" strokeWidth="1.2"/>
              {fvPx>3&&oh>20&&<text x={ox+ow+fvPx/2} y={oy+oh/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(139,92,246,.9)" fontFamily="JetBrains Mono" fontWeight="700"
                transform={`rotate(90,${ox+ow+fvPx/2},${oy+oh/2})`}>TD {r.tD}</text>}</>}
            {/* Linteau — bande cyan AU-DESSUS de l'ouverture */}
            {r.lin>0&&<><rect x={ox-fvPx} y={oy-fvPx} width={ow+fvPx*2} height={fvPx}
              fill="rgba(34,211,238,.25)" stroke="rgba(34,211,238,.8)" strokeWidth="1.2"/>
              {fvPx>3&&ow>30&&<text x={ox+ow/2} y={oy-fvPx/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(34,211,238,.9)" fontFamily="JetBrains Mono" fontWeight="700">LIN {r.lin}</text>}</>}
            {/* Appui — bande verte EN-DESSOUS de l'ouverture */}
            {r.app>0&&<><rect x={ox-fvPx} y={oy+oh} width={ow+fvPx*2} height={fvPx}
              fill="rgba(52,211,153,.25)" stroke="rgba(52,211,153,.8)" strokeWidth="1.2"/>
              {fvPx>3&&ow>30&&<text x={ox+ow/2} y={oy+oh+fvPx/2} textAnchor="middle" dominantBaseline="middle"
                fontSize={Math.min(9,fvPx*.7)} fill="rgba(52,211,153,.9)" fontFamily="JetBrains Mono" fontWeight="700">APP {r.app}</text>}</>}
            {/* Corner markers */}
            {fvPx>2&&<>
              <rect x={ox-fvPx} y={oy-fvPx} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox+ow} y={oy-fvPx} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox-fvPx} y={oy+oh} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
              <rect x={ox+ow} y={oy+oh} width={fvPx} height={fvPx} fill="rgba(139,92,246,.15)" stroke="rgba(139,92,246,.4)" strokeWidth=".5"/>
            </>}
          </g>})}

        {/* Ouvertures */}
        {z.ouvs.map((o,oi)=>{const oox=o.x*ppZ,ooy=o.y*ppZ,oow=o.w*ppZ,ooh=o.h*ppZ;const sel=selId===o.id&&isActive;const multiSel=selIds.has(o.id)&&isActive;
          return<g key={o.id}>
            {/* Opening background — darker to stand out */}
            <rect x={oox} y={ooy} width={oow} height={ooh} fill={multiSel?'rgba(79,110,247,.25)':sel?'rgba(251,113,133,.3)':'rgba(251,113,133,.18)'}
              stroke={multiSel?'var(--bl)':sel?'var(--rs)':'rgba(251,113,133,.8)'} strokeWidth={multiSel||sel?3:2} rx="2" style={{cursor:isActive?'move':'pointer'}}
              onMouseDown={isActive?e=>handleOuvDown(e,o,'move'):undefined}/>
            {/* Cross hatch for opening */}
            {oow>20&&ooh>20&&<g opacity=".15" style={{pointerEvents:'none'}}><line x1={oox} y1={ooy} x2={oox+oow} y2={ooy+ooh} stroke="var(--rs)" strokeWidth="1"/>
              <line x1={oox+oow} y1={ooy} x2={oox} y2={ooy+ooh} stroke="var(--rs)" strokeWidth="1"/></g>}
            {/* Label */}
            {oow>40&&ooh>20&&<text x={oox+oow/2} y={ooy+ooh/2} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(12,oow/5)} fontWeight="700" fill="var(--rs)" fontFamily="JetBrains Mono" style={{pointerEvents:'none'}}>{o.t||'O'}{oi+1}</text>}
            {oow>60&&ooh>35&&<text x={oox+oow/2} y={ooy+ooh/2+Math.min(12,oow/5)*0.8} textAnchor="middle" dominantBaseline="middle"
              fontSize={Math.min(9,oow/8)} fontWeight="500" fill="rgba(251,113,133,.6)" fontFamily="JetBrains Mono" style={{pointerEvents:'none'}}>{o.w}×{o.h}</text>}
            {sel&&['nw','ne','se','sw','n','s','e','w'].map(d=>{
              const cx=d.includes('w')?oox:d.includes('e')?oox+oow:oox+oow/2;
              const cy=d.includes('n')?ooy:d.includes('s')?ooy+ooh:ooy+ooh/2;
              return<circle key={d} cx={cx} cy={cy} r="5" fill="var(--rs)" stroke="var(--pnl)" strokeWidth="2"
                style={{cursor:d.length===2?d+'-resize':d==='n'||d==='s'?'ns-resize':'ew-resize'}}
                onMouseDown={e=>handleOuvDown(e,o,`r-${d}`)}/>;
            })}</g>})}
        {/* Clickable individual joints — between BASE grid panels */}
        {isActive&&zCalc.baseXBounds&&zCalc.baseXBounds.length>2&&<g clipPath={`url(#${clipId})`}>
          {zCalc.baseXBounds.slice(1,-1).map((bx,i)=>{
            const gw=(zCalc.jGapsH[i]||0)/1000*1000*ppZ;
            const gx=bx*1000*ppZ;
            const isCustom=(az.jointsH||[])[i]!=null;
            const vis=Math.max(gw,8);
            // Check if this joint is inside a merged panel (should be hidden)
            const isInsideMerge=(az.merges||[]).some(m=>{
              // Joint i is between col i and i+1
              // Hidden if BOTH cols are in same merge
              return i>=m.c1 && i<m.c2;  // col i and i+1 are both in [c1, c2]
            });
            if(isInsideMerge)return null;  // Hide joint between merged cells
            return<g key={`jh${i}`}>
              <rect x={gx-vis/2+gw/2} y={0} width={vis} height={fHpx}
                fill={isCustom?'rgba(251,191,36,.45)':gw>0.3?'rgba(251,191,36,.25)':'rgba(251,191,36,.08)'}
                stroke={isCustom?'rgba(251,191,36,.95)':gw>0.3?'rgba(251,191,36,.6)':'rgba(251,191,36,.2)'} strokeWidth={isCustom?2:.8}
                style={{cursor:'col-resize'}} rx="2"
                onMouseDown={e=>e.stopPropagation()}
                onClick={e=>{e.stopPropagation();
                  const cur=(az.jointsH||[])[i]!=null?(az.jointsH)[i]:(az.jointH||0);
                  const v=prompt(`Joint vertical #${i+1}\n(entre col ${i+1} et ${i+2})\n\nÉpaisseur en mm :`,cur);
                  if(v===null)return;const n=parseFloat(v);if(isNaN(n))return;
                  updateAZ(z=>{const jh=[...(z.jointsH||[])];while(jh.length<=i)jh.push(null);jh[i]=n;return{...z,jointsH:jh}})}}/>
              {vis>12&&<text x={gx} y={fHpx/2} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="600" fill="rgba(251,191,36,.9)" style={{pointerEvents:'none'}}>↔</text>}
            </g>})}
          {zCalc.baseYBounds&&zCalc.baseYBounds.slice(1,-1).map((by,i)=>{
            const gh=(zCalc.jGapsV[i]||0)/1000*1000*ppZ;
            const gy=by*1000*ppZ;
            const isCustom=(az.jointsV||[])[i]!=null;
            const vis=Math.max(gh,8);
            // Check if this joint is inside a merged panel (should be hidden)
            const isInsideMerge=(az.merges||[]).some(m=>{
              // Joint i is between row i and i+1
              // Hidden if BOTH rows are in same merge
              return i>=m.r1 && i<m.r2;  // row i and i+1 are both in [r1, r2]
            });
            if(isInsideMerge)return null;  // Hide joint between merged cells
            return<g key={`jv${i}`}>
              <rect x={0} y={gy-vis/2+gh/2} width={fWpx} height={vis}
                fill={isCustom?'rgba(251,191,36,.45)':gh>0.3?'rgba(251,191,36,.25)':'rgba(251,191,36,.08)'}
                stroke={isCustom?'rgba(251,191,36,.95)':gh>0.3?'rgba(251,191,36,.6)':'rgba(251,191,36,.2)'} strokeWidth={isCustom?2:.8}
                style={{cursor:'row-resize'}} rx="2"
                onMouseDown={e=>e.stopPropagation()}
                onClick={e=>{e.stopPropagation();
                  const cur=(az.jointsV||[])[i]!=null?(az.jointsV)[i]:(az.jointV||0);
                  const v=prompt(`Joint horizontal #${i+1}\n(entre ligne ${i+1} et ${i+2})\n\nÉpaisseur en mm :`,cur);
                  if(v===null)return;const n=parseFloat(v);if(isNaN(n))return;
                  updateAZ(z=>{const jv=[...(z.jointsV||[])];while(jv.length<=i)jv.push(null);jv[i]=n;return{...z,jointsV:jv}})}}/>
              {vis>12&&<text x={fWpx/2} y={gy} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="600" fill="rgba(251,191,36,.9)" style={{pointerEvents:'none'}}>↕</text>}
            </g>})}
        </g>}

        {/* Dims */}
        <text x={fWpx/2} y={-8} textAnchor="middle" fontSize="11" fontWeight="600" fill="var(--t2)" fontFamily="JetBrains Mono">{(z.L/1000).toFixed(2)} m</text>
        <text x={-8} y={fHpx/2} textAnchor="middle" fontSize="11" fontWeight="600" fill="var(--t2)" fontFamily="JetBrains Mono"
          transform={`rotate(-90,-8,${fHpx/2})`}>{(z.H/1000).toFixed(2)} m</text>
        {/* Zone label (drag handle) */}
        <g style={{cursor:'grab'}} onMouseDown={e=>handleZoneDragStart(e,idx)} onClick={!isActive?e=>{e.stopPropagation();setActiveZoneIdx(idx)}:undefined}>
          <rect x={0} y={fHpx+4} width={Math.max(80,Math.min(fWpx,140))} height={20} rx="4" fill={zColor} opacity={isActive?1:.6}/>
          <text x={8} y={fHpx+17} fontSize="10" fontWeight="700" fill="#fff" fontFamily="DM Sans">{I.move(8)} {z.name}</text>
          {!isActive&&<text x={Math.max(80,Math.min(fWpx,140))-6} y={fHpx+16} textAnchor="end" fontSize="9" fill="rgba(255,255,255,.7)">cliquer</text>}
        </g>
        {/* Resize handles on zone */}
        {isActive&&!z.poly&&['nw','n','ne','e','se','s','sw','w'].map(h=>{
          const cx=h.includes('w')?0:h.includes('e')?fWpx:fWpx/2;
          const cy=h.includes('n')?0:h.includes('s')?fHpx:fHpx/2;
          return<rect key={h} x={cx-5} y={cy-5} width={10} height={10} rx="2.5"
            fill={zColor} stroke="#fff" strokeWidth="1.5" opacity=".85"
            style={{cursor:h.length===2?h+'-resize':h==='n'||h==='s'?'ns-resize':'ew-resize'}}
            onMouseDown={e=>{e.stopPropagation();setResizeZone({idx,handle:h,startX:e.clientX,startY:e.clientY,origOrigin:{...z.facOrigin},origL:z.L,origH:z.H})}}/>})}
        {/* Rotation handle */}
        {isActive&&!z.poly&&<g>
          <line x1={fWpx/2} y1={-8} x2={fWpx/2} y2={-22} stroke={zColor} strokeWidth="1.5" opacity=".6"/>
          <circle cx={fWpx/2} cy={-26} r={7} fill={zColor} stroke="#fff" strokeWidth="1.5" opacity=".9"
            style={{cursor:'grab'}}
            onMouseDown={e=>{e.stopPropagation();
              const rect=cvRef.current.getBoundingClientRect();
              const ccx=ox+fWpx/2,ccy=oy+fHpx/2;
              const startAngle=Math.atan2(e.clientY-rect.top-ccy,e.clientX-rect.left-ccx)*180/Math.PI;
              setRotateZone({idx,startAngle,origRot:z.rot||0})}}/>
          <text x={fWpx/2} y={-22.5} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#fff" fontWeight="700" style={{pointerEvents:'none'}}>↻</text>
          {(z.rot||0)!==0&&<text x={fWpx/2+14} y={-26} fontSize="9" fill={zColor} fontWeight="600">{(z.rot||0).toFixed(1)}°</text>}
        </g>}
      </g>);
  };

  const cursor=isPanning?.mid?'grabbing':step==='calibrate'||step==='zone'?'crosshair':step==='work'&&(modeDraw||measureMode)?'crosshair':dragZone||resizeZone||rotateZone?'grabbing':'default';
  const Instructions=()=>{
    const msgs={calibrate:'Cliquez 2 points pour calibrer la distance.',
      zone:polyMode?`Mode polygone: cliquez les sommets (${polyPts.length} pts). ${polyPts.length>=3?'Cliquez pres du 1er point pour fermer.':''}`:
        'Dessinez les zones sur le plan.',
      work:measureMode?'Mode mesure: cliquez 2 points. M: quitter | Esc: annuler'
        :modeDraw?'Dessinez l\'ouverture (min 200x200mm)'
        :'Ctrl+C/V: copier/coller ouvertures | D: dessiner | M: mesurer | Del: supprimer'};
    const msg=msgs[step];if(!msg)return null;
    return<div className="px-4 py-2 text-xs font-medium flex items-center gap-2" style={{background:polyMode?'var(--gnd)':'var(--blg)',color:polyMode?'var(--gn)':'var(--bl)',borderBottom:'1px solid var(--bd)'}}>
      <span className="w-4 h-4 rounded-full flex items-center justify-center text-[10px] font-bold" style={{background:polyMode?'var(--gn)':'var(--bl)',color:'#fff'}}>i</span>{msg}
      {step==='zone'&&<div className="ml-auto flex gap-2">

        <button onClick={()=>{setPolyMode(!polyMode);setPolyPts([])}} className={`ba px-3 py-1 rounded-lg text-[11px] font-bold ${polyMode?'text-white':'text-[var(--gn)]'}`}
          style={{background:polyMode?'var(--gn)':'transparent',border:`1px solid ${polyMode?'var(--gn)':'var(--bd)'}` }}>
          {I.pen(12)} {polyMode?'Mode polygone':'Polygone'}</button>
        {zones.length>0&&<button onClick={goToWork} className="ba px-4 py-1 rounded-lg text-[11px] font-bold text-white" style={{background:'var(--bl)'}}>
          Continuer ({zones.length})</button>}
      </div>}
    </div>;
  };

  /* ── WELCOME ── */
  const Welcome=()=>(
    <div className="h-full w-full flex items-center justify-center relative overflow-hidden" style={{background:'linear-gradient(160deg,#f5f2ee,#efe8e0 40%,#f0e6e0 70%,#f5f2ee)'}}>
      {/* Animated bg */}
      <div style={{position:'absolute',inset:0,overflow:'hidden',pointerEvents:'none'}}>
        <svg width="100%" height="100%" style={{opacity:.03}}>
          {Array.from({length:20}).map((_,i)=><line key={`v${i}`} x1={`${i*5.2}%`} y1="0" x2={`${i*5.2}%`} y2="100%" stroke="#8b1a2b" strokeWidth=".5"/>)}
          {Array.from({length:14}).map((_,i)=><line key={`h${i}`} x1="0" y1={`${i*7.5}%`} x2="100%" y2={`${i*7.5}%`} stroke="#8b1a2b" strokeWidth=".5"/>)}
        </svg>
        <div style={{position:'absolute',top:'15%',left:'20%',width:220,height:220,borderRadius:'50%',background:'radial-gradient(circle,rgba(139,26,43,.05),transparent 70%)',animation:'float 7s ease-in-out infinite'}}/>
        <div style={{position:'absolute',bottom:'20%',right:'15%',width:160,height:160,borderRadius:'50%',background:'radial-gradient(circle,rgba(8,145,178,.04),transparent 70%)',animation:'float 5s ease-in-out infinite 2s'}}/>
        <div style={{position:'absolute',top:'50%',left:'50%',width:400,height:400,marginTop:-200,marginLeft:-200,borderRadius:'50%',background:'radial-gradient(circle,rgba(139,26,43,.03),transparent 60%)',animation:'float 9s ease-in-out infinite 1s'}}/>
      </div>
      <div className="flex flex-col items-center" style={{maxWidth:480,width:'100%',padding:'0 32px',textAlign:'center',position:'relative',zIndex:2}}>
        {/* Logo with orbiting dots + pulse rings */}
        <div className="wc-d0 mb-8 relative" style={{width:88,height:88}}>
          <div style={{position:'absolute',inset:-8,borderRadius:'50%',border:'1.5px solid rgba(139,26,43,.12)',animation:'pulse-ring 3s cubic-bezier(.215,.61,.355,1) infinite'}}/>
          <div style={{position:'absolute',inset:-8,borderRadius:'50%',border:'1.5px solid rgba(8,145,178,.08)',animation:'pulse-ring 3s cubic-bezier(.215,.61,.355,1) infinite',animationDelay:'1s'}}/>
          <div className="wc-logo flex items-center justify-center" style={{width:88,height:88,borderRadius:22,background:'linear-gradient(135deg,#8b1a2b,#a0243a,#c0392b)',boxShadow:'0 8px 40px rgba(139,26,43,.25),0 0 80px rgba(139,26,43,.08)',position:'relative',zIndex:1}}>
            <svg width="42" height="42" viewBox="0 0 40 40" fill="none"><rect x="3" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".95"/><rect x="23" y="3" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="3" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".75"/><rect x="23" y="23" width="14" height="14" rx="2.5" stroke="#fff" strokeWidth="2.5" opacity=".55"/></svg>
          </div>
          <div style={{position:'absolute',top:'50%',left:'50%',width:7,height:7,marginTop:-3.5,marginLeft:-3.5,borderRadius:'50%',background:'#0891b2',boxShadow:'0 0 10px #0891b2',animation:'orbit 8s linear infinite'}}/>
          <div style={{position:'absolute',top:'50%',left:'50%',width:5,height:5,marginTop:-2.5,marginLeft:-2.5,borderRadius:'50%',background:'#8b1a2b',boxShadow:'0 0 8px #8b1a2b',animation:'orbit 6s linear infinite reverse',animationDelay:'-2s'}}/>
        </div>
        <h1 className="wc-d1 text-3xl font-bold mb-2" style={{background:'linear-gradient(135deg,#2a1a1e,#8b1a2b)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',letterSpacing:'-0.02em'}}>Kalepin</h1>
        <p className="wc-d1 text-sm mb-1.5" style={{color:'var(--t2)'}}>Calepinage, découpe & visualisation 3D</p>
        <p className="wc-d1 text-[10px] mn mb-10" style={{color:'var(--t3)'}}>v16 — PDF fournisseur • Zones ajustables • Plan transparent</p>
        <div className="wc-d2 w-full" style={{marginBottom:24}}>
          <input ref={fileRef} type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.dxf" className="hidden" onChange={e=>{if(e.target.files[0])loadFile(e.target.files[0])}}/>
          <div className="drop p-6 flex items-center justify-center gap-5 rounded-2xl" onClick={()=>fileRef.current?.click()}
            onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])}}
            style={{background:'rgba(139,26,43,.03)',border:'2px dashed rgba(79,110,247,.2)',cursor:'pointer'}}>
            <div style={{width:48,height:48,borderRadius:14,background:'linear-gradient(135deg,rgba(139,26,43,.1),rgba(8,145,178,.06))',display:'flex',alignItems:'center',justifyContent:'center'}}>
              {I.up(28)}
            </div>
            <div className="text-left"><div className="text-sm font-semibold mb-1.5">Déposer un plan</div>
            <div className="flex gap-1.5">{['PDF','PNG','JPG','DXF'].map(t=><span key={t} className="px-2.5 py-0.5 rounded-md text-[10px] font-bold mn" style={{background:t==='DXF'?'rgba(8,145,178,.1)':'rgba(139,26,43,.08)',color:t==='DXF'?'#0891b2':'#8b1a2b'}}>{t}</span>)}</div></div>
          </div></div>
        <div className="wc-d3 flex items-center gap-3 mb-6 w-full"><div className="flex-1 h-px" style={{background:'var(--bd)'}}/><span className="text-[11px]" style={{color:'var(--t3)'}}>ou</span><div className="flex-1 h-px" style={{background:'var(--bd)'}}/></div>
        <button onClick={startManual} className="wc-d3 ba w-full py-3.5 rounded-xl text-sm font-semibold" 
          style={{background:'linear-gradient(135deg,#f0ece6,#e8e0d8)',border:'1px solid var(--bd2)',color:'var(--t1)',
            backgroundSize:'200% auto',transition:'all .3s'}}>
          Saisie manuelle des dimensions</button>
        <div className="wc-d4 flex flex-wrap justify-center gap-2.5 mt-10">
          {[{c:'#0891b2',t:'DXF/PDF',i:'📐'},{c:'#8b1a2b',t:'Découpe',i:'✂'},{c:'#a0243a',t:'3D & RAL',i:'🧊'},{c:'#0d9488',t:'Métré',i:'📊'}].map(f=>
            <div key={f.t} className="px-3.5 py-2 rounded-xl text-center" style={{background:`color-mix(in srgb,${f.c} 8%,transparent)`,border:`1px solid color-mix(in srgb,${f.c} 15%,transparent)`}}>
              <div className="text-[10px] font-bold" style={{color:f.c}}>{f.i} {f.t}</div></div>)}
        </div>
      </div></div>);

  /* ── COUPE CASSETTE POPUP ── */
  const CoupePopup=({ouvIdx,onClose})=>{
    if(ouvIdx===null||!az)return null;
    const o=az.ouvs[ouvIdx];if(!o)return null;
    const r=o.retours||{tG:150,tD:150,lin:150,app:150};
    const fv=o.faceVis||50;
    const sides=[{key:'tG',label:'Tableau G',ret:r.tG,color:'#8b5cf6',L:o.h},
      {key:'tD',label:'Tableau D',ret:r.tD,color:'#8b5cf6',L:o.h},
      {key:'lin',label:'Linteau',ret:r.lin,color:'#0891b2',L:o.w},
      {key:'app',label:'Appui',ret:r.app,color:'#0d9488',L:o.w}];
    const upR=(key,val)=>updateAZ(z=>({...z,ouvs:z.ouvs.map((oo,i)=>i===ouvIdx?{...oo,retours:{...(oo.retours||{tG:150,tD:150,lin:150,app:150}),[key]:val}}:oo)}));
    const upFV=(val)=>updateAZ(z=>({...z,ouvs:z.ouvs.map((oo,i)=>i===ouvIdx?{...oo,faceVis:val}:oo)}));
    const drawSec=(ret,fvv,color)=>{
      const sc2=0.3,mg2=25;const retS=ret*sc2,fvS=fvv*sc2;
      const sx=mg2+15,sy=mg2+10;
      return<svg viewBox="0 0 200 110" style={{width:'100%',height:90}}>
        <rect x={sx-8} y={sy} width={10} height={retS+8} fill="#ccc" opacity="0.25" rx="1"/>
        <rect x={sx+2} y={sy} width={8} height={retS+8} fill="#f0c020" opacity="0.12"/>
        <polyline points={`${sx+fvS},${sy-3} ${sx},${sy-3} ${sx},${sy+retS} ${sx+3},${sy+retS} ${sx+3},${sy} ${sx+fvS},${sy}`}
          fill="none" stroke={color} strokeWidth="2.5" strokeLinejoin="round"/>
        <line x1={sx} y1={sy-12} x2={sx+fvS} y2={sy-12} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx} y1={sy-15} x2={sx} y2={sy-9} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx+fvS} y1={sy-15} x2={sx+fvS} y2={sy-9} stroke="#888" strokeWidth="0.4"/>
        <text x={(sx+sx+fvS)/2} y={sy-14} fontSize="7" fill="#555" textAnchor="middle" fontFamily="monospace">{fvv}</text>
        <line x1={sx-16} y1={sy} x2={sx-16} y2={sy+retS} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx-19} y1={sy} x2={sx-13} y2={sy} stroke="#888" strokeWidth="0.4"/>
        <line x1={sx-19} y1={sy+retS} x2={sx-13} y2={sy+retS} stroke="#888" strokeWidth="0.4"/>
        <text x={sx-17} y={sy+retS/2+3} fontSize="7" fill="#555" textAnchor="middle" fontFamily="monospace" transform={`rotate(-90,${sx-17},${sy+retS/2+3})`}>{ret}</text>
        <text x={140} y={sy+retS/2} fontSize="10" fill={color} fontWeight="bold" fontFamily="monospace">Dev: {ret+fvv+10}</text>
        <text x={140} y={sy+retS/2+12} fontSize="7" fill="#999">({ret}+{fvv}+10mm pli)</text>
      </svg>
    };
    return<div className="ov" onClick={onClose}><div className="mbx" style={{maxWidth:580,minWidth:460}} onClick={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3">
        <div><div className="text-base font-bold" style={{color:'var(--t1)'}}>Coupe cassette pliée</div>
          <div className="text-xs" style={{color:'var(--t3)'}}>O{ouvIdx+1} — {o.w}x{o.h}mm</div></div>
        <button onClick={onClose} className="ba w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>x</button>
      </div>
      <div className="flex items-center gap-3 mb-3 p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
        <span className="text-[10px] font-bold" style={{color:'var(--t2)'}}>Face visible</span>
        <input type="range" className="rng flex-1" min={10} max={200} step={5} value={fv} onChange={e=>upFV(parseInt(e.target.value))}/>
        <input type="number" value={fv} onChange={e=>upFV(parseInt(e.target.value)||50)}
          className="w-14 px-2 py-1 rounded text-center text-xs mn font-bold idark" onKeyDown={e=>e.stopPropagation()}/>
        <span className="text-[9px]" style={{color:'var(--t3)'}}>mm</span>
      </div>
      <div className="grid grid-cols-2 gap-2">
        {sides.map(s=><div key={s.key} className="p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
          <div className="flex items-center gap-2 mb-1">
            <span className="text-[10px] font-bold" style={{color:s.color}}>{s.label}</span>
            <input type="number" value={s.ret} onChange={e=>upR(s.key,parseInt(e.target.value)||0)}
              className="w-14 px-2 py-1 rounded text-center text-xs mn font-bold idark ml-auto" onKeyDown={e=>e.stopPropagation()}/>
            <span className="text-[9px]" style={{color:'var(--t3)'}}>mm</span>
          </div>
          {drawSec(s.ret,fv,s.color)}
          <div className="flex justify-between mt-1 text-[9px]">
            <span style={{color:s.color}}>L={s.L}mm</span>
            <span className="mn font-bold" style={{color:s.color}}>S={(s.L*(s.ret+fv+10)/1e6).toFixed(3)} m²</span>
          </div>
        </div>)}
      </div>
      <div className="mt-3 p-2 rounded-lg text-center" style={{background:'rgba(139,26,43,.05)',border:'1px solid rgba(139,26,43,.12)'}}>
        <span className="text-sm font-bold" style={{color:'var(--bl)'}}>Total: </span>
        <span className="mn text-sm font-bold" style={{color:'var(--bl)'}}>
          {((r.tG+fv+10)*o.h/1e6+(r.tD+fv+10)*o.h/1e6+(r.lin+fv+10)*o.w/1e6+(r.app+fv+10)*o.w/1e6).toFixed(3)} m²
        </span>
        <span className="text-xs ml-2" style={{color:'var(--t3)'}}>
          ({((r.tG+fv+10)*o.h/1e3+(r.tD+fv+10)*o.h/1e3+(r.lin+fv+10)*o.w/1e3+(r.app+fv+10)*o.w/1e3).toFixed(2)} ml dév.)
        </span>
      </div>
    </div></div>
  };

  /* ── MAIN RENDER ── */
  return(
    <div className="h-full flex flex-col">
      {/* ── LIGNE 1 : Logo + projet + outils ── */}
      <div className="flex items-center px-3 flex-shrink-0" style={{height:44,borderBottom:step==='work'?'none':'1px solid var(--bd)',background:'var(--pnl)'}}>
        <div className="flex items-center gap-2 flex-shrink-0">
          <div className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'linear-gradient(135deg,#8b1a2b,#a0243a)'}}>
            <svg width="14" height="14" viewBox="0 0 40 40" fill="none"><rect x="3" y="3" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="23" y="3" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="3" y="23" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/><rect x="23" y="23" width="14" height="14" rx="2" stroke="#fff" strokeWidth="3"/></svg>
          </div><span className="font-bold text-sm">Kalepin</span></div>
        {step==='work'&&<>
          <div className="mx-2 h-5 w-px flex-shrink-0" style={{background:'var(--bd)'}}/>
          <input type="text" value={projectName} onChange={e=>setProjectName(e.target.value)} className="bg-transparent border-none outline-none text-sm font-medium flex-shrink-0" style={{color:'var(--t2)',width:130}} onKeyDown={e=>e.stopPropagation()}/>
          <div className="flex gap-1 ml-1 flex-shrink-0">
            <button onClick={saveProject} className="ba px-2 py-1 rounded text-[9px] font-bold"
              style={{background:'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}
              title="Sauvegarder le projet (JSON)">💾 Sauver</button>
            <label className="ba px-2 py-1 rounded text-[9px] font-bold cursor-pointer"
              style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}
              title="Charger un projet sauvegardé">
              📂 Charger<input type="file" accept=".json" className="hidden" onChange={e=>{if(e.target.files[0])loadProject(e.target.files[0]);e.target.value=''}}/></label>
          </div>
          {/* ── ONGLETS ── */}
          <div className="flex-1 min-w-0 mx-2 self-stretch flex items-end">
            <div className="ztab-bar border-b w-full" style={{borderColor:'var(--bd)'}}>
              {zones.map((z,i)=>(
                <div key={z.id} className={`ztab ${i===activeZoneIdx?'on':''}`}
                  style={i===activeZoneIdx?{borderColor:'var(--bd)',color:ZONE_COLORS[i%8],background:'var(--pnl)'}:{color:'var(--t2)'}}
                  onClick={()=>{if(renamingTab===i)return;
                    // Sauvegarder la vue de la zone courante
                    if(az)saveView(az.id,zoom,pan);
                    setActiveZoneIdx(i);setSelId(null);setSelIds(new Set());setShowAlignPanel(false);
                    // Restaurer la vue de la zone cible (après le setState)
                    const targetZone=zones[i];
                    setTimeout(()=>{
                      const saved=viewStatesRef.current[targetZone.id];
                      if(saved){setZoom(saved.zoom);setPan(saved.pan);}
                      else{// Première visite de cet onglet — autofit sur cette zone seule
                        if(cvRef.current){const rect=cvRef.current.getBoundingClientRect();
                          const w=targetZone.L*pxPerMm_eff,h=targetZone.H*pxPerMm_eff;
                          const nz=Math.min((rect.width-80)/w,(rect.height-80)/h,5);
                          const np={x:(rect.width-w*nz)/2-targetZone.facOrigin.x*nz+targetZone.facOrigin.x*nz,
                            y:(rect.height-h*nz)/2-targetZone.facOrigin.y*nz+targetZone.facOrigin.y*nz};
                          // Simple centering on this zone
                          const cx=targetZone.facOrigin.x*nz+np.x,cy=targetZone.facOrigin.y*nz+np.y;
                          setZoom(nz);setPan({x:rect.width/2-targetZone.facOrigin.x*nz-w*nz/2,y:rect.height/2-targetZone.facOrigin.y*nz-h*nz/2});
                        }
                      }
                    },0);
                  }}
                  onDoubleClick={()=>setRenamingTab(i)}>
                  <span className="inline-block w-2 h-2 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8],opacity:i===activeZoneIdx?1:.6}}/>
                  {renamingTab===i
                    ? <input autoFocus className="bg-transparent border-none outline-none font-semibold text-[10px]"
                        style={{color:ZONE_COLORS[i%8],width:Math.max(40,z.name.length*7)+'px'}}
                        defaultValue={z.name}
                        onBlur={e=>{updateZone(i,z=>({...z,name:e.target.value||z.name}));setRenamingTab(null)}}
                        onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'||e.key==='Escape'){e.target.blur()}}}
                        onClick={e=>e.stopPropagation()}/>
                    : <span className="truncate" style={{maxWidth:110}}>{z.name}</span>
                  }
                  {zones.length>1&&<span className="ztab-close" onClick={e=>{e.stopPropagation();
                    if(!confirm(`Supprimer la zone "${z.name}" ?`))return;
                    setZones(zs=>zs.filter((_,j)=>j!==i));
                    setActiveZoneIdx(i===0?0:Math.min(i-1,zones.length-2));
                  }}>✕</span>}
                </div>
              ))}
              <div className="ztab-add" title="Ajouter une zone (sans plan)" style={{marginBottom:1}}
                onClick={()=>{
                  const newZ={id:Date.now(),name:`Zone ${zones.length+1}`,
                    L:3000,H:2800,facOrigin:{x:(zones.length%4)*120+40,y:(Math.floor(zones.length/4))*100+30},
                    pan_:{l:2000,w:600,nom:''},vert:true,oss:{eM:600,eL:1200},
                    ouvs:[],offX:0,offY:0,rot:0,jointH:0,jointV:0,jointsH:[],jointsV:[],colWidths:[],rowHeights:[],exclusions:[]};
                  setZones(prev=>[...prev,newZ]);setActiveZoneIdx(zones.length);setStep('work');setTimeout(autoFit,150);
                }}>＋</div>
            </div>
          </div>
          {/* ── OUTILS DROITE ── */}
          <div className="flex items-center gap-1.5 flex-shrink-0">
            {bgSrc&&<div className="flex items-center gap-1.5 flex-shrink-0"><label className="text-[10px] flex-shrink-0" style={{color:'var(--t3)'}}>Plan</label>
              <input type="checkbox" checked={bgVis} onChange={e=>setBgVis(e.target.checked)}/><input type="range" min="5" max="90" value={bgOp*100} onChange={e=>setBgOp(e.target.value/100)} className="rng w-12"/></div>}
            <button onClick={runOptimize} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'var(--ppd)',border:'1px solid rgba(167,139,250,.3)',color:'var(--pp)'}}>{I.opt(12)} Optimiser</button>
            <select value={snapMode} onChange={e=>setSnapMode(e.target.value)} className="idark text-[10px] px-1.5 py-1 rounded-lg flex-shrink-0" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)',width:62}}>
              <option value="free">Libre</option><option value="grid">Grille</option><option value="oss">Ossature</option>
            </select>
            {snapMode==='grid'&&<select value={gridSize} onChange={e=>setGridSize(Number(e.target.value))} className="idark text-[10px] px-1 py-1 rounded-lg flex-shrink-0" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)',width:48}}>
              {[1,5,10,25,50,100].map(v=><option key={v} value={v}>{v}mm</option>)}
            </select>}
            <button onClick={()=>{setMeasureMode(v=>!v);if(!measureMode)setModeDraw(false);setMeasurePts([])}}
              className={`ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0 ${measureMode?'apg':''}`}
              style={{background:measureMode?'rgba(245,158,11,.15)':'var(--inp)',border:`1px solid ${measureMode?'#f59e0b':'var(--bd)'}`,color:measureMode?'#f59e0b':'var(--t2)'}}>📏</button>
            {measures.length>0&&<button onClick={()=>setMeasures([])} className="text-[9px] px-1.5 py-1 rounded flex-shrink-0" style={{color:'var(--rs)'}}>✕ {measures.length}</button>}
            <button onClick={()=>setMetreOpen(true)} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Métré</button>
            <button onClick={()=>setRightTab('ral')} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0"
              style={{background:rightTab==='ral'?'rgba(167,139,250,.2)':'transparent',border:`1px solid ${rightTab==='ral'?'var(--pp)':'rgba(167,139,250,.2)'}`,color:'var(--pp)'}}>
              <div style={{width:12,height:12,borderRadius:3,background:RAL_COLORS[ralIdx]?.hex,border:'1px solid rgba(255,255,255,.2)'}}/>{RAL_COLORS[ralIdx]?.code}</button>
            <button onClick={()=>setShow3D(v=>!v)} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0"
              style={{background:show3D?'rgba(167,139,250,.2)':'rgba(167,139,250,.08)',border:`1px solid ${show3D?'var(--pp)':'rgba(167,139,250,.25)'}`,color:'var(--pp)'}}>
              🧊 {show3D?'2D':'3D'}</button>
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setExpSel(s);setExpMod(true)}} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>{I.prn(12)} PDF</button>
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s);setXlsxExpMod(true)}} className="ba flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-medium flex-shrink-0" style={{background:'rgba(52,211,153,.1)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Excel</button>
          </div>
        </>}
      </div>
      {/* ══ BARRE MULTI-SÉLECTION OUVERTURES ══ */}
      {step==='work'&&selIds.size>0&&az&&(()=>{
        const selOuvs=az.ouvs.filter(o=>selIds.has(o.id));
        const doAlign=(axis)=>{
          // Always work with fresh data inside updateAZ
          updateAZ(zone=>{
            const sel=zone.ouvs.filter(o=>selIds.has(o.id));
            if(sel.length<2)return zone;
            const xs=sel.map(o=>o.x),ys=sel.map(o=>o.y);
            const x2s=sel.map(o=>o.x+o.w),y2s=sel.map(o=>o.y+o.h);
            const minX=Math.min(...xs),maxX2=Math.max(...x2s);
            const minY=Math.min(...ys),maxY2=Math.max(...y2s);
            const map={};
            if(axis==='left')    sel.forEach(o=>{map[o.id]={x:minX};});
            else if(axis==='right')  sel.forEach(o=>{map[o.id]={x:maxX2-o.w};});
            else if(axis==='centerH')sel.forEach(o=>{map[o.id]={x:(minX+maxX2)/2-o.w/2};});
            else if(axis==='top')    sel.forEach(o=>{map[o.id]={y:minY};});
            else if(axis==='bottom') sel.forEach(o=>{map[o.id]={y:maxY2-o.h};});
            else if(axis==='centerV')sel.forEach(o=>{map[o.id]={y:(minY+maxY2)/2-o.h/2};});
            else if(axis==='distH'){
              const sorted=[...sel].sort((a,b)=>a.x-b.x);
              if(sorted.length<3)return zone;// need 3+ for distribution
              const totalW=sorted.reduce((a,o)=>a+o.w,0);
              const totalGap=maxX2-minX-totalW;
              const gap=totalGap/(sorted.length-1);
              let cx=sorted[0].x;
              sorted.forEach(o=>{map[o.id]={x:Math.round(cx)};cx+=o.w+gap;});
            }
            else if(axis==='distV'){
              const sorted=[...sel].sort((a,b)=>a.y-b.y);
              if(sorted.length<3)return zone;
              const totalH=sorted.reduce((a,o)=>a+o.h,0);
              const totalGap=maxY2-minY-totalH;
              const gap=totalGap/(sorted.length-1);
              let cy=sorted[0].y;
              sorted.forEach(o=>{map[o.id]={y:Math.round(cy)};cy+=o.h+gap;});
            }
            const newOuvs=zone.ouvs.map(o=>{
              if(!map[o.id])return o;
              const nx='x' in map[o.id]?Math.max(0,Math.min(map[o.id].x,zone.L-o.w)):o.x;
              const ny='y' in map[o.id]?Math.max(0,Math.min(map[o.id].y,zone.H-o.h)):o.y;
              return{...o,x:nx,y:ny};
            });
            return{...zone,ouvs:newOuvs};
          });
        };
        // SVG alignment icons
        const AlignIcon=({type})=>{
          const sq=(x,y,w=18,h=18,fill='#8b1a2b')=><rect x={x} y={y} width={w} height={h} rx="2" fill={fill}/>;
          const line=(x1,y1,x2,y2)=><line x1={x1} y1={y1} x2={x2} y2={y2} stroke="#8b1a2b" strokeWidth="2" strokeDasharray="3,2"/>;
          const s=28;
          if(type==='left')   return<svg width={s} height={s} viewBox="0 0 28 28">{line(6,2,6,26)}{sq(7,4,8,8,'#8b1a2b')}{sq(7,11,14,6,'rgba(139,26,43,.4)')}{sq(7,18,10,7,'rgba(139,26,43,.6)')}</svg>;
          if(type==='right')  return<svg width={s} height={s} viewBox="0 0 28 28">{line(22,2,22,26)}{sq(6,4,14,8,'rgba(139,26,43,.4)')}{sq(12,13,8,6,'#8b1a2b')}{sq(9,20,11,6,'rgba(139,26,43,.6)')}</svg>;
          if(type==='cH')     return<svg width={s} height={s} viewBox="0 0 28 28">{line(14,2,14,26)}{sq(6,4,16,7,'rgba(139,26,43,.4)')}{sq(9,12,10,7,'#8b1a2b')}{sq(7,20,14,6,'rgba(139,26,43,.6)')}</svg>;
          if(type==='top')    return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,6,26,6)}{sq(4,7,8,10,'#8b1a2b')}{sq(15,7,9,16,'rgba(139,26,43,.4)')}</svg>;
          if(type==='bottom') return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,22,26,22)}{sq(4,6,8,16,'rgba(139,26,43,.4)')}{sq(15,12,9,10,'#8b1a2b')}</svg>;
          if(type==='cV')     return<svg width={s} height={s} viewBox="0 0 28 28">{line(2,14,26,14)}{sq(4,5,8,18,'rgba(139,26,43,.4)')}{sq(15,8,9,12,'#8b1a2b')}</svg>;
          if(type==='dH')     return<svg width={s} height={s} viewBox="0 0 28 28"><text x="14" y="18" textAnchor="middle" fontSize="14" fill="#8b1a2b" fontWeight="bold">⇿</text></svg>;
          if(type==='dV')     return<svg width={s} height={s} viewBox="0 0 28 28"><text x="14" y="18" textAnchor="middle" fontSize="14" fill="#8b1a2b" fontWeight="bold">⇳</text></svg>;
          return null;
        };
        const AB2=(type,label,fn,disabled=false)=>(
          <button key={type} title={label} onClick={disabled?undefined:fn} disabled={disabled}
            className="ba flex flex-col items-center gap-0.5 px-1.5 py-1 rounded"
            style={{background:'rgba(139,26,43,.07)',border:'1px solid rgba(139,26,43,.2)',color:'var(--bl)',opacity:disabled?.35:1,cursor:disabled?'not-allowed':'pointer',minWidth:34}}>
            <AlignIcon type={type}/>
            <span style={{fontSize:7,color:'var(--t3)',lineHeight:1}}>{label}</span>
          </button>
        );
        return(
          <div className="flex-shrink-0" style={{borderBottom:'1px solid rgba(139,26,43,.2)'}}>
            {/* Ligne 1 : info + actions basiques */}
            <div className="flex items-center gap-2 px-3 py-1" style={{background:'rgba(139,26,43,.06)'}}>
              <span className="text-[11px] font-bold" style={{color:'var(--bl)'}}>{selIds.size} ouverture{selIds.size>1?'s':''} sélectionnée{selIds.size>1?'s':''}</span>
              <span className="text-[9px] opacity-50" style={{color:'var(--t2)'}}>Ctrl+clic · Maj+clic · Lasso · Glisser=déplacer</span>
              <div className="flex-1"/>
              <button onClick={()=>setShowAlignPanel(v=>!v)}
                className="ba flex items-center gap-1 px-2 py-1 rounded text-[9px] font-bold"
                style={{background:showAlignPanel?'rgba(139,26,43,.2)':'rgba(139,26,43,.08)',border:'1px solid rgba(139,26,43,.3)',color:'var(--bl)'}}>
                ⊹ Aligner <span className="opacity-50 ml-0.5">Ctrl+A</span>
              </button>
              <button onClick={()=>{const dx=parseInt(prompt('Décalage X (mm):','0')||'0'),dy=parseInt(prompt('Décalage Y (mm):','0')||'0');updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>selIds.has(o.id)?{...o,x:Math.max(0,Math.min(o.x+(dx||0),z.L-o.w)),y:Math.max(0,Math.min(o.y+(dy||0),z.H-o.h))}:o)}));}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>↔ Décaler</button>
              <button onClick={()=>{const dw=parseInt(prompt('Largeur mm (0=inchangé):','0')||'0'),dh=parseInt(prompt('Hauteur mm (0=inchangé):','0')||'0');updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>selIds.has(o.id)?{...o,...(dw>0?{w:dw}:{}),...(dh>0?{h:dh}:{})}:o)}));}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⤡ Resize</button>
              <button onClick={()=>{updateAZ(z=>({...z,ouvs:z.ouvs.filter(o=>!selIds.has(o.id))}));setSelIds(new Set());setShowAlignPanel(false);}}
                className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>🗑</button>
              <button onClick={()=>{setSelIds(new Set());setShowAlignPanel(false);}} className="ba px-2 py-1 rounded text-[9px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t3)'}}>✕</button>
            </div>
            {/* Ligne 2 : alignement */}
            {showAlignPanel&&selIds.size>=2&&(
              <div className="flex items-center gap-1 px-3 py-1.5" style={{background:'rgba(139,26,43,.04)',borderTop:'1px solid rgba(139,26,43,.12)'}}>
                <span className="text-[8px] font-bold mr-0.5" style={{color:'var(--t3)'}}>ALIGNER</span>
                {AB2('left','Gauche',()=>doAlign('left'))}
                {AB2('cH','Centrer H',()=>doAlign('centerH'))}
                {AB2('right','Droite',()=>doAlign('right'))}
                <div className="w-px h-6 mx-0.5" style={{background:'rgba(139,26,43,.2)'}}/>
                {AB2('top','Haut',()=>doAlign('top'))}
                {AB2('cV','Centrer V',()=>doAlign('centerV'))}
                {AB2('bottom','Bas',()=>doAlign('bottom'))}
                <div className="w-px h-6 mx-0.5" style={{background:'rgba(139,26,43,.2)'}}/>
                <span className="text-[8px] font-bold mr-0.5" style={{color:'var(--t3)'}}>DISTRIBUER</span>
                {AB2('dH','Horiz.',()=>doAlign('distH'),selIds.size<3)}
                {AB2('dV','Vert.',()=>doAlign('distV'),selIds.size<3)}
                {selIds.size<3&&<span className="text-[8px] opacity-40 ml-1" style={{color:'var(--t3)'}}>3 min. pour distribuer</span>}
              </div>
            )}
          </div>
        );
      })()}
      {/* ══ BARRE FUSION PANNEAUX ══ */}
      {step==='work'&&mergeSrc&&az&&(
        <div className="flex items-center gap-2 px-3 py-1.5 flex-shrink-0" style={{background:'rgba(139,92,246,.12)',borderBottom:'1px solid rgba(139,92,246,.3)'}}>
          <span className="text-[11px] font-bold" style={{color:'var(--pp)'}}>⊞ Mode fusion panneaux actif</span>
          <span className="text-[9px] opacity-70" style={{color:'var(--pp)'}}>Cliquez deux panneaux adjacents à fusionner · Ctrl+E ou Échap pour annuler</span>
          <div className="flex-1"/>
          <button onClick={()=>setMergeSrc(null)} className="ba px-2 py-1 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.2)',border:'1px solid rgba(139,92,246,.4)',color:'var(--pp)'}}>✕ Annuler</button>
        </div>
      )}
      <div className="flex-1 flex min-h-0">
        {step==='welcome'&&<Welcome/>}
        {/* LEFT */}
        {step==='work'&&az&&(
          <div className="w-[250px] flex-shrink-0 border-r flex flex-col" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex-1 overflow-y-auto p-2.5 space-y-2">
              <div className="cd p-2.5"><TI label="Zone" value={az.name} onChange={v=>updateAZ(z=>({...z,name:v}))}/>
                <div className="grid grid-cols-2 gap-1.5 mt-2">
                  <NI compact label="L mm" value={az.L} onChange={v=>updateAZ(z=>({...z,L:v}))} unit="mm"/>
                  <NI compact label="H mm" value={az.H} onChange={v=>updateAZ(z=>({...z,H:v}))} unit="mm"/>
                </div>
                {az.poly&&<div className="text-[9px] mt-1 px-1 py-0.5 rounded" style={{background:'var(--ppd)',color:'var(--pp)'}}>Polygone {az.poly.length} pts</div>}
                <div className="flex gap-1.5 mt-2">
                  <button onClick={()=>{const cz=JSON.parse(JSON.stringify(az));cz.id=Date.now();cz.name=az.name+' (copie)';
                    cz.facOrigin={x:az.facOrigin.x+30/zoom,y:az.facOrigin.y+30/zoom};
                    setZones(zs=>[...zs,cz]);setActiveZoneIdx(zones.length)}}
                    className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg flex items-center justify-center gap-1" style={{background:'var(--blg)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⧉ Dupliquer</button>
                  {zones.length>1&&<button onClick={()=>{setZones(zs=>zs.filter((_,i)=>i!==activeZoneIdx));setActiveZoneIdx(Math.max(0,activeZoneIdx-1))}}
                    className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>Supprimer</button>}
                </div>
              </div>
              <Sec icon={I.grid()} title="Panneau" color="var(--bl)">
                <div className="space-y-2">
                  <div className="grid grid-cols-2 gap-1 max-h-24 overflow-y-auto">{presPan.map((p,i)=>(
                    <div key={p.n+i} className="relative group">
                      <button onClick={()=>updateAZ(z=>({...z,pan_:{l:p.l,w:p.w,nom:p.n}}))} className={`pb truncate w-full ${az.pan_.nom===p.n?'on':''}`}>{p.n}<span className="block text-[8px] opacity-60">{p.l}x{p.w}</span></button>
                      {i>=DP.length&&<button onClick={()=>setPresPan(ps=>ps.filter((_,j)=>j!==i))} className="absolute -top-1 -right-1 w-3.5 h-3.5 rounded-full flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100 transition-opacity" style={{background:'var(--rs)',color:'#fff',lineHeight:1}}>×</button>}
                    </div>))}</div>
                  <button onClick={()=>{
                    const nom=prompt('Nom du panneau :');if(!nom)return;
                    const l=parseInt(prompt('Longueur (mm) :','2000'));if(!l||isNaN(l))return;
                    const w=parseInt(prompt('Largeur (mm) :','600'));if(!w||isNaN(w))return;
                    const np={n:nom,l,w};setPresPan(ps=>[...ps,np]);updateAZ(z=>({...z,pan_:{l,w,nom}}))
                  }} className="ba w-full py-1.5 rounded-lg text-[10px] font-medium flex items-center justify-center gap-1" style={{background:'var(--blg)',border:'1px dashed var(--bl)',color:'var(--bl)'}}>+ Créer un panneau</button>
                  <NI label="Longueur" value={az.pan_.l} onChange={v=>updateAZ(z=>({...z,pan_:{...z.pan_,l:v,nom:''}}))} unit="mm"/>
                  <NI label="Largeur" value={az.pan_.w} onChange={v=>updateAZ(z=>({...z,pan_:{...z.pan_,w:v,nom:''}}))} unit="mm"/>
                  <div className="flex gap-1.5">{[true,false].map(v=><button key={String(v)} onClick={()=>updateAZ(z=>({...z,vert:v}))} className="ba flex-1 py-1.5 text-[10px] font-medium rounded-lg"
                    style={{background:az.vert===v?'var(--blg)':'var(--inp)',border:`1px solid ${az.vert===v?'var(--bl)':'var(--bd)'}`,color:az.vert===v?'var(--bl)':'var(--t3)'}}>{v?'Vertical':'Horizontal'}</button>)}</div>
                  <div className="grid grid-cols-2 gap-1.5">
                    <NI compact label="Decal. X" value={az.offX||0} onChange={v=>updateAZ(z=>({...z,offX:v}))} unit="mm" step={50} min={0}/>
                    <NI compact label="Decal. Y" value={az.offY||0} onChange={v=>updateAZ(z=>({...z,offY:v}))} unit="mm" step={50} min={0}/>
                  </div>
                  {/* Joint gaps — default + individual */}
                  <div className="grid grid-cols-2 gap-1.5">
                    <NI compact label="Joint H défaut" value={az.jointH||0} onChange={v=>updateAZ(z=>({...z,jointH:v}))} unit="mm" step={1} min={0}/>
                    <NI compact label="Joint V défaut" value={az.jointV||0} onChange={v=>updateAZ(z=>({...z,jointV:v}))} unit="mm" step={1} min={0}/>
                  </div>
                  {(az.jointsH?.some(v=>v!=null)||az.jointsV?.some(v=>v!=null))&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-[9px] font-bold" style={{color:'var(--am)'}}>Joints individuels</span>
                      <button onClick={()=>updateAZ(z=>({...z,jointsH:[],jointsV:[]}))} className="text-[8px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>Reset tout</button>
                    </div>
                    {az.jointsH?.some(v=>v!=null)&&<div className="text-[9px] mb-1" style={{color:'var(--t3)'}}>
                      V: {az.jointsH.map((v,i)=>v!=null?`#${i+1}:${v}mm`:null).filter(Boolean).join(', ')}</div>}
                    {az.jointsV?.some(v=>v!=null)&&<div className="text-[9px]" style={{color:'var(--t3)'}}>
                      H: {az.jointsV.map((v,i)=>v!=null?`#${i+1}:${v}mm`:null).filter(Boolean).join(', ')}</div>}
                    <div className="text-[8px] mt-1" style={{color:'var(--am)',fontStyle:'italic'}}>💡 Cliquez sur un joint (ligne orange) dans le plan pour ajuster son épaisseur</div>
                  </div>}
                  {/* Per-column / Per-row sizes */}
                  {C&&C.nC>0&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-[9px] font-bold" style={{color:'var(--cy)'}}>Largeurs colonnes (mm)</span>
                      <button onClick={()=>updateAZ(z=>({...z,colWidths:[]}))} className="text-[8px]" style={{color:'var(--t3)'}}>Reset</button>
                    </div>
                    <div className="flex flex-wrap gap-1 max-h-[200px] overflow-y-auto">{Array.from({length:C.nC}).map((_,ci)=>{
                      const defW=Math.round((az.vert?az.pan_.w:az.pan_.l));
                      const curW=(az.colWidths||[])[ci]||defW;
                      return<input key={ci} type="number" value={curW}
                        onChange={e=>{const v=parseInt(e.target.value)||defW;
                          updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=ci)cw.push(0);cw[ci]=v;return{...z,colWidths:cw}})}}
                        className="idark text-center mn w-12 py-0.5 rounded text-[9px]"
                        style={{borderColor:((az.colWidths||[])[ci]&&(az.colWidths||[])[ci]!==defW)?'var(--cy)':'var(--bd)'}}
                        title={`Col ${ci+1}`}/>})}</div>
                  </div>}
                  {C&&C.nR>0&&<div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-[9px] font-bold" style={{color:'var(--pp)'}}>Hauteurs lignes (mm)</span>
                      <button onClick={()=>updateAZ(z=>({...z,rowHeights:[]}))} className="text-[8px]" style={{color:'var(--t3)'}}>Reset</button>
                    </div>
                    <div className="flex flex-wrap gap-1 max-h-[200px] overflow-y-auto">{Array.from({length:C.nR}).map((_,ri)=>{
                      const defH=Math.round((az.vert?az.pan_.l:az.pan_.w));
                      const curH=(az.rowHeights||[])[ri]||defH;
                      return<input key={ri} type="number" value={curH}
                        onChange={e=>{const v=parseInt(e.target.value)||defH;
                          updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=ri)rh.push(0);rh[ri]=v;return{...z,rowHeights:rh}})}}
                        className="idark text-center mn w-12 py-0.5 rounded text-[9px]"
                        style={{borderColor:((az.rowHeights||[])[ri]&&(az.rowHeights||[])[ri]!==defH)?'var(--pp)':'var(--bd)'}}
                        title={`Ligne ${ri+1}`}/>})}</div>
                  </div>}
                  <div className="flex items-center gap-2">
                    <NI compact label="Rotation" value={az.rot||0} onChange={v=>updateAZ(z=>({...z,rot:v}))} unit="°" step={0.5} min={-45} max={45}/>
                    <input type="range" min="-45" max="45" step="0.5" value={az.rot||0} onChange={e=>updateAZ(z=>({...z,rot:parseFloat(e.target.value)}))} className="rng flex-1"/>
                    {(az.rot||0)!==0&&<button onClick={()=>updateAZ(z=>({...z,rot:0}))} className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>0°</button>}
                  </div>
                </div></Sec>
              <Sec icon={I.frame()} title="Ossature" color="var(--am)" dO={false}><div className="space-y-2">
                <NI label="Entraxe montants" value={az.oss.eM} onChange={v=>updateAZ(z=>({...z,oss:{...z.oss,eM:v}}))} unit="mm"/>
                <NI label="Entraxe lisses" value={az.oss.eL} onChange={v=>updateAZ(z=>({...z,oss:{...z.oss,eL:v}}))} unit="mm"/>
              </div></Sec>
              <Sec icon={I.bolt()} title="Fixations" color="var(--t2)" dO={false}><div className="space-y-2">
                <NI label="Par panneau" value={fix.pp} onChange={v=>setFix(f=>({...f,pp:v}))} unit="u" step={1}/>
                <NI label="Equerres/montant" value={fix.em} onChange={v=>setFix(f=>({...f,em:v}))} unit="u" step={1}/>
              </div></Sec>
              <Sec icon="⊞" title="Fusion" badge={(az.merges||[]).length||null} color="var(--pp)">
                <div className="space-y-2">
                  <button onClick={()=>{if(mergeSrc){setMergeSrc(null)}else{setMergeSrc({parentCol:-1,parentRow:-1});setEditPanel(null)}}}
                    className={`ba w-full py-2 rounded-lg text-[10px] font-bold ${mergeSrc?'apg':''}`}
                    style={{background:mergeSrc?'rgba(139,92,246,.25)':'rgba(139,92,246,.1)',border:'1px solid rgba(139,92,246,.3)',color:'var(--pp)'}}>
                    {mergeSrc?'Annuler':'Fusionner des panneaux'}<span className="ml-1 text-[8px] opacity-50">Ctrl+E</span></button>
                  {(az.merges||[]).length>0&&<div className="space-y-1">
                    <div className="text-[9px] font-bold" style={{color:'var(--t3)'}}>{(az.merges||[]).length} fusion(s)</div>
                    {(az.merges||[]).map((m,i)=><div key={i} className="flex items-center justify-between px-2 py-1 rounded" style={{background:'rgba(139,92,246,.06)',border:'1px solid rgba(139,92,246,.1)'}}>
                      <span className="text-[9px] mn font-bold" style={{color:'var(--pp)'}}>C{m.c1+1}-C{m.c2+1} L{m.r1+1}-L{m.r2+1}</span>
                      <button onClick={()=>updateAZ(z=>({...z,merges:(z.merges||[]).filter((_,j)=>j!==i)}))} className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>x</button>
                    </div>)}
                    <button onClick={()=>updateAZ(z=>({...z,merges:[]}))} className="w-full py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',color:'var(--rs)'}}>Tout supprimer</button>
                  </div>}
                </div>
              </Sec>
              {/* ── EXCLUSIONS / BALCONS ── */}
              <Sec icon="🚫" title="Exclusions / Balcons" badge={(az.exclusions||[]).length||null} color="var(--rs)">
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <label className="text-[9px] font-bold" style={{color:'var(--t3)'}}>Profondeur (mm)</label>
                    <input type="number" value={excludeDepth} onChange={e=>setExcludeDepth(Math.max(100,parseInt(e.target.value)||1500))}
                      className="idark flex-1 px-2 py-1 rounded text-[11px] mn font-bold text-center"
                      style={{borderColor:'var(--rs)'}} min={100} step={100}/>
                  </div>
                  <button onClick={()=>{if(excludeMode){setExcludeMode(false)}else{setExcludeMode(true);setMergeSrc(null);setEditPanel(null)}}}
                    className={`ba w-full py-2 rounded-lg text-[10px] font-bold ${excludeMode?'apg':''}`}
                    style={{background:excludeMode?'rgba(190,18,60,.25)':'rgba(190,18,60,.08)',border:'1px solid rgba(190,18,60,.3)',color:'var(--rs)'}}>
                    {excludeMode?'✓ Cliquer panneau pour exclure/restaurer':'🚫 Mode exclusion (balcon/auvent)'}
                  </button>
                  {(az.exclusions||[]).length>0&&<div className="space-y-1">
                    <div className="text-[9px] font-bold" style={{color:'var(--t3)'}}>{(az.exclusions||[]).length} exclusion(s)</div>
                    {(az.exclusions||[]).map((ex,i)=><div key={i} className="flex items-center justify-between px-2 py-1 rounded" style={{background:'rgba(190,18,60,.06)',border:'1px solid rgba(190,18,60,.15)'}}>
                      <span className="text-[9px] mn font-bold" style={{color:'var(--rs)'}}>C{ex.col+1} L{ex.row+1} — {ex.depth}mm</span>
                      <div className="flex gap-1">
                        <input type="number" defaultValue={ex.depth} className="w-14 text-center text-[9px] px-1 py-0.5 rounded mn"
                          style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}}
                          onChange={e=>{const v=parseInt(e.target.value)||1500;
                            updateAZ(z=>({...z,exclusions:(z.exclusions||[]).map((x,j)=>j===i?{...x,depth:v}:x)}))}}/>
                        <button onClick={()=>updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter((_,j)=>j!==i)}))}
                          className="text-[9px] px-1.5 py-0.5 rounded" style={{background:'var(--rsd)',color:'var(--rs)'}}>x</button>
                      </div>
                    </div>)}
                    <button onClick={()=>updateAZ(z=>({...z,exclusions:[]}))} className="w-full py-1 rounded text-[9px] font-bold" style={{background:'var(--rsd)',color:'var(--rs)'}}>Tout supprimer</button>
                  </div>}
                </div>
              </Sec>
              <Sec icon={I.win()} title="Ouvertures" badge={az.ouvs.length||null} color="var(--rs)" act={{ic:I.plus(14),fn:()=>setAddMod('ouv')}}>
                <div className="space-y-2">
                  <button onClick={()=>setModeDraw(!modeDraw)} className={`ba w-full py-1.5 text-xs font-medium rounded-lg flex items-center justify-center gap-1 ${modeDraw?'apg':''}`}
                    style={{background:modeDraw?'var(--rsd)':'var(--blg)',border:`1px solid ${modeDraw?'var(--rs)':'var(--bl)'}`,color:modeDraw?'var(--rs)':'var(--bl)'}}>
                    {modeDraw?'Annuler':<>{I.cross(12)} Dessiner</>}</button>
                  <div className="grid grid-cols-2 gap-1">{presOuv.map((p,i)=><button key={p.n+i} onClick={()=>addPOuv(p)} className="pb truncate">{p.n}</button>)}</div>
                  <div className="space-y-1 max-h-40 overflow-y-auto">
                    {az.ouvs.map((o,i)=>{const sel=selId===o.id;return(
                      <div key={o.id} className={`rounded-lg p-2 cursor-pointer ${sel?'ring-1':''}`}
                        style={{background:sel?'var(--blg)':'var(--inp)',border:`1px solid ${sel?'var(--bl)':'var(--bd)'}`,ringColor:'var(--bl)'}}
                        onClick={()=>setSelId(sel?null:o.id)}>
                        <div className="flex items-center justify-between">
                          <span className="text-[11px] font-medium">{o.t} {i+1} <span className="mn text-[10px]" style={{color:'var(--t3)'}}>{o.w}x{o.h}</span></span>
                          <div className="flex gap-1">
                            <button onClick={e=>{e.stopPropagation();updateAZ(z=>({...z,ouvs:[...z.ouvs,{...o,id:Date.now(),x:clamp(o.x+200,0,az.L-o.w)}]}))}} className="w-5 h-5 rounded flex items-center justify-center" style={{color:'var(--t3)'}}>{I.copy(10)}</button>
                            <button onClick={e=>{e.stopPropagation();updateAZ(z=>({...z,ouvs:z.ouvs.filter(x=>x.id!==o.id)}));if(selId===o.id)setSelId(null)}} className="w-5 h-5 rounded flex items-center justify-center" style={{color:'var(--t3)'}}>{I.trash(10)}</button>
                          </div></div>
                        {sel&&<div className="mt-2 afu"><div className="grid grid-cols-2 gap-1">
                          <NI compact value={o.x} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,x:v}:x)}))} unit="X" step={50}/>
                          <NI compact value={o.y} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,y:v}:x)}))} unit="Y" step={50}/>
                          <NI compact value={o.w} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,w:v}:x)}))} unit="L" step={50} min={200}/>
                          <NI compact value={o.h} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?{...x,h:v}:x)}))} unit="H" step={50} min={200}/>
                        </div>
                        <div className="mt-1.5 flex flex-wrap gap-1">
                          <button onClick={()=>{const s=snapOuvToJoint(o,'all');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-2 py-1 rounded text-[8px] font-bold" style={{background:'rgba(79,110,247,.1)',border:'1px solid rgba(79,110,247,.3)',color:'var(--bl)'}}>⊞ Aligner tout</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'left');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>← G</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'right');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>D →</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'top');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>↑ H</button>
                          <button onClick={()=>{const s=snapOuvToJoint(o,'bottom');updateAZ(z=>({...z,ouvs:z.ouvs.map(x=>x.id===o.id?s:x)}))}}
                            className="ba px-1.5 py-1 rounded text-[8px]" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>B ↓</button>
                        </div></div>}
                      </div>);})}
                    {!az.ouvs.length&&<p className="text-center text-[11px] py-2" style={{color:'var(--t3)'}}>Aucune</p>}
                  </div></div></Sec>
            </div></div>)}
        {/* CENTER */}
        <div className="flex-1 flex flex-col min-w-0 relative">
          {step==='work'&&(<div className="flex items-center gap-2 px-3 h-9 border-b flex-shrink-0" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex items-center gap-1 p-0.5 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
              <button onClick={()=>setZoom(z=>Math.min(z*1.2,20))} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.zi(12)}</button>
              <span className="w-10 text-center text-[10px] mn" style={{color:'var(--t3)'}}>{(zoom*100).toFixed(0)}%</span>
              <button onClick={()=>setZoom(z=>Math.max(z/1.2,.05))} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.zo(12)}</button>
              <div className="w-px h-4" style={{background:'var(--bd)'}}/><button onClick={autoFit} className="ba w-6 h-6 rounded flex items-center justify-center" style={{color:'var(--t2)'}}>{I.tgt(12)}</button></div>
            <div className="flex gap-2.5 text-[9px] ml-2">
              {[{f:'rgba(79,110,247,.1)',s:'rgba(79,110,247,.4)',t:'Standard'},{f:'rgba(251,191,36,.12)',s:'rgba(251,191,36,.5)',t:'Impactes'},{f:'rgba(34,211,238,.08)',s:'rgba(34,211,238,.4)',t:'Bord poly.'}].map(l=>
                <span key={l.t} className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded-sm" style={{background:l.f,border:`1px solid ${l.s}`}}/><span style={{color:'var(--t3)'}}>{l.t}</span></span>)}
            </div></div>)}
          <Instructions/>
          <div ref={cvRef} className="flex-1 overflow-hidden cvbg" style={{cursor,position:'relative'}} onMouseDown={handleDown} onMouseMove={handleMove} onMouseUp={handleUp} onMouseLeave={()=>{handleUp();setDragZone(null);setResizeZone(null)}} onContextMenu={e=>e.preventDefault()}>

            {show3D&&az&&C&&<Facade3D zone={az} calc={C} ralColor={RAL_COLORS[ralIdx]?.hex} ralFinish={RAL_COLORS[ralIdx]?.finish||'mat'}
              showWall={show3DWall}
              onToggle={k=>{if(k==='wall')setShow3DWall(v=>!v)}}
              onClose={()=>setShow3D(false)}/>}
            {/* Floating canvas toolbar — only 3D + color swatch */}
            {step==='work'&&!show3D&&az&&<div style={{position:'absolute',top:12,right:12,zIndex:20,display:'flex',gap:8,alignItems:'center'}}>
              <div onClick={()=>setRightTab('ral')} style={{width:28,height:28,borderRadius:8,background:RAL_COLORS[ralIdx]?.hex,
                border:'2px solid rgba(255,255,255,.2)',cursor:'pointer',boxShadow:'0 2px 10px rgba(0,0,0,.3)'}} title={`${RAL_COLORS[ralIdx]?.code} — Cliquer pour changer`}/>
              <button onClick={()=>setShow3D(true)} className="ba"
                style={{background:'linear-gradient(135deg,rgba(139,92,246,.9),rgba(79,110,247,.9))',border:'none',borderRadius:10,padding:'8px 12px',
                  color:'#fff',fontSize:12,fontWeight:700,cursor:'pointer',boxShadow:'0 4px 20px rgba(79,110,247,.4)',
                  display:'flex',alignItems:'center',gap:5,backdropFilter:'blur(8px)'}}>
                🧊 3D</button>
            </div>}
            {/* Merge mode banner */}
            {mergeSrc&&<div style={{position:'absolute',top:50,left:'50%',transform:'translateX(-50%)',zIndex:25,
              background:'rgba(139,92,246,.9)',borderRadius:12,padding:'10px 20px',backdropFilter:'blur(8px)',
              display:'flex',alignItems:'center',gap:10,boxShadow:'0 4px 20px rgba(0,0,0,.4)'}}>
              <span className="text-sm font-bold text-white">{mergeSrc.parentCol===-1?'Cliquer le 1er panneau':'Cliquer le 2ème panneau'}</span>
              <button onClick={()=>setMergeSrc(null)} className="ba px-3 py-1 rounded-lg text-xs font-bold"
                style={{background:'rgba(255,255,255,.2)',color:'#fff'}}>Annuler</button>
            </div>}
            {/* Exclude mode banner */}
            {excludeMode&&<div style={{position:'absolute',top:50,left:'50%',transform:'translateX(-50%)',zIndex:25,
              background:'rgba(190,18,60,.88)',borderRadius:12,padding:'10px 20px',backdropFilter:'blur(8px)',
              display:'flex',alignItems:'center',gap:10,boxShadow:'0 4px 20px rgba(0,0,0,.4)'}}>
              <span style={{fontSize:18}}>🚫</span>
              <span className="text-sm font-bold text-white">Cliquer un panneau pour l'exclure / restaurer — {excludeDepth}mm</span>
              <button onClick={()=>setExcludeMode(false)} className="ba px-3 py-1 rounded-lg text-xs font-bold"
                style={{background:'rgba(255,255,255,.2)',color:'#fff'}}>Terminer</button>
            </div>}
            {/* Legend overlay */}
            {step==='work'&&!show3D&&az&&<div style={{position:'absolute',bottom:12,left:12,zIndex:20,
              background:'rgba(15,17,24,.85)',borderRadius:10,padding:'8px 12px',backdropFilter:'blur(12px)',
              border:'1px solid rgba(255,255,255,.06)',display:'flex',gap:12,alignItems:'center'}}>
              {[{c:RAL_COLORS[ralIdx]?.hex||'#383E42',t:'Panneau',b:'none'},
                {c:'rgba(251,113,133,.3)',t:'Ouverture',b:'2px solid rgba(251,113,133,.8)'},
                {c:'rgba(139,92,246,.3)',t:'Tableau',b:'1px solid rgba(139,92,246,.8)'},
                {c:'rgba(34,211,238,.25)',t:'Linteau',b:'1px solid rgba(34,211,238,.8)'},
                {c:'rgba(52,211,153,.25)',t:'Appui',b:'1px solid rgba(52,211,153,.8)'},
                {c:'rgba(245,158,11,.3)',t:'Joint',b:'1px solid rgba(245,158,11,.7)'},
                {c:'transparent',t:'Ossature',b:'2px dashed rgba(245,158,11,.6)'},
              ].map(l=><div key={l.t} className="flex items-center gap-1.5">
                <div style={{width:12,height:12,borderRadius:3,background:l.c,border:l.b,flexShrink:0}}/>
                <span className="text-[9px] font-medium" style={{color:'var(--t3)'}}>{l.t}</span>
              </div>)}
            </div>}
            <svg ref={svgRef} width="100%" height="100%" style={{display:'block',userSelect:'none'}}>
              {bgSrc&&bgVis&&(step==='calibrate'||step==='zone')&&<image href={bgSrc} x={pan.x} y={pan.y} width={bgW*zoom} height={bgH*zoom} style={{opacity:bgOp}}/>}
              {/* Background plan in work mode - behind zones */}
              {bgSrc&&bgVis&&step==='work'&&<image href={bgSrc} x={pan.x} y={pan.y} width={bgW*zoom} height={bgH*zoom} style={{opacity:Math.min(bgOp,0.25)}}/>}
              {step==='calibrate'&&calPts.map((p,i)=><g key={i}><circle cx={p.x*zoom+pan.x} cy={p.y*zoom+pan.y} r="8" fill="none" stroke="var(--cy)" strokeWidth="2" opacity=".5"/>
                <circle cx={p.x*zoom+pan.x} cy={p.y*zoom+pan.y} r="4" fill="var(--cy)"/></g>)}
              {step==='calibrate'&&calPts.length===2&&<line x1={calPts[0].x*zoom+pan.x} y1={calPts[0].y*zoom+pan.y} x2={calPts[1].x*zoom+pan.x} y2={calPts[1].y*zoom+pan.y} stroke="var(--cy)" strokeWidth="2.5" strokeDasharray="8,4"/>}
              {/* Zone step: drawn zones */}
              {step==='zone'&&zones.map((z,i)=>{const ox=z.facOrigin.x*zoom+pan.x,oy=z.facOrigin.y*zoom+pan.y;
                const ppm=mmPerPx?(1/mmPerPx):manualScale;const fW2=z.L*ppm*zoom,fH2=z.H*ppm*zoom;
                const zCol=ZONE_COLORS[i%8];const rDeg=z.rot||0;const rcx=ox+fW2/2,rcy=oy+fH2/2;
                return<g key={z.id} transform={rDeg?`rotate(${rDeg},${rcx},${rcy})`:undefined}>{z.poly?<path d={z.poly.map((p,j)=>`${j===0?'M':'L'}${ox+p.x*ppm*zoom} ${oy+p.y*ppm*zoom}`).join(' ')+'Z'}
                  fill="rgba(79,110,247,.08)" stroke={zCol} strokeWidth="1.5"/>:
                  <rect x={ox} y={oy} width={fW2} height={fH2} fill="rgba(79,110,247,.08)" stroke={zCol} strokeWidth="1.5" rx="3"/>}
                  <text x={ox+6} y={oy+14} fontSize="11" fontWeight="600" fill={zCol}>{z.name}</text>
                  <text x={ox+6} y={oy+28} fontSize="9" fontWeight="500" fill="var(--t3)" fontFamily="JetBrains Mono">{(z.L/1000).toFixed(2)} x {(z.H/1000).toFixed(2)} m</text>
                  {/* Resize handles */}
                  {!z.poly&&['nw','n','ne','e','se','s','sw','w'].map(h=>{
                    const cx=h.includes('w')?ox:h.includes('e')?ox+fW2:ox+fW2/2;
                    const cy=h.includes('n')?oy:h.includes('s')?oy+fH2:oy+fH2/2;
                    return<rect key={h} x={cx-5} y={cy-5} width={10} height={10} rx="2.5"
                      fill={zCol} stroke="#fff" strokeWidth="1.5" opacity=".85"
                      style={{cursor:h.length===2?h+'-resize':h==='n'||h==='s'?'ns-resize':'ew-resize'}}
                      onMouseDown={e=>{e.stopPropagation();setResizeZone({idx:i,handle:h,startX:e.clientX,startY:e.clientY,origOrigin:{...z.facOrigin},origL:z.L,origH:z.H})}}/>})}
                  {/* Rotation handle */}
                  {!z.poly&&<g>
                    <line x1={ox+fW2/2} y1={oy-6} x2={ox+fW2/2} y2={oy-18} stroke={zCol} strokeWidth="1.5" opacity=".5"/>
                    <circle cx={ox+fW2/2} cy={oy-22} r={6} fill={zCol} stroke="#fff" strokeWidth="1.5" opacity=".85"
                      style={{cursor:'grab'}}
                      onMouseDown={e=>{e.stopPropagation();
                        const rect=cvRef.current.getBoundingClientRect();
                        const ccx=ox+fW2/2,ccy=oy+fH2/2;
                        const startAngle=Math.atan2(e.clientY-rect.top-ccy,e.clientX-rect.left-ccx)*180/Math.PI;
                        setRotateZone({idx:i,startAngle,origRot:z.rot||0})}}/>
                    <text x={ox+fW2/2} y={oy-19} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#fff" fontWeight="700" style={{pointerEvents:'none'}}>↻</text>
                  </g>}
                  {/* Drag handle + delete */}
                  <g style={{cursor:'grab'}} onMouseDown={e=>handleZoneDragStart(e,i)}>
                    <rect x={ox} y={oy+fH2+5} width={Math.min(fW2,120)} height={18} rx="5" fill={zCol} opacity=".85"/>
                    <text x={ox+8} y={oy+fH2+17} fontSize="9" fontWeight="700" fill="#fff" fontFamily="DM Sans">☰ déplacer</text>
                  </g>
                  {zones.length>1&&<g style={{cursor:'pointer'}} onClick={e=>{e.stopPropagation();if(confirm('Supprimer '+z.name+' ?')){setZones(zs=>zs.filter((_,j)=>j!==i))}}}>
                    <rect x={ox+Math.min(fW2,120)+4} y={oy+fH2+5} width={18} height={18} rx="5" fill="#ef4444" opacity=".85"/>
                    <text x={ox+Math.min(fW2,120)+13} y={oy+fH2+17} textAnchor="middle" fontSize="11" fontWeight="700" fill="#fff">×</text>
                  </g>}
                </g>})}
              {/* Polygon drawing preview */}
              {step==='zone'&&polyMode&&polyPts.length>0&&<g>
                <polyline points={polyPts.map(p=>`${p.sx*zoom+pan.x},${p.sy*zoom+pan.y}`).join(' ')} fill="none" stroke="var(--gn)" strokeWidth="2" strokeDasharray="6,4"/>
                {polyPts.map((p,i)=><circle key={i} cx={p.sx*zoom+pan.x} cy={p.sy*zoom+pan.y} r={i===0?6:4} fill={i===0?'var(--gn)':'var(--cy)'} stroke="#fff" strokeWidth="1.5"/>)}
                {polyPts.length>=3&&<circle cx={polyPts[0].sx*zoom+pan.x} cy={polyPts[0].sy*zoom+pan.y} r="12" fill="none" stroke="var(--gn)" strokeWidth="1" strokeDasharray="3,3" opacity=".5"/>}
              </g>}
              {/* Rectangle zone drawing */}
              {step==='zone'&&!polyMode&&zoneStart&&zoneCur&&(()=>{const sc=mmPerPx||(1/manualScale);
                const x1=Math.min(zoneStart.x,zoneCur.x)*zoom+pan.x,y1=Math.min(zoneStart.y,zoneCur.y)*zoom+pan.y;
                const w=Math.abs(zoneCur.x-zoneStart.x)*zoom,h=Math.abs(zoneCur.y-zoneStart.y)*zoom;
                return<g><rect x={x1} y={y1} width={w} height={h} fill="rgba(52,211,153,.1)" stroke="var(--gn)" strokeWidth="2" strokeDasharray="8,4" rx="3"/>
                  {w>60&&<text x={x1+w/2} y={y1-8} textAnchor="middle" fontSize="12" fontWeight="700" fill="var(--gn)" fontFamily="JetBrains Mono">
                    {(Math.abs(zoneCur.x-zoneStart.x)*sc/1000).toFixed(2)} x {(Math.abs(zoneCur.y-zoneStart.y)*sc/1000).toFixed(2)} m</text>}</g>})()}
              {/* WORK: all zones */}
              {step==='work'&&zones.map((z,i)=><ZoneView key={z.id} z={z} zCalc={allCalcs[i]} isActive={i===activeZoneIdx} idx={i}/>)}
              {step==='work'&&drawRect&&drawRect.w>0&&drawRect.h>0&&az&&(()=>{const ppZ=pxPerMm_eff*zoom;const ox=az.facOrigin.x*zoom+pan.x,oy=az.facOrigin.y*zoom+pan.y;
                return<rect x={ox+drawRect.x*ppZ} y={oy+drawRect.y*ppZ} width={drawRect.w*ppZ} height={drawRect.h*ppZ} fill="rgba(79,110,247,.15)" stroke="var(--bl)" strokeWidth="2" strokeDasharray="6,4" rx="2"/>})()}
              {/* DXF vector overlay */}
              {step==='work'&&dxfData&&bgSrc&&(()=>{
                const ppm=pxPerMm_eff;const b=dxfData.bounds;
                const dxfW=b.maxX-b.minX,dxfH=b.maxY-b.minY;
                const scX=bgW/dxfW,scY=bgH/dxfH,sc=Math.min(scX,scY);
                const ox2=0,oy2=0;
                return<g opacity=".4">{dxfData.lines.slice(0,5000).map((l,i)=>{
                  const x1=(ox2+(l.x1-b.minX)*sc)*zoom+pan.x;
                  const y1=(oy2+(dxfH-(l.y1-b.minY))*sc)*zoom+pan.y;
                  const x2=(ox2+(l.x2-b.minX)*sc)*zoom+pan.x;
                  const y2=(oy2+(dxfH-(l.y2-b.minY))*sc)*zoom+pan.y;
                  return<line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke="var(--cy)" strokeWidth=".5"/>})}</g>})()}
              {/* Measurement lines */}
              {step==='work'&&measures.map(m=>{const ppZ=pxPerMm_eff*zoom;
                const zOx=az?az.facOrigin.x*zoom+pan.x:pan.x,zOy=az?az.facOrigin.y*zoom+pan.y:pan.y;
                const x1=zOx+m.p0.x*ppZ,y1=zOy+m.p0.y*ppZ,x2=zOx+m.p1.x*ppZ,y2=zOy+m.p1.y*ppZ;
                const mx=(x1+x2)/2,my=(y1+y2)/2;
                return<g key={m.id}>
                  <line x1={x1} y1={y1} x2={x2} y2={y2} stroke="#f59e0b" strokeWidth="2" strokeDasharray="4,3"/>
                  <circle cx={x1} cy={y1} r="3" fill="#f59e0b" stroke="#fff" strokeWidth="1"/>
                  <circle cx={x2} cy={y2} r="3" fill="#f59e0b" stroke="#fff" strokeWidth="1"/>
                  <rect x={mx-22} y={my-9} width="44" height="16" rx="4" fill="rgba(0,0,0,.8)"/>
                  <text x={mx} y={my+3} textAnchor="middle" fontSize="10" fontWeight="700" fill="#fbbf24" fontFamily="JetBrains Mono">{m.dist>=1000?(m.dist/1000).toFixed(2)+'m':m.dist+'mm'}</text>
                  <text x={x2+6} y={y2-4} fontSize="8" fill="#f59e0b" style={{cursor:'pointer'}} onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))}>✕</text>
                </g>})}
              {/* Measurement in progress */}
              {step==='work'&&measureMode&&measurePts.length===1&&az&&(()=>{
                const ppZ=pxPerMm_eff*zoom;
                const zOx=az.facOrigin.x*zoom+pan.x,zOy=az.facOrigin.y*zoom+pan.y;
                const x1=zOx+measurePts[0].x*ppZ,y1=zOy+measurePts[0].y*ppZ;
                return<g><circle cx={x1} cy={y1} r="5" fill="none" stroke="#f59e0b" strokeWidth="2"><animate attributeName="r" values="4;8;4" dur="1.5s" repeatCount="indefinite"/></circle></g>})()}
            {lasso&&lasso.w>5&&lasso.h>5&&az&&(()=>{const ppZ2=zoom*(pxPerMm_eff||manualScale||0.15);const ox=(az.facOrigin?.x||0)*zoom+pan.x,oy=(az.facOrigin?.y||0)*zoom+pan.y;
              return<rect x={lasso.x*ppZ2+ox} y={lasso.y*ppZ2+oy} width={lasso.w*ppZ2} height={lasso.h*ppZ2} fill="rgba(79,110,247,.08)" stroke="rgba(79,110,247,.7)" strokeWidth="1.5" strokeDasharray="5,3"/>})()}
            </svg></div></div>

        {/* RIGHT */}
        {step==='work'&&C&&az&&(
          <div className="w-[270px] flex-shrink-0 border-l flex flex-col" style={{borderColor:'var(--bd)',background:'var(--pnl)'}}>
            <div className="flex border-b flex-shrink-0 overflow-x-auto" style={{borderColor:'var(--bd)'}}>
              {[{id:'resultats',l:'Résultats'},{id:'ral',l:'🎨 RAL'},{id:'menuiseries',l:'Cassettes'},{id:'decoupe',l:'Découpe'},{id:'metre',l:'Métré'}].map(t=>(
                <button key={t.id} onClick={()=>setRightTab(t.id)} className={`tb flex-1 ${rightTab===t.id?'on':''}`}>{t.l}</button>))}</div>
            <div className="flex-1 overflow-y-auto p-2.5 space-y-2.5">
              {rightTab==='ral'&&<>
                <div className="cd p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-6 h-6 rounded-lg" style={{background:RAL_COLORS[ralIdx]?.hex,border:'2px solid rgba(255,255,255,.15)'}}/>
                    <div><div className="text-xs font-bold">{RAL_COLORS[ralIdx]?.code}</div>
                    <div className="text-[9px]" style={{color:'var(--t3)'}}>{RAL_COLORS[ralIdx]?.name}{RAL_COLORS[ralIdx]?.finish?' • '+RAL_COLORS[ralIdx].finish:''}</div></div>
                  </div>
                  {/* Category tabs */}
                  <div className="flex flex-wrap gap-1 mb-2.5">
                    {RAL_CATS.map(cat=><button key={cat} onClick={()=>setRalCat(cat)}
                      className="ba px-2 py-1 rounded-md text-[9px] font-bold"
                      style={{background:ralCat===cat?'var(--blg)':'var(--inp)',border:`1px solid ${ralCat===cat?'var(--bl)':'var(--bd)'}`,
                        color:ralCat===cat?'var(--bl)':'var(--t3)'}}>{cat}</button>)}
                  </div>
                  {/* Color grid filtered by category */}
                  <div className="grid grid-cols-6 gap-1.5">
                    {RAL_COLORS.map((r,i)=>r.cat===ralCat?<button key={r.code} onClick={()=>setRalIdx(i)}
                      className="ba relative" title={`${r.code} — ${r.name}${r.finish?' ('+r.finish+')':''}`}
                      style={{width:34,height:34,borderRadius:8,background:r.hex,border:i===ralIdx?'3px solid var(--bl)':'2px solid rgba(255,255,255,.08)',
                        boxShadow:i===ralIdx?'0 0 12px rgba(79,110,247,.4)':'none',transform:i===ralIdx?'scale(1.12)':'scale(1)',transition:'.15s'}}>
                      {i===ralIdx&&<div style={{position:'absolute',inset:-1,borderRadius:8,border:'2px solid #fff',opacity:.4}}/>}
                      {r.finish&&<div style={{position:'absolute',bottom:1,right:1,width:6,height:6,borderRadius:3,
                        background:r.finish==='brillant'?'#fff':r.finish==='mat'?'#555':r.finish==='brossé'?'#999':r.finish==='métallisé'?'#ccc':'#a85',opacity:.8}}/>}
                    </button>:null)}
                  </div>
                </div>
                <button onClick={()=>setShow3D(true)} className="ba w-full py-2.5 rounded-xl text-sm font-bold text-white flex items-center justify-center gap-2"
                  style={{background:'linear-gradient(135deg,var(--pp),var(--bl))',boxShadow:'0 4px 15px rgba(79,110,247,.25)'}}>
                  🧊 Vue 3D</button>
              </>}
              {rightTab==='resultats'&&<>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--bl)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--bl)'}}>Surfaces</span></div>
                  <RR label="Brute" value={C.sBr.toFixed(2)} unit="m2"/><RR label="Ouvertures" value={`-${C.sOuv.toFixed(2)}`} unit="m2" color="var(--rs)" sub/>
                  <RR label="Nette" value={C.sNet.toFixed(2)} unit="m2" color="var(--bl)" bold/></div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--pp)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--pp)'}}>Panneaux</span></div>
                  <RR label="Calepinage" value={`${C.nC}x${C.nR}`}/><RR label="Total" value={C.nP} unit="u" color="var(--pp)"/>
                  {(az.exclusions||[]).length>0&&<RR label="Exclus (balcons)" value={`-${(az.exclusions||[]).length}`} unit="u" color="var(--rs)" sub/>}
                  <RR label="Impactes" value={C.pImp} unit="u" color="var(--am)" sub/>
                  <RR label="Bord poly." value={C.edgePanels.length} unit="u" color="var(--cy)" sub/><RR label="Chutes" value={C.chut.toFixed(1)} unit="%" color={C.chut>15?'var(--rs)':'var(--gn)'}/>
                  {(C.jGapH>0||C.jGapV>0||C.jGapsH?.some(v=>v>0)||C.jGapsV?.some(v=>v>0))&&<RR label="Joints" value={`Déf: ${(C.jGapH*1000).toFixed(0)}/${(C.jGapV*1000).toFixed(0)}${C.jGapsH?.filter(v=>v!==null&&v!==(az.jointH||0)).length?` + ${C.jGapsH.filter(v=>v!==null&&v!==(az.jointH||0)).length} ind.`:''}`} unit="mm" color="var(--am)"/>}</div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--am)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--am)'}}>Ossature</span></div>
                  <RR label="Montants" value={C.lMN.toFixed(1)} unit="ml"/><RR label="Lisses" value={C.lLN.toFixed(1)} unit="ml"/><RR label="Total" value={C.tOss.toFixed(1)} unit="ml" color="var(--am)" bold/></div>
                <div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--cy)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--cy)'}}>Encadrements</span></div>
                  <RR label="Tableaux" value={C.totEnc.tab.toFixed(2)} unit="ml"/><RR label="Linteaux" value={C.totEnc.lin.toFixed(2)} unit="ml"/><RR label="Appuis" value={C.totEnc.app.toFixed(2)} unit="ml"/>
                  <RR label="Total" value={C.totEnc.tot.toFixed(2)} unit="ml" color="var(--cy)" bold/></div>
                {C.totCassettes&&C.totCassettes.pliees>0&&<div className="cd p-2.5 space-y-1"><div className="flex items-center gap-2 mb-1.5"><div className="w-1.5 h-1.5 rounded-full" style={{background:'var(--pp)'}}/><span className="text-[9px] font-bold uppercase tracking-widest" style={{color:'var(--pp)'}}>Cassettes pliées</span></div>
                  <RR label="Plis" value={C.totCassettes.pliees} unit="pièces"/>
                  <RR label="Panneaux pliés" value={new Set(C.totCassettes.detail.map(d=>d.panRef)).size} unit="pan." color="var(--am)" sub/>
                  <RR label="Surface" value={C.totCassettes.surfTot.toFixed(2)} unit="m²" bold color="var(--pp)"/>
                  <RR label="ML total" value={C.totCassettes.mlTot.toFixed(2)} unit="ml"/></div>}
                <div className="cd p-2.5"><div className="grid grid-cols-2 gap-2">
                  <div className="text-center p-1.5 rounded-lg" style={{background:'var(--inp)'}}><div className="rv text-base">{C.tFix}</div><div className="text-[9px]" style={{color:'var(--t3)'}}>Fixations</div></div>
                  <div className="text-center p-1.5 rounded-lg" style={{background:'var(--inp)'}}><div className="rv text-base">{C.tEq}</div><div className="text-[9px]" style={{color:'var(--t3)'}}>Equerres</div></div></div></div>
                {/* Global summary */}
                {zones.length>1&&<div className="cd p-2.5"><div className="text-[9px] font-bold uppercase tracking-widest mb-1.5" style={{color:'var(--t2)'}}>Total {zones.length} zones</div>
                  {(()=>{const totals=allCalcs.reduce((a,c)=>c?{sNet:a.sNet+c.sNet,nP:a.nP+c.nP,tOss:a.tOss+c.tOss,tFix:a.tFix+c.tFix}:a,{sNet:0,nP:0,tOss:0,tFix:0});
                    return<><RR label="Surface nette" value={totals.sNet.toFixed(2)} unit="m2" color="var(--bl)" bold/><RR label="Panneaux" value={totals.nP} unit="u"/><RR label="Ossature" value={totals.tOss.toFixed(1)} unit="ml"/></>})()}
                </div>}
              </>}
              {rightTab==='menuiseries'&&<>
                <div className="text-[9px] font-bold uppercase tracking-widest mb-1" style={{color:'var(--cy)'}}>Encadrements & Cassettes</div>
                {C.menuDet.length===0&&<p className="text-[11px] py-3 text-center" style={{color:'var(--t3)'}}>Aucune ouverture</p>}
                {C.menuDet.map((m,i)=><div key={m.id} className="cd p-2.5 space-y-2 afu">
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-bold" style={{color:'var(--rs)'}}>O{i+1} — {m.t}</span>
                    <div className="flex items-center gap-1.5"><button onClick={()=>setCoupeOuv(i)} className="ba px-2 py-0.5 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.08)',border:'1px solid rgba(139,92,246,.2)',color:'var(--pp)'}}>Coupe</button><span className="mn text-[10px]" style={{color:'var(--t3)'}}>{m.w}×{m.h}</span></div>
                  </div>
                  {/* Retour depths */}
                  <div className="p-2 rounded-lg" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                    <div className="text-[9px] font-bold mb-1.5" style={{color:'var(--pp)'}}>Profondeur retours (mm)</div>
                    <div className="grid grid-cols-2 gap-1">
                      <NI compact label="Tab. G" value={m.retours?.tG||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tG:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Tab. D" value={m.retours?.tD||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),tD:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Linteau" value={m.retours?.lin||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),lin:v}}:o)}))} unit="mm" step={10} min={0}/>
                      <NI compact label="Appui" value={m.retours?.app||150} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,retours:{...(o.retours||{tG:150,tD:150,lin:150,app:150}),app:v}}:o)}))} unit="mm" step={10} min={0}/>
                    </div>
                    <div className="mt-1"><NI compact label="Face visible" value={m.faceVis||50} onChange={v=>updateAZ(z=>({...z,ouvs:z.ouvs.map(o=>o.id===m.id?{...o,faceVis:v}:o)}))} unit="mm" step={5} min={0}/></div>
                  </div>
                  {/* Cassettes table — per impacted panel */}
                  {m.cassettes.length>0?<><div className="text-[9px] font-bold" style={{color:'var(--pp)'}}>Cassettes pliées ({m.cassettes.length} plis sur {new Set(m.cassettes.map(c=>c.panRef)).size} panneau{new Set(m.cassettes.map(c=>c.panRef)).size>1?'x':''})</div>
                  <table className="dtbl"><thead><tr><th>Panneau</th><th>Pli</th><th style={{textAlign:'right'}}>L (mm)</th><th style={{textAlign:'right'}}>Ret.</th><th style={{textAlign:'right'}}>Dév.</th><th style={{textAlign:'right'}}>m²</th></tr></thead><tbody>
                    {m.cassettes.map((c,j)=><tr key={j}>
                      <td className="mn" style={{color:'var(--am)'}}>{c.panRef}</td>
                      <td style={{color:'var(--pp)'}}>{c.nom.split(' ')[0]}</td>
                      <td className="mn" style={{textAlign:'right'}}>{c.L}</td>
                      <td className="mn" style={{textAlign:'right'}}>{c.dev-(m.faceVis||50)-10}</td>
                      <td className="mn" style={{textAlign:'right'}}>{c.dev}</td>
                      <td className="mn" style={{textAlign:'right'}}>{(c.L*c.dev/1e6).toFixed(3)}</td>
                    </tr>)}
                    <tr style={{background:'var(--gnd)'}}><td colSpan="2" className="font-bold" style={{color:'var(--gn)'}}>Total</td>
                      <td className="mn font-bold" style={{textAlign:'right',color:'var(--gn)'}}>{m.mlCass.toFixed(1)} ml</td>
                      <td/>
                      <td/>
                      <td className="mn font-bold" style={{textAlign:'right',color:'var(--gn)'}}>{m.surfCass.toFixed(3)}</td>
                    </tr>
                  </tbody></table></>
                  :<div className="text-[9px]" style={{color:'var(--t3)',fontStyle:'italic'}}>Ouverture non intersectée par des panneaux</div>}
                  {/* ML encadrements (ossature) */}
                  <div className="flex justify-between text-[10px] px-1"><span style={{color:'var(--t3)'}}>Encadr. ossature</span>
                    <span className="mn font-bold" style={{color:'var(--cy)'}}>{m.encTotal.toFixed(3)} ml</span></div>
                  {m.impPanels.length>0&&<div className="flex flex-wrap gap-1"><span className="text-[9px]" style={{color:'var(--t3)'}}>Pan.:</span>
                    {m.impPanels.map(r=><span key={r} className="imp-tag" style={{background:'var(--amd)',color:'var(--am)'}}>{r}</span>)}</div>}
                </div>)}
                {/* Totaux cassettes */}
                {C.menuDet.length>0&&<div className="cd p-2.5 space-y-1.5">
                  <div className="text-[9px] font-bold uppercase" style={{color:'var(--pp)'}}>Récap cassettes pliées</div>
                  <RR label="Plis totaux" value={C.totCassettes.pliees} unit="pièces"/>
                  <RR label="Panneaux pliés" value={new Set(C.totCassettes.detail.map(d=>d.panRef)).size} unit="panneaux" color="var(--am)"/>
                  <RR label="Surface totale" value={C.totCassettes.surfTot.toFixed(2)} unit="m²" bold color="var(--pp)"/>
                  <RR label="ML total" value={C.totCassettes.mlTot.toFixed(2)} unit="ml"/>
                </div>}
                {C.menuDet.length>0&&<div className="cd p-2.5"><RR label="Total encadr. ossature" value={C.totEnc.tot.toFixed(2)} unit="ml" color="var(--gn)" bold/></div>}
              </>}
              {rightTab==='decoupe'&&<>
                <div className="text-[9px] font-bold uppercase tracking-widest mb-1" style={{color:'var(--am)'}}>Panneaux impactés — {C.pImp}u / {C.nP} total</div>
                {C.pImp===0&&<p className="text-[11px] py-3 text-center" style={{color:'var(--t3)'}}>Aucun panneau impacté. Ajoutez une ouverture pour voir les découpes.</p>}
                {(()=>{
                  const impPans=C.activePanels?C.activePanels.filter(p=>p.isImpacted):[];
                  const basePw=Math.round(C.pw*1000),basePh=Math.round(C.ph*1000);
                  return impPans.map((pm,i)=>{
                    const pw3=Math.round(pm.pWa*1000),ph3=Math.round(pm.pHa*1000);
                    const hasFolds=pm.adjSides&&pm.adjSides.length>0;
                    const sideNames={tG:'Tableau G',tD:'Tableau D',lin:'Linteau',app:'Appui'};
                    return<div key={i} className="cd p-2.5 space-y-1.5 afu">
                      <div className="flex items-center justify-between">
                        <span className="mn text-xs font-bold" style={{color:'var(--am)'}}>Pan. {pm.subRef}</span>
                        <span className="text-[9px] px-2 py-0.5 rounded-full font-bold" style={{background:hasFolds?'rgba(167,139,250,.15)':'var(--amd)',
                          color:hasFolds?'var(--pp)':'var(--am)'}}>{hasFolds?'Plié':'Découpé'}</span>
                      </div>
                      <div className="grid grid-cols-2 gap-1 text-[9px]" style={{color:'var(--t3)'}}>
                        <div>Dim: <b className="mn" style={{color:'var(--t1)'}}>{pw3}×{ph3}</b></div>
                        <div>Base: <b className="mn" style={{color:'var(--bl)'}}>{basePw}×{basePh}</b></div>
                        <div>Surf: <b className="mn" style={{color:'var(--gn)'}}>{(pw3*ph3/1e6).toFixed(3)} m²</b></div>
                        <div>Parent: <b className="mn">{pm.ref}</b></div>
                      </div>
                      {hasFolds&&<div className="rounded-lg overflow-hidden" style={{border:'1px solid rgba(167,139,250,.2)'}}>
                        {pm.adjSides.map((s,si)=>{
                          const o=az.ouvs[s.ouvIdx];const oName=o?`${o.t||'Ouv.'} ${s.ouvIdx+1}`:'?';
                          const panDim=s.side==='tG'||s.side==='tD'?ph3:pw3;
                          const devTotal=panDim+s.retour+s.faceVis+10;
                          return<div key={si} className="px-2.5 py-1.5 text-[9px]" style={{background:si%2===0?'rgba(167,139,250,.06)':'var(--inp)'}}>
                            <div className="flex justify-between items-center mb-0.5">
                              <b style={{color:'var(--pp)'}}>{sideNames[s.side]||s.side}</b>
                              <span style={{color:'var(--t3)'}}>{oName}</span>
                            </div>
                            <div className="grid grid-cols-3 gap-1 mn" style={{color:'var(--t2)'}}>
                              <span>Ret: <b>{s.retour}</b></span>
                              <span>FV: <b>{s.faceVis}</b></span>
                              <span>Pli: <b>10</b></span>
                            </div>
                            <div className="mt-0.5 font-bold" style={{color:'var(--bl)',fontSize:10}}>
                              Dév: {devTotal} mm <span style={{color:'var(--t3)',fontWeight:400,fontSize:8}}>= {panDim}+{s.retour}+{s.faceVis}+10</span>
                            </div>
                          </div>})}
                      </div>}
                      {!hasFolds&&<div className="text-[9px] px-2 py-1.5 rounded-lg" style={{background:'var(--amd)',color:'var(--am)'}}>
                        Panneau découpé (dim ≠ base {basePw}×{basePh})</div>}
                    </div>})})()}
              </>}
              {rightTab==='metre'&&<>
                <div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'var(--gn)'}}>COMPARATIF ZONES</div>
                  <div className="space-y-1.5">{zones.map((z,i)=>{const c2=allCalcs[i];if(!c2)return null;
                    return<div key={z.id} className="rounded-lg p-2" style={{background:i===activeZoneIdx?'var(--blg)':'var(--inp)',border:`1px solid ${i===activeZoneIdx?ZONE_COLORS[i%8]:'var(--bd)'}`,cursor:'pointer'}} onClick={()=>setActiveZoneIdx(i)}>
                      <div className="flex items-center gap-1.5 mb-1"><div className="w-2.5 h-2.5 rounded-sm" style={{background:ZONE_COLORS[i%8]}}/><span className="text-[10px] font-bold" style={{color:ZONE_COLORS[i%8]}}>{z.name}</span></div>
                      <div className="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[9px]">
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>S.nette</span><span className="mn font-bold" style={{color:'var(--bl)'}}>{c2.sNet.toFixed(2)} m²</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Panneaux</span><span className="mn font-bold" style={{color:'var(--t1)'}}>{c2.nP}u</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Ossature</span><span className="mn" style={{color:'var(--t2)'}}>{c2.tOss.toFixed(1)} ml</span></div>
                        <div className="flex justify-between"><span style={{color:'var(--t3)'}}>Chutes</span><span className="mn" style={{color:c2.chut<10?'var(--gn)':c2.chut<20?'var(--am)':'var(--rs)'}}>{c2.chut.toFixed(1)}%</span></div>
                      </div>
                    </div>})}</div>
                </div>
                {zones.length>1&&<div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'var(--am)'}}>Σ TOTAUX ({zones.length} zones)</div>
                  {(()=>{const totS=allCalcs.reduce((a,c)=>a+(c?.sNet||0),0);const totP=allCalcs.reduce((a,c)=>a+(c?.nP||0),0);
                    const totOss=allCalcs.reduce((a,c)=>a+(c?.tOss||0),0);const totFix=allCalcs.reduce((a,c)=>a+(c?.tFix||0),0);
                    const totEq=allCalcs.reduce((a,c)=>a+(c?.tEq||0),0);const totJ=allCalcs.reduce((a,c)=>a+(c?.tJ||0),0);
                    const totEnc=allCalcs.reduce((a,c)=>a+(c?.totEnc?.tot||0),0);const totBr=allCalcs.reduce((a,c)=>a+(c?.sBr||0),0);
                    return<div className="space-y-1 text-[10px]">
                      <RR label="Surface brute" value={totBr.toFixed(2)} unit="m²"/>
                      <RR label="Surface nette" value={totS.toFixed(2)} unit="m²" bold color="var(--bl)"/>
                      <RR label="Panneaux" value={totP} unit="u" bold/><RR label="Ossature" value={totOss.toFixed(1)} unit="ml"/>
                      <RR label="Fixations" value={totFix} unit="u"/><RR label="Équerres" value={totEq} unit="u"/>
                      <RR label="Joints" value={totJ.toFixed(1)} unit="ml"/>
                      <RR label="Encadrements" value={totEnc.toFixed(1)} unit="ml" color="var(--gn)"/>
                    </div>})()}
                </div>}
                {measures.length>0&&<div className="cd p-2.5">
                  <div className="text-[10px] font-bold mb-2" style={{color:'#f59e0b'}}>📏 MESURES ({measures.length})</div>
                  <div className="space-y-1">{measures.map((m,i)=><div key={m.id} className="flex items-center justify-between">
                    <span className="text-[10px]" style={{color:'var(--t3)'}}>M{i+1}</span>
                    <span className="mn text-[10px] font-bold" style={{color:'#fbbf24'}}>{m.dist>=1000?(m.dist/1000).toFixed(3)+' m':m.dist+' mm'}</span>
                    <button onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))} className="text-[9px]" style={{color:'var(--rs)'}}>✕</button>
                  </div>)}</div>
                  {measures.length>1&&<div className="flex justify-between mt-1.5 pt-1.5" style={{borderTop:'1px solid var(--bd)'}}>
                    <span className="text-[10px] font-bold" style={{color:'#f59e0b'}}>Σ Total</span>
                    <span className="mn text-[10px] font-bold" style={{color:'#fbbf24'}}>{(measures.reduce((a,m)=>a+m.dist,0)/1000).toFixed(3)} m</span>
                  </div>}
                </div>}
                <button onClick={()=>setMetreOpen(true)} className="ba w-full py-2 rounded-lg text-[10px] font-medium flex items-center justify-center gap-1"
                  style={{background:'var(--gnd)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>📊 Tableau complet multi-zones</button>
              </>}
            </div></div>)}
      </div>

      {/* PANEL EDITOR POPUP — compact, follows plan */}
      {editPanel&&az&&C&&(()=>{
        const pm=C.panelMap.find(p=>p.col===editPanel.col&&p.row===editPanel.row);
        if(!pm||pm.isVoid){setEditPanel(null);return null}
        const panW=Math.round(pm.pWa*1000),panH=Math.round(pm.pHa*1000);
        const pCol=pm.parentCol,pRow=pm.parentRow;
        const ralHex=RAL_COLORS[ralIdx]?.hex||'#383E42';
        // Compute screen position from panel coords + zoom/pan
        const ppZ=zoom*(pxPerMm_eff||manualScale||0.15);
        const scrX=(pm.pLeft*ppZ+pan.x+(az.facOrigin?.x||0)*zoom)*1+30;
        const scrY=(pm.pTop*ppZ+pan.y+(az.facOrigin?.y||0)*zoom)*1;
        const rect=cvRef.current?.getBoundingClientRect()||{left:0,top:0,width:800,height:600};
        const popW=235,popMaxH=420;
        let lf=rect.left+scrX+pm.pWa*ppZ+8;
        let tp=rect.top+scrY;
        if(lf+popW>window.innerWidth-10)lf=rect.left+scrX-popW-8;
        if(tp+popMaxH>window.innerHeight-10)tp=window.innerHeight-popMaxH-10;
        if(tp<10)tp=10;if(lf<10)lf=10;
        return<div style={{position:'fixed',left:lf,top:tp,zIndex:200,width:popW,maxHeight:popMaxH,
          background:'var(--pnl)',border:'1.5px solid var(--bl)',borderRadius:10,
          boxShadow:'0 8px 30px rgba(0,0,0,.12)',overflowY:'auto',overflowX:'hidden',maxHeight:Math.min(popMaxH,window.innerHeight-tp-10)}}>
          {/* Header compact */}
          <div style={{padding:'6px 10px',borderBottom:'1px solid var(--bd)',background:'var(--crd)'}}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-1.5">
                <div style={{width:20,height:20,borderRadius:4,background:ralHex,display:'flex',alignItems:'center',justifyContent:'center'}}>
                  <span style={{fontSize:7,fontWeight:700,color:'#fff',fontFamily:'monospace'}}>{pm.subRef}</span></div>
                <div><span className="text-[11px] font-bold" style={{color:'var(--t1)'}}>Panneau {pm.subRef}</span>
                  <span className="text-[8px] ml-1" style={{color:'var(--t3)'}}>C{pm.col+1} L{pm.row+1}</span></div>
              </div>
              <button onClick={()=>setEditPanel(null)} className="w-5 h-5 rounded flex items-center justify-center text-[10px]"
                style={{color:'var(--t3)',border:'1px solid var(--bd)'}}>✕</button>
            </div>
          </div>
          {/* Dims row */}
          <div className="flex gap-1 px-2 py-1.5" style={{borderBottom:'1px solid var(--bd)'}}>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(139,26,43,.06)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>L</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--bl)'}}>{panW}</div></div>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(13,148,136,.06)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>H</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--gn)'}}>{panH}</div></div>
            <div className="flex-1 text-center py-1 rounded" style={{background:'rgba(139,92,246,.06)'}}>
              <div className="text-[7px] font-bold" style={{color:'var(--t3)'}}>m²</div>
              <div className="text-[11px] font-bold mn" style={{color:'var(--pp)'}}>{(panW*panH/1e6).toFixed(2)}</div></div>
          </div>
          {/* Tags */}
          {(pm.isImpacted||pm.polyEdge)&&<div className="flex gap-1 px-2 py-1" style={{borderBottom:'1px solid var(--bd)'}}>
            {pm.isImpacted&&<span className="text-[8px] font-bold px-1.5 py-0.5 rounded" style={{background:'var(--amd)',color:'var(--am)'}}>✂ Impacté</span>}
            {pm.polyEdge&&<span className="text-[8px] font-bold px-1.5 py-0.5 rounded" style={{background:'rgba(34,211,238,.08)',color:'var(--cy)'}}>◇ Bord</span>}
          </div>}
          {/* Edit dims */}
          <div className="px-2 py-1.5 space-y-1.5" style={{borderBottom:'1px solid var(--bd)'}}>
            <div className="flex items-center gap-1.5">
              <span className="text-[8px] font-bold" style={{color:'var(--am)',minWidth:28}}>↔ Col</span>
              <input type="number" defaultValue={(az.colWidths||[])[pCol]||az.pan_.l||600}
                className="flex-1 px-2 py-1 rounded text-[11px] mn font-bold idark" id="ep-colw" onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){const v=parseFloat(e.target.value);if(!v||v<50)return;
                  updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=pCol)cw.push(null);cw[pCol]=v;return{...z,colWidths:cw}});setEditPanel(null)}}}/>
              <button onClick={()=>{const el=document.getElementById('ep-colw');const v=parseFloat(el?.value);if(!v||v<50)return;
                updateAZ(z=>{const cw=[...(z.colWidths||[])];while(cw.length<=pCol)cw.push(null);cw[pCol]=v;return{...z,colWidths:cw}});setEditPanel(null)}}
                className="px-3 py-1 rounded text-[9px] font-bold text-white flex-shrink-0" style={{background:'var(--bl)',minWidth:32}}>OK</button>
            </div>
            <div className="flex items-center gap-1.5">
              <span className="text-[8px] font-bold" style={{color:'var(--gn)',minWidth:28}}>↕ Lig</span>
              <input type="number" defaultValue={(az.rowHeights||[])[pRow]||az.pan_.w||400}
                className="flex-1 px-2 py-1 rounded text-[11px] mn font-bold idark" id="ep-rowh" onKeyDown={e=>{e.stopPropagation();if(e.key==='Enter'){const v=parseFloat(e.target.value);if(!v||v<50)return;
                  updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=pRow)rh.push(null);rh[pRow]=v;return{...z,rowHeights:rh}});setEditPanel(null)}}}/>
              <button onClick={()=>{const el=document.getElementById('ep-rowh');const v=parseFloat(el?.value);if(!v||v<50)return;
                updateAZ(z=>{const rh=[...(z.rowHeights||[])];while(rh.length<=pRow)rh.push(null);rh[pRow]=v;return{...z,rowHeights:rh}});setEditPanel(null)}}
                className="px-3 py-1 rounded text-[9px] font-bold text-white flex-shrink-0" style={{background:'var(--gn)',minWidth:32}}>OK</button>
            </div>
          </div>
          {/* Actions */}
          <div className="px-2 py-1.5 space-y-1" style={{borderBottom:'1px solid var(--bd)'}}>
            {(()=>{
              const excl=(az.exclusions||[]).find(e=>e.col===pCol&&e.row===pRow);
              if(excl)return<div className="space-y-1">
                <div className="flex items-center gap-1.5">
                  <span className="text-[8px]" style={{color:'var(--rs)'}}>Exclu ({excl.depth}mm)</span>
                  <input type="number" defaultValue={excl.depth} className="w-14 px-1.5 py-0.5 rounded text-[10px] mn idark" id="ep-excl-depth" onKeyDown={e=>e.stopPropagation()}/>
                  <button onClick={()=>{const el=document.getElementById('ep-excl-depth');const v=parseFloat(el?.value);if(!v||v<100)return;
                    updateAZ(z=>{const ex=[...(z.exclusions||[])].map(e=>e.col===pCol&&e.row===pRow?{...e,depth:v}:e);return{...z,exclusions:ex}});setEditPanel(null)}}
                    className="px-1.5 py-0.5 rounded text-[8px] font-bold text-white" style={{background:'var(--bl)'}}>✓</button>
                  <button onClick={()=>{updateAZ(z=>({...z,exclusions:(z.exclusions||[]).filter(e=>!(e.col===pCol&&e.row===pRow))}));setEditPanel(null)}}
                    className="px-1.5 py-0.5 rounded text-[8px] font-bold" style={{color:'var(--rs)',border:'1px solid rgba(251,113,133,.3)'}}>✕</button>
                </div>
              </div>;
              return<button onClick={()=>{const depth=prompt('Profondeur extrusion (mm):','1500');if(!depth)return;const d=parseFloat(depth);if(isNaN(d)||d<100)return;
                updateAZ(z=>{const ex=[...(z.exclusions||[])];ex.push({col:pCol,row:pRow,depth:d});return{...z,exclusions:ex}});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(251,113,133,.06)',border:'1px solid rgba(251,113,133,.15)',color:'var(--rs)'}}>
                🚫 Exclure (balcon)</button>;
            })()}
          </div>
          {/* Merge */}
          <div className="px-2 py-1.5">
            {pm.isMerged?
              <button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])].filter(m=>!(m.c1===pm.mergeSpan.c1&&m.r1===pm.mergeSpan.r1));return{...z,merges:ms}});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(251,113,133,.06)',border:'1px solid rgba(251,113,133,.15)',color:'var(--rs)'}}>
                ✂ Défusionner</button>
            :<div className="space-y-1">
              <button onClick={()=>{setMergeSrc({parentCol:pCol,parentRow:pRow});setEditPanel(null)}}
                className="w-full py-1 rounded text-[9px] font-bold" style={{background:'rgba(139,92,246,.08)',border:'1px solid rgba(139,92,246,.15)',color:'var(--pp)'}}>
                ⊞ Fusionner avec...</button>
              <div className="flex gap-1">
                {pCol<C.baseNc-1&&<button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])];ms.push({c1:pCol,r1:pRow,c2:pCol+1,r2:pRow});return{...z,merges:ms}});setEditPanel(null)}}
                  className="flex-1 py-0.5 rounded text-[8px] font-bold" style={{background:'rgba(79,110,247,.06)',border:'1px solid rgba(79,110,247,.12)',color:'var(--bl)'}}>→</button>}
                {pRow<C.baseNr-1&&<button onClick={()=>{updateAZ(z=>{const ms=[...(z.merges||[])];ms.push({c1:pCol,r1:pRow,c2:pCol,r2:pRow+1});return{...z,merges:ms}});setEditPanel(null)}}
                  className="flex-1 py-0.5 rounded text-[8px] font-bold" style={{background:'rgba(52,211,153,.06)',border:'1px solid rgba(52,211,153,.12)',color:'var(--gn)'}}>↓</button>}
              </div>
            </div>}
          </div>
          {/* Bottom bar */}
          <div className="flex gap-1 px-2 pb-1.5">
            <button onClick={()=>{updateAZ(z=>{
              const cw=[...(z.colWidths||[])];if(cw[pCol]!=null)cw[pCol]=null;
              const rh=[...(z.rowHeights||[])];if(rh[pRow]!=null)rh[pRow]=null;
              return{...z,colWidths:cw,rowHeights:rh}});setEditPanel(null)}}
              className="flex-1 py-1 rounded text-[8px] font-bold" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t3)'}}>↺ Reset</button>
            <button onClick={()=>setEditPanel(null)}
              className="px-3 py-1 rounded text-[8px] font-bold" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
          </div>
        </div>})()}

      {xlsxExpMod&&<div className="ov"><div className="mbx">
        <h3 className="font-bold text-base mb-1">Export Excel</h3>
        <p className="text-xs mb-4" style={{color:'var(--t2)'}}>Sélectionnez les zones à inclure dans l'export</p>
        <div className="space-y-2 mb-4">
          {zones.map((z,i)=>{const zC2=allCalcs[i];return(
            <label key={z.id} className="flex items-center gap-3 p-2.5 rounded-lg cursor-pointer" style={{background:xlsxExpSel[i]?'rgba(52,211,153,.08)':'var(--inp)',border:`1px solid ${xlsxExpSel[i]?'rgba(52,211,153,.4)':'var(--bd)'}`,transition:'.15s'}}>
              <input type="checkbox" checked={!!xlsxExpSel[i]} onChange={e=>setXlsxExpSel(s=>({...s,[i]:e.target.checked}))}/>
              <div className="w-3 h-3 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8]}}/>
              <div className="flex-1"><div className="text-sm font-medium">{z.name}</div>
                <div className="text-[10px]" style={{color:'var(--t3)'}}>{(z.L/1000).toFixed(1)} × {(z.H/1000).toFixed(1)} m — {zC2?.nP||0} panneaux{z.ouvs?.length?' — '+z.ouvs.length+' ouverture'+(z.ouvs.length>1?'s':''):''}</div></div>
            </label>)})}
          <div className="flex gap-2 mt-1">
            <button onClick={()=>{const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s)}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--gn)',background:'rgba(52,211,153,.1)'}}>Tout sélectionner</button>
            <button onClick={()=>setXlsxExpSel({})} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t3)',background:'var(--inp)'}}>Tout désélectionner</button>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={()=>setXlsxExpMod(false)} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
          <button onClick={()=>{
            const sel=Object.entries(xlsxExpSel).filter(([,v])=>v).map(([k])=>parseInt(k));
            if(!sel.length){alert('Sélectionnez au moins une zone');return;}
            setXlsxExpMod(false);exportCSV(sel);}}
            className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--gn)'}}>
            📊 Exporter {Object.values(xlsxExpSel).filter(Boolean).length} zone{Object.values(xlsxExpSel).filter(Boolean).length>1?'s':''}
          </button>
        </div>
      </div></div>}

      {/* MODALS */}
      {calModal&&<div className="ov" onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();confirmCal()}}}><div className="mbx"><h3 className="font-bold text-base mb-4">Calibration</h3>
        <p className="text-xs mb-3" style={{color:'var(--t2)'}}>Distance reelle entre les 2 points :</p>
        <NI value={calMm} onChange={setCalMm} unit="mm" step={100} min={1}/>
        <div className="flex gap-2 mt-5"><button onClick={()=>{setCalModal(false);setCalPts([])}} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
          <button onClick={confirmCal} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)'}}>Valider</button></div></div></div>}

      {addMod&&<div className="ov"><div className="mbx"><AddPC type={addMod} onClose={()=>setAddMod(null)} onAdd={p=>{if(addMod==='pan')setPresPan(a=>[...a,p]);else setPresOuv(a=>[...a,p])}}/></div></div>}

      {coupeOuv!==null&&<CoupePopup ouvIdx={coupeOuv} onClose={()=>setCoupeOuv(null)}/>}
      {expMod&&(()=>{
        // Compter les pages uniques
        const getPageNum=(i)=>pdfPageNums[i]??i+1;
        const selList=Object.entries(expSel).filter(([,v])=>v).map(([k])=>parseInt(k));
        const pageNums=[...new Set(selList.map(i=>getPageNum(i)))].sort((a,b)=>a-b);
        return(
        <div className="ov"><div className="mbx" style={{maxWidth:580}}>
          <h3 className="font-bold text-base mb-1">Export PDF</h3>
          <p className="text-xs mb-3" style={{color:'var(--t2)'}}>Sélectionnez les zones et assignez-les à des pages (plusieurs zones = même page côte-à-côte)</p>

          {/* Zone list with page selectors */}
          <div className="space-y-1.5 mb-3">
            <div className="grid text-[9px] font-bold mb-1" style={{gridTemplateColumns:'1fr 90px',color:'var(--t3)'}}>
              <span>Zone</span><span className="text-center">Page PDF</span>
            </div>
            {zones.map((z,i)=>{const zC2=allCalcs[i];const pg=getPageNum(i);return(
              <div key={z.id} className="grid items-center gap-2" style={{gridTemplateColumns:'auto 1fr 90px'}}>
                <input type="checkbox" checked={!!expSel[i]} onChange={e=>setExpSel(s=>({...s,[i]:e.target.checked}))}/>
                <label className="flex items-center gap-2 p-2 rounded-lg cursor-pointer" style={{background:expSel[i]?'var(--blg)':'var(--inp)',border:`1px solid ${expSel[i]?'var(--bl)':'var(--bd)'}`,transition:'.15s'}}
                  onClick={()=>setExpSel(s=>({...s,[i]:!s[i]}))}>
                  <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{background:ZONE_COLORS[i%8]}}/>
                  <div><div className="text-xs font-medium">{z.name}</div>
                    <div className="text-[9px]" style={{color:'var(--t3)'}}>{(z.L/1000).toFixed(1)}×{(z.H/1000).toFixed(1)} m — {zC2?.nP||0} pan.</div></div>
                </label>
                <div className="flex items-center gap-1">
                  <span className="text-[9px]" style={{color:'var(--t3)'}}>Pg.</span>
                  <input type="number" min={1} max={99} value={pg}
                    onChange={e=>setPdfPageNums(p=>({...p,[i]:parseInt(e.target.value)||i+1}))}
                    onKeyDown={e=>e.stopPropagation()}
                    className="idark w-12 text-center text-xs mn font-bold px-1 py-1 rounded"
                    style={{opacity:expSel[i]?1:.35}}/>
                </div>
              </div>
            )})}
          </div>

          {/* Page preview */}
          {selList.length>0&&(()=>{
            const pages={};selList.forEach(i=>{const pg=getPageNum(i);if(!pages[pg])pages[pg]=[];pages[pg].push(i);});
            return(
              <div className="mb-3 p-2 rounded-lg" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
                <div className="text-[9px] font-bold mb-1.5" style={{color:'var(--t3)'}}>APERÇU PAGES ({Object.keys(pages).length} page{Object.keys(pages).length>1?'s':''})</div>
                <div className="flex flex-wrap gap-2">
                  {Object.entries(pages).sort((a,b)=>a[0]-b[0]).map(([pg,zis])=>(
                    <div key={pg} className="flex items-center gap-1.5 px-2 py-1 rounded" style={{background:'var(--inp)',border:'1px solid var(--bd)'}}>
                      <span className="text-[9px] font-bold" style={{color:'var(--bl)'}}>P{pg}</span>
                      <span className="text-[9px]">→</span>
                      {zis.map(zi=>(
                        <span key={zi} className="flex items-center gap-1">
                          <span className="inline-block w-2 h-2 rounded-sm" style={{background:ZONE_COLORS[zi%8]}}/>
                          <span className="text-[9px]">{zones[zi].name}</span>
                        </span>
                      ))}
                    </div>
                  ))}
                </div>
              </div>
            );
          })()}

          <div className="flex gap-2 mb-3">
            <button onClick={()=>{const s={};const pn={};zones.forEach((_,i)=>{s[i]=true;pn[i]=i+1;});setExpSel(s);setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--bl)',background:'var(--blg)'}}>Tout sélect.</button>
            <button onClick={()=>setExpSel({})} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t3)',background:'var(--inp)'}}>Aucun</button>
            <button onClick={()=>{const sel=selList;const pn={};sel.forEach((i,idx)=>{pn[i]=idx+1;});setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t2)',background:'var(--inp)'}}>1 zone/page</button>
            <button onClick={()=>{const sel=selList;const pn={};sel.forEach(i=>{pn[i]=1;});setPdfPageNums(pn);}} className="text-[10px] font-medium px-2 py-1 rounded ba" style={{color:'var(--t2)',background:'var(--inp)'}}>Tout sur 1 page</button>
          </div>

          <label className="flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer mb-2" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
            <input type="checkbox" checked={pdfOss} onChange={e=>setPdfOss(e.target.checked)}/>
            <span className="text-xs" style={{color:'var(--t2)'}}>Afficher ossature (montants / lisses)</span>
          </label>
          <div className="flex items-center gap-2 mb-3">
            <label className="flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer flex-1" style={{background:pdfQR?'rgba(139,92,246,.08)':'var(--crd)',border:`1px solid ${pdfQR?'rgba(139,92,246,.3)':'var(--bd)'}`}}>
              <input type="checkbox" checked={pdfQR} onChange={e=>setPdfQR(e.target.checked)} disabled={!supaConf.url||!supaConf.key}/>
              <span className="text-xs" style={{color:pdfQR?'var(--pp)':'var(--t2)'}}>QR code → vue 3D</span>
            </label>
            <button onClick={()=>{setExpMod(false);setSupaModal(true)}} className="ba px-3 py-2 rounded-lg text-[10px] font-bold"
              style={{background:supaConf.url?'rgba(13,148,136,.08)':'rgba(180,30,50,.06)',
                border:`1px solid ${supaConf.url?'rgba(13,148,136,.3)':'rgba(180,30,50,.15)'}`,
                color:supaConf.url?'var(--gn)':'var(--rs)'}}>
              {supaConf.url?'✓ Supabase':'⚙ Supabase'}</button>
          </div>

          <div className="flex gap-2">
            <button onClick={()=>setExpMod(false)} className="ba flex-1 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
            <button onClick={()=>{
              if(!selList.length)return;
              const pageGroups={};selList.forEach(i=>pageGroups[i]=getPageNum(i));
              setExpMod(false);exportPDF(selList,{showOss:pdfOss,pageGroups,showQR:pdfQR});}}
              className="ba flex-1 py-2.5 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)',opacity:selList.length?1:.5}}>
              Exporter {selList.length} zone{selList.length>1?'s':''} — {[...new Set(selList.map(i=>getPageNum(i)))].length} page{[...new Set(selList.map(i=>getPageNum(i)))].length>1?'s':''}
            </button>
          </div>
        </div></div>
        );
      })()}

      {/* SUPABASE CONFIG MODAL */}
      {supaModal&&<div className="ov" onClick={()=>setSupaModal(false)}><div className="mbx" style={{maxWidth:480}} onClick={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-bold text-base">Configuration Supabase</h3>
          <button onClick={()=>setSupaModal(false)} className="w-7 h-7 rounded-lg flex items-center justify-center" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>✕</button>
        </div>
        <p className="text-xs mb-3" style={{color:'var(--t3)'}}>
          Connectez votre base Supabase pour stocker les vues 3D et générer des QR codes sur les PDF.
          Créez une table <code className="mn" style={{background:'var(--crd)',padding:'1px 4px',borderRadius:4}}>kalepin_views</code> avec les colonnes :
          <code className="mn block mt-1 p-2 rounded-lg text-[10px]" style={{background:'var(--crd)',border:'1px solid var(--bd)'}}>
            id (uuid, PK, default gen_random_uuid()), created_at (timestamptz), project_name (text), zone_name (text), zone_json (jsonb), calc_json (jsonb), ral_color (text), ral_finish (text)
          </code>
        </p>
        <div className="space-y-2 mb-3">
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>URL Supabase</label>
            <input type="text" defaultValue={supaConf.url||''} id="supa-url" placeholder="https://xxxxx.supabase.co"
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>Anon Key (public)</label>
            <input type="password" defaultValue={supaConf.key||''} id="supa-key" placeholder="eyJhbGciOiJIUzI1NiIs..."
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
          <div>
            <label className="text-[10px] font-bold mb-1 block" style={{color:'var(--t2)'}}>URL viewer (optionnel, défaut = URL actuelle)</label>
            <input type="text" defaultValue={supaConf.viewerUrl||''} id="supa-viewer" placeholder={window.location.origin+window.location.pathname}
              className="w-full px-3 py-2 rounded-lg text-sm mn" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t1)'}} onKeyDown={e=>e.stopPropagation()}/>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={()=>{
            const cfg={url:(document.getElementById('supa-url')?.value||'').replace(/\/$/,''),
              key:document.getElementById('supa-key')?.value||'',
              viewerUrl:document.getElementById('supa-viewer')?.value||''};
            setSupaConfig(cfg);setSupaConf(cfg);setSupaModal(false);
          }} className="ba flex-1 py-2 rounded-lg text-sm font-medium text-white" style={{background:'var(--gn)'}}>Enregistrer</button>
          {supaConf.url&&<button onClick={async()=>{
            try{const r=await fetch(supaConf.url+'/rest/v1/kalepin_views?select=id&limit=1',{headers:{'apikey':supaConf.key}});
              alert(r.ok?'✓ Connexion OK !':'✗ Erreur '+r.status)}catch(e){alert('✗ '+e.message)}
          }} className="ba px-4 py-2 rounded-lg text-sm font-medium" style={{background:'var(--cyd)',border:'1px solid rgba(8,145,178,.3)',color:'var(--cy)'}}>Tester</button>}
        </div>
      </div></div>}

      {optMod&&<div className="ov"><div className="mbx"><h3 className="font-bold text-base mb-3">Optimisation calepinage</h3>
        <p className="text-xs mb-4" style={{color:'var(--t2)'}}>Solutions testees: orientations V/H x decalages. Classement par taux de chute minimal.</p>
        <div className="space-y-2 max-h-[400px] overflow-y-auto">
          {optResults.map((r,i)=><div key={i} className={`opt-card ${i===0?'best':''}`} onClick={()=>applyOpt(r)}>
            <div className="flex items-center justify-between mb-1">
              <span className="text-xs font-bold" style={{color:i===0?'var(--gn)':'var(--t1)'}}>{i===0?'★ Optimal':``} {r.vert?'Vertical':'Horizontal'}</span>
              <span className="mn text-xs font-bold" style={{color:r.chut<10?'var(--gn)':r.chut<20?'var(--am)':'var(--rs)'}}>{r.chut.toFixed(1)}% chutes</span></div>
            <div className="flex gap-3 text-[10px]" style={{color:'var(--t3)'}}>
              <span>Decal: {r.offX}x{r.offY}mm</span><span>{r.nP} pan.</span><span>{r.pImp} imp.</span><span>{r.nCuts} coupes</span></div>
          </div>)}
          {optResults.length===0&&<p className="text-center py-4 text-xs" style={{color:'var(--t3)'}}>Aucun resultat</p>}
        </div>
        <button onClick={()=>setOptMod(false)} className="ba w-full mt-4 py-2 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
      </div></div>}

      {/* AI DETECTION MODAL */}
      {/* METRE MODAL */}
      {metreOpen&&<div className="ov"><div className="mbx" style={{maxWidth:700,width:'90vw'}}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-bold text-base">📊 Métré — Récapitulatif multi-zones</h3>
          <button onClick={()=>setMetreOpen(false)} className="text-lg" style={{color:'var(--t3)'}}>✕</button>
        </div>
        {/* Zone selection */}
        <div className="flex flex-wrap gap-1.5 mb-4">{zones.map((z,i)=>{
          const isOn=!!metreSelZones[i];
          return<button key={z.id} onClick={()=>setMetreSelZones(s=>({...s,[i]:!s[i]}))}
            className="ba px-3 py-1.5 rounded-lg text-[11px] font-medium"
            style={{background:isOn?'var(--blg)':'var(--inp)',border:`1px solid ${isOn?ZONE_COLORS[i%8]:'var(--bd)'}`,color:isOn?ZONE_COLORS[i%8]:'var(--t3)'}}>
            <span className="inline-block w-2.5 h-2.5 rounded-sm mr-1.5" style={{background:ZONE_COLORS[i%8],opacity:isOn?1:.4}}/>{z.name}</button>})}
          <button onClick={()=>{const a={};zones.forEach((_,i)=>a[i]=true);setMetreSelZones(a)}}
            className="ba px-2.5 py-1.5 rounded-lg text-[10px] font-medium" style={{background:'var(--gnd)',border:'1px solid rgba(52,211,153,.3)',color:'var(--gn)'}}>Tout</button>
          <button onClick={()=>setMetreSelZones({})}
            className="ba px-2.5 py-1.5 rounded-lg text-[10px] font-medium" style={{background:'var(--rsd)',border:'1px solid rgba(251,113,133,.3)',color:'var(--rs)'}}>Aucun</button>
        </div>
        {/* Summary table */}
        {(()=>{
          const selIdx=Object.entries(metreSelZones).filter(([_,v])=>v).map(([k])=>parseInt(k));
          const rows=selIdx.map(i=>{const z=zones[i],c=allCalcs[i];if(!c)return null;
            return{name:z.name,col:ZONE_COLORS[i%8],sBr:c.sBr,sOuv:c.sOuv,sNet:c.sNet,nP:c.nP,pImp:c.pImp,
              tOss:c.tOss,tFix:c.tFix,tEq:c.tEq,tJ:c.tJ,totEnc:c.totEnc.tot,panL:z.pan_.l,panW:z.pan_.w,panNom:z.pan_.nom||`${z.pan_.l}x${z.pan_.w}`,
              chut:c.chut,nCuts:c.nCuts,L:z.L,H:z.H}}).filter(Boolean);
          if(rows.length===0)return<p className="text-center py-8 text-xs" style={{color:'var(--t3)'}}>Sélectionnez des zones ci-dessus</p>;
          const sum=(k)=>rows.reduce((a,r)=>a+r[k],0);
          const fmt=(v,d=2)=>v.toFixed(d);
          return<div className="space-y-3">
            {/* Detail table */}
            <div className="overflow-x-auto"><table className="w-full text-[10px]" style={{borderCollapse:'collapse'}}>
              <thead><tr style={{background:'var(--crd2)'}}>
                {['Zone','Dimensions','Panneau','S.Brute','Ouvertures','S.Nette','Panneaux','Impactés','Chutes','Ossature','Fixations','Équerres','Joints','Encadr.'].map(h=>
                  <th key={h} className="px-2 py-2 text-left font-bold" style={{color:'var(--t2)',borderBottom:'1px solid var(--bd)'}}>{h}</th>)}
              </tr></thead>
              <tbody>{rows.map((r,i)=><tr key={i} style={{borderBottom:'1px solid var(--bd)'}}>
                <td className="px-2 py-1.5 font-bold" style={{color:r.col}}>{r.name}</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{(r.L/1000).toFixed(1)}×{(r.H/1000).toFixed(1)}m</td>
                <td className="px-2 py-1.5" style={{color:'var(--t2)'}}>{r.panNom}</td>
                <td className="px-2 py-1.5 mn font-bold" style={{color:'var(--t1)'}}>{fmt(r.sBr)} m²</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--rs)'}}>-{fmt(r.sOuv)} m²</td>
                <td className="px-2 py-1.5 mn font-bold" style={{color:'var(--bl)'}}>{fmt(r.sNet)} m²</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t1)'}}>{r.nP}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--am)'}}>{r.pImp}u</td>
                <td className="px-2 py-1.5 mn" style={{color:r.chut<10?'var(--gn)':r.chut<20?'var(--am)':'var(--rs)'}}>{fmt(r.chut,1)}%</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{fmt(r.tOss,1)} ml</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{r.tFix}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{r.tEq}u</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--t2)'}}>{fmt(r.tJ,1)} ml</td>
                <td className="px-2 py-1.5 mn" style={{color:'var(--gn)'}}>{fmt(r.totEnc,1)} ml</td>
              </tr>)}</tbody>
              {rows.length>1&&<tfoot><tr style={{background:'var(--crd)'}}>
                <td className="px-2 py-2 font-bold" style={{color:'var(--gn)'}}>ΣTOTAL</td>
                <td className="px-2 py-2 mn" style={{color:'var(--t3)'}}>{rows.length} zones</td>
                <td className="px-2 py-2"/>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t1)'}}>{fmt(sum('sBr'))} m²</td>
                <td className="px-2 py-2 mn" style={{color:'var(--rs)'}}>-{fmt(sum('sOuv'))} m²</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--bl)'}}>{fmt(sum('sNet'))} m²</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t1)'}}>{sum('nP')}u</td>
                <td className="px-2 py-2 mn" style={{color:'var(--am)'}}>{sum('pImp')}u</td>
                <td className="px-2 py-2"/>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{fmt(sum('tOss'),1)} ml</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{sum('tFix')}u</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{sum('tEq')}u</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--t2)'}}>{fmt(sum('tJ'),1)} ml</td>
                <td className="px-2 py-2 mn font-bold" style={{color:'var(--gn)'}}>{fmt(sum('totEnc'),1)} ml</td>
              </tr></tfoot>}
            </table></div>
            {/* Summary cards */}
            <div className="grid grid-cols-4 gap-2">
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--bl)'}}>SURFACE NETTE TOTALE</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('sNet'))} m²</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--pp)'}}>PANNEAUX TOTAL</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{sum('nP')} u</div>
                <div className="text-[9px]" style={{color:'var(--am)'}}>{sum('pImp')} impactés</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--am)'}}>OSSATURE TOTALE</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('tOss'),1)} ml</div></div>
              <div className="cd p-3"><div className="text-[9px] font-bold mb-1" style={{color:'var(--gn)'}}>ENCADREMENTS TOTAL</div>
                <div className="mn text-lg font-bold" style={{color:'var(--t1)'}}>{fmt(sum('totEnc'),1)} ml</div></div>
            </div>
            {/* Measurements */}
            {measures.length>0&&<div className="cd p-3">
              <div className="text-[10px] font-bold mb-2" style={{color:'#f59e0b'}}>MESURES ({measures.length})</div>
              <div className="space-y-1">{measures.map((m,i)=><div key={m.id} className="flex items-center justify-between text-[10px]">
                <span style={{color:'var(--t2)'}}>Mesure {i+1}</span>
                <span className="mn font-bold" style={{color:'#fbbf24'}}>{m.dist>=1000?(m.dist/1000).toFixed(3)+' m':m.dist+' mm'}</span>
                <button onClick={()=>setMeasures(ms=>ms.filter(x=>x.id!==m.id))} className="text-[9px]" style={{color:'var(--rs)'}}>✕</button>
              </div>)}</div>
              {measures.length>1&&<div className="flex justify-between mt-2 pt-2" style={{borderTop:'1px solid var(--bd)'}}>
                <span className="text-[10px] font-bold" style={{color:'#f59e0b'}}>Σ Total</span>
                <span className="mn font-bold" style={{color:'#fbbf24'}}>{(measures.reduce((a,m)=>a+m.dist,0)/1000).toFixed(3)} m</span>
              </div>}
            </div>}
          </div>})()}
        <button onClick={()=>setMetreOpen(false)} className="ba w-full mt-4 py-2.5 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Fermer</button>
        <button onClick={()=>{setMetreOpen(false);const s={};zones.forEach((_,i)=>s[i]=true);setXlsxExpSel(s);setXlsxExpMod(true)}} className="ba w-full mt-2 py-2.5 rounded-lg text-sm font-medium" style={{background:'rgba(52,211,153,.12)',border:'1px solid rgba(52,211,153,.35)',color:'var(--gn)'}}>📊 Exporter Excel (métrés + détails)</button>
      </div></div>}
    </div>);
}

function AddPC({type,onClose,onAdd}){
  const[n,sN]=useState('');const[l,sL]=useState(2000);const[w,sW]=useState(600);const[h,sH]=useState(1200);const[t,sT]=useState('Fenetre');
  const go=()=>{if(!n.trim())return;if(type==='pan')onAdd({n:n.trim(),l,w,c:1});else onAdd({n:n.trim(),t,w,h});onClose()};
  return<><h3 className="font-bold text-base mb-4">Nouveau {type==='pan'?'panneau':'ouverture'}</h3>
    <div className="space-y-3"><TI label="Nom" value={n} onChange={sN}/>
      {type==='ouv'&&<div className="space-y-1"><label className="text-[11px] font-medium" style={{color:'var(--t3)'}}>Type</label>
        <select value={t} onChange={e=>sT(e.target.value)} className="idark w-full rounded-lg text-sm py-2 px-3">
          {['Fenetre','Porte','Porte-fenetre','Chassis fixe','Grille'].map(x=><option key={x}>{x}</option>)}</select></div>}
      <div className="grid grid-cols-2 gap-3">{type==='pan'?<><NI label="Longueur" value={l} onChange={sL} unit="mm"/><NI label="Largeur" value={w} onChange={sW} unit="mm"/></>
        :<><NI label="Largeur" value={w} onChange={sW} unit="mm"/><NI label="Hauteur" value={h} onChange={sH} unit="mm"/></>}</div></div>
    <div className="flex gap-2 mt-5"><button onClick={onClose} className="ba flex-1 py-2 rounded-lg text-sm font-medium" style={{background:'var(--inp)',border:'1px solid var(--bd)',color:'var(--t2)'}}>Annuler</button>
      <button onClick={go} className="ba flex-1 py-2 rounded-lg text-sm font-medium text-white" style={{background:'var(--bl)'}}>Ajouter</button></div></>;
}

if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
// Detect viewer mode from URL
const _viewParam=new URLSearchParams(window.location.search).get('view');
ReactDOM.createRoot(document.getElementById('root')).render(_viewParam?<ViewerApp viewId={_viewParam}/>:<App/>);
</script>
</body>
</html>
